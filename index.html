<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ŸÜÿ∏ÿßŸÖ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸàÿßÿ±ÿØ ÿßŸÑÿ®ÿ¥ÿ±Ÿäÿ©</title>
    
    <!-- SheetJS (xlsx) for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- PDF.js for PDF to Image conversion -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // ÿ™ŸáŸäÿ¶ÿ© PDF.js worker
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }
    </script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp, getApps, deleteApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, updateDoc, deleteDoc, query, where, orderBy, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, deleteUser } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© Firebase Storage - ÿ≥ŸÜÿ≥ÿ™ÿÆÿØŸÖ base64 ŸÅŸä Firestore ÿ®ÿØŸÑÿßŸã ŸÖŸÜŸá
        
        // ŸÖŸÅÿßÿ™Ÿäÿ≠ localStorage
        const HRM_FIREBASE_CONFIG_KEY = 'hrm_firebase_config';
        const HRM_FOLDER_PATH_KEY = 'hrm_folder_path';
        const HRM_CURRENT_COMPANY_KEY = 'hrm_current_company';
        
        // ÿ¨ÿπŸÑ ÿßŸÑŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ŸÖÿ™ÿßÿ≠ÿ© ÿπÿßŸÑŸÖŸäÿßŸã
        window.HRM_FIREBASE_CONFIG_KEY = HRM_FIREBASE_CONFIG_KEY;
        window.HRM_FOLDER_PATH_KEY = HRM_FOLDER_PATH_KEY;
        window.HRM_CURRENT_COMPANY_KEY = HRM_CURRENT_COMPANY_KEY;
        
        // ÿ™ŸáŸäÿ¶ÿ© Firebase
        async function initializeFirebase() {
            try {
                // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ŸÖŸÜ localStorage
                const savedConfig = localStorage.getItem(HRM_FIREBASE_CONFIG_KEY);
                let firebaseConfig = null;
                
                if (savedConfig) {
                    firebaseConfig = JSON.parse(savedConfig);
                } else {
                    // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©
                    firebaseConfig = {
                        apiKey: "AIzaSyDIv558hbbEgBfErYUAjtI41HFDI_P6bLM",
                        authDomain: "purchase-order-f1010.firebaseapp.com",
                        projectId: "purchase-order-f1010",
                        storageBucket: "purchase-order-f1010.firebasestorage.app",
                        messagingSenderId: "340050509000",
                        appId: "1:340050509000:web:08a6605bf0e595ecd679fd"
                    };
                    // ÿ≠ŸÅÿ∏ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©
                    localStorage.setItem(HRM_FIREBASE_CONFIG_KEY, JSON.stringify(firebaseConfig));
                }
                
                // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿ™ÿ∑ÿ®ŸäŸÇ Firebase ŸÖŸáŸäÿ£ ŸÖÿ≥ÿ®ŸÇÿßŸã
                const existingApps = getApps();
                let app;
                
                if (existingApps.length > 0) {
                    // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑŸÖŸàÿ¨ŸàÿØ
                    app = existingApps[0];
                } else {
                    // ÿ•ŸÜÿ¥ÿßÿ° ÿ™ÿ∑ÿ®ŸäŸÇ ÿ¨ÿØŸäÿØ
                    app = initializeApp(firebaseConfig, 'HRM_App');
                }
                
                const db = getFirestore(app);
                
                // ÿ™ŸáŸäÿ¶ÿ© Authentication
                let auth;
                try {
                    auth = getAuth(app);
                } catch (authError) {
                    console.warn('ÿ™ÿ≠ÿ∞Ÿäÿ±: ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ŸáŸäÿ¶ÿ© Firebase Authentication:', authError);
                    auth = null;
                }
                
                // ÿ¨ÿπŸÑ ÿßŸÑŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ŸÖÿ™ÿßÿ≠ÿ© ÿπÿßŸÑŸÖŸäÿßŸã
                window.db = db;
                window.auth = auth;
                window.firestore = { collection, doc, setDoc, getDoc, getDocs, updateDoc, deleteDoc, query, where, orderBy, addDoc, serverTimestamp };
                window.onAuthStateChanged = onAuthStateChanged;
                window.signInWithEmailAndPassword = signInWithEmailAndPassword;
                window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
                window.signOut = signOut;
                window.deleteUser = deleteUser;
                
                console.log('‚úÖ ÿ™ŸÖ ÿ™ŸáŸäÿ¶ÿ© Firebase ÿ®ŸÜÿ¨ÿßÿ≠');
                
                // ÿ¨ÿπŸÑ ÿßŸÑÿØÿßŸÑÿ© ŸÖÿ™ÿßÿ≠ÿ© ÿπÿßŸÑŸÖŸäÿßŸã
                window.initializeFirebase = initializeFirebase;
                
                return true;
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ŸáŸäÿ¶ÿ© Firebase:', error);
                return false;
            }
        }
        
        // ÿ™ŸáŸäÿ¶ÿ© Firebase ÿπŸÜÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©
        initializeFirebase().then(() => {
            console.log('Firebase initialization completed');
        }).catch(error => {
            console.error('Firebase initialization failed:', error);
        });
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Cairo', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            min-height: 100vh;
            padding: 5px;
        }

        .container {
            max-width: 100%;
            width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 25px 80px rgba(0,0,0,0.4), 0 0 0 1px rgba(255,255,255,0.1);
            overflow: hidden;
            animation: containerSlideIn 0.6s ease-out;
            height: calc(100vh - 10px);
            display: flex;
            flex-direction: column;
        }

        @keyframes containerSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.98);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: headerShimmer 8s infinite;
        }

        .header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.3) 50%, transparent 100%);
        }

        @keyframes headerShimmer {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 25px;
            position: relative;
            z-index: 1;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
            flex: 1;
            min-width: 300px;
        }

        .header-logo {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            transition: all 0.3s;
        }

        .header-logo:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .header-logo img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .header-logo-placeholder {
            font-size: 2em;
            opacity: 0.8;
        }

        .header-title-section {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .header h1 {
            font-size: 1.6em;
            margin: 0;
            font-weight: 700;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
            position: relative;
            z-index: 1;
            text-align: right;
            line-height: 1.2;
        }

        .header-company-name {
            font-size: 0.95em;
            opacity: 0.9;
            font-weight: 500;
            margin-top: 3px;
            text-shadow: 0 1px 5px rgba(0,0,0,0.2);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .header-user-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
            padding: 12px 20px;
            background: rgba(255,255,255,0.15);
            border-radius: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.3s;
        }

        .header-user-info:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }

        .header-user-name {
            font-weight: 600;
            font-size: 1.05em;
            text-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .header-user-role {
            font-size: 0.9em;
            opacity: 0.85;
            text-transform: capitalize;
        }

        .header-logout-btn {
            padding: 12px 24px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-logout-btn:hover {
            background: rgba(220, 53, 69, 1);
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(220, 53, 69, 0.4);
        }

        .header-logout-btn:active {
            transform: translateY(0);
        }

        .header-language-btn {
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-language-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .header-language-btn:active {
            transform: translateY(0);
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }

            .header-left {
                flex-direction: column;
                text-align: center;
            }

            .header-title-section {
                align-items: center;
            }

            .header h1 {
                text-align: center;
            }

            .header-right {
                width: 100%;
                justify-content: center;
            }
        }

        .nav {
            background: linear-gradient(to bottom, #ffffff 0%, #f8f9fa 100%);
            padding: 0;
            display: flex;
            flex-wrap: wrap;
            border-bottom: 3px solid #e9ecef;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .nav-btn {
            flex: 1;
            min-width: 120px;
            padding: 12px 18px;
            background: transparent;
            border: none;
            border-bottom: 4px solid transparent;
            cursor: pointer;
            font-size: 15px;
            color: #666;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
            position: relative;
        }

        .nav-btn::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateX(-50%);
        }

        .nav-btn:hover {
            background: linear-gradient(to bottom, #f0f4ff 0%, #e9ecef 100%);
            color: #667eea;
            transform: translateY(-2px);
        }

        .nav-btn:hover::before {
            width: 80%;
        }

        .nav-btn.active {
            color: #667eea;
            font-weight: 700;
            background: linear-gradient(to bottom, #f0f4ff 0%, #ffffff 100%);
        }

        .nav-btn.active::before {
            width: 100%;
        }

        .content {
            padding: 15px 20px;
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3), 0 0 0 1px rgba(255,255,255,0.1);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
            transition: all 0.6s;
        }

        .stat-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4), 0 0 0 1px rgba(255,255,255,0.2);
        }

        .stat-card:hover::before {
            top: -30%;
            right: -30%;
        }

        .stat-card h2 {
            font-size: 2.2em;
            margin-bottom: 8px;
            font-weight: 800;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
            position: relative;
            z-index: 1;
        }

        .stat-card p {
            font-size: 0.95em;
            opacity: 0.95;
            font-weight: 500;
            position: relative;
            z-index: 1;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #5568d3 0%, #653a8a 100%);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:active {
            transform: translateY(-1px);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #218838 0%, #1aa179 100%);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(40, 167, 69, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #c82333 0%, #bd2130 100%);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(220, 53, 69, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            color: white;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #5a6268 0%, #495057 100%);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(108, 117, 125, 0.4);
        }

        .btn-info {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
        }

        .btn-info:hover {
            background: linear-gradient(135deg, #138496 0%, #117a8b 100%);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(23, 162, 184, 0.4);
        }

        .table-container {
            overflow-x: auto;
            margin-top: 10px;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        th, td {
            padding: 10px 12px;
            text-align: right;
            border-bottom: 1px solid #e9ecef;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 700;
            font-size: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        th:first-child {
            border-top-right-radius: 12px;
        }

        th:last-child {
            border-top-left-radius: 12px;
        }

        tr {
            transition: all 0.2s ease;
        }

        tr:hover {
            background: linear-gradient(to left, #f0f4ff 0%, #ffffff 100%);
            transform: scale(1.01);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }

        tr:last-child td:first-child {
            border-bottom-right-radius: 12px;
        }

        tr:last-child td:last-child {
            border-bottom-left-radius: 12px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: #ffffff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1), 0 4px 12px rgba(102, 126, 234, 0.15);
            transform: translateY(-2px);
        }

        .form-group input:hover,
        .form-group select:hover,
        .form-group textarea:hover {
            border-color: #cbd5e0;
        }

        .hidden {
            display: none !important;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #ffffff;
            margin: auto;
            padding: 0;
            border: none;
            border-radius: 20px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(255,255,255,0.1);
            animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }

        .modal-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%);
            animation: headerShimmer 6s infinite;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.6em;
            font-weight: 700;
            text-shadow: 0 2px 8px rgba(0,0,0,0.2);
            position: relative;
            z-index: 1;
        }

        .modal-close {
            color: white;
            font-size: 36px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            z-index: 1;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg) scale(1.1);
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            background: #ffffff;
        }

        .modal-body::-webkit-scrollbar {
            width: 8px;
        }

        .modal-body::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .modal-body::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
        }

        .modal-body::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5568d3 0%, #653a8a 100%);
        }

        .badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 18px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .action-buttons button {
            padding: 10px 18px;
            font-size: 14px;
        }

        /* ŸÉÿ±Ÿàÿ™ ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ± */
        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .report-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 2px solid #e9ecef;
            border-radius: 20px;
            padding: 30px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .report-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transform: scaleX(0);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .report-card:hover {
            transform: translateY(-8px) scale(1.02);
            border-color: #667eea;
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.25);
        }

        .report-card:hover::before {
            transform: scaleX(1);
        }

        .report-card .icon {
            font-size: 3.5em;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            transition: all 0.3s;
        }

        .report-card:hover .icon {
            transform: scale(1.1) rotate(5deg);
        }

        .report-card h3 {
            color: #667eea;
            margin-bottom: 12px;
            font-size: 1.4em;
            font-weight: 700;
        }

        .report-card p {
            color: #666;
            font-size: 14px;
            line-height: 1.6;
        }

        /* ÿ™ÿ≠ÿ≥ŸäŸÜÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ© */
        .content {
            padding: 15px 20px;
        }

        .section h2 {
            font-size: 1.6em;
            font-weight: 700;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* ÿ™ÿ≠ÿ≥ŸäŸÜÿßÿ™ ŸÑŸÑÿ®ÿ≠ÿ´ ŸàÿßŸÑŸÅŸÑÿßÿ™ÿ± */
        .search-filter-container {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
        }

        /* ÿ™ÿ≠ÿ≥ŸäŸÜÿßÿ™ ŸÑŸÑÿ£ŸäŸÇŸàŸÜÿßÿ™ */
        .icon-large {
            font-size: 2.5em;
            margin-bottom: 15px;
        }
        /* Ÿàÿßÿ¨Ÿáÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ */
        .login-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            overflow-y: auto;
            padding: 20px;
        }

        .login-container.hidden {
            display: none !important;
        }

        .login-box {
            background: white;
            border-radius: 25px;
            box-shadow: 0 25px 80px rgba(0,0,0,0.4);
            padding: 50px 40px;
            width: 100%;
            max-width: 480px;
            text-align: center;
            position: relative;
            overflow: hidden;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        }

        .login-icon {
            font-size: 5em;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        .login-box h2 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.2em;
            font-weight: 700;
        }

        .login-box p {
            color: #666;
            margin-bottom: 35px;
            font-size: 15px;
        }

        .login-form-group {
            margin-bottom: 25px;
            text-align: right;
            position: relative;
        }

        .login-form-group label {
            display: block;
            margin-bottom: 10px;
            color: #333;
            font-weight: 600;
            font-size: 15px;
        }

        .login-form-group input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s;
            box-sizing: border-box;
        }

        .login-form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }

        .login-remember {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            text-align: right;
        }

        .login-remember label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #666;
            font-size: 14px;
            cursor: pointer;
            user-select: none;
        }

        .login-remember input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #667eea;
        }

        .login-error {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            display: none;
            border-right: 4px solid #dc3545;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .login-error.show {
            display: block;
        }

        .login-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            position: relative;
            overflow: hidden;
        }

        .login-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .login-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .login-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        .login-btn:active {
            transform: translateY(-1px);
        }

        .login-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .login-loading {
            display: none;
            text-align: center;
            color: #667eea;
            margin-top: 20px;
            font-size: 15px;
        }

        .login-loading.show {
            display: block;
        }

        .login-loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .login-footer {
            margin-top: 35px;
            padding-top: 25px;
            border-top: 2px solid #f0f0f0;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .login-footer button {
            background: transparent;
            border: none;
            color: #667eea;
            cursor: pointer;
            font-size: 14px;
            padding: 10px;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .login-footer button:hover {
            background: #f8f9fa;
            text-decoration: none;
        }
        /* ============================================
           ÿ±ÿ≥ŸÖ ŸáŸäŸÉŸÑŸä ŸÑŸÑÿ¥ÿ±ŸÉÿ© (Organizational Chart) - ÿ™ÿµŸÖŸäŸÖ ÿßÿ≠ÿ™ÿ±ÿßŸÅŸä
           ============================================ */
        .org-chart-container {
            width: 100%;
            overflow-x: auto;
            overflow-y: auto;
            padding: 30px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 600px;
            position: relative;
        }

        .org-chart {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 100%;
            padding: 50px 30px;
            background: transparent;
            max-width: 100%;
        }
        
        /* ÿ™ÿ≠ÿ≥ŸäŸÜ ÿßŸÑÿπÿ±ÿ∂ ÿπŸÑŸâ ÿßŸÑÿ¥ÿßÿ¥ÿßÿ™ ÿßŸÑŸÉÿ®Ÿäÿ±ÿ© */
        @media (min-width: 1200px) {
            .org-children-wrapper {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            }
            
            .org-children-wrapper.level-3-wrapper {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            }
            
            .org-children-wrapper.level-2-wrapper {
                grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            }
        }
        
        /* ÿ™ÿ≠ÿ≥ŸäŸÜ ÿßŸÑÿπÿ±ÿ∂ ÿπŸÑŸâ ÿßŸÑÿ¥ÿßÿ¥ÿßÿ™ ÿßŸÑŸÖÿ™Ÿàÿ≥ÿ∑ÿ© */
        @media (max-width: 1199px) and (min-width: 768px) {
            .org-children-wrapper {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
        }
        
        /* ÿ™ÿ≠ÿ≥ŸäŸÜ ÿßŸÑÿπÿ±ÿ∂ ÿπŸÑŸâ ÿßŸÑÿ¥ÿßÿ¥ÿßÿ™ ÿßŸÑÿµÿ∫Ÿäÿ±ÿ© */
        @media (max-width: 767px) {
            .org-children-wrapper {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .org-node {
                max-width: 100%;
            }
        }

        .org-level {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            width: 100%;
            margin-bottom: 50px;
            position: relative;
        }
        
        /* ÿ™ÿ≠ÿ≥ŸäŸÜ ÿπÿ±ÿ∂ ÿßŸÑŸÖÿ≥ÿ™ŸàŸäÿßÿ™ ÿßŸÑŸÖÿÆÿ™ŸÑŸÅÿ© */
        .org-level.level-0 {
            margin-bottom: 60px;
        }
        
        .org-level.level-1 {
            margin-bottom: 50px;
        }
        
        .org-level.level-2 {
            margin-bottom: 40px;
        }
        
        .org-level.level-3 {
            margin-bottom: 30px;
        }

        .org-node {
            background: white;
            border: 4px solid;
            border-radius: 16px;
            padding: 25px;
            margin: 0;
            min-width: 280px;
            max-width: 320px;
            width: auto;
            flex-shrink: 0;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.05);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            cursor: pointer;
            overflow: hidden;
            box-sizing: border-box;
        }

        .org-node::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.5), transparent);
            transform: translateX(-100%);
            transition: transform 0.6s;
        }

        .org-node:hover::before {
            transform: translateX(100%);
        }

        .org-node:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2), 0 0 0 1px rgba(0, 0, 0, 0.05);
        }

        .org-node.level-0 {
            border-color: #667eea;
            background: linear-gradient(145deg, #667eea 0%, #764ba2 50%, #667eea 100%);
            color: white;
            font-size: 1.3em;
            font-weight: bold;
            box-shadow: 0 10px 35px rgba(102, 126, 234, 0.4), inset 0 1px 0 rgba(255,255,255,0.2);
            min-width: 350px;
            max-width: 400px;
            margin: 0 auto;
        }

        .org-node.level-0::after {
            content: 'üëë';
            position: absolute;
            top: -15px;
            right: -15px;
            font-size: 2em;
            opacity: 0.3;
            transform: rotate(15deg);
        }

        .org-node.level-1 {
            border-color: #28a745;
            background: linear-gradient(145deg, #28a745 0%, #20c997 50%, #28a745 100%);
            color: white;
            box-shadow: 0 8px 30px rgba(40, 167, 69, 0.3), inset 0 1px 0 rgba(255,255,255,0.2);
        }

        .org-node.level-2 {
            border-color: #ff9800;
            background: linear-gradient(145deg, #ff9800 0%, #ff6b35 50%, #ff9800 100%);
            color: white;
            box-shadow: 0 8px 30px rgba(255, 152, 0, 0.3), inset 0 1px 0 rgba(255,255,255,0.2);
        }

        .org-node.level-3 {
            border-color: #17a2b8;
            background: linear-gradient(145deg, #17a2b8 0%, #6f42c1 50%, #17a2b8 100%);
            color: white;
            box-shadow: 0 8px 30px rgba(23, 162, 184, 0.3), inset 0 1px 0 rgba(255,255,255,0.2);
        }

        .org-node.level-4 {
            border-color: #6c757d;
            background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
            color: #333;
            border-width: 3px;
            box-shadow: 0 6px 25px rgba(108, 117, 125, 0.2);
        }

        .org-node-title {
            font-size: 1.25em;
            font-weight: 700;
            margin-bottom: 10px;
            text-align: center;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
            letter-spacing: 0.5px;
            line-height: 1.3;
            word-break: break-word;
        }

        .org-node.level-4 .org-node-title {
            color: #667eea;
            text-shadow: none;
        }

        .org-node-subtitle {
            font-size: 0.9em;
            opacity: 0.9;
            text-align: center;
            margin-bottom: 10px;
            font-weight: 500;
            font-style: italic;
            padding: 4px 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            display: inline-block;
        }

        .org-node-count {
            font-size: 0.9em;
            opacity: 0.9;
            text-align: center;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 2px solid rgba(255, 255, 255, 0.4);
            font-weight: 600;
        }

        .org-node.level-4 .org-node-count {
            border-top-color: #e9ecef;
            color: #666;
        }

        .org-node-managers {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 2px solid rgba(255, 255, 255, 0.4);
        }

        .org-node-managers div {
            font-size: 0.85em;
            margin-bottom: 6px;
            padding: 4px 8px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 6px;
            backdrop-filter: blur(10px);
        }

        .org-connector {
            position: absolute;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            z-index: 0;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .org-connector.vertical {
            width: 4px;
            height: 50px;
            top: -50px;
            left: 50%;
            transform: translateX(-50%);
            border-radius: 2px;
        }

        .org-connector.horizontal {
            height: 4px;
            width: 100%;
            top: 50%;
            transform: translateY(-50%);
            border-radius: 2px;
        }

        .org-children {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            position: relative;
            margin-top: 50px;
            padding-top: 40px;
            width: 100%;
        }
        
        /* ÿ™ÿ≠ÿ≥ŸäŸÜ ÿßŸÑŸÖÿ≥ÿßŸÅÿ© ÿ®ŸäŸÜ ÿßŸÑŸÖÿ≥ÿ™ŸàŸäÿßÿ™ ŸÅŸä ÿßŸÑÿ¥ÿ¨ÿ±ÿ© */
        .org-node.level-0 .org-children {
            margin-top: 60px;
            padding-top: 50px;
        }
        
        .org-node.level-1 .org-children {
            margin-top: 50px;
            padding-top: 40px;
        }
        
        .org-node.level-2 .org-children {
            margin-top: 45px;
            padding-top: 35px;
        }
        
        .org-node.level-3 .org-children {
            margin-top: 40px;
            padding-top: 30px;
        }
        
        /* ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ÿ™ÿ∏Ÿáÿ± ŸÉŸÅÿ±Ÿàÿπ Ÿàÿßÿ∂ÿ≠ÿ© */
        .org-node.level-0 .org-children .org-children-wrapper,
        .org-node.level-2 .org-children .org-children-wrapper {
            display: block;
            width: 100%;
        }

        .org-children::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            width: 4px;
            height: 30px;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            transform: translateX(-50%);
            border-radius: 2px;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .org-children-wrapper {
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: flex-start;
            gap: 25px;
            position: relative;
            width: 100%;
            flex-wrap: wrap;
            padding: 20px 0;
            margin-top: 20px;
        }
        
        /* ÿ™ÿ≠ÿ≥ŸäŸÜ ÿπÿ±ÿ∂ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ŸÅŸä ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ - ÿπÿ±ÿ∂ ÿ£ŸÅŸÇŸä ŸÖÿ´ŸÑ ÿßŸÑÿ¥ÿ¨ÿ±ÿ© */
        .org-children-wrapper.level-3-wrapper {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 20px;
            justify-items: center;
            width: 100%;
            max-width: 100%;
            padding: 20px 10px;
            flex-wrap: nowrap;
        }
        
        /* ÿ™ÿ≠ÿ≥ŸäŸÜ ÿπÿ±ÿ∂ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ÿπŸÜÿØŸÖÿß ÿ™ŸÉŸàŸÜ ŸÇŸÑŸäŸÑÿ© (1-3 ÿ£ŸÇÿ≥ÿßŸÖ) */
        .org-children-wrapper.level-3-wrapper:has(.org-node-wrapper:only-child),
        .org-children-wrapper.level-3-wrapper:has(.org-node-wrapper:nth-child(2):last-child),
        .org-children-wrapper.level-3-wrapper:has(.org-node-wrapper:nth-child(3):last-child) {
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* ÿ™ÿ≠ÿ≥ŸäŸÜ ÿπÿ±ÿ∂ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ÿπŸÜÿØŸÖÿß ÿ™ŸÉŸàŸÜ ŸÖÿ™Ÿàÿ≥ÿ∑ÿ© (4-6 ÿ£ŸÇÿ≥ÿßŸÖ) */
        .org-children-wrapper.level-3-wrapper:has(.org-node-wrapper:nth-child(4):last-child),
        .org-children-wrapper.level-3-wrapper:has(.org-node-wrapper:nth-child(5):last-child),
        .org-children-wrapper.level-3-wrapper:has(.org-node-wrapper:nth-child(6):last-child) {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }
        
        /* ÿ™ÿ≠ÿ≥ŸäŸÜ ÿπÿ±ÿ∂ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ÿπŸÜÿØŸÖÿß ÿ™ŸÉŸàŸÜ ŸÉÿ´Ÿäÿ±ÿ© (7+ ÿ£ŸÇÿ≥ÿßŸÖ) */
        .org-children-wrapper.level-3-wrapper:has(.org-node-wrapper:nth-child(7)) {
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }
        
        /* ÿ™ÿ≠ÿ≥ŸäŸÜ ÿπÿ±ÿ∂ ÿßŸÑÿπŸÇÿØ ŸÅŸä grid ŸÑŸÑÿ£ŸÇÿ≥ÿßŸÖ */
        .org-children-wrapper.level-3-wrapper .org-node-wrapper {
            width: 100%;
            max-width: 100%;
        }
        
        .org-children-wrapper.level-3-wrapper .org-node {
            width: 100%;
            max-width: 100%;
        }
        
        /* ÿ™ÿ≠ÿ≥ŸäŸÜ ÿπÿ±ÿ∂ ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ ŸÅŸä ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ */
        .org-children-wrapper.level-2-wrapper {
            gap: 25px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        /* ÿ™ÿ≠ÿ≥ŸäŸÜ ÿπÿ±ÿ∂ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ */
        .org-children-wrapper.level-1-wrapper {
            gap: 30px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* ÿÆÿ∑ ÿßÿ™ÿµÿßŸÑ ÿ£ŸÅŸÇŸä ŸÖŸÜ ÿßŸÑÿπŸÇÿØÿ© ÿßŸÑÿ£ŸÖ ÿ•ŸÑŸâ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿ®ŸÜÿßÿ° */
        .org-children-wrapper::before {
            content: '';
            position: absolute;
            top: -40px;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent 0%, #667eea 5%, #667eea 95%, transparent 100%);
            z-index: 0;
            border-radius: 2px;
        }

        /* ÿÆÿ∑ ÿßÿ™ÿµÿßŸÑ ÿ±ÿ£ÿ≥Ÿä ŸÖŸÜ ÿßŸÑÿπŸÇÿØÿ© ÿßŸÑÿ£ŸÖ */
        .org-children-wrapper::after {
            content: '';
            position: absolute;
            top: -40px;
            left: 50%;
            width: 3px;
            height: 40px;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            transform: translateX(-50%);
            z-index: 0;
            border-radius: 2px;
        }
        
        /* ÿ™ÿ≠ÿ≥ŸäŸÜ ÿÆÿ∑Ÿàÿ∑ ÿßŸÑÿßÿ™ÿµÿßŸÑ ŸÑŸÑÿ£ŸÇÿ≥ÿßŸÖ (ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ 3) */
        .org-children-wrapper.level-3-wrapper::before {
            top: -35px;
            height: 2.5px;
        }
        
        .org-children-wrapper.level-3-wrapper::after {
            top: -35px;
            height: 35px;
            width: 2.5px;
        }

        .org-node {
            position: relative;
            z-index: 1;
        }
        
        /* wrapper ŸÑŸÑÿπŸÇÿØ ŸÑÿ±ÿ≥ŸÖ ÿÆÿ∑Ÿàÿ∑ ÿßŸÑÿßÿ™ÿµÿßŸÑ */
        .org-node-wrapper {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 0 0 auto;
        }
        
        /* ÿÆÿ∑ ÿßÿ™ÿµÿßŸÑ ÿ±ÿ£ÿ≥Ÿä ŸÖŸÜ ÿßŸÑÿπŸÇÿØÿ© ÿ•ŸÑŸâ ÿ£ÿ®ŸÜÿßÿ¶Ÿáÿß */
        .org-node-wrapper::before {
            content: '';
            position: absolute;
            top: -40px;
            left: 50%;
            width: 3px;
            height: 40px;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            transform: translateX(-50%);
            z-index: 0;
            border-radius: 2px;
        }
        
        /* ÿ•ÿÆŸÅÿßÿ° ÿßŸÑÿÆÿ∑ ÿßŸÑÿ±ÿ£ÿ≥Ÿä ŸÑŸÑÿπŸÇÿØÿ© ÿßŸÑÿ¨ÿ∞ÿ±Ÿäÿ© */
        .org-level:first-child .org-node-wrapper::before {
            display: none;
        }
        
        /* ÿÆÿ∑ ÿßÿ™ÿµÿßŸÑ ÿ£ŸÅŸÇŸä ÿ®ŸäŸÜ ÿßŸÑÿπŸÇÿØ ŸÅŸä ŸÜŸÅÿ≥ ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ */
        .org-children-wrapper::before {
            content: '';
            position: absolute;
            top: -40px;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent 0%, #667eea 10%, #667eea 90%, transparent 100%);
            z-index: 0;
            border-radius: 2px;
        }
        
        /* ÿÆÿ∑ ÿßÿ™ÿµÿßŸÑ ÿ±ÿ£ÿ≥Ÿä ŸÖŸÜ ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑÿ£ÿπŸÑŸâ */
        .org-children-wrapper::after {
            content: '';
            position: absolute;
            top: -40px;
            left: 50%;
            width: 3px;
            height: 40px;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            transform: translateX(-50%);
            z-index: 0;
            border-radius: 2px;
        }
        
        /* ÿÆÿ∑Ÿàÿ∑ ÿßÿ™ÿµÿßŸÑ ÿ£ŸÅŸÇŸäÿ© ÿ®ŸäŸÜ ÿßŸÑÿπŸÇÿØ ÿßŸÑŸÖÿ™ÿ¨ÿßŸàÿ±ÿ© */
        .org-node-wrapper:not(:first-child)::after {
            content: '';
            position: absolute;
            left: -15px;
            top: -40px;
            width: 15px;
            height: 3px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            z-index: 0;
        }
        
        /* ÿÆÿ∑ ÿßÿ™ÿµÿßŸÑ ÿ±ÿ£ÿ≥Ÿä ŸÅŸä ÿßŸÑŸÖŸÜÿ™ÿµŸÅ */
        .org-node-wrapper:first-child::after {
            content: '';
            position: absolute;
            left: 50%;
            top: -40px;
            width: 3px;
            height: 40px;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            transform: translateX(-50%);
            z-index: 0;
        }

        .org-employee-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }

        .org-employee-card {
            background: rgba(255, 255, 255, 0.25);
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 10px;
            padding: 12px;
            font-size: 0.9em;
            text-align: center;
            backdrop-filter: blur(10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .org-employee-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        
        .org-employee-card:hover::before {
            left: 100%;
        }

        .org-employee-card:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: translateY(-2px);
        }

        .org-employee-card strong {
            display: block;
            margin-bottom: 4px;
            font-weight: 600;
        }

        .org-node.level-4 .org-employee-card {
            background: #ffffff;
            border-color: #e9ecef;
            color: #333;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .org-node.level-4 .org-employee-card:hover {
            background: #f8f9fa;
            border-color: #667eea;
        }

        .org-controls {
            position: sticky;
            top: 10px;
            z-index: 100;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
            border: 2px solid #e9ecef;
        }

        .org-controls button {
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .org-controls button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .org-zoom-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .org-zoom-level {
            font-weight: bold;
            min-width: 70px;
            text-align: center;
            color: #667eea;
            font-size: 16px;
        }

        .org-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .org-stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 30px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.1);
            border: 2px solid #e9ecef;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .org-stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .org-stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 35px rgba(0, 0, 0, 0.15);
        }

        .org-stat-number {
            font-size: 3em;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
            line-height: 1;
        }

        .org-stat-label {
            color: #666;
            font-size: 1em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* ============================================
           ÿ™ÿµŸÖŸäŸÖ ÿßÿ≠ÿ™ÿ±ÿßŸÅŸä ŸÑŸÑÿ∑ÿ®ÿßÿπÿ©
           ============================================ */
        @media print {
            @page {
                size: A4 landscape;
                margin: 1.5cm;
            }

            body {
                background: white !important;
            }

            .org-controls {
                display: none !important;
            }

            .org-chart-container {
                overflow: visible !important;
                background: white !important;
                padding: 0 !important;
            }

            .org-chart {
                padding: 20px 0 !important;
                transform: scale(1) !important;
            }

            .org-node {
                break-inside: avoid;
                page-break-inside: avoid;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
                border-width: 2px !important;
                margin: 10px !important;
                padding: 15px !important;
            }

            .org-node:hover {
                transform: none !important;
            }

            .org-node::before {
                display: none !important;
            }

            .org-node::after {
                display: none !important;
            }

            .org-level {
                margin-bottom: 30px !important;
                page-break-inside: avoid;
            }

            .org-children {
                margin-top: 20px !important;
                padding-top: 15px !important;
            }

            .org-children-wrapper {
                gap: 20px !important;
            }

            .org-stats {
                margin-bottom: 20px !important;
                page-break-after: avoid;
            }

            .org-stat-card {
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
                border: 1px solid #e9ecef !important;
            }

            .org-stat-card::before {
                display: none !important;
            }

            .org-employee-card {
                break-inside: avoid;
                page-break-inside: avoid;
            }

            /* ÿ™ÿ≠ÿ≥ŸäŸÜ ÿßŸÑÿ£ŸÑŸàÿßŸÜ ŸÑŸÑÿ∑ÿ®ÿßÿπÿ© */
            .org-node.level-0 {
                background: linear-gradient(145deg, #667eea 0%, #764ba2 100%) !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .org-node.level-1 {
                background: linear-gradient(145deg, #28a745 0%, #20c997 100%) !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .org-node.level-2 {
                background: linear-gradient(145deg, #ff9800 0%, #ff6b35 100%) !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .org-node.level-3 {
                background: linear-gradient(145deg, #17a2b8 0%, #6f42c1 100%) !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            /* ÿ•ÿ∂ÿßŸÅÿ© ÿ±ÿ£ÿ≥ Ÿàÿ™ÿ∞ŸäŸäŸÑ ŸÑŸÑÿ∑ÿ®ÿßÿπÿ© */
            .org-chart::before {
                content: 'ÿ™ŸÇÿ±Ÿäÿ± ŸáŸäŸÉŸÑ ÿßŸÑÿ¥ÿ±ŸÉÿ©';
                display: block;
                text-align: center;
                font-size: 24px;
                font-weight: bold;
                color: #667eea;
                margin-bottom: 30px;
                padding-bottom: 15px;
                border-bottom: 3px solid #667eea;
            }

            .org-chart::after {
                content: 'ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±: ' attr(data-report-date);
                display: block;
                text-align: center;
                font-size: 12px;
                color: #666;
                margin-top: 30px;
                padding-top: 15px;
                border-top: 1px solid #e9ecef;
            }
        }
    </style>
</head>
<body>
    <!-- Ÿàÿßÿ¨Ÿáÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <div class="login-icon">üîê</div>
            <h2>ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ</h2>
            <p>ŸÜÿ∏ÿßŸÖ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸàÿßÿ±ÿØ ÿßŸÑÿ®ÿ¥ÿ±Ÿäÿ©</p>
            
            <div id="loginError" class="login-error"></div>
            
            <form id="loginForm" onsubmit="handleLogin(event)" autocomplete="off">
                <div class="login-form-group">
                    <label>ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä:</label>
                    <input type="email" id="loginEmail" placeholder="ÿ£ÿØÿÆŸÑ ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä" required autocomplete="off">
                </div>
                
                <div class="login-form-group">
                    <label>ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±:</label>
                    <input type="password" id="loginPassword" placeholder="ÿ£ÿØÿÆŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±" required autocomplete="off">
                </div>
                
                <div class="login-remember">
                    <label>
                        <input type="checkbox" id="rememberMe">
                        <span>ÿ™ÿ∞ŸÉÿ±ŸÜŸä</span>
                    </label>
                </div>
                
                <button type="submit" class="login-btn" id="loginBtn">
                    ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
                </button>
            </form>
            
            <div id="loginLoading" class="login-loading">
                ÿ¨ÿßÿ±Ÿä ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
            </div>
            
            <div class="login-footer">
                <button type="button" onclick="resetBrowserData()" style="color: #dc3545;">
                    üîÑ ÿ™ŸáŸäÿ¶ÿ© ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ™ÿµŸÅÿ≠
                </button>
            </div>
        </div>
    </div>

    <!-- ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä -->
    <div id="app" class="container hidden">
        <div class="header">
            <div class="header-content">
                <div class="header-left">
                    <div class="header-logo" id="companyLogoHeader">
                        <div class="header-logo-placeholder">üè¢</div>
                    </div>
                    <div class="header-title-section">
                        <h1 id="headerSystemTitle">ŸÜÿ∏ÿßŸÖ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸàÿßÿ±ÿØ ÿßŸÑÿ®ÿ¥ÿ±Ÿäÿ©</h1>
                        <div class="header-company-name" id="companyNameHeader"></div>
                    </div>
                </div>
                <div class="header-right">
                    <div class="header-user-info" id="userInfo">
                        <div class="header-user-name">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</div>
                        <div class="header-user-role"></div>
                    </div>
                    <button class="header-language-btn" onclick="toggleLanguage()" title="ÿ™ÿ®ÿØŸäŸÑ ÿßŸÑŸÑÿ∫ÿ© / Switch Language">
                        <span id="languageIcon">üåê</span>
                        <span id="languageText">EN</span>
                    </button>
                    <button class="header-logout-btn" onclick="handleLogout()">
                        <span>üö™</span>
                        <span id="logoutText">ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="nav">
            <button class="nav-btn active" onclick="showSection('dashboard')">üìä ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ</button>
            <button class="nav-btn" onclick="showSection('employees')">üë• ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ</button>
            <button class="nav-btn" onclick="showSection('projects')">üìÅ ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ</button>
            <button class="nav-btn" onclick="showSection('regions')">üåç ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ</button>
            <button class="nav-btn" onclick="showSection('departments')">üèõÔ∏è ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ</button>
            <button class="nav-btn" onclick="showSection('leaves')">üìÖ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™</button>
            <button class="nav-btn" onclick="showSection('reports')">üìà ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ±</button>
            <button class="nav-btn" onclick="showSection('users')">üë§ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ</button>
            <button class="nav-btn" onclick="showSection('settings')">‚öôÔ∏è ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™</button>
        </div>

        <div class="content">
            <!-- ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ -->
            <div id="dashboard" class="section active">
                <h2 style="margin-bottom: 20px; color: #667eea;">ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ</h2>
                <div class="stats">
                    <div class="stat-card">
                        <h2 id="totalEmployees">0</h2>
                        <p>ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ</p>
                    </div>
                    <div class="stat-card">
                        <h2 id="totalProjects">0</h2>
                        <p>ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ</p>
                    </div>
                    <div class="stat-card">
                        <h2 id="activeProjects">0</h2>
                        <p>ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ ÿßŸÑŸÜÿ¥ÿ∑ÿ©</p>
                    </div>
                    <div class="stat-card">
                        <h2 id="activeEmployees">0</h2>
                        <p>ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ ÿßŸÑŸÜÿ¥ÿ∑ŸäŸÜ</p>
                    </div>
                </div>
            </div>

            <!-- ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ -->
            <div id="employees" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                    <h2 style="margin: 0; color: #667eea;">ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="showAddEmployeeForm()">+ ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸàÿ∏ŸÅ ÿ¨ÿØŸäÿØ</button>
                        <button class="btn btn-success" onclick="showBulkAddEmployeesForm()">+ ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸàÿ∏ŸÅŸäŸÜ ŸÖÿ™ÿπÿØÿØŸäŸÜ</button>
                    </div>
                </div>

                <!-- ÿßŸÑÿ®ÿ≠ÿ´ ŸàÿßŸÑŸÅŸÑÿ™ÿ±ÿ© -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="form-group" style="margin: 0;">
                            <label>ÿßŸÑÿ®ÿ≠ÿ´:</label>
                            <input type="text" id="employeeSearch" placeholder="ÿßÿ®ÿ≠ÿ´ ÿ®ÿßŸÑÿßÿ≥ŸÖÿå ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑŸàÿ∏ŸäŸÅŸä..." onkeyup="filterEmployees()">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label>ÿßŸÑÿ≠ÿßŸÑÿ©:</label>
                            <select id="employeeStatusFilter" onchange="filterEmployees()">
                                <option value="">ÿßŸÑŸÉŸÑ</option>
                                <option value="active">ŸÜÿ¥ÿ∑</option>
                                <option value="inactive">ÿ∫Ÿäÿ± ŸÜÿ¥ÿ∑</option>
                                <option value="on-leave">ŸÅŸä ÿ•ÿ¨ÿßÿ≤ÿ©</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center;">
                        <span id="employeesCount" style="color: #666;">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ: 0</span>
                        <button class="btn btn-danger" onclick="clearEmployeeFilters()" style="padding: 8px 15px; font-size: 14px;">ŸÖÿ≥ÿ≠ ÿßŸÑŸÅŸÑÿßÿ™ÿ±</button>
                    </div>
                </div>

                <!-- ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ -->
                <div class="table-container">
                    <table id="employeesTable">
                        <thead>
                            <tr>
                                <th>ÿßŸÑÿµŸàÿ±ÿ©</th>
                                <th>ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑŸàÿ∏ŸäŸÅŸä</th>
                                <th>ÿßŸÑÿßÿ≥ŸÖ</th>
                                <th>ÿßŸÑŸÖÿ≥ŸÖŸâ ÿßŸÑŸàÿ∏ŸäŸÅŸä</th>
                                <th>ÿßŸÑŸÇÿ≥ŸÖ</th>
                                <th>ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä</th>
                                <th>ÿßŸÑŸáÿßÿ™ŸÅ</th>
                                <th>ÿßŸÑÿπŸÜŸàÿßŸÜ</th>
                                <th>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿπŸäŸäŸÜ</th>
                                <th>ÿßŸÑÿ≠ÿßŸÑÿ©</th>
                                <th>ÿßŸÑŸÖŸàÿ∏ŸÅ ÿßŸÑÿ®ÿØŸäŸÑ</th>
                                <th>ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
                            </tr>
                        </thead>
                        <tbody id="employeesTableBody">
                            <tr><td colspan="12" class="loading">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ -->
            <div id="projects" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                    <h2 style="margin: 0; color: #667eea;">ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ</h2>
                    <button class="btn btn-primary" onclick="showAddProjectForm()">+ ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ¥ÿ±Ÿàÿπ ÿ¨ÿØŸäÿØ</button>
                </div>

                <!-- ÿßŸÑÿ®ÿ≠ÿ´ ŸàÿßŸÑŸÅŸÑÿ™ÿ±ÿ© -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="form-group" style="margin: 0;">
                            <label>ÿßŸÑÿ®ÿ≠ÿ´:</label>
                            <input type="text" id="projectSearch" placeholder="ÿßÿ®ÿ≠ÿ´ ÿ®ÿßŸÑÿßÿ≥ŸÖÿå ÿßŸÑÿ±ŸÖÿ≤..." onkeyup="filterProjects()">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label>ÿßŸÑÿ≠ÿßŸÑÿ©:</label>
                            <select id="projectStatusFilter" onchange="filterProjects()">
                                <option value="">ÿßŸÑŸÉŸÑ</option>
                                <option value="active">ŸÜÿ¥ÿ∑</option>
                                <option value="completed">ŸÖŸÉÿ™ŸÖŸÑ</option>
                                <option value="on-hold">ŸÖÿ™ŸàŸÇŸÅ</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center;">
                        <span id="projectsCount" style="color: #666;">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ: 0</span>
                        <button class="btn btn-danger" onclick="clearProjectFilters()" style="padding: 8px 15px; font-size: 14px;">ŸÖÿ≥ÿ≠ ÿßŸÑŸÅŸÑÿßÿ™ÿ±</button>
                    </div>
                </div>

                <!-- ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ -->
                <div class="table-container">
                    <table id="projectsTable">
                        <thead>
                            <tr>
                                <th>ÿ±ŸÖÿ≤ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ</th>
                                <th>ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ</th>
                                <th>ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©</th>
                                <th>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ®ÿØÿ°</th>
                                <th>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ°</th>
                                <th>ÿßŸÑÿ≠ÿßŸÑÿ©</th>
                                <th>ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
                            </tr>
                        </thead>
                        <tbody id="projectsTableBody">
                            <tr><td colspan="7" class="loading">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ -->
            <div id="regions" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                    <h2 style="margin: 0; color: #667eea;">ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ</h2>
                    <button class="btn btn-primary" onclick="showAddRegionForm()">+ ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ∑ŸÇÿ© ÿ¨ÿØŸäÿØÿ©</button>
                </div>

                <!-- ÿßŸÑÿ®ÿ≠ÿ´ -->
                <div class="search-filter-container">
                    <div class="form-group" style="margin: 0;">
                        <label>ÿßŸÑÿ®ÿ≠ÿ´:</label>
                        <input type="text" id="regionSearch" placeholder="ÿßÿ®ÿ≠ÿ´ ÿ®ÿßŸÑÿßÿ≥ŸÖ..." onkeyup="filterRegions()">
                    </div>
                    <div style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center;">
                        <span id="regionsCount" style="color: #666;">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ: 0</span>
                        <button class="btn btn-danger" onclick="clearRegionFilters()" style="padding: 8px 15px; font-size: 14px;">ŸÖÿ≥ÿ≠ ÿßŸÑŸÅŸÑÿßÿ™ÿ±</button>
                    </div>
                </div>

                <!-- ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ -->
                <div class="table-container">
                    <table id="regionsTable">
                        <thead>
                            <tr>
                                <th>ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©</th>
                                <th>ÿßŸÑŸàÿµŸÅ</th>
                                <th>ÿπÿØÿØ ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ</th>
                                <th>ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
                            </tr>
                        </thead>
                        <tbody id="regionsTableBody">
                            <tr><td colspan="4" class="loading">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ -->
            <div id="departments" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                    <h2 style="margin: 0; color: #667eea;">ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ</h2>
                    <button class="btn btn-primary" onclick="showAddDepartmentForm()">+ ÿ•ÿ∂ÿßŸÅÿ© ŸÇÿ≥ŸÖ ÿ¨ÿØŸäÿØ</button>
                </div>

                <!-- ÿßŸÑÿ®ÿ≠ÿ´ -->
                <div class="search-filter-container">
                    <div class="form-group" style="margin: 0;">
                        <label>ÿßŸÑÿ®ÿ≠ÿ´:</label>
                        <input type="text" id="departmentSearch" placeholder="ÿßÿ®ÿ≠ÿ´ ÿ®ÿßŸÑÿßÿ≥ŸÖ..." onkeyup="filterDepartments()">
                    </div>
                    <div style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center;">
                        <span id="departmentsCount" style="color: #666;">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ: 0</span>
                        <button class="btn btn-danger" onclick="clearDepartmentFilters()" style="padding: 8px 15px; font-size: 14px;">ŸÖÿ≥ÿ≠ ÿßŸÑŸÅŸÑÿßÿ™ÿ±</button>
                    </div>
                </div>

                <!-- ÿ¨ÿØŸàŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ -->
                <div class="table-container">
                    <table id="departmentsTable">
                        <thead>
                            <tr>
                                <th>ÿßÿ≥ŸÖ ÿßŸÑŸÇÿ≥ŸÖ</th>
                                <th>ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ/ÿßŸÑÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿπÿßŸÖÿ©</th>
                                <th>ÿßŸÑŸàÿµŸÅ</th>
                                <th>ÿπÿØÿØ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ</th>
                                <th>ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
                            </tr>
                        </thead>
                        <tbody id="departmentsTableBody">
                            <tr><td colspan="5" class="loading">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ -->
            <div id="leaves" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                    <h2 style="margin: 0; color: #667eea;">ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™</h2>
                    <button class="btn btn-primary" onclick="showAddLeaveForm()">+ ÿ•ÿ∂ÿßŸÅÿ© ÿ•ÿ¨ÿßÿ≤ÿ© ÿ¨ÿØŸäÿØÿ©</button>
                </div>

                <!-- ÿßŸÑÿ®ÿ≠ÿ´ ŸàÿßŸÑŸÅŸÑÿ™ÿ±ÿ© -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <!-- ÿ™ŸÜŸÇŸÑ ÿßŸÑÿ£ÿ¥Ÿáÿ± -->
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px; flex-wrap: wrap;">
                        <span style="font-weight: bold; color: #667eea;">ÿπÿ±ÿ∂ ÿ•ÿ¨ÿßÿ≤ÿßÿ™:</span>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <button type="button" class="btn btn-secondary" onclick="navigateLeavesMonth(-1)" style="padding: 6px 12px; font-size: 14px;" title="ÿßŸÑÿ¥Ÿáÿ± ÿßŸÑÿ≥ÿßÿ®ŸÇ">‚óÄ</button>
                            <span id="leavesMonthLabel" style="min-width: 120px; font-weight: bold; text-align: center;">ŸäŸÜÿßŸäÿ± 2025</span>
                            <button type="button" class="btn btn-secondary" onclick="navigateLeavesMonth(1)" style="padding: 6px 12px; font-size: 14px;" title="ÿßŸÑÿ¥Ÿáÿ± ÿßŸÑÿ™ÿßŸÑŸä">‚ñ∂</button>
                        </div>
                        <button type="button" class="btn btn-primary" id="leavesViewAllBtn" onclick="setLeavesViewAll()" style="padding: 6px 15px; font-size: 14px;">ÿπÿ±ÿ∂ ŸÉŸÑ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™</button>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="form-group" style="margin: 0;">
                            <label>ÿßŸÑÿ®ÿ≠ÿ´:</label>
                            <input type="text" id="leaveSearch" placeholder="ÿßÿ®ÿ≠ÿ´ ÿ®ÿßÿ≥ŸÖ ÿßŸÑŸÖŸàÿ∏ŸÅ..." onkeyup="filterLeaves()">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label>ŸÜŸàÿπ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ©:</label>
                            <select id="leaveTypeFilter" onchange="filterLeaves()">
                                <option value="">ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ŸÜŸàÿßÿπ</option>
                                <option value="monthly">ÿ•ÿ¨ÿßÿ≤ÿ© ÿ¥Ÿáÿ±Ÿäÿ©</option>
                                <option value="hourly">ÿ•ÿ¨ÿßÿ≤ÿ© ÿ≤ŸÖŸÜŸäÿ©</option>
                                <option value="unpaid">ÿ•ÿ¨ÿßÿ≤ÿ© ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ®</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label>ÿßŸÑÿ≠ÿßŸÑÿ©:</label>
                            <select id="leaveStatusFilter" onchange="filterLeaves()">
                                <option value="">ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ÿßŸÑÿßÿ™</option>
                                <option value="pending">ŸÇŸäÿØ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±</option>
                                <option value="approved">ŸÖŸàÿßŸÅŸÇ ÿπŸÑŸäŸáÿß</option>
                                <option value="rejected">ŸÖÿ±ŸÅŸàÿ∂ÿ©</option>
                                <option value="cancelled">ŸÖŸÑÿ∫ÿßÿ©</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center;">
                        <span id="leavesCount" style="color: #666;">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™: 0</span>
                        <button class="btn btn-danger" onclick="clearLeaveFilters()" style="padding: 8px 15px; font-size: 14px;">ŸÖÿ≥ÿ≠ ÿßŸÑŸÅŸÑÿßÿ™ÿ±</button>
                    </div>
                </div>

                <!-- ÿ¨ÿØŸàŸÑ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ -->
                <div class="table-container">
                    <table id="leavesTable">
                        <thead>
                            <tr>
                                <th>ÿßÿ≥ŸÖ ÿßŸÑŸÖŸàÿ∏ŸÅ</th>
                                <th>ŸÜŸàÿπ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ©</th>
                                <th>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ®ÿØÿ°</th>
                                <th>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ°</th>
                                <th>ÿßŸÑŸÖÿØÿ©</th>
                                <th>ÿßŸÑÿ≠ÿßŸÑÿ©</th>
                                <th>ÿßŸÑÿÆÿµŸÖ <span id="deductionLockIcon" style="color: #dc3545; cursor: pointer;" onclick="toggleDeductionView()" title="ÿßŸÜŸÇÿ± ŸÑÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿÆÿµŸàŸÖÿßÿ™">üîí</span></th>
                                <th>ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™</th>
                                <th>ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
                            </tr>
                        </thead>
                        <tbody id="leavesTableBody">
                            <tr><td colspan="9" class="loading">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ -->
            <div id="users" class="section">
                <div id="usersSectionLocked" style="display: none; text-align: center; padding: 60px 20px; background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); border-radius: 15px; border: 3px solid #ffc107;">
                    <div style="font-size: 5em; margin-bottom: 20px;">üîí</div>
                    <h2 style="color: #856404; margin-bottom: 15px;">Ÿáÿ∞ÿß ÿßŸÑŸÇÿ≥ŸÖ ŸÖÿ≠ŸÖŸä ÿ®ŸÉŸÑŸÖÿ© ŸÖÿ±Ÿàÿ±</h2>
                    <p style="color: #856404; font-size: 1.1em; margin-bottom: 30px;">Ÿäÿ¨ÿ® ÿ•ÿØÿÆÿßŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ŸÑŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸâ ŸÇÿ≥ŸÖ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ</p>
                    <button class="btn btn-warning" onclick="unlockUsersSection()" style="padding: 15px 40px; font-size: 18px; font-weight: bold;">
                        üîì ÿ•ÿØÿÆÿßŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±
                    </button>
                </div>
                
                <div id="usersSectionContent" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                        <h2 style="margin: 0; color: #667eea;">ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ</h2>
                        <div>
                            <button class="btn btn-danger" onclick="lockUsersSection()" style="margin-left: 10px; padding: 10px 20px;">
                                üîí ŸÇŸÅŸÑ ÿßŸÑŸÇÿ≥ŸÖ
                            </button>
                            <button class="btn btn-primary" onclick="showAddUserForm()">+ ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ¨ÿØŸäÿØ</button>
                        </div>
                    </div>

                    <!-- ÿßŸÑÿ®ÿ≠ÿ´ ŸàÿßŸÑŸÅŸÑÿ™ÿ±ÿ© -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="form-group" style="margin: 0;">
                            <label>ÿßŸÑÿ®ÿ≠ÿ´:</label>
                            <input type="text" id="userSearch" placeholder="ÿßÿ®ÿ≠ÿ´ ÿ®ÿßŸÑÿßÿ≥ŸÖÿå ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä..." onkeyup="filterUsers()">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label>ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ©:</label>
                            <select id="userRoleFilter" onchange="filterUsers()">
                                <option value="">ÿ¨ŸÖŸäÿπ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™</option>
                                <option value="admin">ŸÖÿØŸäÿ± ÿßŸÑŸÜÿ∏ÿßŸÖ</option>
                                <option value="hr">ŸÖŸàÿßÿ±ÿØ ÿ®ÿ¥ÿ±Ÿäÿ©</option>
                                <option value="manager">ŸÖÿØŸäÿ±</option>
                                <option value="employee">ŸÖŸàÿ∏ŸÅ</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label>ÿßŸÑÿ≠ÿßŸÑÿ©:</label>
                            <select id="userStatusFilter" onchange="filterUsers()">
                                <option value="">ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ÿßŸÑÿßÿ™</option>
                                <option value="active">ŸÜÿ¥ÿ∑</option>
                                <option value="inactive">ÿ∫Ÿäÿ± ŸÜÿ¥ÿ∑</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center;">
                        <span id="usersCount" style="color: #666;">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ: 0</span>
                        <button class="btn btn-danger" onclick="clearUserFilters()" style="padding: 8px 15px; font-size: 14px;">ŸÖÿ≥ÿ≠ ÿßŸÑŸÅŸÑÿßÿ™ÿ±</button>
                    </div>
                </div>

                <!-- ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ -->
                <div class="table-container">
                    <table id="usersTable">
                        <thead>
                            <tr>
                                <th>ÿßŸÑÿßÿ≥ŸÖ</th>
                                <th>ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä</th>
                                <th>ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ©</th>
                                <th>ÿßŸÑÿ≠ÿßŸÑÿ©</th>
                                <th>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ•ŸÜÿ¥ÿßÿ°</th>
                                <th>ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr><td colspan="6" class="loading">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</td></tr>
                        </tbody>
                    </table>
                </div>
                </div>
            </div>

            <!-- ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ± -->
            <div id="reports" class="section">
                <h2 style="margin-bottom: 20px; color: #667eea;">üìà ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ±</h2>
                
                <!-- ÿ£ŸÜŸàÿßÿπ ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ± -->
                <div class="reports-grid">
                    <!-- ÿ™ŸÇÿ±Ÿäÿ± ÿ≠ÿ±ŸÉÿ© ÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑŸÖŸàÿ∏ŸÅ -->
                    <div class="report-card" onclick="showEmployeeLeaveHistoryReportModal()">
                        <div style="text-align: center;">
                            <div class="icon">üìã</div>
                            <h3>ÿ™ŸÇÿ±Ÿäÿ± ÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑŸÖŸàÿ∏ŸÅ</h3>
                            <p>ÿ≠ÿ±ŸÉÿ© ÿ™ÿßÿ±ŸäÿÆŸäÿ© ŸÑŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ŸàÿßŸÑÿ±ÿµŸäÿØ</p>
                        </div>
                    </div>
                    
                    <!-- ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ŸàÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ -->
                    <div class="report-card" onclick="showProjectEmployeesReportModal()">
                        <div style="text-align: center;">
                            <div class="icon">üë•üìÅ</div>
                            <h3>ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ</h3>
                            <p>ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ ŸÅŸä ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ</p>
                        </div>
                    </div>
                    
                    <!-- ÿ™ŸÇÿ±Ÿäÿ± ÿ≠ÿ±ŸÉÿ© ŸÖÿ¥ÿßÿ±Ÿäÿπ ÿßŸÑŸÖŸàÿ∏ŸÅ -->
                    <div class="report-card" onclick="showEmployeeProjectsHistoryReportModal()">
                        <div style="text-align: center;">
                            <div class="icon">üìÅüìã</div>
                            <h3>ÿ™ŸÇÿ±Ÿäÿ± ŸÖÿ¥ÿßÿ±Ÿäÿπ ÿßŸÑŸÖŸàÿ∏ŸÅ</h3>
                            <p>ÿ≠ÿ±ŸÉÿ© ÿ™ÿßÿ±ŸäÿÆŸäÿ© ŸÑŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ</p>
                        </div>
                    </div>
                    
                    <!-- ÿ™ŸÇÿ±Ÿäÿ± ŸáŸäŸÉŸÑ ÿßŸÑÿ¥ÿ±ŸÉÿ© -->
                    <div class="report-card" onclick="generateCompanyStructureReport()">
                        <div style="text-align: center;">
                            <div class="icon">üè¢</div>
                            <h3>ÿ™ŸÇÿ±Ÿäÿ± ŸáŸäŸÉŸÑ ÿßŸÑÿ¥ÿ±ŸÉÿ©</h3>
                            <p>ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ ŸàÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ ŸàÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ</p>
                        </div>
                    </div>
                    
                    <!-- ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ -->
                    <div class="report-card" onclick="showEmployeeReportModal()">
                        <div style="text-align: center;">
                            <div class="icon">üë•</div>
                            <h3>ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ</h3>
                            <p>ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ Ÿàÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ</p>
                        </div>
                    </div>
                    
                    <!-- ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ™ŸÇŸäŸäŸÖÿßÿ™ ÿßŸÑÿ≥ŸÜŸàŸäÿ© -->
                    <div class="report-card" onclick="generateEvaluationsReport()">
                        <div style="text-align: center;">
                            <div class="icon">‚≠ê</div>
                            <h3>ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ™ŸÇŸäŸäŸÖÿßÿ™ ÿßŸÑÿ≥ŸÜŸàŸäÿ©</h3>
                            <p>ÿ™ŸÇŸäŸäŸÖÿßÿ™ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ ÿßŸÑÿ≥ŸÜŸàŸäÿ©</p>
                        </div>
                    </div>
                    
                    <!-- ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ -->
                    <div class="report-card" onclick="generateLeaveReport()">
                        <div style="text-align: center;">
                            <div class="icon">üìÖ</div>
                            <h3>ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™</h3>
                            <p>ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ Ÿàÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™</p>
                        </div>
                    </div>
                    
                    <!-- ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿÆÿµŸàŸÖÿßÿ™ -->
                    <div class="report-card" onclick="generateDeductionReport()">
                        <div style="text-align: center;">
                            <div class="icon">üîí</div>
                            <h3>ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿÆÿµŸàŸÖÿßÿ™</h3>
                            <p>ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿÆÿµŸàŸÖÿßÿ™ ÿßŸÑŸÖÿßŸÑŸäÿ©</p>
                        </div>
                    </div>
                    
                    <!-- ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ -->
                    <div class="report-card" onclick="generateProjectReport()">
                        <div style="text-align: center;">
                            <div class="icon">üìÅ</div>
                            <h3>ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ</h3>
                            <p>ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ Ÿàÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ</p>
                        </div>
                    </div>
                    
                    <!-- ÿ™ŸÇÿ±Ÿäÿ± ÿ•ÿ≠ÿµÿßÿ¶Ÿä ÿπÿßŸÖ -->
                    <div class="report-card" onclick="generateStatisticsReport()">
                        <div style="text-align: center;">
                            <div class="icon">üìä</div>
                            <h3>ÿ™ŸÇÿ±Ÿäÿ± ÿ•ÿ≠ÿµÿßÿ¶Ÿä ÿπÿßŸÖ</h3>
                            <p>ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿ¥ÿßŸÖŸÑÿ© ŸÑŸÑŸÜÿ∏ÿßŸÖ</p>
                        </div>
                    </div>
                </div>
                
                <!-- ŸÖŸÜÿ∑ŸÇÿ© ÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± -->
                <div id="reportContent" style="display: none;">
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 id="reportTitle" style="margin: 0; color: #667eea;"></h3>
                            <div>
                                <button class="btn btn-info" onclick="printReport()" style="margin-left: 10px;">üñ®Ô∏è ÿ∑ÿ®ÿßÿπÿ©</button>
                                <button class="btn btn-success" onclick="exportReportToPDF()" style="margin-left: 10px;">üìÑ ÿ™ÿµÿØŸäÿ± PDF</button>
                                <button class="btn btn-primary" onclick="exportReportToExcel()">üìä ÿ™ÿµÿØŸäÿ± Excel</button>
                                <button class="btn btn-danger" onclick="closeReport()">‚úï ÿ•ÿ∫ŸÑÿßŸÇ</button>
                            </div>
                        </div>
                        <div id="reportBody" style="background: white; padding: 20px; border-radius: 8px;">
                            <!-- ŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿ≥Ÿäÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ™Ÿá ŸáŸÜÿß -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ -->
            <div id="settings" class="section">
                <h2 style="margin-bottom: 20px; color: #667eea;">ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™</h2>
                
                <!-- ÿ•ÿπÿØÿßÿØÿßÿ™ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ -->
                <div style="background: #f8f9fa; padding: 30px; border-radius: 10px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: #667eea;">ÿ•ÿπÿØÿßÿØÿßÿ™ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ Firebase</h3>
                        <button class="btn btn-primary" onclick="toggleDatabaseSettingsEdit()" id="dbEditBtn">üîì ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™</button>
                    </div>
                    
                    <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                        <p style="margin: 0; color: #856404; font-size: 14px;">
                            üîí ÿ•ÿπÿØÿßÿØÿßÿ™ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ≠ŸÖŸäÿ© ÿ®ŸÉŸÑŸÖÿ© ŸÖÿ±Ÿàÿ±. Ÿäÿ¨ÿ® ÿ•ÿØÿÆÿßŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ŸÑŸÑÿ™ÿπÿØŸäŸÑ.
                        </p>
                    </div>

                    <div id="databaseSettingsForm">
                        <div class="form-group">
                            <label>API Key:</label>
                            <input type="text" id="dbApiKey" readonly style="background: #e9ecef;">
                        </div>
                        <div class="form-group">
                            <label>Auth Domain:</label>
                            <input type="text" id="dbAuthDomain" readonly style="background: #e9ecef;">
                        </div>
                        <div class="form-group">
                            <label>Project ID:</label>
                            <input type="text" id="dbProjectId" readonly style="background: #e9ecef;">
                        </div>
                        <div class="form-group">
                            <label>Storage Bucket:</label>
                            <input type="text" id="dbStorageBucket" readonly style="background: #e9ecef;">
                        </div>
                        <div class="form-group">
                            <label>Messaging Sender ID:</label>
                            <input type="text" id="dbMessagingSenderId" readonly style="background: #e9ecef;">
                        </div>
                        <div class="form-group">
                            <label>App ID:</label>
                            <input type="text" id="dbAppId" readonly style="background: #e9ecef;">
                        </div>
                        
                        <div id="dbSaveButtons" style="display: none; margin-top: 20px;">
                            <button class="btn btn-success" onclick="saveDatabaseSettings()">üíæ ÿ≠ŸÅÿ∏ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™</button>
                            <button class="btn btn-danger" onclick="cancelDatabaseSettingsEdit()">‚ùå ÿ•ŸÑÿ∫ÿßÿ°</button>
                        </div>
                    </div>
                </div>

                <!-- ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ¥ÿ±ŸÉÿ© -->
                <div style="background: #f8f9fa; padding: 30px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 20px; color: #667eea;">ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ¥ÿ±ŸÉÿ©</h3>
                    
                    <div class="form-group">
                        <label>ÿßÿ≥ŸÖ ÿßŸÑÿ¥ÿ±ŸÉÿ©: <span style="color: red;">*</span></label>
                        <input type="text" id="companyName" placeholder="ÿßÿ≥ŸÖ ÿßŸÑÿ¥ÿ±ŸÉÿ© ÿ£Ÿà ÿßŸÑŸÖÿ§ÿ≥ÿ≥ÿ©">
                    </div>
                    
                    <div class="form-group">
                        <label>ÿ¥ÿπÿßÿ± ÿßŸÑÿ¥ÿ±ŸÉÿ© (Logo):</label>
                        <div style="display: flex; gap: 20px; align-items: flex-start;">
                            <div style="flex: 1;">
                                <input type="file" id="companyLogoFile" accept="image/*" onchange="handleCompanyLogoUpload(event)" style="margin-bottom: 10px;">
                                <p style="color: #666; font-size: 12px; margin-top: 5px;">ÿßŸÑÿµŸäÿ∫ ÿßŸÑŸÖÿØÿπŸàŸÖÿ©: JPG, PNG, GIF (ÿßŸÑÿ≠ÿ¨ŸÖ ÿßŸÑÿ£ŸÇÿµŸâ: 2MB)</p>
                            </div>
                            <div id="companyLogoPreview" style="width: 150px; height: 150px; border: 2px dashed #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; background: white; overflow: hidden;">
                                <span style="color: #999;">ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑÿ¥ÿπÿßÿ±</span>
                            </div>
                        </div>
                        <button type="button" class="btn btn-danger" onclick="removeCompanyLogo()" id="removeLogoBtn" style="display: none; margin-top: 10px;">üóëÔ∏è ÿ≠ÿ∞ŸÅ ÿßŸÑÿ¥ÿπÿßÿ±</button>
                    </div>
                    
                    <div class="form-group">
                        <label>ÿßŸÑÿπŸÜŸàÿßŸÜ:</label>
                        <textarea id="companyAddress" rows="2" placeholder="ÿπŸÜŸàÿßŸÜ ÿßŸÑÿ¥ÿ±ŸÉÿ© ÿßŸÑŸÉÿßŸÖŸÑ"></textarea>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        <div class="form-group">
                            <label>ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ:</label>
                            <input type="tel" id="companyPhone" placeholder="+966XXXXXXXXX">
                        </div>
                        <div class="form-group">
                            <label>ÿ±ŸÇŸÖ ÿßŸÑŸÅÿßŸÉÿ≥:</label>
                            <input type="tel" id="companyFax" placeholder="+966XXXXXXXXX">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        <div class="form-group">
                            <label>ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä:</label>
                            <input type="email" id="companyEmail" placeholder="info@company.com">
                        </div>
                        <div class="form-group">
                            <label>ÿßŸÑŸÖŸàŸÇÿπ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä:</label>
                            <input type="url" id="companyWebsite" placeholder="https://www.company.com">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>ÿßŸÑÿ≥ÿ¨ŸÑ ÿßŸÑÿ™ÿ¨ÿßÿ±Ÿä:</label>
                        <input type="text" id="companyCommercialRegister" placeholder="ÿ±ŸÇŸÖ ÿßŸÑÿ≥ÿ¨ŸÑ ÿßŸÑÿ™ÿ¨ÿßÿ±Ÿä">
                    </div>
                    
                    <div class="form-group">
                        <label>ÿßŸÑŸàÿµŸÅ:</label>
                        <textarea id="companyDescription" rows="3" placeholder="ŸàÿµŸÅ ŸÖÿÆÿ™ÿµÿ± ÿπŸÜ ÿßŸÑÿ¥ÿ±ŸÉÿ©"></textarea>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button class="btn btn-success" onclick="saveCompanyInfo()">üíæ ÿ≠ŸÅÿ∏ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ¥ÿ±ŸÉÿ©</button>
                        <button class="btn btn-secondary" onclick="loadCompanyInfo()" style="margin-right: 10px;">üîÑ ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ</button>
                    </div>
                </div>

                <!-- ÿ≥ÿ¨ŸÑ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™ -->
                <div style="background: #f8f9fa; padding: 30px; border-radius: 10px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: #667eea;">üìã ÿ≥ÿ¨ŸÑ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™ (Audit Log)</h3>
                        <button class="btn btn-primary" onclick="loadAuditLogs(100); displayAuditLogs();">üîÑ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ≥ÿ¨ŸÑ</button>
                    </div>
                    
                    <div style="background: #e7f3ff; border-right: 4px solid #667eea; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <p style="margin: 0; color: #0c5460; font-size: 14px;">
                            üìù Ÿáÿ∞ÿß ÿßŸÑÿ≥ÿ¨ŸÑ Ÿäÿ≠ÿ™ŸàŸä ÿπŸÑŸâ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™ ÿßŸÑÿ™Ÿä ÿ™ŸÖÿ™ ÿπŸÑŸâ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ (ÿ•ÿ∂ÿßŸÅÿ©ÿå ÿ™ÿπÿØŸäŸÑÿå ÿ≠ÿ∞ŸÅ)
                        </p>
                    </div>

                    <div class="table-container">
                        <table id="auditLogsTable">
                            <thead>
                                <tr>
                                    <th>ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ŸàÿßŸÑŸàŸÇÿ™</th>
                                    <th>ŸÜŸàÿπ ÿßŸÑÿ≥ÿ¨ŸÑ</th>
                                    <th>ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°</th>
                                    <th>ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ</th>
                                    <th>ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ</th>
                                </tr>
                            </thead>
                            <tbody id="auditLogsTableBody">
                                <tr><td colspan="5" class="loading">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ŸÜÿßŸÅÿ∞ÿ© ÿ•ÿ∂ÿßŸÅÿ©/ÿ™ÿπÿØŸäŸÑ ŸÖŸàÿ∏ŸÅ -->
    <div id="employeeModal" class="modal">
        <div class="modal-content" style="max-width: 1200px;">
            <div class="modal-header">
                <h3 id="employeeFormTitle">ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸàÿ∏ŸÅ ÿ¨ÿØŸäÿØ</h3>
                <span class="modal-close" onclick="hideAddEmployeeForm()">&times;</span>
            </div>
            <div class="modal-body">
                <!-- ÿµŸàÿ±ÿ© ÿßŸÑŸÖŸàÿ∏ŸÅ -->
                <div style="margin-bottom: 20px; text-align: center;">
                    <div style="position: relative; display: inline-block;">
                        <img id="employeePhotoPreview" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='150' height='150'%3E%3Crect fill='%23e9ecef' width='150' height='150'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' dy='.3em' fill='%23666' font-size='14'%3EÿµŸàÿ±ÿ© ÿßŸÑŸÖŸàÿ∏ŸÅ%3C/text%3E%3C/svg%3E" 
                             style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 3px solid #667eea; cursor: pointer;"
                             onclick="document.getElementById('employeePhotoInput').click()">
                        <input type="file" id="employeePhotoInput" accept="image/*" style="display: none;" onchange="previewEmployeePhoto(event)">
                        <div style="margin-top: 10px;">
                            <button type="button" class="btn btn-primary" onclick="document.getElementById('employeePhotoInput').click()" style="padding: 8px 20px; font-size: 14px;">
                                üì∑ ÿßÿÆÿ™ÿ± ÿµŸàÿ±ÿ©
                            </button>
                            <button type="button" class="btn btn-danger" onclick="removeEmployeePhoto()" style="padding: 8px 20px; font-size: 14px; margin-right: 10px;">
                                üóëÔ∏è ÿ≠ÿ∞ŸÅ ÿßŸÑÿµŸàÿ±ÿ©
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ÿ±ŸÖÿ≤ ÿßŸÑŸÖŸàÿ∏ŸÅ (ÿ™ŸÑŸÇÿßÿ¶Ÿä) -->
                <div style="background: #e7f3ff; border-right: 4px solid #667eea; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑŸàÿ∏ŸäŸÅŸä:</label>
                    <div style="font-size: 18px; font-weight: bold; color: #667eea;" id="empNumberDisplay">EMP-001</div>
                    <p style="color: #666; font-size: 12px; margin-top: 5px; margin-bottom: 0;">ÿ≥Ÿäÿ™ŸÖ ÿ™ŸàŸÑŸäÿØ ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑŸàÿ∏ŸäŸÅŸä ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã</p>
                </div>

                <!-- ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ© -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                    <div class="form-group">
                        <label>ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ: <span style="color: red;">*</span></label>
                        <input type="text" id="empName" required>
                    </div>
                    <div class="form-group">
                        <label>ÿßŸÑÿßÿ≥ŸÖ ÿ®ÿßŸÑÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ©:</label>
                        <input type="text" id="empNameEn">
                    </div>
                    <div class="form-group">
                        <label>ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä:</label>
                        <input type="email" id="empEmail">
                    </div>
                    <div class="form-group">
                        <label>ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ:</label>
                        <input type="text" id="empPhone">
                    </div>
                    <div class="form-group">
                        <label>ÿßŸÑÿπŸÜŸàÿßŸÜ:</label>
                        <input type="text" id="empAddress" placeholder="ŸÖÿ´ÿßŸÑ: ÿ®ÿ∫ÿØÿßÿØÿå ÿßŸÑŸÉÿ±ÿßÿØÿ©">
                    </div>
                    <div class="form-group">
                        <label>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿπŸäŸäŸÜ:</label>
                        <input type="date" id="empHireDate">
                    </div>
                    <div class="form-group">
                        <label>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ•ÿØÿ±ÿßÿ¨ ŸÅŸä ÿßŸÑŸÜÿ∏ÿßŸÖ:</label>
                        <input type="date" id="empSystemEntryDate">
                        <p style="color: #666; font-size: 12px; margin-top: 5px;">ÿ™ÿßÿ±ŸäÿÆ ÿ•ÿØÿ±ÿßÿ¨ ÿßŸÑŸÖŸàÿ∏ŸÅ ŸÅŸä ÿßŸÑŸÜÿ∏ÿßŸÖ (ŸÑÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑÿ™ÿ±ÿßŸÉŸÖŸäÿ©)</p>
                    </div>
                    <div class="form-group">
                        <label>ÿßŸÑŸÖÿ≥ŸÖŸâ ÿßŸÑŸàÿ∏ŸäŸÅŸä:</label>
                        <input type="text" id="empPosition">
                    </div>
                    <div class="form-group">
                        <label>ÿßŸÑÿ™ÿ≠ÿµŸäŸÑ ÿßŸÑÿØÿ±ÿßÿ≥Ÿä:</label>
                        <select id="empEducation">
                            <option value="">ÿßÿÆÿ™ÿ± ÿßŸÑÿ™ÿ≠ÿµŸäŸÑ ÿßŸÑÿØÿ±ÿßÿ≥Ÿä</option>
                            <option value="elementary">ÿßÿ®ÿ™ÿØÿßÿ¶Ÿä</option>
                            <option value="middle">ŸÖÿ™Ÿàÿ≥ÿ∑</option>
                            <option value="high_school">ÿ´ÿßŸÜŸàŸä</option>
                            <option value="diploma">ÿØÿ®ŸÑŸàŸÖ</option>
                            <option value="bachelor">ÿ®ŸÉÿßŸÑŸàÿ±ŸäŸàÿ≥</option>
                            <option value="master">ŸÖÿßÿ¨ÿ≥ÿ™Ÿäÿ±</option>
                            <option value="phd">ÿØŸÉÿ™Ÿàÿ±ÿßŸá</option>
                            <option value="other">ÿ£ÿÆÿ±Ÿâ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ÿßŸÑÿßÿÆÿ™ÿµÿßÿµ:</label>
                        <input type="text" id="empSpecialization" placeholder="ŸÖÿ´ÿßŸÑ: ŸáŸÜÿØÿ≥ÿ© ÿ®ÿ±ŸÖÿ¨Ÿäÿßÿ™ÿå ŸÖÿ≠ÿßÿ≥ÿ®ÿ©ÿå ÿ•ÿØÿßÿ±ÿ© ÿ£ÿπŸÖÿßŸÑ">
                    </div>
                    <div class="form-group">
                        <label>ÿßŸÑÿ≠ÿßŸÑÿ©:</label>
                        <select id="empStatus">
                            <option value="active">ŸÜÿ¥ÿ∑</option>
                            <option value="inactive">ÿ∫Ÿäÿ± ŸÜÿ¥ÿ∑</option>
                            <option value="on-leave">ŸÅŸä ÿ•ÿ¨ÿßÿ≤ÿ©</option>
                            <option value="terminated">ŸÖŸÜÿ™ŸáŸä ÿßŸÑÿÆÿØŸÖÿ©</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ÿ±ŸÖÿ≤ ÿßŸÑÿ±ÿßÿ™ÿ®:</label>
                        <input type="text" id="empSalaryCode" placeholder="ŸÖÿ´ÿßŸÑ: SAL-001">
                    </div>
                    <div class="form-group">
                        <label>ÿßŸÑŸÖŸàÿ∏ŸÅ ÿßŸÑÿ®ÿØŸäŸÑ (ŸÅŸä ÿ≠ÿßŸÑÿ© ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ©):</label>
                        <select id="empReplacement">
                            <option value="">ŸÑÿß ŸäŸàÿ¨ÿØ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ÿßŸÑŸÇÿ≥ŸÖ:</label>
                        <select id="empDepartment">
                            <option value="">-- ÿßÿÆÿ™ÿ± ÿßŸÑŸÇÿ≥ŸÖ --</option>
                        </select>
                        <p style="color: #666; font-size: 12px; margin-top: 5px;">ÿßŸÑŸÇÿ≥ŸÖ ÿßŸÑÿ∞Ÿä ŸäŸÜÿ™ŸÖŸä ÿ•ŸÑŸäŸá ÿßŸÑŸÖŸàÿ∏ŸÅ ŸÅŸä ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ÿ£Ÿà ÿßŸÑÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿπÿßŸÖÿ©</p>
                    </div>
                    <div class="form-group">
                        <label>ŸÖŸÉÿßŸÜ ÿßŸÑÿπŸÖŸÑ:</label>
                        <select id="empWorkLocation">
                            <option value="">-- ÿßÿÆÿ™ÿ± ŸÖŸÉÿßŸÜ ÿßŸÑÿπŸÖŸÑ --</option>
                        </select>
                        <p style="color: #666; font-size: 12px; margin-top: 5px;">ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿ£Ÿà ÿßŸÑŸÖŸÉÿßŸÜ ÿßŸÑÿ∞Ÿä ŸäÿπŸÖŸÑ ŸÅŸäŸá ÿßŸÑŸÖŸàÿ∏ŸÅ</p>
                    </div>
                    <div class="form-group">
                        <label>ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑÿ¥Ÿáÿ±Ÿäÿ© (ÿ®ÿßŸÑÿ£ŸäÿßŸÖ):</label>
                        <input type="number" id="empMonthlyLeaveDays" min="0" step="0.5" placeholder="ŸÖÿ´ÿßŸÑ: 2.5" value="2.5">
                        <p style="color: #666; font-size: 12px; margin-top: 5px;">ÿπÿØÿØ ÿ£ŸäÿßŸÖ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿßŸÑÿ¥Ÿáÿ±Ÿäÿ© ÿßŸÑŸÖÿ™ÿßÿ≠ÿ©</p>
                    </div>
                    <div class="form-group">
                        <label>ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ© (ÿ®ÿßŸÑÿ≥ÿßÿπÿßÿ™):</label>
                        <input type="number" id="empHourlyLeaveHours" min="0" step="0.5" placeholder="ŸÖÿ´ÿßŸÑ: 8" value="8">
                        <p style="color: #666; font-size: 12px; margin-top: 5px;">ÿπÿØÿØ ÿ≥ÿßÿπÿßÿ™ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿßŸÑÿ≤ŸÖŸÜŸäÿ© ÿßŸÑŸÖÿ™ÿßÿ≠ÿ©</p>
                    </div>
                    <div class="form-group">
                        <label>ÿßŸÑÿ±ÿµŸäÿØ ÿßŸÑÿ™ÿ±ÿßŸÉŸÖŸä ÿßŸÑÿßÿ®ÿ™ÿØÿßÿ¶Ÿä (ÿ®ÿßŸÑÿ£ŸäÿßŸÖ):</label>
                        <input type="number" id="empInitialLeaveBalance" step="0.5" placeholder="ŸÖÿ´ÿßŸÑ: 5 ÿ£Ÿà -2" value="0">
                        <p style="color: #666; font-size: 12px; margin-top: 5px;">ÿ±ÿµŸäÿØ ÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßÿ®ÿ™ÿØÿßÿ¶Ÿä (ŸäŸÖŸÉŸÜ ÿ£ŸÜ ŸäŸÉŸàŸÜ ÿ≥ÿßŸÑÿ®ÿßŸã)</p>
                    </div>
                </div>

                <!-- ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ±ÿßÿ™ÿ® (ŸÖÿ≠ŸÖŸäÿ©) -->
                <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #e9ecef;">
                    <h4 style="margin-bottom: 15px; color: #667eea;">ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ±ÿßÿ™ÿ® (ŸÖÿ≠ŸÖŸäÿ©)</h4>
                    <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <p style="margin: 0; color: #856404; font-size: 14px;">
                            üîí Ÿáÿ∞Ÿá ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™ ŸÖÿ≠ŸÖŸäÿ© ÿ®ŸÉŸÑŸÖÿ© ŸÖÿ±Ÿàÿ±. Ÿäÿ¨ÿ® ÿ•ÿØÿÆÿßŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ŸÑÿπÿ±ÿ∂ ÿ£Ÿà ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ±ÿßÿ™ÿ®.
                        </p>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                        <div class="form-group">
                            <label>ÿßŸÑÿ±ÿßÿ™ÿ® ÿßŸÑÿßÿ®ÿ™ÿØÿßÿ¶Ÿä:</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="password" id="empInitialSalary" placeholder="****" readonly style="flex: 1;">
                                <select id="empInitialSalaryCurrency" style="width: 100px; padding: 8px; border: 1px solid #ddd; border-radius: 5px; background: #f8f9fa;" disabled>
                                    <option value="IQD">IQD</option>
                                    <option value="USD">USD</option>
                                </select>
                                <button type="button" class="btn btn-primary" onclick="showSalaryField('initial')" style="padding: 8px 15px; font-size: 14px;">
                                    üîì ÿπÿ±ÿ∂/ÿ™ÿπÿØŸäŸÑ
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>ÿßŸÑÿ±ÿßÿ™ÿ® ÿßŸÑÿ≠ÿßŸÑŸä:</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="password" id="empCurrentSalary" placeholder="****" readonly style="flex: 1;">
                                <select id="empCurrentSalaryCurrency" style="width: 100px; padding: 8px; border: 1px solid #ddd; border-radius: 5px; background: #f8f9fa;" disabled>
                                    <option value="IQD">IQD</option>
                                    <option value="USD">USD</option>
                                </select>
                                <button type="button" class="btn btn-primary" onclick="showSalaryField('current')" style="padding: 8px 15px; font-size: 14px;">
                                    üîì ÿπÿ±ÿ∂/ÿ™ÿπÿØŸäŸÑ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ÿ¨Ÿáÿßÿ™ ÿßŸÑÿßÿ™ÿµÿßŸÑ -->
                <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #e9ecef;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="margin: 0; color: #667eea;">ÿ¨Ÿáÿßÿ™ ÿßŸÑÿßÿ™ÿµÿßŸÑ (ÿßŸÑÿ£ŸÇÿßÿ±ÿ®)</h4>
                        <button type="button" class="btn btn-primary" onclick="addContact()" style="padding: 8px 20px; font-size: 14px;">
                            ‚ûï ÿ•ÿ∂ÿßŸÅÿ© ÿ¨Ÿáÿ© ÿßÿ™ÿµÿßŸÑ
                        </button>
                    </div>
                    <div id="employeeContactsList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">
                        <!-- ÿ≥Ÿäÿ™ŸÖ ÿπÿ±ÿ∂ ÿ¨Ÿáÿßÿ™ ÿßŸÑÿßÿ™ÿµÿßŸÑ ŸáŸÜÿß -->
                    </div>
                </div>

                <!-- ÿ≥ÿ¨ŸÑ ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ -->
                <div id="employeeProjectsHistory" style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #e9ecef;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="margin: 0; color: #667eea;">ÿ≥ÿ¨ŸÑ ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ</h4>
                        <button type="button" class="btn btn-primary" onclick="showAddProjectToHistoryForm()" style="padding: 8px 20px; font-size: 14px;">
                            ‚ûï ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ¥ÿ±Ÿàÿπ
                        </button>
                    </div>
                    <div id="projectsHistoryList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-bottom: 15px;">
                        <!-- ÿ≥Ÿäÿ™ŸÖ ÿπÿ±ÿ∂ ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ ŸáŸÜÿß -->
                    </div>
                </div>

                <!-- ÿ≥ÿ¨ŸÑ ÿßŸÑÿπŸÇŸàÿ®ÿßÿ™ -->
                <div id="employeePenalties" style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #e9ecef;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="margin: 0; color: #dc3545;">ÿ≥ÿ¨ŸÑ ÿßŸÑÿπŸÇŸàÿ®ÿßÿ™</h4>
                        <button type="button" class="btn btn-danger" onclick="showAddPenaltyForm()" style="padding: 8px 20px; font-size: 14px;">
                            ‚ûï ÿ•ÿ∂ÿßŸÅÿ© ÿπŸÇŸàÿ®ÿ©
                        </button>
                    </div>
                    <div id="penaltiesList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin-bottom: 15px;">
                        <!-- ÿ≥Ÿäÿ™ŸÖ ÿπÿ±ÿ∂ ÿßŸÑÿπŸÇŸàÿ®ÿßÿ™ ŸáŸÜÿß -->
                    </div>
                </div>

                <!-- ÿ≥ÿ¨ŸÑ ÿßŸÑŸÖŸÉÿßŸÅÿ¢ÿ™ -->
                <div id="employeeRewards" style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #e9ecef;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="margin: 0; color: #28a745;">ÿ≥ÿ¨ŸÑ ÿßŸÑŸÖŸÉÿßŸÅÿ¢ÿ™</h4>
                        <button type="button" class="btn btn-success" onclick="showAddRewardForm()" style="padding: 8px 20px; font-size: 14px;">
                            ‚ûï ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÉÿßŸÅÿ£ÿ©
                        </button>
                    </div>
                    <div id="rewardsList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin-bottom: 15px;">
                        <!-- ÿ≥Ÿäÿ™ŸÖ ÿπÿ±ÿ∂ ÿßŸÑŸÖŸÉÿßŸÅÿ¢ÿ™ ŸáŸÜÿß -->
                    </div>
                </div>

                <!-- ÿ≥ÿ¨ŸÑ ÿßŸÑÿ™ŸÇŸäŸäŸÖ ÿßŸÑÿ≥ŸÜŸàŸä (ŸÖÿ≠ŸÖŸä) -->
                <div id="employeeAnnualEvaluations" style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #e9ecef;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="margin: 0; color: #ff9800;">
                            ‚≠ê ÿ≥ÿ¨ŸÑ ÿßŸÑÿ™ŸÇŸäŸäŸÖ ÿßŸÑÿ≥ŸÜŸàŸä
                            <span id="evaluationLockIcon" style="color: #dc3545; cursor: pointer; margin-right: 10px; font-size: 0.8em;" onclick="toggleEvaluationView()" title="ÿßŸÜŸÇÿ± ŸÑÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿ™ŸÇŸäŸäŸÖÿßÿ™">üîí</span>
                        </h4>
                        <button type="button" class="btn btn-info" id="addEvaluationBtn" onclick="showAddEvaluationForm()" style="padding: 8px 20px; font-size: 14px; display: none;">
                            ‚ûï ÿ•ÿ∂ÿßŸÅÿ© ÿ™ŸÇŸäŸäŸÖ ÿ≥ŸÜŸàŸä
                        </button>
                    </div>
                    <div id="evaluationsList" style="display: none; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 15px; margin-bottom: 15px;">
                        <!-- ÿ≥Ÿäÿ™ŸÖ ÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÇŸäŸäŸÖÿßÿ™ ÿßŸÑÿ≥ŸÜŸàŸäÿ© ŸáŸÜÿß -->
                    </div>
                    <div id="evaluationsLockedMessage" style="text-align: center; padding: 40px; background: #fff3cd; border: 2px solid #ffc107; border-radius: 10px; color: #856404;">
                        <div style="font-size: 3em; margin-bottom: 15px;">üîí</div>
                        <div style="font-size: 1.2em; font-weight: bold; margin-bottom: 10px;">Ÿáÿ∞ÿß ÿßŸÑŸÇÿ≥ŸÖ ŸÖÿ≠ŸÖŸä ÿ®ŸÉŸÑŸÖÿ© ŸÖÿ±Ÿàÿ±</div>
                        <div style="margin-bottom: 20px;">ÿßŸÜŸÇÿ± ÿπŸÑŸâ ÿ£ŸäŸÇŸàŸÜÿ© ÿßŸÑŸÇŸÅŸÑ ŸÑÿ•ÿØÿÆÿßŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±</div>
                        <button type="button" class="btn btn-warning" onclick="toggleEvaluationView()" style="padding: 10px 25px;">
                            üîì ÿ•ÿØÿÆÿßŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±
                        </button>
                    </div>
                </div>

                <!-- ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØÿßÿ™ -->
                <div id="employeeDocuments" style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #e9ecef;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="margin: 0; color: #667eea;">ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØÿßÿ™ ÿßŸÑŸÖÿ±ŸÅŸÇÿ©</h4>
                        <button type="button" class="btn btn-primary" onclick="document.getElementById('employeeDocumentInput').click()" style="padding: 8px 20px; font-size: 14px;">
                            üìé ÿ•ÿ±ŸÅÿßŸÇ ŸÖÿ≥ÿ™ŸÜÿØ
                        </button>
                        <input type="file" id="employeeDocumentInput" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" style="display: none;" onchange="handleDocumentUpload(event)">
                    </div>
                    <div id="employeeDocumentsList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
                        <!-- ÿ≥Ÿäÿ™ŸÖ ÿπÿ±ÿ∂ ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØÿßÿ™ ŸáŸÜÿß -->
                    </div>
                </div>

                <div style="margin-top: 30px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn btn-danger" onclick="hideAddEmployeeForm()">ÿ•ŸÑÿ∫ÿßÿ°</button>
                    <button class="btn btn-success" id="employeeSubmitBtn" onclick="addEmployee()">ÿ•ÿ∂ÿßŸÅÿ©</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ŸÜÿßŸÅÿ∞ÿ© ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸàÿ∏ŸÅŸäŸÜ ŸÖÿ™ÿπÿØÿØŸäŸÜ -->
    <div id="bulkAddEmployeesModal" class="modal">
        <div class="modal-content" style="max-width: 1400px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3 id="bulkAddEmployeesFormTitle" data-translate="bulkAddEmployees">ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸàÿ∏ŸÅŸäŸÜ ŸÖÿ™ÿπÿØÿØŸäŸÜ</h3>
                <span class="modal-close" onclick="hideBulkAddEmployeesForm()">&times;</span>
            </div>
            <div class="modal-body">
                <div style="background: #e7f3ff; border-right: 4px solid #667eea; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <p style="margin: 0; color: #0c5460; font-size: 14px;">
                        üí° ŸäŸÖŸÉŸÜŸÉ ÿ•ÿ∂ÿßŸÅÿ© ÿπÿØÿ© ŸÖŸàÿ∏ŸÅŸäŸÜ ÿØŸÅÿπÿ© Ÿàÿßÿ≠ÿØÿ©. ÿ≥Ÿäÿ™ŸÖ ÿ™ŸàŸÑŸäÿØ ÿ£ÿ±ŸÇÿßŸÖ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã. ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑŸÖŸÖŸäÿ≤ÿ© ÿ®ŸÄ <span style="color: red;">*</span> ÿ•ŸÑÿ≤ÿßŸÖŸäÿ©.
                    </p>
                </div>

                <div style="margin-bottom: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn btn-info" onclick="showPasteFromExcelDialog()">üìã ŸÑÿµŸÇ ŸÖŸÜ Excel</button>
                    <button class="btn btn-primary" onclick="addBulkEmployeeRow()">+ ÿ•ÿ∂ÿßŸÅÿ© ÿµŸÅ</button>
                    <button class="btn btn-danger" onclick="clearBulkEmployeesForm()">üóëÔ∏è ŸÖÿ≥ÿ≠ ÿßŸÑŸÉŸÑ</button>
                </div>

                <div style="overflow-x: auto;">
                    <table id="bulkEmployeesTable" style="width: 100%; border-collapse: collapse; background: white;">
                        <thead>
                            <tr style="background: #667eea; color: white; position: sticky; top: 0; z-index: 10;">
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: center; min-width: 50px;">#</th>
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: center; min-width: 120px;">ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ <span style="color: red;">*</span></th>
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: center; min-width: 120px;">ÿßŸÑÿßÿ≥ŸÖ ÿ®ÿßŸÑÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ©</th>
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: center; min-width: 150px;">ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä</th>
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: center; min-width: 120px;">ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ</th>
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: center; min-width: 150px;">ÿßŸÑÿπŸÜŸàÿßŸÜ</th>
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: center; min-width: 120px;">ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿπŸäŸäŸÜ</th>
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: center; min-width: 120px;">ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ•ÿØÿ±ÿßÿ¨</th>
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: center; min-width: 120px;">ÿßŸÑŸÖÿ≥ŸÖŸâ ÿßŸÑŸàÿ∏ŸäŸÅŸä</th>
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: center; min-width: 120px;">ÿßŸÑÿ™ÿ≠ÿµŸäŸÑ ÿßŸÑÿØÿ±ÿßÿ≥Ÿä</th>
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: center; min-width: 120px;">ÿßŸÑÿßÿÆÿ™ÿµÿßÿµ</th>
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: center; min-width: 100px;">ÿßŸÑÿ≠ÿßŸÑÿ©</th>
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: center; min-width: 120px;">ÿ±ŸÖÿ≤ ÿßŸÑÿ±ÿßÿ™ÿ®</th>
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: center; min-width: 150px;">ÿßŸÑŸÇÿ≥ŸÖ</th>
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: center; min-width: 100px;">ÿ•ÿ¨ÿßÿ≤ÿ© ÿ¥Ÿáÿ±Ÿäÿ©</th>
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: center; min-width: 100px;">ÿ•ÿ¨ÿßÿ≤ÿ© ÿ≤ŸÖŸÜŸäÿ©</th>
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: center; min-width: 120px;">ÿßŸÑÿ±ÿµŸäÿØ ÿßŸÑÿßÿ®ÿ™ÿØÿßÿ¶Ÿä</th>
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: center; min-width: 80px;">ÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
                            </tr>
                        </thead>
                        <tbody id="bulkEmployeesTableBody">
                            <!-- ÿ≥Ÿäÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿµŸÅŸàŸÅ ŸáŸÜÿß ÿØŸäŸÜÿßŸÖŸäŸÉŸäÿßŸã -->
                        </tbody>
                    </table>
                </div>

                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>ÿπÿØÿØ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ:</strong> <span id="bulkEmployeesCount">0</span>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-danger" onclick="hideBulkAddEmployeesForm()">ÿ•ŸÑÿ∫ÿßÿ°</button>
                            <button class="btn btn-success" onclick="saveBulkEmployees()">üíæ ÿ≠ŸÅÿ∏ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ŸÜÿßŸÅÿ∞ÿ© ŸÑÿµŸÇ ŸÖŸÜ Excel -->
    <div id="pasteFromExcelModal" class="modal" style="z-index: 10004;">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>ŸÑÿµŸÇ ŸÖŸÜ Excel</h3>
                <span class="modal-close" onclick="hidePasteFromExcelDialog()">&times;</span>
            </div>
            <div class="modal-body">
                <div style="background: #e7f3ff; border-right: 4px solid #667eea; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <p style="margin: 0; color: #0c5460; font-size: 14px;">
                        üìã ÿßŸÑÿµŸÇ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ Excel ŸáŸÜÿß. Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ŸÉŸàŸÜ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä ŸÜŸÅÿ≥ ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑÿ£ÿπŸÖÿØÿ©:<br>
                        <strong>ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ | ÿßŸÑÿßÿ≥ŸÖ ÿ®ÿßŸÑÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ© | ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä | ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ | ÿßŸÑÿπŸÜŸàÿßŸÜ | ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿπŸäŸäŸÜ | ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ•ÿØÿ±ÿßÿ¨ | ÿßŸÑŸÖÿ≥ŸÖŸâ ÿßŸÑŸàÿ∏ŸäŸÅŸä | ÿßŸÑÿ™ÿ≠ÿµŸäŸÑ ÿßŸÑÿØÿ±ÿßÿ≥Ÿä | ÿßŸÑÿßÿÆÿ™ÿµÿßÿµ | ÿßŸÑÿ≠ÿßŸÑÿ© | ÿ±ŸÖÿ≤ ÿßŸÑÿ±ÿßÿ™ÿ® | ÿßŸÑŸÇÿ≥ŸÖ | ÿ•ÿ¨ÿßÿ≤ÿ© ÿ¥Ÿáÿ±Ÿäÿ© | ÿ•ÿ¨ÿßÿ≤ÿ© ÿ≤ŸÖŸÜŸäÿ© | ÿßŸÑÿ±ÿµŸäÿØ ÿßŸÑÿßÿ®ÿ™ÿØÿßÿ¶Ÿä</strong><br>
                        <small>ŸÖŸÑÿßÿ≠ÿ∏ÿ©: ŸäŸÖŸÉŸÜŸÉ ŸÜÿ≥ÿÆ ÿßŸÑÿµŸÅ ÿßŸÑÿ£ŸàŸÑ (ÿßŸÑÿπŸÜÿßŸàŸäŸÜ) ŸÖŸÜ Excelÿå ÿ≥Ÿäÿ™ŸÖ ÿ™ÿÆÿ∑ŸäŸá ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã</small>
                    </p>
                </div>
                <div class="form-group">
                    <label>ÿßŸÑÿµŸÇ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸáŸÜÿß:</label>
                    <textarea id="excelPasteData" rows="10" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px; font-family: monospace;" placeholder="ÿßŸÑÿµŸÇ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ Excel ŸáŸÜÿß..."></textarea>
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn btn-danger" onclick="hidePasteFromExcelDialog()">ÿ•ŸÑÿ∫ÿßÿ°</button>
                    <button class="btn btn-success" onclick="processExcelPaste()">‚úÖ ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ŸÜÿßŸÅÿ∞ÿ© ÿ•ŸÜŸáÿßÿ° ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ -->
    <div id="endProjectModal" class="modal" style="z-index: 10003;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>ÿ•ŸÜŸáÿßÿ° ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ</h3>
                <span class="modal-close" onclick="hideEndProjectModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="endProjectInfo" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <!-- ÿ≥Ÿäÿ™ŸÖ ÿπÿ±ÿ∂ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ŸáŸÜÿß -->
                </div>
                <div class="form-group">
                    <label>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ°: <span style="color: red;">*</span></label>
                    <input type="date" id="endProjectDate" required style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px;">
                    <small style="color: #666; display: block; margin-top: 5px;">ÿ≥Ÿäÿ™ŸÖ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸäŸàŸÖ ÿ•ÿ∞ÿß ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØ ÿ™ÿßÿ±ŸäÿÆ</small>
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn btn-danger" onclick="hideEndProjectModal()">ÿ•ŸÑÿ∫ÿßÿ°</button>
                    <button class="btn btn-success" onclick="confirmEndProject()">ÿ•ŸÜŸáÿßÿ° ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ŸÜÿßŸÅÿ∞ÿ© ÿ•ÿ∂ÿßŸÅÿ©/ÿ™ÿπÿØŸäŸÑ ŸÖÿ≥ÿ™ÿÆÿØŸÖ -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="userFormTitle">ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ¨ÿØŸäÿØ</h3>
                <span class="modal-close" onclick="hideAddUserForm()">&times;</span>
            </div>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                    <div class="form-group">
                        <label>ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ: <span style="color: red;">*</span></label>
                        <input type="text" id="userName" required>
                    </div>
                    <div class="form-group">
                        <label>ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä: <span style="color: red;">*</span></label>
                        <input type="email" id="userEmail" required>
                    </div>
                    <div class="form-group" id="userPasswordGroup">
                        <label>ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±: <span style="color: red;">*</span></label>
                        <input type="password" id="userPassword" minlength="6" placeholder="6 ÿ£ÿ≠ÿ±ŸÅ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ">
                        <p style="color: #666; font-size: 12px; margin-top: 5px;">Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ŸÉŸàŸÜ 6 ÿ£ÿ≠ÿ±ŸÅ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ</p>
                    </div>
                    <div class="form-group" id="userPasswordConfirmGroup">
                        <label>ÿ™ÿ£ŸÉŸäÿØ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±: <span style="color: red;">*</span></label>
                        <input type="password" id="userPasswordConfirm" minlength="6">
                    </div>
                    <div class="form-group">
                        <label>ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ©: <span style="color: red;">*</span></label>
                        <select id="userRole" required>
                            <option value="employee">ŸÖŸàÿ∏ŸÅ</option>
                            <option value="manager">ŸÖÿØŸäÿ±</option>
                            <option value="hr">ŸÖŸàÿßÿ±ÿØ ÿ®ÿ¥ÿ±Ÿäÿ©</option>
                            <option value="admin">ŸÖÿØŸäÿ± ÿßŸÑŸÜÿ∏ÿßŸÖ</option>
                        </select>
                        <p style="color: #666; font-size: 12px; margin-top: 5px;">
                            <strong>ŸÖÿØŸäÿ± ÿßŸÑŸÜÿ∏ÿßŸÖ:</strong> ÿ¨ŸÖŸäÿπ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™<br>
                            <strong>ŸÖŸàÿßÿ±ÿØ ÿ®ÿ¥ÿ±Ÿäÿ©:</strong> ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ ŸàÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™<br>
                            <strong>ŸÖÿØŸäÿ±:</strong> ÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ± ŸàÿßŸÑÿ•ÿ¥ÿ±ÿßŸÅ<br>
                            <strong>ŸÖŸàÿ∏ŸÅ:</strong> ÿπÿ±ÿ∂ ÿ®ŸäÿßŸÜÿßÿ™Ÿá ŸÅŸÇÿ∑
                        </p>
                    </div>
                    <div class="form-group">
                        <label>ÿßŸÑÿ≠ÿßŸÑÿ©: <span style="color: red;">*</span></label>
                        <select id="userStatus" required>
                            <option value="active">ŸÜÿ¥ÿ∑</option>
                            <option value="inactive">ÿ∫Ÿäÿ± ŸÜÿ¥ÿ∑</option>
                        </select>
                    </div>
                </div>

                <div style="margin-top: 30px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn btn-danger" onclick="hideAddUserForm()">ÿ•ŸÑÿ∫ÿßÿ°</button>
                    <button class="btn btn-success" id="userSubmitBtn" onclick="addUser()">ÿ•ÿ∂ÿßŸÅÿ©</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ŸÜÿßŸÅÿ∞ÿ© ÿ•ÿ∂ÿßŸÅÿ©/ÿ™ÿπÿØŸäŸÑ ŸÖÿ¥ÿ±Ÿàÿπ -->
    <div id="projectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="projectFormTitle">ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ¥ÿ±Ÿàÿπ ÿ¨ÿØŸäÿØ</h3>
                <span class="modal-close" onclick="hideAddProjectForm()">&times;</span>
            </div>
            <div class="modal-body">
                <div style="background: #e7f3ff; border-right: 4px solid #667eea; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">ÿ±ŸÖÿ≤ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ:</label>
                    <div style="font-size: 18px; font-weight: bold; color: #667eea;" id="projectCode">PRJ-001</div>
                    <p style="color: #666; font-size: 12px; margin-top: 5px; margin-bottom: 0;">ÿ≥Ÿäÿ™ŸÖ ÿ™ŸàŸÑŸäÿØ ÿ±ŸÖÿ≤ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã</p>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                    <div class="form-group">
                        <label>ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ (ÿπÿ±ÿ®Ÿä): <span style="color: red;">*</span></label>
                        <input type="text" id="projectName" required>
                    </div>
                    <div class="form-group">
                        <label>ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ (ÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿä):</label>
                        <input type="text" id="projectNameEn" placeholder="Project Name (English)">
                    </div>
                    <div class="form-group">
                        <label>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ®ÿØÿ°:</label>
                        <input type="date" id="projectStartDate">
                    </div>
                    <div class="form-group">
                        <label>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ°:</label>
                        <input type="date" id="projectEndDate">
                    </div>
                    <div class="form-group">
                        <label>ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©:</label>
                        <select id="projectRegion">
                            <option value="">-- ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ÿßŸÑÿ≠ÿßŸÑÿ©:</label>
                        <select id="projectStatus">
                            <option value="active">ŸÜÿ¥ÿ∑</option>
                            <option value="completed">ŸÖŸÉÿ™ŸÖŸÑ</option>
                            <option value="on-hold">ŸÖÿ™ŸàŸÇŸÅ</option>
                        </select>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 20px;">
                    <label>ÿßŸÑŸàÿµŸÅ:</label>
                    <textarea id="projectDescription" rows="4" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px; font-family: inherit;"></textarea>
                </div>

                <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-right: 4px solid #ffc107; border-radius: 8px;">
                    <label style="display: flex; align-items: center; cursor: pointer; font-weight: 600;">
                        <input type="checkbox" id="projectIsGeneralManagement" onchange="toggleGeneralManagementFields()" style="margin-left: 10px; width: 20px; height: 20px; cursor: pointer;">
                        <span>Ÿáÿ∞ÿß ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ŸáŸà ÿßŸÑÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿπÿßŸÖÿ©</span>
                    </label>
                    <p style="color: #666; font-size: 12px; margin-top: 8px; margin-bottom: 0;">ÿπŸÜÿØ ÿ™ÿ≠ÿØŸäÿØ Ÿáÿ∞ÿß ÿßŸÑÿÆŸäÿßÿ±ÿå ÿ≥Ÿäÿ™ŸÖ ÿßÿπÿ™ÿ®ÿßÿ± Ÿáÿ∞ÿß ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ŸÉÿ•ÿØÿßÿ±ÿ© ÿπÿßŸÖÿ© ŸÅŸä ÿ™ŸÇÿ±Ÿäÿ± ŸáŸäŸÉŸÑ ÿßŸÑÿ¥ÿ±ŸÉÿ©</p>
                </div>

                <div id="generalManagementFields" style="display: none; margin-top: 20px; padding: 20px; background: #e7f3ff; border-right: 4px solid #667eea; border-radius: 8px;">
                    <h4 style="color: #667eea; margin-bottom: 15px;">ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿπÿßŸÖÿ©</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                        <div class="form-group">
                            <label>ÿßÿ≥ŸÖ ÿßŸÑŸÖÿØŸäÿ± ÿßŸÑÿπÿßŸÖ:</label>
                            <input type="text" id="projectGeneralManager" placeholder="ÿßÿ≥ŸÖ ÿßŸÑŸÖÿØŸäÿ± ÿßŸÑÿπÿßŸÖ">
                        </div>
                        <div class="form-group">
                            <label>ÿßÿ≥ŸÖ ÿßŸÑŸÖÿØŸäÿ± ÿßŸÑÿ™ŸÜŸÅŸäÿ∞Ÿä:</label>
                            <input type="text" id="projectExecutiveManager" placeholder="ÿßÿ≥ŸÖ ÿßŸÑŸÖÿØŸäÿ± ÿßŸÑÿ™ŸÜŸÅŸäÿ∞Ÿä">
                        </div>
                    </div>
                </div>

                <div style="margin-top: 30px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn btn-danger" onclick="hideAddProjectForm()">ÿ•ŸÑÿ∫ÿßÿ°</button>
                    <button class="btn btn-success" id="projectSubmitBtn" onclick="addProject()">ÿ•ÿ∂ÿßŸÅÿ©</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ŸÜÿßŸÅÿ∞ÿ© ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ¥ÿ±Ÿàÿπ ŸÑŸÑÿ≥ÿ¨ŸÑ -->
    <div id="addProjectToHistoryModal" class="modal" style="z-index: 10001;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ¥ÿ±Ÿàÿπ ŸÑŸÑÿ≥ÿ¨ŸÑ</h3>
                <span class="modal-close" onclick="hideAddProjectToHistoryForm()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ: <span style="color: red;">*</span></label>
                    <select id="historyProjectSelect" required style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px;">
                        <option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ®ÿØÿ°: <span style="color: red;">*</span></label>
                    <input type="date" id="historyProjectStartDate" required>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="historyProjectIsCurrent" checked onchange="toggleProjectEndDate()">
                        ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ÿßŸÑÿ≠ÿßŸÑŸä
                    </label>
                </div>
                <div id="historyProjectEndDateGroup" class="form-group" style="display: none;">
                    <label>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ°:</label>
                    <input type="date" id="historyProjectEndDate">
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn btn-danger" onclick="hideAddProjectToHistoryForm()">ÿ•ŸÑÿ∫ÿßÿ°</button>
                    <button class="btn btn-success" onclick="addProjectToHistory()">ÿ•ÿ∂ÿßŸÅÿ©</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ŸÜÿßŸÅÿ∞ÿ© ÿ•ÿ∂ÿßŸÅÿ©/ÿ™ÿπÿØŸäŸÑ ÿ•ÿ¨ÿßÿ≤ÿ© -->
    <div id="leaveModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="leaveFormTitle">ÿ•ÿ∂ÿßŸÅÿ© ÿ•ÿ¨ÿßÿ≤ÿ© ÿ¨ÿØŸäÿØÿ©</h3>
                <span class="modal-close" onclick="hideAddLeaveForm()">&times;</span>
            </div>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                    <div class="form-group">
                        <label>ÿßŸÑŸÖŸàÿ∏ŸÅ: <span style="color: red;">*</span></label>
                        <input type="text" id="leaveEmployeeId" list="leaveEmployeeList" placeholder="ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÖŸàÿ∏ŸÅ ÿ®ÿßŸÑÿßÿ≥ŸÖ ÿ£Ÿà ÿ±ŸÇŸÖ ÿßŸÑŸÖŸàÿ∏ŸÅ..." required autocomplete="off" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px;">
                        <datalist id="leaveEmployeeList"></datalist>
                        <input type="hidden" id="leaveEmployeeIdHidden" value="">
                    </div>
                    <div class="form-group">
                        <label>ŸÜŸàÿπ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ©: <span style="color: red;">*</span></label>
                        <select id="leaveType" required onchange="handleLeaveTypeChange()">
                            <option value="">ÿßÿÆÿ™ÿ± ŸÜŸàÿπ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ©</option>
                            <option value="monthly">ÿ•ÿ¨ÿßÿ≤ÿ© ÿ¥Ÿáÿ±Ÿäÿ©</option>
                            <option value="hourly">ÿ•ÿ¨ÿßÿ≤ÿ© ÿ≤ŸÖŸÜŸäÿ©</option>
                            <option value="unpaid">ÿ•ÿ¨ÿßÿ≤ÿ© ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ®</option>
                            <option value="work-mission">ŸÖŸáŸÖÿ© ÿπŸÖŸÑ</option>
                        </select>
                    </div>
                    <div class="form-group" id="leaveRegionGroup" style="display: none;">
                        <label>ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©: <span style="color: red;">*</span></label>
                        <select id="leaveRegionId">
                            <option value="">-- ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© --</option>
                        </select>
                        <p style="color: #666; font-size: 12px; margin-top: 5px;">ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑÿ™Ÿä ÿ≥ÿ™ÿ™ŸÖ ŸÅŸäŸáÿß ÿßŸÑŸÖŸáŸÖÿ©</p>
                    </div>
                    <div class="form-group" id="leaveMissionTypeGroup" style="display: none;">
                        <label>ŸÜŸàÿπ ÿßŸÑŸÖŸáŸÖÿ©: <span style="color: red;">*</span></label>
                        <select id="leaveMissionType" onchange="handleMissionTypeChange()">
                            <option value="">-- ÿßÿÆÿ™ÿ± ŸÜŸàÿπ ÿßŸÑŸÖŸáŸÖÿ© --</option>
                            <option value="full-day">ŸäŸàŸÖ ŸÉÿßŸÖŸÑ</option>
                            <option value="hourly">ÿ≤ŸÖŸÜŸäÿ© (ÿ≥ÿßÿπÿßÿ™)</option>
                        </select>
                        <p style="color: #666; font-size: 12px; margin-top: 5px;">ÿßÿÆÿ™ÿ± ŸÖÿß ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿßŸÑŸÖŸáŸÖÿ© ŸÑŸäŸàŸÖ ŸÉÿßŸÖŸÑ ÿ£Ÿà ÿ¨ÿ≤ÿ° ŸÖŸÜ ÿßŸÑŸäŸàŸÖ</p>
                    </div>
                    <div class="form-group" id="leaveMissionHoursGroup" style="display: none;">
                        <label>ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿ•ÿØÿÆÿßŸÑ:</label>
                        <select id="leaveMissionHoursInputMethod" onchange="handleMissionHoursMethodChange()" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px; margin-bottom: 10px;">
                            <option value="manual">ÿ•ÿØÿÆÿßŸÑ ŸäÿØŸàŸä (ÿπÿØÿØ ÿßŸÑÿ≥ÿßÿπÿßÿ™)</option>
                            <option value="time-range">ŸÖŸÜ ÿ≥ÿßÿπÿ© ÿ•ŸÑŸâ ÿ≥ÿßÿπÿ©</option>
                        </select>
                        <div id="leaveMissionHoursManualGroup">
                            <label>ÿπÿØÿØ ÿßŸÑÿ≥ÿßÿπÿßÿ™:</label>
                            <input type="number" id="leaveMissionHours" min="0.5" step="0.5" placeholder="ŸÖÿ´ÿßŸÑ: 4">
                            <p style="color: #666; font-size: 12px; margin-top: 5px;">ÿπÿØÿØ ÿ≥ÿßÿπÿßÿ™ ÿßŸÑŸÖŸáŸÖÿ©</p>
                        </div>
                        <div id="leaveMissionHoursTimeRangeGroup" style="display: none;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                <div>
                                    <label>ŸÖŸÜ:</label>
                                    <input type="time" id="leaveMissionStartTime" onchange="calculateMissionHoursFromTime()" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px;">
                                </div>
                                <div>
                                    <label>ÿ•ŸÑŸâ:</label>
                                    <input type="time" id="leaveMissionEndTime" onchange="calculateMissionHoursFromTime()" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px;">
                                </div>
                            </div>
                            <div style="background: #e7f3ff; padding: 10px; border-radius: 8px; margin-top: 10px;">
                                <strong>ÿπÿØÿØ ÿßŸÑÿ≥ÿßÿπÿßÿ™ ÿßŸÑŸÖÿ≠ÿ≥Ÿàÿ®ÿ©:</strong> <span id="leaveMissionCalculatedHours" style="color: #667eea; font-weight: bold;">0</span> ÿ≥ÿßÿπÿ©
                            </div>
                        </div>
                    </div>
                    <!-- ÿπÿ±ÿ∂ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ© -->
                    <div id="leaveBalanceInfo" style="display: none; grid-column: 1 / -1; background: #e7f3ff; border-right: 4px solid #667eea; padding: 15px; border-radius: 8px; margin-top: 10px;">
                        <h4 style="margin: 0 0 10px 0; color: #667eea;">ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ©:</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div>
                                <strong>ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑÿ¥Ÿáÿ±Ÿäÿ©:</strong>
                                <span id="monthlyLeaveBalance" style="color: #28a745; font-weight: bold; font-size: 18px;">-</span> ŸäŸàŸÖ
                            </div>
                            <div>
                                <strong>ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ©:</strong>
                                <span id="hourlyLeaveBalance" style="color: #28a745; font-weight: bold; font-size: 18px;">-</span> ÿ≥ÿßÿπÿ©
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ®ÿØÿ°: <span style="color: red;">*</span></label>
                        <input type="date" id="leaveStartDate" required>
                    </div>
                    <div class="form-group">
                        <label>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ°:</label>
                        <input type="date" id="leaveEndDate">
                    </div>
                    <div class="form-group" id="leaveHoursGroup" style="display: none;">
                        <label>ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿ•ÿØÿÆÿßŸÑ:</label>
                        <select id="leaveHoursInputMethod" onchange="handleLeaveHoursMethodChange()" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px; margin-bottom: 10px;">
                            <option value="manual">ÿ•ÿØÿÆÿßŸÑ ŸäÿØŸàŸä (ÿπÿØÿØ ÿßŸÑÿ≥ÿßÿπÿßÿ™)</option>
                            <option value="time-range">ŸÖŸÜ ÿ≥ÿßÿπÿ© ÿ•ŸÑŸâ ÿ≥ÿßÿπÿ©</option>
                            <option value="multiple-periods">ŸÅÿ™ÿ±ÿßÿ™ ŸÖÿ™ÿπÿØÿØÿ© ŸÅŸä ŸäŸàŸÖ Ÿàÿßÿ≠ÿØ</option>
                        </select>
                        <div id="leaveHoursManualGroup">
                            <label>ÿπÿØÿØ ÿßŸÑÿ≥ÿßÿπÿßÿ™:</label>
                            <input type="number" id="leaveHours" min="0.5" step="0.5" placeholder="ŸÖÿ´ÿßŸÑ: 4">
                        </div>
                        <div id="leaveHoursTimeRangeGroup" style="display: none;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                <div>
                                    <label>ŸÖŸÜ:</label>
                                    <input type="time" id="leaveStartTime" onchange="calculateLeaveHoursFromTime()" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px;">
                                </div>
                                <div>
                                    <label>ÿ•ŸÑŸâ:</label>
                                    <input type="time" id="leaveEndTime" onchange="calculateLeaveHoursFromTime()" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px;">
                                </div>
                            </div>
                            <div style="background: #e7f3ff; padding: 10px; border-radius: 8px; margin-top: 10px;">
                                <strong>ÿπÿØÿØ ÿßŸÑÿ≥ÿßÿπÿßÿ™ ÿßŸÑŸÖÿ≠ÿ≥Ÿàÿ®ÿ©:</strong> <span id="leaveCalculatedHours" style="color: #667eea; font-weight: bold;">0</span> ÿ≥ÿßÿπÿ©
                            </div>
                        </div>
                        <div id="leaveHoursMultiplePeriodsGroup" style="display: none;">
                            <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                                <p style="margin: 0; color: #856404; font-size: 14px;">
                                    üí° ŸäŸÖŸÉŸÜŸÉ ÿ•ÿ∂ÿßŸÅÿ© ÿπÿØÿ© ŸÅÿ™ÿ±ÿßÿ™ ÿ≤ŸÖŸÜŸäÿ© ŸÅŸä ŸÜŸÅÿ≥ ÿßŸÑŸäŸàŸÖ. ŸÖÿ´ÿßŸÑ: ŸÖŸÜ 09:00 ÿ•ŸÑŸâ 12:00 ŸàŸÖŸÜ 14:00 ÿ•ŸÑŸâ 17:00
                                </p>
                            </div>
                            <div id="leaveTimePeriodsContainer">
                                <!-- ÿßŸÑŸÅÿ™ÿ±ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ© ÿ≥ÿ™Ÿèÿ∂ÿßŸÅ ŸáŸÜÿß ÿØŸäŸÜÿßŸÖŸäŸÉŸäÿßŸã -->
                            </div>
                            <button type="button" class="btn btn-primary" onclick="addLeaveTimePeriod()" style="margin-top: 10px; padding: 8px 15px; font-size: 14px;">+ ÿ•ÿ∂ÿßŸÅÿ© ŸÅÿ™ÿ±ÿ© ÿ≤ŸÖŸÜŸäÿ©</button>
                            <div style="background: #e7f3ff; padding: 10px; border-radius: 8px; margin-top: 15px;">
                                <strong>ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ≥ÿßÿπÿßÿ™ ÿßŸÑŸÖÿ≠ÿ≥Ÿàÿ®ÿ©:</strong> <span id="leaveTotalCalculatedHours" style="color: #667eea; font-weight: bold;">0</span> ÿ≥ÿßÿπÿ©
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>ÿßŸÑÿ≠ÿßŸÑÿ©:</label>
                        <select id="leaveStatus">
                            <option value="pending">ŸÇŸäÿØ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±</option>
                            <option value="approved">ŸÖŸàÿßŸÅŸÇ ÿπŸÑŸäŸáÿß</option>
                            <option value="rejected">ŸÖÿ±ŸÅŸàÿ∂ÿ©</option>
                            <option value="cancelled">ŸÖŸÑÿ∫ÿßÿ©</option>
                        </select>
                    </div>
                    <div class="form-group" id="leaveDeductionGroup" style="display: none; grid-column: 1 / -1; background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="leaveCalculateDeduction" checked style="width: 20px; height: 20px; cursor: pointer;">
                            <span style="font-weight: bold; color: #856404;">ÿßÿ≠ÿ™ÿ≥ÿßÿ® ÿÆÿµŸÖ ŸÖÿßŸÑŸä ŸÑŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ®</span>
                        </label>
                        <p style="color: #856404; font-size: 13px; margin-top: 8px; margin-right: 30px;">
                            ÿπŸÜÿØ ÿ™ŸÅÿπŸäŸÑ Ÿáÿ∞ÿß ÿßŸÑÿÆŸäÿßÿ±ÿå ÿ≥Ÿäÿ™ŸÖ ÿßÿ≠ÿ™ÿ≥ÿßÿ® ÿÆÿµŸÖ ŸÖÿßŸÑŸä ŸÖŸÜ ÿ±ÿßÿ™ÿ® ÿßŸÑŸÖŸàÿ∏ŸÅ ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ŸÖÿØÿ© ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ŸàÿßŸÑÿ±ÿßÿ™ÿ® ÿßŸÑÿ≠ÿßŸÑŸä.
                        </p>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™:</label>
                        <textarea id="leaveNotes" rows="3" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px;"></textarea>
                    </div>
                </div>

                <div style="margin-top: 30px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn btn-danger" onclick="hideAddLeaveForm()">ÿ•ŸÑÿ∫ÿßÿ°</button>
                    <button class="btn btn-success" id="leaveSubmitBtn" onclick="addLeave()">ÿ•ÿ∂ÿßŸÅÿ©</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ŸÜÿßŸÅÿ∞ÿ© ÿ•ÿ∂ÿßŸÅÿ© ÿπŸÇŸàÿ®ÿ© -->
    <div id="addPenaltyModal" class="modal" style="z-index: 10002;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>ÿ•ÿ∂ÿßŸÅÿ© ÿπŸÇŸàÿ®ÿ©</h3>
                <span class="modal-close" onclick="hideAddPenaltyForm()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>ŸÜŸàÿπ ÿßŸÑÿπŸÇŸàÿ®ÿ©: <span style="color: red;">*</span></label>
                    <select id="penaltyType" required style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px;">
                        <option value="">ÿßÿÆÿ™ÿ± ŸÜŸàÿπ ÿßŸÑÿπŸÇŸàÿ®ÿ©</option>
                        <option value="warning">ÿ•ŸÜÿ∞ÿßÿ±</option>
                        <option value="reprimand">ÿ™Ÿàÿ®ŸäÿÆ</option>
                        <option value="deduction">ÿÆÿµŸÖ ŸÖÿßŸÑŸä</option>
                        <option value="suspension">ÿ™ÿπŸÑŸäŸÇ</option>
                        <option value="termination">ÿ•ŸÜŸáÿßÿ° ÿÆÿØŸÖÿ©</option>
                        <option value="other">ÿ£ÿÆÿ±Ÿâ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ÿßŸÑÿ™ÿßÿ±ŸäÿÆ: <span style="color: red;">*</span></label>
                    <input type="date" id="penaltyDate" required>
                </div>
                <div class="form-group">
                    <label>ÿßŸÑÿ≥ÿ®ÿ®/ÿßŸÑŸàÿµŸÅ: <span style="color: red;">*</span></label>
                    <textarea id="penaltyReason" rows="3" required style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px;"></textarea>
                </div>
                <div class="form-group">
                    <label>ÿßŸÑŸÖÿ®ŸÑÿ∫ (ŸÅŸä ÿ≠ÿßŸÑÿ© ÿßŸÑÿÆÿµŸÖ ÿßŸÑŸÖÿßŸÑŸä):</label>
                    <input type="number" id="penaltyAmount" min="0" step="0.01" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label>ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ©:</label>
                    <textarea id="penaltyNotes" rows="2" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px;"></textarea>
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn btn-danger" onclick="hideAddPenaltyForm()">ÿ•ŸÑÿ∫ÿßÿ°</button>
                    <button class="btn btn-success" onclick="addPenalty()">ÿ•ÿ∂ÿßŸÅÿ©</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ŸÜÿßŸÅÿ∞ÿ© ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÉÿßŸÅÿ£ÿ© -->
    <!-- ŸÜÿßŸÅÿ∞ÿ© ÿ•ÿ∂ÿßŸÅÿ©/ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ™ŸÇŸäŸäŸÖ ÿßŸÑÿ≥ŸÜŸàŸä -->
    <div id="addEvaluationModal" class="modal" style="z-index: 10002;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="evaluationFormTitle">ÿ•ÿ∂ÿßŸÅÿ© ÿ™ŸÇŸäŸäŸÖ ÿ≥ŸÜŸàŸä</h3>
                <span class="modal-close" onclick="hideAddEvaluationForm()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>ÿßŸÑÿ≥ŸÜÿ©: <span style="color: red;">*</span></label>
                    <input type="number" id="evaluationYear" min="2000" max="2100" required placeholder="ŸÖÿ´ÿßŸÑ: 2024">
                </div>
                <div class="form-group">
                    <label>ÿßŸÑÿ™ŸÇŸäŸäŸÖ (ŸÖŸÜ 5): <span style="color: red;">*</span></label>
                    <select id="evaluationRating" required>
                        <option value="">-- ÿßÿÆÿ™ÿ± ÿßŸÑÿ™ŸÇŸäŸäŸÖ --</option>
                        <option value="1">1 - ÿ∂ÿπŸäŸÅ ÿ¨ÿØÿßŸã</option>
                        <option value="2">2 - ÿ∂ÿπŸäŸÅ</option>
                        <option value="3">3 - ŸÖŸÇÿ®ŸàŸÑ</option>
                        <option value="4">4 - ÿ¨ŸäÿØ</option>
                        <option value="5">5 - ŸÖŸÖÿ™ÿßÿ≤</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ŸàÿµŸÅ ÿßŸÑÿ™ŸÇŸäŸäŸÖ: <span style="color: red;">*</span></label>
                    <textarea id="evaluationDescription" rows="5" required placeholder="ŸàÿµŸÅ ŸÖŸÅÿµŸÑ ŸÑŸÑÿ™ŸÇŸäŸäŸÖ..."></textarea>
                </div>
                <div class="form-group">
                    <label>ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ©:</label>
                    <textarea id="evaluationNotes" rows="3" placeholder="ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ© (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)..."></textarea>
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn btn-danger" onclick="hideAddEvaluationForm()">ÿ•ŸÑÿ∫ÿßÿ°</button>
                    <button class="btn btn-success" id="evaluationSubmitBtn" onclick="addEvaluation()">ÿ•ÿ∂ÿßŸÅÿ©</button>
                </div>
            </div>
        </div>
    </div>

    <div id="addRewardModal" class="modal" style="z-index: 10002;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÉÿßŸÅÿ£ÿ©</h3>
                <span class="modal-close" onclick="hideAddRewardForm()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>ŸÜŸàÿπ ÿßŸÑŸÖŸÉÿßŸÅÿ£ÿ©: <span style="color: red;">*</span></label>
                    <select id="rewardType" required style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px;">
                        <option value="">ÿßÿÆÿ™ÿ± ŸÜŸàÿπ ÿßŸÑŸÖŸÉÿßŸÅÿ£ÿ©</option>
                        <option value="bonus">ŸÖŸÉÿßŸÅÿ£ÿ© ŸÖÿßŸÑŸäÿ©</option>
                        <option value="recognition">ÿ¥ŸÉÿ± Ÿàÿ™ŸÇÿØŸäÿ±</option>
                        <option value="promotion">ÿ™ÿ±ŸÇŸäÿ©</option>
                        <option value="gift">ŸáÿØŸäÿ©</option>
                        <option value="certificate">ÿ¥ŸáÿßÿØÿ© ÿ™ŸÇÿØŸäÿ±</option>
                        <option value="other">ÿ£ÿÆÿ±Ÿâ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ÿßŸÑÿ™ÿßÿ±ŸäÿÆ: <span style="color: red;">*</span></label>
                    <input type="date" id="rewardDate" required>
                </div>
                <div class="form-group">
                    <label>ÿßŸÑÿ≥ÿ®ÿ®/ÿßŸÑŸàÿµŸÅ: <span style="color: red;">*</span></label>
                    <textarea id="rewardReason" rows="3" required style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px;"></textarea>
                </div>
                <div class="form-group">
                    <label>ÿßŸÑŸÖÿ®ŸÑÿ∫ (ŸÅŸä ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖŸÉÿßŸÅÿ£ÿ© ÿßŸÑŸÖÿßŸÑŸäÿ©):</label>
                    <input type="number" id="rewardAmount" min="0" step="0.01" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label>ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ©:</label>
                    <textarea id="rewardNotes" rows="2" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px;"></textarea>
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn btn-danger" onclick="hideAddRewardForm()">ÿ•ŸÑÿ∫ÿßÿ°</button>
                    <button class="btn btn-success" onclick="addReward()">ÿ•ÿ∂ÿßŸÅÿ©</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ŸÜÿßŸÅÿ∞ÿ© ÿ•ÿ∂ÿßŸÅÿ©/ÿ™ÿπÿØŸäŸÑ ŸÖŸÜÿ∑ŸÇÿ© -->
    <div id="regionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="regionFormTitle">ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ∑ŸÇÿ© ÿ¨ÿØŸäÿØÿ©</h3>
                <span class="modal-close" onclick="hideAddRegionForm()">&times;</span>
            </div>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                    <div class="form-group">
                        <label>ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© (ÿπÿ±ÿ®Ÿä): <span style="color: red;">*</span></label>
                        <input type="text" id="regionName" required>
                    </div>
                    <div class="form-group">
                        <label>ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© (ÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿä):</label>
                        <input type="text" id="regionNameEn" placeholder="Region Name (English)">
                    </div>
                </div>
                <div class="form-group" style="margin-top: 15px;">
                    <label>ÿßŸÑŸàÿµŸÅ:</label>
                    <textarea id="regionDescription" rows="4" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px; font-family: inherit;"></textarea>
                </div>
                <div style="margin-top: 30px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn btn-danger" onclick="hideAddRegionForm()">ÿ•ŸÑÿ∫ÿßÿ°</button>
                    <button class="btn btn-success" id="regionSubmitBtn" onclick="addRegion()">ÿ•ÿ∂ÿßŸÅÿ©</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ŸÜÿßŸÅÿ∞ÿ© ÿ•ÿ∂ÿßŸÅÿ©/ÿ™ÿπÿØŸäŸÑ ŸÇÿ≥ŸÖ -->
    <div id="departmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="departmentFormTitle">ÿ•ÿ∂ÿßŸÅÿ© ŸÇÿ≥ŸÖ ÿ¨ÿØŸäÿØ</h3>
                <span class="modal-close" onclick="hideAddDepartmentForm()">&times;</span>
            </div>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                    <div class="form-group">
                        <label>ÿßÿ≥ŸÖ ÿßŸÑŸÇÿ≥ŸÖ (ÿπÿ±ÿ®Ÿä): <span style="color: red;">*</span></label>
                        <input type="text" id="departmentName" required>
                    </div>
                    <div class="form-group">
                        <label>ÿßÿ≥ŸÖ ÿßŸÑŸÇÿ≥ŸÖ (ÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿä):</label>
                        <input type="text" id="departmentNameEn" placeholder="Department Name (English)">
                    </div>
                </div>
                <div class="form-group">
                    <label>ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ/ÿßŸÑÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿπÿßŸÖÿ©: <span style="color: red;">*</span></label>
                    <select id="departmentProjectId" required>
                        <option value="">-- ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ --</option>
                        <option value="general_management">ÿßŸÑÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿπÿßŸÖÿ©</option>
                    </select>
                    <p style="color: #666; font-size: 12px; margin-top: 5px;">ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ÿßŸÑÿ∞Ÿä ŸäŸÜÿ™ŸÖŸä ÿ•ŸÑŸäŸá ÿßŸÑŸÇÿ≥ŸÖ ÿ£Ÿà ÿßÿÆÿ™ÿ± "ÿßŸÑÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿπÿßŸÖÿ©"</p>
                </div>
                <div class="form-group">
                    <label>ÿßŸÑŸàÿµŸÅ:</label>
                    <textarea id="departmentDescription" rows="4" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px; font-family: inherit;"></textarea>
                </div>
                <div style="margin-top: 30px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn btn-danger" onclick="hideAddDepartmentForm()">ÿ•ŸÑÿ∫ÿßÿ°</button>
                    <button class="btn btn-success" id="departmentSubmitBtn" onclick="addDepartment()">ÿ•ÿ∂ÿßŸÅÿ©</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer - ÿ≠ŸÇŸàŸÇ ÿßŸÑŸÜÿ¥ÿ± -->
    <footer id="appFooter" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px 20px; text-align: center; margin-top: 50px; border-top: 3px solid rgba(255,255,255,0.2);">
        <div style="max-width: 1200px; margin: 0 auto;">
            <div style="font-size: 1.2em; font-weight: bold; margin-bottom: 10px;" data-translate="copyright">
                Ÿáÿ∞ÿß ÿßŸÑÿ®ÿ±ŸÜÿßŸÖÿ¨ ŸÖŸÜ ÿ™ÿµŸÖŸäŸÖ Ÿà ÿ•ŸÜÿ¥ÿßÿ° Rosemary ŸÑŸÑÿ≠ŸÑŸàŸÑ ÿßŸÑÿ®ÿ±ŸÖÿ¨Ÿä
            </div>
            <div style="font-size: 0.9em; opacity: 0.9;" data-translate="copyrightEn">
                This software is designed and developed by Rosemary for software solutions
            </div>
            <div style="margin-top: 15px; font-size: 0.85em; opacity: 0.8;">
                ¬© 2024 Rosemary - ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÇ ŸÖÿ≠ŸÅŸàÿ∏ÿ© | All Rights Reserved
            </div>
        </div>
    </footer>

    <script>
        // ============================================
        // ÿßŸÑŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿßŸÑÿπÿßŸÖÿ©
        // ============================================
        const SALARY_PASSWORD = '1475963';
        const LEAVE_EDIT_PASSWORD = '1475963'; // ŸÉŸÑŸÖÿ© ŸÖÿ±Ÿàÿ± ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑŸÖŸàÿßŸÅŸÇ ÿπŸÑŸäŸáÿß
        const DEDUCTION_VIEW_PASSWORD = '1475963'; // ŸÉŸÑŸÖÿ© ŸÖÿ±Ÿàÿ± ÿπÿ±ÿ∂ ÿßŸÑÿÆÿµŸàŸÖÿßÿ™
        const EVALUATION_PASSWORD = '1475963'; // ŸÉŸÑŸÖÿ© ŸÖÿ±Ÿàÿ± ÿßŸÑÿ™ŸÇŸäŸäŸÖÿßÿ™ ÿßŸÑÿ≥ŸÜŸàŸäÿ©
        const USERS_SECTION_PASSWORD = '1475963'; // ŸÉŸÑŸÖÿ© ŸÖÿ±Ÿàÿ± ŸÇÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ
        window.deductionViewUnlocked = false; // ÿ≠ÿßŸÑÿ© ŸÅÿ™ÿ≠ ÿπÿ±ÿ∂ ÿßŸÑÿÆÿµŸàŸÖÿßÿ™
        window.evaluationViewUnlocked = false; // ÿ≠ÿßŸÑÿ© ŸÅÿ™ÿ≠ ÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÇŸäŸäŸÖÿßÿ™
        window.usersSectionUnlocked = false; // ÿ≠ÿßŸÑÿ© ŸÅÿ™ÿ≠ ŸÇÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ
        let currentUser = null;
        // ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ£ŸàŸÑ (ŸÑÿß ÿ™Ÿèÿ≠ŸÅÿ∏ ŸÅŸä "ÿ™ÿ∞ŸÉÿ±ŸÜŸä" ŸÑÿ∂ŸÖÿßŸÜ ÿ£ŸÜ ŸÉŸÑ ÿ≤ÿßÿ¶ÿ± Ÿäÿ≥ÿ¨ŸëŸÑ ÿØÿÆŸàŸÑŸá ÿ®ŸÜŸÅÿ≥Ÿá)
        const FIRST_USER_EMAIL = 'ali.alqadre93@gmail.com';
        const FIRST_USER_PASSWORD = '9875321';
        // #region agent log
        let isManualLogout = false; // ÿπŸÑÿßŸÖÿ© ŸÑÿ™ÿ™ÿ®ÿπ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ ÿßŸÑŸäÿØŸàŸä
        // ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿ≠ÿßŸÑÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ ŸÖŸÜ sessionStorage
        try {
            const savedLogoutState = sessionStorage.getItem('hrm_manual_logout');
            if (savedLogoutState === 'true') {
                isManualLogout = true;
                console.log('üîç [DEBUG-E] ÿßÿ≥ÿ™ÿπÿßÿØÿ© isManualLogout ŸÖŸÜ sessionStorage:', isManualLogout);
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßÿ≥ÿ™ÿØÿπÿßÿ° logging ÿßŸÑÿÆÿßÿ±ÿ¨Ÿä
            } else {
                console.log('üîç [DEBUG-E] ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ≠ÿßŸÑÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿÆÿ±Ÿàÿ¨ ŸÖÿ≠ŸÅŸàÿ∏ÿ© ŸÅŸä sessionStorage');
            }
        } catch (e) {
            console.log('üîç [DEBUG-E] ÿÆÿ∑ÿ£ ŸÅŸä ŸÇÿ±ÿßÿ°ÿ© sessionStorage:', e);
        }
        // #endregion
        let employeesData = [];
        let leavesData = [];
        let leavesViewYear = new Date().getFullYear();
        let leavesViewMonth = new Date().getMonth(); // 0-11
        let leavesViewAllMonths = false; // true = ÿπÿ±ÿ∂ ŸÉŸÑ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ÿå false = ÿπÿ±ÿ∂ ÿ¥Ÿáÿ± ŸÖÿ≠ÿØÿØ
        let auditLogs = []; // ÿ≥ÿ¨ŸÑ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™
        
        // ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ™ÿ±ÿ¨ŸÖÿ©
        let currentLanguage = localStorage.getItem('hrm_language') || 'ar';
        
        const translations = {
            ar: {
                // Header
                systemTitle: 'ŸÜÿ∏ÿßŸÖ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸàÿßÿ±ÿØ ÿßŸÑÿ®ÿ¥ÿ±Ÿäÿ©',
                logout: 'ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨',
                loading: 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...',
                
                // Navigation
                dashboard: 'ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ',
                employees: 'ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ',
                projects: 'ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ',
                regions: 'ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ',
                departments: 'ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ',
                leaves: 'ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™',
                reports: 'ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ±',
                users: 'ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ',
                settings: 'ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™',
                
                // Dashboard
                totalEmployees: 'ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ',
                activeEmployees: 'ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ ÿßŸÑŸÜÿ¥ÿ∑ŸäŸÜ',
                totalProjects: 'ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ',
                activeProjects: 'ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ ÿßŸÑŸÜÿ¥ÿ∑ÿ©',
                pendingLeaves: 'ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑŸÖÿπŸÑŸÇÿ©',
                
                // Common
                add: 'ÿ•ÿ∂ÿßŸÅÿ©',
                edit: 'ÿ™ÿπÿØŸäŸÑ',
                delete: 'ÿ≠ÿ∞ŸÅ',
                save: 'ÿ≠ŸÅÿ∏',
                cancel: 'ÿ•ŸÑÿ∫ÿßÿ°',
                search: 'ÿßŸÑÿ®ÿ≠ÿ´',
                filter: 'ŸÅŸÑÿ™ÿ±ÿ©',
                clearFilters: 'ŸÖÿ≥ÿ≠ ÿßŸÑŸÅŸÑÿßÿ™ÿ±',
                actions: 'ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™',
                status: 'ÿßŸÑÿ≠ÿßŸÑÿ©',
                name: 'ÿßŸÑÿßÿ≥ŸÖ',
                date: 'ÿßŸÑÿ™ÿßÿ±ŸäÿÆ',
                description: 'ÿßŸÑŸàÿµŸÅ',
                notes: 'ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™',
                
                // Roles
                admin: 'ŸÖÿØŸäÿ± ÿßŸÑŸÜÿ∏ÿßŸÖ',
                hr: 'ŸÖŸàÿßÿ±ÿØ ÿ®ÿ¥ÿ±Ÿäÿ©',
                manager: 'ŸÖÿØŸäÿ±',
                employee: 'ŸÖŸàÿ∏ŸÅ',
                
                // Modals
                addEmployee: 'ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸàÿ∏ŸÅ ÿ¨ÿØŸäÿØ',
                editEmployee: 'ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖŸàÿ∏ŸÅ',
                bulkAddEmployees: 'ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸàÿ∏ŸÅŸäŸÜ ŸÖÿ™ÿπÿØÿØŸäŸÜ',
                addProject: 'ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ¥ÿ±Ÿàÿπ ÿ¨ÿØŸäÿØ',
                editProject: 'ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ',
                addRegion: 'ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ∑ŸÇÿ© ÿ¨ÿØŸäÿØÿ©',
                editRegion: 'ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©',
                addDepartment: 'ÿ•ÿ∂ÿßŸÅÿ© ŸÇÿ≥ŸÖ ÿ¨ÿØŸäÿØ',
                editDepartment: 'ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÇÿ≥ŸÖ',
                addLeave: 'ÿ•ÿ∂ÿßŸÅÿ© ÿ•ÿ¨ÿßÿ≤ÿ© ÿ¨ÿØŸäÿØÿ©',
                editLeave: 'ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ©',
                addUser: 'ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ¨ÿØŸäÿØ',
                editUser: 'ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ',
                addEvaluation: 'ÿ•ÿ∂ÿßŸÅÿ© ÿ™ŸÇŸäŸäŸÖ ÿ≥ŸÜŸàŸä',
                editEvaluation: 'ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ™ŸÇŸäŸäŸÖ',
                
                // Buttons
                addBtn: 'ÿ•ÿ∂ÿßŸÅÿ©',
                editBtn: 'ÿ™ÿπÿØŸäŸÑ',
                deleteBtn: 'ÿ≠ÿ∞ŸÅ',
                saveBtn: 'ÿ≠ŸÅÿ∏',
                saveChanges: 'ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™',
                cancelBtn: 'ÿ•ŸÑÿ∫ÿßÿ°',
                closeBtn: 'ÿ•ÿ∫ŸÑÿßŸÇ',
                viewBtn: 'ÿπÿ±ÿ∂',
                lockSection: 'ŸÇŸÅŸÑ ÿßŸÑŸÇÿ≥ŸÖ',
                unlockSection: 'ÿ•ÿØÿÆÿßŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±',
                
                // Sections
                usersSectionLocked: 'Ÿáÿ∞ÿß ÿßŸÑŸÇÿ≥ŸÖ ŸÖÿ≠ŸÖŸä ÿ®ŸÉŸÑŸÖÿ© ŸÖÿ±Ÿàÿ±',
                usersSectionLockedDesc: 'Ÿäÿ¨ÿ® ÿ•ÿØÿÆÿßŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ŸÑŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸâ ŸÇÿ≥ŸÖ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ',
                copyright: 'Ÿáÿ∞ÿß ÿßŸÑÿ®ÿ±ŸÜÿßŸÖÿ¨ ŸÖŸÜ ÿ™ÿµŸÖŸäŸÖ Ÿà ÿ•ŸÜÿ¥ÿßÿ° Rosemary ŸÑŸÑÿ≠ŸÑŸàŸÑ ÿßŸÑÿ®ÿ±ŸÖÿ¨Ÿä',
                copyrightEn: 'This software is designed and developed by Rosemary for software solutions'
            },
            en: {
                // Header
                systemTitle: 'Human Resources Management System',
                logout: 'Logout',
                loading: 'Loading...',
                
                // Navigation
                dashboard: 'Dashboard',
                employees: 'Employees',
                projects: 'Projects',
                regions: 'Regions',
                departments: 'Departments',
                leaves: 'Leaves',
                reports: 'Reports',
                users: 'Users',
                settings: 'Settings',
                
                // Dashboard
                totalEmployees: 'Total Employees',
                activeEmployees: 'Active Employees',
                totalProjects: 'Total Projects',
                activeProjects: 'Active Projects',
                pendingLeaves: 'Pending Leaves',
                
                // Common
                add: 'Add',
                edit: 'Edit',
                delete: 'Delete',
                save: 'Save',
                cancel: 'Cancel',
                search: 'Search',
                filter: 'Filter',
                clearFilters: 'Clear Filters',
                actions: 'Actions',
                status: 'Status',
                name: 'Name',
                date: 'Date',
                description: 'Description',
                notes: 'Notes',
                
                // Roles
                admin: 'System Administrator',
                hr: 'Human Resources',
                manager: 'Manager',
                employee: 'Employee',
                
                // Modals
                addEmployee: 'Add New Employee',
                editEmployee: 'Edit Employee',
                bulkAddEmployees: 'Bulk Add Employees',
                addProject: 'Add New Project',
                editProject: 'Edit Project',
                addRegion: 'Add New Region',
                editRegion: 'Edit Region',
                addDepartment: 'Add New Department',
                editDepartment: 'Edit Department',
                addLeave: 'Add New Leave',
                editLeave: 'Edit Leave',
                addUser: 'Add New User',
                editUser: 'Edit User',
                addEvaluation: 'Add Annual Evaluation',
                editEvaluation: 'Edit Evaluation',
                
                // Buttons
                addBtn: 'Add',
                editBtn: 'Edit',
                deleteBtn: 'Delete',
                saveBtn: 'Save',
                saveChanges: 'Save Changes',
                cancelBtn: 'Cancel',
                closeBtn: 'Close',
                viewBtn: 'View',
                lockSection: 'Lock Section',
                unlockSection: 'Enter Password',
                
                // Sections
                usersSectionLocked: 'This section is password protected',
                usersSectionLockedDesc: 'Password required to access user management section',
                copyright: 'This software is designed and developed by Rosemary for software solutions',
                copyrightEn: 'This software is designed and developed by Rosemary for software solutions'
            }
        };
        
        // ÿØÿßŸÑÿ© ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑÿ™ÿ±ÿ¨ŸÖÿ©
        function t(key) {
            return translations[currentLanguage][key] || key;
        }
        
        // ÿØÿßŸÑÿ© ÿ™ÿ®ÿØŸäŸÑ ÿßŸÑŸÑÿ∫ÿ©
        function switchLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('hrm_language', lang);
            document.documentElement.lang = lang;
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
            applyTranslations();
        }
        
        // ÿØÿßŸÑÿ© ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ™ÿ±ÿ¨ŸÖÿ©
        function applyTranslations() {
            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿπŸÜŸàÿßŸÜ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä
            const headerTitle = document.getElementById('headerSystemTitle');
            if (headerTitle) {
                headerTitle.textContent = t('systemTitle');
            }
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿ≤ÿ± ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨
            const logoutBtn = document.querySelector('.header-logout-btn span:last-child');
            if (logoutBtn) {
                logoutBtn.textContent = t('logout');
            }
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ™ŸÜŸÇŸÑ
            const navButtons = document.querySelectorAll('.nav-btn');
            navButtons.forEach(btn => {
                const text = btn.textContent.trim();
                if (text.includes('üìä')) btn.textContent = `üìä ${t('dashboard')}`;
                else if (text.includes('üë•')) btn.textContent = `üë• ${t('employees')}`;
                else if (text.includes('üìÅ')) btn.textContent = `üìÅ ${t('projects')}`;
                else if (text.includes('üåç')) btn.textContent = `üåç ${t('regions')}`;
                else if (text.includes('üèõÔ∏è')) btn.textContent = `üèõÔ∏è ${t('departments')}`;
                else if (text.includes('üìÖ')) btn.textContent = `üìÖ ${t('leaves')}`;
                else if (text.includes('üìà')) btn.textContent = `üìà ${t('reports')}`;
                else if (text.includes('üë§')) btn.textContent = `üë§ ${t('users')}`;
                else if (text.includes('‚öôÔ∏è')) btn.textContent = `‚öôÔ∏è ${t('settings')}`;
            });
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿπŸÜÿßŸàŸäŸÜ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ
            const sectionTitles = document.querySelectorAll('.section h2');
            sectionTitles.forEach(title => {
                const text = title.textContent.trim();
                if (text === 'ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ' || text === 'Dashboard') title.textContent = t('dashboard');
                else if (text === 'ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ' || text === 'Employees') title.textContent = t('employees');
                else if (text === 'ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ' || text === 'Projects') title.textContent = t('projects');
                else if (text === 'ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ' || text === 'Regions') title.textContent = t('regions');
                else if (text === 'ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ' || text === 'Departments') title.textContent = t('departments');
                else if (text === 'ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™' || text === 'Leaves') title.textContent = t('leaves');
                else if (text === 'ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ±' || text === 'Reports') title.textContent = t('reports');
                else if (text === 'ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ' || text === 'Users') title.textContent = t('users');
                else if (text === 'ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™' || text === 'Settings') title.textContent = t('settings');
            });
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿπŸÜÿßŸàŸäŸÜ ÿßŸÑŸÜŸàÿßŸÅÿ∞ (Modals)
            const employeeFormTitle = document.getElementById('employeeFormTitle');
            if (employeeFormTitle) {
                const isEdit = editingEmployeeId !== null;
                employeeFormTitle.textContent = isEdit ? t('editEmployee') : t('addEmployee');
            }
            
            const projectFormTitle = document.getElementById('projectFormTitle');
            if (projectFormTitle) {
                const isEdit = editingProjectId !== null;
                projectFormTitle.textContent = isEdit ? t('editProject') : t('addProject');
            }
            
            const regionFormTitle = document.getElementById('regionFormTitle');
            if (regionFormTitle) {
                const isEdit = editingRegionId !== null;
                regionFormTitle.textContent = isEdit ? t('editRegion') : t('addRegion');
            }
            
            const departmentFormTitle = document.getElementById('departmentFormTitle');
            if (departmentFormTitle) {
                const isEdit = editingDepartmentId !== null;
                departmentFormTitle.textContent = isEdit ? t('editDepartment') : t('addDepartment');
            }
            
            const leaveFormTitle = document.getElementById('leaveFormTitle');
            if (leaveFormTitle) {
                const isEdit = editingLeaveId !== null;
                leaveFormTitle.textContent = isEdit ? t('editLeave') : t('addLeave');
            }
            
            const userFormTitle = document.getElementById('userFormTitle');
            if (userFormTitle) {
                const isEdit = editingUserId !== null;
                userFormTitle.textContent = isEdit ? t('editUser') : t('addUser');
            }
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑŸÜŸàÿßŸÅÿ∞
            const submitButtons = document.querySelectorAll('[id$="SubmitBtn"]');
            submitButtons.forEach(btn => {
                const id = btn.id;
                if (id.includes('employee')) {
                    btn.textContent = editingEmployeeId ? t('saveChanges') : t('addBtn');
                } else if (id.includes('project')) {
                    btn.textContent = editingProjectId ? t('saveChanges') : t('addBtn');
                } else if (id.includes('region')) {
                    btn.textContent = editingRegionId ? t('saveChanges') : t('addBtn');
                } else if (id.includes('department')) {
                    btn.textContent = editingDepartmentId ? t('saveChanges') : t('addBtn');
                } else if (id.includes('leave')) {
                    btn.textContent = editingLeaveId ? t('saveChanges') : t('addBtn');
                } else if (id.includes('user')) {
                    btn.textContent = editingUserId ? t('saveChanges') : t('addBtn');
                }
            });
            
            // ÿ™ÿ≠ÿØŸäÿ´ ŸÜÿµŸàÿµ ŸÇÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ÿßŸÑŸÖŸÇŸÅŸÑ
            const usersSectionLocked = document.querySelector('#usersSectionLocked h2');
            if (usersSectionLocked) {
                usersSectionLocked.textContent = t('usersSectionLocked');
            }
            const usersSectionLockedDesc = document.querySelector('#usersSectionLocked p');
            if (usersSectionLockedDesc && usersSectionLockedDesc.textContent.includes('Ÿäÿ¨ÿ® ÿ•ÿØÿÆÿßŸÑ')) {
                usersSectionLockedDesc.textContent = t('usersSectionLockedDesc');
            }
            const unlockBtn = document.querySelector('#usersSectionLocked button');
            if (unlockBtn && unlockBtn.textContent.includes('ÿ•ÿØÿÆÿßŸÑ')) {
                unlockBtn.innerHTML = `üîì ${t('unlockSection')}`;
            }
            const lockBtn = document.querySelector('#usersSectionContent button[onclick="lockUsersSection()"]');
            if (lockBtn) {
                lockBtn.innerHTML = `üîí ${t('lockSection')}`;
            }
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ŸÇŸàŸÇ ÿßŸÑŸÜÿ¥ÿ±
            const copyrightElements = document.querySelectorAll('[data-translate="copyright"]');
            copyrightElements.forEach(el => {
                el.textContent = t('copyright');
            });
            const copyrightEnElements = document.querySelectorAll('[data-translate="copyrightEn"]');
            copyrightEnElements.forEach(el => {
                if (currentLanguage === 'en') {
                    el.style.display = 'none';
                } else {
                    el.style.display = 'block';
                }
            });
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿ¨ŸÖŸäÿπ ÿßŸÑÿπŸÜÿßÿµÿ± ÿßŸÑÿ™Ÿä ÿ™ÿ≠ÿ™ŸàŸä ÿπŸÑŸâ data-translate
            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.getAttribute('data-translate');
                if (translations[currentLanguage] && translations[currentLanguage][key]) {
                    el.textContent = t(key);
                }
            });
        }
        let editingLeaveId = null;
        let projectsData = [];
        let editingEmployeeId = null;
        let regionsData = [];
        let editingRegionId = null;
        let editingProjectId = null;
        let departmentsData = [];
        let editingDepartmentId = null;
        let editingUserId = null;
        // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© generalManagementProjectId - ÿßŸÑÿ¢ŸÜ ŸÜÿ≥ÿ™ÿÆÿØŸÖ isGeneralManagement ŸÅŸä ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ
        
        // ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿßŸÑŸÖŸàÿ∏ŸÅ
        let employeePhotoFile = null;
        let employeeDocumentsToUpload = [];
        let employeeDocumentsToDelete = [];
        let employeeContacts = [];
        let employeeProjectsHistory = [];
        let employeePenalties = [];
        let employeeRewards = [];
        let employeeEvaluations = [];
        let editingEvaluationId = null;

        // ============================================
        // ÿØŸàÿßŸÑ ÿßŸÑÿ™ŸÜŸÇŸÑ ÿ®ŸäŸÜ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ
        // ============================================
        async function showSection(sectionId) {
            // ÿ•ÿÆŸÅÿßÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // ÿ•ÿ≤ÿßŸÑÿ© active ŸÖŸÜ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ±
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿπŸÜÿØ ŸÅÿ™ÿ≠ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ
            if (sectionId === 'settings') {
                loadAuditLogs(100).then(() => {
                    displayAuditLogs();
                });
            }
            
            // ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑŸÇÿ≥ŸÖ ÿßŸÑŸÖÿ≠ÿØÿØ
            const section = document.getElementById(sectionId);
            if (section) {
                section.classList.add('active');
            }
            
            // ÿ•ÿ∂ÿßŸÅÿ© active ŸÑŸÑÿ≤ÿ± ÿßŸÑŸÖÿ≠ÿØÿØ
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿπŸÜÿØ ŸÅÿ™ÿ≠ ÿßŸÑŸÇÿ≥ŸÖ
            if (sectionId === 'dashboard') {
                loadDashboardStats();
            } else if (sectionId === 'employees') {
                // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ÿ£ŸàŸÑÿßŸã ŸÑÿ£ŸÜ displayEmployees Ÿäÿ≠ÿ™ÿßÿ¨Ÿáÿß
                try {
                    await loadDepartments();
                } catch (err) {
                    console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ:', err);
                }
                // ÿ´ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ
                try {
                    await loadEmployees();
                } catch (err) {
                    console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ:', err);
                }
            } else if (sectionId === 'projects') {
                loadProjects();
                loadRegions(); // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ ŸÑÿπÿ±ÿ∂Ÿáÿß ŸÅŸä ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ
            } else if (sectionId === 'regions') {
                loadRegions();
                loadProjects(); // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ ŸÑÿ≠ÿ≥ÿßÿ® ÿßŸÑÿπÿØÿØ
            } else if (sectionId === 'departments') {
                loadDepartments();
                loadProjects(); // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ ŸÑÿπÿ±ÿ∂Ÿáÿß ŸÅŸä ÿßŸÑŸÇÿßÿ¶ŸÖÿ©
                loadEmployees(); // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ ŸÑÿ≠ÿ≥ÿßÿ® ÿßŸÑÿπÿØÿØ
            } else if (sectionId === 'leaves') {
                leavesViewAllMonths = false;
                const now = new Date();
                leavesViewYear = now.getFullYear();
                leavesViewMonth = now.getMonth();
                updateLeavesMonthLabel();
                loadLeaves();
            } else if (sectionId === 'reports') {
                // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÑÿ™ŸÇÿßÿ±Ÿäÿ± (ÿ∫Ÿäÿ± ŸÖÿ™ÿ≤ÿßŸÖŸÜ)
                loadEmployees().catch(err => console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ:', err));
                loadLeaves().catch(err => console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™:', err));
                loadProjects().catch(err => console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ:', err));
            } else if (sectionId === 'users') {
                // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ŸÇÿ®ŸÑ ŸÅÿ™ÿ≠ ŸÇÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ
                if (!window.usersSectionUnlocked) {
                    const lockedDiv = document.getElementById('usersSectionLocked');
                    const contentDiv = document.getElementById('usersSectionContent');
                    if (lockedDiv) lockedDiv.style.display = 'block';
                    if (contentDiv) contentDiv.style.display = 'none';
                    return; // ŸÑŸÜ ŸÜŸÉŸÖŸÑ ŸÅÿ™ÿ≠ ÿßŸÑŸÇÿ≥ŸÖ ÿ≠ÿ™Ÿâ Ÿäÿ™ŸÖ ÿ•ÿØÿÆÿßŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±
                }
                const lockedDiv = document.getElementById('usersSectionLocked');
                const contentDiv = document.getElementById('usersSectionContent');
                if (lockedDiv) lockedDiv.style.display = 'none';
                if (contentDiv) contentDiv.style.display = 'block';
                loadUsers();
            } else if (sectionId === 'settings') {
                loadDatabaseSettings();
                loadCompanyInfo();
                loadAuditLogs(100).then(() => {
                    displayAuditLogs();
                });
            }
        }

        // ============================================
        // ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ
        // ============================================
        async function loadDashboardStats() {
            try {
                if (!window.db || !window.firestore) {
                    console.warn('Firebase ÿ∫Ÿäÿ± ŸÖŸáŸäÿ£');
                    return;
                }

                // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ
                const employeesRef = window.firestore.collection(window.db, 'employees');
                const employeesSnapshot = await window.firestore.getDocs(employeesRef);
                const totalEmployees = employeesSnapshot.size;
                const activeEmployees = employeesSnapshot.docs.filter(doc => {
                    const data = doc.data();
                    return data.status === 'active';
                }).length;

                // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ
                const projectsRef = window.firestore.collection(window.db, 'projects');
                const projectsSnapshot = await window.firestore.getDocs(projectsRef);
                const totalProjects = projectsSnapshot.size;
                const activeProjects = projectsSnapshot.docs.filter(doc => {
                    const data = doc.data();
                    return data.status === 'active';
                }).length;

                // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™
                document.getElementById('totalEmployees').textContent = totalEmployees;
                document.getElementById('activeEmployees').textContent = activeEmployees;
                document.getElementById('totalProjects').textContent = totalProjects;
                document.getElementById('activeProjects').textContent = activeProjects;
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ:', error);
                if (error.code === 'permission-denied' || error.message?.includes('permission')) {
                    console.error('‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™: Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ∑ÿ®ŸäŸÇ ŸÇŸàÿßÿπÿØ Firestore ŸÅŸä Firebase Console');
                }
            }
        }

        // ============================================
        // ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ
        // ============================================
        async function loadEmployees() {
            try {
                if (!window.db || !window.firestore) {
                    console.warn('Firebase ÿ∫Ÿäÿ± ŸÖŸáŸäÿ£');
                    const tbody = document.getElementById('employeesTableBody');
                    if (tbody) {
                        tbody.innerHTML = '<tr><td colspan="12" style="text-align: center; padding: 40px; color: #dc3545;">‚ö†Ô∏è Firebase ÿ∫Ÿäÿ± ŸÖŸáŸäÿ£ - Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™</td></tr>';
                    }
                    return;
                }

                // ÿ•ÿ∏Ÿáÿßÿ± ÿ±ÿ≥ÿßŸÑÿ© ÿ™ÿ≠ŸÖŸäŸÑ
                const tbody = document.getElementById('employeesTableBody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="12" style="text-align: center; padding: 40px; color: #667eea;">‚è≥ ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...</td></tr>';
                }

                const employeesRef = window.firestore.collection(window.db, 'employees');
                const snapshot = await window.firestore.getDocs(employeesRef);
                
                console.log('üìä [LOAD-EMPLOYEES] ÿπÿØÿØ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ ŸÖŸÜ Firestore:', snapshot.size);
                
                employeesData = [];
                let loadedCount = 0;
                snapshot.forEach(doc => {
                    try {
                        const data = doc.data();
                        if (!data) {
                            console.warn(`‚ö†Ô∏è [LOAD-EMPLOYEES] ÿ®ŸäÿßŸÜÿßÿ™ ŸÅÿßÿ±ÿ∫ÿ© ŸÑŸÑŸÖŸàÿ∏ŸÅ ${doc.id}`);
                            return;
                        }
                        
                        employeesData.push({ 
                            id: doc.id, 
                            ...data,
                            // ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ©
                            name: data.name || 'ÿ®ÿØŸàŸÜ ÿßÿ≥ŸÖ',
                            employeeNumber: data.employeeNumber || '',
                            status: data.status || 'active',
                            hireDate: data.hireDate || '',
                            position: data.position || '',
                            email: data.email || '',
                            phone: data.phone || '',
                            address: data.address || '',
                            departmentId: data.departmentId || null,
                            replacementEmployeeId: data.replacementEmployeeId || null,
                            photoURL: data.photoURL || null
                        });
                        loadedCount++;
                    } catch (err) {
                        console.error(`‚ùå [LOAD-EMPLOYEES] ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿπÿßŸÑÿ¨ÿ© ŸÖŸàÿ∏ŸÅ ${doc.id}:`, err);
                    }
                });

                console.log('‚úÖ [LOAD-EMPLOYEES] ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ', loadedCount, 'ŸÖŸÜ', snapshot.size, 'ŸÖŸàÿ∏ŸÅ ÿ®ŸÜÿ¨ÿßÿ≠');
                console.log('üìã [LOAD-EMPLOYEES] ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ:', employeesData.map(e => ({
                    id: e.id,
                    name: e.name,
                    employeeNumber: e.employeeNumber,
                    departmentId: e.departmentId
                })));
                
                // ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ£ŸÜ departmentsData ŸÖÿ≠ŸÖŸÑÿ© ŸÇÿ®ŸÑ ÿßŸÑÿπÿ±ÿ∂
                if (!departmentsData || departmentsData.length === 0) {
                    console.warn('‚ö†Ô∏è [LOAD-EMPLOYEES] departmentsData ÿ∫Ÿäÿ± ŸÖÿ≠ŸÖŸÑÿ©ÿå ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...');
                    try {
                        await loadDepartments();
                        console.log('‚úÖ [LOAD-EMPLOYEES] ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ÿ®ŸÜÿ¨ÿßÿ≠');
                    } catch (deptErr) {
                        console.error('‚ùå [LOAD-EMPLOYEES] ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ:', deptErr);
                    }
                }
                
                // ÿπÿ±ÿ∂ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                displayEmployees();
                updateEmployeesCount();
                
                // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ∏Ÿáÿ±ÿ™ ŸÅŸä ÿßŸÑÿ¨ÿØŸàŸÑ
                setTimeout(() => {
                    const tbody = document.getElementById('employeesTableBody');
                    if (tbody) {
                        const rows = tbody.querySelectorAll('tr');
                        console.log('üìä [LOAD-EMPLOYEES] ÿπÿØÿØ ÿßŸÑÿµŸÅŸàŸÅ ŸÅŸä ÿßŸÑÿ¨ÿØŸàŸÑ:', rows.length);
                        if (rows.length === 0 || (rows.length === 1 && rows[0].textContent.includes('ŸÑÿß ÿ™Ÿàÿ¨ÿØ'))) {
                            console.error('‚ùå [LOAD-EMPLOYEES] ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÖ ÿ™ÿ∏Ÿáÿ± ŸÅŸä ÿßŸÑÿ¨ÿØŸàŸÑ!');
                        } else {
                            console.log('‚úÖ [LOAD-EMPLOYEES] ÿ™ŸÖ ÿπÿ±ÿ∂', rows.length, 'ÿµŸÅ ŸÅŸä ÿßŸÑÿ¨ÿØŸàŸÑ');
                        }
                    }
                }, 100);
                
            } catch (error) {
                console.error('‚ùå [LOAD-EMPLOYEES] ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ:', error);
                const tbody = document.getElementById('employeesTableBody');
                if (tbody) {
                    tbody.innerHTML = `<tr><td colspan="12" style="text-align: center; padding: 40px; color: #dc3545;">
                        <div style="font-size: 18px; margin-bottom: 10px;">‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</div>
                        <div style="font-size: 14px; color: #666;">${error.message || 'ÿÆÿ∑ÿ£ ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ'}</div>
                        <button onclick="loadEmployees()" class="btn btn-primary" style="margin-top: 15px; padding: 8px 16px;">ÿ•ÿπÿßÿØÿ© ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ©</button>
                    </td></tr>`;
                }
            }
        }

        // ÿØÿßŸÑÿ© ÿ™ÿ±ÿ™Ÿäÿ® ÿ∞ŸÉŸäÿ© ÿ≠ÿ≥ÿ® ÿ±ŸÖÿ≤ ÿßŸÑŸÖŸàÿ∏ŸÅ
        function sortEmployeesByNumber(employees) {
            // #region agent log
            console.log('üîç [DEBUG-SORT] ÿ®ÿØÿ° ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ ÿ≠ÿ≥ÿ® employeeNumber, ÿßŸÑÿπÿØÿØ:', employees.length);
            const beforeSort = employees.map(e => e.employeeNumber || '-').slice(0, 5);
            console.log('üîç [DEBUG-SORT] ÿ£ŸàŸÑ 5 ÿ£ÿ±ŸÇÿßŸÖ ŸÇÿ®ŸÑ ÿßŸÑÿ™ÿ±ÿ™Ÿäÿ®:', beforeSort);
            // #endregion
            
            const sorted = [...employees].sort((a, b) => {
                const numA = a.employeeNumber || '';
                const numB = b.employeeNumber || '';
                
                // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÉŸÑÿßŸáŸÖÿß ÿ£ÿ±ŸÇÿßŸÖÿå ŸÇÿßÿ±ŸÜ ŸÉÿ£ÿ±ŸÇÿßŸÖ
                const numAInt = parseInt(numA);
                const numBInt = parseInt(numB);
                
                if (!isNaN(numAInt) && !isNaN(numBInt)) {
                    return numAInt - numBInt;
                }
                
                // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿ£ÿ≠ÿØŸáŸÖÿß ÿ±ŸÇŸÖ ŸàÿßŸÑÿ¢ÿÆÿ± ŸÜÿµÿå ÿßŸÑÿ£ÿ±ŸÇÿßŸÖ ÿ£ŸàŸÑÿßŸã
                if (!isNaN(numAInt) && isNaN(numBInt)) return -1;
                if (isNaN(numAInt) && !isNaN(numBInt)) return 1;
                
                // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÉŸÑÿßŸáŸÖÿß ŸÜÿµŸàÿµÿå ŸÇÿßÿ±ŸÜ ŸÜÿµŸäÿßŸã
                return numA.localeCompare(numB, 'ar', { numeric: true, sensitivity: 'base' });
            });
            
            // #region agent log
            const afterSort = sorted.map(e => e.employeeNumber || '-').slice(0, 5);
            console.log('üîç [DEBUG-SORT] ÿ£ŸàŸÑ 5 ÿ£ÿ±ŸÇÿßŸÖ ÿ®ÿπÿØ ÿßŸÑÿ™ÿ±ÿ™Ÿäÿ®:', afterSort);
            // #endregion
            
            return sorted;
        }

        function displayEmployees() {
            const tbody = document.getElementById('employeesTableBody');
            if (!tbody) {
                console.error('‚ùå [DISPLAY-EMPLOYEES] ÿπŸÜÿµÿ± employeesTableBody ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ ŸÅŸä DOM');
                return;
            }
            
            if (!employeesData || employeesData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" style="text-align: center; padding: 40px; color: #666;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸàÿ∏ŸÅŸäŸÜ</td></tr>';
                console.warn('‚ö†Ô∏è [DISPLAY-EMPLOYEES] ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸàÿ∏ŸÅŸäŸÜ ŸÑŸÑÿπÿ±ÿ∂');
                return;
            }

            // #region agent log
            console.log('üîç [DEBUG-DISPLAY] ÿπÿ±ÿ∂ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ, ÿßŸÑÿπÿØÿØ:', employeesData.length);
            // #endregion

            try {
                // ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ ÿ≠ÿ≥ÿ® ÿ±ŸÖÿ≤ ÿßŸÑŸÖŸàÿ∏ŸÅ
                const sortedEmployees = sortEmployeesByNumber(employeesData);

            tbody.innerHTML = sortedEmployees.map(emp => {
                // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÖŸàÿ∏ŸÅ ÿßŸÑÿ®ÿØŸäŸÑ
                let replacementEmployeeName = '-';
                if (emp.replacementEmployeeId) {
                    const replacementEmp = employeesData.find(e => e.id === emp.replacementEmployeeId);
                    if (replacementEmp) {
                        replacementEmployeeName = replacementEmp.name || '-';
                    }
                }
                
                // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÇÿ≥ŸÖ
                let departmentName = '-';
                if (emp.departmentId) {
                    // ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ£ŸÜ departmentsData ŸÖÿ≠ŸÖŸÑÿ©
                    if (departmentsData && departmentsData.length > 0) {
                        const department = departmentsData.find(d => d.id === emp.departmentId);
                        if (department) {
                            departmentName = department.name || '-';
                        }
                    } else {
                        // ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™ŸÉŸÜ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ŸÖÿ≠ŸÖŸÑÿ©ÿå ŸÜÿ≠ÿßŸàŸÑ ÿ™ÿ≠ŸÖŸäŸÑŸáÿß
                        console.warn('‚ö†Ô∏è [DISPLAY-EMPLOYEES] departmentsData ÿ∫Ÿäÿ± ŸÖÿ≠ŸÖŸÑÿ©ÿå ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...');
                        loadDepartments().catch(err => console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ:', err));
                    }
                }
                
                // ÿπÿ±ÿ∂ ÿßŸÑÿµŸàÿ±ÿ©
                const photoDisplay = emp.photoURL 
                    ? `<img src="${emp.photoURL}" alt="${emp.name || 'ÿµŸàÿ±ÿ© ÿßŸÑŸÖŸàÿ∏ŸÅ'}" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid #e9ecef; cursor: pointer;" onclick="viewEmployeePhoto('${emp.photoURL}', '${emp.name || ''}')" title="ÿßŸÜŸÇÿ± ŸÑÿπÿ±ÿ∂ ÿßŸÑÿµŸàÿ±ÿ©">`
                    : `<div style="width: 50px; height: 50px; border-radius: 50%; background: #e9ecef; display: flex; align-items: center; justify-content: center; color: #999; font-size: 20px;" title="ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿµŸàÿ±ÿ©">üë§</div>`;
                
                // ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ
                const formattedHireDate = emp.hireDate ? formatDate(emp.hireDate) : '-';
                
                // ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä (ÿ•ÿ∏Ÿáÿßÿ± ÿ¨ÿ≤ÿ° ŸÖŸÜŸá ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿ∑ŸàŸäŸÑÿßŸã)
                const emailDisplay = emp.email && emp.email.length > 25 
                    ? `<span title="${emp.email}">${emp.email.substring(0, 22)}...</span>`
                    : (emp.email || '-');
                
                // ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑÿπŸÜŸàÿßŸÜ (ÿ•ÿ∏Ÿáÿßÿ± ÿ¨ÿ≤ÿ° ŸÖŸÜŸá ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿ∑ŸàŸäŸÑÿßŸã)
                const addressDisplay = emp.address && emp.address.length > 30
                    ? `<span title="${emp.address}">${emp.address.substring(0, 27)}...</span>`
                    : (emp.address || '-');
                
                return `
                <tr>
                    <td style="text-align: center; padding: 10px;">${photoDisplay}</td>
                    <td><strong style="color: #667eea;">${emp.employeeNumber || '-'}</strong></td>
                    <td style="font-weight: 500;">${emp.name || '-'}</td>
                    <td>${emp.position || '-'}</td>
                    <td><span style="color: #ff9800; font-weight: 600;">${departmentName}</span></td>
                    <td style="font-size: 13px;">${emailDisplay}</td>
                    <td>${emp.phone || '-'}</td>
                    <td style="font-size: 13px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${emp.address || ''}">${addressDisplay}</td>
                    <td style="white-space: nowrap;">${formattedHireDate}</td>
                    <td><span class="badge ${getStatusBadge(emp.status)}">${getEmployeeStatusName(emp.status)}</span></td>
                    <td>${replacementEmployeeName}</td>
                    <td class="action-buttons" style="white-space: nowrap;">
                        <button class="btn btn-info" onclick="viewEmployeeProjects('${emp.id}')" style="margin-left: 5px; padding: 6px 10px; font-size: 12px;" title="ÿ≥ÿ¨ŸÑ ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ">üìÅ</button>
                        <button class="btn btn-secondary" onclick="viewEmployeeDocuments('${emp.id}')" style="margin-left: 5px; padding: 6px 10px; font-size: 12px;" title="ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑŸÖÿ±ŸÅŸÇÿ©">üìé</button>
                        <button class="btn btn-warning" onclick="viewEmployeeEvaluations('${emp.id}')" style="margin-left: 5px; padding: 6px 10px; font-size: 12px; background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);" title="ÿßŸÑÿ™ŸÇŸäŸäŸÖ ÿßŸÑÿ≥ŸÜŸàŸä (ŸÖÿ≠ŸÖŸä)">‚≠ê</button>
                        <button class="btn btn-primary" onclick="editEmployee('${emp.id}')" style="padding: 6px 12px; font-size: 12px;">ÿ™ÿπÿØŸäŸÑ</button>
                        <button class="btn btn-danger" onclick="deleteEmployee('${emp.id}')" style="padding: 6px 12px; font-size: 12px;">ÿ≠ÿ∞ŸÅ</button>
                    </td>
                </tr>
            `;
            }).join('');
                
                console.log('‚úÖ [DISPLAY-EMPLOYEES] ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° HTML ŸÑŸÑÿ¨ÿØŸàŸÑ ÿ®ŸÜÿ¨ÿßÿ≠ - ÿπÿØÿØ ÿßŸÑÿµŸÅŸàŸÅ:', sortedEmployees.length);
            } catch (error) {
                console.error('‚ùå [DISPLAY-EMPLOYEES] ÿÆÿ∑ÿ£ ŸÅŸä ÿπÿ±ÿ∂ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ:', error);
                tbody.innerHTML = `<tr><td colspan="12" style="text-align: center; padding: 40px; color: #dc3545;">
                    <div style="font-size: 18px; margin-bottom: 10px;">‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿπÿ±ÿ∂ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</div>
                    <div style="font-size: 14px; color: #666;">${error.message || 'ÿÆÿ∑ÿ£ ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ'}</div>
                    <button onclick="loadEmployees()" class="btn btn-primary" style="margin-top: 15px; padding: 8px 16px;">ÿ•ÿπÿßÿØÿ© ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ©</button>
                </td></tr>`;
            }
        }

        function filterEmployees() {
            const search = document.getElementById('employeeSearch').value.toLowerCase();
            const statusFilter = document.getElementById('employeeStatusFilter').value;

            const filtered = employeesData.filter(emp => {
                const matchSearch = !search || 
                    (emp.name && emp.name.toLowerCase().includes(search)) ||
                    (emp.employeeNumber && emp.employeeNumber.toLowerCase().includes(search)) ||
                    (emp.email && emp.email.toLowerCase().includes(search));
                
                const matchStatus = !statusFilter || emp.status === statusFilter;
                
                return matchSearch && matchStatus;
            });

            // #region agent log
            console.log('üîç [DEBUG-FILTER] ÿ™ÿµŸÅŸäÿ© ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ, ÿπÿØÿØ ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨:', filtered.length);
            // #endregion

            // ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨ ÿßŸÑŸÖÿµŸÅÿßÿ© ÿ≠ÿ≥ÿ® ÿ±ŸÖÿ≤ ÿßŸÑŸÖŸàÿ∏ŸÅ
            const sortedFiltered = sortEmployeesByNumber(filtered);

            // ÿπÿ±ÿ∂ ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨ ŸÖÿπ ÿßŸÑŸÇÿ≥ŸÖ
            const tbody = document.getElementById('employeesTableBody');
            if (sortedFiltered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" style="text-align: center; padding: 40px;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ™ÿßÿ¶ÿ¨</td></tr>';
            } else {
                tbody.innerHTML = sortedFiltered.map(emp => {
                    // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÖŸàÿ∏ŸÅ ÿßŸÑÿ®ÿØŸäŸÑ
                    let replacementEmployeeName = '-';
                    if (emp.replacementEmployeeId) {
                        const replacementEmp = employeesData.find(e => e.id === emp.replacementEmployeeId);
                        if (replacementEmp) {
                            replacementEmployeeName = replacementEmp.name || '-';
                        }
                    }
                    
                    // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÇÿ≥ŸÖ
                    let departmentName = '-';
                    if (emp.departmentId) {
                        const department = departmentsData.find(d => d.id === emp.departmentId);
                        if (department) {
                            departmentName = department.name || '-';
                        }
                    }
                    
                    // ÿπÿ±ÿ∂ ÿßŸÑÿµŸàÿ±ÿ©
                    const photoDisplay = emp.photoURL 
                        ? `<img src="${emp.photoURL}" alt="${emp.name || 'ÿµŸàÿ±ÿ© ÿßŸÑŸÖŸàÿ∏ŸÅ'}" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid #e9ecef; cursor: pointer;" onclick="viewEmployeePhoto('${emp.photoURL}', '${emp.name || ''}')" title="ÿßŸÜŸÇÿ± ŸÑÿπÿ±ÿ∂ ÿßŸÑÿµŸàÿ±ÿ©">`
                        : `<div style="width: 50px; height: 50px; border-radius: 50%; background: #e9ecef; display: flex; align-items: center; justify-content: center; color: #999; font-size: 20px;" title="ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿµŸàÿ±ÿ©">üë§</div>`;
                    
                    // ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ
                    const formattedHireDate = emp.hireDate ? formatDate(emp.hireDate) : '-';
                    
                    // ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä (ÿ•ÿ∏Ÿáÿßÿ± ÿ¨ÿ≤ÿ° ŸÖŸÜŸá ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿ∑ŸàŸäŸÑÿßŸã)
                    const emailDisplay = emp.email && emp.email.length > 25 
                        ? `<span title="${emp.email}">${emp.email.substring(0, 22)}...</span>`
                        : (emp.email || '-');
                    
                    // ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑÿπŸÜŸàÿßŸÜ (ÿ•ÿ∏Ÿáÿßÿ± ÿ¨ÿ≤ÿ° ŸÖŸÜŸá ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿ∑ŸàŸäŸÑÿßŸã)
                    const addressDisplay = emp.address && emp.address.length > 30
                        ? `<span title="${emp.address}">${emp.address.substring(0, 27)}...</span>`
                        : (emp.address || '-');
                    
                    return `
                        <tr>
                            <td style="text-align: center; padding: 10px;">${photoDisplay}</td>
                            <td><strong style="color: #667eea;">${emp.employeeNumber || '-'}</strong></td>
                            <td style="font-weight: 500;">${emp.name || '-'}</td>
                            <td>${emp.position || '-'}</td>
                            <td><span style="color: #ff9800; font-weight: 600;">${departmentName}</span></td>
                            <td style="font-size: 13px;">${emailDisplay}</td>
                            <td>${emp.phone || '-'}</td>
                            <td style="font-size: 13px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${emp.address || ''}">${addressDisplay}</td>
                            <td style="white-space: nowrap;">${formattedHireDate}</td>
                            <td><span class="badge ${getStatusBadge(emp.status)}">${getEmployeeStatusName(emp.status)}</span></td>
                            <td>${replacementEmployeeName}</td>
                            <td class="action-buttons" style="white-space: nowrap;">
                                <button class="btn btn-info" onclick="viewEmployeeProjects('${emp.id}')" style="margin-left: 5px; padding: 6px 10px; font-size: 12px;" title="ÿ≥ÿ¨ŸÑ ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ">üìÅ</button>
                                <button class="btn btn-secondary" onclick="viewEmployeeDocuments('${emp.id}')" style="margin-left: 5px; padding: 6px 10px; font-size: 12px;" title="ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑŸÖÿ±ŸÅŸÇÿ©">üìé</button>
                                <button class="btn btn-warning" onclick="viewEmployeeEvaluations('${emp.id}')" style="margin-left: 5px; padding: 6px 10px; font-size: 12px; background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);" title="ÿßŸÑÿ™ŸÇŸäŸäŸÖ ÿßŸÑÿ≥ŸÜŸàŸä (ŸÖÿ≠ŸÖŸä)">‚≠ê</button>
                                <button class="btn btn-primary" onclick="editEmployee('${emp.id}')" style="padding: 6px 12px; font-size: 12px;">ÿ™ÿπÿØŸäŸÑ</button>
                                <button class="btn btn-danger" onclick="deleteEmployee('${emp.id}')" style="padding: 6px 12px; font-size: 12px;">ÿ≠ÿ∞ŸÅ</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
            
            updateEmployeesCount();
        }

        function clearEmployeeFilters() {
            document.getElementById('employeeSearch').value = '';
            document.getElementById('employeeStatusFilter').value = '';
            displayEmployees();
            updateEmployeesCount();
        }

        function updateEmployeesCount() {
            document.getElementById('employeesCount').textContent = `ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ: ${employeesData.length}`;
        }

        // ÿ™ŸàŸÑŸäÿØ ÿ±ŸÖÿ≤ ÿßŸÑŸÖŸàÿ∏ŸÅ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã
        async function generateEmployeeCode() {
            try {
                if (!window.db || !window.firestore) {
                    return 'EMP-001';
                }

                const employeesRef = window.firestore.collection(window.db, 'employees');
                const snapshot = await window.firestore.getDocs(employeesRef);
                const count = snapshot.size;
                const codeNumber = String(count + 1).padStart(3, '0');
                return `EMP-${codeNumber}`;
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ŸàŸÑŸäÿØ ÿ±ŸÖÿ≤ ÿßŸÑŸÖŸàÿ∏ŸÅ:', error);
                return 'EMP-001';
            }
        }

        // ÿ™ŸàŸÑŸäÿØ ÿ±ŸÇŸÖ ŸÖŸàÿ∏ŸÅ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã (ŸÑŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÅŸä ÿßŸÑÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿ™ÿπÿØÿØÿ©)
        let bulkEmployeeNumberCounter = 0;
        async function generateNextEmployeeNumber() {
            if (bulkEmployeeNumberCounter === 0) {
                // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿ¢ÿÆÿ± ÿ±ŸÇŸÖ ŸÖŸàÿ∏ŸÅ
                try {
                    if (window.db && window.firestore) {
                        const employeesRef = window.firestore.collection(window.db, 'employees');
                        const snapshot = await window.firestore.getDocs(employeesRef);
                        const count = snapshot.size;
                        bulkEmployeeNumberCounter = count;
                    }
                } catch (error) {
                    console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿπÿØÿØ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ:', error);
                }
            }
            bulkEmployeeNumberCounter++;
            const codeNumber = String(bulkEmployeeNumberCounter).padStart(3, '0');
            return `EMP-${codeNumber}`;
        }

        // ÿπÿ±ÿ∂ ŸÜÿßŸÅÿ∞ÿ© ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸàÿ∏ŸÅ
        async function showAddEmployeeForm() {
            editingEmployeeId = null;
            const modal = document.getElementById('employeeModal');
            if (!modal) return;

            // ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ™ÿ±ÿ¨ŸÖÿßÿ™ ŸÇÿ®ŸÑ ŸÅÿ™ÿ≠ ÿßŸÑŸÜÿßŸÅÿ∞ÿ©
            applyTranslations();
            document.getElementById('employeeSubmitBtn').setAttribute('onclick', 'addEmployee()');

            // ÿ™ŸàŸÑŸäÿØ ÿ±ŸÖÿ≤ ÿßŸÑŸÖŸàÿ∏ŸÅ
            const empCode = await generateEmployeeCode();
            document.getElementById('empNumberDisplay').textContent = empCode;

            // ŸÖÿ≥ÿ≠ ÿßŸÑÿ≠ŸÇŸàŸÑ
            document.getElementById('empName').value = '';
            document.getElementById('empNameEn').value = '';
            document.getElementById('empEmail').value = '';
            document.getElementById('empPhone').value = '';
            document.getElementById('empAddress').value = '';
            document.getElementById('empWorkLocation').value = '';
            document.getElementById('empPosition').value = '';
            // ÿ™ÿπŸäŸäŸÜ ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸäŸàŸÖ ÿßŸÑÿ≠ÿßŸÑŸä ŸÉŸÇŸäŸÖÿ© ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ© ŸÑÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ•ÿØÿ±ÿßÿ¨ ŸÅŸä ÿßŸÑŸÜÿ∏ÿßŸÖ
            const today = new Date().toISOString().split('T')[0]; // ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸäŸàŸÖ ÿ®ÿµŸäÿ∫ÿ© YYYY-MM-DD
            document.getElementById('empHireDate').value = '';
            document.getElementById('empSystemEntryDate').value = today;
            document.getElementById('empEducation').value = '';
            document.getElementById('empSpecialization').value = '';
            document.getElementById('empStatus').value = 'active';
            document.getElementById('empSalaryCode').value = '';
            document.getElementById('empReplacement').value = '';
            document.getElementById('empMonthlyLeaveDays').value = '2.5';
            document.getElementById('empHourlyLeaveHours').value = '8';
            document.getElementById('empInitialLeaveBalance').value = '0';
            
            // ŸÖÿ≥ÿ≠ ÿ≠ŸÇŸàŸÑ ÿßŸÑÿ±ÿßÿ™ÿ®
            const initialSalaryField = document.getElementById('empInitialSalary');
            const currentSalaryField = document.getElementById('empCurrentSalary');
            const initialSalaryCurrency = document.getElementById('empInitialSalaryCurrency');
            const currentSalaryCurrency = document.getElementById('empCurrentSalaryCurrency');
            
            if (initialSalaryField) {
                initialSalaryField.type = 'password';
                initialSalaryField.value = '';
                initialSalaryField.readOnly = true;
                initialSalaryField.removeAttribute('data-salary-value');
            }
            if (currentSalaryField) {
                currentSalaryField.type = 'password';
                currentSalaryField.value = '';
                currentSalaryField.readOnly = true;
                currentSalaryField.removeAttribute('data-salary-value');
            }
            if (initialSalaryCurrency) {
                initialSalaryCurrency.value = 'IQD';
                initialSalaryCurrency.disabled = true;
            }
            if (currentSalaryCurrency) {
                currentSalaryCurrency.value = 'IQD';
                currentSalaryCurrency.disabled = true;
            }

            // ÿ™ÿ≠ÿØŸäÿ´ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ ÿßŸÑÿ®ÿØŸäŸÑŸäŸÜ
            updateReplacementSelect();
            
            // ÿ™ÿ≠ÿØŸäÿ´ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ
            updateDepartmentSelect();
            
            // ÿ™ÿ≠ÿØŸäÿ´ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ (ŸÖŸÉÿßŸÜ ÿßŸÑÿπŸÖŸÑ)
            updateWorkLocationSelect();

            // ŸÖÿ≥ÿ≠ ÿßŸÑÿµŸàÿ±ÿ© ŸàÿßŸÑŸÖÿ≥ÿ™ŸÜÿØÿßÿ™
            removeEmployeePhoto();
            employeeDocumentsToUpload = [];
            employeeDocumentsToDelete = [];
            document.getElementById('employeeDocumentsList').innerHTML = '';

            // ŸÖÿ≥ÿ≠ ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™
            employeeContacts = [];
            employeeProjectsHistory = [];
            employeePenalties = [];
            employeeRewards = [];
            employeeEvaluations = [];
            editingEvaluationId = null;
            window.evaluationViewUnlocked = false; // ÿ•ÿπÿßÿØÿ© ŸÇŸÅŸÑ ÿßŸÑÿ™ŸÇŸäŸäŸÖÿßÿ™
            displayContacts();
            displayProjectsHistory();
            displayPenalties();
            displayRewards();
            
            // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ŸÇŸäŸäŸÖÿßÿ™
            const evaluationsList = document.getElementById('evaluationsList');
            const lockedMessage = document.getElementById('evaluationsLockedMessage');
            const addBtn = document.getElementById('addEvaluationBtn');
            const lockIcon = document.getElementById('evaluationLockIcon');
            
            if (evaluationsList) evaluationsList.style.display = 'none';
            if (lockedMessage) lockedMessage.style.display = 'block';
            if (addBtn) addBtn.style.display = 'none';
            if (lockIcon) {
                lockIcon.textContent = 'üîí';
                lockIcon.title = 'ÿßŸÜŸÇÿ± ŸÑÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿ™ŸÇŸäŸäŸÖÿßÿ™';
            }

            modal.classList.add('active');
        }

        // ÿ•ÿÆŸÅÿßÿ° ŸÜÿßŸÅÿ∞ÿ© ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸàÿ∏ŸÅ
        function hideAddEmployeeForm() {
            const modal = document.getElementById('employeeModal');
            if (modal) {
                modal.classList.remove('active');
            }
            editingEmployeeId = null;
            employeePhotoFile = null;
            employeeDocumentsToUpload = [];
            employeeDocumentsToDelete = [];
            employeeContacts = [];
            employeeProjectsHistory = [];
            employeePenalties = [];
            employeeRewards = [];
            employeeEvaluations = [];
            editingEvaluationId = null;
        }

        // ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ŸÑÿ•ÿØÿßÿ±ÿ© ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ ÿßŸÑŸÖÿ™ÿπÿØÿØŸäŸÜ
        let bulkEmployeeRowCounter = 0;

        // ÿπÿ±ÿ∂ ŸÜÿßŸÅÿ∞ÿ© ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸàÿ∏ŸÅŸäŸÜ ŸÖÿ™ÿπÿØÿØŸäŸÜ
        async function showBulkAddEmployeesForm() {
            const modal = document.getElementById('bulkAddEmployeesModal');
            if (!modal) return;

            // ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ™ÿ±ÿ¨ŸÖÿßÿ™
            applyTranslations();

            // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™ŸÉŸÜ ŸÖÿ≠ŸÖŸÑÿ©
            if (!departmentsData || departmentsData.length === 0) {
                await loadDepartments();
            }

            // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿπÿØÿßÿØ
            bulkEmployeeRowCounter = 0;
            bulkEmployeeNumberCounter = 0;

            // ÿ•ÿ∂ÿßŸÅÿ© ÿµŸÅ ÿ£ŸàŸÑŸä
            const tbody = document.getElementById('bulkEmployeesTableBody');
            if (tbody) {
                tbody.innerHTML = '';
                await addBulkEmployeeRow();
            }

            modal.classList.add('active');
            updateBulkEmployeesCount();
        }

        // ÿ•ÿÆŸÅÿßÿ° ŸÜÿßŸÅÿ∞ÿ© ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸàÿ∏ŸÅŸäŸÜ ŸÖÿ™ÿπÿØÿØŸäŸÜ
        function hideBulkAddEmployeesForm() {
            const modal = document.getElementById('bulkAddEmployeesModal');
            if (modal) {
                modal.classList.remove('active');
            }
            bulkEmployeeRowCounter = 0;
        }

        // ÿ•ÿ∂ÿßŸÅÿ© ÿµŸÅ ÿ¨ÿØŸäÿØ ŸÅŸä ÿßŸÑÿ¨ÿØŸàŸÑ
        async function addBulkEmployeeRow() {
            const tbody = document.getElementById('bulkEmployeesTableBody');
            if (!tbody) return;

            bulkEmployeeRowCounter++;
            const rowIndex = bulkEmployeeRowCounter;

            // ÿ™ŸàŸÑŸäÿØ ÿ±ŸÇŸÖ ŸÖŸàÿ∏ŸÅ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã
            const nextEmployeeNumber = await generateNextEmployeeNumber();

            const row = document.createElement('tr');
            row.id = `bulkEmployeeRow_${rowIndex}`;
            row.innerHTML = `
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center; background: #f8f9fa;">
                    <strong>${rowIndex}</strong>
                </td>
                <td style="padding: 8px; border: 1px solid #ddd;">
                    <input type="text" class="bulk-emp-name" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </td>
                <td style="padding: 8px; border: 1px solid #ddd;">
                    <input type="text" class="bulk-emp-name-en" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </td>
                <td style="padding: 8px; border: 1px solid #ddd;">
                    <input type="email" class="bulk-emp-email" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </td>
                <td style="padding: 8px; border: 1px solid #ddd;">
                    <input type="text" class="bulk-emp-phone" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </td>
                <td style="padding: 8px; border: 1px solid #ddd;">
                    <input type="text" class="bulk-emp-address" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </td>
                <td style="padding: 8px; border: 1px solid #ddd;">
                    <input type="date" class="bulk-emp-hire-date" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </td>
                <td style="padding: 8px; border: 1px solid #ddd;">
                    <input type="date" class="bulk-emp-system-entry-date" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </td>
                <td style="padding: 8px; border: 1px solid #ddd;">
                    <input type="text" class="bulk-emp-position" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </td>
                <td style="padding: 8px; border: 1px solid #ddd;">
                    <select class="bulk-emp-education" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">ÿßÿÆÿ™ÿ±</option>
                        <option value="elementary">ÿßÿ®ÿ™ÿØÿßÿ¶Ÿä</option>
                        <option value="middle">ŸÖÿ™Ÿàÿ≥ÿ∑</option>
                        <option value="high_school">ÿ´ÿßŸÜŸàŸä</option>
                        <option value="diploma">ÿØÿ®ŸÑŸàŸÖ</option>
                        <option value="bachelor">ÿ®ŸÉÿßŸÑŸàÿ±ŸäŸàÿ≥</option>
                        <option value="master">ŸÖÿßÿ¨ÿ≥ÿ™Ÿäÿ±</option>
                        <option value="phd">ÿØŸÉÿ™Ÿàÿ±ÿßŸá</option>
                        <option value="other">ÿ£ÿÆÿ±Ÿâ</option>
                    </select>
                </td>
                <td style="padding: 8px; border: 1px solid #ddd;">
                    <input type="text" class="bulk-emp-specialization" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </td>
                <td style="padding: 8px; border: 1px solid #ddd;">
                    <select class="bulk-emp-status" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="active">ŸÜÿ¥ÿ∑</option>
                        <option value="inactive">ÿ∫Ÿäÿ± ŸÜÿ¥ÿ∑</option>
                        <option value="on-leave">ŸÅŸä ÿ•ÿ¨ÿßÿ≤ÿ©</option>
                        <option value="terminated">ŸÖŸÜÿ™ŸáŸä ÿßŸÑÿÆÿØŸÖÿ©</option>
                    </select>
                </td>
                <td style="padding: 8px; border: 1px solid #ddd;">
                    <input type="text" class="bulk-emp-salary-code" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </td>
                <td style="padding: 8px; border: 1px solid #ddd;">
                    <select class="bulk-emp-department" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">-- ÿßÿÆÿ™ÿ± ÿßŸÑŸÇÿ≥ŸÖ --</option>
                        ${departmentsData ? departmentsData.map(dept => `<option value="${dept.id}">${dept.name || dept.nameEn || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</option>`).join('') : ''}
                    </select>
                </td>
                <td style="padding: 8px; border: 1px solid #ddd;">
                    <input type="number" class="bulk-emp-monthly-leave" min="0" step="0.5" value="2.5" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </td>
                <td style="padding: 8px; border: 1px solid #ddd;">
                    <input type="number" class="bulk-emp-hourly-leave" min="0" step="0.5" value="8" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </td>
                <td style="padding: 8px; border: 1px solid #ddd;">
                    <input type="number" class="bulk-emp-initial-balance" step="0.5" value="0" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                    <button type="button" class="btn btn-danger" onclick="removeBulkEmployeeRow(${rowIndex})" style="padding: 5px 10px; font-size: 12px;">üóëÔ∏è</button>
                </td>
            `;

            // ÿ•ÿ∂ÿßŸÅÿ© ÿ≠ŸÇŸÑ ŸÖÿÆŸÅŸä ŸÑÿ±ŸÇŸÖ ÿßŸÑŸÖŸàÿ∏ŸÅ
            const empNumberInput = document.createElement('input');
            empNumberInput.type = 'hidden';
            empNumberInput.className = 'bulk-emp-number';
            empNumberInput.value = nextEmployeeNumber;
            row.querySelector('td:first-child').appendChild(empNumberInput);

            tbody.appendChild(row);
            updateBulkEmployeesCount();
        }

        // ÿ≠ÿ∞ŸÅ ÿµŸÅ ŸÖŸÜ ÿßŸÑÿ¨ÿØŸàŸÑ
        function removeBulkEmployeeRow(rowIndex) {
            const row = document.getElementById(`bulkEmployeeRow_${rowIndex}`);
            if (row) {
                row.remove();
                updateBulkEmployeesCount();
                // ÿ•ÿπÿßÿØÿ© ÿ™ÿ±ŸÇŸäŸÖ ÿßŸÑÿµŸÅŸàŸÅ
                renumberBulkEmployeeRows();
            }
        }

        // ÿ•ÿπÿßÿØÿ© ÿ™ÿ±ŸÇŸäŸÖ ÿßŸÑÿµŸÅŸàŸÅ
        function renumberBulkEmployeeRows() {
            const tbody = document.getElementById('bulkEmployeesTableBody');
            if (!tbody) return;

            const rows = tbody.querySelectorAll('tr');
            rows.forEach((row, index) => {
                const numberCell = row.querySelector('td:first-child');
                if (numberCell) {
                    numberCell.innerHTML = `<strong>${index + 1}</strong>`;
                }
            });
        }

        // ÿ™ÿ≠ÿØŸäÿ´ ÿπÿØÿØ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ
        function updateBulkEmployeesCount() {
            const tbody = document.getElementById('bulkEmployeesTableBody');
            const count = tbody ? tbody.querySelectorAll('tr').length : 0;
            const countElement = document.getElementById('bulkEmployeesCount');
            if (countElement) {
                countElement.textContent = count;
            }
        }

        // ŸÖÿ≥ÿ≠ ÿ¨ŸÖŸäÿπ ÿßŸÑÿµŸÅŸàŸÅ
        function clearBulkEmployeesForm() {
            if (confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ŸÖÿ≥ÿ≠ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ÿü')) {
                const tbody = document.getElementById('bulkEmployeesTableBody');
                if (tbody) {
                    tbody.innerHTML = '';
                    bulkEmployeeRowCounter = 0;
                    bulkEmployeeNumberCounter = 0;
                    updateBulkEmployeesCount();
                }
            }
        }

        // ÿπÿ±ÿ∂ ŸÜÿßŸÅÿ∞ÿ© ŸÑÿµŸÇ ŸÖŸÜ Excel
        function showPasteFromExcelDialog() {
            const modal = document.getElementById('pasteFromExcelModal');
            if (modal) {
                modal.classList.add('active');
                const textarea = document.getElementById('excelPasteData');
                if (textarea) {
                    textarea.value = '';
                    textarea.focus();
                }
            }
        }

        // ÿ•ÿÆŸÅÿßÿ° ŸÜÿßŸÅÿ∞ÿ© ŸÑÿµŸÇ ŸÖŸÜ Excel
        function hidePasteFromExcelDialog() {
            const modal = document.getElementById('pasteFromExcelModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        // ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖŸÜÿ≥ŸàÿÆÿ© ŸÖŸÜ Excel
        async function processExcelPaste() {
            const textarea = document.getElementById('excelPasteData');
            if (!textarea) return;

            const pastedData = textarea.value.trim();
            if (!pastedData) {
                alert('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÑÿµŸÇ');
                return;
            }

            // ÿ™ŸÇÿ≥ŸäŸÖ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ•ŸÑŸâ ÿµŸÅŸàŸÅ
            const rows = pastedData.split(/\r?\n/).filter(row => row.trim());
            if (rows.length === 0) {
                alert('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ÿµÿ≠Ÿäÿ≠ÿ©');
                return;
            }

            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿµŸÅ ÿßŸÑÿ£ŸàŸÑ - ÿ•ÿ∞ÿß ŸÉÿßŸÜ Ÿäÿ≠ÿ™ŸàŸä ÿπŸÑŸâ ÿπŸÜÿßŸàŸäŸÜÿå ŸÜÿ™ÿÆÿ∑ÿßŸá
            let startRow = 0;
            const firstRow = rows[0].toLowerCase();
            if (firstRow.includes('ÿßŸÑÿßÿ≥ŸÖ') || firstRow.includes('name') || firstRow.includes('ÿßÿ≥ŸÖ')) {
                startRow = 1;
            }

            // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™ŸÉŸÜ ŸÖÿ≠ŸÖŸÑÿ©
            if (!departmentsData || departmentsData.length === 0) {
                await loadDepartments();
            }

            // ŸÖÿπÿßŸÑÿ¨ÿ© ŸÉŸÑ ÿµŸÅ
            const tbody = document.getElementById('bulkEmployeesTableBody');
            if (!tbody) return;

            let addedRows = 0;
            let skippedRows = 0;

            for (let i = startRow; i < rows.length; i++) {
                const row = rows[i];
                // ÿ™ŸÇÿ≥ŸäŸÖ ÿßŸÑÿµŸÅ ÿ•ŸÑŸâ ÿ£ÿπŸÖÿØÿ© (ŸÖŸÅÿµŸàŸÑÿ© ÿ®ŸÄ Tab ÿ£Ÿà ŸÖÿ≥ÿßŸÅÿßÿ™ ŸÖÿ™ÿπÿØÿØÿ©)
                const columns = row.split(/\t/).map(col => col.trim());
                
                // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿµŸÅ ŸÅÿßÿ±ÿ∫ÿßŸãÿå ŸÜÿ™ÿÆÿ∑ÿßŸá
                if (columns.length === 0 || columns.every(col => !col)) {
                    skippedRows++;
                    continue;
                }

                // ÿ•ÿ∂ÿßŸÅÿ© ÿµŸÅ ÿ¨ÿØŸäÿØ
                await addBulkEmployeeRow();
                const newRow = tbody.querySelector(`tr:last-child`);
                if (!newRow) continue;

                // ÿ™ÿπÿ®ÿ¶ÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä ÿßŸÑÿµŸÅ
                try {
                    // 0: ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ (ŸÖÿ∑ŸÑŸàÿ®)
                    const nameInput = newRow.querySelector('.bulk-emp-name');
                    if (nameInput && columns[0]) {
                        nameInput.value = columns[0];
                    }

                    // 1: ÿßŸÑÿßÿ≥ŸÖ ÿ®ÿßŸÑÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ©
                    const nameEnInput = newRow.querySelector('.bulk-emp-name-en');
                    if (nameEnInput && columns[1]) {
                        nameEnInput.value = columns[1];
                    }

                    // 2: ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä
                    const emailInput = newRow.querySelector('.bulk-emp-email');
                    if (emailInput && columns[2]) {
                        emailInput.value = columns[2];
                    }

                    // 3: ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ
                    const phoneInput = newRow.querySelector('.bulk-emp-phone');
                    if (phoneInput && columns[3]) {
                        phoneInput.value = columns[3];
                    }

                    // 4: ÿßŸÑÿπŸÜŸàÿßŸÜ
                    const addressInput = newRow.querySelector('.bulk-emp-address');
                    if (addressInput && columns[4]) {
                        addressInput.value = columns[4];
                    }

                    // 5: ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿπŸäŸäŸÜ (ÿ™ÿ≠ŸàŸäŸÑ ŸÖŸÜ Excel date format ÿ•ÿ∞ÿß ŸÑÿ≤ŸÖ ÿßŸÑÿ£ŸÖÿ±)
                    const hireDateInput = newRow.querySelector('.bulk-emp-hire-date');
                    if (hireDateInput && columns[5]) {
                        const dateValue = convertExcelDate(columns[5]);
                        if (dateValue) {
                            hireDateInput.value = dateValue;
                        }
                    }

                    // 6: ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ•ÿØÿ±ÿßÿ¨
                    const systemEntryDateInput = newRow.querySelector('.bulk-emp-system-entry-date');
                    if (systemEntryDateInput && columns[6]) {
                        const dateValue = convertExcelDate(columns[6]);
                        if (dateValue) {
                            systemEntryDateInput.value = dateValue;
                        }
                    }

                    // 7: ÿßŸÑŸÖÿ≥ŸÖŸâ ÿßŸÑŸàÿ∏ŸäŸÅŸä
                    const positionInput = newRow.querySelector('.bulk-emp-position');
                    if (positionInput && columns[7]) {
                        positionInput.value = columns[7];
                    }

                    // 8: ÿßŸÑÿ™ÿ≠ÿµŸäŸÑ ÿßŸÑÿØÿ±ÿßÿ≥Ÿä
                    const educationSelect = newRow.querySelector('.bulk-emp-education');
                    if (educationSelect && columns[8]) {
                        const educationValue = mapEducation(columns[8]);
                        if (educationValue) {
                            educationSelect.value = educationValue;
                        }
                    }

                    // 9: ÿßŸÑÿßÿÆÿ™ÿµÿßÿµ
                    const specializationInput = newRow.querySelector('.bulk-emp-specialization');
                    if (specializationInput && columns[9]) {
                        specializationInput.value = columns[9];
                    }

                    // 10: ÿßŸÑÿ≠ÿßŸÑÿ©
                    const statusSelect = newRow.querySelector('.bulk-emp-status');
                    if (statusSelect && columns[10]) {
                        const statusValue = mapStatus(columns[10]);
                        if (statusValue) {
                            statusSelect.value = statusValue;
                        }
                    }

                    // 11: ÿ±ŸÖÿ≤ ÿßŸÑÿ±ÿßÿ™ÿ®
                    const salaryCodeInput = newRow.querySelector('.bulk-emp-salary-code');
                    if (salaryCodeInput && columns[11]) {
                        salaryCodeInput.value = columns[11];
                    }

                    // 12: ÿßŸÑŸÇÿ≥ŸÖ (ÿßŸÑÿ®ÿ≠ÿ´ ÿ®ÿßŸÑÿßÿ≥ŸÖ)
                    const departmentSelect = newRow.querySelector('.bulk-emp-department');
                    if (departmentSelect && columns[12]) {
                        const deptName = columns[12].trim();
                        if (deptName && departmentsData) {
                            const dept = departmentsData.find(d => 
                                d.name === deptName || 
                                d.nameEn === deptName ||
                                d.name?.toLowerCase() === deptName.toLowerCase() ||
                                d.nameEn?.toLowerCase() === deptName.toLowerCase()
                            );
                            if (dept) {
                                departmentSelect.value = dept.id;
                            }
                        }
                    }

                    // 13: ÿ•ÿ¨ÿßÿ≤ÿ© ÿ¥Ÿáÿ±Ÿäÿ©
                    const monthlyLeaveInput = newRow.querySelector('.bulk-emp-monthly-leave');
                    if (monthlyLeaveInput && columns[13]) {
                        const value = parseFloat(columns[13]);
                        if (!isNaN(value)) {
                            monthlyLeaveInput.value = value;
                        }
                    }

                    // 14: ÿ•ÿ¨ÿßÿ≤ÿ© ÿ≤ŸÖŸÜŸäÿ©
                    const hourlyLeaveInput = newRow.querySelector('.bulk-emp-hourly-leave');
                    if (hourlyLeaveInput && columns[14]) {
                        const value = parseFloat(columns[14]);
                        if (!isNaN(value)) {
                            hourlyLeaveInput.value = value;
                        }
                    }

                    // 15: ÿßŸÑÿ±ÿµŸäÿØ ÿßŸÑÿßÿ®ÿ™ÿØÿßÿ¶Ÿä
                    const initialBalanceInput = newRow.querySelector('.bulk-emp-initial-balance');
                    if (initialBalanceInput && columns[15]) {
                        const value = parseFloat(columns[15]);
                        if (!isNaN(value)) {
                            initialBalanceInput.value = value;
                        }
                    }

                    addedRows++;
                } catch (error) {
                    console.error('ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿµŸÅ:', error);
                    skippedRows++;
                }
            }

            updateBulkEmployeesCount();
            hidePasteFromExcelDialog();

            let message = `‚úÖ ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ${addedRows} ÿµŸÅ ÿ®ŸÜÿ¨ÿßÿ≠`;
            if (skippedRows > 0) {
                message += `\n‚ö†Ô∏è ÿ™ŸÖ ÿ™ÿÆÿ∑Ÿä ${skippedRows} ÿµŸÅ (ŸÅÿßÿ±ÿ∫ ÿ£Ÿà ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠)`;
            }
            alert(message);
        }

        // ÿ™ÿ≠ŸàŸäŸÑ ÿ™ÿßÿ±ŸäÿÆ Excel ÿ•ŸÑŸâ ÿµŸäÿ∫ÿ© YYYY-MM-DD
        function convertExcelDate(excelDate) {
            if (!excelDate) return null;

            // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿ®ÿµŸäÿ∫ÿ© Excel (ÿ±ŸÇŸÖ)
            if (!isNaN(excelDate)) {
                // Excel Ÿäÿ≠ÿ≥ÿ® ÿßŸÑÿ£ŸäÿßŸÖ ŸÖŸÜ 1 ŸäŸÜÿßŸäÿ± 1900
                const excelEpoch = new Date(1900, 0, 1);
                const days = parseInt(excelDate) - 2; // Excel Ÿäÿ®ÿØÿ£ ŸÖŸÜ 1 ŸäŸÜÿßŸäÿ± 1900ÿå ŸÑŸÉŸÜŸá Ÿäÿπÿ™ÿ®ÿ± 1900 ÿ≥ŸÜÿ© ŸÉÿ®Ÿäÿ≥ÿ©
                const date = new Date(excelEpoch);
                date.setDate(date.getDate() + days);
                return date.toISOString().split('T')[0];
            }

            // ŸÖÿ≠ÿßŸàŸÑÿ© ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿ®ÿµŸäÿ∫ ŸÖÿÆÿ™ŸÑŸÅÿ©
            const dateFormats = [
                /^\d{4}-\d{2}-\d{2}$/, // YYYY-MM-DD
                /^\d{2}\/\d{2}\/\d{4}$/, // MM/DD/YYYY
                /^\d{2}\/\d{2}\/\d{2}$/, // MM/DD/YY
                /^\d{2}-\d{2}-\d{4}$/, // DD-MM-YYYY
            ];

            for (const format of dateFormats) {
                if (format.test(excelDate)) {
                    try {
                        const date = new Date(excelDate);
                        if (!isNaN(date.getTime())) {
                            return date.toISOString().split('T')[0];
                        }
                    } catch (e) {
                        // continue
                    }
                }
            }

            return null;
        }

        // ÿ™ÿ≠ŸàŸäŸÑ ŸÜÿµ ÿßŸÑÿ™ÿ≠ÿµŸäŸÑ ÿßŸÑÿØÿ±ÿßÿ≥Ÿä ÿ•ŸÑŸâ ŸÇŸäŸÖÿ©
        function mapEducation(educationText) {
            if (!educationText) return '';
            const text = educationText.toLowerCase().trim();
            const mapping = {
                'ÿßÿ®ÿ™ÿØÿßÿ¶Ÿä': 'elementary',
                'elementary': 'elementary',
                'ŸÖÿ™Ÿàÿ≥ÿ∑': 'middle',
                'middle': 'middle',
                'ÿ´ÿßŸÜŸàŸä': 'high_school',
                'high school': 'high_school',
                'high_school': 'high_school',
                'ÿØÿ®ŸÑŸàŸÖ': 'diploma',
                'diploma': 'diploma',
                'ÿ®ŸÉÿßŸÑŸàÿ±ŸäŸàÿ≥': 'bachelor',
                'bachelor': 'bachelor',
                'ŸÖÿßÿ¨ÿ≥ÿ™Ÿäÿ±': 'master',
                'master': 'master',
                'ÿØŸÉÿ™Ÿàÿ±ÿßŸá': 'phd',
                'phd': 'phd',
                'ph.d': 'phd',
                'ÿ£ÿÆÿ±Ÿâ': 'other',
                'other': 'other'
            };
            return mapping[text] || '';
        }

        // ÿ™ÿ≠ŸàŸäŸÑ ŸÜÿµ ÿßŸÑÿ≠ÿßŸÑÿ© ÿ•ŸÑŸâ ŸÇŸäŸÖÿ©
        function mapStatus(statusText) {
            if (!statusText) return 'active';
            const text = statusText.toLowerCase().trim();
            const mapping = {
                'ŸÜÿ¥ÿ∑': 'active',
                'active': 'active',
                'ÿ∫Ÿäÿ± ŸÜÿ¥ÿ∑': 'inactive',
                'inactive': 'inactive',
                'ŸÅŸä ÿ•ÿ¨ÿßÿ≤ÿ©': 'on-leave',
                'on-leave': 'on-leave',
                'on leave': 'on-leave',
                'ŸÖŸÜÿ™ŸáŸä ÿßŸÑÿÆÿØŸÖÿ©': 'terminated',
                'terminated': 'terminated'
            };
            return mapping[text] || 'active';
        }

        // ÿ≠ŸÅÿ∏ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ
        async function saveBulkEmployees() {
            if (!window.db || !window.firestore) {
                alert('Firebase ÿ∫Ÿäÿ± ŸÖŸáŸäÿ£');
                return;
            }

            const tbody = document.getElementById('bulkEmployeesTableBody');
            if (!tbody) return;

            const rows = tbody.querySelectorAll('tr');
            if (rows.length === 0) {
                alert('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÑÿ•ÿ∂ÿßŸÅÿ™Ÿáÿß');
                return;
            }

            const employeesToAdd = [];
            const errors = [];

            // ÿ¨ŸÖÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ÿ¨ŸÖŸäÿπ ÿßŸÑÿµŸÅŸàŸÅ
            rows.forEach((row, index) => {
                const name = row.querySelector('.bulk-emp-name')?.value.trim();
                if (!name) {
                    errors.push(`ÿßŸÑÿµŸÅ ${index + 1}: ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ ŸÖÿ∑ŸÑŸàÿ®`);
                    return;
                }

                const employeeData = {
                    employeeNumber: row.querySelector('.bulk-emp-number')?.value || generateNextEmployeeNumber(),
                    name: name,
                    nameEn: row.querySelector('.bulk-emp-name-en')?.value.trim() || '',
                    email: row.querySelector('.bulk-emp-email')?.value.trim() || '',
                    phone: row.querySelector('.bulk-emp-phone')?.value.trim() || '',
                    address: row.querySelector('.bulk-emp-address')?.value.trim() || '',
                    hireDate: row.querySelector('.bulk-emp-hire-date')?.value || null,
                    systemEntryDate: row.querySelector('.bulk-emp-system-entry-date')?.value || null,
                    position: row.querySelector('.bulk-emp-position')?.value.trim() || '',
                    education: row.querySelector('.bulk-emp-education')?.value || '',
                    specialization: row.querySelector('.bulk-emp-specialization')?.value.trim() || '',
                    status: row.querySelector('.bulk-emp-status')?.value || 'active',
                    salaryCode: row.querySelector('.bulk-emp-salary-code')?.value.trim() || '',
                    departmentId: row.querySelector('.bulk-emp-department')?.value || null,
                    monthlyLeaveDays: parseFloat(row.querySelector('.bulk-emp-monthly-leave')?.value) || 2.5,
                    hourlyLeaveHours: parseFloat(row.querySelector('.bulk-emp-hourly-leave')?.value) || 8,
                    initialLeaveBalance: parseFloat(row.querySelector('.bulk-emp-initial-balance')?.value) || 0,
                    contacts: [],
                    projectsHistory: [],
                    penalties: [],
                    rewards: [],
                    evaluations: [],
                    createdAt: window.firestore.serverTimestamp(),
                    createdBy: currentUser?.uid || 'system'
                };

                employeesToAdd.push(employeeData);
            });

            if (errors.length > 0) {
                alert('ÿßŸÑÿ£ÿÆÿ∑ÿßÿ° ÿßŸÑÿ™ÿßŸÑŸäÿ©:\n' + errors.join('\n'));
                return;
            }

            if (employeesToAdd.length === 0) {
                alert('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ÿµÿ≠Ÿäÿ≠ÿ© ŸÑÿ•ÿ∂ÿßŸÅÿ™Ÿáÿß');
                return;
            }

            // ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ≠ŸÅÿ∏
            if (!confirm(`ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ•ÿ∂ÿßŸÅÿ© ${employeesToAdd.length} ŸÖŸàÿ∏ŸÅÿü`)) {
                return;
            }

            try {
                let successCount = 0;
                let errorCount = 0;

                // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ Ÿàÿßÿ≠ÿØÿßŸã ÿ™ŸÑŸà ÿßŸÑÿ¢ÿÆÿ±
                for (let i = 0; i < employeesToAdd.length; i++) {
                    try {
                        const docRef = await window.firestore.addDoc(
                            window.firestore.collection(window.db, 'employees'),
                            employeesToAdd[i]
                        );

                        // ÿ™ÿ≥ÿ¨ŸäŸÑ ŸÅŸä ÿ≥ÿ¨ŸÑ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™
                        await logAudit('employee', 'create', {
                            employeeId: docRef.id,
                            employeeNumber: employeesToAdd[i].employeeNumber,
                            employeeName: employeesToAdd[i].name
                        });

                        successCount++;
                    } catch (error) {
                        console.error(`ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸàÿ∏ŸÅ ${i + 1}:`, error);
                        errorCount++;
                    }
                }

                if (successCount > 0) {
                    alert(`‚úÖ ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ${successCount} ŸÖŸàÿ∏ŸÅ ÿ®ŸÜÿ¨ÿßÿ≠${errorCount > 0 ? `\n‚ùå ŸÅÿ¥ŸÑ ÿ•ÿ∂ÿßŸÅÿ© ${errorCount} ŸÖŸàÿ∏ŸÅ` : ''}`);
                    hideBulkAddEmployeesForm();
                    await loadEmployees();
                    await loadDashboardStats();
                } else {
                    alert('‚ùå ŸÅÿ¥ŸÑ ÿ•ÿ∂ÿßŸÅÿ© ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ');
                }
            } catch (error) {
                alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ: ' + error.message);
                console.error(error);
            }
        }

        // ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸàÿ∏ŸÅ
        async function addEmployee() {
            if (editingEmployeeId) {
                updateEmployee();
                return;
            }

            if (!window.db || !window.firestore) {
                alert('Firebase ÿ∫Ÿäÿ± ŸÖŸáŸäÿ£');
                return;
            }

            const employeeData = {
                employeeNumber: document.getElementById('empNumberDisplay').textContent.trim(),
                name: document.getElementById('empName').value.trim(),
                nameEn: document.getElementById('empNameEn').value.trim(),
                email: document.getElementById('empEmail').value.trim(),
                phone: document.getElementById('empPhone').value.trim(),
                address: document.getElementById('empAddress').value.trim(),
                workLocationId: document.getElementById('empWorkLocation').value || null,
                hireDate: document.getElementById('empHireDate').value,
                position: document.getElementById('empPosition').value.trim(),
                education: document.getElementById('empEducation').value || '',
                specialization: document.getElementById('empSpecialization').value.trim(),
                status: document.getElementById('empStatus').value || 'active',
                salaryCode: document.getElementById('empSalaryCode').value.trim(),
                replacementId: document.getElementById('empReplacement').value || null,
                departmentId: document.getElementById('empDepartment').value || null,
                systemEntryDate: document.getElementById('empSystemEntryDate').value || null,
                initialLeaveBalance: parseFloat(document.getElementById('empInitialLeaveBalance').value) || 0,
                monthlyLeaveDays: parseFloat(document.getElementById('empMonthlyLeaveDays').value) || 2.5,
                hourlyLeaveHours: parseFloat(document.getElementById('empHourlyLeaveHours').value) || 8,
                initialSalary: document.getElementById('empInitialSalary').value && document.getElementById('empInitialSalary').type === 'number' ? parseFloat(document.getElementById('empInitialSalary').value) : null,
                initialSalaryCurrency: document.getElementById('empInitialSalaryCurrency') ? document.getElementById('empInitialSalaryCurrency').value : 'IQD',
                currentSalary: document.getElementById('empCurrentSalary').value && document.getElementById('empCurrentSalary').type === 'number' ? parseFloat(document.getElementById('empCurrentSalary').value) : null,
                currentSalaryCurrency: document.getElementById('empCurrentSalaryCurrency') ? document.getElementById('empCurrentSalaryCurrency').value : 'IQD',
                contacts: employeeContacts,
                projectsHistory: employeeProjectsHistory,
                penalties: employeePenalties,
                rewards: employeeRewards,
                evaluations: employeeEvaluations,
                createdAt: window.firestore.serverTimestamp(),
                createdBy: currentUser?.uid || 'system'
            };

            if (!employeeData.name) {
                alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖŸàÿ∏ŸÅ');
                return;
            }

            try {
                // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸàÿ∏ŸÅ ÿ£ŸàŸÑÿßŸã ŸÑŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ID
                const docRef = await window.firestore.addDoc(
                    window.firestore.collection(window.db, 'employees'),
                    employeeData
                );
                const employeeId = docRef.id;

                // ÿ±ŸÅÿπ ÿßŸÑÿµŸàÿ±ÿ©
                if (employeePhotoFile) {
                    const photoURL = await uploadEmployeePhoto(employeeId);
                    if (photoURL) {
                        await window.firestore.updateDoc(
                            window.firestore.doc(window.db, 'employees', employeeId),
                            { photoURL: photoURL }
                        );
                    }
                }

                // ÿ±ŸÅÿπ ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØÿßÿ™
                if (employeeDocumentsToUpload.length > 0) {
                    const uploadedDocs = await uploadEmployeeDocuments(employeeId);
                    if (uploadedDocs.length > 0) {
                        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿßŸÑŸÜŸáÿßÿ¶Ÿä ŸÖŸÜ ÿßŸÑÿ≠ÿ¨ŸÖ ÿßŸÑŸÉŸÑŸä ŸÇÿ®ŸÑ ÿßŸÑÿ≠ŸÅÿ∏
                        let finalDocs = uploadedDocs;
                        let totalSize = uploadedDocs.reduce((sum, doc) => {
                            return sum + new Blob([doc.data]).size;
                        }, 0);
                        
                        const totalSizeMB = (totalSize / (1024 * 1024)).toFixed(2);
                        
                        // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿ≠ÿ¨ŸÖ Ÿäÿ™ÿ¨ÿßŸàÿ≤ 1 MBÿå ŸÜÿ≠ÿßŸàŸÑ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑÿ£ŸÉÿ®ÿ± ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã
                        if (totalSize > 1 * 1024 * 1024) {
                            // ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿ≠ÿ≥ÿ® ÿßŸÑÿ≠ÿ¨ŸÖ (ÿßŸÑÿ£ŸÉÿ®ÿ± ÿ£ŸàŸÑÿßŸã)
                            const sortedDocs = [...uploadedDocs].sort((a, b) => {
                                const sizeA = new Blob([a.data]).size;
                                const sizeB = new Blob([b.data]).size;
                                return sizeB - sizeA;
                            });
                            
                            // ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑÿ£ŸÉÿ®ÿ± ÿ≠ÿ™Ÿâ Ÿäÿµÿ®ÿ≠ ÿßŸÑÿ≠ÿ¨ŸÖ ÿ£ŸÇŸÑ ŸÖŸÜ 1 MB
                            let removedCount = 0;
                            while (totalSize > 1 * 1024 * 1024 && sortedDocs.length > 0) {
                                const largestDoc = sortedDocs.shift();
                                const docSize = new Blob([largestDoc.data]).size;
                                totalSize -= docSize;
                                removedCount++;
                            }
                            
                            if (removedCount > 0) {
                                const confirmed = confirm(`‚ö†Ô∏è ÿ•ÿ¨ŸÖÿßŸÑŸä ÿ≠ÿ¨ŸÖ ÿßŸÑŸÖŸÑŸÅÿßÿ™ (${totalSizeMB} MB) Ÿäÿ™ÿ¨ÿßŸàÿ≤ ÿ≠ÿØ Firestore (1 MB)\n\nÿ≥Ÿäÿ™ŸÖ ÿ≠ÿ∞ŸÅ ${removedCount} ŸÖŸÑŸÅ ŸÉÿ®Ÿäÿ± ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã.\n\nŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©ÿü`);
                                if (!confirmed) {
                                    alert('ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿπŸÖŸÑŸäÿ©. ŸÑŸÜ Ÿäÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÑŸÅÿßÿ™.');
                                    throw new Error('ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿπŸÖŸÑŸäÿ© ŸÖŸÜ ŸÇÿ®ŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ');
                                }
                                
                                finalDocs = sortedDocs;
                                alert(`‚úÖ ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ${removedCount} ŸÖŸÑŸÅ ŸÉÿ®Ÿäÿ± ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã.\n\nÿ≥Ÿäÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ© ÿßŸÑÿ¢ŸÜ.`);
                            } else {
                                alert(`‚ö†Ô∏è ÿÆÿ∑ÿ£: ÿ•ÿ¨ŸÖÿßŸÑŸä ÿ≠ÿ¨ŸÖ ÿßŸÑŸÖŸÑŸÅÿßÿ™ (${totalSizeMB} MB) Ÿäÿ™ÿ¨ÿßŸàÿ≤ ÿ≠ÿØ Firestore (1 MB)\n\nŸÑŸÜ Ÿäÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÑŸÅÿßÿ™.\n\nÿßŸÑÿ±ÿ¨ÿßÿ° ÿ™ŸÇŸÑŸäŸÑ ÿπÿØÿØ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿ£Ÿà ÿ≠ÿ¨ŸÖŸáÿß.`);
                                throw new Error(`ÿ≠ÿ¨ŸÖ ÿßŸÑŸÖŸÑŸÅÿßÿ™ (${totalSizeMB} MB) Ÿäÿ™ÿ¨ÿßŸàÿ≤ ÿ≠ÿØ Firestore (1 MB)`);
                            }
                        }
                        
                        await window.firestore.updateDoc(
                            window.firestore.doc(window.db, 'employees', employeeId),
                            { documents: finalDocs }
                        );
                    }
                }

                // ÿ™ÿ≥ÿ¨ŸäŸÑ ŸÅŸä ÿ≥ÿ¨ŸÑ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™
                await logAudit('employee', 'create', {
                    employeeId: employeeId,
                    employeeNumber: employeeData.employeeNumber,
                    employeeName: employeeData.name
                });

                alert('ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸàÿ∏ŸÅ ÿ®ŸÜÿ¨ÿßÿ≠!');
                hideAddEmployeeForm();
                await loadEmployees();
                await loadDashboardStats();
            } catch (error) {
                alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸàÿ∏ŸÅ: ' + error.message);
                console.error(error);
            }
        }

        // ÿ™ÿπÿØŸäŸÑ ŸÖŸàÿ∏ŸÅ
        async function editEmployee(id) {
            editingEmployeeId = id;
            const emp = employeesData.find(e => e.id === id);
            if (!emp) {
                alert('ÿßŸÑŸÖŸàÿ∏ŸÅ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ');
                return;
            }

            const modal = document.getElementById('employeeModal');
            if (!modal) return;

            // ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ™ÿ±ÿ¨ŸÖÿßÿ™ ŸÇÿ®ŸÑ ŸÅÿ™ÿ≠ ÿßŸÑŸÜÿßŸÅÿ∞ÿ©
            applyTranslations();
            document.getElementById('employeeSubmitBtn').setAttribute('onclick', 'updateEmployee()');

            document.getElementById('empNumberDisplay').textContent = emp.employeeNumber || 'EMP-001';
            document.getElementById('empName').value = emp.name || '';
            document.getElementById('empNameEn').value = emp.nameEn || '';
            document.getElementById('empEmail').value = emp.email || '';
            document.getElementById('empPhone').value = emp.phone || '';
            document.getElementById('empAddress').value = emp.address || '';
            document.getElementById('empHireDate').value = emp.hireDate || '';
            document.getElementById('empSystemEntryDate').value = emp.systemEntryDate || '';
            document.getElementById('empPosition').value = emp.position || '';
            document.getElementById('empEducation').value = emp.education || '';
            document.getElementById('empSpecialization').value = emp.specialization || '';
            document.getElementById('empStatus').value = emp.status || 'active';
            document.getElementById('empSalaryCode').value = emp.salaryCode || '';
            document.getElementById('empReplacement').value = emp.replacementId || '';
            
            // ÿ™ÿ≠ÿØŸäÿ´ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ÿ´ŸÖ ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÇÿ≥ŸÖ ÿßŸÑŸÖÿ≠ÿØÿØ
            await updateDepartmentSelect();
            document.getElementById('empDepartment').value = emp.departmentId || '';
            
            // ÿ™ÿ≠ÿØŸäÿ´ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ ÿ´ŸÖ ÿ™ÿπŸäŸäŸÜ ŸÖŸÉÿßŸÜ ÿßŸÑÿπŸÖŸÑ ÿßŸÑŸÖÿ≠ÿØÿØ
            await updateWorkLocationSelect();
            document.getElementById('empWorkLocation').value = emp.workLocationId || '';
            
            document.getElementById('empMonthlyLeaveDays').value = emp.monthlyLeaveDays || 2.5;
            document.getElementById('empHourlyLeaveHours').value = emp.hourlyLeaveHours || 8;
            document.getElementById('empInitialLeaveBalance').value = emp.initialLeaveBalance || 0;
            
            // ÿ™ÿπÿ®ÿ¶ÿ© ÿßŸÑÿ±ÿßÿ™ÿ® (ŸÖÿ≠ŸÖŸä)
            const initialSalaryField = document.getElementById('empInitialSalary');
            const currentSalaryField = document.getElementById('empCurrentSalary');
            const initialSalaryCurrency = document.getElementById('empInitialSalaryCurrency');
            const currentSalaryCurrency = document.getElementById('empCurrentSalaryCurrency');
            
            if (initialSalaryField) {
                initialSalaryField.type = 'password';
                initialSalaryField.value = emp.initialSalary ? '****' : '';
                initialSalaryField.readOnly = true;
                initialSalaryField.setAttribute('data-salary-value', emp.initialSalary || '');
            }
            
            if (currentSalaryField) {
                currentSalaryField.type = 'password';
                currentSalaryField.value = emp.currentSalary ? '****' : '';
                currentSalaryField.readOnly = true;
                currentSalaryField.setAttribute('data-salary-value', emp.currentSalary || '');
            }
            
            if (initialSalaryCurrency) {
                initialSalaryCurrency.value = emp.initialSalaryCurrency || 'IQD';
                initialSalaryCurrency.disabled = true;
            }
            
            if (currentSalaryCurrency) {
                currentSalaryCurrency.value = emp.currentSalaryCurrency || 'IQD';
                currentSalaryCurrency.disabled = true;
            }

            // ÿ™ÿ≠ÿØŸäÿ´ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ ÿßŸÑÿ®ÿØŸäŸÑŸäŸÜ
            updateReplacementSelect(editingEmployeeId);

            // ÿπÿ±ÿ∂ ÿ¨Ÿáÿßÿ™ ÿßŸÑÿßÿ™ÿµÿßŸÑ
            employeeContacts = emp.contacts || [];
            displayContacts();

            // ÿπÿ±ÿ∂ ÿßŸÑÿπŸÇŸàÿ®ÿßÿ™ ŸàÿßŸÑŸÖŸÉÿßŸÅÿ¢ÿ™
            employeePenalties = emp.penalties || [];
            employeeRewards = emp.rewards || [];
            employeeEvaluations = emp.evaluations || [];
            editingEvaluationId = null;
            window.evaluationViewUnlocked = false; // ÿ•ÿπÿßÿØÿ© ŸÇŸÅŸÑ ÿßŸÑÿ™ŸÇŸäŸäŸÖÿßÿ™ ÿπŸÜÿØ ŸÅÿ™ÿ≠ ÿ®ÿ∑ÿßŸÇÿ© ŸÖŸàÿ∏ŸÅ ÿ¨ÿØŸäÿØ
            displayPenalties();
            displayRewards();
            
            // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ŸÇŸäŸäŸÖÿßÿ™
            const evaluationsList = document.getElementById('evaluationsList');
            const lockedMessage = document.getElementById('evaluationsLockedMessage');
            const addBtn = document.getElementById('addEvaluationBtn');
            const lockIcon = document.getElementById('evaluationLockIcon');
            
            if (evaluationsList) evaluationsList.style.display = 'none';
            if (lockedMessage) lockedMessage.style.display = 'block';
            if (addBtn) addBtn.style.display = 'none';
            if (lockIcon) {
                lockIcon.textContent = 'üîí';
                lockIcon.title = 'ÿßŸÜŸÇÿ± ŸÑÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿ™ŸÇŸäŸäŸÖÿßÿ™';
            }

            // ÿπÿ±ÿ∂ ÿ≥ÿ¨ŸÑ ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ
            employeeProjectsHistory = emp.projectsHistory || [];
            displayProjectsHistory();

            // ÿπÿ±ÿ∂ ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑŸÖŸàÿ¨ŸàÿØÿ©
            if (emp.photoURL) {
                document.getElementById('employeePhotoPreview').src = emp.photoURL;
            } else {
                removeEmployeePhoto();
            }

            // ÿπÿ±ÿ∂ ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØÿßÿ™ ÿßŸÑŸÖŸàÿ¨ŸàÿØÿ©
            displayExistingDocuments(emp.documents || []);

            modal.classList.add('active');
        }

        // ÿπÿ±ÿ∂ ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØÿßÿ™ ÿßŸÑŸÖŸàÿ¨ŸàÿØÿ©
        function displayExistingDocuments(documents) {
            const documentsList = document.getElementById('employeeDocumentsList');
            documentsList.innerHTML = '';
            
            if (!documents || documents.length === 0) {
                return;
            }

            documents.forEach((doc, index) => {
                const docCard = document.createElement('div');
                docCard.id = `existingDoc_${index}`;
                docCard.className = 'document-card';
                docCard.style.cssText = 'border: 2px solid #e9ecef; border-radius: 8px; padding: 15px; background: #f8f9fa; position: relative;';
                
                const fileName = doc.name && doc.name.length > 20 ? doc.name.substring(0, 20) + '...' : (doc.name || 'ŸÖÿ≥ÿ™ŸÜÿØ');
                const fileSize = doc.size ? (doc.size / 1024).toFixed(2) + ' KB' : '';
                
                docCard.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 24px;">üìé</span>
                        <div style="flex: 1;">
                            <div style="font-weight: bold; color: #333;">${fileName}</div>
                            <div style="font-size: 12px; color: #666;">${fileSize}</div>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <a href="${doc.data || doc.url}" target="_blank" style="background: #667eea; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer; text-decoration: none; font-size: 12px;">ÿπÿ±ÿ∂</a>
                            <button onclick="markDocumentForDeletion('${index}', '${doc.data || doc.url}')" style="background: #dc3545; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer; font-size: 12px;">ÿ≠ÿ∞ŸÅ</button>
                        </div>
                    </div>
                `;
                
                documentsList.appendChild(docCard);
            });
        }

        // ÿ™ÿ≠ÿØŸäÿØ ŸÖÿ≥ÿ™ŸÜÿØ ŸÑŸÑÿ≠ÿ∞ŸÅ
        function markDocumentForDeletion(index, url) {
            if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØÿü')) return;
            
            employeeDocumentsToDelete.push(url);
            const docCard = document.getElementById(`existingDoc_${index}`);
            if (docCard) {
                docCard.style.opacity = '0.5';
                docCard.style.textDecoration = 'line-through';
            }
        }

        // ÿ™ÿ≠ÿØŸäÿ´ ŸÖŸàÿ∏ŸÅ
        async function updateEmployee() {
            if (!editingEmployeeId) return;

            if (!window.db || !window.firestore) {
                alert('Firebase ÿ∫Ÿäÿ± ŸÖŸáŸäÿ£');
                return;
            }

            const employeeData = {
                name: document.getElementById('empName').value.trim(),
                nameEn: document.getElementById('empNameEn').value.trim(),
                employeeNumber: document.getElementById('empNumberDisplay').textContent.trim(),
                email: document.getElementById('empEmail').value.trim(),
                phone: document.getElementById('empPhone').value.trim(),
                address: document.getElementById('empAddress').value.trim(),
                workLocationId: document.getElementById('empWorkLocation').value || null,
                hireDate: document.getElementById('empHireDate').value,
                position: document.getElementById('empPosition').value.trim(),
                education: document.getElementById('empEducation').value || '',
                specialization: document.getElementById('empSpecialization').value.trim(),
                status: document.getElementById('empStatus').value || 'active',
                salaryCode: document.getElementById('empSalaryCode').value.trim(),
                replacementId: document.getElementById('empReplacement').value || null,
                departmentId: document.getElementById('empDepartment').value || null,
                systemEntryDate: document.getElementById('empSystemEntryDate').value || null,
                initialLeaveBalance: parseFloat(document.getElementById('empInitialLeaveBalance').value) || 0,
                monthlyLeaveDays: parseFloat(document.getElementById('empMonthlyLeaveDays').value) || 2.5,
                hourlyLeaveHours: parseFloat(document.getElementById('empHourlyLeaveHours').value) || 8,
                initialSalary: document.getElementById('empInitialSalary').value && document.getElementById('empInitialSalary').type === 'number' ? parseFloat(document.getElementById('empInitialSalary').value) : null,
                initialSalaryCurrency: document.getElementById('empInitialSalaryCurrency') ? document.getElementById('empInitialSalaryCurrency').value : 'IQD',
                currentSalary: document.getElementById('empCurrentSalary').value && document.getElementById('empCurrentSalary').type === 'number' ? parseFloat(document.getElementById('empCurrentSalary').value) : null,
                currentSalaryCurrency: document.getElementById('empCurrentSalaryCurrency') ? document.getElementById('empCurrentSalaryCurrency').value : 'IQD',
                contacts: employeeContacts,
                projectsHistory: employeeProjectsHistory,
                penalties: employeePenalties,
                rewards: employeeRewards,
                evaluations: employeeEvaluations,
                updatedAt: window.firestore.serverTimestamp(),
                updatedBy: currentUser?.uid || 'system'
            };

            if (!employeeData.name) {
                alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖŸàÿ∏ŸÅ');
                return;
            }

            try {
                // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™ ŸÇÿ®ŸÑ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´
                if (!currentUser) {
                    alert('‚ö†Ô∏è Ÿäÿ¨ÿ® ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã');
                    return;
                }

                // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÑÿØŸäŸá ÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ Ÿàÿ•ÿµŸÑÿßÿ≠ role ÿ•ÿ∞ÿß ŸÑÿ≤ŸÖ ÿßŸÑÿ£ŸÖÿ±
                console.log('üîç ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ...');
                console.log('üë§ User ID:', currentUser.uid);
                console.log('üìß Email:', currentUser.email);
                
                try {
                    const userDoc = await window.firestore.getDoc(
                        window.firestore.doc(window.db, 'users', currentUser.uid)
                    );
                    
                    console.log('üìÑ User document exists:', userDoc.exists());
                    
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        let userRole = userData.role;
                        
                        console.log('üìã User data:', userData);
                        console.log('üé≠ Current role:', userRole);
                        
                        // ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ roleÿå ŸÜÿ∂ŸäŸÅ role 'admin' ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã (ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ£ŸàŸÑ)
                        if (!userRole) {
                            console.log('‚ö†Ô∏è ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÑŸäÿ≥ ŸÑÿØŸäŸá role - ÿ¨ÿßÿ±Ÿä ÿ•ÿ∂ÿßŸÅÿ© role admin...');
                            try {
                                await window.firestore.updateDoc(
                                    window.firestore.doc(window.db, 'users', currentUser.uid),
                                    { 
                                        role: 'admin',
                                        active: true
                                    }
                                );
                                userRole = 'admin';
                                console.log('‚úÖ ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© role admin ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ');
                            } catch (updateError) {
                                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ role ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ:', updateError);
                                console.error('‚ùå Error details:', updateError.code, updateError.message);
                                // ŸÜÿ™ÿßÿ®ÿπ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ÿπŸÑŸâ ÿ£Ÿä ÿ≠ÿßŸÑ
                            }
                        }
                        
                        console.log('üé≠ Final role:', userRole);
                        
                        if (userRole !== 'admin' && userRole !== 'hr') {
                            alert('‚ö†Ô∏è ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ŸÑÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ. Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ŸÉŸàŸÜ ŸÖÿØŸäÿ±ÿßŸã ÿ£Ÿà ŸÖŸÜ ŸÖŸàÿßÿ±ÿØ ÿ®ÿ¥ÿ±Ÿäÿ©.\n\nRole ÿßŸÑÿ≠ÿßŸÑŸä: ' + (userRole || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'));
                            console.error('‚ùå ÿµŸÑÿßÿ≠Ÿäÿ© ÿ∫Ÿäÿ± ŸÉÿßŸÅŸäÿ©. Role:', userRole);
                            return;
                        }
                        
                        console.log('‚úÖ ÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿµÿ≠Ÿäÿ≠ÿ©');
                    } else {
                        // ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ≥ÿ¨ŸÑ ŸÅŸä Firestoreÿå ŸÜŸÜÿ¥ÿ¶Ÿá ŸÖÿπ role 'admin'
                        console.log('‚ö†Ô∏è ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÑŸäÿ≥ ŸÑÿØŸäŸá ÿ≥ÿ¨ŸÑ ŸÅŸä Firestore - ÿ¨ÿßÿ±Ÿä ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ≥ÿ¨ŸÑ ŸÖÿπ role admin...');
                        try {
                            await window.firestore.setDoc(
                                window.firestore.doc(window.db, 'users', currentUser.uid),
                                {
                                    name: currentUser.displayName || currentUser.email?.split('@')[0] || 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ',
                                    email: currentUser.email,
                                    role: 'admin',
                                    status: 'active',
                                    active: true,
                                    createdAt: window.firestore.serverTimestamp(),
                                    createdBy: 'system'
                                }
                            );
                            console.log('‚úÖ ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿ≥ÿ¨ŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖÿπ role admin');
                        } catch (createError) {
                            console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ŸÜÿ¥ÿßÿ° ÿ≥ÿ¨ŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ:', createError);
                            console.error('‚ùå Error details:', createError.code, createError.message);
                            // ŸÜÿ™ÿßÿ®ÿπ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ÿπŸÑŸâ ÿ£Ÿä ÿ≠ÿßŸÑ
                        }
                    }
                } catch (permError) {
                    console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™:', permError);
                    console.error('‚ùå Error details:', permError.code, permError.message);
                    // ŸÜÿ™ÿßÿ®ÿπ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ©
                }
                
                console.log('üìù ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ÿØŸäÿ´ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖŸàÿ∏ŸÅ...');
                console.log('üíæ Employee ID:', editingEmployeeId);
                console.log('üíæ Employee data keys:', Object.keys(employeeData));

                // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÇÿØŸäŸÖÿ© ŸÑŸÑÿ™ÿ≥ÿ¨ŸäŸÑ
                const oldEmployee = employeesData.find(e => e.id === editingEmployeeId);
                
                // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ©
                try {
                    await window.firestore.updateDoc(
                        window.firestore.doc(window.db, 'employees', editingEmployeeId),
                        employeeData
                    );
                    console.log('‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖŸàÿ∏ŸÅ ÿ®ŸÜÿ¨ÿßÿ≠');
                    
                    // ÿ™ÿ≥ÿ¨ŸäŸÑ ŸÅŸä ÿ≥ÿ¨ŸÑ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™
                    await logAudit('employee', 'update', {
                        employeeId: editingEmployeeId,
                        employeeNumber: employeeData.employeeNumber,
                        employeeName: employeeData.name,
                        oldData: oldEmployee,
                        newData: employeeData
                    });
                } catch (updateError) {
                    console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖŸàÿ∏ŸÅ:', updateError);
                    console.error('‚ùå Error code:', updateError.code);
                    console.error('‚ùå Error message:', updateError.message);
                    console.error('‚ùå Full error:', updateError);
                    throw updateError; // ÿ•ÿπÿßÿØÿ© ÿ±ŸÖŸä ÿßŸÑÿÆÿ∑ÿ£ ŸÑŸÑÿ™ÿπÿßŸÖŸÑ ŸÖÿπŸá ŸÅŸä catch ÿßŸÑÿÆÿßÿ±ÿ¨Ÿä
                }

                // ÿ±ŸÅÿπ ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ© ÿ•ŸÜ Ÿàÿ¨ÿØÿ™
                if (employeePhotoFile) {
                    const photoURL = await uploadEmployeePhoto(editingEmployeeId);
                    if (photoURL) {
                        await window.firestore.updateDoc(
                            window.firestore.doc(window.db, 'employees', editingEmployeeId),
                            { photoURL: photoURL }
                        );
                    }
                }

                // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØÿßÿ™ ÿßŸÑÿ≠ÿßŸÑŸäÿ©
                const emp = employeesData.find(e => e.id === editingEmployeeId);
                let currentDocuments = emp?.documents || [];

                // ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØÿßÿ™ ÿßŸÑŸÖÿ≠ÿØÿØÿ© (ÿßŸÑÿ¢ŸÜ ŸÜÿ≠ÿ∞ŸÅŸáÿß ŸÖŸÜ Firestore ŸÖÿ®ÿßÿ¥ÿ±ÿ©)
                if (employeeDocumentsToDelete.length > 0) {
                    // ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØÿßÿ™ ŸÖŸÜ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© (ŸÜÿ≥ÿ™ÿÆÿØŸÖ data ÿ£Ÿà url ŸÑŸÑÿ®ÿ≠ÿ´)
                    currentDocuments = currentDocuments.filter(doc => {
                        // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØ Ÿäÿ≠ÿ™ŸàŸä ÿπŸÑŸâ data (base64) ÿ£Ÿà url
                        const docIdentifier = doc.data || doc.url;
                        return !employeeDocumentsToDelete.includes(docIdentifier);
                    });
                    console.log('‚úÖ ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØÿßÿ™ ŸÖŸÜ ÿßŸÑŸÇÿßÿ¶ŸÖÿ©');
                }

                // ÿ±ŸÅÿπ ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ©
                if (employeeDocumentsToUpload.length > 0) {
                    const uploadedDocs = await uploadEmployeeDocuments(editingEmployeeId);
                    
                    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿßŸÑŸÜŸáÿßÿ¶Ÿä ŸÖŸÜ ÿßŸÑÿ≠ÿ¨ŸÖ ÿßŸÑŸÉŸÑŸä ŸÇÿ®ŸÑ ÿßŸÑÿ≠ŸÅÿ∏
                    let allDocuments = [...currentDocuments, ...uploadedDocs];
                    let totalSize = allDocuments.reduce((sum, doc) => {
                        const docData = doc.data || doc.url || '';
                        return sum + new Blob([docData]).size;
                    }, 0);
                    
                    const totalSizeMB = (totalSize / (1024 * 1024)).toFixed(2);
                    
                    // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿ≠ÿ¨ŸÖ Ÿäÿ™ÿ¨ÿßŸàÿ≤ 1 MBÿå ŸÜÿ≠ÿßŸàŸÑ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑŸÇÿØŸäŸÖÿ© ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã
                    if (totalSize > 1 * 1024 * 1024) {
                        // ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿ≠ÿ≥ÿ® ÿßŸÑÿ™ÿßÿ±ŸäÿÆ (ÿßŸÑÿ£ŸÇÿØŸÖ ÿ£ŸàŸÑÿßŸã)
                        const sortedDocs = allDocuments.sort((a, b) => {
                            const dateA = new Date(a.uploadedAt || 0);
                            const dateB = new Date(b.uploadedAt || 0);
                            return dateA - dateB;
                        });
                        
                        // ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑŸÇÿØŸäŸÖÿ© ÿ≠ÿ™Ÿâ Ÿäÿµÿ®ÿ≠ ÿßŸÑÿ≠ÿ¨ŸÖ ÿ£ŸÇŸÑ ŸÖŸÜ 1 MB
                        let removedCount = 0;
                        while (totalSize > 1 * 1024 * 1024 && sortedDocs.length > 0) {
                            const oldestDoc = sortedDocs.shift();
                            const docSize = new Blob([oldestDoc.data || oldestDoc.url || '']).size;
                            totalSize -= docSize;
                            removedCount++;
                        }
                        
                        if (removedCount > 0) {
                            const confirmed = confirm(`‚ö†Ô∏è ÿ•ÿ¨ŸÖÿßŸÑŸä ÿ≠ÿ¨ŸÖ ÿßŸÑŸÖŸÑŸÅÿßÿ™ (${totalSizeMB} MB) Ÿäÿ™ÿ¨ÿßŸàÿ≤ ÿ≠ÿØ Firestore (1 MB)\n\nÿ≥Ÿäÿ™ŸÖ ÿ≠ÿ∞ŸÅ ${removedCount} ŸÖŸÑŸÅ ŸÇÿØŸäŸÖ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ŸÑŸÅÿ≥ÿ≠ ÿßŸÑŸÖÿ¨ÿßŸÑ ŸÑŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ©.\n\nŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©ÿü`);
                            if (!confirmed) {
                                alert('ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿπŸÖŸÑŸäÿ©. ŸÑŸÜ Ÿäÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ©.');
                                throw new Error('ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿπŸÖŸÑŸäÿ© ŸÖŸÜ ŸÇÿ®ŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ');
                            }
                            
                            allDocuments = sortedDocs;
                            alert(`‚úÖ ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ${removedCount} ŸÖŸÑŸÅ ŸÇÿØŸäŸÖ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã.\n\nÿ≥Ÿäÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ© ÿßŸÑÿ¢ŸÜ.`);
                        } else {
                            alert(`‚ö†Ô∏è ÿÆÿ∑ÿ£: ÿ•ÿ¨ŸÖÿßŸÑŸä ÿ≠ÿ¨ŸÖ ÿßŸÑŸÖŸÑŸÅÿßÿ™ (${totalSizeMB} MB) Ÿäÿ™ÿ¨ÿßŸàÿ≤ ÿ≠ÿØ Firestore (1 MB)\n\nŸÑŸÜ Ÿäÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ©.\n\nÿßŸÑÿ±ÿ¨ÿßÿ° ÿ™ŸÇŸÑŸäŸÑ ÿπÿØÿØ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿ£Ÿà ÿ≠ÿ¨ŸÖŸáÿß.`);
                            throw new Error(`ÿ≠ÿ¨ŸÖ ÿßŸÑŸÖŸÑŸÅÿßÿ™ (${totalSizeMB} MB) Ÿäÿ™ÿ¨ÿßŸàÿ≤ ÿ≠ÿØ Firestore (1 MB)`);
                        }
                    }
                    
                    currentDocuments = allDocuments;
                }

                // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØÿßÿ™
                if (employeeDocumentsToUpload.length > 0 || employeeDocumentsToDelete.length > 0) {
                    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿßŸÑŸÜŸáÿßÿ¶Ÿä ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ ŸÇÿ®ŸÑ ÿßŸÑÿ≠ŸÅÿ∏
                    const finalTotalSize = currentDocuments.reduce((sum, doc) => {
                        const docData = doc.data || doc.url || '';
                        return sum + new Blob([docData]).size;
                    }, 0);
                    
                    if (finalTotalSize > 1 * 1024 * 1024) {
                        const finalSizeMB = (finalTotalSize / (1024 * 1024)).toFixed(2);
                        alert(`‚ö†Ô∏è ÿÆÿ∑ÿ£: ÿ•ÿ¨ŸÖÿßŸÑŸä ÿ≠ÿ¨ŸÖ ÿßŸÑŸÖŸÑŸÅÿßÿ™ (${finalSizeMB} MB) Ÿäÿ™ÿ¨ÿßŸàÿ≤ ÿ≠ÿØ Firestore (1 MB)\n\nŸÑŸÜ Ÿäÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™.\n\nÿßŸÑÿ±ÿ¨ÿßÿ° ÿ≠ÿ∞ŸÅ ÿ®ÿπÿ∂ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿ£Ÿà ÿ™ŸÇŸÑŸäŸÑ ÿ≠ÿ¨ŸÖŸáÿß.`);
                        throw new Error(`ÿ≠ÿ¨ŸÖ ÿßŸÑŸÖŸÑŸÅÿßÿ™ (${finalSizeMB} MB) Ÿäÿ™ÿ¨ÿßŸàÿ≤ ÿ≠ÿØ Firestore (1 MB)`);
                    }
                    
                    await window.firestore.updateDoc(
                        window.firestore.doc(window.db, 'employees', editingEmployeeId),
                        { documents: currentDocuments }
                    );
                }

                alert('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸàÿ∏ŸÅ ÿ®ŸÜÿ¨ÿßÿ≠!');
                hideAddEmployeeForm();
                await loadEmployees();
                await loadDashboardStats();
            } catch (error) {
                alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸàÿ∏ŸÅ: ' + error.message);
                console.error(error);
            }
        }

        // ÿ≠ÿ∞ŸÅ ŸÖŸàÿ∏ŸÅ
        async function deleteEmployee(id) {
            if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑŸÖŸàÿ∏ŸÅÿü')) return;

            if (!window.db || !window.firestore) {
                alert('Firebase ÿ∫Ÿäÿ± ŸÖŸáŸäÿ£');
                return;
            }

            try {
                const employee = employeesData.find(e => e.id === id);
                if (!employee) {
                    alert('ÿßŸÑŸÖŸàÿ∏ŸÅ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ');
                    return;
                }

                await window.firestore.deleteDoc(
                    window.firestore.doc(window.db, 'employees', id)
                );

                // ÿ™ÿ≥ÿ¨ŸäŸÑ ŸÅŸä ÿ≥ÿ¨ŸÑ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™
                await logAudit('employee', 'delete', {
                    employeeId: id,
                    employeeNumber: employee.employeeNumber,
                    employeeName: employee.name
                });

                alert('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸàÿ∏ŸÅ ÿ®ŸÜÿ¨ÿßÿ≠!');
                await loadEmployees();
                await loadDashboardStats();
            } catch (error) {
                alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸàÿ∏ŸÅ: ' + error.message);
                console.error(error);
            }
        }
        
        // ============================================
        // ŸÜÿ∏ÿßŸÖ ÿ≥ÿ¨ŸÑ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™ (Audit Log)
        // ============================================
        async function logAudit(entityType, action, data) {
            try {
                if (!window.db || !window.firestore || !currentUser) {
                    console.warn('‚ö†Ô∏è ŸÑÿß ŸäŸÖŸÉŸÜ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿ™ÿπÿØŸäŸÑ - Firebase ÿ∫Ÿäÿ± ŸÖŸáŸäÿ£ ÿ£Ÿà ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ∫Ÿäÿ± ŸÖÿ≥ÿ¨ŸÑ ÿØÿÆŸàŸÑ');
                    return;
                }

                const auditData = {
                    entityType: entityType, // 'employee', 'evaluation', 'project', etc.
                    action: action, // 'create', 'update', 'delete', 'view'
                    data: data,
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    timestamp: window.firestore.serverTimestamp(),
                    createdAt: new Date().toISOString()
                };

                // ÿ≠ŸÅÿ∏ ŸÅŸä Firestore
                await window.firestore.addDoc(
                    window.firestore.collection(window.db, 'auditLogs'),
                    auditData
                );

                // ÿ≠ŸÅÿ∏ ŸÖÿ≠ŸÑŸäÿßŸã ÿ£Ÿäÿ∂ÿßŸã (ŸÑŸÑÿπÿ±ÿ∂ ÿßŸÑÿ≥ÿ±Ÿäÿπ)
                auditLogs.push({
                    id: 'audit_' + Date.now(),
                    ...auditData,
                    timestamp: new Date().toISOString()
                });

                // ÿßŸÑÿßÿ≠ÿ™ŸÅÿßÿ∏ ÿ®ÿ¢ÿÆÿ± 1000 ÿ≥ÿ¨ŸÑ ŸÖÿ≠ŸÑŸäÿßŸã ŸÅŸÇÿ∑
                if (auditLogs.length > 1000) {
                    auditLogs = auditLogs.slice(-1000);
                }

                console.log('‚úÖ ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿ™ÿπÿØŸäŸÑ:', { entityType, action });
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿ™ÿπÿØŸäŸÑ:', error);
            }
        }
        
        // ============================================
        // ÿØŸàÿßŸÑ ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑÿ™Ÿàÿßÿ±ŸäÿÆ ŸàÿßŸÑÿ£ÿ±ŸÇÿßŸÖ (ÿßŸÑÿ™ŸÇŸàŸäŸÖ ÿßŸÑŸÖŸäŸÑÿßÿØŸä ŸàÿßŸÑÿ£ÿ±ŸÇÿßŸÖ ÿßŸÑÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ© ŸÅŸÇÿ∑)
        // ============================================
        
        /**
         * ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ™ŸÇŸàŸäŸÖ ÿßŸÑŸÖŸäŸÑÿßÿØŸä ŸàÿßŸÑÿ£ÿ±ŸÇÿßŸÖ ÿßŸÑÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ© ŸÅŸÇÿ∑
         * @param {Date|string|number|object} date - ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖÿ±ÿßÿØ ÿ™ŸÜÿ≥ŸäŸÇŸá (ŸäÿØÿπŸÖ Firestore Timestamp ŸÖÿπ .seconds)
         * @param {object} options - ÿÆŸäÿßÿ±ÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ© ŸÑŸÑÿ™ŸÜÿ≥ŸäŸÇ
         * @returns {string} - ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖŸÜÿ≥ŸÇ
         */
        function formatDate(date, options = {}) {
            if (!date) return '';
            
            let dateObj;
            if (date instanceof Date) {
                dateObj = date;
            } else if (date && typeof date === 'object' && date.seconds) {
                dateObj = new Date(date.seconds * 1000);
            } else if (typeof date === 'string') {
                dateObj = new Date(date);
            } else if (typeof date === 'number') {
                dateObj = new Date(date);
            } else {
                dateObj = new Date(date);
            }
            
            if (isNaN(dateObj.getTime())) return '';
            
            // ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿ®ÿµŸäÿ∫ÿ© dd-mm-yyyy
            const day = String(dateObj.getDate()).padStart(2, '0');
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const year = dateObj.getFullYear();
            
            return `${day}-${month}-${year}`;
        }
        
        /**
         * ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ŸàÿßŸÑŸàŸÇÿ™ ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ™ŸÇŸàŸäŸÖ ÿßŸÑŸÖŸäŸÑÿßÿØŸä ŸàÿßŸÑÿ£ÿ±ŸÇÿßŸÖ ÿßŸÑÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ© ŸÅŸÇÿ∑
         * @param {Date|string|number|object} date - ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖÿ±ÿßÿØ ÿ™ŸÜÿ≥ŸäŸÇŸá (ŸäÿØÿπŸÖ Firestore Timestamp ŸÖÿπ .seconds)
         * @param {object} dateOptions - ÿÆŸäÿßÿ±ÿßÿ™ ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ
         * @param {object} timeOptions - ÿÆŸäÿßÿ±ÿßÿ™ ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑŸàŸÇÿ™
         * @returns {string} - ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ŸàÿßŸÑŸàŸÇÿ™ ÿßŸÑŸÖŸÜÿ≥ŸÇŸäŸÜ
         */
        function formatDateTime(date, dateOptions = {}, timeOptions = {}) {
            if (!date) return '';
            
            let dateObj;
            if (date instanceof Date) {
                dateObj = date;
            } else if (date && typeof date === 'object' && date.seconds) {
                dateObj = new Date(date.seconds * 1000);
            } else if (typeof date === 'string') {
                dateObj = new Date(date);
            } else if (typeof date === 'number') {
                dateObj = new Date(date);
            } else {
                dateObj = new Date(date);
            }
            
            if (isNaN(dateObj.getTime())) return '';
            
            // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ en-US ŸÑÿ∂ŸÖÿßŸÜ ÿßŸÑÿ™ŸÇŸàŸäŸÖ ÿßŸÑŸÖŸäŸÑÿßÿØŸä ŸàÿßŸÑÿ£ÿ±ŸÇÿßŸÖ ÿßŸÑÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ©
            return dateObj.toLocaleDateString('en-US', dateOptions) + ' ' + 
                   dateObj.toLocaleTimeString('en-US', timeOptions);
        }
        
        /**
         * ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑÿ£ÿ±ŸÇÿßŸÖ ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ£ÿ±ŸÇÿßŸÖ ÿßŸÑÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ© ŸÅŸÇÿ∑
         * @param {number} number - ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑŸÖÿ±ÿßÿØ ÿ™ŸÜÿ≥ŸäŸÇŸá
         * @param {object} options - ÿÆŸäÿßÿ±ÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ© ŸÑŸÑÿ™ŸÜÿ≥ŸäŸÇ
         * @returns {string} - ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑŸÖŸÜÿ≥ŸÇ
         */
        function formatNumber(number, options = {}) {
            if (number === null || number === undefined) return '0';
            
            // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ en-US ŸÑÿ∂ŸÖÿßŸÜ ÿßŸÑÿ£ÿ±ŸÇÿßŸÖ ÿßŸÑÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ©
            return new Intl.NumberFormat('en-US', options).format(number);
        }
        
        // ÿ™ÿ≠ŸÖŸäŸÑ ÿ≥ÿ¨ŸÑ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™
        async function loadAuditLogs(limit = 100) {
            try {
                if (!window.db || !window.firestore) {
                    console.warn('Firebase ÿ∫Ÿäÿ± ŸÖŸáŸäÿ£');
                    return;
                }

                const auditRef = window.firestore.collection(window.db, 'auditLogs');
                const q = window.firestore.query(
                    auditRef,
                    window.firestore.orderBy('timestamp', 'desc')
                );
                
                const snapshot = await window.firestore.getDocs(q);
                auditLogs = [];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    auditLogs.push({
                        id: doc.id,
                        ...data,
                        timestamp: data.timestamp?.toDate?.()?.toISOString() || data.createdAt || new Date().toISOString()
                    });
                });

                // ÿßŸÑÿßÿ≠ÿ™ŸÅÿßÿ∏ ÿ®ÿ¢ÿÆÿ± limit ÿ≥ÿ¨ŸÑ
                auditLogs = auditLogs.slice(0, limit);
                
                console.log(`‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ${auditLogs.length} ÿ≥ÿ¨ŸÑ ÿ™ÿπÿØŸäŸÑ`);
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿ≥ÿ¨ŸÑ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™:', error);
                // ŸÅŸä ÿ≠ÿßŸÑÿ© ÿßŸÑÿÆÿ∑ÿ£ÿå ŸÜÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ©
                console.log('‚ö†Ô∏è ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ©');
            }
        }
        
        // ÿπÿ±ÿ∂ ÿ≥ÿ¨ŸÑ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™
        function displayAuditLogs() {
            const tbody = document.getElementById('auditLogsTableBody');
            if (!tbody) return;
            
            if (auditLogs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #666;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ≥ÿ¨ŸÑÿßÿ™ ÿ™ÿπÿØŸäŸÑ</td></tr>';
                return;
            }
            
            const actionNames = {
                'create': 'ÿ•ÿ∂ÿßŸÅÿ©',
                'update': 'ÿ™ÿπÿØŸäŸÑ',
                'delete': 'ÿ≠ÿ∞ŸÅ',
                'view': 'ÿπÿ±ÿ∂'
            };
            
            const entityNames = {
                'employee': 'ŸÖŸàÿ∏ŸÅ',
                'evaluation': 'ÿ™ŸÇŸäŸäŸÖ ÿ≥ŸÜŸàŸä',
                'project': 'ŸÖÿ¥ÿ±Ÿàÿπ',
                'leave': 'ÿ•ÿ¨ÿßÿ≤ÿ©',
                'user': 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ'
            };
            
            tbody.innerHTML = auditLogs.map(log => {
                const date = new Date(log.timestamp || log.createdAt);
                const dateStr = formatDateTime(date);
                
                let details = '';
                if (log.data) {
                    if (log.entityType === 'employee') {
                        details = log.data.employeeName || log.data.employeeNumber || '-';
                    } else if (log.entityType === 'evaluation') {
                        details = `ÿ≥ŸÜÿ© ${log.data.evaluationYear || log.data.evaluation?.year || '-'} - ÿ™ŸÇŸäŸäŸÖ ${log.data.evaluationRating || log.data.evaluation?.rating || '-'}/5`;
                    } else {
                        details = JSON.stringify(log.data).substring(0, 50) + '...';
                    }
                }
                
                return `
                    <tr>
                        <td>${dateStr}</td>
                        <td><span class="badge badge-info">${entityNames[log.entityType] || log.entityType}</span></td>
                        <td><span class="badge ${log.action === 'delete' ? 'badge-danger' : log.action === 'create' ? 'badge-success' : 'badge-warning'}">${actionNames[log.action] || log.action}</span></td>
                        <td>${log.userEmail || log.userId || '-'}</td>
                        <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${details}">${details || '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        // ============================================
        // ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ
        // ============================================
        async function loadProjects() {
            try {
                if (!window.db || !window.firestore) {
                    console.warn('Firebase ÿ∫Ÿäÿ± ŸÖŸáŸäÿ£');
                    return;
                }

                const projectsRef = window.firestore.collection(window.db, 'projects');
                const snapshot = await window.firestore.getDocs(projectsRef);
                projectsData = [];
                snapshot.forEach(doc => {
                    projectsData.push({ id: doc.id, ...doc.data() });
                });

                displayProjects();
                updateProjectsCount();
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ:', error);
                document.getElementById('projectsTableBody').innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #dc3545;">ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</td></tr>';
            }
        }

        function displayProjects() {
            const tbody = document.getElementById('projectsTableBody');
            if (projectsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™</td></tr>';
                return;
            }

            tbody.innerHTML = projectsData.map(proj => {
                const region = regionsData.find(r => r.id === proj.regionId);
                const regionName = region ? region.name : '-';
                return `
                    <tr>
                        <td><strong style="color: #667eea;">${proj.code || '-'}</strong></td>
                        <td>
                            <strong>${proj.name || '-'}</strong>
                            ${proj.nameEn ? `<br><small style="color: #999; font-size: 0.85em;">${proj.nameEn}</small>` : ''}
                        </td>
                        <td>${regionName}</td>
                        <td>${proj.startDate || '-'}</td>
                        <td>${proj.endDate || '-'}</td>
                        <td><span class="badge ${getStatusBadge(proj.status)}">${getStatusName(proj.status)}</span></td>
                        <td class="action-buttons">
                            <button class="btn btn-primary" onclick="editProject('${proj.id}')">ÿ™ÿπÿØŸäŸÑ</button>
                            <button class="btn btn-danger" onclick="deleteProject('${proj.id}')">ÿ≠ÿ∞ŸÅ</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function filterProjects() {
            const search = document.getElementById('projectSearch').value.toLowerCase();
            const statusFilter = document.getElementById('projectStatusFilter').value;

            const filtered = projectsData.filter(proj => {
                const matchSearch = !search || 
                    (proj.name && proj.name.toLowerCase().includes(search)) ||
                    (proj.nameEn && proj.nameEn.toLowerCase().includes(search)) ||
                    (proj.code && proj.code.toLowerCase().includes(search));
                
                const matchStatus = !statusFilter || proj.status === statusFilter;
                
                return matchSearch && matchStatus;
            });

            const tbody = document.getElementById('projectsTableBody');
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ™ÿßÿ¶ÿ¨</td></tr>';
            } else {
                tbody.innerHTML = filtered.map(proj => {
                    const region = regionsData.find(r => r.id === proj.regionId);
                    const regionName = region ? region.name : '-';
                    return `
                        <tr>
                            <td><strong style="color: #667eea;">${proj.code || '-'}</strong></td>
                            <td>
                                <strong>${proj.name || '-'}</strong>
                                ${proj.nameEn ? `<br><small style="color: #999; font-size: 0.85em;">${proj.nameEn}</small>` : ''}
                            </td>
                            <td>${regionName}</td>
                            <td>${proj.startDate || '-'}</td>
                            <td>${proj.endDate || '-'}</td>
                            <td><span class="badge ${getStatusBadge(proj.status)}">${getStatusName(proj.status)}</span></td>
                            <td class="action-buttons">
                                <button class="btn btn-primary" onclick="editProject('${proj.id}')">ÿ™ÿπÿØŸäŸÑ</button>
                                <button class="btn btn-danger" onclick="deleteProject('${proj.id}')">ÿ≠ÿ∞ŸÅ</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            document.getElementById('projectsCount').textContent = `ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ: ${filtered.length}`;
        }

        function clearProjectFilters() {
            document.getElementById('projectSearch').value = '';
            document.getElementById('projectStatusFilter').value = '';
            displayProjects();
            updateProjectsCount();
        }

        function updateProjectsCount() {
            document.getElementById('projectsCount').textContent = `ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ: ${projectsData.length}`;
        }

        // ÿ™ŸàŸÑŸäÿØ ÿ±ŸÖÿ≤ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã
        async function generateProjectCode() {
            try {
                if (!window.db || !window.firestore) {
                    return 'PRJ-001';
                }

                const projectsRef = window.firestore.collection(window.db, 'projects');
                const snapshot = await window.firestore.getDocs(projectsRef);
                const count = snapshot.size;
                const codeNumber = String(count + 1).padStart(3, '0');
                return `PRJ-${codeNumber}`;
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ŸàŸÑŸäÿØ ÿ±ŸÖÿ≤ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ:', error);
                return 'PRJ-001';
            }
        }

        // ÿπÿ±ÿ∂ ŸÜÿßŸÅÿ∞ÿ© ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ¥ÿ±Ÿàÿπ
        async function showAddProjectForm() {
            editingProjectId = null;
            const modal = document.getElementById('projectModal');
            if (!modal) return;

            // ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ™ÿ±ÿ¨ŸÖÿßÿ™ ŸÇÿ®ŸÑ ŸÅÿ™ÿ≠ ÿßŸÑŸÜÿßŸÅÿ∞ÿ©
            applyTranslations();
            document.getElementById('projectSubmitBtn').setAttribute('onclick', 'addProject()');

            // ÿ™ŸàŸÑŸäÿØ ÿ±ŸÖÿ≤ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ
            const projectCode = await generateProjectCode();
            document.getElementById('projectCode').textContent = projectCode;

            // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ
            await loadRegions();
            const regionSelect = document.getElementById('projectRegion');
            if (regionSelect) {
                regionSelect.innerHTML = '<option value="">-- ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© --</option>';
                regionsData.forEach(region => {
                    const option = document.createElement('option');
                    option.value = region.id;
                    option.textContent = region.name;
                    regionSelect.appendChild(option);
                });
            }

            // ŸÖÿ≥ÿ≠ ÿßŸÑÿ≠ŸÇŸàŸÑ
            document.getElementById('projectName').value = '';
            document.getElementById('projectNameEn').value = '';
            document.getElementById('projectDescription').value = '';
            document.getElementById('projectStartDate').value = '';
            document.getElementById('projectEndDate').value = '';
            document.getElementById('projectStatus').value = 'active';
            document.getElementById('projectRegion').value = '';
            document.getElementById('projectIsGeneralManagement').checked = false;
            document.getElementById('projectGeneralManager').value = '';
            document.getElementById('projectExecutiveManager').value = '';
            document.getElementById('generalManagementFields').style.display = 'none';

            modal.classList.add('active');
        }

        // ÿ™ÿ®ÿØŸäŸÑ ÿπÿ±ÿ∂ ÿ≠ŸÇŸàŸÑ ÿßŸÑÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿπÿßŸÖÿ©
        function toggleGeneralManagementFields() {
            const checkbox = document.getElementById('projectIsGeneralManagement');
            const fieldsDiv = document.getElementById('generalManagementFields');
            if (checkbox && fieldsDiv) {
                fieldsDiv.style.display = checkbox.checked ? 'block' : 'none';
            }
        }

        // ÿ•ÿÆŸÅÿßÿ° ŸÜÿßŸÅÿ∞ÿ© ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ¥ÿ±Ÿàÿπ
        function hideAddProjectForm() {
            const modal = document.getElementById('projectModal');
            if (modal) {
                modal.classList.remove('active');
            }
            editingProjectId = null;
        }

        // ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ¥ÿ±Ÿàÿπ
        async function addProject() {
            if (editingProjectId) {
                updateProject();
                return;
            }

            if (!window.db || !window.firestore) {
                alert('Firebase ÿ∫Ÿäÿ± ŸÖŸáŸäÿ£');
                return;
            }

            const isGeneralManagement = document.getElementById('projectIsGeneralManagement').checked;
            const projectData = {
                code: document.getElementById('projectCode').textContent,
                name: document.getElementById('projectName').value.trim(),
                nameEn: document.getElementById('projectNameEn').value.trim() || null,
                description: document.getElementById('projectDescription').value.trim(),
                startDate: document.getElementById('projectStartDate').value,
                endDate: document.getElementById('projectEndDate').value,
                status: document.getElementById('projectStatus').value || 'active',
                regionId: document.getElementById('projectRegion').value || null,
                isGeneralManagement: isGeneralManagement,
                createdAt: window.firestore.serverTimestamp(),
                createdBy: currentUser?.uid || 'system'
            };

            // ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿπÿßŸÖÿ© ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ÿ•ÿØÿßÿ±ÿ© ÿπÿßŸÖÿ©
            if (isGeneralManagement) {
                projectData.generalManager = document.getElementById('projectGeneralManager').value.trim();
                projectData.executiveManager = document.getElementById('projectExecutiveManager').value.trim();
            }

            if (!projectData.name) {
                alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ');
                return;
            }

            try {
                await window.firestore.addDoc(
                    window.firestore.collection(window.db, 'projects'),
                    projectData
                );

                alert('ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ÿ®ŸÜÿ¨ÿßÿ≠!');
                hideAddProjectForm();
                await loadProjects();
                await loadDashboardStats();
            } catch (error) {
                alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ: ' + error.message);
                console.error(error);
            }
        }

        // ÿ™ÿπÿØŸäŸÑ ŸÖÿ¥ÿ±Ÿàÿπ
        async function editProject(id) {
            editingProjectId = id;
            const proj = projectsData.find(p => p.id === id);
            if (!proj) {
                alert('ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ');
                return;
            }

            const modal = document.getElementById('projectModal');
            if (!modal) return;

            // ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ™ÿ±ÿ¨ŸÖÿßÿ™ ŸÇÿ®ŸÑ ŸÅÿ™ÿ≠ ÿßŸÑŸÜÿßŸÅÿ∞ÿ©
            applyTranslations();
            document.getElementById('projectSubmitBtn').setAttribute('onclick', 'updateProject()');

            document.getElementById('projectCode').textContent = proj.code || 'PRJ-001';
            document.getElementById('projectName').value = proj.name || '';
            document.getElementById('projectNameEn').value = proj.nameEn || '';
            document.getElementById('projectDescription').value = proj.description || '';
            document.getElementById('projectStartDate').value = proj.startDate || '';
            document.getElementById('projectEndDate').value = proj.endDate || '';
            document.getElementById('projectStatus').value = proj.status || 'active';

            // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ Ÿàÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑŸÖÿ≠ÿØÿØÿ©
            await loadRegions();
            const regionSelect = document.getElementById('projectRegion');
            if (regionSelect) {
                regionSelect.innerHTML = '<option value="">-- ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© --</option>';
                regionsData.forEach(region => {
                    const option = document.createElement('option');
                    option.value = region.id;
                    option.textContent = region.name;
                    if (proj.regionId === region.id) {
                        option.selected = true;
                    }
                    regionSelect.appendChild(option);
                });
            }

            // ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿπÿßŸÖÿ©
            const isGeneralManagement = proj.isGeneralManagement || false;
            document.getElementById('projectIsGeneralManagement').checked = isGeneralManagement;
            document.getElementById('projectGeneralManager').value = proj.generalManager || '';
            document.getElementById('projectExecutiveManager').value = proj.executiveManager || '';
            document.getElementById('generalManagementFields').style.display = isGeneralManagement ? 'block' : 'none';

            modal.classList.add('active');
        }

        // ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿ¥ÿ±Ÿàÿπ
        async function updateProject() {
            if (!editingProjectId) return;

            if (!window.db || !window.firestore) {
                alert('Firebase ÿ∫Ÿäÿ± ŸÖŸáŸäÿ£');
                return;
            }

            const isGeneralManagement = document.getElementById('projectIsGeneralManagement').checked;
            const projectData = {
                name: document.getElementById('projectName').value.trim(),
                nameEn: document.getElementById('projectNameEn').value.trim() || null,
                description: document.getElementById('projectDescription').value.trim(),
                startDate: document.getElementById('projectStartDate').value,
                endDate: document.getElementById('projectEndDate').value,
                status: document.getElementById('projectStatus').value || 'active',
                regionId: document.getElementById('projectRegion').value || null,
                isGeneralManagement: isGeneralManagement,
                updatedAt: window.firestore.serverTimestamp(),
                updatedBy: currentUser?.uid || 'system'
            };

            // ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿπÿßŸÖÿ© ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ÿ•ÿØÿßÿ±ÿ© ÿπÿßŸÖÿ©
            if (isGeneralManagement) {
                projectData.generalManager = document.getElementById('projectGeneralManager').value.trim();
                projectData.executiveManager = document.getElementById('projectExecutiveManager').value.trim();
            } else {
                // ÿ•ÿ≤ÿßŸÑÿ© ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿπÿßŸÖÿ© ÿ•ÿ∞ÿß ŸÑŸÖ ŸäÿπÿØ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ÿ•ÿØÿßÿ±ÿ© ÿπÿßŸÖÿ©
                projectData.generalManager = null;
                projectData.executiveManager = null;
            }

            if (!projectData.name) {
                alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ');
                return;
            }

            try {
                await window.firestore.updateDoc(
                    window.firestore.doc(window.db, 'projects', editingProjectId),
                    projectData
                );

                alert('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ÿ®ŸÜÿ¨ÿßÿ≠!');
                hideAddProjectForm();
                await loadProjects();
                await loadDashboardStats();
            } catch (error) {
                alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ: ' + error.message);
                console.error(error);
            }
        }

        // ÿ≠ÿ∞ŸÅ ŸÖÿ¥ÿ±Ÿàÿπ
        async function deleteProject(id) {
            if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπÿü')) return;

            if (!window.db || !window.firestore) {
                alert('Firebase ÿ∫Ÿäÿ± ŸÖŸáŸäÿ£');
                return;
            }

            try {
                await window.firestore.deleteDoc(
                    window.firestore.doc(window.db, 'projects', id)
                );

                alert('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ÿ®ŸÜÿ¨ÿßÿ≠!');
                await loadProjects();
                await loadDashboardStats();
            } catch (error) {
                alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ: ' + error.message);
                console.error(error);
            }
        }

        // ============================================
        // ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ
        // ============================================
        async function loadRegions() {
            try {
                if (!window.db || !window.firestore) {
                    console.warn('Firebase ÿ∫Ÿäÿ± ŸÖŸáŸäÿ£');
                    return;
                }

                const regionsRef = window.firestore.collection(window.db, 'regions');
                const snapshot = await window.firestore.getDocs(regionsRef);
                regionsData = [];
                snapshot.forEach(doc => {
                    regionsData.push({ id: doc.id, ...doc.data() });
                });

                if (document.getElementById('regionsTableBody')) {
                    displayRegions();
                }
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ:', error);
            }
        }

        function displayRegions() {
            const tbody = document.getElementById('regionsTableBody');
            if (!tbody) return;

            if (regionsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 40px;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™</td></tr>';
                return;
            }

            tbody.innerHTML = regionsData.map(region => {
                // ÿ≠ÿ≥ÿßÿ® ÿπÿØÿØ ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ ŸÅŸä Ÿáÿ∞Ÿá ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©
                const projectsCount = projectsData.filter(p => p.regionId === region.id).length;
                
                return `
                    <tr>
                        <td>
                            <strong style="color: #667eea;">${region.name || '-'}</strong>
                            ${region.nameEn ? `<br><small style="color: #999; font-size: 0.85em;">${region.nameEn}</small>` : ''}
                        </td>
                        <td>${region.description || '-'}</td>
                        <td><span class="badge badge-info">${projectsCount}</span></td>
                        <td class="action-buttons">
                            <button class="btn btn-primary" onclick="editRegion('${region.id}')">ÿ™ÿπÿØŸäŸÑ</button>
                            <button class="btn btn-danger" onclick="deleteRegion('${region.id}')">ÿ≠ÿ∞ŸÅ</button>
                        </td>
                    </tr>
                `;
            }).join('');

            updateRegionsCount();
        }

        function filterRegions() {
            const search = document.getElementById('regionSearch').value.toLowerCase();
            const filtered = regionsData.filter(region => {
                const matchSearch = !search || 
                    (region.name && region.name.toLowerCase().includes(search)) ||
                    (region.nameEn && region.nameEn.toLowerCase().includes(search)) ||
                    (region.description && region.description.toLowerCase().includes(search));
                return matchSearch;
            });

            const tbody = document.getElementById('regionsTableBody');
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 40px;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ™ÿßÿ¶ÿ¨</td></tr>';
            } else {
                tbody.innerHTML = filtered.map(region => {
                    const projectsCount = projectsData.filter(p => p.regionId === region.id).length;
                    return `
                        <tr>
                            <td>
                                <strong style="color: #667eea;">${region.name || '-'}</strong>
                                ${region.nameEn ? `<br><small style="color: #999; font-size: 0.85em;">${region.nameEn}</small>` : ''}
                            </td>
                            <td>${region.description || '-'}</td>
                            <td><span class="badge badge-info">${projectsCount}</span></td>
                            <td class="action-buttons">
                                <button class="btn btn-primary" onclick="editRegion('${region.id}')">ÿ™ÿπÿØŸäŸÑ</button>
                                <button class="btn btn-danger" onclick="deleteRegion('${region.id}')">ÿ≠ÿ∞ŸÅ</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            const countEl = document.getElementById('regionsCount');
            if (countEl) {
                countEl.textContent = `ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ: ${filtered.length}`;
            }
        }

        function clearRegionFilters() {
            document.getElementById('regionSearch').value = '';
            displayRegions();
            updateRegionsCount();
        }

        function updateRegionsCount() {
            const countEl = document.getElementById('regionsCount');
            if (countEl) {
                countEl.textContent = `ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ: ${regionsData.length}`;
            }
        }

        function showAddRegionForm() {
            editingRegionId = null;
            const modal = document.getElementById('regionModal');
            if (!modal) return;

            // ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ™ÿ±ÿ¨ŸÖÿßÿ™ ŸÇÿ®ŸÑ ŸÅÿ™ÿ≠ ÿßŸÑŸÜÿßŸÅÿ∞ÿ©
            applyTranslations();
            document.getElementById('regionSubmitBtn').setAttribute('onclick', 'addRegion()');

            // ŸÖÿ≥ÿ≠ ÿßŸÑÿ≠ŸÇŸàŸÑ
            document.getElementById('regionName').value = '';
            document.getElementById('regionNameEn').value = '';
            document.getElementById('regionDescription').value = '';

            modal.classList.add('active');
        }

        function hideAddRegionForm() {
            const modal = document.getElementById('regionModal');
            if (modal) {
                modal.classList.remove('active');
            }
            editingRegionId = null;
        }

        async function addRegion() {
            if (editingRegionId) {
                updateRegion();
                return;
            }

            if (!window.db || !window.firestore) {
                alert('Firebase ÿ∫Ÿäÿ± ŸÖŸáŸäÿ£');
                return;
            }

            const regionData = {
                name: document.getElementById('regionName').value.trim(),
                nameEn: document.getElementById('regionNameEn').value.trim() || null,
                description: document.getElementById('regionDescription').value.trim(),
                createdAt: window.firestore.serverTimestamp(),
                createdBy: currentUser?.uid || 'system'
            };

            if (!regionData.name) {
                alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©');
                return;
            }

            try {
                await window.firestore.addDoc(
                    window.firestore.collection(window.db, 'regions'),
                    regionData
                );

                alert('ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿ®ŸÜÿ¨ÿßÿ≠!');
                hideAddRegionForm();
                await loadRegions();
            } catch (error) {
                alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©: ' + error.message);
                console.error(error);
            }
        }

        async function editRegion(id) {
            editingRegionId = id;
            const region = regionsData.find(r => r.id === id);
            if (!region) {
                alert('ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©');
                return;
            }

            const modal = document.getElementById('regionModal');
            if (!modal) return;

            // ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ™ÿ±ÿ¨ŸÖÿßÿ™ ŸÇÿ®ŸÑ ŸÅÿ™ÿ≠ ÿßŸÑŸÜÿßŸÅÿ∞ÿ©
            applyTranslations();
            document.getElementById('regionSubmitBtn').setAttribute('onclick', 'updateRegion()');

            document.getElementById('regionName').value = region.name || '';
            document.getElementById('regionNameEn').value = region.nameEn || '';
            document.getElementById('regionDescription').value = region.description || '';

            modal.classList.add('active');
        }

        async function updateRegion() {
            if (!editingRegionId) return;

            if (!window.db || !window.firestore) {
                alert('Firebase ÿ∫Ÿäÿ± ŸÖŸáŸäÿ£');
                return;
            }

            const regionData = {
                name: document.getElementById('regionName').value.trim(),
                nameEn: document.getElementById('regionNameEn').value.trim() || null,
                description: document.getElementById('regionDescription').value.trim(),
                updatedAt: window.firestore.serverTimestamp(),
                updatedBy: currentUser?.uid || 'system'
            };

            if (!regionData.name) {
                alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©');
                return;
            }

            try {
                await window.firestore.updateDoc(
                    window.firestore.doc(window.db, 'regions', editingRegionId),
                    regionData
                );

                alert('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿ®ŸÜÿ¨ÿßÿ≠!');
                hideAddRegionForm();
                await loadRegions();
            } catch (error) {
                alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©: ' + error.message);
                console.error(error);
            }
        }

        async function deleteRegion(id) {
            if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞Ÿá ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©ÿü\n\nŸÖŸÑÿßÿ≠ÿ∏ÿ©: ÿ≥Ÿäÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿ±ÿ®ÿ∑ ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ ÿ®Ÿáÿ∞Ÿá ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©.')) return;

            if (!window.db || !window.firestore) {
                alert('Firebase ÿ∫Ÿäÿ± ŸÖŸáŸäÿ£');
                return;
            }

            try {
                // ÿ•ÿ≤ÿßŸÑÿ© ÿ±ÿ®ÿ∑ ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ ÿ®Ÿáÿ∞Ÿá ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©
                const projectsInRegion = projectsData.filter(p => p.regionId === id);
                for (const project of projectsInRegion) {
                    await window.firestore.updateDoc(
                        window.firestore.doc(window.db, 'projects', project.id),
                        { regionId: null }
                    );
                }

                await window.firestore.deleteDoc(
                    window.firestore.doc(window.db, 'regions', id)
                );

                alert('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿ®ŸÜÿ¨ÿßÿ≠!');
                await loadRegions();
                await loadProjects();
            } catch (error) {
                alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©: ' + error.message);
                console.error(error);
            }
        }

        // ============================================
        // ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ
        // ============================================
        async function loadDepartments() {
            try {
                if (!window.db || !window.firestore) {
                    console.warn('Firebase ÿ∫Ÿäÿ± ŸÖŸáŸäÿ£');
                    return;
                }

                const departmentsRef = window.firestore.collection(window.db, 'departments');
                const snapshot = await window.firestore.getDocs(departmentsRef);
                departmentsData = [];
                snapshot.forEach(doc => {
                    departmentsData.push({ id: doc.id, ...doc.data() });
                });

                if (document.getElementById('departmentsTableBody')) {
                    displayDepartments();
                }
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ:', error);
            }
        }

        function displayDepartments() {
            const tbody = document.getElementById('departmentsTableBody');
            if (!tbody) return;

            if (departmentsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™</td></tr>';
                return;
            }

            tbody.innerHTML = departmentsData.map(dept => {
                const employeesCount = employeesData.filter(e => e.departmentId === dept.id).length;
                let projectName = '-';
                if (dept.projectId === 'general_management') {
                    projectName = 'ÿßŸÑÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿπÿßŸÖÿ©';
                } else if (dept.projectId) {
                    const project = projectsData.find(p => p.id === dept.projectId);
                    projectName = project ? project.name : 'ŸÖÿ¥ÿ±Ÿàÿπ ŸÖÿ≠ÿ∞ŸàŸÅ';
                }
                
                return `
                    <tr>
                        <td>
                            <strong style="color: #667eea;">${dept.name || '-'}</strong>
                            ${dept.nameEn ? `<br><small style="color: #999; font-size: 0.85em;">${dept.nameEn}</small>` : ''}
                        </td>
                        <td>${projectName}</td>
                        <td>${dept.description || '-'}</td>
                        <td><span class="badge badge-info">${employeesCount}</span></td>
                        <td class="action-buttons">
                            <button class="btn btn-primary" onclick="editDepartment('${dept.id}')">ÿ™ÿπÿØŸäŸÑ</button>
                            <button class="btn btn-danger" onclick="deleteDepartment('${dept.id}')">ÿ≠ÿ∞ŸÅ</button>
                        </td>
                    </tr>
                `;
            }).join('');

            updateDepartmentsCount();
        }

        function filterDepartments() {
            const search = document.getElementById('departmentSearch').value.toLowerCase();
            const filtered = departmentsData.filter(dept => {
                const matchSearch = !search || 
                    (dept.name && dept.name.toLowerCase().includes(search)) ||
                    (dept.nameEn && dept.nameEn.toLowerCase().includes(search)) ||
                    (dept.description && dept.description.toLowerCase().includes(search));
                return matchSearch;
            });

            const tbody = document.getElementById('departmentsTableBody');
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ™ÿßÿ¶ÿ¨</td></tr>';
            } else {
                tbody.innerHTML = filtered.map(dept => {
                    const employeesCount = employeesData.filter(e => e.departmentId === dept.id).length;
                    let projectName = '-';
                    if (dept.projectId === 'general_management') {
                        projectName = 'ÿßŸÑÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿπÿßŸÖÿ©';
                    } else if (dept.projectId) {
                        const project = projectsData.find(p => p.id === dept.projectId);
                        projectName = project ? project.name : 'ŸÖÿ¥ÿ±Ÿàÿπ ŸÖÿ≠ÿ∞ŸàŸÅ';
                    }
                    return `
                        <tr>
                            <td>
                                <strong style="color: #667eea;">${dept.name || '-'}</strong>
                                ${dept.nameEn ? `<br><small style="color: #999; font-size: 0.85em;">${dept.nameEn}</small>` : ''}
                            </td>
                            <td>${projectName}</td>
                            <td>${dept.description || '-'}</td>
                            <td><span class="badge badge-info">${employeesCount}</span></td>
                            <td class="action-buttons">
                                <button class="btn btn-primary" onclick="editDepartment('${dept.id}')">ÿ™ÿπÿØŸäŸÑ</button>
                                <button class="btn btn-danger" onclick="deleteDepartment('${dept.id}')">ÿ≠ÿ∞ŸÅ</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            const countEl = document.getElementById('departmentsCount');
            if (countEl) {
                countEl.textContent = `ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ: ${filtered.length}`;
            }
        }

        function clearDepartmentFilters() {
            document.getElementById('departmentSearch').value = '';
            displayDepartments();
            updateDepartmentsCount();
        }

        function updateDepartmentsCount() {
            const countEl = document.getElementById('departmentsCount');
            if (countEl) {
                countEl.textContent = `ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ: ${departmentsData.length}`;
            }
        }

        async function showAddDepartmentForm() {
            editingDepartmentId = null;
            const modal = document.getElementById('departmentModal');
            if (!modal) return;

            // ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ™ÿ±ÿ¨ŸÖÿßÿ™ ŸÇÿ®ŸÑ ŸÅÿ™ÿ≠ ÿßŸÑŸÜÿßŸÅÿ∞ÿ©
            applyTranslations();
            document.getElementById('departmentSubmitBtn').setAttribute('onclick', 'addDepartment()');

            await loadProjects();
            const projectSelect = document.getElementById('departmentProjectId');
            if (projectSelect) {
                projectSelect.innerHTML = '<option value="">-- ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ --</option>';
                projectSelect.innerHTML += '<option value="general_management">ÿßŸÑÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿπÿßŸÖÿ©</option>';
                projectsData.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = `${project.code || ''} - ${project.name}`;
                    projectSelect.appendChild(option);
                });
            }

            document.getElementById('departmentName').value = '';
            document.getElementById('departmentNameEn').value = '';
            document.getElementById('departmentDescription').value = '';
            if (projectSelect) projectSelect.value = '';

            modal.classList.add('active');
        }

        function hideAddDepartmentForm() {
            const modal = document.getElementById('departmentModal');
            if (modal) {
                modal.classList.remove('active');
            }
            editingDepartmentId = null;
        }

        async function addDepartment() {
            if (editingDepartmentId) {
                updateDepartment();
                return;
            }

            if (!window.db || !window.firestore) {
                alert('Firebase ÿ∫Ÿäÿ± ŸÖŸáŸäÿ£');
                return;
            }

            const departmentData = {
                name: document.getElementById('departmentName').value.trim(),
                nameEn: document.getElementById('departmentNameEn').value.trim() || null,
                projectId: document.getElementById('departmentProjectId').value || null,
                description: document.getElementById('departmentDescription').value.trim(),
                createdAt: window.firestore.serverTimestamp(),
                createdBy: currentUser?.uid || 'system'
            };

            if (!departmentData.name) {
                alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÇÿ≥ŸÖ');
                return;
            }

            if (!departmentData.projectId) {
                alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ÿ£Ÿà ÿßŸÑÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿπÿßŸÖÿ©');
                return;
            }

            try {
                await window.firestore.addDoc(
                    window.firestore.collection(window.db, 'departments'),
                    departmentData
                );

                alert('ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÇÿ≥ŸÖ ÿ®ŸÜÿ¨ÿßÿ≠!');
                hideAddDepartmentForm();
                await loadDepartments();
            } catch (error) {
                alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÇÿ≥ŸÖ: ' + error.message);
                console.error(error);
            }
        }

        async function editDepartment(id) {
            editingDepartmentId = id;
            const department = departmentsData.find(d => d.id === id);
            if (!department) {
                alert('ÿßŸÑŸÇÿ≥ŸÖ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ');
                return;
            }

            const modal = document.getElementById('departmentModal');
            if (!modal) return;

            // ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ™ÿ±ÿ¨ŸÖÿßÿ™ ŸÇÿ®ŸÑ ŸÅÿ™ÿ≠ ÿßŸÑŸÜÿßŸÅÿ∞ÿ©
            applyTranslations();
            document.getElementById('departmentSubmitBtn').setAttribute('onclick', 'updateDepartment()');

            await loadProjects();
            const projectSelect = document.getElementById('departmentProjectId');
            if (projectSelect) {
                projectSelect.innerHTML = '<option value="">-- ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ --</option>';
                projectSelect.innerHTML += '<option value="general_management">ÿßŸÑÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿπÿßŸÖÿ©</option>';
                projectsData.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = `${project.code || ''} - ${project.name}`;
                    if (department.projectId === project.id) {
                        option.selected = true;
                    }
                    projectSelect.appendChild(option);
                });
                if (department.projectId === 'general_management') {
                    projectSelect.value = 'general_management';
                }
            }

            document.getElementById('departmentName').value = department.name || '';
            document.getElementById('departmentNameEn').value = department.nameEn || '';
            document.getElementById('departmentDescription').value = department.description || '';

            modal.classList.add('active');
        }

        async function updateDepartment() {
            if (!editingDepartmentId) return;

            if (!window.db || !window.firestore) {
                alert('Firebase ÿ∫Ÿäÿ± ŸÖŸáŸäÿ£');
                return;
            }

            const departmentData = {
                name: document.getElementById('departmentName').value.trim(),
                nameEn: document.getElementById('departmentNameEn').value.trim() || null,
                projectId: document.getElementById('departmentProjectId').value || null,
                description: document.getElementById('departmentDescription').value.trim(),
                updatedAt: window.firestore.serverTimestamp(),
                updatedBy: currentUser?.uid || 'system'
            };

            if (!departmentData.name) {
                alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÇÿ≥ŸÖ');
                return;
            }

            if (!departmentData.projectId) {
                alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ÿ£Ÿà ÿßŸÑÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿπÿßŸÖÿ©');
                return;
            }

            try {
                await window.firestore.updateDoc(
                    window.firestore.doc(window.db, 'departments', editingDepartmentId),
                    departmentData
                );

                alert('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÇÿ≥ŸÖ ÿ®ŸÜÿ¨ÿßÿ≠!');
                hideAddDepartmentForm();
                await loadDepartments();
            } catch (error) {
                alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÇÿ≥ŸÖ: ' + error.message);
                console.error(error);
            }
        }

        async function deleteDepartment(id) {
            if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑŸÇÿ≥ŸÖÿü\n\nŸÖŸÑÿßÿ≠ÿ∏ÿ©: ÿ≥Ÿäÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿ±ÿ®ÿ∑ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ ÿ®Ÿáÿ∞ÿß ÿßŸÑŸÇÿ≥ŸÖ.')) return;

            if (!window.db || !window.firestore) {
                alert('Firebase ÿ∫Ÿäÿ± ŸÖŸáŸäÿ£');
                return;
            }

            try {
                const employeesInDepartment = employeesData.filter(e => e.departmentId === id);
                for (const employee of employeesInDepartment) {
                    await window.firestore.updateDoc(
                        window.firestore.doc(window.db, 'employees', employee.id),
                        { departmentId: null }
                    );
                }

                await window.firestore.deleteDoc(
                    window.firestore.doc(window.db, 'departments', id)
                );

                alert('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÇÿ≥ŸÖ ÿ®ŸÜÿ¨ÿßÿ≠!');
                await loadDepartments();
                await loadEmployees();
            } catch (error) {
                alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ÿ∞ŸÅ ÿßŸÑŸÇÿ≥ŸÖ: ' + error.message);
                console.error(error);
            }
        }

        // ============================================
        // ÿØŸàÿßŸÑ ŸÖÿ≥ÿßÿπÿØÿ©
        // ============================================
        function getStatusName(status) {
            const statusNames = {
                'active': 'ŸÜÿ¥ÿ∑',
                'inactive': 'ÿ∫Ÿäÿ± ŸÜÿ¥ÿ∑',
                'on-leave': 'ŸÅŸä ÿ•ÿ¨ÿßÿ≤ÿ©',
                'completed': 'ŸÖŸÉÿ™ŸÖŸÑ',
                'on-hold': 'ŸÖÿ™ŸàŸÇŸÅ'
            };
            return statusNames[status] || status;
        }

        function getStatusBadge(status) {
            const badges = {
                'active': 'badge-success',
                'inactive': 'badge-danger',
                'on-leave': 'badge-warning',
                'completed': 'badge-success',
                'on-hold': 'badge-info'
            };
            return badges[status] || 'badge-info';
        }

        // ÿØÿßŸÑÿ© ŸÑŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßÿ≥ŸÖ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖŸàÿ∏ŸÅ
        function getEmployeeStatusName(status) {
            const statusNames = {
                'active': 'ŸÜÿ¥ÿ∑',
                'inactive': 'ÿ∫Ÿäÿ± ŸÜÿ¥ÿ∑',
                'on-leave': 'ŸÅŸä ÿ•ÿ¨ÿßÿ≤ÿ©',
                'suspended': 'ŸÖŸàŸÇŸàŸÅ',
                'terminated': 'ŸÖŸÜÿ™ŸáŸä ÿßŸÑÿÆÿØŸÖÿ©'
            };
            return statusNames[status] || status || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
        }

        // ÿØÿßŸÑÿ© ŸÑŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ badge ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖŸàÿ∏ŸÅ
        function getEmployeeStatusBadge(status) {
            const badges = {
                'active': 'badge-success',
                'inactive': 'badge-danger',
                'on-leave': 'badge-warning',
                'suspended': 'badge-danger',
                'terminated': 'badge-secondary'
            };
            return badges[status] || 'badge-secondary';
        }

        // ============================================
        // ÿØŸàÿßŸÑ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿµŸàÿ± ŸàÿßŸÑŸÖÿ≥ÿ™ŸÜÿØÿßÿ™
        // ============================================
        // ÿ∂ÿ∫ÿ∑ ÿßŸÑÿµŸàÿ±ÿ© ŸÇÿ®ŸÑ ÿßŸÑÿ±ŸÅÿπ (ŸÖÿπ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿ∂ÿ∫ÿ∑ ÿ£ŸÇŸàŸâ)
        async function compressImage(file, maxWidth = 1600, maxHeight = 1600, quality = 0.6) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ£ÿ®ÿπÿßÿØ ÿßŸÑÿ¨ÿØŸäÿØÿ© ŸÖÿπ ÿßŸÑÿ≠ŸÅÿßÿ∏ ÿπŸÑŸâ ŸÜÿ≥ÿ®ÿ© ÿßŸÑÿπÿ±ÿ∂ ÿ•ŸÑŸâ ÿßŸÑÿßÿ±ÿ™ŸÅÿßÿπ
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > maxWidth || height > maxHeight) {
                            if (width > height) {
                                height = (height * maxWidth) / width;
                                width = maxWidth;
                            } else {
                                width = (width * maxHeight) / height;
                                height = maxHeight;
                            }
                        }
                        
                        // ÿ•ŸÜÿ¥ÿßÿ° Canvas Ÿàÿ∂ÿ∫ÿ∑ ÿßŸÑÿµŸàÿ±ÿ©
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // ÿ™ÿ≠ŸàŸäŸÑ Canvas ÿ•ŸÑŸâ Blob
                        canvas.toBlob((blob) => {
                            if (blob) {
                                // ÿ•ŸÜÿ¥ÿßÿ° File ÿ¨ÿØŸäÿØ ŸÖŸÜ Blob
                                const compressedFile = new File([blob], file.name, {
                                    type: 'image/jpeg',
                                    lastModified: Date.now()
                                });
                                
                                console.log(`‚úÖ ÿ™ŸÖ ÿ∂ÿ∫ÿ∑ ÿßŸÑÿµŸàÿ±ÿ©: ${(file.size / 1024).toFixed(2)} KB ‚Üí ${(compressedFile.size / 1024).toFixed(2)} KB (${((1 - compressedFile.size / file.size) * 100).toFixed(1)}% ÿ™ŸÇŸÑŸäŸÑ)`);
                                resolve(compressedFile);
                            } else {
                                reject(new Error('ŸÅÿ¥ŸÑ ÿ∂ÿ∫ÿ∑ ÿßŸÑÿµŸàÿ±ÿ©'));
                            }
                        }, 'image/jpeg', quality);
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        // ÿ∂ÿ∫ÿ∑ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã (ÿßŸÑÿµŸàÿ±ÿå PDFÿå DOCÿå ÿ•ŸÑÿÆ)
        async function compressFile(file) {
            const fileType = file.type || '';
            const fileName = file.name.toLowerCase();
            
            // ÿ∂ÿ∫ÿ∑ ÿßŸÑÿµŸàÿ± (ŸÖÿπ ÿ∂ÿ∫ÿ∑ ÿ£ŸÇŸàŸâ ŸÑŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑŸÉÿ®Ÿäÿ±ÿ©)
            if (fileType.startsWith('image/')) {
                try {
                    // ŸÑŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑŸÉÿ®Ÿäÿ±ÿ©ÿå ŸÜÿ≥ÿ™ÿÆÿØŸÖ ÿ∂ÿ∫ÿ∑ ÿ£ŸÇŸàŸâ
                    let quality = 0.6;
                    let maxWidth = 1600;
                    let maxHeight = 1600;
                    
                    if (file.size > 2 * 1024 * 1024) { // ÿ£ŸÉÿ®ÿ± ŸÖŸÜ 2 MB
                        quality = 0.5;
                        maxWidth = 1400;
                        maxHeight = 1400;
                    }
                    if (file.size > 5 * 1024 * 1024) { // ÿ£ŸÉÿ®ÿ± ŸÖŸÜ 5 MB
                        quality = 0.4;
                        maxWidth = 1200;
                        maxHeight = 1200;
                    }
                    
                    const compressed = await compressImage(file, maxWidth, maxHeight, quality);
                    
                    // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿ≠ÿ¨ŸÖ ÿ®ÿπÿØ ÿßŸÑÿ∂ÿ∫ÿ∑ ŸÑÿß Ÿäÿ≤ÿßŸÑ ŸÉÿ®Ÿäÿ±ÿßŸãÿå ŸÜÿ≠ÿßŸàŸÑ ÿ∂ÿ∫ÿ∑ ÿ£ŸÉÿ´ÿ±
                    if (compressed.size > 800 * 1024 && file.size > compressed.size) {
                        const moreCompressed = await compressImage(compressed, maxWidth * 0.9, maxHeight * 0.9, quality * 0.9);
                        if (moreCompressed.size < compressed.size) {
                            return moreCompressed;
                        }
                    }
                    
                    return compressed;
                } catch (error) {
                    console.warn('‚ö†Ô∏è ŸÅÿ¥ŸÑ ÿ∂ÿ∫ÿ∑ ÿßŸÑÿµŸàÿ±ÿ©ÿå ÿ≥Ÿäÿ™ŸÖ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ£ÿµŸÑŸä:', error);
                    return file;
                }
            }
            
            // ŸÑŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑÿ£ÿÆÿ±Ÿâ (PDFÿå DOCÿå DOCX)ÿå ŸÜÿ≠ÿßŸàŸÑ ÿ™ŸÇŸÑŸäŸÑ ÿßŸÑÿ≠ÿ¨ŸÖ ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÉÿ®Ÿäÿ±ÿßŸã
            // ŸÖŸÑÿßÿ≠ÿ∏ÿ©: ŸÑÿß ŸäŸÖŸÉŸÜ ÿ∂ÿ∫ÿ∑ Ÿáÿ∞Ÿá ÿßŸÑŸÖŸÑŸÅÿßÿ™ ŸÅŸä ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ ÿ®ÿØŸàŸÜ ŸÖŸÉÿ™ÿ®ÿßÿ™ ÿÆÿßÿ±ÿ¨Ÿäÿ©
            // ŸÑŸÉŸÜ ŸäŸÖŸÉŸÜŸÜÿß ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ≠ÿ¨ŸÖ Ÿàÿ•ÿ±ÿ¨ÿßÿπ ÿßŸÑŸÖŸÑŸÅ ŸÉŸÖÿß ŸáŸà ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿµÿ∫Ÿäÿ±ÿßŸã
            if (file.size > 500 * 1024) { // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑŸÖŸÑŸÅ ÿ£ŸÉÿ®ÿ± ŸÖŸÜ 500 KB
                // ŸÑŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑŸÉÿ®Ÿäÿ±ÿ©ÿå ŸÜÿπÿ±ÿ∂ ÿ™ÿ≠ÿ∞Ÿäÿ±
                console.warn(`‚ö†Ô∏è ÿßŸÑŸÖŸÑŸÅ "${file.name}" ŸÉÿ®Ÿäÿ± (${(file.size / 1024).toFixed(2)} KB) ŸàŸÑÿß ŸäŸÖŸÉŸÜ ÿ∂ÿ∫ÿ∑Ÿá ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã.`);
            }
            
            return file;
        }

        async function previewEmployeePhoto(event) {
            const file = event.target.files[0];
            if (file) {
                // ÿπÿ±ÿ∂ ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑÿ£ÿµŸÑŸäÿ© ÿ£ŸàŸÑÿßŸã
                const reader = new FileReader();
                reader.onload = async (e) => {
                    document.getElementById('employeePhotoPreview').src = e.target.result;
                    
                    // ÿ∂ÿ∫ÿ∑ ÿßŸÑÿµŸàÿ±ÿ© ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã
                    try {
                        const compressedFile = await compressImage(file);
                        employeePhotoFile = compressedFile; // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑŸÖÿ∂ÿ∫Ÿàÿ∑ÿ©
                        console.log('‚úÖ ÿ™ŸÖ ÿ∂ÿ∫ÿ∑ ÿßŸÑÿµŸàÿ±ÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
                    } catch (error) {
                        console.error('‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿ∂ÿ∫ÿ∑ ÿßŸÑÿµŸàÿ±ÿ©ÿå ÿ≥Ÿäÿ™ŸÖ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑÿ£ÿµŸÑŸäÿ©:', error);
                        employeePhotoFile = file; // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑÿ£ÿµŸÑŸäÿ© ŸÅŸä ÿ≠ÿßŸÑÿ© ÿßŸÑŸÅÿ¥ŸÑ
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        function removeEmployeePhoto() {
            employeePhotoFile = null;
            document.getElementById('employeePhotoInput').value = '';
            document.getElementById('employeePhotoPreview').src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='150' height='150'%3E%3Crect fill='%23e9ecef' width='150' height='150'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' dy='.3em' fill='%23666' font-size='14'%3EÿµŸàÿ±ÿ© ÿßŸÑŸÖŸàÿ∏ŸÅ%3C/text%3E%3C/svg%3E";
        }

        // ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿµŸàÿ±ÿ© ÿ•ŸÑŸâ base64 Ÿàÿ™ÿÆÿ≤ŸäŸÜŸáÿß ŸÅŸä Firestore
        async function uploadEmployeePhoto(employeeId) {
            if (!employeePhotoFile) return null;
            try {
                // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖÿ≥ÿ¨ŸÑ ÿØÿÆŸàŸÑ
                if (!currentUser) {
                    throw new Error('Ÿäÿ¨ÿ® ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã');
                }
                
                // ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿµŸàÿ±ÿ© ÿ•ŸÑŸâ base64
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const base64String = e.target.result;
                            console.log('‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿµŸàÿ±ÿ© ÿ•ŸÑŸâ base64');
                            
                            // ÿ≠ŸÅÿ∏ base64 ŸÅŸä Firestore ŸÉŸÄ data URL
                            // ÿßŸÑÿµŸäÿ∫ÿ©: "data:image/jpeg;base64,/9j/4AAQSkZJRg..."
                            resolve(base64String);
                        } catch (error) {
                            console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿµŸàÿ±ÿ©:', error);
                            reject(error);
                        }
                    };
                    reader.onerror = (error) => {
                        console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑŸÖŸÑŸÅ:', error);
                        reject(error);
                    };
                    reader.readAsDataURL(employeePhotoFile);
                });
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ±ŸÅÿπ ÿßŸÑÿµŸàÿ±ÿ©:', error);
                alert('ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿµŸàÿ±ÿ©: ' + error.message);
                return null;
            }
        }

        async function handleDocumentUpload(event) {
            const files = Array.from(event.target.files);
            // ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ ŸÑŸÑŸÖŸÑŸÅ ÿßŸÑŸÅÿ±ÿØŸä: 10 MB (ŸÖÿπ ÿ∂ÿ∫ÿ∑ ÿ™ŸÑŸÇÿßÿ¶Ÿä)
            const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10 MB ŸÉÿ≠ÿØ ÿ£ŸÇÿµŸâ ŸÑŸÉŸÑ ŸÖŸÑŸÅ
            // ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ ŸÑŸÑŸÖÿ¨ŸÖŸàÿπ ÿßŸÑŸÉŸÑŸä: 10 MB (ŸÖÿπ ÿ∂ÿ∫ÿ∑ ÿ™ŸÑŸÇÿßÿ¶Ÿä)
            // ÿ™ÿ≠ÿ∞Ÿäÿ±: ÿ®ÿπÿØ base64 Ÿäÿµÿ®ÿ≠ ~13.3 MB - Ÿáÿ∞ÿß Ÿäÿ™ÿ¨ÿßŸàÿ≤ ÿ≠ÿØ Firestore (1 MB) ÿ®ÿ¥ŸÉŸÑ ŸÉÿ®Ÿäÿ±
            // ÿ≥Ÿäÿ™ŸÖ ÿ∂ÿ∫ÿ∑ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ŸÑÿ™ŸÇŸÑŸäŸÑ ÿßŸÑÿ≠ÿ¨ŸÖ
            const MAX_TOTAL_SIZE = 10 * 1024 * 1024; // 10 MB ŸÉÿ≠ÿØ ÿ£ŸÇÿµŸâ ŸÑŸÑŸÖÿ¨ŸÖŸàÿπ ÿßŸÑŸÉŸÑŸä
            
            // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ≠ÿ¨ŸÖ ÿßŸÑŸÉŸÑŸä ÿßŸÑÿ≠ÿßŸÑŸä
            let currentTotalSize = employeeDocumentsToUpload.reduce((sum, f) => sum + f.size, 0);
            const documentsList = document.getElementById('employeeDocumentsList');
            
            // ÿ•ÿ∏Ÿáÿßÿ± ÿ±ÿ≥ÿßŸÑÿ© ÿ™ÿ≠ŸÖŸäŸÑ
            const loadingMessage = document.createElement('div');
            loadingMessage.id = 'compressionLoading';
            loadingMessage.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 10000; text-align: center;';
            loadingMessage.innerHTML = '<div style="font-size: 16px; margin-bottom: 10px;">‚è≥ ÿ¨ÿßÿ±Ÿä ÿ∂ÿ∫ÿ∑ ÿßŸÑŸÖŸÑŸÅÿßÿ™...</div><div style="font-size: 12px; color: #666;">Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±</div>';
            document.body.appendChild(loadingMessage);
            
            try {
                for (const file of files) {
                    // ÿ∂ÿ∫ÿ∑ ÿßŸÑŸÖŸÑŸÅ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã
                    let processedFile = file;
                    const originalSize = file.size;
                    
                    try {
                        processedFile = await compressFile(file);
                        if (processedFile.size < originalSize) {
                            console.log(`‚úÖ ÿ™ŸÖ ÿ∂ÿ∫ÿ∑ "${file.name}": ${(originalSize / 1024).toFixed(2)} KB ‚Üí ${(processedFile.size / 1024).toFixed(2)} KB`);
                        }
                    } catch (error) {
                        console.warn(`‚ö†Ô∏è ŸÅÿ¥ŸÑ ÿ∂ÿ∫ÿ∑ "${file.name}"ÿå ÿ≥Ÿäÿ™ŸÖ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ£ÿµŸÑŸä:`, error);
                        processedFile = file;
                    }
                    
                    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ≠ÿ¨ŸÖ ÿßŸÑŸÖŸÑŸÅ ÿ®ÿπÿØ ÿßŸÑÿ∂ÿ∫ÿ∑
                    if (processedFile.size > MAX_FILE_SIZE) {
                        const fileSizeMB = (processedFile.size / (1024 * 1024)).toFixed(2);
                        const maxSizeMB = (MAX_FILE_SIZE / (1024 * 1024)).toFixed(2);
                        alert(`‚ö†Ô∏è ÿßŸÑŸÖŸÑŸÅ "${file.name}" ŸÉÿ®Ÿäÿ± ÿ¨ÿØÿßŸã ÿ≠ÿ™Ÿâ ÿ®ÿπÿØ ÿßŸÑÿ∂ÿ∫ÿ∑ (${fileSizeMB} MB)\n\nÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ ÿßŸÑŸÖÿ≥ŸÖŸàÿ≠ ÿ®Ÿá: ${maxSizeMB} MB\n\nÿßŸÑÿ±ÿ¨ÿßÿ° ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸÑŸÅ ÿ£ÿµÿ∫ÿ±.`);
                        continue;
                    }
                    
                    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ≠ÿ¨ŸÖ ÿßŸÑŸÉŸÑŸä (ŸÖÿπ ŸÖÿ±ÿßÿπÿßÿ© ÿ£ŸÜ base64 Ÿäÿ≤ŸäÿØ ÿßŸÑÿ≠ÿ¨ŸÖ ÿ®ŸÜÿ≥ÿ®ÿ© 33%)
                    const estimatedSize = processedFile.size * 1.33; // ÿ™ŸÇÿØŸäÿ± ÿ≠ÿ¨ŸÖ base64
                    if ((currentTotalSize * 1.33) + estimatedSize > MAX_TOTAL_SIZE) {
                        const totalSizeMB = (((currentTotalSize + processedFile.size) * 1.33) / (1024 * 1024)).toFixed(2);
                        const maxTotalSizeMB = (MAX_TOTAL_SIZE / (1024 * 1024)).toFixed(2);
                        alert(`‚ö†Ô∏è ÿ•ÿ¨ŸÖÿßŸÑŸä ÿ≠ÿ¨ŸÖ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ŸÉÿ®Ÿäÿ± ÿ¨ÿØÿßŸã (${totalSizeMB} MB ÿ®ÿπÿØ ÿßŸÑÿ™ÿ≠ŸàŸäŸÑ)\n\nÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ ÿßŸÑŸÖÿ≥ŸÖŸàÿ≠ ÿ®Ÿá: ${maxTotalSizeMB} MB\n\nÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿ≤ÿßŸÑÿ© ÿ®ÿπÿ∂ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿ£Ÿà ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸÑŸÅÿßÿ™ ÿ£ÿµÿ∫ÿ±.`);
                        continue;
                    }
                    
                    employeeDocumentsToUpload.push(processedFile);
                    currentTotalSize += processedFile.size; // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ≠ÿ¨ŸÖ ÿßŸÑŸÉŸÑŸä
                    
                    const docCard = document.createElement('div');
                    docCard.className = 'document-card';
                    docCard.style.cssText = 'border: 2px solid #e9ecef; border-radius: 8px; padding: 15px; background: #f8f9fa; position: relative;';
                    const fileName = processedFile.name.length > 20 ? processedFile.name.substring(0, 20) + '...' : processedFile.name;
                    const fileSizeKB = (processedFile.size / 1024).toFixed(2);
                    const fileSizeMB = (processedFile.size / (1024 * 1024)).toFixed(2);
                    const maxSizeKB = 10240; // 10 MB
                    const isLargeFile = processedFile.size > maxSizeKB * 1024;
                    const sizeColor = isLargeFile ? '#dc3545' : '#666';
                    const warningIcon = isLargeFile ? '‚ö†Ô∏è ' : '';
                    const compressionInfo = processedFile.size < originalSize ? 
                        `<br><span style="color: #28a745; font-size: 11px;">‚úì ÿ™ŸÖ ÿßŸÑÿ∂ÿ∫ÿ∑: ${((1 - processedFile.size / originalSize) * 100).toFixed(1)}% ÿ™ŸÇŸÑŸäŸÑ</span>` : '';
                    
                    docCard.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 24px;">üìé</span>
                            <div style="flex: 1;">
                                <div style="font-weight: bold; color: #333;">${fileName}</div>
                                <div style="font-size: 12px; color: ${sizeColor};">
                                    ${warningIcon}${fileSizeKB} KB ${processedFile.size > 1024 * 1024 ? `(${fileSizeMB} MB)` : ''}
                                    ${compressionInfo}
                                    ${isLargeFile ? '<br><span style="color: #dc3545; font-size: 11px;">‚ö†Ô∏è ÿ≠ÿ¨ŸÖ ŸÉÿ®Ÿäÿ± - ŸÇÿØ Ÿäÿ≥ÿ®ÿ® ŸÖÿ¥ÿßŸÉŸÑ</span>' : ''}
                                </div>
                            </div>
                            <button onclick="removeDocumentFromList('${processedFile.name}')" style="background: #dc3545; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; font-size: 14px; line-height: 1;">√ó</button>
                        </div>
                    `;
                    documentsList.appendChild(docCard);
                }
            } finally {
                // ÿ•ÿ≤ÿßŸÑÿ© ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ
                const loadingElement = document.getElementById('compressionLoading');
                if (loadingElement) {
                    loadingElement.remove();
                }
            }
        }

        function removeDocumentFromList(fileName) {
            employeeDocumentsToUpload = employeeDocumentsToUpload.filter(f => f.name !== fileName);
            const documentsList = document.getElementById('employeeDocumentsList');
            documentsList.innerHTML = '';
            employeeDocumentsToUpload.forEach(file => {
                const docCard = document.createElement('div');
                docCard.className = 'document-card';
                docCard.style.cssText = 'border: 2px solid #e9ecef; border-radius: 8px; padding: 15px; background: #f8f9fa; position: relative;';
                const displayName = file.name.length > 20 ? file.name.substring(0, 20) + '...' : file.name;
                const fileSizeKB = (file.size / 1024).toFixed(2);
                const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
                const maxSizeKB = 1024; // 1 MB
                const isLargeFile = file.size > maxSizeKB * 1024;
                const sizeColor = isLargeFile ? '#dc3545' : '#666';
                const warningIcon = isLargeFile ? '‚ö†Ô∏è ' : '';
                // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿßŸÑÿµŸàÿ±ÿ© ŸÖÿ∂ÿ∫Ÿàÿ∑ÿ© (ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ŸÖŸÜ ŸÜŸàÿπ jpeg ŸàŸÉÿßŸÜÿ™ ÿ£ÿµÿ∫ÿ± ŸÖŸÜ 500KBÿå ŸÅŸÖŸÜ ÿßŸÑŸÖÿ≠ÿ™ŸÖŸÑ ÿ£ŸÜŸáÿß ŸÖÿ∂ÿ∫Ÿàÿ∑ÿ©)
                const isCompressed = file.type === 'image/jpeg' && file.size < 500 * 1024;
                const compressionBadge = isCompressed ? '<br><span style="color: #28a745; font-size: 11px;">‚úì ŸÖÿ∂ÿ∫Ÿàÿ∑</span>' : '';
                
                docCard.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 24px;">üìé</span>
                        <div style="flex: 1;">
                            <div style="font-weight: bold; color: #333;">${displayName}</div>
                            <div style="font-size: 12px; color: ${sizeColor};">
                                ${warningIcon}${fileSizeKB} KB ${file.size > 1024 * 1024 ? `(${fileSizeMB} MB)` : ''}
                                ${compressionBadge}
                                ${isLargeFile ? '<br><span style="color: #dc3545; font-size: 11px;">‚ö†Ô∏è ÿ≠ÿ¨ŸÖ ŸÉÿ®Ÿäÿ± - ŸÇÿØ Ÿäÿ≥ÿ®ÿ® ŸÖÿ¥ÿßŸÉŸÑ</span>' : ''}
                            </div>
                        </div>
                        <button onclick="removeDocumentFromList('${file.name}')" style="background: #dc3545; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; font-size: 14px; line-height: 1;">√ó</button>
                    </div>
                `;
                documentsList.appendChild(docCard);
            });
        }

        async function uploadEmployeeDocuments(employeeId) {
            if (employeeDocumentsToUpload.length === 0) return [];
            
            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖÿ≥ÿ¨ŸÑ ÿØÿÆŸàŸÑ
            if (!currentUser) {
                alert('‚ö†Ô∏è Ÿäÿ¨ÿ® ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã');
                return [];
            }
            
            // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ≠ÿ¨ŸÖ ÿßŸÑŸÉŸÑŸä ŸÑŸÑŸÖŸÑŸÅÿßÿ™ (base64 Ÿäÿ≤ŸäÿØ ÿßŸÑÿ≠ÿ¨ŸÖ ÿ®ŸÜÿ≥ÿ®ÿ© 33%)
            const totalSize = employeeDocumentsToUpload.reduce((sum, file) => sum + file.size, 0);
            const estimatedBase64Size = totalSize * 1.33; // ÿ™ŸÇÿØŸäÿ± ÿ≠ÿ¨ŸÖ base64
            
            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ≠ÿ¨ŸÖ ÿßŸÑŸÉŸÑŸä (ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ 10 MB - ÿ®ÿπÿØ base64 Ÿäÿµÿ®ÿ≠ ~13.3 MB)
            // ÿ™ÿ≠ÿ∞Ÿäÿ±: Ÿáÿ∞ÿß Ÿäÿ™ÿ¨ÿßŸàÿ≤ ÿ≠ÿØ Firestore (1 MB) ÿ®ÿ¥ŸÉŸÑ ŸÉÿ®Ÿäÿ±
            // ÿ≥Ÿäÿ™ŸÖ ÿ∂ÿ∫ÿ∑ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ŸÑÿ™ŸÇŸÑŸäŸÑ ÿßŸÑÿ≠ÿ¨ŸÖ
            const MAX_TOTAL_SIZE = 10 * 1024 * 1024; // 10 MB
            if (estimatedBase64Size > MAX_TOTAL_SIZE) {
                const totalSizeMB = (estimatedBase64Size / (1024 * 1024)).toFixed(2);
                const maxSizeMB = (MAX_TOTAL_SIZE / (1024 * 1024)).toFixed(2);
                alert(`‚ö†Ô∏è ÿ•ÿ¨ŸÖÿßŸÑŸä ÿ≠ÿ¨ŸÖ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ŸÉÿ®Ÿäÿ± ÿ¨ÿØÿßŸã (${totalSizeMB} MB ÿ®ÿπÿØ ÿßŸÑÿ™ÿ≠ŸàŸäŸÑ)\n\nÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ ÿßŸÑŸÖÿ≥ŸÖŸàÿ≠ ÿ®Ÿá: ${maxSizeMB} MB\n\nÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿ≤ÿßŸÑÿ© ÿ®ÿπÿ∂ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿ£Ÿà ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸÑŸÅÿßÿ™ ÿ£ÿµÿ∫ÿ±.\n\nŸÖŸÑÿßÿ≠ÿ∏ÿ©: ÿ≠ÿ¨ŸÖ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿ®ÿπÿØ ÿßŸÑÿ™ÿ≠ŸàŸäŸÑ ÿ•ŸÑŸâ base64 ÿ≥ŸäŸÉŸàŸÜ ÿ£ŸÉÿ®ÿ± ÿ®ŸÜÿ≥ÿ®ÿ© 33%`);
                return [];
            }
            
            // ÿ™ÿ≠ÿ∞Ÿäÿ± ÿ•ÿ∂ÿßŸÅŸä ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿ≠ÿ¨ŸÖ ÿßŸÑŸÖŸÇÿØÿ± ÿ®ÿπÿØ base64 Ÿäÿ™ÿ¨ÿßŸàÿ≤ 1 MB (ÿ≠ÿØ Firestore)
            if (estimatedBase64Size > 1 * 1024 * 1024) {
                const totalSizeMB = (estimatedBase64Size / (1024 * 1024)).toFixed(2);
                const confirmed = confirm(`‚ö†Ô∏è ÿ™ÿ≠ÿ∞Ÿäÿ± ŸÖŸáŸÖ: ÿ•ÿ¨ŸÖÿßŸÑŸä ÿ≠ÿ¨ŸÖ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿ®ÿπÿØ ÿßŸÑÿ™ÿ≠ŸàŸäŸÑ ÿ≥ŸäŸÉŸàŸÜ ${totalSizeMB} MB\n\nŸáÿ∞ÿß Ÿäÿ™ÿ¨ÿßŸàÿ≤ ÿ≠ÿØ Firestore (1 MB) ÿ®ÿ¥ŸÉŸÑ ŸÉÿ®Ÿäÿ± ŸàŸÇÿØ Ÿäÿ≥ÿ®ÿ® ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ≠ŸÅÿ∏.\n\nŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ© ÿπŸÑŸâ ÿ£Ÿä ÿ≠ÿßŸÑÿü\n\n‚ö†Ô∏è ÿ™ÿ≠ÿ∞Ÿäÿ±: ŸÇÿØ ŸäŸÅÿ¥ŸÑ ÿßŸÑÿ≠ŸÅÿ∏ ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿ≠ÿ¨ŸÖ ÿßŸÑŸÜŸáÿßÿ¶Ÿä ÿ£ŸÉÿ®ÿ± ŸÖŸÜ 1 MB.\n\nŸÜÿµŸäÿ≠ÿ©: ŸäŸèŸÅÿ∂ŸÑ ÿ™ŸÇŸÑŸäŸÑ ÿπÿØÿØ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿ£Ÿà ÿ≠ÿ¨ŸÖŸáÿß ŸÑÿ™ÿ¨ŸÜÿ® ÿßŸÑŸÖÿ¥ÿßŸÉŸÑ.`);
                if (!confirmed) {
                    return [];
                }
            }
            
            const uploadedDocs = [];
            for (const file of employeeDocumentsToUpload) {
                try {
                    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ≠ÿ¨ŸÖ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑŸÅÿ±ÿØŸä (10 MB ŸÉÿ≠ÿØ ÿ£ŸÇÿµŸâ)
                    const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10 MB
                    if (file.size > MAX_FILE_SIZE) {
                        const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
                        const maxSizeMB = (MAX_FILE_SIZE / (1024 * 1024)).toFixed(2);
                        alert(`‚ö†Ô∏è ÿßŸÑŸÖŸÑŸÅ "${file.name}" ŸÉÿ®Ÿäÿ± ÿ¨ÿØÿßŸã (${fileSizeMB} MB)\n\nÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ ÿßŸÑŸÖÿ≥ŸÖŸàÿ≠ ÿ®Ÿá: ${maxSizeMB} MB\n\nÿ≥Ÿäÿ™ŸÖ ÿ™ÿÆÿ∑Ÿä Ÿáÿ∞ÿß ÿßŸÑŸÖŸÑŸÅ.`);
                        continue;
                    }
                    
                    // ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑŸÖŸÑŸÅ ÿ•ŸÑŸâ base64
                    const base64String = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    });
                    
                    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ≠ÿ¨ŸÖ base64 ÿßŸÑŸÅÿπŸÑŸä
                    const base64Size = new Blob([base64String]).size;
                    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ≠ÿ¨ŸÖ base64 - Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ ÿ£ŸÇŸÑ ŸÖŸÜ 1 MB (ÿ≠ÿØ Firestore)
                    const MAX_BASE64_SIZE = 1 * 1024 * 1024; // 1 MB ŸÉÿ≠ÿØ ÿ£ŸÇÿµŸâ ŸÑŸÄ base64 (ÿ≠ÿØ Firestore)
                    if (base64Size > MAX_BASE64_SIZE) {
                        const base64SizeMB = (base64Size / (1024 * 1024)).toFixed(2);
                        alert(`‚ö†Ô∏è ÿßŸÑŸÖŸÑŸÅ "${file.name}" ŸÉÿ®Ÿäÿ± ÿ¨ÿØÿßŸã ÿ®ÿπÿØ ÿßŸÑÿ™ÿ≠ŸàŸäŸÑ ÿ•ŸÑŸâ base64 (${base64SizeMB} MB)\n\nÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ ÿßŸÑŸÖÿ≥ŸÖŸàÿ≠ ÿ®Ÿá: 1 MB (ÿ≠ÿØ Firestore)\n\nÿ≥Ÿäÿ™ŸÖ ÿ™ÿÆÿ∑Ÿä Ÿáÿ∞ÿß ÿßŸÑŸÖŸÑŸÅ.\n\nŸÜÿµŸäÿ≠ÿ©: ŸÇŸÖ ÿ®ÿ∂ÿ∫ÿ∑ ÿßŸÑŸÖŸÑŸÅ ÿ£Ÿà ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸÑŸÅ ÿ£ÿµÿ∫ÿ±.`);
                        continue;
                    }
                    
                    uploadedDocs.push({
                        name: file.name,
                        data: base64String, // ÿ≠ŸÅÿ∏ base64 ÿ®ÿØŸÑÿßŸã ŸÖŸÜ URL
                        type: file.type || 'application/octet-stream',
                        size: file.size,
                        uploadedAt: new Date().toISOString(),
                        uploadedBy: currentUser.uid || 'system'
                    });
                    
                    console.log(`‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØ ÿ•ŸÑŸâ base64: ${file.name} (${(file.size / 1024).toFixed(2)} KB ‚Üí ${(base64Size / 1024).toFixed(2)} KB)`);
                    
                    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ≠ÿ¨ŸÖ ÿßŸÑŸÉŸÑŸä ŸÑŸÑŸÖÿ≥ÿ™ŸÜÿØÿßÿ™ ÿ®ÿπÿØ ÿ•ÿ∂ÿßŸÅÿ© Ÿáÿ∞ÿß ÿßŸÑŸÖŸÑŸÅ
                    const totalDocsSize = uploadedDocs.reduce((sum, doc) => {
                        return sum + new Blob([doc.data]).size;
                    }, 0);
                    
                    // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿ≠ÿ¨ŸÖ ÿßŸÑŸÉŸÑŸä Ÿäÿ™ÿ¨ÿßŸàÿ≤ 900 KB (ŸÑÿ™ÿ±ŸÉ ŸÖÿ≥ÿßÿ≠ÿ© ŸÑŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ£ÿÆÿ±Ÿâ)ÿå ŸÜÿ≠ÿßŸàŸÑ ÿ∂ÿ∫ÿ∑ ÿ£ŸÉÿ´ÿ±
                    const WARNING_SIZE = 900 * 1024; // 900 KB
                    if (totalDocsSize > WARNING_SIZE && totalDocsSize <= MAX_BASE64_SIZE) {
                        // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÇÿ±Ÿäÿ®ÿßŸã ŸÖŸÜ ÿßŸÑÿ≠ÿØÿå ŸÜÿ≠ÿßŸàŸÑ ÿ∂ÿ∫ÿ∑ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑŸÖÿ∂ÿßŸÅÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ
                        console.log('‚ö†Ô∏è ÿßŸÑÿ≠ÿ¨ŸÖ ŸÇÿ±Ÿäÿ® ŸÖŸÜ ÿßŸÑÿ≠ÿØÿå ŸÖÿ≠ÿßŸàŸÑÿ© ÿ∂ÿ∫ÿ∑ ÿ•ÿ∂ÿßŸÅŸä...');
                    }
                    
                    // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿ≠ÿ¨ŸÖ ÿßŸÑŸÉŸÑŸä Ÿäÿ™ÿ¨ÿßŸàÿ≤ 1 MBÿå ŸÜŸàŸÇŸÅ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿ≤ŸäÿØ
                    if (totalDocsSize > MAX_BASE64_SIZE) {
                        const totalSizeMB = (totalDocsSize / (1024 * 1024)).toFixed(2);
                        alert(`‚ö†Ô∏è ÿ™ÿ≠ÿ∞Ÿäÿ±: ÿ•ÿ¨ŸÖÿßŸÑŸä ÿ≠ÿ¨ŸÖ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿ®ÿπÿØ ÿ•ÿ∂ÿßŸÅÿ© "${file.name}" ÿ≥ŸäŸÉŸàŸÜ ${totalSizeMB} MB\n\nŸáÿ∞ÿß Ÿäÿ™ÿ¨ÿßŸàÿ≤ ÿ≠ÿØ Firestore (1 MB).\n\nÿ≥Ÿäÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑŸÖÿ∂ÿßŸÅÿ© ÿ≠ÿ™Ÿâ ÿßŸÑÿ¢ŸÜ ŸÅŸÇÿ∑.\n\nÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ© ŸÑŸÜ Ÿäÿ™ŸÖ ÿ≠ŸÅÿ∏Ÿáÿß.\n\nŸÜÿµŸäÿ≠ÿ©: ŸÇŸÖ ÿ®ÿ≠ÿ∞ŸÅ ÿ®ÿπÿ∂ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑŸÇÿØŸäŸÖÿ© ÿ£Ÿà ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸÑŸÅÿßÿ™ ÿ£ÿµÿ∫ÿ±.`);
                        break; // ÿ•ŸäŸÇÿßŸÅ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿ≤ŸäÿØ ŸÖŸÜ ÿßŸÑŸÖŸÑŸÅÿßÿ™
                    }
                } catch (error) {
                    console.error(`‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØ ${file.name}:`, error);
                    alert(`ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØ: ${file.name} - ${error.message}`);
                }
            }
            
            if (uploadedDocs.length === 0) {
                alert('‚ö†Ô∏è ŸÑŸÖ Ÿäÿ™ŸÖ ÿ±ŸÅÿπ ÿ£Ÿä ŸÖŸÑŸÅ. ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿ£ÿµÿ∫ÿ± ŸÖŸÜ 10 MB ŸÑŸÉŸÑ ŸÖŸÑŸÅ.');
            }
            
            return uploadedDocs;
        }

        // ============================================
        // ÿØŸàÿßŸÑ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ±ÿßÿ™ÿ® ÿßŸÑŸÖÿ≠ŸÖŸä
        // ============================================
        function showSalaryField(type) {
            const password = prompt('ÿ£ÿØÿÆŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ŸÑÿπÿ±ÿ∂/ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ±ÿßÿ™ÿ®:');
            if (password !== SALARY_PASSWORD) {
                alert('ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©');
                return;
            }
            
            const fieldId = type === 'initial' ? 'empInitialSalary' : 'empCurrentSalary';
            const currencyId = type === 'initial' ? 'empInitialSalaryCurrency' : 'empCurrentSalaryCurrency';
            const field = document.getElementById(fieldId);
            const currencyField = document.getElementById(currencyId);
            
            if (field) {
                field.type = 'number';
                field.readOnly = false;
                field.placeholder = 'ÿ£ÿØÿÆŸÑ ÿßŸÑÿ±ÿßÿ™ÿ®';
                const savedValue = field.getAttribute('data-salary-value');
                if (savedValue) {
                    field.value = savedValue;
                }
                field.focus();
            }
            
            if (currencyField) {
                currencyField.disabled = false;
            }
        }

        // ============================================
        // ÿØŸàÿßŸÑ ÿ•ÿØÿßÿ±ÿ© ÿ¨Ÿáÿßÿ™ ÿßŸÑÿßÿ™ÿµÿßŸÑ
        // ============================================
        function addContact() {
            const name = prompt('ÿßÿ≥ŸÖ ÿ¨Ÿáÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ:');
            if (!name) return;
            
            const relationship = prompt('ÿµŸÑÿ© ÿßŸÑŸÇÿ±ÿßÿ®ÿ© (ŸÖÿ´ŸÑ: ÿ≤Ÿàÿ¨/ÿ≤Ÿàÿ¨ÿ©ÿå ÿ£ÿ®ÿå ÿ£ŸÖÿå ÿ£ÿÆÿå ÿ£ÿÆÿ™ÿå ÿ•ŸÑÿÆ):');
            if (!relationship) return;
            
            const phone = prompt('ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ:');
            const address = prompt('ÿßŸÑÿπŸÜŸàÿßŸÜ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä):') || '';
            
            const contact = {
                id: 'contact_' + Date.now(),
                name: name,
                relationship: relationship,
                phone: phone || '',
                address: address
            };
            
            employeeContacts.push(contact);
            displayContacts();
        }

        function removeContact(contactId) {
            if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞Ÿá ÿ¨Ÿáÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑÿü')) return;
            employeeContacts = employeeContacts.filter(c => c.id !== contactId);
            displayContacts();
        }

        function displayContacts() {
            const container = document.getElementById('employeeContactsList');
            if (!container) return;
            
            if (employeeContacts.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center; padding: 20px; grid-column: 1/-1;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ¨Ÿáÿßÿ™ ÿßÿ™ÿµÿßŸÑ</p>';
                return;
            }
            
            container.innerHTML = employeeContacts.map(contact => `
                <div style="border: 2px solid #e9ecef; border-radius: 8px; padding: 15px; background: #f8f9fa; position: relative;">
                    <button onclick="removeContact('${contact.id}')" style="position: absolute; top: 10px; left: 10px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; font-size: 14px; line-height: 1;">√ó</button>
                    <div style="margin-bottom: 10px;">
                        <div style="font-weight: bold; color: #667eea; margin-bottom: 5px;">${contact.name}</div>
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">
                            <strong>ÿµŸÑÿ© ÿßŸÑŸÇÿ±ÿßÿ®ÿ©:</strong> ${contact.relationship}
                        </div>
                        ${contact.phone ? `<div style="font-size: 12px; color: #666; margin-bottom: 5px;"><strong>ÿßŸÑŸáÿßÿ™ŸÅ:</strong> ${contact.phone}</div>` : ''}
                        ${contact.address ? `<div style="font-size: 12px; color: #666;"><strong>ÿßŸÑÿπŸÜŸàÿßŸÜ:</strong> ${contact.address}</div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // ============================================
        // ÿØŸàÿßŸÑ ÿ•ÿØÿßÿ±ÿ© ÿ≥ÿ¨ŸÑ ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ
        // ============================================
        function showAddProjectToHistoryForm() {
            const modal = document.getElementById('addProjectToHistoryModal');
            if (!modal) return;
            
            const select = document.getElementById('historyProjectSelect');
            select.innerHTML = '<option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ</option>';
            projectsData.forEach(proj => {
                const option = document.createElement('option');
                option.value = proj.id;
                option.textContent = `${proj.code || ''} - ${proj.name || ''}`;
                select.appendChild(option);
            });
            
            document.getElementById('historyProjectStartDate').value = '';
            document.getElementById('historyProjectIsCurrent').checked = true;
            document.getElementById('historyProjectEndDateGroup').style.display = 'none';
            
            modal.classList.add('active');
        }

        function hideAddProjectToHistoryForm() {
            const modal = document.getElementById('addProjectToHistoryModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        function toggleProjectEndDate() {
            const isCurrent = document.getElementById('historyProjectIsCurrent').checked;
            const endDateGroup = document.getElementById('historyProjectEndDateGroup');
            if (isCurrent) {
                endDateGroup.style.display = 'none';
                document.getElementById('historyProjectEndDate').value = '';
            } else {
                endDateGroup.style.display = 'block';
            }
        }

        function addProjectToHistory() {
            const projectId = document.getElementById('historyProjectSelect').value;
            const startDate = document.getElementById('historyProjectStartDate').value;
            const isCurrent = document.getElementById('historyProjectIsCurrent').checked;
            const endDate = document.getElementById('historyProjectEndDate').value;
            
            if (!projectId || !startDate) {
                alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ Ÿàÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ®ÿØÿ°');
                return;
            }
            
            const project = projectsData.find(p => p.id === projectId);
            if (!project) {
                alert('ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ');
                return;
            }
            
            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ŸÖÿ¥ÿßÿ±Ÿäÿπ ÿ≠ÿßŸÑŸäÿ© ÿ®ÿØŸàŸÜ ÿ™ÿßÿ±ŸäÿÆ ÿßŸÜÿ™Ÿáÿßÿ°
            const currentProjects = employeeProjectsHistory.filter(p => p.isCurrent);
            
            if (currentProjects.length > 0 && isCurrent) {
                // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸáŸÜÿßŸÉ ŸÖÿ¥ÿßÿ±Ÿäÿπ ÿ≠ÿßŸÑŸäÿ© ŸàÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ÿßŸÑÿ¨ÿØŸäÿØ ÿ£Ÿäÿ∂ÿßŸã ÿ≠ÿßŸÑŸäÿßŸãÿå ŸÜÿ≥ÿ£ŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
                const currentProjectsNames = currentProjects.map(p => p.projectName).join('ÿå ');
                const newProjectName = project.name;
                
                const userChoice = confirm(
                    `‚ö†Ô∏è ŸäŸàÿ¨ÿØ ${currentProjects.length} ŸÖÿ¥ÿ±Ÿàÿπ(ÿßÿ™) ÿ≠ÿßŸÑŸäÿ© ÿ®ÿØŸàŸÜ ÿ™ÿßÿ±ŸäÿÆ ÿßŸÜÿ™Ÿáÿßÿ°:\n\n` +
                    `ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ ÿßŸÑÿ≠ÿßŸÑŸäÿ©: ${currentProjectsNames}\n\n` +
                    `ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ÿßŸÑÿ¨ÿØŸäÿØ: ${newProjectName}\n\n` +
                    `ŸáŸÑ ÿßŸÑŸÖŸàÿ∏ŸÅ ŸäÿπŸÖŸÑ ŸÅŸä ÿßŸÑŸÖÿ¥ÿ±ŸàÿπŸäŸÜ ŸÖÿπÿßŸãÿü\n\n` +
                    `‚Ä¢ ÿßÿ∂ÿ∫ÿ∑ "ŸÖŸàÿßŸÅŸÇ" ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑŸÖŸàÿ∏ŸÅ ŸäÿπŸÖŸÑ ŸÅŸä ÿßŸÑŸÖÿ¥ÿ±ŸàÿπŸäŸÜ ŸÖÿπÿßŸã\n` +
                    `‚Ä¢ ÿßÿ∂ÿ∫ÿ∑ "ÿ•ŸÑÿ∫ÿßÿ°" ÿ•ÿ∞ÿß ÿßŸÜÿ™ŸÇŸÑ ÿßŸÑŸÖŸàÿ∏ŸÅ ŸÖŸÜ ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ ÿßŸÑÿ≥ÿßÿ®ŸÇÿ© ÿ•ŸÑŸâ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ÿßŸÑÿ¨ÿØŸäÿØ`
                );
                
                if (userChoice) {
                    // ÿßŸÑŸÖŸàÿ∏ŸÅ ŸäÿπŸÖŸÑ ŸÅŸä ÿßŸÑŸÖÿ¥ÿ±ŸàÿπŸäŸÜ ŸÖÿπÿßŸã - ŸÜÿ∂ŸäŸÅ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ÿßŸÑÿ¨ÿØŸäÿØ ÿ®ÿØŸàŸÜ ÿ•ŸÜŸáÿßÿ° ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ ÿßŸÑÿ≥ÿßÿ®ŸÇÿ©
                    // ŸÑÿß ŸÜŸÅÿπŸÑ ÿ¥Ÿäÿ¶ÿßŸã ŸÑŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ ÿßŸÑÿ≥ÿßÿ®ŸÇÿ©
                } else {
                    // ÿßŸÑŸÖŸàÿ∏ŸÅ ÿßŸÜÿ™ŸÇŸÑ - ŸÜÿ≥ÿ£ŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿπŸÜ ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ° ŸÑŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ ÿßŸÑÿ≥ÿßÿ®ŸÇÿ©
                    const endDateInput = prompt(
                        `ÿßŸÑŸÖŸàÿ∏ŸÅ ÿßŸÜÿ™ŸÇŸÑ ŸÖŸÜ ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ ÿßŸÑÿ≥ÿßÿ®ŸÇÿ© ÿ•ŸÑŸâ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ÿßŸÑÿ¨ÿØŸäÿØ.\n\n` +
                        `ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ ÿßŸÑÿ≥ÿßÿ®ŸÇÿ©: ${currentProjectsNames}\n\n` +
                        `ÿ™ÿßÿ±ŸäÿÆ ÿ®ÿØÿ° ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ÿßŸÑÿ¨ÿØŸäÿØ: ${startDate}\n\n` +
                        `ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ° ŸÑŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ ÿßŸÑÿ≥ÿßÿ®ŸÇÿ© (YYYY-MM-DD):\n` +
                        `(ÿßÿ™ÿ±ŸÉŸá ŸÅÿßÿ±ÿ∫ÿßŸã ŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿ™ÿßÿ±ŸäÿÆ: ${new Date(new Date(startDate).setDate(new Date(startDate).getDate() - 1)).toISOString().split('T')[0]})`
                    );
                    
                    let endDateForPrevious;
                    if (endDateInput && endDateInput.trim()) {
                        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµÿ≠ÿ© ÿßŸÑÿ™ÿßÿ±ŸäÿÆ
                        const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
                        if (!dateRegex.test(endDateInput.trim())) {
                            alert('‚ö†Ô∏è ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠. Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ ÿ®ÿßŸÑÿµŸäÿ∫ÿ© YYYY-MM-DD');
                            return;
                        }
                        endDateForPrevious = endDateInput.trim();
                    } else {
                        // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä (ŸäŸàŸÖ ŸÇÿ®ŸÑ ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ®ÿØÿ° ÿßŸÑÿ¨ÿØŸäÿØ)
                        const defaultEndDate = new Date(startDate);
                        defaultEndDate.setDate(defaultEndDate.getDate() - 1);
                        endDateForPrevious = defaultEndDate.toISOString().split('T')[0];
                    }
                    
                    // ÿ•ŸÜŸáÿßÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ ÿßŸÑÿ≥ÿßÿ®ŸÇÿ© ÿ®ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖÿ≠ÿØÿØ
                    currentProjects.forEach(currentProj => {
                        currentProj.endDate = endDateForPrevious;
                        currentProj.isCurrent = false;
                    });
                }
            } else if (currentProjects.length > 0 && !isCurrent) {
                // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ÿßŸÑÿ¨ÿØŸäÿØ ŸÑŸäÿ≥ ÿ≠ÿßŸÑŸäÿßŸãÿå ŸÑÿß ŸÜÿ≠ÿ™ÿßÿ¨ ŸÑŸÑÿ≥ÿ§ÿßŸÑ
                // ŸÜŸÜŸáŸä ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ ÿßŸÑÿ≥ÿßÿ®ŸÇÿ© ŸÅŸÇÿ∑ ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ®ÿØÿ° ÿßŸÑÿ¨ÿØŸäÿØ ÿ®ÿπÿØ ÿ™ÿßÿ±ŸäÿÆ ÿ®ÿØÿ° ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ ÿßŸÑÿ≥ÿßÿ®ŸÇÿ©
                currentProjects.forEach(currentProj => {
                    const currentStartDate = new Date(currentProj.startDate);
                    const newStartDate = new Date(startDate);
                    
                    if (newStartDate > currentStartDate) {
                        const endDateForPrevious = new Date(startDate);
                        endDateForPrevious.setDate(endDateForPrevious.getDate() - 1);
                        currentProj.endDate = endDateForPrevious.toISOString().split('T')[0];
                        currentProj.isCurrent = false;
                    }
                });
            }
            
            const projectHistory = {
                id: 'proj_' + Date.now(),
                projectId: projectId,
                projectCode: project.code || '',
                projectName: project.name,
                startDate: startDate,
                endDate: isCurrent ? null : endDate,
                isCurrent: isCurrent
            };
            
            employeeProjectsHistory.push(projectHistory);
            displayProjectsHistory();
            hideAddProjectToHistoryForm();
        }

        function displayProjectsHistory() {
            const container = document.getElementById('projectsHistoryList');
            if (!container) return;
            
            if (employeeProjectsHistory.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ¥ÿßÿ±Ÿäÿπ ŸÖÿ≥ÿ¨ŸÑÿ©</p>';
                return;
            }
            
            const sortedProjects = [...employeeProjectsHistory].sort((a, b) => {
                return new Date(b.startDate) - new Date(a.startDate);
            });
            
            container.innerHTML = sortedProjects.map(proj => {
                const status = proj.isCurrent ? 'ŸäÿπŸÖŸÑ ÿ≠ÿßŸÑŸäÿßŸã' : 'ŸÖŸÜÿ™ŸáŸä';
                const statusColor = proj.isCurrent ? '#28a745' : '#6c757d';
                return `
                    <div style="border: 2px solid #e9ecef; border-radius: 8px; padding: 15px; background: #f8f9fa; position: relative;">
                        <button onclick="removeProjectFromHistory('${proj.id}')" style="position: absolute; top: 10px; left: 10px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; font-size: 14px; line-height: 1;" title="ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ">√ó</button>
                        <div style="margin-bottom: 10px;">
                            <div style="font-weight: bold; color: #667eea; margin-bottom: 5px;">${proj.projectCode || ''}</div>
                            <div style="font-weight: bold; color: #333; margin-bottom: 5px;">${proj.projectName}</div>
                        </div>
                        <div style="font-size: 12px; color: #666; margin-bottom: 10px;">
                            <div><strong>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ®ÿØÿ°:</strong> ${proj.startDate}</div>
                            <div><strong>${proj.isCurrent ? 'ÿßŸÑÿ≠ÿßŸÑÿ©:' : 'ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ°:'}</strong> ${proj.isCurrent ? 'ŸäÿπŸÖŸÑ ÿ≠ÿßŸÑŸäÿßŸã' : proj.endDate}</div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                            <span style="background: ${statusColor}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: bold; display: inline-block;">${status}</span>
                            ${proj.isCurrent ? `<button onclick="endProjectFromHistory('${proj.id}')" style="background: #ffc107; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold;" title="ÿ•ŸÜŸáÿßÿ° ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ">ÿ•ŸÜŸáÿßÿ° ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function removeProjectFromHistory(projectId) {
            if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ŸÖŸÜ ÿßŸÑÿ≥ÿ¨ŸÑÿü')) return;
            employeeProjectsHistory = employeeProjectsHistory.filter(p => p.id !== projectId);
            displayProjectsHistory();
        }
        
        // ŸÖÿ™ÿ∫Ÿäÿ± ŸÑÿ™ÿÆÿ≤ŸäŸÜ ŸÖÿπÿ±ŸÅ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ÿßŸÑŸÖÿ±ÿßÿØ ÿ•ŸÜŸáÿßÿ§Ÿá
        let projectToEndId = null;
        
        // ÿ•ŸÜŸáÿßÿ° ŸÖÿ¥ÿ±Ÿàÿπ ÿ≠ÿßŸÑŸäÿßŸã (ÿ®ÿØŸàŸÜ ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ¥ÿ±Ÿàÿπ ÿ¨ÿØŸäÿØ)
        function endProjectFromHistory(projectId) {
            const project = employeeProjectsHistory.find(p => p.id === projectId);
            if (!project || !project.isCurrent) {
                alert('ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ ÿ£Ÿà ÿ∫Ÿäÿ± ÿ≠ÿßŸÑŸäÿßŸã');
                return;
            }
            
            projectToEndId = projectId;
            
            // ÿπÿ±ÿ∂ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ŸÅŸä ÿßŸÑŸÜÿßŸÅÿ∞ÿ©
            const projectInfo = document.getElementById('endProjectInfo');
            projectInfo.innerHTML = `
                <div style="margin-bottom: 10px;">
                    <strong style="color: #667eea; font-size: 16px;">${project.projectCode || ''} - ${project.projectName}</strong>
                </div>
                <div style="font-size: 14px; color: #666;">
                    <div><strong>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ®ÿØÿ°:</strong> ${project.startDate}</div>
                    <div style="margin-top: 5px;"><strong>ÿßŸÑÿ≠ÿßŸÑÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©:</strong> <span style="color: #28a745; font-weight: bold;">ŸäÿπŸÖŸÑ ÿ≠ÿßŸÑŸäÿßŸã</span></div>
                </div>
            `;
            
            // ÿ™ÿπŸäŸäŸÜ ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸäŸàŸÖ ŸÉŸÇŸäŸÖÿ© ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('endProjectDate').value = today;
            
            // ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑŸÜÿßŸÅÿ∞ÿ©
            const modal = document.getElementById('endProjectModal');
            if (modal) {
                modal.classList.add('active');
            }
        }
        
        // ÿ•ÿÆŸÅÿßÿ° ŸÜÿßŸÅÿ∞ÿ© ÿ•ŸÜŸáÿßÿ° ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ
        function hideEndProjectModal() {
            const modal = document.getElementById('endProjectModal');
            if (modal) {
                modal.classList.remove('active');
            }
            projectToEndId = null;
            document.getElementById('endProjectDate').value = '';
        }
        
        // ÿ™ÿ£ŸÉŸäÿØ ÿ•ŸÜŸáÿßÿ° ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ
        function confirmEndProject() {
            if (!projectToEndId) {
                alert('ÿÆÿ∑ÿ£: ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ');
                return;
            }
            
            const project = employeeProjectsHistory.find(p => p.id === projectToEndId);
            if (!project || !project.isCurrent) {
                alert('ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ ÿ£Ÿà ÿ∫Ÿäÿ± ÿ≠ÿßŸÑŸäÿßŸã');
                hideEndProjectModal();
                return;
            }
            
            const endDateInput = document.getElementById('endProjectDate').value;
            
            if (!endDateInput) {
                alert('‚ö†Ô∏è ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ™ÿ≠ÿØŸäÿØ ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ°');
                return;
            }
            
            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ£ŸÜ ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ° ÿ®ÿπÿØ ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ®ÿØÿ°
            const startDate = new Date(project.startDate);
            const endDateObj = new Date(endDateInput);
            
            if (endDateObj < startDate) {
                alert('‚ö†Ô∏è ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ° Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ ÿ®ÿπÿØ ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ®ÿØÿ°');
                return;
            }
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ
            project.endDate = endDateInput;
            project.isCurrent = false;
            
            displayProjectsHistory();
            hideEndProjectModal();
            
            alert(`‚úÖ ÿ™ŸÖ ÿ•ŸÜŸáÿßÿ° ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ "${project.projectName}" ÿ®ŸÜÿ¨ÿßÿ≠!\nÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ°: ${endDateInput}`);
        }
        
        // ÿπÿ±ÿ∂ ÿµŸàÿ±ÿ© ÿßŸÑŸÖŸàÿ∏ŸÅ ŸÅŸä ŸÜÿßŸÅÿ∞ÿ© ŸÖŸÜÿ®ÿ´ŸÇÿ©
        function viewEmployeePhoto(photoURL, employeeName) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.zIndex = '10004';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px; text-align: center;">
                    <div class="modal-header">
                        <h3>ÿµŸàÿ±ÿ© ÿßŸÑŸÖŸàÿ∏ŸÅ - ${employeeName || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</h3>
                        <span class="modal-close" onclick="this.closest('.modal').remove()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <img src="${photoURL}" alt="${employeeName || 'ÿµŸàÿ±ÿ© ÿßŸÑŸÖŸàÿ∏ŸÅ'}" style="max-width: 100%; max-height: 500px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                        <div style="margin-top: 20px;">
                            <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">ÿ•ÿ∫ŸÑÿßŸÇ</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.classList.add('active');
            
            // ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÜÿßŸÅÿ∞ÿ© ÿπŸÜÿØ ÿßŸÑŸÜŸÇÿ± ÿÆÿßÿ±ÿ¨Ÿáÿß
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        // ÿπÿ±ÿ∂ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑŸÖÿ±ŸÅŸÇÿ© ŸÑŸÑŸÖŸàÿ∏ŸÅ ŸÅŸä ŸÜÿßŸÅÿ∞ÿ© ŸÖŸÜŸÅÿµŸÑÿ©
        function viewEmployeeDocuments(employeeId) {
            const employee = employeesData.find(e => e.id === employeeId);
            if (!employee) {
                alert('ÿßŸÑŸÖŸàÿ∏ŸÅ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ');
                return;
            }
            
            const documents = employee.documents || [];
            
            // ÿ•ŸÜÿ¥ÿßÿ° ŸÜÿßŸÅÿ∞ÿ© ÿπÿ±ÿ∂ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑŸÖÿ±ŸÅŸÇÿ©
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.zIndex = '10005';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h3>ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑŸÖÿ±ŸÅŸÇÿ© - ${employee.name}</h3>
                        <span class="modal-close" onclick="this.closest('.modal').remove()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: 15px; padding: 15px; background: #e7f3ff; border-radius: 8px; border-right: 4px solid #667eea;">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                                <div>
                                    <strong style="color: #667eea; font-size: 16px;">üóúÔ∏è ÿ£ÿØŸàÿßÿ™ ÿßŸÑŸÖŸÑŸÅÿßÿ™</strong>
                                    <p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">ÿ∂ÿ∫ÿ∑ ÿßŸÑŸÖŸÑŸÅÿßÿ™ Ÿàÿ™ÿ≠ŸàŸäŸÑ PDF ÿ•ŸÑŸâ ÿµŸàÿ±</p>
                                </div>
                                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                    <button id="convertPdfToImagesBtn" onclick="convertPdfToImages('${employeeId}')" class="btn btn-info" style="padding: 8px 16px; font-size: 14px; border: none; border-radius: 6px; cursor: pointer; background: #17a2b8; color: white; font-weight: bold;">
                                        <span style="margin-left: 5px;">üìÑ‚ÜíüñºÔ∏è</span> ÿ™ÿ≠ŸàŸäŸÑ PDF ÿ•ŸÑŸâ ÿµŸàÿ±
                                    </button>
                                    <button id="compressAllDocumentsBtn" onclick="compressAllEmployeeDocuments('${employeeId}')" class="btn btn-primary" style="padding: 8px 16px; font-size: 14px; border: none; border-radius: 6px; cursor: pointer; background: #667eea; color: white; font-weight: bold;">
                                        <span style="margin-left: 5px;">üóúÔ∏è</span> ÿ∂ÿ∫ÿ∑ ÿ¨ŸÖŸäÿπ ÿßŸÑÿµŸàÿ±
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="employeeDocumentsView" style="max-height: 500px; overflow-y: auto;">
                            <!-- ÿ≥Ÿäÿ™ŸÖ ÿπÿ±ÿ∂ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ŸáŸÜÿß -->
                        </div>
                        <div style="margin-top: 20px; text-align: center;">
                            <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">ÿ•ÿ∫ŸÑÿßŸÇ</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.classList.add('active');
            
            // ÿπÿ±ÿ∂ ÿßŸÑŸÖŸÑŸÅÿßÿ™
            const documentsView = document.getElementById('employeeDocumentsView');
            
            if (documents.length === 0) {
                documentsView.innerHTML = '<p style="text-align: center; padding: 40px; color: #666;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÑŸÅÿßÿ™ ŸÖÿ±ŸÅŸÇÿ© ŸÑŸáÿ∞ÿß ÿßŸÑŸÖŸàÿ∏ŸÅ</p>';
            } else {
                // ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ŸÅŸä ŸÖÿ™ÿ∫Ÿäÿ± ŸÖÿ§ŸÇÿ™ ŸÑŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸäŸáÿß ŸÖŸÜ ÿßŸÑÿØŸàÿßŸÑ
                window.tempDocumentsData = documents;
                
                documentsView.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;">
                        ${documents.map((doc, index) => {
                            const fileName = doc.name || `ŸÖŸÑŸÅ ${index + 1}`;
                            const fileExtension = fileName.split('.').pop().toLowerCase();
                            const isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(fileExtension);
                            const isPDF = fileExtension === 'pdf';
                            
                            // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ data (base64) ÿ£Ÿà url (ŸÑŸÑÿ™ŸàÿßŸÅŸÇ ŸÖÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÇÿØŸäŸÖÿ©)
                            const fileData = doc.data || doc.url;
                            
                            let icon = 'üìÑ';
                            if (isImage) icon = 'üñºÔ∏è';
                            else if (isPDF) icon = 'üìï';
                            else if (['doc', 'docx'].includes(fileExtension)) icon = 'üìò';
                            else if (['xls', 'xlsx'].includes(fileExtension)) icon = 'üìä';
                            
                            // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ index ŸÑÿ™ÿÆÿ≤ŸäŸÜ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä ŸÖÿ™ÿ∫Ÿäÿ± ŸÖÿ§ŸÇÿ™
                            const fileIndex = index;
                            const safeFileName = fileName.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                            
                            return `
                                <div style="border: 2px solid #e9ecef; border-radius: 8px; padding: 15px; background: #f8f9fa; text-align: center;">
                                    <div style="font-size: 3em; margin-bottom: 10px;">${icon}</div>
                                    <div style="font-weight: bold; color: #333; margin-bottom: 10px; word-break: break-word; font-size: 14px;">${safeFileName}</div>
                                    ${doc.size ? `<div style="font-size: 11px; color: #666; margin-bottom: 10px;">${(doc.size / 1024).toFixed(2)} KB</div>` : ''}
                                    <div style="display: flex; gap: 5px; justify-content: center;">
                                        <button onclick="openDocumentAtIndex(${fileIndex}, '${fileExtension}')" class="btn btn-primary" style="padding: 6px 12px; font-size: 12px; cursor: pointer; border: none; border-radius: 4px; background: #667eea; color: white;">ŸÅÿ™ÿ≠</button>
                                        <button onclick="downloadDocumentAtIndex(${fileIndex})" class="btn btn-success" style="padding: 6px 12px; font-size: 12px; cursor: pointer; border: none; border-radius: 4px; background: #28a745; color: white;">ÿ™ÿ≠ŸÖŸäŸÑ</button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }
            
            // ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÜÿßŸÅÿ∞ÿ© ÿπŸÜÿØ ÿßŸÑŸÜŸÇÿ± ÿÆÿßÿ±ÿ¨Ÿáÿß
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            // ÿ≠ŸÅÿ∏ employeeId ŸÅŸä ÿßŸÑŸÜÿßŸÅÿ∞ÿ© ŸÑŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸäŸá ŸÖŸÜ ÿßŸÑÿØŸàÿßŸÑ ÿßŸÑÿ£ÿÆÿ±Ÿâ
            modal.setAttribute('data-employee-id', employeeId);
        }
        
        // ÿ™ÿ≠ŸàŸäŸÑ ŸÖŸÑŸÅÿßÿ™ PDF ÿ•ŸÑŸâ ÿµŸàÿ±
        async function convertPdfToImages(employeeId) {
            const employee = employeesData.find(e => e.id === employeeId);
            if (!employee) {
                alert('ÿßŸÑŸÖŸàÿ∏ŸÅ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ');
                return;
            }
            
            const documents = employee.documents || [];
            if (documents.length === 0) {
                alert('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÑŸÅÿßÿ™ ŸÖÿ±ŸÅŸÇÿ© ŸÑŸáÿ∞ÿß ÿßŸÑŸÖŸàÿ∏ŸÅ');
                return;
            }
            
            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ŸÖŸÑŸÅÿßÿ™ PDF
            const pdfDocuments = documents.filter(doc => {
                const fileName = (doc.name || '').toLowerCase();
                return fileName.endsWith('.pdf') && doc.data;
            });
            
            if (pdfDocuments.length === 0) {
                alert('‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÑŸÅÿßÿ™ PDF ŸäŸÖŸÉŸÜ ÿ™ÿ≠ŸàŸäŸÑŸáÿß.\n\nÿßŸÑÿ™ÿ≠ŸàŸäŸÑ ŸÖÿ™ÿßÿ≠ ŸÑŸÖŸÑŸÅÿßÿ™ PDF ŸÅŸÇÿ∑.');
                return;
            }
            
            const confirmed = confirm(`ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ™ÿ≠ŸàŸäŸÑ ${pdfDocuments.length} ŸÖŸÑŸÅ PDF ÿ•ŸÑŸâ ÿµŸàÿ±ÿü\n\nÿ≥Ÿäÿ™ŸÖ:\n‚Ä¢ ÿ™ÿ≠ŸàŸäŸÑ ŸÉŸÑ ÿµŸÅÿ≠ÿ© ŸÖŸÜ PDF ÿ•ŸÑŸâ ÿµŸàÿ±ÿ©\n‚Ä¢ ÿ≠ŸÅÿ∏ ÿßŸÑÿµŸàÿ± ŸÉŸÖŸÑŸÅÿßÿ™ ÿ¨ÿØŸäÿØÿ©\n‚Ä¢ ÿ≠ÿ∞ŸÅ ŸÖŸÑŸÅÿßÿ™ PDF ÿßŸÑÿ£ÿµŸÑŸäÿ©\n\nŸÖŸÑÿßÿ≠ÿ∏ÿ©: Ÿáÿ∞Ÿá ÿßŸÑÿπŸÖŸÑŸäÿ© ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜŸáÿß.`);
            if (!confirmed) {
                return;
            }
            
            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ŸÖŸÉÿ™ÿ®ÿ© PDF.js
            if (typeof pdfjsLib === 'undefined') {
                alert('‚ö†Ô∏è ŸÖŸÉÿ™ÿ®ÿ© PDF.js ÿ∫Ÿäÿ± ŸÖÿ≠ŸÖŸÑÿ©. Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿµŸÅÿ≠ÿ© ŸàÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.');
                return;
            }
            
            // ÿ•ÿ∏Ÿáÿßÿ± ÿ±ÿ≥ÿßŸÑÿ© ÿ™ÿ≠ŸÖŸäŸÑ
            const loadingModal = document.createElement('div');
            loadingModal.className = 'modal';
            loadingModal.style.zIndex = '10010';
            loadingModal.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <div class="modal-body" style="text-align: center; padding: 30px;">
                        <div style="font-size: 48px; margin-bottom: 20px;">‚è≥</div>
                        <div style="font-size: 16px; font-weight: bold; margin-bottom: 10px;">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸàŸäŸÑ PDF ÿ•ŸÑŸâ ÿµŸàÿ±...</div>
                        <div id="pdfConversionProgress" style="font-size: 14px; color: #666;">0 / ${pdfDocuments.length}</div>
                        <div style="margin-top: 20px; width: 100%; background: #e9ecef; border-radius: 4px; height: 8px; overflow: hidden;">
                            <div id="pdfConversionProgressBar" style="width: 0%; background: #17a2b8; height: 100%; transition: width 0.3s;"></div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(loadingModal);
            loadingModal.classList.add('active');
            
            try {
                const newDocuments = [];
                let processedCount = 0;
                let totalPagesConverted = 0;
                
                // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿ∫Ÿäÿ± PDF ŸÉŸÖÿß ŸáŸä
                documents.forEach(doc => {
                    const fileName = (doc.name || '').toLowerCase();
                    if (!fileName.endsWith('.pdf')) {
                        newDocuments.push(doc);
                    }
                });
                
                // ÿ™ÿ≠ŸàŸäŸÑ ŸÉŸÑ ŸÖŸÑŸÅ PDF
                for (let i = 0; i < pdfDocuments.length; i++) {
                    const pdfDoc = pdfDocuments[i];
                    const pdfName = pdfDoc.name.replace('.pdf', '').replace('.PDF', '');
                    
                    try {
                        // ÿ™ÿ≠ŸàŸäŸÑ base64 ÿ•ŸÑŸâ Blob
                        const base64Data = pdfDoc.data;
                        const response = await fetch(base64Data);
                        const pdfBlob = await response.blob();
                        const pdfArrayBuffer = await pdfBlob.arrayBuffer();
                        
                        // ÿ™ÿ≠ŸÖŸäŸÑ PDF ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ PDF.js
                        const pdf = await pdfjsLib.getDocument({ data: pdfArrayBuffer }).promise;
                        const numPages = pdf.numPages;
                        
                        // ÿ™ÿ≠ŸàŸäŸÑ ŸÉŸÑ ÿµŸÅÿ≠ÿ© ÿ•ŸÑŸâ ÿµŸàÿ±ÿ©
                        for (let pageNum = 1; pageNum <= numPages; pageNum++) {
                            const page = await pdf.getPage(pageNum);
                            
                            // ÿ•ŸÜÿ¥ÿßÿ° canvas ŸÑÿπÿ±ÿ∂ ÿßŸÑÿµŸÅÿ≠ÿ©
                            // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ scale 1.5 ŸÑŸÑÿ™Ÿàÿßÿ≤ŸÜ ÿ®ŸäŸÜ ÿßŸÑÿ¨ŸàÿØÿ© ŸàÿßŸÑÿ≠ÿ¨ŸÖ
                            const viewport = page.getViewport({ scale: 1.5 });
                            const canvas = document.createElement('canvas');
                            const context = canvas.getContext('2d');
                            canvas.height = viewport.height;
                            canvas.width = viewport.width;
                            
                            // ÿ±ÿ≥ŸÖ ÿßŸÑÿµŸÅÿ≠ÿ© ÿπŸÑŸâ canvas
                            await page.render({
                                canvasContext: context,
                                viewport: viewport
                            }).promise;
                            
                            // ÿ™ÿ≠ŸàŸäŸÑ canvas ÿ•ŸÑŸâ blob ÿ´ŸÖ ÿ•ŸÑŸâ base64
                            // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿ¨ŸàÿØÿ© 0.75 ŸÑÿ™ŸÇŸÑŸäŸÑ ÿßŸÑÿ≠ÿ¨ŸÖ
                            const imageBlob = await new Promise(resolve => {
                                canvas.toBlob(resolve, 'image/jpeg', 0.75);
                            });
                            
                            const imageBase64 = await new Promise((resolve, reject) => {
                                const reader = new FileReader();
                                reader.onload = (e) => resolve(e.target.result);
                                reader.onerror = reject;
                                reader.readAsDataURL(imageBlob);
                            });
                            
                            // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿµŸàÿ±ÿ© ŸÉŸÖŸÑŸÅ ÿ¨ÿØŸäÿØ
                            const imageName = numPages > 1 
                                ? `${pdfName}_ÿµŸÅÿ≠ÿ©_${pageNum}.jpg`
                                : `${pdfName}.jpg`;
                            
                            newDocuments.push({
                                name: imageName,
                                data: imageBase64,
                                type: 'image/jpeg',
                                size: imageBlob.size,
                                uploadedAt: pdfDoc.uploadedAt || new Date().toISOString(),
                                uploadedBy: pdfDoc.uploadedBy || currentUser?.uid || 'system',
                                convertedFromPdf: true,
                                originalPdfName: pdfDoc.name
                            });
                            
                            totalPagesConverted++;
                        }
                        
                        processedCount++;
                        
                        // ÿ™ÿ≠ÿØŸäÿ´ ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ™ŸÇÿØŸÖ
                        const progress = Math.round((processedCount / pdfDocuments.length) * 100);
                        const progressBar = document.getElementById('pdfConversionProgressBar');
                        const progressText = document.getElementById('pdfConversionProgress');
                        if (progressBar) progressBar.style.width = progress + '%';
                        if (progressText) progressText.textContent = `${processedCount} / ${pdfDocuments.length} (${totalPagesConverted} ÿµŸÅÿ≠ÿ©)`;
                        
                    } catch (error) {
                        console.error(`ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸàŸäŸÑ ${pdfDoc.name}:`, error);
                        // ŸÅŸä ÿ≠ÿßŸÑÿ© ÿßŸÑŸÅÿ¥ŸÑÿå ŸÜÿ≠ÿ™ŸÅÿ∏ ÿ®ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ£ÿµŸÑŸä
                        newDocuments.push(pdfDoc);
                    }
                }
                
                // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ≠ÿ¨ŸÖ ÿßŸÑŸÉŸÑŸä ÿ®ÿπÿØ ÿßŸÑÿ™ÿ≠ŸàŸäŸÑ
                const totalSize = newDocuments.reduce((sum, doc) => {
                    return sum + new Blob([doc.data || doc.url || '']).size;
                }, 0);
                
                const totalSizeMB = (totalSize / (1024 * 1024)).toFixed(2);
                
                // ÿ•ÿ∫ŸÑÿßŸÇ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ
                loadingModal.remove();
                
                // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ≠ÿ¨ŸÖ ŸÇÿ®ŸÑ ÿßŸÑÿ≠ŸÅÿ∏
                if (totalSize > 1 * 1024 * 1024) {
                    const confirmed = confirm(`‚ö†Ô∏è ÿ™ÿ≠ÿ∞Ÿäÿ±: ÿ•ÿ¨ŸÖÿßŸÑŸä ÿ≠ÿ¨ŸÖ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿ®ÿπÿØ ÿßŸÑÿ™ÿ≠ŸàŸäŸÑ (${totalSizeMB} MB) Ÿäÿ™ÿ¨ÿßŸàÿ≤ ÿ≠ÿØ Firestore (1 MB)\n\nŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ© ÿπŸÑŸâ ÿ£Ÿä ÿ≠ÿßŸÑÿü\n\nŸÇÿØ ŸäŸÅÿ¥ŸÑ ÿßŸÑÿ≠ŸÅÿ∏.`);
                    if (!confirmed) {
                        alert('ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿπŸÖŸÑŸäÿ©.');
                        return;
                    }
                }
                
                // ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ©
                await window.firestore.updateDoc(
                    window.firestore.doc(window.db, 'employees', employeeId),
                    { documents: newDocuments }
                );
                
                // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ©
                employee.documents = newDocuments;
                
                // ÿ™ÿ≠ÿØŸäÿ´ employeesData
                const empIndex = employeesData.findIndex(e => e.id === employeeId);
                if (empIndex !== -1) {
                    employeesData[empIndex].documents = newDocuments;
                }
                
                alert(`‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸàŸäŸÑ PDF ÿ•ŸÑŸâ ÿµŸàÿ± ÿ®ŸÜÿ¨ÿßÿ≠!\n\nüìä ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™:\n‚Ä¢ ÿπÿØÿØ ŸÖŸÑŸÅÿßÿ™ PDF ÿßŸÑŸÖÿ≠ŸàŸÑÿ©: ${processedCount}\n‚Ä¢ ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿµŸÅÿ≠ÿßÿ™ ÿßŸÑŸÖÿ≠ŸàŸÑÿ©: ${totalPagesConverted}\n‚Ä¢ ÿßŸÑÿ≠ÿ¨ŸÖ ÿßŸÑŸÉŸÑŸä: ${totalSizeMB} MB\n\n‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™.`);
                
                // ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑŸÖŸÑŸÅÿßÿ™
                viewEmployeeDocuments(employeeId);
                
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸàŸäŸÑ PDF:', error);
                loadingModal.remove();
                alert(`‚ùå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸàŸäŸÑ PDF: ${error.message}\n\nŸäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.`);
            }
        }
        
        // ÿ∂ÿ∫ÿ∑ ÿ¨ŸÖŸäÿπ ŸÖŸÑŸÅÿßÿ™ ÿßŸÑŸÖŸàÿ∏ŸÅ
        async function compressAllEmployeeDocuments(employeeId) {
            const employee = employeesData.find(e => e.id === employeeId);
            if (!employee) {
                alert('ÿßŸÑŸÖŸàÿ∏ŸÅ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ');
                return;
            }
            
            const documents = employee.documents || [];
            if (documents.length === 0) {
                alert('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÑŸÅÿßÿ™ ŸÖÿ±ŸÅŸÇÿ© ŸÑŸáÿ∞ÿß ÿßŸÑŸÖŸàÿ∏ŸÅ');
                return;
            }
            
            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿµŸàÿ± ŸÑŸÑÿ∂ÿ∫ÿ∑
            const imageDocuments = documents.filter(doc => {
                const fileName = (doc.name || '').toLowerCase();
                const fileExtension = fileName.split('.').pop();
                return ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(fileExtension) && doc.data;
            });
            
            if (imageDocuments.length === 0) {
                alert('‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿµŸàÿ± ŸäŸÖŸÉŸÜ ÿ∂ÿ∫ÿ∑Ÿáÿß.\n\nÿßŸÑÿ∂ÿ∫ÿ∑ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä ŸÖÿ™ÿßÿ≠ ŸÑŸÑÿµŸàÿ± ŸÅŸÇÿ∑ (JPG, PNG, GIF, WebP).\n\nÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑÿ£ÿÆÿ±Ÿâ (PDF, DOC, ÿ•ŸÑÿÆ) ŸÑÿß ŸäŸÖŸÉŸÜ ÿ∂ÿ∫ÿ∑Ÿáÿß ŸÅŸä ÿßŸÑŸÖÿ™ÿµŸÅÿ≠.');
                return;
            }
            
            const confirmed = confirm(`ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ∂ÿ∫ÿ∑ ${imageDocuments.length} ÿµŸàÿ±ÿ© ŸÖŸÜ ŸÖŸÑŸÅÿßÿ™ ÿßŸÑŸÖŸàÿ∏ŸÅÿü\n\nÿ≥Ÿäÿ™ŸÖ ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑÿ£ÿµŸÑŸäÿ© ÿ®ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑŸÖÿ∂ÿ∫Ÿàÿ∑ÿ©.\n\nŸÖŸÑÿßÿ≠ÿ∏ÿ©: Ÿáÿ∞Ÿá ÿßŸÑÿπŸÖŸÑŸäÿ© ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜŸáÿß.`);
            if (!confirmed) {
                return;
            }
            
            // ÿ•ÿ∏Ÿáÿßÿ± ÿ±ÿ≥ÿßŸÑÿ© ÿ™ÿ≠ŸÖŸäŸÑ
            const loadingModal = document.createElement('div');
            loadingModal.className = 'modal';
            loadingModal.style.zIndex = '10010';
            loadingModal.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <div class="modal-body" style="text-align: center; padding: 30px;">
                        <div style="font-size: 48px; margin-bottom: 20px;">‚è≥</div>
                        <div style="font-size: 16px; font-weight: bold; margin-bottom: 10px;">ÿ¨ÿßÿ±Ÿä ÿ∂ÿ∫ÿ∑ ÿßŸÑŸÖŸÑŸÅÿßÿ™...</div>
                        <div id="compressionProgress" style="font-size: 14px; color: #666;">0 / ${imageDocuments.length}</div>
                        <div style="margin-top: 20px; width: 100%; background: #e9ecef; border-radius: 4px; height: 8px; overflow: hidden;">
                            <div id="compressionProgressBar" style="width: 0%; background: #667eea; height: 100%; transition: width 0.3s;"></div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(loadingModal);
            loadingModal.classList.add('active');
            
            try {
                const compressedDocs = [];
                let processedCount = 0;
                let totalOriginalSize = 0;
                let totalCompressedSize = 0;
                
                for (let i = 0; i < documents.length; i++) {
                    const doc = documents[i];
                    const fileName = (doc.name || '').toLowerCase();
                    const fileExtension = fileName.split('.').pop();
                    const isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(fileExtension);
                    
                    if (isImage && doc.data) {
                        try {
                            totalOriginalSize += new Blob([doc.data]).size;
                            
                            // ÿ™ÿ≠ŸàŸäŸÑ base64 ÿ•ŸÑŸâ Blob ÿ´ŸÖ ÿ•ŸÑŸâ File
                            const base64Data = doc.data;
                            const response = await fetch(base64Data);
                            const blob = await response.blob();
                            const file = new File([blob], doc.name, { type: doc.type || 'image/jpeg' });
                            
                            // ÿ∂ÿ∫ÿ∑ ÿßŸÑÿµŸàÿ±ÿ©
                            const compressedFile = await compressFile(file);
                            
                            // ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑŸÖÿ∂ÿ∫Ÿàÿ∑ ÿ•ŸÑŸâ base64
                            const compressedBase64 = await new Promise((resolve, reject) => {
                                const reader = new FileReader();
                                reader.onload = (e) => resolve(e.target.result);
                                reader.onerror = reject;
                                reader.readAsDataURL(compressedFile);
                            });
                            
                            totalCompressedSize += new Blob([compressedBase64]).size;
                            
                            // ÿ•ŸÜÿ¥ÿßÿ° ŸÖÿ≥ÿ™ŸÜÿØ ÿ¨ÿØŸäÿØ ÿ®ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑŸÖÿ∂ÿ∫Ÿàÿ∑ÿ©
                            compressedDocs.push({
                                name: doc.name,
                                data: compressedBase64,
                                type: doc.type || 'image/jpeg',
                                size: compressedFile.size,
                                uploadedAt: doc.uploadedAt || new Date().toISOString(),
                                uploadedBy: doc.uploadedBy || currentUser?.uid || 'system'
                            });
                            
                            processedCount++;
                            
                            // ÿ™ÿ≠ÿØŸäÿ´ ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ™ŸÇÿØŸÖ
                            const progress = Math.round((processedCount / imageDocuments.length) * 100);
                            const progressBar = document.getElementById('compressionProgressBar');
                            const progressText = document.getElementById('compressionProgress');
                            if (progressBar) progressBar.style.width = progress + '%';
                            if (progressText) progressText.textContent = `${processedCount} / ${imageDocuments.length}`;
                            
                        } catch (error) {
                            console.error(`ÿÆÿ∑ÿ£ ŸÅŸä ÿ∂ÿ∫ÿ∑ ${doc.name}:`, error);
                            // ŸÅŸä ÿ≠ÿßŸÑÿ© ÿßŸÑŸÅÿ¥ŸÑÿå ŸÜÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØ ÿßŸÑÿ£ÿµŸÑŸä
                            compressedDocs.push(doc);
                        }
                    } else {
                        // ŸÑŸÑŸÖŸÑŸÅÿßÿ™ ÿ∫Ÿäÿ± ÿßŸÑÿµŸàÿ±ÿå ŸÜÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØ ÿßŸÑÿ£ÿµŸÑŸä
                        compressedDocs.push(doc);
                    }
                }
                
                // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ≠ÿ¨ŸÖ ÿßŸÑŸÉŸÑŸä ÿ®ÿπÿØ ÿßŸÑÿ∂ÿ∫ÿ∑
                const totalSize = compressedDocs.reduce((sum, doc) => {
                    return sum + new Blob([doc.data || doc.url || '']).size;
                }, 0);
                
                const totalSizeMB = (totalSize / (1024 * 1024)).toFixed(2);
                const originalSizeMB = (totalOriginalSize / (1024 * 1024)).toFixed(2);
                const savedMB = ((totalOriginalSize - totalCompressedSize) / (1024 * 1024)).toFixed(2);
                const savedPercent = totalOriginalSize > 0 ? (((totalOriginalSize - totalCompressedSize) / totalOriginalSize) * 100).toFixed(1) : '0';
                
                // ÿ•ÿ∫ŸÑÿßŸÇ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ
                loadingModal.remove();
                
                // ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑŸÖÿ∂ÿ∫Ÿàÿ∑ÿ©
                await window.firestore.updateDoc(
                    window.firestore.doc(window.db, 'employees', employeeId),
                    { documents: compressedDocs }
                );
                
                // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ©
                employee.documents = compressedDocs;
                
                // ÿ™ÿ≠ÿØŸäÿ´ employeesData
                const empIndex = employeesData.findIndex(e => e.id === employeeId);
                if (empIndex !== -1) {
                    employeesData[empIndex].documents = compressedDocs;
                }
                
                alert(`‚úÖ ÿ™ŸÖ ÿ∂ÿ∫ÿ∑ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠!\n\nüìä ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™:\n‚Ä¢ ÿßŸÑÿ≠ÿ¨ŸÖ ÿßŸÑÿ£ÿµŸÑŸä: ${originalSizeMB} MB\n‚Ä¢ ÿßŸÑÿ≠ÿ¨ŸÖ ÿ®ÿπÿØ ÿßŸÑÿ∂ÿ∫ÿ∑: ${totalSizeMB} MB\n‚Ä¢ ÿ™ŸÖ ÿ™ŸàŸÅŸäÿ±: ${savedMB} MB (${savedPercent}%)\n‚Ä¢ ÿπÿØÿØ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑŸÖÿ∂ÿ∫Ÿàÿ∑ÿ©: ${processedCount}\n\n‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™.`);
                
                // ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑŸÖŸÑŸÅÿßÿ™
                viewEmployeeDocuments(employeeId);
                
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ∂ÿ∫ÿ∑ ÿßŸÑŸÖŸÑŸÅÿßÿ™:', error);
                loadingModal.remove();
                alert(`‚ùå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ∂ÿ∫ÿ∑ ÿßŸÑŸÖŸÑŸÅÿßÿ™: ${error.message}\n\nŸäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.`);
            }
        }
        
        // ŸÅÿ™ÿ≠ ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØ ŸÅŸä ŸÜÿßŸÅÿ∞ÿ© ÿ¨ÿØŸäÿØÿ© (ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ index)
        function openDocumentAtIndex(index, fileExtension) {
            if (!window.tempDocumentsData || !window.tempDocumentsData[index]) {
                alert('‚ö†Ô∏è ÿßŸÑŸÖŸÑŸÅ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ');
                return;
            }
            const doc = window.tempDocumentsData[index];
            const fileData = doc.data || doc.url;
            const fileName = doc.name || `ŸÖŸÑŸÅ ${index + 1}`;
            openDocument(fileData, fileName, fileExtension);
        }
        
        // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØ (ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ index)
        function downloadDocumentAtIndex(index) {
            if (!window.tempDocumentsData || !window.tempDocumentsData[index]) {
                alert('‚ö†Ô∏è ÿßŸÑŸÖŸÑŸÅ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ');
                return;
            }
            const doc = window.tempDocumentsData[index];
            const fileData = doc.data || doc.url;
            const fileName = doc.name || `ŸÖŸÑŸÅ ${index + 1}`;
            downloadDocument(fileData, fileName);
        }
        
        // ŸÅÿ™ÿ≠ ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØ ŸÅŸä ŸÜÿßŸÅÿ∞ÿ© ÿ¨ÿØŸäÿØÿ©
        function openDocument(fileData, fileName, fileExtension) {
            try {
                // ÿ•ÿ∞ÿß ŸÉÿßŸÜ base64 stringÿå ŸÜÿ≠ÿ™ÿßÿ¨ ÿ•ŸÑŸâ ŸÅÿ™ÿ≠Ÿá ÿ®ÿ¥ŸÉŸÑ ÿµÿ≠Ÿäÿ≠
                if (fileData.startsWith('data:')) {
                    // ÿ•ŸÜÿ¥ÿßÿ° ŸÜÿßŸÅÿ∞ÿ© ÿ¨ÿØŸäÿØÿ© ŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖŸÑŸÅ
                    const newWindow = window.open('', '_blank');
                    if (!newWindow) {
                        alert('‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ≥ŸÖÿßÿ≠ ŸÑŸÑŸÜŸàÿßŸÅÿ∞ ÿßŸÑŸÖŸÜÿ®ÿ´ŸÇÿ© ŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖŸÑŸÅ');
                        return;
                    }
                    
                    // ŸÑŸÑÿµŸàÿ±ÿå ŸÜÿπÿ±ÿ∂Ÿáÿß ŸÖÿ®ÿßÿ¥ÿ±ÿ©
                    if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(fileExtension)) {
                        newWindow.document.write(`
                            <html>
                                <head>
                                    <title>${fileName}</title>
                                    <style>
                                        body { margin: 0; padding: 20px; text-align: center; background: #f5f5f5; }
                                        img { max-width: 100%; height: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
                                    </style>
                                </head>
                                <body>
                                    <img src="${fileData}" alt="${fileName}" />
                                </body>
                            </html>
                        `);
                    } 
                    // ŸÑŸÑŸÄ PDFÿå ŸÜÿ≥ÿ™ÿÆÿØŸÖ iframe
                    else if (fileExtension === 'pdf') {
                        newWindow.document.write(`
                            <html>
                                <head>
                                    <title>${fileName}</title>
                                    <style>
                                        body { margin: 0; padding: 0; }
                                        iframe { width: 100%; height: 100vh; border: none; }
                                    </style>
                                </head>
                                <body>
                                    <iframe src="${fileData}"></iframe>
                                </body>
                            </html>
                        `);
                    }
                    // ŸÑŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑÿ£ÿÆÿ±Ÿâÿå ŸÜÿπÿ±ÿ∂ ÿ±ÿßÿ®ÿ∑ ÿ™ÿ≠ŸÖŸäŸÑ
                    else {
                        newWindow.document.write(`
                            <html>
                                <head>
                                    <title>${fileName}</title>
                                    <style>
                                        body { margin: 0; padding: 40px; text-align: center; font-family: Arial, sans-serif; background: #f5f5f5; }
                                        .container { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: inline-block; }
                                        .icon { font-size: 64px; margin-bottom: 20px; }
                                        .filename { font-size: 18px; font-weight: bold; color: #333; margin-bottom: 20px; }
                                        .download-btn { padding: 12px 24px; background: #667eea; color: white; text-decoration: none; border-radius: 4px; display: inline-block; }
                                        .download-btn:hover { background: #5568d3; }
                                    </style>
                                </head>
                                <body>
                                    <div class="container">
                                        <div class="icon">üìÑ</div>
                                        <div class="filename">${fileName}</div>
                                        <p style="color: #666; margin-bottom: 20px;">ŸÑÿß ŸäŸÖŸÉŸÜ ÿπÿ±ÿ∂ Ÿáÿ∞ÿß ÿßŸÑŸÜŸàÿπ ŸÖŸÜ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ŸÅŸä ÿßŸÑŸÖÿ™ÿµŸÅÿ≠</p>
                                        <a href="${fileData}" download="${fileName}" class="download-btn">ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÑŸÅ</a>
                                    </div>
                                </body>
                            </html>
                        `);
                    }
                    newWindow.document.close();
                } else {
                    // ÿ•ÿ∞ÿß ŸÉÿßŸÜ URL ÿπÿßÿØŸä
                    window.open(fileData, '_blank');
                }
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ŸÅÿ™ÿ≠ ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØ:', error);
                alert('‚ö†Ô∏è ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ŸÅÿ™ÿ≠ ÿßŸÑŸÖŸÑŸÅ. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ ÿ£Ÿà ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÑŸÅ.');
            }
        }
        
        // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØ
        function downloadDocument(fileData, fileName) {
            try {
                // ÿ•ŸÜÿ¥ÿßÿ° ÿ±ÿßÿ®ÿ∑ ÿ™ÿ≠ŸÖŸäŸÑ
                const link = document.createElement('a');
                link.href = fileData;
                link.download = fileName;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØ:', error);
                alert('‚ö†Ô∏è ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÑŸÅ. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.');
            }
        }
        
        // ÿπÿ±ÿ∂ ÿ≥ÿ¨ŸÑ ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ ŸÅŸä ŸÜÿßŸÅÿ∞ÿ© ŸÖŸÜŸÅÿµŸÑÿ©
        async function viewEmployeeProjects(employeeId) {
            const employee = employeesData.find(e => e.id === employeeId);
            if (!employee) {
                alert('ÿßŸÑŸÖŸàÿ∏ŸÅ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ');
                return;
            }
            
            // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™ŸÉŸÜ ŸÖÿ≠ŸÖŸÑÿ©
            if (!projectsData || projectsData.length === 0) {
                await loadProjects();
            }
            
            // ÿ•ŸÜÿ¥ÿßÿ° ŸÜÿßŸÅÿ∞ÿ© ÿπÿ±ÿ∂ ÿ≥ÿ¨ŸÑ ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.zIndex = '10002';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h3>ÿ≥ÿ¨ŸÑ ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ - ${employee.name}</h3>
                        <span class="modal-close" onclick="this.closest('.modal').remove()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div id="employeeProjectsHistoryView" style="max-height: 500px; overflow-y: auto;">
                            <!-- ÿ≥Ÿäÿ™ŸÖ ÿπÿ±ÿ∂ ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ ŸáŸÜÿß -->
                        </div>
                        <div style="margin-top: 20px; text-align: center;">
                            <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">ÿ•ÿ∫ŸÑÿßŸÇ</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.classList.add('active');
            
            // ÿ™ÿ≠ŸÖŸäŸÑ ÿ≥ÿ¨ŸÑ ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ
            const projectsHistory = employee.projectsHistory || [];
            
            if (projectsHistory.length === 0) {
                document.getElementById('employeeProjectsHistoryView').innerHTML = 
                    '<p style="text-align: center; padding: 40px; color: #666;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ¥ÿßÿ±Ÿäÿπ ŸÖÿ≥ÿ¨ŸÑÿ© ŸÑŸáÿ∞ÿß ÿßŸÑŸÖŸàÿ∏ŸÅ</p>';
                return;
            }
            
            // ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ ÿ≠ÿ≥ÿ® ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ®ÿØÿ°
            const sortedProjects = [...projectsHistory].sort((a, b) => {
                return new Date(b.startDate) - new Date(a.startDate);
            });
            
            // ÿπÿ±ÿ∂ ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ
            const projectsHtml = sortedProjects.map(proj => {
                const project = projectsData.find(p => p.id === proj.projectId);
                const status = proj.isCurrent ? 'ŸäÿπŸÖŸÑ ÿ≠ÿßŸÑŸäÿßŸã' : 'ŸÖŸÜÿ™ŸáŸä';
                const statusColor = proj.isCurrent ? '#28a745' : '#6c757d';
                const statusBg = proj.isCurrent ? '#d4edda' : '#e9ecef';
                
                return `
                    <div style="border: 2px solid ${statusColor}; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: ${statusBg};">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div style="flex: 1;">
                                <div style="font-weight: bold; color: #667eea; font-size: 16px; margin-bottom: 5px;">
                                    ${proj.projectCode || ''} - ${proj.projectName || project?.name || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}
                                </div>
                                <div style="font-size: 14px; color: #666; margin-top: 8px;">
                                    <div><strong>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ®ÿØÿ°:</strong> ${proj.startDate || '-'}</div>
                                    <div><strong>${proj.isCurrent ? 'ÿßŸÑÿ≠ÿßŸÑÿ©:' : 'ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ°:'}</strong> 
                                        ${proj.isCurrent ? '<span style="color: #28a745; font-weight: bold;">ŸäÿπŸÖŸÑ ÿ≠ÿßŸÑŸäÿßŸã</span>' : (proj.endDate || '-')}
                                    </div>
                                </div>
                            </div>
                            <span style="background: ${statusColor}; color: white; padding: 6px 12px; border-radius: 15px; font-size: 12px; font-weight: bold;">
                                ${status}
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('employeeProjectsHistoryView').innerHTML = projectsHtml;
            
            // ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÜÿßŸÅÿ∞ÿ© ÿπŸÜÿØ ÿßŸÑŸÜŸÇÿ± ÿÆÿßÿ±ÿ¨Ÿáÿß
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // ============================================
        // ÿØŸàÿßŸÑ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿπŸÇŸàÿ®ÿßÿ™
        // ============================================
        function showAddPenaltyForm() {
            const modal = document.getElementById('addPenaltyModal');
            if (!modal) return;
            
            document.getElementById('penaltyType').value = '';
            document.getElementById('penaltyDate').value = '';
            document.getElementById('penaltyReason').value = '';
            document.getElementById('penaltyAmount').value = '';
            document.getElementById('penaltyNotes').value = '';
            
            modal.classList.add('active');
        }

        function hideAddPenaltyForm() {
            const modal = document.getElementById('addPenaltyModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        function addPenalty() {
            const type = document.getElementById('penaltyType').value;
            const date = document.getElementById('penaltyDate').value;
            const reason = document.getElementById('penaltyReason').value.trim();
            const amount = document.getElementById('penaltyAmount').value ? parseFloat(document.getElementById('penaltyAmount').value) : null;
            const notes = document.getElementById('penaltyNotes').value.trim();
            
            if (!type || !date || !reason) {
                alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ŸÜŸàÿπ ÿßŸÑÿπŸÇŸàÿ®ÿ© ŸàÿßŸÑÿ™ÿßÿ±ŸäÿÆ ŸàÿßŸÑÿ≥ÿ®ÿ®');
                return;
            }
            
            const penalty = {
                id: 'penalty_' + Date.now(),
                type: type,
                date: date,
                reason: reason,
                amount: amount,
                notes: notes
            };
            
            employeePenalties.push(penalty);
            displayPenalties();
            hideAddPenaltyForm();
        }

        function removePenalty(penaltyId) {
            if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞Ÿá ÿßŸÑÿπŸÇŸàÿ®ÿ©ÿü')) return;
            employeePenalties = employeePenalties.filter(p => p.id !== penaltyId);
            displayPenalties();
        }

        function displayPenalties() {
            const container = document.getElementById('penaltiesList');
            if (!container) return;
            
            if (employeePenalties.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center; padding: 20px; grid-column: 1/-1;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿπŸÇŸàÿ®ÿßÿ™ ŸÖÿ≥ÿ¨ŸÑÿ©</p>';
                return;
            }
            
            const sortedPenalties = [...employeePenalties].sort((a, b) => {
                return new Date(b.date) - new Date(a.date);
            });
            
            const typeNames = {
                'warning': 'ÿ•ŸÜÿ∞ÿßÿ±',
                'reprimand': 'ÿ™Ÿàÿ®ŸäÿÆ',
                'deduction': 'ÿÆÿµŸÖ ŸÖÿßŸÑŸä',
                'suspension': 'ÿ™ÿπŸÑŸäŸÇ',
                'termination': 'ÿ•ŸÜŸáÿßÿ° ÿÆÿØŸÖÿ©',
                'other': 'ÿ£ÿÆÿ±Ÿâ'
            };
            
            container.innerHTML = sortedPenalties.map(penalty => {
                return `
                    <div style="border: 2px solid #dc3545; border-radius: 8px; padding: 15px; background: #fff5f5; position: relative;">
                        <button onclick="removePenalty('${penalty.id}')" style="position: absolute; top: 10px; left: 10px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; font-size: 14px; line-height: 1;">√ó</button>
                        <div style="margin-bottom: 10px;">
                            <div style="font-weight: bold; color: #dc3545; margin-bottom: 5px;">${typeNames[penalty.type] || penalty.type}</div>
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">
                                <strong>ÿßŸÑÿ™ÿßÿ±ŸäÿÆ:</strong> ${penalty.date}
                            </div>
                            ${penalty.amount ? `<div style="font-size: 12px; color: #666; margin-bottom: 5px;"><strong>ÿßŸÑŸÖÿ®ŸÑÿ∫:</strong> ${formatNumber(penalty.amount)} ÿØŸäŸÜÿßÿ±</div>` : ''}
                        </div>
                        <div style="font-size: 12px; color: #333; margin-bottom: 10px;">
                            <strong>ÿßŸÑÿ≥ÿ®ÿ®:</strong> ${penalty.reason}
                        </div>
                        ${penalty.notes ? `<div style="font-size: 12px; color: #666;"><strong>ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™:</strong> ${penalty.notes}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        // ============================================
        // ÿØŸàÿßŸÑ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸÉÿßŸÅÿ¢ÿ™
        // ============================================
        function showAddRewardForm() {
            const modal = document.getElementById('addRewardModal');
            if (!modal) return;
            
            document.getElementById('rewardType').value = '';
            document.getElementById('rewardDate').value = '';
            document.getElementById('rewardReason').value = '';
            document.getElementById('rewardAmount').value = '';
            document.getElementById('rewardNotes').value = '';
            
            modal.classList.add('active');
        }

        function hideAddRewardForm() {
            const modal = document.getElementById('addRewardModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        function addReward() {
            const type = document.getElementById('rewardType').value;
            const date = document.getElementById('rewardDate').value;
            const reason = document.getElementById('rewardReason').value.trim();
            const amount = document.getElementById('rewardAmount').value ? parseFloat(document.getElementById('rewardAmount').value) : null;
            const notes = document.getElementById('rewardNotes').value.trim();
            
            if (!type || !date || !reason) {
                alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ŸÜŸàÿπ ÿßŸÑŸÖŸÉÿßŸÅÿ£ÿ© ŸàÿßŸÑÿ™ÿßÿ±ŸäÿÆ ŸàÿßŸÑÿ≥ÿ®ÿ®');
                return;
            }
            
            const reward = {
                id: 'reward_' + Date.now(),
                type: type,
                date: date,
                reason: reason,
                amount: amount,
                notes: notes
            };
            
            employeeRewards.push(reward);
            displayRewards();
            hideAddRewardForm();
        }

        function removeReward(rewardId) {
            if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞Ÿá ÿßŸÑŸÖŸÉÿßŸÅÿ£ÿ©ÿü')) return;
            employeeRewards = employeeRewards.filter(r => r.id !== rewardId);
            displayRewards();
        }

        function displayRewards() {
            const container = document.getElementById('rewardsList');
            if (!container) return;
            
            if (employeeRewards.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center; padding: 20px; grid-column: 1/-1;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÉÿßŸÅÿ¢ÿ™ ŸÖÿ≥ÿ¨ŸÑÿ©</p>';
                return;
            }
            
            const sortedRewards = [...employeeRewards].sort((a, b) => {
                return new Date(b.date) - new Date(a.date);
            });
            
            const typeNames = {
                'bonus': 'ŸÖŸÉÿßŸÅÿ£ÿ© ŸÖÿßŸÑŸäÿ©',
                'recognition': 'ÿ¥ŸÉÿ± Ÿàÿ™ŸÇÿØŸäÿ±',
                'promotion': 'ÿ™ÿ±ŸÇŸäÿ©',
                'gift': 'ŸáÿØŸäÿ©',
                'certificate': 'ÿ¥ŸáÿßÿØÿ© ÿ™ŸÇÿØŸäÿ±',
                'other': 'ÿ£ÿÆÿ±Ÿâ'
            };
            
            container.innerHTML = sortedRewards.map(reward => {
                return `
                    <div style="border: 2px solid #28a745; border-radius: 8px; padding: 15px; background: #f0fff4; position: relative;">
                        <button onclick="removeReward('${reward.id}')" style="position: absolute; top: 10px; left: 10px; background: #28a745; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; font-size: 14px; line-height: 1;">√ó</button>
                        <div style="margin-bottom: 10px;">
                            <div style="font-weight: bold; color: #28a745; margin-bottom: 5px;">${typeNames[reward.type] || reward.type}</div>
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">
                                <strong>ÿßŸÑÿ™ÿßÿ±ŸäÿÆ:</strong> ${reward.date}
                            </div>
                            ${reward.amount ? `<div style="font-size: 12px; color: #666; margin-bottom: 5px;"><strong>ÿßŸÑŸÖÿ®ŸÑÿ∫:</strong> ${formatNumber(reward.amount)} ÿØŸäŸÜÿßÿ±</div>` : ''}
                        </div>
                        <div style="font-size: 12px; color: #333; margin-bottom: 10px;">
                            <strong>ÿßŸÑÿ≥ÿ®ÿ®:</strong> ${reward.reason}
                        </div>
                        ${reward.notes ? `<div style="font-size: 12px; color: #666;"><strong>ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™:</strong> ${reward.notes}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        // ============================================
        // ÿØŸàÿßŸÑ ÿßŸÑÿ™ŸÇŸäŸäŸÖ ÿßŸÑÿ≥ŸÜŸàŸä
        // ============================================
        // ÿ™ÿ®ÿØŸäŸÑ ÿ≠ÿßŸÑÿ© ÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÇŸäŸäŸÖÿßÿ™
        function toggleEvaluationView() {
            if (window.evaluationViewUnlocked) {
                // ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑÿπÿ±ÿ∂
                window.evaluationViewUnlocked = false;
                const lockIcon = document.getElementById('evaluationLockIcon');
                const evaluationsList = document.getElementById('evaluationsList');
                const lockedMessage = document.getElementById('evaluationsLockedMessage');
                const addBtn = document.getElementById('addEvaluationBtn');
                
                if (lockIcon) {
                    lockIcon.textContent = 'üîí';
                    lockIcon.title = 'ÿßŸÜŸÇÿ± ŸÑÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿ™ŸÇŸäŸäŸÖÿßÿ™';
                }
                if (evaluationsList) evaluationsList.style.display = 'none';
                if (lockedMessage) lockedMessage.style.display = 'block';
                if (addBtn) addBtn.style.display = 'none';
            } else {
                // ÿ∑ŸÑÿ® ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±
                const password = prompt('üîí Ÿáÿ∞ÿß ÿßŸÑŸÇÿ≥ŸÖ ŸÖÿ≠ŸÖŸä ÿ®ŸÉŸÑŸÖÿ© ŸÖÿ±Ÿàÿ±\nÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ŸÑÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÇŸäŸäŸÖÿßÿ™ ÿßŸÑÿ≥ŸÜŸàŸäÿ©:');
                if (!password) return;
                
                if (password !== EVALUATION_PASSWORD) {
                    alert('‚ùå ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©');
                    return;
                }
                
                window.evaluationViewUnlocked = true;
                const lockIcon = document.getElementById('evaluationLockIcon');
                const evaluationsList = document.getElementById('evaluationsList');
                const lockedMessage = document.getElementById('evaluationsLockedMessage');
                const addBtn = document.getElementById('addEvaluationBtn');
                
                if (lockIcon) {
                    lockIcon.textContent = 'üîì';
                    lockIcon.title = 'ÿßŸÜŸÇÿ± ŸÑÿ•ÿÆŸÅÿßÿ° ÿßŸÑÿ™ŸÇŸäŸäŸÖÿßÿ™';
                }
                if (evaluationsList) evaluationsList.style.display = 'grid';
                if (lockedMessage) lockedMessage.style.display = 'none';
                if (addBtn) addBtn.style.display = 'inline-block';
                
                displayEvaluations();
            }
        }

        // ÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÇŸäŸäŸÖÿßÿ™ ŸÖŸÜ ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ
        async function viewEmployeeEvaluations(employeeId) {
            const password = prompt('üîí ÿßŸÑÿ™ŸÇŸäŸäŸÖÿßÿ™ ÿßŸÑÿ≥ŸÜŸàŸäÿ© ŸÖÿ≠ŸÖŸäÿ© ÿ®ŸÉŸÑŸÖÿ© ŸÖÿ±Ÿàÿ±\nÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±:');
            if (!password) return;
            
            if (password !== EVALUATION_PASSWORD) {
                alert('‚ùå ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©');
                return;
            }
            
            const employee = employeesData.find(e => e.id === employeeId);
            if (!employee) {
                alert('ÿßŸÑŸÖŸàÿ∏ŸÅ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ');
                return;
            }
            
            const evaluations = employee.evaluations || [];
            
            // ÿ•ŸÜÿ¥ÿßÿ° ŸÜÿßŸÅÿ∞ÿ© ÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÇŸäŸäŸÖÿßÿ™
            const modalHtml = `
                <div class="modal active" style="z-index: 10005;">
                    <div class="modal-content" style="max-width: 900px;">
                        <div class="modal-header">
                            <h3>‚≠ê ÿßŸÑÿ™ŸÇŸäŸäŸÖÿßÿ™ ÿßŸÑÿ≥ŸÜŸàŸäÿ© - ${employee.name || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</h3>
                            <span class="modal-close" onclick="this.closest('.modal').remove()">&times;</span>
                        </div>
                        <div class="modal-body">
                            <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>ÿßŸÑŸÖŸàÿ∏ŸÅ:</strong> ${employee.name || '-'}<br>
                                    <strong>ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑŸàÿ∏ŸäŸÅŸä:</strong> ${employee.employeeNumber || '-'}
                                </div>
                                <button class="btn btn-info" onclick="editEmployeeForEvaluation('${employeeId}')">
                                    ‚ûï ÿ•ÿ∂ÿßŸÅÿ© ÿ™ŸÇŸäŸäŸÖ
                                </button>
                            </div>
                            <div id="employeeEvaluationsView" style="max-height: 500px; overflow-y: auto;">
                                ${evaluations.length === 0 
                                    ? '<p style="text-align: center; padding: 40px; color: #666;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ™ŸÇŸäŸäŸÖÿßÿ™ ŸÖÿ≥ÿ¨ŸÑÿ©</p>'
                                    : generateEvaluationsHTML(evaluations, employeeId)
                                }
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function editEmployeeForEvaluation(employeeId) {
            // ÿ•ÿ∫ŸÑÿßŸÇ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ™ŸÇŸäŸäŸÖÿßÿ™
            const modal = document.querySelector('.modal.active');
            if (modal) modal.remove();
            
            // ŸÅÿ™ÿ≠ ÿ®ÿ∑ÿßŸÇÿ© ÿßŸÑŸÖŸàÿ∏ŸÅ
            editEmployee(employeeId);
            
            // ŸÅÿ™ÿ≠ ŸÇÿ≥ŸÖ ÿßŸÑÿ™ŸÇŸäŸäŸÖÿßÿ™
            setTimeout(() => {
                if (!window.evaluationViewUnlocked) {
                    toggleEvaluationView();
                }
                showAddEvaluationForm();
            }, 500);
        }

        function generateEvaluationsHTML(evaluations, employeeId) {
            const ratingNames = {
                1: { name: 'ÿ∂ÿπŸäŸÅ ÿ¨ÿØÿßŸã', color: '#dc3545', bg: '#f8d7da' },
                2: { name: 'ÿ∂ÿπŸäŸÅ', color: '#fd7e14', bg: '#ffe5d0' },
                3: { name: 'ŸÖŸÇÿ®ŸàŸÑ', color: '#ffc107', bg: '#fff3cd' },
                4: { name: 'ÿ¨ŸäÿØ', color: '#28a745', bg: '#d4edda' },
                5: { name: 'ŸÖŸÖÿ™ÿßÿ≤', color: '#20c997', bg: '#d1f2eb' }
            };
            
            const sorted = [...evaluations].sort((a, b) => b.year - a.year);
            
            return sorted.map(evaluation => {
                const ratingInfo = ratingNames[evaluation.rating] || ratingNames[3];
                return `
                    <div style="border: 2px solid ${ratingInfo.color}; border-radius: 12px; padding: 20px; margin-bottom: 15px; background: ${ratingInfo.bg};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div>
                                <div style="font-weight: bold; color: ${ratingInfo.color}; font-size: 18px;">ÿ≥ŸÜÿ© ${evaluation.year}</div>
                                <div style="font-size: 24px; font-weight: bold; color: ${ratingInfo.color}; margin-top: 5px;">
                                    ${'‚≠ê'.repeat(evaluation.rating)}${'‚òÜ'.repeat(5 - evaluation.rating)}
                                </div>
                            </div>
                            <div style="background: white; padding: 8px 12px; border-radius: 6px;">
                                <span style="font-weight: bold; color: ${ratingInfo.color}; font-size: 16px;">${evaluation.rating}/5</span>
                                <span style="color: #666; margin-right: 8px;">- ${ratingInfo.name}</span>
                            </div>
                        </div>
                        <div style="background: white; padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                            <div style="font-size: 13px; color: #333; line-height: 1.6;">
                                <strong>ÿßŸÑŸàÿµŸÅ:</strong><br>
                                ${evaluation.description}
                            </div>
                        </div>
                        ${evaluation.notes ? `
                            <div style="background: white; padding: 10px; border-radius: 8px;">
                                <div style="font-size: 12px; color: #666;">
                                    <strong>ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™:</strong> ${evaluation.notes}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function showAddEvaluationForm() {
            if (!window.evaluationViewUnlocked) {
                toggleEvaluationView();
                return;
            }
            
            const modal = document.getElementById('addEvaluationModal');
            if (!modal) return;
            
            editingEvaluationId = null;
            document.getElementById('evaluationFormTitle').textContent = 'ÿ•ÿ∂ÿßŸÅÿ© ÿ™ŸÇŸäŸäŸÖ ÿ≥ŸÜŸàŸä';
            document.getElementById('evaluationSubmitBtn').textContent = 'ÿ•ÿ∂ÿßŸÅÿ©';
            document.getElementById('evaluationSubmitBtn').setAttribute('onclick', 'addEvaluation()');
            
            document.getElementById('evaluationYear').value = new Date().getFullYear();
            document.getElementById('evaluationRating').value = '';
            document.getElementById('evaluationDescription').value = '';
            document.getElementById('evaluationNotes').value = '';
            
            modal.classList.add('active');
        }

        function hideAddEvaluationForm() {
            const modal = document.getElementById('addEvaluationModal');
            if (modal) {
                modal.classList.remove('active');
            }
            editingEvaluationId = null;
        }

        function addEvaluation() {
            if (!window.evaluationViewUnlocked) {
                const password = prompt('üîí ÿ•ÿ∂ÿßŸÅÿ©/ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ™ŸÇŸäŸäŸÖÿßÿ™ ŸÖÿ≠ŸÖŸä ÿ®ŸÉŸÑŸÖÿ© ŸÖÿ±Ÿàÿ±\nÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±:');
                if (!password || password !== EVALUATION_PASSWORD) {
                    alert('‚ùå ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©');
                    return;
                }
                window.evaluationViewUnlocked = true;
            }
            
            const year = parseInt(document.getElementById('evaluationYear').value);
            const rating = parseInt(document.getElementById('evaluationRating').value);
            const description = document.getElementById('evaluationDescription').value.trim();
            const notes = document.getElementById('evaluationNotes').value.trim();
            
            if (!year || !rating || !description) {
                alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿ≥ŸÜÿ© ŸàÿßŸÑÿ™ŸÇŸäŸäŸÖ ŸàÿßŸÑŸàÿµŸÅ');
                return;
            }
            
            if (rating < 1 || rating > 5) {
                alert('ÿßŸÑÿ™ŸÇŸäŸäŸÖ Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ ÿ®ŸäŸÜ 1 Ÿà 5');
                return;
            }
            
            const isEdit = editingEvaluationId !== null;
            const oldEvaluation = isEdit ? employeeEvaluations.find(e => e.id === editingEvaluationId) : null;
            
            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿπÿØŸÖ Ÿàÿ¨ŸàÿØ ÿ™ŸÇŸäŸäŸÖ ŸÑŸÜŸÅÿ≥ ÿßŸÑÿ≥ŸÜÿ©
            if (!isEdit) {
                const existingEvaluation = employeeEvaluations.find(e => e.year === year);
                if (existingEvaluation) {
                    if (!confirm(`ŸäŸàÿ¨ÿØ ÿ™ŸÇŸäŸäŸÖ ŸÖÿ≥ÿ¨ŸÑ ŸÑÿ≥ŸÜÿ© ${year}. ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑŸáÿü`)) {
                        return;
                    }
                    employeeEvaluations = employeeEvaluations.filter(e => e.year !== year);
                }
            }
            
            const evaluation = {
                id: editingEvaluationId || 'eval_' + Date.now(),
                year: year,
                rating: rating,
                description: description,
                notes: notes || '',
                createdAt: isEdit ? (oldEvaluation?.createdAt || new Date().toISOString()) : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            if (isEdit) {
                const index = employeeEvaluations.findIndex(e => e.id === editingEvaluationId);
                if (index !== -1) {
                    employeeEvaluations[index] = evaluation;
                    // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿ™ÿπÿØŸäŸÑ
                    logAudit('evaluation', 'update', {
                        employeeId: editingEmployeeId,
                        evaluationId: editingEvaluationId,
                        oldData: oldEvaluation,
                        newData: evaluation
                    });
                }
            } else {
                employeeEvaluations.push(evaluation);
                // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿ•ÿ∂ÿßŸÅÿ©
                logAudit('evaluation', 'create', {
                    employeeId: editingEmployeeId,
                    evaluation: evaluation
                });
            }
            
            displayEvaluations();
            hideAddEvaluationForm();
        }

        function editEvaluation(evaluationId) {
            if (!window.evaluationViewUnlocked) {
                const password = prompt('üîí ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ™ŸÇŸäŸäŸÖÿßÿ™ ŸÖÿ≠ŸÖŸä ÿ®ŸÉŸÑŸÖÿ© ŸÖÿ±Ÿàÿ±\nÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±:');
                if (!password || password !== EVALUATION_PASSWORD) {
                    alert('‚ùå ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©');
                    return;
                }
                window.evaluationViewUnlocked = true;
            }
            
            const evaluation = employeeEvaluations.find(e => e.id === evaluationId);
            if (!evaluation) return;
            
            editingEvaluationId = evaluationId;
            document.getElementById('evaluationFormTitle').textContent = 'ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ™ŸÇŸäŸäŸÖ ÿßŸÑÿ≥ŸÜŸàŸä';
            document.getElementById('evaluationSubmitBtn').textContent = 'ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™';
            document.getElementById('evaluationSubmitBtn').setAttribute('onclick', 'addEvaluation()');
            
            document.getElementById('evaluationYear').value = evaluation.year;
            document.getElementById('evaluationRating').value = evaluation.rating;
            document.getElementById('evaluationDescription').value = evaluation.description;
            document.getElementById('evaluationNotes').value = evaluation.notes || '';
            
            const modal = document.getElementById('addEvaluationModal');
            if (modal) {
                modal.classList.add('active');
            }
        }

        function removeEvaluation(evaluationId) {
            if (!window.evaluationViewUnlocked) {
                const password = prompt('üîí ÿ≠ÿ∞ŸÅ ÿßŸÑÿ™ŸÇŸäŸäŸÖÿßÿ™ ŸÖÿ≠ŸÖŸä ÿ®ŸÉŸÑŸÖÿ© ŸÖÿ±Ÿàÿ±\nÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±:');
                if (!password || password !== EVALUATION_PASSWORD) {
                    alert('‚ùå ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©');
                    return;
                }
                window.evaluationViewUnlocked = true;
            }
            
            if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑÿ™ŸÇŸäŸäŸÖ ÿßŸÑÿ≥ŸÜŸàŸäÿü')) return;
            
            const evaluation = employeeEvaluations.find(e => e.id === evaluationId);
            if (evaluation) {
                logAudit('evaluation', 'delete', {
                    employeeId: editingEmployeeId,
                    evaluationYear: evaluation.year,
                    evaluationRating: evaluation.rating
                });
            }
            
            employeeEvaluations = employeeEvaluations.filter(e => e.id !== evaluationId);
            displayEvaluations();
        }

        function displayEvaluations() {
            if (!window.evaluationViewUnlocked) {
                return;
            }
            
            const container = document.getElementById('evaluationsList');
            if (!container) return;
            
            if (employeeEvaluations.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center; padding: 20px; grid-column: 1/-1;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ™ŸÇŸäŸäŸÖÿßÿ™ ÿ≥ŸÜŸàŸäÿ© ŸÖÿ≥ÿ¨ŸÑÿ©</p>';
                return;
            }
            
            const sortedEvaluations = [...employeeEvaluations].sort((a, b) => b.year - a.year);
            
            const ratingNames = {
                1: { name: 'ÿ∂ÿπŸäŸÅ ÿ¨ÿØÿßŸã', color: '#dc3545', bg: '#f8d7da' },
                2: { name: 'ÿ∂ÿπŸäŸÅ', color: '#fd7e14', bg: '#ffe5d0' },
                3: { name: 'ŸÖŸÇÿ®ŸàŸÑ', color: '#ffc107', bg: '#fff3cd' },
                4: { name: 'ÿ¨ŸäÿØ', color: '#28a745', bg: '#d4edda' },
                5: { name: 'ŸÖŸÖÿ™ÿßÿ≤', color: '#20c997', bg: '#d1f2eb' }
            };
            
            container.innerHTML = sortedEvaluations.map(evaluation => {
                const ratingInfo = ratingNames[evaluation.rating] || ratingNames[3];
                return `
                    <div style="border: 2px solid ${ratingInfo.color}; border-radius: 12px; padding: 20px; background: ${ratingInfo.bg}; position: relative; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <button onclick="removeEvaluation('${evaluation.id}')" style="position: absolute; top: 10px; left: 10px; background: ${ratingInfo.color}; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 18px; line-height: 1; font-weight: bold;">√ó</button>
                        <button onclick="editEvaluation('${evaluation.id}')" style="position: absolute; top: 10px; left: 50px; background: #667eea; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 16px; line-height: 1;">‚úé</button>
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div style="font-weight: bold; color: ${ratingInfo.color}; font-size: 18px;">ÿ≥ŸÜÿ© ${evaluation.year}</div>
                                <div style="font-size: 24px; font-weight: bold; color: ${ratingInfo.color};">
                                    ${'‚≠ê'.repeat(evaluation.rating)}${'‚òÜ'.repeat(5 - evaluation.rating)}
                                </div>
                            </div>
                            <div style="background: white; padding: 8px 12px; border-radius: 6px; display: inline-block;">
                                <span style="font-weight: bold; color: ${ratingInfo.color}; font-size: 16px;">${evaluation.rating}/5</span>
                                <span style="color: #666; margin-right: 8px;">- ${ratingInfo.name}</span>
                            </div>
                        </div>
                        <div style="background: white; padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                            <div style="font-size: 13px; color: #333; line-height: 1.6;">
                                <strong>ÿßŸÑŸàÿµŸÅ:</strong><br>
                                ${evaluation.description}
                            </div>
                        </div>
                        ${evaluation.notes ? `
                            <div style="background: white; padding: 10px; border-radius: 8px;">
                                <div style="font-size: 12px; color: #666;">
                                    <strong>ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™:</strong> ${evaluation.notes}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // ============================================
        // ÿØŸàÿßŸÑ ŸÖÿ≥ÿßÿπÿØÿ©
        // ============================================
        function getEducationName(education) {
            const names = {
                'elementary': 'ÿßÿ®ÿ™ÿØÿßÿ¶Ÿä',
                'middle': 'ŸÖÿ™Ÿàÿ≥ÿ∑',
                'high_school': 'ÿ´ÿßŸÜŸàŸä',
                'diploma': 'ÿØÿ®ŸÑŸàŸÖ',
                'bachelor': 'ÿ®ŸÉÿßŸÑŸàÿ±ŸäŸàÿ≥',
                'master': 'ŸÖÿßÿ¨ÿ≥ÿ™Ÿäÿ±',
                'phd': 'ÿØŸÉÿ™Ÿàÿ±ÿßŸá',
                'other': 'ÿ£ÿÆÿ±Ÿâ'
            };
            return names[education] || education;
        }

        function updateReplacementSelect(excludeId = null) {
            const select = document.getElementById('empReplacement');
            if (!select) return;
            
            select.innerHTML = '<option value="">ŸÑÿß ŸäŸàÿ¨ÿØ</option>';
            employeesData.forEach(emp => {
                if (emp.id !== excludeId && emp.status === 'active') {
                    const option = document.createElement('option');
                    option.value = emp.id;
                    option.textContent = `${emp.name} (${emp.employeeNumber || ''})`;
                    select.appendChild(option);
                }
            });
        }

        async function updateDepartmentSelect(excludeId = null) {
            const select = document.getElementById('empDepartment');
            if (!select) return;
            
            // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ŸàÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™ŸÉŸÜ ŸÖÿ≠ŸÖŸÑÿ©
            if (departmentsData.length === 0) {
                await loadDepartments();
            }
            if (projectsData.length === 0) {
                await loadProjects();
            }
            
            select.innerHTML = '<option value="">-- ÿßÿÆÿ™ÿ± ÿßŸÑŸÇÿ≥ŸÖ --</option>';
            departmentsData.forEach(dept => {
                if (excludeId && dept.id === excludeId) return;
                
                const option = document.createElement('option');
                option.value = dept.id;
                let projectName = '';
                if (dept.projectId === 'general_management') {
                    projectName = 'ÿßŸÑÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿπÿßŸÖÿ©';
                } else if (dept.projectId) {
                    const project = projectsData.find(p => p.id === dept.projectId);
                    projectName = project ? project.name : 'ŸÖÿ¥ÿ±Ÿàÿπ ŸÖÿ≠ÿ∞ŸàŸÅ';
                }
                option.textContent = `${dept.name}${projectName ? ' - ' + projectName : ''}`;
                select.appendChild(option);
            });
        }

        // ÿ™ÿ≠ÿØŸäÿ´ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ (ŸÖŸÉÿßŸÜ ÿßŸÑÿπŸÖŸÑ)
        async function updateWorkLocationSelect() {
            const select = document.getElementById('empWorkLocation');
            if (!select) return;
            
            // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™ŸÉŸÜ ŸÖÿ≠ŸÖŸÑÿ©
            if (regionsData.length === 0) {
                await loadRegions();
            }
            
            select.innerHTML = '<option value="">-- ÿßÿÆÿ™ÿ± ŸÖŸÉÿßŸÜ ÿßŸÑÿπŸÖŸÑ --</option>';
            regionsData.forEach(region => {
                const option = document.createElement('option');
                option.value = region.id;
                option.textContent = region.name || region.nameEn || 'ŸÖŸÜÿ∑ŸÇÿ© ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØÿ©';
                select.appendChild(option);
            });
        }

        // ÿ™ÿ≠ÿØŸäÿ´ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ ŸÑŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ (ŸÖŸáŸÖÿ© ÿπŸÖŸÑ)
        async function updateLeaveRegionSelect() {
            const select = document.getElementById('leaveRegionId');
            if (!select) return;
            
            // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™ŸÉŸÜ ŸÖÿ≠ŸÖŸÑÿ©
            if (regionsData.length === 0) {
                await loadRegions();
            }
            
            select.innerHTML = '<option value="">-- ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© --</option>';
            regionsData.forEach(region => {
                const option = document.createElement('option');
                option.value = region.id;
                option.textContent = region.name || region.nameEn || 'ŸÖŸÜÿ∑ŸÇÿ© ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØÿ©';
                select.appendChild(option);
            });
        }

        // ŸÖÿπÿßŸÑÿ¨ÿ© ÿ™ÿ∫ŸäŸäÿ± ŸÜŸàÿπ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ©
        function handleLeaveTypeChange() {
            const leaveType = document.getElementById('leaveType')?.value;
            const leaveHoursGroup = document.getElementById('leaveHoursGroup');
            const leaveRegionGroup = document.getElementById('leaveRegionGroup');
            const leaveMissionTypeGroup = document.getElementById('leaveMissionTypeGroup');
            const leaveMissionHoursGroup = document.getElementById('leaveMissionHoursGroup');
            
            // ÿ•ÿ∏Ÿáÿßÿ±/ÿ•ÿÆŸÅÿßÿ° ÿ≠ŸÇŸÑ ÿßŸÑÿ≥ÿßÿπÿßÿ™ ŸÑŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ©
            if (leaveHoursGroup) {
                leaveHoursGroup.style.display = (leaveType === 'hourly') ? 'block' : 'none';
            }
            
            // ÿ•ÿ∏Ÿáÿßÿ±/ÿ•ÿÆŸÅÿßÿ° ÿ≠ŸÇŸàŸÑ ŸÖŸáŸÖÿ© ÿßŸÑÿπŸÖŸÑ
            if (leaveRegionGroup) {
                leaveRegionGroup.style.display = (leaveType === 'work-mission') ? 'block' : 'none';
                // ÿ¨ÿπŸÑ ÿßŸÑÿ≠ŸÇŸÑ ŸÖÿ∑ŸÑŸàÿ®ÿßŸã ÿπŸÜÿØ ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸáŸÖÿ© ÿπŸÖŸÑ
                const regionSelect = document.getElementById('leaveRegionId');
                if (regionSelect) {
                    if (leaveType === 'work-mission') {
                        regionSelect.setAttribute('required', 'required');
                    } else {
                        regionSelect.removeAttribute('required');
                    }
                }
            }
            
            // ÿ•ÿ∏Ÿáÿßÿ±/ÿ•ÿÆŸÅÿßÿ° ŸÜŸàÿπ ÿßŸÑŸÖŸáŸÖÿ© (ÿ≤ŸÖŸÜŸäÿ© ÿ£Ÿà ŸäŸàŸÖ ŸÉÿßŸÖŸÑ)
            if (leaveMissionTypeGroup) {
                leaveMissionTypeGroup.style.display = (leaveType === 'work-mission') ? 'block' : 'none';
                if (leaveType !== 'work-mission') {
                    // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÇŸäŸÖ ÿπŸÜÿØ ÿ™ÿ∫ŸäŸäÿ± ŸÜŸàÿπ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ©
                    const missionTypeSelect = document.getElementById('leaveMissionType');
                    const missionHoursInput = document.getElementById('leaveMissionHours');
                    if (missionTypeSelect) missionTypeSelect.value = '';
                    if (missionHoursInput) missionHoursInput.value = '';
                    if (leaveMissionHoursGroup) leaveMissionHoursGroup.style.display = 'none';
                }
            }
        }
        
        // ŸÖÿπÿßŸÑÿ¨ÿ© ÿ™ÿ∫ŸäŸäÿ± ŸÜŸàÿπ ÿßŸÑŸÖŸáŸÖÿ© (ÿ≤ŸÖŸÜŸäÿ© ÿ£Ÿà ŸäŸàŸÖ ŸÉÿßŸÖŸÑ)
        function handleMissionTypeChange() {
            const missionType = document.getElementById('leaveMissionType')?.value;
            const leaveMissionHoursGroup = document.getElementById('leaveMissionHoursGroup');
            const leaveEndDateGroup = document.querySelector('.form-group:has(#leaveEndDate)');
            const leaveEndDateInput = document.getElementById('leaveEndDate');
            
            if (leaveMissionHoursGroup) {
                leaveMissionHoursGroup.style.display = (missionType === 'hourly') ? 'block' : 'none';
            }
            
            // ÿπŸÜÿØ ÿßÿÆÿ™Ÿäÿßÿ± "ÿ≤ŸÖŸÜŸäÿ©"ÿå ÿ•ÿÆŸÅÿßÿ° ÿ≠ŸÇŸÑ ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ°
            // ÿπŸÜÿØ ÿßÿÆÿ™Ÿäÿßÿ± "ŸäŸàŸÖ ŸÉÿßŸÖŸÑ"ÿå ÿ•ÿ∏Ÿáÿßÿ± ÿ≠ŸÇŸÑ ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ°
            if (leaveEndDateInput) {
                if (missionType === 'hourly') {
                    leaveEndDateInput.removeAttribute('required');
                    leaveEndDateInput.value = '';
                } else if (missionType === 'full-day') {
                    // ŸäŸÖŸÉŸÜ ÿ¨ÿπŸÑŸá ŸÖÿ∑ŸÑŸàÿ®ÿßŸã ÿ•ÿ∞ÿß ŸÑÿ≤ŸÖ ÿßŸÑÿ£ŸÖÿ±
                    // leaveEndDateInput.setAttribute('required', 'required');
                }
            }
        }
        
        // ŸÖÿπÿßŸÑÿ¨ÿ© ÿ™ÿ∫ŸäŸäÿ± ÿ∑ÿ±ŸäŸÇÿ© ÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿ≥ÿßÿπÿßÿ™ ŸÑŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿßŸÑÿ≤ŸÖŸÜŸäÿ©
        function handleLeaveHoursMethodChange() {
            const method = document.getElementById('leaveHoursInputMethod')?.value;
            const manualGroup = document.getElementById('leaveHoursManualGroup');
            const timeRangeGroup = document.getElementById('leaveHoursTimeRangeGroup');
            const multiplePeriodsGroup = document.getElementById('leaveHoursMultiplePeriodsGroup');
            
            // ÿ•ÿÆŸÅÿßÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ¨ŸÖŸàÿπÿßÿ™ ÿ£ŸàŸÑÿßŸã
            if (manualGroup) manualGroup.style.display = 'none';
            if (timeRangeGroup) timeRangeGroup.style.display = 'none';
            if (multiplePeriodsGroup) multiplePeriodsGroup.style.display = 'none';
            
            if (method === 'time-range') {
                if (timeRangeGroup) timeRangeGroup.style.display = 'block';
                // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ≥ÿßÿπÿßÿ™ ÿπŸÜÿØ ÿßŸÑÿ™ÿ®ÿØŸäŸÑ
                calculateLeaveHoursFromTime();
            } else if (method === 'multiple-periods') {
                if (multiplePeriodsGroup) multiplePeriodsGroup.style.display = 'block';
                // ÿ•ÿ∂ÿßŸÅÿ© ŸÅÿ™ÿ±ÿ© ÿ≤ŸÖŸÜŸäÿ© ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ© ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿßŸÑÿ≠ÿßŸàŸäÿ© ŸÅÿßÿ±ÿ∫ÿ©
                const container = document.getElementById('leaveTimePeriodsContainer');
                if (container && container.children.length === 0) {
                    addLeaveTimePeriod();
                }
                // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ≥ÿßÿπÿßÿ™ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸäÿ©
                calculateTotalLeaveHoursFromPeriods();
            } else {
                // manual
                if (manualGroup) manualGroup.style.display = 'block';
            }
        }
        
        // ÿ•ÿ∂ÿßŸÅÿ© ŸÅÿ™ÿ±ÿ© ÿ≤ŸÖŸÜŸäÿ© ÿ¨ÿØŸäÿØÿ© ŸÑŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿßŸÑÿ≤ŸÖŸÜŸäÿ© ÿßŸÑŸÖÿ™ŸÇÿ∑ÿπÿ©
        function addLeaveTimePeriod() {
            const container = document.getElementById('leaveTimePeriodsContainer');
            if (!container) return;
            
            const periodIndex = container.children.length;
            const periodDiv = document.createElement('div');
            periodDiv.className = 'leave-time-period';
            periodDiv.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; margin-bottom: 10px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;';
            periodDiv.innerHTML = `
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">ŸÖŸÜ:</label>
                    <input type="time" class="period-start-time" onchange="calculateTotalLeaveHoursFromPeriods()" style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">ÿ•ŸÑŸâ:</label>
                    <input type="time" class="period-end-time" onchange="calculateTotalLeaveHoursFromPeriods()" style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px;">
                </div>
                <div style="display: flex; align-items: flex-end;">
                    <button type="button" class="btn btn-danger" onclick="removeLeaveTimePeriod(this)" style="padding: 10px 15px; font-size: 14px;">üóëÔ∏è</button>
                </div>
            `;
            
            container.appendChild(periodDiv);
            // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ≥ÿßÿπÿßÿ™ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸäÿ© ÿ®ÿπÿØ ÿßŸÑÿ•ÿ∂ÿßŸÅÿ©
            calculateTotalLeaveHoursFromPeriods();
        }
        
        // ÿ≠ÿ∞ŸÅ ŸÅÿ™ÿ±ÿ© ÿ≤ŸÖŸÜŸäÿ©
        function removeLeaveTimePeriod(button) {
            const periodDiv = button.closest('.leave-time-period');
            if (periodDiv) {
                periodDiv.remove();
                calculateTotalLeaveHoursFromPeriods();
            }
        }
        
        // ÿ≠ÿ≥ÿßÿ® ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ≥ÿßÿπÿßÿ™ ŸÖŸÜ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÅÿ™ÿ±ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ©
        function calculateTotalLeaveHoursFromPeriods() {
            const container = document.getElementById('leaveTimePeriodsContainer');
            const totalHoursSpan = document.getElementById('leaveTotalCalculatedHours');
            const hoursInput = document.getElementById('leaveHours');
            
            if (!container) return;
            
            let totalHours = 0;
            const periods = container.querySelectorAll('.leave-time-period');
            
            periods.forEach(period => {
                const startTimeInput = period.querySelector('.period-start-time');
                const endTimeInput = period.querySelector('.period-end-time');
                
                if (startTimeInput && endTimeInput && startTimeInput.value && endTimeInput.value) {
                    const startTime = startTimeInput.value;
                    const endTime = endTimeInput.value;
                    
                    // ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿ£ŸàŸÇÿßÿ™ ÿ•ŸÑŸâ ÿØŸÇÿßÿ¶ŸÇ
                    const [startHours, startMinutes] = startTime.split(':').map(Number);
                    const [endHours, endMinutes] = endTime.split(':').map(Number);
                    
                    const startTotalMinutes = startHours * 60 + startMinutes;
                    const endTotalMinutes = endHours * 60 + endMinutes;
                    
                    // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÅÿ±ŸÇ ÿ®ÿßŸÑÿØŸÇÿßÿ¶ŸÇ
                    let diffMinutes = endTotalMinutes - startTotalMinutes;
                    
                    // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑŸàŸÇÿ™ ÿßŸÑŸÜŸáÿßÿ¶Ÿä ŸÇÿ®ŸÑ ÿßŸÑŸàŸÇÿ™ ÿßŸÑÿßÿ®ÿ™ÿØÿßÿ¶Ÿäÿå ŸÜÿπÿ™ÿ®ÿ± ÿ£ŸÜŸá ÿßŸÑŸäŸàŸÖ ÿßŸÑÿ™ÿßŸÑŸä
                    if (diffMinutes < 0) {
                        diffMinutes += 24 * 60; // ÿ•ÿ∂ÿßŸÅÿ© 24 ÿ≥ÿßÿπÿ©
                    }
                    
                    // ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿØŸÇÿßÿ¶ŸÇ ÿ•ŸÑŸâ ÿ≥ÿßÿπÿßÿ™
                    const hours = diffMinutes / 60;
                    totalHours += hours;
                }
            });
            
            // ÿ™ŸÇÿ±Ÿäÿ® ÿ•ŸÑŸâ ÿ£ŸÇÿ±ÿ® 0.5
            const roundedTotalHours = Math.round(totalHours * 2) / 2;
            
            // ÿπÿ±ÿ∂ ÿßŸÑŸÜÿ™Ÿäÿ¨ÿ©
            if (totalHoursSpan) {
                totalHoursSpan.textContent = roundedTotalHours.toFixed(1);
            }
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ŸÇŸÑ ÿßŸÑÿ≥ÿßÿπÿßÿ™
            if (hoursInput) {
                hoursInput.value = roundedTotalHours.toFixed(1);
            }
        }
        
        // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ≥ÿßÿπÿßÿ™ ŸÖŸÜ ŸàŸÇÿ™ ÿßŸÑÿ®ÿØÿßŸäÿ© ŸàÿßŸÑŸÜŸáÿßŸäÿ© ŸÑŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿßŸÑÿ≤ŸÖŸÜŸäÿ©
        function calculateLeaveHoursFromTime() {
            const startTime = document.getElementById('leaveStartTime')?.value;
            const endTime = document.getElementById('leaveEndTime')?.value;
            const calculatedHoursSpan = document.getElementById('leaveCalculatedHours');
            const hoursInput = document.getElementById('leaveHours');
            
            if (!startTime || !endTime) {
                if (calculatedHoursSpan) calculatedHoursSpan.textContent = '0';
                if (hoursInput) hoursInput.value = '';
                return;
            }
            
            // ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿ£ŸàŸÇÿßÿ™ ÿ•ŸÑŸâ ÿØŸÇÿßÿ¶ŸÇ
            const [startHours, startMinutes] = startTime.split(':').map(Number);
            const [endHours, endMinutes] = endTime.split(':').map(Number);
            
            const startTotalMinutes = startHours * 60 + startMinutes;
            const endTotalMinutes = endHours * 60 + endMinutes;
            
            // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÅÿ±ŸÇ ÿ®ÿßŸÑÿØŸÇÿßÿ¶ŸÇ
            let diffMinutes = endTotalMinutes - startTotalMinutes;
            
            // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑŸàŸÇÿ™ ÿßŸÑŸÜŸáÿßÿ¶Ÿä ŸÇÿ®ŸÑ ÿßŸÑŸàŸÇÿ™ ÿßŸÑÿßÿ®ÿ™ÿØÿßÿ¶Ÿäÿå ŸÜÿπÿ™ÿ®ÿ± ÿ£ŸÜŸá ÿßŸÑŸäŸàŸÖ ÿßŸÑÿ™ÿßŸÑŸä
            if (diffMinutes < 0) {
                diffMinutes += 24 * 60; // ÿ•ÿ∂ÿßŸÅÿ© 24 ÿ≥ÿßÿπÿ©
            }
            
            // ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿØŸÇÿßÿ¶ŸÇ ÿ•ŸÑŸâ ÿ≥ÿßÿπÿßÿ™ (ŸÖÿπ ÿØŸÇÿ© 0.5)
            const hours = diffMinutes / 60;
            const roundedHours = Math.round(hours * 2) / 2; // ÿ™ŸÇÿ±Ÿäÿ® ÿ•ŸÑŸâ ÿ£ŸÇÿ±ÿ® 0.5
            
            // ÿπÿ±ÿ∂ ÿßŸÑŸÜÿ™Ÿäÿ¨ÿ©
            if (calculatedHoursSpan) {
                calculatedHoursSpan.textContent = roundedHours.toFixed(1);
            }
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ŸÇŸÑ ÿßŸÑÿ≥ÿßÿπÿßÿ™
            if (hoursInput) {
                hoursInput.value = roundedHours.toFixed(1);
            }
        }
        
        // ŸÖÿπÿßŸÑÿ¨ÿ© ÿ™ÿ∫ŸäŸäÿ± ÿ∑ÿ±ŸäŸÇÿ© ÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿ≥ÿßÿπÿßÿ™ ŸÑŸÑŸÖŸáŸÖÿ© ÿßŸÑÿ≤ŸÖŸÜŸäÿ©
        function handleMissionHoursMethodChange() {
            const method = document.getElementById('leaveMissionHoursInputMethod')?.value;
            const manualGroup = document.getElementById('leaveMissionHoursManualGroup');
            const timeRangeGroup = document.getElementById('leaveMissionHoursTimeRangeGroup');
            
            if (method === 'time-range') {
                if (manualGroup) manualGroup.style.display = 'none';
                if (timeRangeGroup) timeRangeGroup.style.display = 'block';
                // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ≥ÿßÿπÿßÿ™ ÿπŸÜÿØ ÿßŸÑÿ™ÿ®ÿØŸäŸÑ
                calculateMissionHoursFromTime();
            } else {
                if (manualGroup) manualGroup.style.display = 'block';
                if (timeRangeGroup) timeRangeGroup.style.display = 'none';
            }
        }
        
        // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ≥ÿßÿπÿßÿ™ ŸÖŸÜ ŸàŸÇÿ™ ÿßŸÑÿ®ÿØÿßŸäÿ© ŸàÿßŸÑŸÜŸáÿßŸäÿ© ŸÑŸÑŸÖŸáŸÖÿ© ÿßŸÑÿ≤ŸÖŸÜŸäÿ©
        function calculateMissionHoursFromTime() {
            const startTime = document.getElementById('leaveMissionStartTime')?.value;
            const endTime = document.getElementById('leaveMissionEndTime')?.value;
            const calculatedHoursSpan = document.getElementById('leaveMissionCalculatedHours');
            const hoursInput = document.getElementById('leaveMissionHours');
            
            if (!startTime || !endTime) {
                if (calculatedHoursSpan) calculatedHoursSpan.textContent = '0';
                if (hoursInput) hoursInput.value = '';
                return;
            }
            
            // ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿ£ŸàŸÇÿßÿ™ ÿ•ŸÑŸâ ÿØŸÇÿßÿ¶ŸÇ
            const [startHours, startMinutes] = startTime.split(':').map(Number);
            const [endHours, endMinutes] = endTime.split(':').map(Number);
            
            const startTotalMinutes = startHours * 60 + startMinutes;
            const endTotalMinutes = endHours * 60 + endMinutes;
            
            // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÅÿ±ŸÇ ÿ®ÿßŸÑÿØŸÇÿßÿ¶ŸÇ
            let diffMinutes = endTotalMinutes - startTotalMinutes;
            
            // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑŸàŸÇÿ™ ÿßŸÑŸÜŸáÿßÿ¶Ÿä ŸÇÿ®ŸÑ ÿßŸÑŸàŸÇÿ™ ÿßŸÑÿßÿ®ÿ™ÿØÿßÿ¶Ÿäÿå ŸÜÿπÿ™ÿ®ÿ± ÿ£ŸÜŸá ÿßŸÑŸäŸàŸÖ ÿßŸÑÿ™ÿßŸÑŸä
            if (diffMinutes < 0) {
                diffMinutes += 24 * 60; // ÿ•ÿ∂ÿßŸÅÿ© 24 ÿ≥ÿßÿπÿ©
            }
            
            // ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿØŸÇÿßÿ¶ŸÇ ÿ•ŸÑŸâ ÿ≥ÿßÿπÿßÿ™ (ŸÖÿπ ÿØŸÇÿ© 0.5)
            const hours = diffMinutes / 60;
            const roundedHours = Math.round(hours * 2) / 2; // ÿ™ŸÇÿ±Ÿäÿ® ÿ•ŸÑŸâ ÿ£ŸÇÿ±ÿ® 0.5
            
            // ÿπÿ±ÿ∂ ÿßŸÑŸÜÿ™Ÿäÿ¨ÿ©
            if (calculatedHoursSpan) {
                calculatedHoursSpan.textContent = roundedHours.toFixed(1);
            }
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ŸÇŸÑ ÿßŸÑÿ≥ÿßÿπÿßÿ™
            if (hoursInput) {
                hoursInput.value = roundedHours.toFixed(1);
            }
        }

        // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨
        // ============================================
        // ÿØŸàÿßŸÑ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸàÿßŸÑÿÆÿ±Ÿàÿ¨
        // ============================================
        
        // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
        async function handleLogin(event) {
            if (event) {
                event.preventDefault();
            }
            
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const rememberMe = document.getElementById('rememberMe').checked;
            const errorDiv = document.getElementById('loginError');
            const loadingDiv = document.getElementById('loginLoading');
            const loginBtn = document.getElementById('loginBtn');
            
            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
            if (!email || !password) {
                errorDiv.textContent = 'ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ŸàŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±';
                errorDiv.classList.add('show');
                return;
            }
            
            // ÿ•ÿ∏Ÿáÿßÿ± ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ
            loginBtn.disabled = true;
            loadingDiv.classList.add('show');
            errorDiv.classList.remove('show');
            
            try {
                if (!window.auth || !window.signInWithEmailAndPassword) {
                    throw new Error('Firebase Authentication ÿ∫Ÿäÿ± ŸÖŸáŸäÿ£');
                }
                
                // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
                const userCredential = await window.signInWithEmailAndPassword(window.auth, email, password);
                currentUser = userCredential.user;
                
                // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿπŸÑÿßŸÖÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ ÿßŸÑŸäÿØŸàŸä
                isManualLogout = false;
                
                console.log('‚úÖ ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ŸÜÿ¨ÿßÿ≠:', email);
                
                // ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿ≥ÿ¨ŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÅŸä Firestore
                await ensureUserRecordExists(currentUser);
                
                // ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ•ÿ∞ÿß ÿ™ŸÖ ÿßÿÆÿ™Ÿäÿßÿ± "ÿ™ÿ∞ŸÉÿ±ŸÜŸä" (ŸÖÿß ÿπÿØÿß ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ£ŸàŸÑ ŸÑÿ∂ŸÖÿßŸÜ ÿ£ŸÜ ŸÉŸÑ ÿ≤ÿßÿ¶ÿ± Ÿäÿ≥ÿ¨ŸëŸÑ ÿØÿÆŸàŸÑŸá ÿ®ŸÜŸÅÿ≥Ÿá)
                if (rememberMe) {
                    try {
                        if (email !== FIRST_USER_EMAIL) {
                            localStorage.setItem('hrm_remembered_email', email);
                            localStorage.setItem('hrm_remembered_password', password);
                            localStorage.setItem('hrm_remember_me', 'true');
                            console.log('‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ÿ±ŸäÿØ ŸàŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ŸÑŸÑÿ¨ŸÑÿ≥ÿ© ÿßŸÑŸÇÿßÿØŸÖÿ©');
                        } else {
                            localStorage.removeItem('hrm_remembered_email');
                            localStorage.removeItem('hrm_remembered_password');
                            localStorage.setItem('hrm_remember_me', 'true');
                        }
                    } catch (storageError) {
                        console.warn('‚ö†Ô∏è ŸÑÿß ŸäŸÖŸÉŸÜ ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ:', storageError);
                    }
                } else {
                    localStorage.removeItem('hrm_remembered_email');
                    localStorage.removeItem('hrm_remembered_password');
                    localStorage.removeItem('hrm_remember_me');
                }
                
                // ÿ•ÿÆŸÅÿßÿ° Ÿàÿßÿ¨Ÿáÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ Ÿàÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ
                showApp();
                
                // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ÿπÿØ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
                try {
                    // ÿ™ÿ≠ŸÖŸäŸÑ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ¥ÿ±ŸÉÿ©
                    await loadCompanyInfo();
                    updateCompanyLogoInApp();
                    
                    // ÿ™ÿ≠ŸÖŸäŸÑ ÿ•ÿπÿØÿßÿØÿßÿ™ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                    loadDatabaseSettings();
                    
                    // ÿ™ÿ≠ŸÖŸäŸÑ ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ
                    await loadDashboardStats();
                } catch (loadError) {
                    console.error('‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:', loadError);
                }
                
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ:', error);
                
                let errorMessage = 'ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ';
                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = 'ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠';
                } else if (error.code === 'auth/user-disabled') {
                    errorMessage = 'ÿ™ŸÖ ÿ™ÿπÿ∑ŸäŸÑ Ÿáÿ∞ÿß ÿßŸÑÿ≠ÿ≥ÿßÿ®';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'ÿ™ŸÖ ÿ™ÿ¨ÿßŸàÿ≤ ÿπÿØÿØ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿßÿ™ ÿßŸÑŸÖÿ≥ŸÖŸàÿ≠ ÿ®Ÿáÿß. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÑÿßÿ≠ŸÇÿßŸã';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                errorDiv.textContent = errorMessage;
                errorDiv.classList.add('show');
            } finally {
                loginBtn.disabled = false;
                loadingDiv.classList.remove('show');
            }
        }
        
        // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨
        function handleLogout() {
            // #region agent log
            console.log('üîç [DEBUG-A] ÿØÿÆŸàŸÑ handleLogout');
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßÿ≥ÿ™ÿØÿπÿßÿ° logging ÿßŸÑÿÆÿßÿ±ÿ¨Ÿä
            // #endregion
            if (confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ÿü')) {
                // ÿ™ÿπŸäŸäŸÜ ÿπŸÑÿßŸÖÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ ÿßŸÑŸäÿØŸàŸä
                isManualLogout = true;
                // #region agent log
                try {
                    sessionStorage.setItem('hrm_manual_logout', 'true');
                    console.log('üîç [DEBUG-A] ÿ™ÿπŸäŸäŸÜ isManualLogout = true Ÿàÿ≠ŸÅÿ∏Ÿá ŸÅŸä sessionStorage');
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßÿ≥ÿ™ÿØÿπÿßÿ° logging ÿßŸÑÿÆÿßÿ±ÿ¨Ÿä
                } catch (e) {
                    console.log('üîç [DEBUG-A] ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ sessionStorage:', e);
                }
                // #endregion
                
                if (window.signOut && window.auth) {
                    // #region agent log
                    console.log('üîç [DEBUG-A] ŸÇÿ®ŸÑ ÿßÿ≥ÿ™ÿØÿπÿßÿ° signOut');
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßÿ≥ÿ™ÿØÿπÿßÿ° logging ÿßŸÑÿÆÿßÿ±ÿ¨Ÿä
                    // #endregion
                    window.signOut(window.auth).then(() => {
                        // #region agent log
                        console.log('üîç [DEBUG-A] ÿ®ÿπÿØ signOut - ŸÜÿ¨ÿ≠');
                        // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßÿ≥ÿ™ÿØÿπÿßÿ° logging ÿßŸÑÿÆÿßÿ±ÿ¨Ÿä
                        // #endregion
                        currentUser = null;
                        showLogin();
                    }).catch(error => {
                        // #region agent log
                        console.log('üîç [DEBUG-A] ÿÆÿ∑ÿ£ ŸÅŸä signOut:', error.message);
                        // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßÿ≥ÿ™ÿØÿπÿßÿ° logging ÿßŸÑÿÆÿßÿ±ÿ¨Ÿä
                        // #endregion
                        console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨:', error);
                        currentUser = null;
                        showLogin();
                    });
                } else {
                    currentUser = null;
                    showLogin();
                }
            }
        }
        
        // ÿ•ÿ∏Ÿáÿßÿ± Ÿàÿßÿ¨Ÿáÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
        function showLogin() {
            const loginScreen = document.getElementById('loginScreen');
            const app = document.getElementById('app');
            if (loginScreen) loginScreen.classList.remove('hidden');
            if (app) app.classList.add('hidden');
            
            // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ÿ±ŸäÿØ ŸàŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ŸäŸÜ ÿ•ÿ∞ÿß ŸÉÿßŸÜ "ÿ™ÿ∞ŸÉÿ±ŸÜŸä" ŸÖŸÅÿπŸëŸÑ (ŸÖÿπ ŸÖŸÜÿπ ÿπÿ±ÿ∂ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ£ŸàŸÑ)
            let rememberedEmail = localStorage.getItem('hrm_remembered_email');
            let rememberedPassword = localStorage.getItem('hrm_remembered_password');
            if (rememberedEmail === FIRST_USER_EMAIL || rememberedPassword === FIRST_USER_PASSWORD) {
                rememberedEmail = '';
                rememberedPassword = '';
                try {
                    localStorage.removeItem('hrm_remembered_email');
                    localStorage.removeItem('hrm_remembered_password');
                    localStorage.removeItem('hrm_remember_me');
                } catch (e) {}
            }
            const rememberMe = localStorage.getItem('hrm_remember_me') === 'true';
            const loginEmail = document.getElementById('loginEmail');
            const loginPassword = document.getElementById('loginPassword');
            const rememberMeCheckbox = document.getElementById('rememberMe');
            const loginError = document.getElementById('loginError');
            
            if (loginEmail) {
                if (rememberMe && rememberedEmail) {
                    loginEmail.value = rememberedEmail;
                } else {
                    loginEmail.value = '';
                }
            }
            if (loginPassword) {
                loginPassword.value = (rememberMe && rememberedPassword) ? rememberedPassword : '';
            }
            if (rememberMeCheckbox) rememberMeCheckbox.checked = rememberMe;
            if (loginError) loginError.classList.remove('show');
            
            // ÿßŸÑÿ™ÿ±ŸÉŸäÿ≤ ÿπŸÑŸâ ÿ≠ŸÇŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿ®ÿ±ŸäÿØ ŸÖÿ≠ŸÅŸàÿ∏ÿßŸã
            if (rememberMe && rememberedEmail && loginPassword) {
                setTimeout(() => loginPassword.focus(), 100);
            } else if (loginEmail) {
                setTimeout(() => loginEmail.focus(), 100);
            }
        }
        
        // ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä
        async function showApp() {
            const loginScreen = document.getElementById('loginScreen');
            const app = document.getElementById('app');
            if (loginScreen) loginScreen.classList.add('hidden');
            if (app) app.classList.remove('hidden');
            
            // ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
            await updateUserInfo();
            
            // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
            await loadDashboardStats();
            await loadEmployees();
            await loadProjects();
            await loadLeaves();
            await loadUsers();
        }
        
        // ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÅŸä ÿßŸÑŸáŸäÿØÿ±
        async function updateUserInfo() {
            if (!currentUser || !window.db || !window.firestore) return;
            
            try {
                // ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖŸÜ Firestore
                const userDoc = await window.firestore.getDoc(
                    window.firestore.doc(window.db, 'users', currentUser.uid)
                );
                
                const userInfoElement = document.getElementById('userInfo');
                if (!userInfoElement) return;
                
                const userNameElement = userInfoElement.querySelector('.header-user-name');
                const userRoleElement = userInfoElement.querySelector('.header-user-role');
                
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    const userName = userData.name || currentUser.email.split('@')[0];
                    const userRole = userData.role || 'employee';
                    
                    if (userNameElement) {
                        userNameElement.textContent = userName;
                    }
                    if (userRoleElement) {
                        userRoleElement.textContent = getRoleName(userRole);
                    }
                } else {
                    if (userNameElement) {
                        userNameElement.textContent = currentUser.email.split('@')[0];
                    }
                    if (userRoleElement) {
                        userRoleElement.textContent = 'ŸÖŸàÿ∏ŸÅ';
                    }
                }
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ:', error);
                const userInfoElement = document.getElementById('userInfo');
                if (userInfoElement && currentUser) {
                    const userNameElement = userInfoElement.querySelector('.header-user-name');
                    const userRoleElement = userInfoElement.querySelector('.header-user-role');
                    if (userNameElement) {
                        userNameElement.textContent = currentUser.email.split('@')[0];
                    }
                    if (userRoleElement) {
                        userRoleElement.textContent = 'ŸÖŸàÿ∏ŸÅ';
                    }
                }
            }
        }
        
        // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßÿ≥ŸÖ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ©
        function getRoleName(role) {
            return t(role) || role;
        }
        
        // ÿ™ÿ®ÿØŸäŸÑ ÿßŸÑŸÑÿ∫ÿ©
        function toggleLanguage() {
            const newLang = currentLanguage === 'ar' ? 'en' : 'ar';
            switchLanguage(newLang);
        }
        
        // ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑŸÑÿ∫ÿ© ÿπŸÜÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©
        function initLanguage() {
            document.documentElement.lang = currentLanguage;
            document.documentElement.dir = currentLanguage === 'ar' ? 'rtl' : 'ltr';
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿ≤ÿ± ÿßŸÑŸÑÿ∫ÿ©
            const languageText = document.getElementById('languageText');
            if (languageText) {
                languageText.textContent = currentLanguage === 'ar' ? 'EN' : 'AR';
            }
            
            // ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ™ÿ±ÿ¨ŸÖÿßÿ™
            applyTranslations();
            
            applyTranslations();
        }
        
        // ÿ™ŸáŸäÿ¶ÿ© ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ™ÿµŸÅÿ≠
        function resetBrowserData() {
            const password = prompt('ÿ£ÿØÿÆŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ŸÑÿ™ŸáŸäÿ¶ÿ© ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ™ÿµŸÅÿ≠:');
            if (password === '1475963') {
                if (confirm('‚ö†Ô∏è ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ™ŸáŸäÿ¶ÿ© ÿ¨ŸÖŸäÿπ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ÿü\n\nÿ≥Ÿäÿ™ŸÖ ÿ≠ÿ∞ŸÅ:\n- ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ© ŸÖÿ≠ŸÑŸäÿßŸã\n- ÿ•ÿπÿØÿßÿØÿßÿ™ Firebase\n- ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ¨ŸÑÿ≥ÿ©\n\nŸáÿ∞Ÿá ÿßŸÑÿπŸÖŸÑŸäÿ© ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜŸáÿß!')) {
                    try {
                        localStorage.clear();
                        sessionStorage.clear();
                        alert('‚úÖ ÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿ¨ŸÖŸäÿπ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ ÿ®ŸÜÿ¨ÿßÿ≠!\nÿ≥Ÿäÿ™ŸÖ ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©...');
                        location.reload();
                    } catch (error) {
                        console.error('ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:', error);
                        alert('‚ùå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
                    }
                }
            } else if (password !== null) {
                alert('‚ùå ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©');
            }
        }

        // ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÜŸàÿßŸÅÿ∞ ÿπŸÜÿØ ÿßŸÑŸÜŸÇÿ± ÿÆÿßÿ±ÿ¨Ÿáÿß
        window.addEventListener('click', function(event) {
            const employeeModal = document.getElementById('employeeModal');
            if (event.target === employeeModal) {
                hideAddEmployeeForm();
            }

            const projectModal = document.getElementById('projectModal');
            if (event.target === projectModal) {
                hideAddProjectForm();
            }

            const leaveModal = document.getElementById('leaveModal');
            if (event.target === leaveModal) {
                hideAddLeaveForm();
            }

            const userModal = document.getElementById('userModal');
            if (event.target === userModal) {
                hideAddUserForm();
            }
        });

        // ============================================
        // ÿ•ÿØÿßÿ±ÿ© ÿ•ÿπÿØÿßÿØÿßÿ™ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
        // ============================================
        const DB_SETTINGS_PASSWORD = '1475963';
        let dbSettingsEditMode = false;

        // ÿ™ÿ≠ŸÖŸäŸÑ ÿ•ÿπÿØÿßÿØÿßÿ™ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
        function loadDatabaseSettings() {
            try {
                const savedConfig = localStorage.getItem(window.HRM_FIREBASE_CONFIG_KEY || 'hrm_firebase_config');
                if (savedConfig) {
                    const config = JSON.parse(savedConfig);
                    document.getElementById('dbApiKey').value = config.apiKey || '';
                    document.getElementById('dbAuthDomain').value = config.authDomain || '';
                    document.getElementById('dbProjectId').value = config.projectId || '';
                    document.getElementById('dbStorageBucket').value = config.storageBucket || '';
                    document.getElementById('dbMessagingSenderId').value = config.messagingSenderId || '';
                    document.getElementById('dbAppId').value = config.appId || '';
                } else {
                    // ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©
                    document.getElementById('dbApiKey').value = 'AIzaSyDIv558hbbEgBfErYUAjtI41HFDI_P6bLM';
                    document.getElementById('dbAuthDomain').value = 'purchase-order-f1010.firebaseapp.com';
                    document.getElementById('dbProjectId').value = 'purchase-order-f1010';
                    document.getElementById('dbStorageBucket').value = 'purchase-order-f1010.firebasestorage.app';
                    document.getElementById('dbMessagingSenderId').value = '340050509000';
                    document.getElementById('dbAppId').value = '1:340050509000:web:08a6605bf0e595ecd679fd';
                }
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿ•ÿπÿØÿßÿØÿßÿ™ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:', error);
            }
        }

        // ÿ™ŸÅÿπŸäŸÑ/ÿ™ÿπÿ∑ŸäŸÑ Ÿàÿ∂ÿπ ÿßŸÑÿ™ÿπÿØŸäŸÑ
        function toggleDatabaseSettingsEdit() {
            if (!dbSettingsEditMode) {
                const password = prompt('ÿ£ÿØÿÆŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ŸÑÿ™ÿπÿØŸäŸÑ ÿ•ÿπÿØÿßÿØÿßÿ™ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:');
                if (password !== DB_SETTINGS_PASSWORD) {
                    alert('‚ùå ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©');
                    return;
                }
                
                // ÿ™ŸÅÿπŸäŸÑ Ÿàÿ∂ÿπ ÿßŸÑÿ™ÿπÿØŸäŸÑ
                dbSettingsEditMode = true;
                document.getElementById('dbEditBtn').textContent = 'üîí ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ™ÿπÿØŸäŸÑ';
                document.getElementById('dbSaveButtons').style.display = 'flex';
                document.getElementById('dbSaveButtons').style.gap = '10px';
                
                // ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ≠ŸÇŸàŸÑ
                document.getElementById('dbApiKey').readOnly = false;
                document.getElementById('dbApiKey').style.background = '#fff';
                document.getElementById('dbAuthDomain').readOnly = false;
                document.getElementById('dbAuthDomain').style.background = '#fff';
                document.getElementById('dbProjectId').readOnly = false;
                document.getElementById('dbProjectId').style.background = '#fff';
                document.getElementById('dbStorageBucket').readOnly = false;
                document.getElementById('dbStorageBucket').style.background = '#fff';
                document.getElementById('dbMessagingSenderId').readOnly = false;
                document.getElementById('dbMessagingSenderId').style.background = '#fff';
                document.getElementById('dbAppId').readOnly = false;
                document.getElementById('dbAppId').style.background = '#fff';
            } else {
                cancelDatabaseSettingsEdit();
            }
        }

        // ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ™ÿπÿØŸäŸÑ
        function cancelDatabaseSettingsEdit() {
            dbSettingsEditMode = false;
            document.getElementById('dbEditBtn').textContent = 'üîì ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™';
            document.getElementById('dbSaveButtons').style.display = 'none';
            
            // ÿ™ÿπÿ∑ŸäŸÑ ÿßŸÑÿ≠ŸÇŸàŸÑ Ÿàÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÇŸäŸÖ
            document.getElementById('dbApiKey').readOnly = true;
            document.getElementById('dbApiKey').style.background = '#e9ecef';
            document.getElementById('dbAuthDomain').readOnly = true;
            document.getElementById('dbAuthDomain').style.background = '#e9ecef';
            document.getElementById('dbProjectId').readOnly = true;
            document.getElementById('dbProjectId').style.background = '#e9ecef';
            document.getElementById('dbStorageBucket').readOnly = true;
            document.getElementById('dbStorageBucket').style.background = '#e9ecef';
            document.getElementById('dbMessagingSenderId').readOnly = true;
            document.getElementById('dbMessagingSenderId').style.background = '#e9ecef';
            document.getElementById('dbAppId').readOnly = true;
            document.getElementById('dbAppId').style.background = '#e9ecef';
            
            // ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÇŸäŸÖ ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ©
            loadDatabaseSettings();
        }

        // ÿ≠ŸÅÿ∏ ÿ•ÿπÿØÿßÿØÿßÿ™ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
        async function saveDatabaseSettings() {
            const password = prompt('ÿ£ÿØÿÆŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ŸÑÿ™ÿ£ŸÉŸäÿØ ÿ≠ŸÅÿ∏ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™:');
            if (password !== DB_SETTINGS_PASSWORD) {
                alert('‚ùå ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©');
                return;
            }

            const config = {
                apiKey: document.getElementById('dbApiKey').value.trim(),
                authDomain: document.getElementById('dbAuthDomain').value.trim(),
                projectId: document.getElementById('dbProjectId').value.trim(),
                storageBucket: document.getElementById('dbStorageBucket').value.trim(),
                messagingSenderId: document.getElementById('dbMessagingSenderId').value.trim(),
                appId: document.getElementById('dbAppId').value.trim()
            };

            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµÿ≠ÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
            if (!config.apiKey || !config.authDomain || !config.projectId) {
                alert('‚ùå Ÿäÿ¨ÿ® ÿ•ÿØÿÆÿßŸÑ API Key Ÿà Auth Domain Ÿà Project ID ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ');
                return;
            }

            try {
                // ÿ≠ŸÅÿ∏ ŸÅŸä localStorage
                localStorage.setItem(window.HRM_FIREBASE_CONFIG_KEY || 'hrm_firebase_config', JSON.stringify(config));
                
                // ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ© ŸÑÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™
                // (ÿ≥Ÿäÿ™ŸÖ ÿ™ŸáŸäÿ¶ÿ© Firebase ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ÿπŸÜÿØ ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ)
                
                alert('‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿ•ÿπÿØÿßÿØÿßÿ™ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠!\n\n‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ© ŸÑÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™.');
                cancelDatabaseSettingsEdit();
            } catch (error) {
                alert('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™: ' + error.message);
                console.error(error);
            }
        }

        // ============================================
        // ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ¥ÿ±ŸÉÿ©
        // ============================================
        let companyInfo = null;

        // ÿ™ÿ≠ŸÖŸäŸÑ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ¥ÿ±ŸÉÿ©
        async function loadCompanyInfo() {
            try {
                if (!window.db || !window.firestore) {
                    console.warn('Firebase ÿ∫Ÿäÿ± ŸÖŸáŸäÿ£');
                    return;
                }

                const settingsRef = window.firestore.doc(window.db, 'settings', 'company');
                const settingsDoc = await window.firestore.getDoc(settingsRef);

                if (settingsDoc.exists()) {
                    companyInfo = settingsDoc.data();
                    
                    // ÿ™ÿπÿ®ÿ¶ÿ© ÿßŸÑÿ≠ŸÇŸàŸÑ
                    document.getElementById('companyName').value = companyInfo.name || '';
                    document.getElementById('companyAddress').value = companyInfo.address || '';
                    document.getElementById('companyPhone').value = companyInfo.phone || '';
                    document.getElementById('companyFax').value = companyInfo.fax || '';
                    document.getElementById('companyEmail').value = companyInfo.email || '';
                    document.getElementById('companyWebsite').value = companyInfo.website || '';
                    document.getElementById('companyCommercialRegister').value = companyInfo.commercialRegister || '';
                    document.getElementById('companyDescription').value = companyInfo.description || '';
                    
                    // ÿπÿ±ÿ∂ ÿßŸÑÿ¥ÿπÿßÿ±
                    if (companyInfo.logo) {
                        displayCompanyLogo(companyInfo.logo);
                    } else {
                        clearCompanyLogoPreview();
                    }
                    
                    console.log('‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ¥ÿ±ŸÉÿ©');
                } else {
                    // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ≠ŸÇŸàŸÑ
                    clearCompanyInfoForm();
                    console.log('‚ÑπÔ∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ¥ÿ±ŸÉÿ© ŸÖÿ≠ŸÅŸàÿ∏ÿ©');
                }
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ¥ÿ±ŸÉÿ©:', error);
                alert('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ¥ÿ±ŸÉÿ©: ' + error.message);
            }
        }

        // ÿ≠ŸÅÿ∏ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ¥ÿ±ŸÉÿ©
        async function saveCompanyInfo() {
            try {
                if (!window.db || !window.firestore) {
                    alert('‚ùå Firebase ÿ∫Ÿäÿ± ŸÖŸáŸäÿ£');
                    return;
                }

                const companyName = document.getElementById('companyName').value.trim();
                if (!companyName) {
                    alert('‚ùå Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿßŸÑÿ¥ÿ±ŸÉÿ©');
                    return;
                }

                const companyData = {
                    name: companyName,
                    address: document.getElementById('companyAddress').value.trim(),
                    phone: document.getElementById('companyPhone').value.trim(),
                    fax: document.getElementById('companyFax').value.trim(),
                    email: document.getElementById('companyEmail').value.trim(),
                    website: document.getElementById('companyWebsite').value.trim(),
                    commercialRegister: document.getElementById('companyCommercialRegister').value.trim(),
                    description: document.getElementById('companyDescription').value.trim(),
                    updatedAt: new Date().toISOString(),
                    updatedBy: currentUser?.email || 'unknown'
                };

                // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ¥ÿπÿßÿ± ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÖŸàÿ¨ŸàÿØÿßŸã
                const logoPreview = document.getElementById('companyLogoPreview');
                const logoImg = logoPreview.querySelector('img');
                if (logoImg && logoImg.src && logoImg.src.startsWith('data:')) {
                    companyData.logo = logoImg.src;
                } else if (companyInfo && companyInfo.logo) {
                    // ÿßŸÑÿßÿ≠ÿ™ŸÅÿßÿ∏ ÿ®ÿßŸÑÿ¥ÿπÿßÿ± ÿßŸÑŸÇÿØŸäŸÖ ÿ•ÿ∞ÿß ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿ∫ŸäŸäÿ±Ÿá
                    companyData.logo = companyInfo.logo;
                }

                const settingsRef = window.firestore.doc(window.db, 'settings', 'company');
                await window.firestore.setDoc(settingsRef, companyData, { merge: true });

                companyInfo = companyData;
                
                // ÿ™ÿ≠ÿØŸäÿ´ ÿπÿ±ÿ∂ ÿßŸÑÿ¥ÿπÿßÿ± ŸÅŸä ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ
                updateCompanyLogoInApp();

                alert('‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ¥ÿ±ŸÉÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
                console.log('‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ¥ÿ±ŸÉÿ©');
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ¥ÿ±ŸÉÿ©:', error);
                alert('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ¥ÿ±ŸÉÿ©: ' + error.message);
            }
        }

        // ŸÖÿπÿßŸÑÿ¨ÿ© ÿ±ŸÅÿπ ÿßŸÑÿ¥ÿπÿßÿ±
        function handleCompanyLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ŸÜŸàÿπ ÿßŸÑŸÖŸÑŸÅ
            if (!file.type.startsWith('image/')) {
                alert('‚ùå Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸÑŸÅ ÿµŸàÿ±ÿ©');
                return;
            }

            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ≠ÿ¨ŸÖ ÿßŸÑŸÖŸÑŸÅ (2MB)
            if (file.size > 2 * 1024 * 1024) {
                alert('‚ùå ÿ≠ÿ¨ŸÖ ÿßŸÑÿµŸàÿ±ÿ© ŸÉÿ®Ÿäÿ± ÿ¨ÿØÿßŸã. ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ: 2MB');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                displayCompanyLogo(e.target.result);
            };
            reader.onerror = function() {
                alert('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑŸÖŸÑŸÅ');
            };
            reader.readAsDataURL(file);
        }

        // ÿπÿ±ÿ∂ ÿßŸÑÿ¥ÿπÿßÿ±
        function displayCompanyLogo(logoData) {
            const preview = document.getElementById('companyLogoPreview');
            preview.innerHTML = `<img src="${logoData}" alt="ÿ¥ÿπÿßÿ± ÿßŸÑÿ¥ÿ±ŸÉÿ©" style="max-width: 100%; max-height: 100%; object-fit: contain;">`;
            document.getElementById('removeLogoBtn').style.display = 'inline-block';
        }

        // ÿ≠ÿ∞ŸÅ ÿßŸÑÿ¥ÿπÿßÿ±
        function removeCompanyLogo() {
            if (confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ¥ÿπÿßÿ±ÿü')) {
                clearCompanyLogoPreview();
                document.getElementById('companyLogoFile').value = '';
            }
        }

        // ŸÖÿ≥ÿ≠ ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑÿ¥ÿπÿßÿ±
        function clearCompanyLogoPreview() {
            const preview = document.getElementById('companyLogoPreview');
            preview.innerHTML = '<span style="color: #999;">ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑÿ¥ÿπÿßÿ±</span>';
            document.getElementById('removeLogoBtn').style.display = 'none';
        }

        // ŸÖÿ≥ÿ≠ ÿ¨ŸÖŸäÿπ ÿ≠ŸÇŸàŸÑ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ¥ÿ±ŸÉÿ©
        function clearCompanyInfoForm() {
            document.getElementById('companyName').value = '';
            document.getElementById('companyAddress').value = '';
            document.getElementById('companyPhone').value = '';
            document.getElementById('companyFax').value = '';
            document.getElementById('companyEmail').value = '';
            document.getElementById('companyWebsite').value = '';
            document.getElementById('companyCommercialRegister').value = '';
            document.getElementById('companyDescription').value = '';
            clearCompanyLogoPreview();
            document.getElementById('companyLogoFile').value = '';
        }

        // ÿ™ÿ≠ÿØŸäÿ´ ÿπÿ±ÿ∂ ÿßŸÑÿ¥ÿπÿßÿ± ŸÅŸä ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ (ŸÅŸä ÿßŸÑŸáŸäÿØÿ±)
        function updateCompanyLogoInApp() {
            const logoContainer = document.getElementById('companyLogoHeader');
            const companyNameElement = document.getElementById('companyNameHeader');
            
            if (!logoContainer) return;

            if (companyInfo && companyInfo.logo) {
                logoContainer.innerHTML = `<img src="${companyInfo.logo}" alt="${companyInfo.name || 'ÿ¥ÿπÿßÿ± ÿßŸÑÿ¥ÿ±ŸÉÿ©'}" style="max-width: 100%; max-height: 100%; object-fit: contain;">`;
            } else {
                logoContainer.innerHTML = '<div class="header-logo-placeholder">üè¢</div>';
            }

            if (companyNameElement) {
                if (companyInfo && companyInfo.name) {
                    companyNameElement.textContent = companyInfo.name;
                    companyNameElement.style.display = 'block';
                } else {
                    companyNameElement.style.display = 'none';
                }
            }
        }

        // ============================================
        // ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ
        // ============================================
        // ŸÅÿ™ÿ≠ ŸÇÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ (ÿ®ÿπÿØ ÿ•ÿØÿÆÿßŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±)
        function unlockUsersSection() {
            const password = prompt('üîí ŸÇÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ŸÖÿ≠ŸÖŸä ÿ®ŸÉŸÑŸÖÿ© ŸÖÿ±Ÿàÿ±\nÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±:');
            if (!password) return;
            
            if (password !== USERS_SECTION_PASSWORD) {
                alert('‚ùå ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©');
                return;
            }
            
            window.usersSectionUnlocked = true;
            const lockedDiv = document.getElementById('usersSectionLocked');
            const contentDiv = document.getElementById('usersSectionContent');
            
            if (lockedDiv) lockedDiv.style.display = 'none';
            if (contentDiv) contentDiv.style.display = 'block';
            
            // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ
            loadUsers();
        }
        
        // ŸÇŸÅŸÑ ŸÇÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ
        function lockUsersSection() {
            if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ŸÇŸÅŸÑ ŸÇÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜÿü')) return;
            
            window.usersSectionUnlocked = false;
            const lockedDiv = document.getElementById('usersSectionLocked');
            const contentDiv = document.getElementById('usersSectionContent');
            
            if (lockedDiv) lockedDiv.style.display = 'block';
            if (contentDiv) contentDiv.style.display = 'none';
        }
        
        async function loadUsers() {
            try {
                if (!window.db || !window.firestore) {
                    console.warn('Firebase ÿ∫Ÿäÿ± ŸÖŸáŸäÿ£');
                    const tbody = document.getElementById('usersTableBody');
                    if (tbody) {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #dc3545;">Firebase ÿ∫Ÿäÿ± ŸÖŸáŸäÿ£</td></tr>';
                    }
                    return;
                }

                console.log('ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ...');
                const usersRef = window.firestore.collection(window.db, 'users');
                const snapshot = await window.firestore.getDocs(usersRef);
                
                console.log('ÿπÿØÿØ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ÿßŸÑŸÖÿ≠ŸÖŸÑŸäŸÜ:', snapshot.size);
                
                usersData = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    usersData.push({ id: doc.id, ...data });
                    console.log('ŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖÿ≠ŸÖŸÑ:', data.email || data.name || doc.id);
                });

                console.log('ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ŸÅŸä ÿßŸÑÿ∞ÿßŸÉÿ±ÿ©:', usersData.length);
                displayUsers();
                updateUsersCount();
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ:', error);
                console.error('ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿÆÿ∑ÿ£:', error.code, error.message);
                
                if (error.code === 'permission-denied' || error.message?.includes('permission')) {
                    console.error('‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™: Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ∑ÿ®ŸäŸÇ ŸÇŸàÿßÿπÿØ Firestore ŸÅŸä Firebase Console');
                    if (!document.getElementById('firestoreRulesAlert')) {
                        const alertDiv = document.createElement('div');
                        alertDiv.id = 'firestoreRulesAlert';
                        alertDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #fff3cd; border: 2px solid #ffc107; border-radius: 10px; padding: 20px; max-width: 500px; z-index: 10000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);';
                        alertDiv.innerHTML = `
                            <h3 style="margin-top: 0; color: #856404;">‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™</h3>
                            <p style="color: #856404; margin-bottom: 15px;">Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ∑ÿ®ŸäŸÇ ŸÇŸàÿßÿπÿØ Firestore ÿßŸÑÿ™ÿßŸÑŸäÿ©:</p>
                            <ol style="color: #856404; margin-bottom: 15px; padding-right: 20px;">
                                <li>ÿßŸÅÿ™ÿ≠: <a href="https://console.firebase.google.com/project/purchase-order-f1010/firestore/rules" target="_blank" style="color: #667eea;">Firebase Console</a></li>
                                <li>ÿßŸÜÿ≥ÿÆ ŸàÿßŸÑÿµŸÇ ÿßŸÑŸÇŸàÿßÿπÿØ ŸÖŸÜ ŸÖŸÑŸÅ firestore.rules</li>
                                <li>ÿßÿ∂ÿ∫ÿ∑ "Publish"</li>
                            </ol>
                            <pre style="background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; font-size: 11px; margin-bottom: 15px; max-height: 300px; overflow-y: auto;">rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function isAuthenticated() {
      return request.auth != null;
    }
    function userExists() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data();
    }
    function isActiveUser() {
      return isAuthenticated() && userExists() && 
             (getUserData().active == true || getUserData().active == null);
    }
    function isAdmin() {
      return isActiveUser() && getUserData().role == 'admin';
    }
    function isHR() {
      return isActiveUser() && getUserData().role == 'hr';
    }
    function isAdminOrHR() {
      return isAdmin() || isHR();
    }
    
    match /users/{userId} {
      allow read: if isAuthenticated() && (request.auth.uid == userId || isAdminOrHR());
      allow write: if isAdmin();
    }
    match /employees/{employeeId} {
      allow read: if isActiveUser();
      allow create, update: if isAdminOrHR();
      allow delete: if isAdmin();
    }
    match /projects/{projectId} {
      allow read: if isActiveUser();
      allow write: if isAdminOrHR();
    }
    match /leaves/{leaveId} {
      allow read: if isActiveUser();
      allow create, update: if isAdminOrHR();
      allow delete: if isAdmin();
    }
    match /settings/{settingId} {
      allow read: if isActiveUser();
      allow write: if isAdmin();
    }
    match /{document=**} {
      allow read: if isActiveUser();
      allow write: if isAdminOrHR();
    }
  }
}</pre>
                            <p style="color: #856404; font-size: 12px; margin-top: 10px;">
                                <strong>ŸÖŸÑÿßÿ≠ÿ∏ÿ©:</strong> Ÿáÿ∞Ÿá ÿßŸÑŸÇŸàÿßÿπÿØ ÿ™ÿ≥ŸÖÿ≠ ŸÅŸÇÿ∑ ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ÿßŸÑŸÖÿ≥ÿ¨ŸÑŸäŸÜ ÿ®ÿßŸÑŸàÿµŸàŸÑÿå ŸÖÿπ ÿµŸÑÿßÿ≠Ÿäÿßÿ™ ŸÖÿ≠ÿØÿØÿ© ÿ≠ÿ≥ÿ® ÿßŸÑÿØŸàÿ±.
                            </p>
                            <button onclick="this.parentElement.remove()" style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; width: 100%;">ŸÅŸáŸÖÿ™</button>
                        `;
                        document.body.appendChild(alertDiv);
                    }
                }
                
                const tbody = document.getElementById('usersTableBody');
                if (tbody) {
                    let errorMessage = 'ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™';
                    if (error.code === 'permission-denied') {
                        errorMessage = '‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿµŸÑÿßÿ≠Ÿäÿßÿ™ ŸÑŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸâ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ŸÇŸàÿßÿπÿØ ÿßŸÑÿ£ŸÖÿßŸÜ ŸÅŸä Firebase Console.';
                    } else {
                        errorMessage = 'ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™: ' + error.message;
                    }
                    tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 40px; color: #dc3545;">${errorMessage}</td></tr>`;
                }
            }
        }

        function displayUsers() {
            const tbody = document.getElementById('usersTableBody');
            if (!tbody) return;
            
            if (usersData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™</td></tr>';
                return;
            }

            tbody.innerHTML = usersData.map(user => {
                const createdAt = user.createdAt && user.createdAt.toDate ? formatDate(user.createdAt.toDate()) : '-';
                return `
                    <tr>
                        <td>${user.name || '-'}</td>
                        <td>${user.email || '-'}</td>
                        <td><span class="badge ${getRoleBadge(user.role)}">${getRoleName(user.role)}</span></td>
                        <td><span class="badge ${getStatusBadge(user.status || 'active')}">${getStatusName(user.status || 'active')}</span></td>
                        <td>${createdAt}</td>
                        <td class="action-buttons">
                            <button class="btn btn-primary" onclick="editUser('${user.id}')">ÿ™ÿπÿØŸäŸÑ</button>
                            <button class="btn btn-danger" onclick="deleteUserFromSystem('${user.id}')">ÿ≠ÿ∞ŸÅ</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function filterUsers() {
            const search = document.getElementById('userSearch').value.toLowerCase();
            const roleFilter = document.getElementById('userRoleFilter').value;
            const statusFilter = document.getElementById('userStatusFilter').value;

            const filtered = usersData.filter(user => {
                const matchSearch = !search || 
                    (user.name && user.name.toLowerCase().includes(search)) ||
                    (user.email && user.email.toLowerCase().includes(search));
                
                const matchRole = !roleFilter || user.role === roleFilter;
                const matchStatus = !statusFilter || (user.status || 'active') === statusFilter;
                
                return matchSearch && matchRole && matchStatus;
            });

            const tbody = document.getElementById('usersTableBody');
            if (!tbody) return;
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ™ÿßÿ¶ÿ¨</td></tr>';
            } else {
                tbody.innerHTML = filtered.map(user => {
                    const createdAt = user.createdAt && user.createdAt.toDate ? formatDate(user.createdAt.toDate()) : '-';
                    return `
                        <tr>
                            <td>${user.name || '-'}</td>
                            <td>${user.email || '-'}</td>
                            <td><span class="badge ${getRoleBadge(user.role)}">${getRoleName(user.role)}</span></td>
                            <td><span class="badge ${getStatusBadge(user.status || 'active')}">${getStatusName(user.status || 'active')}</span></td>
                            <td>${createdAt}</td>
                            <td class="action-buttons">
                                <button class="btn btn-primary" onclick="editUser('${user.id}')">ÿ™ÿπÿØŸäŸÑ</button>
                                <button class="btn btn-danger" onclick="deleteUserFromSystem('${user.id}')">ÿ≠ÿ∞ŸÅ</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            const countEl = document.getElementById('usersCount');
            if (countEl) {
                countEl.textContent = `ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ: ${filtered.length}`;
            }
        }

        function clearUserFilters() {
            document.getElementById('userSearch').value = '';
            document.getElementById('userRoleFilter').value = '';
            document.getElementById('userStatusFilter').value = '';
            displayUsers();
            updateUsersCount();
        }

        function updateUsersCount() {
            const countEl = document.getElementById('usersCount');
            if (countEl) {
                countEl.textContent = `ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ: ${usersData.length}`;
            }
        }

        function getRoleName(role) {
            const roleNames = {
                'admin': 'ŸÖÿØŸäÿ± ÿßŸÑŸÜÿ∏ÿßŸÖ',
                'hr': 'ŸÖŸàÿßÿ±ÿØ ÿ®ÿ¥ÿ±Ÿäÿ©',
                'manager': 'ŸÖÿØŸäÿ±',
                'employee': 'ŸÖŸàÿ∏ŸÅ'
            };
            return roleNames[role] || role;
        }

        function getRoleBadge(role) {
            const badges = {
                'admin': 'badge-danger',
                'hr': 'badge-info',
                'manager': 'badge-info',
                'employee': 'badge-success'
            };
            return badges[role] || 'badge-info';
        }

        // ÿπÿ±ÿ∂ ŸÜÿßŸÅÿ∞ÿ© ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ÿÆÿØŸÖ
        function showAddUserForm() {
            editingUserId = null;
            const modal = document.getElementById('userModal');
            if (!modal) return;

            // ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ™ÿ±ÿ¨ŸÖÿßÿ™ ŸÇÿ®ŸÑ ŸÅÿ™ÿ≠ ÿßŸÑŸÜÿßŸÅÿ∞ÿ©
            applyTranslations();
            document.getElementById('userSubmitBtn').setAttribute('onclick', 'addUser()');
            const passwordGroup = document.getElementById('userPasswordGroup');
            const passwordConfirmGroup = document.getElementById('userPasswordConfirmGroup');
            if (passwordGroup) passwordGroup.style.display = 'block';
            if (passwordConfirmGroup) passwordConfirmGroup.style.display = 'block';

            // ŸÖÿ≥ÿ≠ ÿßŸÑÿ≠ŸÇŸàŸÑ
            document.getElementById('userName').value = '';
            document.getElementById('userEmail').value = '';
            document.getElementById('userPassword').value = '';
            document.getElementById('userPasswordConfirm').value = '';
            document.getElementById('userRole').value = 'employee';
            document.getElementById('userStatus').value = 'active';

            modal.classList.add('active');
        }

        // ÿ•ÿÆŸÅÿßÿ° ŸÜÿßŸÅÿ∞ÿ© ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ÿÆÿØŸÖ
        function hideAddUserForm() {
            const modal = document.getElementById('userModal');
            if (modal) {
                modal.classList.remove('active');
            }
            editingUserId = null;
        }

        // ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ÿÆÿØŸÖ
        async function addUser() {
            if (editingUserId) {
                updateUser();
                return;
            }

            if (!window.db || !window.firestore || !window.auth || !window.createUserWithEmailAndPassword) {
                alert('Firebase ÿ∫Ÿäÿ± ŸÖŸáŸäÿ£');
                return;
            }

            const name = document.getElementById('userName').value.trim();
            const email = document.getElementById('userEmail').value.trim();
            const password = document.getElementById('userPassword').value;
            const passwordConfirm = document.getElementById('userPasswordConfirm').value;
            const role = document.getElementById('userRole').value;
            const status = document.getElementById('userStatus').value || 'active';

            if (!name || !email || !password) {
                alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©');
                return;
            }

            if (password.length < 6) {
                alert('ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ŸÉŸàŸÜ 6 ÿ£ÿ≠ÿ±ŸÅ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ');
                return;
            }

            if (password !== passwordConfirm) {
                alert('ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± Ÿàÿ™ÿ£ŸÉŸäÿØ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ŸÖÿ™ÿ∑ÿßÿ®ŸÇŸäŸÜ');
                return;
            }

            try {
                // ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÅŸä Firebase Authentication
                const userCredential = await window.createUserWithEmailAndPassword(window.auth, email, password);
                const userId = userCredential.user.uid;

                // ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÅŸä Firestore
                const userData = {
                    name: name,
                    email: email,
                    role: role,
                    status: status,
                    active: status === 'active',
                    createdAt: window.firestore.serverTimestamp(),
                    createdBy: currentUser?.uid || 'system'
                };

                await window.firestore.setDoc(
                    window.firestore.doc(window.db, 'users', userId),
                    userData
                );

                alert('ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ®ŸÜÿ¨ÿßÿ≠!');
                hideAddUserForm();
                await loadUsers();
            } catch (error) {
                alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: ' + getErrorMessage(error));
                console.error(error);
            }
        }

        // ÿ™ÿπÿØŸäŸÑ ŸÖÿ≥ÿ™ÿÆÿØŸÖ
        async function editUser(id) {
            editingUserId = id;
            const user = usersData.find(u => u.id === id);
            if (!user) {
                alert('ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ');
                return;
            }

            const modal = document.getElementById('userModal');
            if (!modal) return;

            // ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ™ÿ±ÿ¨ŸÖÿßÿ™ ŸÇÿ®ŸÑ ŸÅÿ™ÿ≠ ÿßŸÑŸÜÿßŸÅÿ∞ÿ©
            applyTranslations();
            document.getElementById('userSubmitBtn').setAttribute('onclick', 'updateUser()');
            const passwordGroup = document.getElementById('userPasswordGroup');
            const passwordConfirmGroup = document.getElementById('userPasswordConfirmGroup');
            if (passwordGroup) passwordGroup.style.display = 'none';
            if (passwordConfirmGroup) passwordConfirmGroup.style.display = 'none';

            document.getElementById('userName').value = user.name || '';
            document.getElementById('userEmail').value = user.email || '';
            document.getElementById('userRole').value = user.role || 'employee';
            document.getElementById('userStatus').value = user.status || 'active';

            modal.classList.add('active');
        }

        // ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿ≥ÿ™ÿÆÿØŸÖ
        async function updateUser() {
            if (!editingUserId) return;

            if (!window.db || !window.firestore) {
                alert('Firebase ÿ∫Ÿäÿ± ŸÖŸáŸäÿ£');
                return;
            }

            const userData = {
                name: document.getElementById('userName').value.trim(),
                email: document.getElementById('userEmail').value.trim(),
                role: document.getElementById('userRole').value,
                status: document.getElementById('userStatus').value || 'active',
                active: document.getElementById('userStatus').value === 'active',
                updatedAt: window.firestore.serverTimestamp(),
                updatedBy: currentUser?.uid || 'system'
            };

            if (!userData.name || !userData.email) {
                alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿßÿ≥ŸÖ ŸàÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä');
                return;
            }

            try {
                await window.firestore.updateDoc(
                    window.firestore.doc(window.db, 'users', editingUserId),
                    userData
                );

                alert('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ®ŸÜÿ¨ÿßÿ≠!');
                hideAddUserForm();
                await loadUsers();
            } catch (error) {
                alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: ' + error.message);
                console.error(error);
            }
        }

        // ÿ≠ÿ∞ŸÅ ŸÖÿ≥ÿ™ÿÆÿØŸÖ
        async function deleteUserFromSystem(userId) {
            if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖÿü')) return;

            if (!window.db || !window.firestore) {
                alert('Firebase ÿ∫Ÿäÿ± ŸÖŸáŸäÿ£');
                return;
            }

            try {
                // ÿ≠ÿ∞ŸÅ ŸÖŸÜ Firestore
                await window.firestore.deleteDoc(
                    window.firestore.doc(window.db, 'users', userId)
                );

                alert('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ®ŸÜÿ¨ÿßÿ≠!');
                await loadUsers();
            } catch (error) {
                alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: ' + error.message);
                console.error(error);
            }
        }

        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ£ŸàŸÑ Ÿàÿ•ŸÜÿ¥ÿßÿ¶Ÿá ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã
        async function checkAndCreateFirstUser() {
            try {
                if (!window.db || !window.firestore || !window.auth || !window.createUserWithEmailAndPassword) {
                    console.warn('Firebase ÿ∫Ÿäÿ± ŸÖŸáŸäÿ£ - ÿ≥Ÿäÿ™ŸÖ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÑÿßÿ≠ŸÇÿßŸã');
                    return;
                }

                const firstUserEmail = FIRST_USER_EMAIL;
                const firstUserPassword = FIRST_USER_PASSWORD;
                
                // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ£ŸàŸÑ ÿ®ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä
                // ÿ£ŸàŸÑÿßŸã: ŸÖÿ≠ÿßŸàŸÑÿ© ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Firestore
                let firstUserExistsInFirestore = false;
                try {
                    const usersRef = window.firestore.collection(window.db, 'users');
                    const snapshot = await window.firestore.getDocs(usersRef);
                    
                    // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ®ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä
                    snapshot.forEach(doc => {
                        const userData = doc.data();
                        if (userData.email === firstUserEmail) {
                            firstUserExistsInFirestore = true;
                            console.log('‚úÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ£ŸàŸÑ ŸÖŸàÿ¨ŸàÿØ ŸÅŸä Firestore:', firstUserEmail);
                    }
                    });
                } catch (readError) {
                    // ÿ•ÿ∞ÿß ŸÅÿ¥ŸÑÿ™ ÿßŸÑŸÇÿ±ÿßÿ°ÿ© ÿ®ÿ≥ÿ®ÿ® ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™ÿå ÿ≥ŸÜÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Authentication ŸÖÿ®ÿßÿ¥ÿ±ÿ©
                    console.log('‚ö†Ô∏è ŸÑÿß ŸäŸÖŸÉŸÜ ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ŸÖŸÜ Firestore ÿ®ÿ≥ÿ®ÿ® ŸÇŸàÿßÿπÿØ ÿßŸÑÿ£ŸÖÿßŸÜ');
                }
                
                // ÿ´ÿßŸÜŸäÿßŸã: ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÅŸä Authentication ÿØŸàŸÜ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ ÿ™ŸÑŸÇÿßÿ¶Ÿä
                // (ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä Ÿäÿ≥ŸÖÿ≠ ŸÑÿ£Ÿä ÿ≤ÿßÿ¶ÿ± ÿ®ÿßŸÑÿØÿÆŸàŸÑ ŸÉŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ£ŸàŸÑ - ŸÜŸÖŸÜÿπ ÿ∞ŸÑŸÉ)
                let firstUserExistsInAuth = false;
                const currentAuthUser = window.auth?.currentUser;
                
                if (currentAuthUser && currentAuthUser.email === firstUserEmail) {
                    // ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖÿ≥ÿ¨ŸÑ ÿØÿÆŸàŸÑ ÿ®ÿßŸÑŸÅÿπŸÑ ŸÉŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ£ŸàŸÑ
                    firstUserExistsInAuth = true;
                    console.log('‚úÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ£ŸàŸÑ ŸÖÿ≥ÿ¨ŸÑ ÿØÿÆŸàŸÑ ÿ®ÿßŸÑŸÅÿπŸÑ:', firstUserEmail);
                }
                
                // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖŸàÿ¨ŸàÿØÿßŸã ŸÅŸä Authentication ŸàŸÖÿ≥ÿ¨ŸëŸÑ ÿØÿÆŸàŸÑŸáÿå ŸÑÿß ŸÜÿ∫ŸäŸëÿ± ÿ¥Ÿäÿ°
                if (firstUserExistsInAuth) {
                    if (!firstUserExistsInFirestore) {
                        console.log('‚ö†Ô∏è ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖŸàÿ¨ŸàÿØ ŸÅŸä Authentication ŸÑŸÉŸÜ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ ŸÅŸä Firestore - ÿ≥Ÿäÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ≥ÿ¨ŸÑ ÿπŸÜÿØ ensureUserRecordExists');
                    }
                    return;
                }
                
                // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑŸàÿ¨ŸàÿØ ÿ®ŸÖÿ≠ÿßŸàŸÑÿ© ÿßŸÑÿ•ŸÜÿ¥ÿßÿ° (ÿ®ÿØŸàŸÜ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ ÿ™ŸÑŸÇÿßÿ¶Ÿä ŸÑŸÑÿ≤ÿßÿ¶ÿ±)
                console.log('ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ£ŸàŸÑ (ÿ®ÿØŸàŸÜ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ ÿ™ŸÑŸÇÿßÿ¶Ÿä)...');
                try {
                    const userCredential = await window.createUserWithEmailAndPassword(
                        window.auth,
                        firstUserEmail,
                        firstUserPassword
                    );
                    const userId = userCredential.user.uid;
                    // ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÑŸÖ ŸäŸÉŸÜ ŸÖŸàÿ¨ŸàÿØÿßŸã Ÿàÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ§Ÿá - ŸÜŸÜÿ¥ÿ¶ ÿßŸÑÿ≥ÿ¨ŸÑ ŸÅŸä Firestore ÿ´ŸÖ ŸÜÿÆÿ±ÿ¨Ÿá ŸÑŸäÿ∏Ÿáÿ± ŸÜŸÖŸàÿ∞ÿ¨ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
                    await new Promise(resolve => setTimeout(resolve, 500));
                    const userData = {
                        name: 'ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ£ŸàŸÑ',
                        email: firstUserEmail,
                        role: 'admin',
                        status: 'active',
                        active: true,
                        isFirstAdmin: true,
                        createdAt: window.firestore.serverTimestamp(),
                        createdBy: 'system'
                    };
                    await window.firestore.setDoc(
                        window.firestore.doc(window.db, 'users', userId),
                        userData
                    );
                    console.log('‚úÖ ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ£ŸàŸÑ ÿ®ŸÜÿ¨ÿßÿ≠!');
                    alert('‚úÖ ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ£ŸàŸÑ ÿ®ŸÜÿ¨ÿßÿ≠!\n\nÿßŸÑÿ®ÿ±ŸäÿØ: ' + firstUserEmail + '\nŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±: ' + firstUserPassword + '\n\nÿ≥Ÿäÿ™ŸÖ ÿ•ÿ∏Ÿáÿßÿ± ŸÜÿßŸÅÿ∞ÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ.');
                    // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ ŸÅŸàÿ±ÿßŸã ÿ≠ÿ™Ÿâ Ÿäÿ∏Ÿáÿ± ŸÜŸÖŸàÿ∞ÿ¨ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸàŸÑÿß ŸäÿØÿÆŸÑ ÿßŸÑÿ≤ÿßÿ¶ÿ± ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã
                    if (window.signOut && window.auth) {
                        await window.signOut(window.auth);
                        currentUser = null;
                    }
                    return;
                } catch (error) {
                    if (error.code === 'auth/email-already-in-use') {
                        // ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ£ŸàŸÑ ŸÖŸàÿ¨ŸàÿØ ŸÖÿ≥ÿ®ŸÇÿßŸã - ŸÑÿß ŸÜŸèÿ≥ÿ¨ŸëŸÑ ÿØÿÆŸàŸÑÿßŸã ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸãÿå ŸÜÿ™ÿ±ŸÉ ÿßŸÑÿ≤ÿßÿ¶ÿ± Ÿäÿ±Ÿâ ŸÜŸÖŸàÿ∞ÿ¨ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
                        console.log('‚úÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ£ŸàŸÑ ŸÖŸàÿ¨ŸàÿØ ŸÖÿ≥ÿ®ŸÇÿßŸã ŸÅŸä Authentication - ŸÜÿßŸÅÿ∞ÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ≥ÿ™ÿ∏Ÿáÿ± ŸÑŸÑÿ≤ÿßÿ¶ÿ±');
                        return;
                    }
                    if (error.code === 'auth/invalid-email' || error.code === 'auth/weak-password') {
                        console.warn('‚ö†Ô∏è ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ£ŸàŸÑ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠ÿ©:', error.code);
                        return;
                    }
                    console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ≠ŸÇŸÇ/ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ£ŸàŸÑ:', error);
                }
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ£ŸàŸÑ:', error);
                // ŸÑÿß ŸÜŸàŸÇŸÅ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ÿ•ÿ∞ÿß ŸÅÿ¥ŸÑ ÿßŸÑÿ™ÿ≠ŸÇŸÇ
            }
        }

        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÅŸä Firestore Ÿàÿ•ŸÜÿ¥ÿßÿ° ÿ≥ÿ¨ŸÑŸá ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸÖŸàÿ¨ŸàÿØÿßŸã
        async function ensureUserRecordExists(user) {
            try {
                if (!user || !window.db || !window.firestore) {
                    return false;
                }

                const userDoc = await window.firestore.getDoc(
                    window.firestore.doc(window.db, 'users', user.uid)
                );

                if (!userDoc.exists()) {
                    // ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ ŸÅŸä Firestoreÿå ÿ•ŸÜÿ¥ÿßÿ° ÿ≥ÿ¨ŸÑŸá
                    console.log('‚ö†Ô∏è ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ ŸÅŸä Firestore - ÿ¨ÿßÿ±Ÿä ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ≥ÿ¨ŸÑ...');
                    
                    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿπÿØÿØ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ŸÑÿ™ÿ≠ÿØŸäÿØ ÿ•ÿ∞ÿß ŸÉÿßŸÜ Ÿáÿ∞ÿß ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ£ŸàŸÑ
                    let isFirstUser = false;
                    try {
                        const usersRef = window.firestore.collection(window.db, 'users');
                        const snapshot = await window.firestore.getDocs(usersRef);
                        isFirstUser = snapshot.empty;
                    } catch (error) {
                        // ÿ•ÿ∞ÿß ŸÅÿ¥ŸÑÿ™ ÿßŸÑŸÇÿ±ÿßÿ°ÿ©ÿå ŸÜŸÅÿ™ÿ±ÿ∂ ÿ£ŸÜŸá ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ£ŸàŸÑ
                        isFirstUser = true;
                    }

                    const userData = {
                        name: user.displayName || user.email?.split('@')[0] || 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ',
                        email: user.email,
                        role: isFirstUser ? 'admin' : 'employee', // ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ£ŸàŸÑ ŸäŸÉŸàŸÜ admin
                        status: 'active',
                        active: true,
                        isFirstAdmin: isFirstUser,
                        createdAt: window.firestore.serverTimestamp(),
                        createdBy: 'system'
                    };

                    await window.firestore.setDoc(
                        window.firestore.doc(window.db, 'users', user.uid),
                        userData
                    );

                    console.log('‚úÖ ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿ≥ÿ¨ŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÅŸä Firestore:', user.email, 'ŸÖÿπ role:', userData.role);
                    return true;
                } else {
                    // ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖŸàÿ¨ŸàÿØÿå ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ£ŸÜ ŸÑÿØŸäŸá role ŸÖŸÜÿßÿ≥ÿ®
                    const userData = userDoc.data();
                    const currentRole = userData.role;
                    
                    // ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸÑÿØŸäŸá role ÿ£Ÿà role ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿå ŸÜÿµŸÑÿ≠Ÿá
                    if (!currentRole || (currentRole !== 'admin' && currentRole !== 'hr' && currentRole !== 'employee')) {
                        console.log('‚ö†Ô∏è ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖŸàÿ¨ŸàÿØ ŸÑŸÉŸÜ ŸÑŸäÿ≥ ŸÑÿØŸäŸá role ŸÖŸÜÿßÿ≥ÿ® - ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ÿØŸäÿ´...');
                        
                        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿπÿØÿØ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ŸÑÿ™ÿ≠ÿØŸäÿØ ÿ•ÿ∞ÿß ŸÉÿßŸÜ Ÿáÿ∞ÿß ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ£ŸàŸÑ
                        let isFirstUser = false;
                        try {
                            const usersRef = window.firestore.collection(window.db, 'users');
                            const snapshot = await window.firestore.getDocs(usersRef);
                            // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸáŸÜÿßŸÉ ŸÖÿ≥ÿ™ÿÆÿØŸÖ Ÿàÿßÿ≠ÿØ ŸÅŸÇÿ∑ÿå ŸÅŸáŸà ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ£ŸàŸÑ
                            isFirstUser = snapshot.size === 1;
                        } catch (error) {
                            // ÿ•ÿ∞ÿß ŸÅÿ¥ŸÑÿ™ ÿßŸÑŸÇÿ±ÿßÿ°ÿ©ÿå ŸÜŸÅÿ™ÿ±ÿ∂ ÿ£ŸÜŸá ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ£ŸàŸÑ
                            isFirstUser = true;
                        }
                        
                        const updateData = {
                            role: isFirstUser ? 'admin' : (currentRole || 'admin'),
                            active: userData.active !== false
                        };
                        
                        // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ£ŸàŸÑÿå ÿ£ÿ∂ŸÅ isFirstAdmin
                        if (isFirstUser) {
                            updateData.isFirstAdmin = true;
                        }
                        
                        try {
                            await window.firestore.updateDoc(
                                window.firestore.doc(window.db, 'users', user.uid),
                                updateData
                            );
                            console.log('‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ role ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ•ŸÑŸâ:', updateData.role);
                        } catch (updateError) {
                            console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ role ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ:', updateError);
                            // ŸÜÿ™ÿßÿ®ÿπ ÿπŸÑŸâ ÿ£Ÿä ÿ≠ÿßŸÑ
                        }
                    } else {
                        console.log('‚úÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÑÿØŸäŸá role ÿµÿ≠Ÿäÿ≠:', currentRole);
                    }
                    return true;
                }
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ≥ÿ¨ŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ:', error);
                return false;
            }
        }

        function getErrorMessage(error) {
            const messages = {
                'auth/email-already-in-use': 'ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ®ÿßŸÑŸÅÿπŸÑ',
                'auth/invalid-email': 'ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠',
                'auth/weak-password': 'ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∂ÿπŸäŸÅÿ© ÿ¨ÿØÿßŸã',
                'auth/user-not-found': 'ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ',
                'auth/wrong-password': 'ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿÆÿßÿ∑ÿ¶ÿ©'
            };
            return messages[error.code] || error.message;
        }

        // ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ÿπŸÜÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©
        window.addEventListener('DOMContentLoaded', async () => {
            // #region agent log
            console.log('üîç [DEBUG-B] DOMContentLoaded - ÿ®ÿØÿ° ÿßŸÑÿ™ŸáŸäÿ¶ÿ©, isManualLogout:', isManualLogout);
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßÿ≥ÿ™ÿØÿπÿßÿ° logging ÿßŸÑÿÆÿßÿ±ÿ¨Ÿä
            // #endregion
            console.log('ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©');
            
            // ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑŸÑÿ∫ÿ©
            initLanguage();
            
            // ÿ•ÿ∏Ÿáÿßÿ± Ÿàÿßÿ¨Ÿáÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã
            showLogin();
            
            // ÿßŸÜÿ™ÿ∏ÿßÿ± ÿ™ŸáŸäÿ¶ÿ© Firebase
            let attempts = 0;
            const maxAttempts = 50;
            while (attempts < maxAttempts) {
                if (window.db && window.firestore && window.auth) {
                    console.log('‚úÖ Firebase ÿ¨ÿßŸáÿ≤ ŸÑŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ');
                    break;
                }
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            if (!window.db || !window.firestore || !window.auth) {
                console.warn('‚ö†Ô∏è Firebase ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ŸáŸäÿ¶ÿ™Ÿá ÿ®ÿπÿØ. ŸÇÿØ ÿ™ÿ≠ÿ™ÿßÿ¨ ÿ•ŸÑŸâ ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©.');
                return;
            }
            
            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ≠ÿßŸÑÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
            if (window.onAuthStateChanged) {
                window.onAuthStateChanged(window.auth, async (user) => {
                    // #region agent log
                    console.log('üîç [DEBUG-C] onAuthStateChanged - ÿßÿ≥ÿ™ÿØÿπÿßÿ°, hasUser:', !!user, 'userEmail:', user?.email, 'isManualLogout:', isManualLogout);
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßÿ≥ÿ™ÿØÿπÿßÿ° logging ÿßŸÑÿÆÿßÿ±ÿ¨Ÿä
                    // #endregion
                    if (user) {
                        // ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖÿ≥ÿ¨ŸÑ ÿØÿÆŸàŸÑ
                        currentUser = user;
                        // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿπŸÑÿßŸÖÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ ÿßŸÑŸäÿØŸàŸä ÿπŸÜÿØ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
                        isManualLogout = false;
                        // #region agent log
                        try {
                            sessionStorage.removeItem('hrm_manual_logout');
                            console.log('üîç [DEBUG-C] ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖÿ≥ÿ¨ŸÑ ÿØÿÆŸàŸÑ - ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ isManualLogout = false');
                            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßÿ≥ÿ™ÿØÿπÿßÿ° logging ÿßŸÑÿÆÿßÿ±ÿ¨Ÿä
                        } catch (e) {
                            console.log('üîç [DEBUG-C] ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ≤ÿßŸÑÿ© sessionStorage:', e);
                        }
                        // #endregion
                        console.log('‚úÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖÿ≥ÿ¨ŸÑ ÿØÿÆŸàŸÑ:', user.email);
                        
                        // ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿ≥ÿ¨ŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÅŸä Firestore
                        await ensureUserRecordExists(user);
                        
                        // ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ
                        showApp();
                        
                        // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ÿπÿØ ÿßŸÑÿ™ÿ≠ŸÇŸÇ Ÿàÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
                        try {
                        // ÿ™ÿ≠ŸÖŸäŸÑ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ¥ÿ±ŸÉÿ©
                        await loadCompanyInfo();
                        updateCompanyLogoInApp();
                            
                            // ÿ™ÿ≠ŸÖŸäŸÑ ÿ•ÿπÿØÿßÿØÿßÿ™ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                            loadDatabaseSettings();
                            
                            // ÿ™ÿ≠ŸÖŸäŸÑ ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ
                            await loadDashboardStats();
                        } catch (loadError) {
                            console.error('‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:', loadError);
                        }
                    } else {
                        // ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ∫Ÿäÿ± ŸÖÿ≥ÿ¨ŸÑ ÿØÿÆŸàŸÑ
                        currentUser = null;
                        // #region agent log
                        console.log('üîç [DEBUG-D] ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ∫Ÿäÿ± ŸÖÿ≥ÿ¨ŸÑ ÿØÿÆŸàŸÑ, isManualLogout:', isManualLogout);
                        // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßÿ≥ÿ™ÿØÿπÿßÿ° logging ÿßŸÑÿÆÿßÿ±ÿ¨Ÿä
                        // #endregion
                        console.log('‚ÑπÔ∏è ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ∫Ÿäÿ± ŸÖÿ≥ÿ¨ŸÑ ÿØÿÆŸàŸÑ');
                        
                        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ£ŸàŸÑ Ÿàÿ•ŸÜÿ¥ÿßÿ§Ÿá ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸÖŸàÿ¨ŸàÿØÿßŸã
                        // ŸÅŸÇÿ∑ ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿÆÿ±Ÿàÿ¨ ŸäÿØŸàŸä
                        if (!isManualLogout) {
                            // #region agent log
                            console.log('üîç [DEBUG-D] ÿßÿ≥ÿ™ÿØÿπÿßÿ° checkAndCreateFirstUser - isManualLogout = false');
                            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßÿ≥ÿ™ÿØÿπÿßÿ° logging ÿßŸÑÿÆÿßÿ±ÿ¨Ÿä
                            // #endregion
                        await checkAndCreateFirstUser();
                        } else {
                            // #region agent log
                            console.log('üîç [DEBUG-D] ÿ™ÿÆÿ∑Ÿä checkAndCreateFirstUser - isManualLogout = true');
                            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßÿ≥ÿ™ÿØÿπÿßÿ° logging ÿßŸÑÿÆÿßÿ±ÿ¨Ÿä
                            // #endregion
                            // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿπŸÑÿßŸÖÿ© ÿ®ÿπÿØ ŸÖÿπÿßŸÑÿ¨ÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨
                            isManualLogout = false;
                            try {
                                sessionStorage.removeItem('hrm_manual_logout');
                                console.log('üîç [DEBUG-D] ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© hrm_manual_logout ŸÖŸÜ sessionStorage');
                            } catch (e) {
                                console.log('üîç [DEBUG-D] ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ≤ÿßŸÑÿ© sessionStorage:', e);
                            }
                        }
                        
                        // ÿ•ÿ∏Ÿáÿßÿ± Ÿàÿßÿ¨Ÿáÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
                        showLogin();
                    }
                });
            } else {
                // ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ onAuthStateChanged ŸÖÿ™ÿßÿ≠ÿßŸãÿå ŸÜÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ£ŸàŸÑ ŸÅŸÇÿ∑
                await checkAndCreateFirstUser();
            }
            
            // ŸÖŸÑÿßÿ≠ÿ∏ÿ©: ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ Ÿäÿ™ŸÖ ÿ®ÿπÿØ ÿßŸÑÿ™ÿ≠ŸÇŸÇ Ÿàÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÅŸä onAuthStateChanged
        });

        // ============================================
        // ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™
        // ============================================
        async function loadLeaves() {
            // #region agent log
            const sessionId = 'debug-session-' + Date.now();
            const runId = 'run1';
            const leavesDataCountBefore = leavesData.length;
            const leavesIdsBefore = leavesData.map(l => l.id);
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßÿ≥ÿ™ÿØÿπÿßÿ° logging ÿßŸÑÿÆÿßÿ±ÿ¨Ÿä
            console.log('üîç [DEBUG-LEAVE-LOAD] ÿ®ÿØÿ° loadLeaves(), leavesData ŸÇÿ®ŸÑ:', leavesDataCountBefore, leavesIdsBefore);
            // #endregion
            
            try {
                if (!window.db || !window.firestore) {
                    console.warn('Firebase ÿ∫Ÿäÿ± ŸÖŸáŸäÿ£');
                    const tbody = document.getElementById('leavesTableBody');
                    if (tbody) {
                        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #dc3545;">Firebase ÿ∫Ÿäÿ± ŸÖŸáŸäÿ£</td></tr>';
                    }
                    return;
                }

                const leavesRef = window.firestore.collection(window.db, 'leaves');
                const snapshot = await window.firestore.getDocs(leavesRef);
                
                // #region agent log
                const snapshotSize = snapshot.size;
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßÿ≥ÿ™ÿØÿπÿßÿ° logging ÿßŸÑÿÆÿßÿ±ÿ¨Ÿä
                console.log('üîç [DEBUG-LEAVE-LOAD] ÿπÿØÿØ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ŸÖŸÜ Firebase:', snapshotSize);
                // #endregion
                
                leavesData = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    leavesData.push({ id: doc.id, ...data });
                });

                // #region agent log
                const leavesDataCountAfter = leavesData.length;
                const leavesIdsAfter = leavesData.map(l => l.id);
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßÿ≥ÿ™ÿØÿπÿßÿ° logging ÿßŸÑÿÆÿßÿ±ÿ¨Ÿä
                console.log('üîç [DEBUG-LEAVE-LOAD] leavesData ÿ®ÿπÿØ:', leavesDataCountAfter, leavesIdsAfter);
                // #endregion

                displayLeaves();
                updateLeavesCount();
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™:', error);
                const tbody = document.getElementById('leavesTableBody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #dc3545;">ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</td></tr>';
                }
            }
        }

        function displayLeaves() {
            const tbody = document.getElementById('leavesTableBody');
            if (!tbody) return;
            
            if (leavesData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™</td></tr>';
                return;
            }

            // ŸÅŸÑÿ™ÿ±ÿ© ÿ≠ÿ≥ÿ® ÿßŸÑÿ¥Ÿáÿ± (ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ "ÿπÿ±ÿ∂ ŸÉŸÑ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™" ŸÖŸÅÿπŸëŸÑÿßŸã)
            let leavesToShow = leavesViewAllMonths ? leavesData : leavesData.filter(l => leaveOverlapsMonth(l, leavesViewYear, leavesViewMonth));

            // ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ŸÖŸÜ ÿßŸÑÿ£ÿ≠ÿØÿ´ ÿ•ŸÑŸâ ÿßŸÑÿ£ŸÇÿØŸÖ ÿ≠ÿ≥ÿ® ÿßŸÑÿ™ÿßÿ±ŸäÿÆ
            const sortedLeaves = [...leavesToShow].sort((a, b) => {
                // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ®ÿØÿßŸäÿ© ŸÑŸÑÿ™ÿ±ÿ™Ÿäÿ®
                const dateA = a.startDate ? new Date(a.startDate) : new Date(0);
                const dateB = b.startDate ? new Date(b.startDate) : new Date(0);
                // ÿ™ÿ±ÿ™Ÿäÿ® ÿ™ŸÜÿßÿ≤ŸÑŸä (ÿßŸÑÿ£ÿ≠ÿØÿ´ ÿ£ŸàŸÑÿßŸã)
                return dateB - dateA;
            });

            tbody.innerHTML = sortedLeaves.map(leave => {
                const employee = employeesData.find(e => e.id === leave.employeeId);
                const employeeName = employee ? employee.name : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
                const startDate = leave.startDate ? formatDate(leave.startDate) : '-';
                
                // ÿπÿ±ÿ∂ ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ° ÿßŸÑŸÅÿπŸÑŸä (ÿ•ŸÜ Ÿàÿ¨ÿØ)
                let endDate = '-';
                if (leave.endDate) {
                    endDate = formatDate(leave.endDate);
                }
                
                // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿØÿ© ÿ®ÿßŸÑÿ£ŸäÿßŸÖ
                let duration = '-';
                if (leave.type === 'hourly' && leave.hours) {
                    // ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ŸáŸÜÿßŸÉ ŸÅÿ™ÿ±ÿßÿ™ ÿ≤ŸÖŸÜŸäÿ© ŸÖÿ™ÿπÿØÿØÿ©ÿå ÿπÿ±ÿ∂Ÿáÿß
                    if (leave.timeRanges && Array.isArray(leave.timeRanges) && leave.timeRanges.length > 0) {
                        const timeRangesText = leave.timeRanges.map(tr => `${tr.startTime} - ${tr.endTime}`).join('ÿå ');
                        duration = `${leave.hours} ÿ≥ÿßÿπÿ© (${timeRangesText})`;
                    } else {
                        duration = leave.hours + ' ÿ≥ÿßÿπÿ©';
                    }
                } else if (leave.startDate && leave.endDate) {
                    // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿØÿ© ÿ®ÿßŸÑÿ£ŸäÿßŸÖ ŸÑŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑÿ¥Ÿáÿ±Ÿäÿ© Ÿàÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ®
                    const start = new Date(leave.startDate);
                    const end = new Date(leave.endDate);
                    const diffTime = Math.abs(end - start);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    duration = diffDays + ' ŸäŸàŸÖ';
                } else if (leave.startDate && leave.type === 'unpaid') {
                    // ŸÑŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ® ÿ®ÿØŸàŸÜ ÿ™ÿßÿ±ŸäÿÆ ÿßŸÜÿ™Ÿáÿßÿ°ÿå ŸÜÿ≥ÿ™ÿÆÿØŸÖ ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ®ÿØÿßŸäÿ© ŸÅŸÇÿ∑
                    duration = '1 ŸäŸàŸÖ';
                }
                
                const statusBadge = getLeaveStatusBadge(leave.status || 'pending');
                const statusName = getLeaveStatusName(leave.status || 'pending');
                const currentStatus = leave.status || 'pending';
                
                // ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑŸÖŸàÿßŸÅŸÇÿ©/ÿßŸÑÿ±ŸÅÿ∂ (ÿ™ÿ∏Ÿáÿ± ŸÅŸÇÿ∑ ŸÑŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ŸÇŸäÿØ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±)
                let actionButtons = '';
                if (currentStatus === 'pending') {
                    actionButtons = `
                        <button class="btn btn-success" onclick="approveLeave('${leave.id}')" style="padding: 6px 12px; font-size: 13px; margin-left: 5px;">‚úÖ ŸÖŸàÿßŸÅŸÇÿ©</button>
                        <button class="btn btn-danger" onclick="rejectLeave('${leave.id}')" style="padding: 6px 12px; font-size: 13px; margin-left: 5px;">‚ùå ÿ±ŸÅÿ∂</button>
                        <button class="btn btn-primary" onclick="editLeave('${leave.id}')" style="padding: 6px 12px; font-size: 13px; margin-left: 5px;">‚úèÔ∏è ÿ™ÿπÿØŸäŸÑ</button>
                        <button class="btn btn-danger" onclick="deleteLeave('${leave.id}')" style="padding: 6px 12px; font-size: 13px;">üóëÔ∏è ÿ≠ÿ∞ŸÅ</button>
                    `;
                } else {
                    actionButtons = `
                        <button class="btn btn-primary" onclick="editLeave('${leave.id}')" style="padding: 6px 12px; font-size: 13px; margin-left: 5px;">‚úèÔ∏è ÿ™ÿπÿØŸäŸÑ</button>
                        <button class="btn btn-danger" onclick="deleteLeave('${leave.id}')" style="padding: 6px 12px; font-size: 13px;">üóëÔ∏è ÿ≠ÿ∞ŸÅ</button>
                    `;
                }
                
                // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿÆÿµŸÖ ŸÑŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ®
                let deductionDisplay = '-';
                if (leave.type === 'unpaid' && employee) {
                    const deduction = calculateUnpaidLeaveDeduction(leave, employee);
                    if (window.deductionViewUnlocked) {
                        // ÿπÿ±ÿ∂ ÿßŸÑÿÆÿµŸÖ ŸÖÿπ ÿßŸÑÿπŸÖŸÑÿ© (ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿπŸÖŸÑÿ© ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ© ÿ•ŸÜ Ÿàÿ¨ÿØÿ™)
                        const currency = leave.salaryCurrencyAtLeave || employee.currentSalaryCurrency || 'IQD';
                        const currencySymbol = currency === 'USD' ? '$' : 'ÿØ.ÿπ';
                        deductionDisplay = deduction !== null ? formatNumber(deduction) + ' ' + currencySymbol : '-';
                    } else {
                        deductionDisplay = deduction !== null ? '****' : '-';
                    }
                }
                
                return `
                    <tr>
                        <td>${employeeName}</td>
                        <td>${getLeaveTypeName(leave.type, leave)}</td>
                        <td>${startDate}</td>
                        <td>${endDate}</td>
                        <td>${duration}</td>
                        <td><span class="badge ${statusBadge}">${statusName}</span></td>
                        <td style="font-weight: ${leave.type === 'unpaid' ? 'bold' : 'normal'}; color: ${leave.type === 'unpaid' ? '#dc3545' : 'inherit'};">
                            ${deductionDisplay}
                        </td>
                        <td>${leave.notes || '-'}</td>
                        <td class="action-buttons" style="white-space: nowrap;">
                            ${actionButtons}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ™ÿØÿßÿÆŸÑ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ŸÖÿπ ÿ¥Ÿáÿ± ŸÖÿ≠ÿØÿØ
        function leaveOverlapsMonth(leave, year, month) {
            const monthStart = new Date(year, month, 1);
            const monthEnd = new Date(year, month + 1, 0, 23, 59, 59);
            const start = leave.startDate ? new Date(leave.startDate) : null;
            const end = (leave.endDate ? new Date(leave.endDate) : start) || start;
            if (!start || isNaN(start.getTime())) return false;
            return start <= monthEnd && (end || start) >= monthStart;
        }

        // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿπÿ±ÿ∂ ÿßÿ≥ŸÖ ÿßŸÑÿ¥Ÿáÿ± ÿ®ÿßŸÑÿπÿ±ÿ®Ÿäÿ©
        function getLeavesMonthLabel(year, month) {
            const months = ['ŸäŸÜÿßŸäÿ±', 'ŸÅÿ®ÿ±ÿßŸäÿ±', 'ŸÖÿßÿ±ÿ≥', 'ÿ£ÿ®ÿ±ŸäŸÑ', 'ŸÖÿßŸäŸà', 'ŸäŸàŸÜŸäŸà', 'ŸäŸàŸÑŸäŸà', 'ÿ£ÿ∫ÿ≥ÿ∑ÿ≥', 'ÿ≥ÿ®ÿ™ŸÖÿ®ÿ±', 'ÿ£ŸÉÿ™Ÿàÿ®ÿ±', 'ŸÜŸàŸÅŸÖÿ®ÿ±', 'ÿØŸäÿ≥ŸÖÿ®ÿ±'];
            return months[month] + ' ' + year;
        }

        // ÿ™ÿ≠ÿØŸäÿ´ ÿπÿ±ÿ∂ ÿßŸÑÿ¥Ÿáÿ± ŸÅŸä ÿßŸÑŸàÿßÿ¨Ÿáÿ©
        function updateLeavesMonthLabel() {
            const labelEl = document.getElementById('leavesMonthLabel');
            const allBtn = document.getElementById('leavesViewAllBtn');
            if (labelEl) labelEl.textContent = leavesViewAllMonths ? 'ŸÉŸÑ ÿßŸÑÿ£ÿ¥Ÿáÿ±' : getLeavesMonthLabel(leavesViewYear, leavesViewMonth);
            if (allBtn) allBtn.textContent = leavesViewAllMonths ? 'ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑÿ¥Ÿáÿ± ÿßŸÑÿ≠ÿßŸÑŸä' : 'ÿπÿ±ÿ∂ ŸÉŸÑ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™';
        }

        // ÿßŸÑÿ™ŸÜŸÇŸÑ ÿ®ŸäŸÜ ÿßŸÑÿ£ÿ¥Ÿáÿ± (-1 ŸÑŸÑÿ≥ÿßÿ®ŸÇÿå 1 ŸÑŸÑÿ™ÿßŸÑŸä)
        function navigateLeavesMonth(delta) {
            leavesViewAllMonths = false;
            leavesViewMonth += delta;
            if (leavesViewMonth < 0) {
                leavesViewMonth = 11;
                leavesViewYear--;
            } else if (leavesViewMonth > 11) {
                leavesViewMonth = 0;
                leavesViewYear++;
            }
            updateLeavesMonthLabel();
            filterLeaves();
        }

        // ÿπÿ±ÿ∂ ŸÉŸÑ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™
        function setLeavesViewAll() {
            leavesViewAllMonths = !leavesViewAllMonths;
            if (!leavesViewAllMonths) {
                const now = new Date();
                leavesViewYear = now.getFullYear();
                leavesViewMonth = now.getMonth();
            }
            updateLeavesMonthLabel();
            filterLeaves();
        }

        function filterLeaves() {
            const search = document.getElementById('leaveSearch').value.toLowerCase();
            const typeFilter = document.getElementById('leaveTypeFilter').value;
            const statusFilter = document.getElementById('leaveStatusFilter').value;

            let filtered = leavesData.filter(leave => {
                const employee = employeesData.find(e => e.id === leave.employeeId);
                const employeeName = employee ? employee.name.toLowerCase() : '';
                
                const matchSearch = !search || employeeName.includes(search);
                const matchType = !typeFilter || leave.type === typeFilter;
                const matchStatus = !statusFilter || (leave.status || 'pending') === statusFilter;
                const matchMonth = leavesViewAllMonths || leaveOverlapsMonth(leave, leavesViewYear, leavesViewMonth);
                
                return matchSearch && matchType && matchStatus && matchMonth;
            });

            // ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑŸÖŸÅŸÑÿ™ÿ±ÿ© ŸÖŸÜ ÿßŸÑÿ£ÿ≠ÿØÿ´ ÿ•ŸÑŸâ ÿßŸÑÿ£ŸÇÿØŸÖ ÿ≠ÿ≥ÿ® ÿßŸÑÿ™ÿßÿ±ŸäÿÆ
            const sortedFiltered = filtered.sort((a, b) => {
                const dateA = a.startDate ? new Date(a.startDate) : new Date(0);
                const dateB = b.startDate ? new Date(b.startDate) : new Date(0);
                return dateB - dateA;
            });

            const tbody = document.getElementById('leavesTableBody');
            if (!tbody) return;
            
            if (sortedFiltered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ™ÿßÿ¶ÿ¨</td></tr>';
            } else {
                tbody.innerHTML = sortedFiltered.map(leave => {
                    const employee = employeesData.find(e => e.id === leave.employeeId);
                    const employeeName = employee ? employee.name : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
                    const startDate = leave.startDate ? formatDate(leave.startDate) : '-';
                    const endDate = leave.endDate ? formatDate(leave.endDate) : (leave.type === 'unpaid' ? 'ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ®' : '-');
                    let duration = '-';
                    if (leave.type === 'hourly' && leave.hours) {
                        // ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ŸáŸÜÿßŸÉ ŸÅÿ™ÿ±ÿßÿ™ ÿ≤ŸÖŸÜŸäÿ© ŸÖÿ™ÿπÿØÿØÿ©ÿå ÿπÿ±ÿ∂Ÿáÿß
                        if (leave.timeRanges && Array.isArray(leave.timeRanges) && leave.timeRanges.length > 0) {
                            const timeRangesText = leave.timeRanges.map(tr => `${tr.startTime} - ${tr.endTime}`).join('ÿå ');
                            duration = `${leave.hours} ÿ≥ÿßÿπÿ© (${timeRangesText})`;
                        } else {
                            duration = leave.hours + ' ÿ≥ÿßÿπÿ©';
                        }
                    } else if (leave.type === 'unpaid') {
                        if (leave.startDate && leave.endDate) {
                            const start = new Date(leave.startDate);
                            const end = new Date(leave.endDate);
                            const diffTime = Math.abs(end - start);
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                            duration = diffDays + ' ŸäŸàŸÖ (ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ®)';
                        } else if (leave.startDate) {
                            duration = 'ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ®';
                        }
                    } else if (leave.startDate && leave.endDate) {
                        const start = new Date(leave.startDate);
                        const end = new Date(leave.endDate);
                        const diffTime = Math.abs(end - start);
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                        duration = diffDays + ' ŸäŸàŸÖ';
                    }
                    
                    const statusBadge = getLeaveStatusBadge(leave.status || 'pending');
                    const statusName = getLeaveStatusName(leave.status || 'pending');
                    const currentStatus = leave.status || 'pending';
                    
                    // ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑŸÖŸàÿßŸÅŸÇÿ©/ÿßŸÑÿ±ŸÅÿ∂ (ÿ™ÿ∏Ÿáÿ± ŸÅŸÇÿ∑ ŸÑŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ŸÇŸäÿØ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±)
                    let actionButtons = '';
                    if (currentStatus === 'pending') {
                        actionButtons = `
                            <button class="btn btn-success" onclick="approveLeave('${leave.id}')" style="padding: 6px 12px; font-size: 13px; margin-left: 5px;">‚úÖ ŸÖŸàÿßŸÅŸÇÿ©</button>
                            <button class="btn btn-danger" onclick="rejectLeave('${leave.id}')" style="padding: 6px 12px; font-size: 13px; margin-left: 5px;">‚ùå ÿ±ŸÅÿ∂</button>
                            <button class="btn btn-primary" onclick="editLeave('${leave.id}')" style="padding: 6px 12px; font-size: 13px; margin-left: 5px;">‚úèÔ∏è ÿ™ÿπÿØŸäŸÑ</button>
                            <button class="btn btn-danger" onclick="deleteLeave('${leave.id}')" style="padding: 6px 12px; font-size: 13px;">üóëÔ∏è ÿ≠ÿ∞ŸÅ</button>
                        `;
                    } else {
                        actionButtons = `
                            <button class="btn btn-primary" onclick="editLeave('${leave.id}')" style="padding: 6px 12px; font-size: 13px; margin-left: 5px;">‚úèÔ∏è ÿ™ÿπÿØŸäŸÑ</button>
                            <button class="btn btn-danger" onclick="deleteLeave('${leave.id}')" style="padding: 6px 12px; font-size: 13px;">üóëÔ∏è ÿ≠ÿ∞ŸÅ</button>
                        `;
                    }
                    
                    // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿÆÿµŸÖ ŸÑŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ®
                    let deductionDisplay = '-';
                    if (leave.type === 'unpaid' && employee) {
                        const deduction = calculateUnpaidLeaveDeduction(leave, employee);
                        if (window.deductionViewUnlocked) {
                            // ÿπÿ±ÿ∂ ÿßŸÑÿÆÿµŸÖ ŸÖÿπ ÿßŸÑÿπŸÖŸÑÿ© (ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿπŸÖŸÑÿ© ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ© ÿ•ŸÜ Ÿàÿ¨ÿØÿ™)
                            const currency = leave.salaryCurrencyAtLeave || employee.currentSalaryCurrency || 'IQD';
                            const currencySymbol = currency === 'USD' ? '$' : 'ÿØ.ÿπ';
                            deductionDisplay = deduction !== null ? formatNumber(deduction) + ' ' + currencySymbol : '-';
                        } else {
                            deductionDisplay = deduction !== null ? '****' : '-';
                        }
                    }
                    
                    return `
                        <tr>
                            <td>${employeeName}</td>
                            <td>${getLeaveTypeName(leave.type, leave)}</td>
                            <td>${startDate}</td>
                            <td>${endDate}</td>
                            <td>${duration}</td>
                            <td><span class="badge ${statusBadge}">${statusName}</span></td>
                            <td style="font-weight: ${leave.type === 'unpaid' ? 'bold' : 'normal'}; color: ${leave.type === 'unpaid' ? '#dc3545' : 'inherit'};">
                                ${deductionDisplay}
                            </td>
                            <td>${leave.notes || '-'}</td>
                            <td class="action-buttons" style="white-space: nowrap;">
                                ${actionButtons}
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            const countEl = document.getElementById('leavesCount');
            if (countEl) {
                countEl.textContent = `ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™: ${filtered.length}`;
            }
        }

        function clearLeaveFilters() {
            document.getElementById('leaveSearch').value = '';
            document.getElementById('leaveTypeFilter').value = '';
            document.getElementById('leaveStatusFilter').value = '';
            leavesViewAllMonths = false;
            const now = new Date();
            leavesViewYear = now.getFullYear();
            leavesViewMonth = now.getMonth();
            updateLeavesMonthLabel();
            displayLeaves();
            updateLeavesCount();
        }

        function updateLeavesCount() {
            const count = leavesViewAllMonths 
                ? leavesData.length 
                : leavesData.filter(l => leaveOverlapsMonth(l, leavesViewYear, leavesViewMonth)).length;
            const countEl = document.getElementById('leavesCount');
            if (countEl) countEl.textContent = `ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™: ${count}`;
        }

        async function showAddLeaveForm() {
            // #region agent log
            const sessionId = 'debug-session-' + Date.now();
            const runId = 'run1';
            const editingLeaveIdBefore = editingLeaveId;
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßÿ≥ÿ™ÿØÿπÿßÿ° logging ÿßŸÑÿÆÿßÿ±ÿ¨Ÿä
            console.log('üîç [DEBUG-LEAVE-SHOW] showAddLeaveForm() - editingLeaveId ŸÇÿ®ŸÑ:', editingLeaveIdBefore);
            // #endregion
            
            editingLeaveId = null;
            
            // #region agent log
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßÿ≥ÿ™ÿØÿπÿßÿ° logging ÿßŸÑÿÆÿßÿ±ÿ¨Ÿä
            console.log('üîç [DEBUG-LEAVE-SHOW] showAddLeaveForm() - editingLeaveId ÿ®ÿπÿØ:', editingLeaveId);
            // #endregion
            
            const modal = document.getElementById('leaveModal');
            if (!modal) {
                // #region agent log
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßÿ≥ÿ™ÿØÿπÿßÿ° logging ÿßŸÑÿÆÿßÿ±ÿ¨Ÿä
                console.log('üîç [DEBUG-LEAVE-SHOW] ÿßŸÑŸÜÿßŸÅÿ∞ÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©!');
                // #endregion
                return;
            }

            // ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ™ÿ±ÿ¨ŸÖÿßÿ™ ŸÇÿ®ŸÑ ŸÅÿ™ÿ≠ ÿßŸÑŸÜÿßŸÅÿ∞ÿ©
            applyTranslations();
            
            const submitBtn = document.getElementById('leaveSubmitBtn');
            if (submitBtn) {
                submitBtn.setAttribute('onclick', 'addLeave()');
                // #region agent log
                const onclickAfter = submitBtn.getAttribute('onclick');
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßÿ≥ÿ™ÿØÿπÿßÿ° logging ÿßŸÑÿÆÿßÿ±ÿ¨Ÿä
                console.log('üîç [DEBUG-LEAVE-SHOW] onclick ÿ®ÿπÿØ ÿßŸÑÿ™ÿπŸäŸäŸÜ:', onclickAfter);
                // #endregion
            } else {
                // #region agent log
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßÿ≥ÿ™ÿØÿπÿßÿ° logging ÿßŸÑÿÆÿßÿ±ÿ¨Ÿä
                console.log('üîç [DEBUG-LEAVE-SHOW] ÿßŸÑÿ≤ÿ± leaveSubmitBtn ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ!');
                // #endregion
            }
            
            // ŸÖÿ≥ÿ≠ ÿßŸÑŸÜŸàÿπ ÿßŸÑÿ£ÿµŸÑŸä ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ ÿπŸÜÿØ ŸÅÿ™ÿ≠ ÿßŸÑŸÜÿßŸÅÿ∞ÿ©
            const leaveTypeSelect = document.getElementById('leaveType');
            if (leaveTypeSelect) {
                leaveTypeSelect.removeAttribute('data-original-type');
            }

            // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™ŸÉŸÜ ŸÖÿ≠ŸÖŸÑÿ© ÿ®ÿßŸÑŸÅÿπŸÑ
            if (!employeesData || employeesData.length === 0) {
                console.log('ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ...');
                await loadEmployees();
            }

            // ÿ™ÿ≠ÿØŸäÿ´ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ
            const employeeInput = document.getElementById('leaveEmployeeId');
            const employeeDatalist = document.getElementById('leaveEmployeeList');
            const employeeHiddenInput = document.getElementById('leaveEmployeeIdHidden');
            
            if (employeeInput && employeeDatalist) {
                // ŸÖÿ≥ÿ≠ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ≥ÿßÿ®ŸÇÿ©
                employeeDatalist.innerHTML = '';
                employeeInput.value = '';
                if (employeeHiddenInput) employeeHiddenInput.value = '';
                
                if (employeesData && employeesData.length > 0) {
                    // ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ ÿ≠ÿ≥ÿ® ÿßŸÑÿßÿ≥ŸÖ
                    const sortedEmployees = [...employeesData].sort((a, b) => {
                        const nameA = (a.name || '').trim().toLowerCase();
                        const nameB = (b.name || '').trim().toLowerCase();
                        return nameA.localeCompare(nameB, 'ar');
                    });
                    
                    sortedEmployees.forEach(emp => {
                        const option = document.createElement('option');
                        const displayText = `${emp.name || 'ÿ®ÿØŸàŸÜ ÿßÿ≥ŸÖ'}${emp.employeeNumber ? ' (' + emp.employeeNumber + ')' : ''}`;
                        option.value = displayText;
                        option.setAttribute('data-employee-id', emp.id);
                        employeeDatalist.appendChild(option);
                    });
                }
                
                // ÿ•ÿ∂ÿßŸÅÿ© event listener ŸÑÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ© ÿπŸÜÿØ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÖŸàÿ∏ŸÅ
                employeeInput.addEventListener('input', function() {
                    const inputValue = this.value.trim();
                    if (!inputValue) {
                        if (employeeHiddenInput) employeeHiddenInput.value = '';
                        const balanceInfo = document.getElementById('leaveBalanceInfo');
                        if (balanceInfo) balanceInfo.style.display = 'none';
                        return;
                    }
                    
                    // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÖŸàÿ∏ŸÅ ÿßŸÑŸÖÿ∑ÿßÿ®ŸÇ
                    const matchingOption = Array.from(employeeDatalist.options).find(opt => {
                        return opt.value === inputValue || opt.value.includes(inputValue);
                    });
                    
                    if (matchingOption) {
                        const employeeId = matchingOption.getAttribute('data-employee-id');
                        if (employeeHiddenInput) employeeHiddenInput.value = employeeId;
                        if (employeeId) {
                            calculateLeaveBalance(employeeId);
                        }
                    } else {
                        // ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿ¨ŸÖŸäÿπ ÿßŸÑÿÆŸäÿßÿ±ÿßÿ™ ŸÑŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ŸÖÿ∑ÿßÿ®ŸÇÿ© ÿ¨ÿ≤ÿ¶Ÿäÿ©
                        const foundOption = Array.from(employeeDatalist.options).find(opt => {
                            return opt.value.toLowerCase().includes(inputValue.toLowerCase());
                        });
                        
                        if (foundOption) {
                            const employeeId = foundOption.getAttribute('data-employee-id');
                            if (employeeHiddenInput) employeeHiddenInput.value = employeeId;
                            if (employeeId) {
                                calculateLeaveBalance(employeeId);
                            }
                        } else {
                            if (employeeHiddenInput) employeeHiddenInput.value = '';
                            const balanceInfo = document.getElementById('leaveBalanceInfo');
                            if (balanceInfo) balanceInfo.style.display = 'none';
                        }
                    }
                });
                
                // ÿ•ÿ∂ÿßŸÅÿ© event listener ÿπŸÜÿØ ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸÜ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸÜÿ≥ÿØŸÑÿ©
                employeeInput.addEventListener('change', function() {
                    const inputValue = this.value.trim();
                    if (!inputValue) {
                        if (employeeHiddenInput) employeeHiddenInput.value = '';
                        const balanceInfo = document.getElementById('leaveBalanceInfo');
                        if (balanceInfo) balanceInfo.style.display = 'none';
                        return;
                    }
                    
                    const matchingOption = Array.from(employeeDatalist.options).find(opt => opt.value === inputValue);
                    if (matchingOption) {
                        const employeeId = matchingOption.getAttribute('data-employee-id');
                        if (employeeHiddenInput) employeeHiddenInput.value = employeeId;
                        if (employeeId) {
                            calculateLeaveBalance(employeeId);
                        }
                    } else {
                        // ÿ•ÿ∞ÿß ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ŸÖÿ∑ÿßÿ®ŸÇÿ© ÿØŸÇŸäŸÇÿ©ÿå ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ŸÖÿ∑ÿßÿ®ŸÇÿ© ÿ¨ÿ≤ÿ¶Ÿäÿ©
                        const foundOption = Array.from(employeeDatalist.options).find(opt => {
                            return opt.value.toLowerCase().includes(inputValue.toLowerCase()) || 
                                   inputValue.toLowerCase().includes(opt.value.toLowerCase());
                        });
                        
                        if (foundOption) {
                            const employeeId = foundOption.getAttribute('data-employee-id');
                            if (employeeHiddenInput) employeeHiddenInput.value = employeeId;
                            this.value = foundOption.value; // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÜÿµ ÿßŸÑŸÖÿπÿ±Ÿàÿ∂
                            if (employeeId) {
                                calculateLeaveBalance(employeeId);
                            }
                        } else {
                            // ÿ•ÿ∞ÿß ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ£Ÿä ŸÖÿ∑ÿßÿ®ŸÇÿ©ÿå ŸÖÿ≥ÿ≠ ÿßŸÑŸÇŸäŸÖÿ©
                            if (employeeHiddenInput) employeeHiddenInput.value = '';
                            this.value = '';
                            const balanceInfo = document.getElementById('leaveBalanceInfo');
                            if (balanceInfo) balanceInfo.style.display = 'none';
                            alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸàÿ∏ŸÅ ŸÖŸÜ ÿßŸÑŸÇÿßÿ¶ŸÖÿ©');
                        }
                    }
                });
            }

            // ÿ™ÿ≠ÿØŸäÿ´ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ
            await updateLeaveRegionSelect();
            
            // ŸÖÿ≥ÿ≠ ÿßŸÑÿ≠ŸÇŸàŸÑ Ÿàÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÇŸäŸÖ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©
            const today = new Date().toISOString().split('T')[0]; // ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸäŸàŸÖ ÿ®ÿµŸäÿ∫ÿ© YYYY-MM-DD
            
            // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ leaveTypeSelect ÿßŸÑŸÖŸàÿ¨ŸàÿØ ÿ®ÿØŸÑÿßŸã ŸÖŸÜ getElementById ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ
            if (leaveTypeSelect) {
                leaveTypeSelect.value = '';
                handleLeaveTypeChange(); // ÿ•ÿÆŸÅÿßÿ°/ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿ≠ŸÇŸàŸÑ ÿ≠ÿ≥ÿ® ÿßŸÑŸÜŸàÿπ
            }
            
            document.getElementById('leaveStartDate').value = today;
            document.getElementById('leaveEndDate').value = today;
            document.getElementById('leaveHours').value = '';
            document.getElementById('leaveStatus').value = 'pending';
            document.getElementById('leaveNotes').value = '';
            
            // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿ≠ŸÇŸàŸÑ ÿßŸÑŸàŸÇÿ™ ŸÑŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿßŸÑÿ≤ŸÖŸÜŸäÿ©
            const leaveHoursInputMethod = document.getElementById('leaveHoursInputMethod');
            const leaveStartTime = document.getElementById('leaveStartTime');
            const leaveEndTime = document.getElementById('leaveEndTime');
            if (leaveHoursInputMethod) leaveHoursInputMethod.value = 'manual';
            if (leaveStartTime) leaveStartTime.value = '';
            if (leaveEndTime) leaveEndTime.value = '';
            const leaveCalculatedHours = document.getElementById('leaveCalculatedHours');
            if (leaveCalculatedHours) leaveCalculatedHours.textContent = '0';
            
            // ŸÖÿ≥ÿ≠ ÿßŸÑŸÅÿ™ÿ±ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ© ÿßŸÑŸÖÿ™ÿπÿØÿØÿ©
            const leaveTimePeriodsContainer = document.getElementById('leaveTimePeriodsContainer');
            if (leaveTimePeriodsContainer) {
                leaveTimePeriodsContainer.innerHTML = '';
            }
            const leaveTotalCalculatedHours = document.getElementById('leaveTotalCalculatedHours');
            if (leaveTotalCalculatedHours) leaveTotalCalculatedHours.textContent = '0';
            
            // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿ≠ŸÇŸàŸÑ ÿßŸÑŸàŸÇÿ™ ŸÑŸÑŸÖŸáŸÖÿ© ÿßŸÑÿ≤ŸÖŸÜŸäÿ©
            const leaveMissionHoursInputMethod = document.getElementById('leaveMissionHoursInputMethod');
            const leaveMissionStartTime = document.getElementById('leaveMissionStartTime');
            const leaveMissionEndTime = document.getElementById('leaveMissionEndTime');
            if (leaveMissionHoursInputMethod) leaveMissionHoursInputMethod.value = 'manual';
            if (leaveMissionStartTime) leaveMissionStartTime.value = '';
            if (leaveMissionEndTime) leaveMissionEndTime.value = '';
            const leaveMissionCalculatedHours = document.getElementById('leaveMissionCalculatedHours');
            if (leaveMissionCalculatedHours) leaveMissionCalculatedHours.textContent = '0';
            
            // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿπÿ±ÿ∂
            handleLeaveHoursMethodChange();
            handleMissionHoursMethodChange();
            
            const leaveHoursGroup = document.getElementById('leaveHoursGroup');
            const leaveDeductionGroup = document.getElementById('leaveDeductionGroup');
            const leaveBalanceInfo = document.getElementById('leaveBalanceInfo');
            if (leaveHoursGroup) leaveHoursGroup.style.display = 'none';
            if (leaveDeductionGroup) leaveDeductionGroup.style.display = 'none';
            if (leaveBalanceInfo) leaveBalanceInfo.style.display = 'none';
            
            // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ checkbox ÿßŸÑÿÆÿµŸÖ
            const calculateDeductionCheckbox = document.getElementById('leaveCalculateDeduction');
            if (calculateDeductionCheckbox) {
                calculateDeductionCheckbox.checked = true; // ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä: ŸÖŸÅÿπŸëŸÑ
            }

            modal.classList.add('active');
        }

        function hideAddLeaveForm() {
            // #region agent log
            const sessionId = 'debug-session-' + Date.now();
            const runId = 'run1';
            const editingLeaveIdBefore = editingLeaveId;
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßÿ≥ÿ™ÿØÿπÿßÿ° logging ÿßŸÑÿÆÿßÿ±ÿ¨Ÿä
            console.log('üîç [DEBUG-LEAVE-HIDE] hideAddLeaveForm() - editingLeaveId ŸÇÿ®ŸÑ:', editingLeaveIdBefore);
            // #endregion
            
            const modal = document.getElementById('leaveModal');
            if (modal) {
                modal.classList.remove('active');
            }
            editingLeaveId = null;
            
            // #region agent log
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßÿ≥ÿ™ÿØÿπÿßÿ° logging ÿßŸÑÿÆÿßÿ±ÿ¨Ÿä
            console.log('üîç [DEBUG-LEAVE-HIDE] hideAddLeaveForm() - editingLeaveId ÿ®ÿπÿØ:', editingLeaveId);
            // #endregion
        }

        // ÿ™ÿ∫ŸäŸäÿ± ŸÜŸàÿπ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ŸÑÿ•ÿ∏Ÿáÿßÿ±/ÿ•ÿÆŸÅÿßÿ° ÿ≠ŸÇŸÑ ÿßŸÑÿ≥ÿßÿπÿßÿ™
        document.addEventListener('DOMContentLoaded', function() {
            const leaveTypeSelect = document.getElementById('leaveType');
            const leaveHoursGroup = document.getElementById('leaveHoursGroup');
            if (leaveTypeSelect && leaveHoursGroup) {
                leaveTypeSelect.addEventListener('change', function() {
                    // ÿ≠ŸÅÿ∏ ÿßŸÑŸÜŸàÿπ ÿßŸÑÿ£ÿµŸÑŸä ÿπŸÜÿØ ÿßÿÆÿ™Ÿäÿßÿ± ŸÜŸàÿπ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ŸÑÿ£ŸàŸÑ ŸÖÿ±ÿ©
                    if (!this.getAttribute('data-original-type')) {
                        this.setAttribute('data-original-type', this.value);
                    }
                    
                    if (this.value === 'hourly') {
                        leaveHoursGroup.style.display = 'block';
                        document.getElementById('leaveEndDate').required = false;
                    } else if (this.value === 'unpaid') {
                        leaveHoursGroup.style.display = 'none';
                        document.getElementById('leaveEndDate').required = true;
                    } else {
                        leaveHoursGroup.style.display = 'none';
                        document.getElementById('leaveEndDate').required = true;
                    }
                });
            }
        });

        async function addLeave() {
            // #region agent log
            const sessionId = 'debug-session-' + Date.now();
            const runId = 'run1';
            const submitBtn = document.getElementById('leaveSubmitBtn');
            const onclickValue = submitBtn ? submitBtn.getAttribute('onclick') : 'ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ';
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßÿ≥ÿ™ÿØÿπÿßÿ° logging ÿßŸÑÿÆÿßÿ±ÿ¨Ÿä
            console.log('üîç [DEBUG-LEAVE-ADD] ÿ®ÿØÿ° addLeave(), editingLeaveId:', editingLeaveId, 'onclick:', onclickValue);
            // #endregion
            
            if (editingLeaveId) {
                // #region agent log
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßÿ≥ÿ™ÿØÿπÿßÿ° logging ÿßŸÑÿÆÿßÿ±ÿ¨Ÿä
                console.log('üîç [DEBUG-LEAVE-ADD] ‚ö†Ô∏è editingLeaveId ŸÖŸàÿ¨ŸàÿØÿå ÿßÿ≥ÿ™ÿØÿπÿßÿ° updateLeave() - Ÿáÿ∞ÿß ŸÇÿØ ŸäŸÉŸàŸÜ ÿÆÿ∑ÿ£!');
                // #endregion
                updateLeave();
                return;
            }

            if (!window.db || !window.firestore) {
                alert('Firebase ÿ∫Ÿäÿ± ŸÖŸáŸäÿ£');
                return;
            }

            // ŸÇÿ±ÿßÿ°ÿ© ID ÿßŸÑŸÖŸàÿ∏ŸÅ ŸÖŸÜ ÿßŸÑÿ≠ŸÇŸÑ ÿßŸÑŸÖÿÆŸÅŸä
            const employeeHiddenInput = document.getElementById('leaveEmployeeIdHidden');
            const employeeInput = document.getElementById('leaveEmployeeId');
            let employeeId = employeeHiddenInput ? employeeHiddenInput.value : '';
            
            // ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸáŸÜÿßŸÉ ID ŸÅŸä ÿßŸÑÿ≠ŸÇŸÑ ÿßŸÑŸÖÿÆŸÅŸäÿå ÿ≠ÿßŸàŸÑ ÿßŸÑÿ®ÿ≠ÿ´ ŸÖŸÜ ÿßŸÑŸÜÿµ ÿßŸÑŸÖÿØÿÆŸÑ
            if (!employeeId && employeeInput && employeeInput.value.trim()) {
                const datalist = document.getElementById('leaveEmployeeList');
                if (datalist) {
                    const matchingOption = Array.from(datalist.options).find(opt => opt.value === employeeInput.value.trim());
                    if (matchingOption) {
                        employeeId = matchingOption.getAttribute('data-employee-id');
                        if (employeeId && employeeHiddenInput) {
                            employeeHiddenInput.value = employeeId;
                        }
                    }
                }
            }
            
            if (!employeeId) {
                alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸàÿ∏ŸÅ ÿµÿ≠Ÿäÿ≠ ŸÖŸÜ ÿßŸÑŸÇÿßÿ¶ŸÖÿ©');
                return;
            }
            
            const leaveTypeSelect = document.getElementById('leaveType');
            if (!leaveTypeSelect) {
                alert('ÿÆÿ∑ÿ£: ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ≠ŸÇŸÑ ŸÜŸàÿπ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ©');
                return;
            }
            
            let type = leaveTypeSelect.value; // ÿ™ÿ∫ŸäŸäÿ± ÿ•ŸÑŸâ let ŸÑŸÑÿ≥ŸÖÿßÿ≠ ÿ®ÿßŸÑÿ™ÿπÿØŸäŸÑ
            
            // ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÜŸàÿπ ÿßŸÑÿ£ÿµŸÑŸä (ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸÖÿ≠ÿØÿØÿßŸãÿå ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑŸÜŸàÿπ ÿßŸÑÿ≠ÿßŸÑŸä)
            let originalType = leaveTypeSelect.getAttribute('data-original-type');
            if (!originalType) {
                originalType = type; // ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸáŸÜÿßŸÉ ŸÜŸàÿπ ÿ£ÿµŸÑŸä ŸÖÿ≠ŸÅŸàÿ∏ÿå ŸÅÿßŸÑŸÜŸàÿπ ÿßŸÑÿ≠ÿßŸÑŸä ŸáŸà ÿßŸÑÿ£ÿµŸÑŸä
                leaveTypeSelect.setAttribute('data-original-type', type);
            }
            
            const startDate = document.getElementById('leaveStartDate').value;
            const endDate = document.getElementById('leaveEndDate').value;
            const hoursInputMethod = document.getElementById('leaveHoursInputMethod')?.value;
            let hours = document.getElementById('leaveHours').value;
            let timeRanges = null; // ŸÖÿµŸÅŸàŸÅÿ© ÿßŸÑŸÅÿ™ÿ±ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ© ÿßŸÑŸÖÿ™ÿπÿØÿØÿ©
            
            // ÿ¨ŸÖÿπ ÿßŸÑŸÅÿ™ÿ±ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ© ÿßŸÑŸÖÿ™ÿπÿØÿØÿ© ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿßŸÑÿ∑ÿ±ŸäŸÇÿ© "multiple-periods"
            if (type === 'hourly' && hoursInputMethod === 'multiple-periods') {
                const container = document.getElementById('leaveTimePeriodsContainer');
                if (container) {
                    timeRanges = [];
                    const periods = container.querySelectorAll('.leave-time-period');
                    periods.forEach(period => {
                        const startTimeInput = period.querySelector('.period-start-time');
                        const endTimeInput = period.querySelector('.period-end-time');
                        if (startTimeInput && endTimeInput && startTimeInput.value && endTimeInput.value) {
                            timeRanges.push({
                                startTime: startTimeInput.value,
                                endTime: endTimeInput.value
                            });
                        }
                    });
                    // ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™ŸÉŸÜ ŸáŸÜÿßŸÉ ŸÅÿ™ÿ±ÿßÿ™ ÿµÿßŸÑÿ≠ÿ©ÿå ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ≥ÿßÿπÿßÿ™ ÿßŸÑŸÖÿ≠ÿ≥Ÿàÿ®ÿ©
                    if (timeRanges.length === 0) {
                        alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿ∂ÿßŸÅÿ© ŸÅÿ™ÿ±ÿ© ÿ≤ŸÖŸÜŸäÿ© Ÿàÿßÿ≠ÿØÿ© ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ');
                        return;
                    }
                }
            }
            
            const status = document.getElementById('leaveStatus').value || 'pending';
            const notes = document.getElementById('leaveNotes').value.trim();

            if (!employeeId || !type || !startDate) {
                alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©');
                return;
            }

            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ±ÿµŸäÿØ ŸÑŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑÿ¥Ÿáÿ±Ÿäÿ© (ŸÇÿ®ŸÑ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ endDate)
            // ŸÑÿ£ŸÜ endDate ŸÇÿØ ŸÑÿß ŸäŸÉŸàŸÜ ŸÖÿ∑ŸÑŸàÿ®ÿßŸã ÿ•ÿ∞ÿß ÿ™ŸÖ ÿßŸÑÿ™ÿ≠ŸàŸäŸÑ ÿ•ŸÑŸâ ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ®
            let needsEndDate = true;
            if (type === 'hourly' || type === 'unpaid') {
                needsEndDate = false;
            }

            if (needsEndDate && !endDate) {
                alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ°');
                return;
            }

            if (type === 'hourly' && !hours) {
                alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿπÿØÿØ ÿßŸÑÿ≥ÿßÿπÿßÿ™');
                return;
            }
            
            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ŸÜŸàÿπ ÿßŸÑŸÖŸáŸÖÿ© ŸÑŸÖŸáŸÖÿ© ÿßŸÑÿπŸÖŸÑ
            if (type === 'work-mission') {
                const missionType = document.getElementById('leaveMissionType')?.value;
                if (!missionType) {
                    alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßÿÆÿ™Ÿäÿßÿ± ŸÜŸàÿπ ÿßŸÑŸÖŸáŸÖÿ© (ÿ≤ŸÖŸÜŸäÿ© ÿ£Ÿà ŸäŸàŸÖ ŸÉÿßŸÖŸÑ)');
                    return;
                }
                if (missionType === 'hourly') {
                    const missionHours = document.getElementById('leaveMissionHours')?.value;
                    if (!missionHours || parseFloat(missionHours) <= 0) {
                        alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿπÿØÿØ ÿ≥ÿßÿπÿßÿ™ ÿßŸÑŸÖŸáŸÖÿ©');
                        return;
                    }
                } else if (missionType === 'full-day' && !endDate) {
                    alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ° ŸÑŸÖŸáŸÖÿ© ÿßŸÑÿπŸÖŸÑ (ŸäŸàŸÖ ŸÉÿßŸÖŸÑ)');
                    return;
                }
            }

            // ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ŸÑÿ™ÿÆÿ≤ŸäŸÜ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ™ŸÇÿ≥ŸäŸÖ (ÿ•ÿ∞ÿß ŸÑÿ≤ŸÖ ÿßŸÑÿ£ŸÖÿ±)
            let shouldSplitLeave = false;
            let paidHours = 0;
            let unpaidHours = 0;
            
            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ±ÿµŸäÿØ ŸÑŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ©
            if (type === 'hourly' && hours) {
                const employee = employeesData.find(e => e.id === employeeId);
                if (employee) {
                    const hourlyLeaveHours = employee.hourlyLeaveHours || 8;
                    const now = new Date();
                    const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                    
                    // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖÿ© ŸÅŸä ÿßŸÑÿ¥Ÿáÿ± ÿßŸÑÿ≠ÿßŸÑŸä
                    let hourlyUsed = 0;
                    const hourlyLeaves = leavesData.filter(l => 
                        l.employeeId === employeeId && 
                        l.type === 'hourly' && 
                        l.status === 'approved'
                    );
                    
                    hourlyLeaves.forEach(leave => {
                        if (leave.startDate) {
                            const leaveDate = new Date(leave.startDate);
                            // ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ŸÅŸä ÿßŸÑÿ¥Ÿáÿ± ÿßŸÑÿ≠ÿßŸÑŸä
                            if (leaveDate >= firstDayOfMonth) {
                                hourlyUsed += (leave.hours || 0);
                            }
                        }
                    });
                    
                    const hourlyBalance = hourlyLeaveHours - hourlyUsed;
                    const requiredHours = parseFloat(hours);
                    
                    // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿ±ÿµŸäÿØ ÿ∫Ÿäÿ± ŸÉÿßŸÅŸä (ÿµŸÅÿ± ÿ£Ÿà ÿ≥ÿßŸÑÿ®) ÿ£Ÿà ÿßŸÑŸÖÿ∑ŸÑŸàÿ® Ÿäÿ™ÿ¨ÿßŸàÿ≤ ÿßŸÑÿ±ÿµŸäÿØ ÿßŸÑŸÖÿ™ÿßÿ≠
                    if (hourlyBalance <= 0 || hourlyBalance < requiredHours) {
                        let confirmMessage = '';
                        if (hourlyBalance < 0) {
                            // ÿßŸÑÿ±ÿµŸäÿØ ÿßŸÑÿ≥ÿßŸÑÿ®
                            confirmMessage = `‚ö†Ô∏è ÿßŸÑÿ±ÿµŸäÿØ ÿßŸÑÿ≤ŸÖŸÜŸä ÿßŸÑÿ≠ÿßŸÑŸä: ${hourlyBalance.toFixed(1)} ÿ≥ÿßÿπÿ© (ÿ±ÿµŸäÿØ ÿ≥ÿßŸÑÿ®)\n\nÿßŸÑŸÖÿ∑ŸÑŸàÿ®: ${requiredHours} ÿ≥ÿßÿπÿ©\n\nÿ≥Ÿäÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ŸÉŸÄ "ÿ•ÿ¨ÿßÿ≤ÿ© ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ®" ŸÑÿ£ŸÜ ÿßŸÑÿ±ÿµŸäÿØ ÿßŸÑÿ≤ŸÖŸÜŸä ÿ≥ÿßŸÑÿ®.\n\nŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©ÿü`;
                        } else if (hourlyBalance === 0) {
                            // ÿßŸÑÿ±ÿµŸäÿØ ÿµŸÅÿ±
                            confirmMessage = `‚ö†Ô∏è ÿßŸÑÿ±ÿµŸäÿØ ÿßŸÑÿ≤ŸÖŸÜŸä ÿßŸÑÿ≠ÿßŸÑŸä: ${hourlyBalance.toFixed(1)} ÿ≥ÿßÿπÿ© (ÿ±ÿµŸäÿØ ÿµŸÅÿ±)\n\nÿßŸÑŸÖÿ∑ŸÑŸàÿ®: ${requiredHours} ÿ≥ÿßÿπÿ©\n\nÿ≥Ÿäÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ŸÉŸÄ "ÿ•ÿ¨ÿßÿ≤ÿ© ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ®" ŸÑÿ£ŸÜ ÿßŸÑÿ±ÿµŸäÿØ ÿßŸÑÿ≤ŸÖŸÜŸä ÿµŸÅÿ±.\n\nŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©ÿü`;
                        } else {
                            // ÿßŸÑÿ±ÿµŸäÿØ ŸÖŸàÿ¨ÿ® ŸÑŸÉŸÜ ÿ∫Ÿäÿ± ŸÉÿßŸÅŸä - ÿ™ŸÇÿ≥ŸäŸÖ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ©
                            const shortage = requiredHours - hourlyBalance;
                            confirmMessage = `‚ö†Ô∏è ÿßŸÑÿ±ÿµŸäÿØ ÿßŸÑÿ≤ŸÖŸÜŸä ÿßŸÑŸÖÿ™ÿßÿ≠: ${hourlyBalance.toFixed(1)} ÿ≥ÿßÿπÿ©\nÿßŸÑŸÖÿ∑ŸÑŸàÿ®: ${requiredHours} ÿ≥ÿßÿπÿ©\nÿßŸÑŸÜŸÇÿµ: ${shortage.toFixed(1)} ÿ≥ÿßÿπÿ©\n\nÿ≥Ÿäÿ™ŸÖ ÿ™ŸÇÿ≥ŸäŸÖ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã:\n‚Ä¢ ÿ•ÿ¨ÿßÿ≤ÿ© ÿ≤ŸÖŸÜŸäÿ©: ${hourlyBalance.toFixed(1)} ÿ≥ÿßÿπÿ© (ŸÖŸÜ ÿßŸÑÿ±ÿµŸäÿØ)\n‚Ä¢ ÿ•ÿ¨ÿßÿ≤ÿ© ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ®: ${shortage.toFixed(1)} ÿ≥ÿßÿπÿ© (ÿßŸÑÿ®ÿßŸÇŸä)\n\nŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©ÿü`;
                            shouldSplitLeave = true;
                            paidHours = hourlyBalance;
                            unpaidHours = shortage;
                        }
                        
                        if (!confirm(confirmMessage)) {
                            return;
                        }
                        
                        // ÿ•ÿ∏Ÿáÿßÿ± ÿÆŸäÿßÿ± ÿßŸÑÿÆÿµŸÖ ÿπŸÜÿØ ÿ™ŸÇÿ≥ŸäŸÖ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ©
                        if (shouldSplitLeave) {
                            const leaveDeductionGroup = document.getElementById('leaveDeductionGroup');
                            if (leaveDeductionGroup) {
                                leaveDeductionGroup.style.display = 'block';
                            }
                        }
                        
                        if (!shouldSplitLeave) {
                            // ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿßŸÑÿ≤ŸÖŸÜŸäÿ© ÿ™ÿ®ŸÇŸâ ÿ≤ŸÖŸÜŸäÿ© (type: hourly) ŸÖÿπ ÿπŸÑÿßŸÖÿ© ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ® (isUnpaidHourly)
                            originalType = 'hourly';
                            leaveTypeSelect.setAttribute('data-original-type', 'hourly');
                            leaveTypeSelect.setAttribute('data-is-unpaid-hourly', 'true');
                            // ŸÑÿß ŸÜÿ∫ŸäŸëÿ± type ÿ•ŸÑŸâ unpaidÿõ ÿ™ÿ®ŸÇŸâ 'hourly'
                            
                            // ÿ•ÿ∏Ÿáÿßÿ± ÿÆŸäÿßÿ± ÿßŸÑÿÆÿµŸÖ ÿπŸÜÿØ ÿßŸÑÿ™ÿ≠ŸàŸäŸÑ ÿ•ŸÑŸâ ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ®
                            const leaveDeductionGroup = document.getElementById('leaveDeductionGroup');
                            if (leaveDeductionGroup) {
                                leaveDeductionGroup.style.display = 'block';
                            }
                            // ÿ≠ŸÇŸÑ ÿßŸÑÿ≥ÿßÿπÿßÿ™ Ÿäÿ®ŸÇŸâ ÿ∏ÿßŸáÿ±ÿßŸã ŸÑÿ£ŸÜ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿ≤ŸÖŸÜŸäÿ©
                        }
                    }
                }
            }

            // ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ŸÑÿ™ÿÆÿ≤ŸäŸÜ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ™ŸÇÿ≥ŸäŸÖ ŸÑŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑÿ¥Ÿáÿ±Ÿäÿ©
            let shouldSplitMonthlyLeave = false;
            let paidDays = 0;
            let unpaidDays = 0;
            let paidEndDate = null;
            let unpaidStartDate = null;
            
            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ±ÿµŸäÿØ ŸÑŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑÿ¥Ÿáÿ±Ÿäÿ©
            if (type === 'monthly' && endDate) {
                const employee = employeesData.find(e => e.id === employeeId);
                if (employee) {
                    const monthlyLeaveDays = employee.monthlyLeaveDays || 2.5;
                    const initialBalance = employee.initialLeaveBalance || 0;
                    const entryDate = employee.systemEntryDate || employee.hireDate;
                    
                    let totalMonthlyLeaves = 0;
                    if (entryDate) {
                        const systemEntryDate = new Date(entryDate);
                        systemEntryDate.setHours(0, 0, 0, 0); // ÿ∂ÿ®ÿ∑ ÿßŸÑŸàŸÇÿ™ ÿ•ŸÑŸâ ÿ®ÿØÿßŸäÿ© ÿßŸÑŸäŸàŸÖ
                        const now = new Date();
                        now.setHours(0, 0, 0, 0); // ÿ∂ÿ®ÿ∑ ÿßŸÑŸàŸÇÿ™ ÿ•ŸÑŸâ ÿ®ÿØÿßŸäÿ© ÿßŸÑŸäŸàŸÖ
                        
                        // ÿ≠ÿ≥ÿßÿ® ÿπÿØÿØ ÿßŸÑÿ£ÿ¥Ÿáÿ± ÿ®ÿØŸÇÿ© (ŸÖÿ±ÿßÿπÿßÿ© ÿßŸÑÿ£ŸäÿßŸÖ)
                        let monthsDiff = (now.getFullYear() - systemEntryDate.getFullYear()) * 12 + 
                                        (now.getMonth() - systemEntryDate.getMonth());
                        
                        // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑŸäŸàŸÖ ÿßŸÑÿ≠ÿßŸÑŸä < ŸäŸàŸÖ ÿßŸÑÿ•ÿØÿ±ÿßÿ¨ÿå ŸÑÿß ŸÜÿ≠ÿ≥ÿ® ÿßŸÑÿ¥Ÿáÿ± ÿßŸÑÿ≠ÿßŸÑŸä
                        if (now.getDate() < systemEntryDate.getDate()) {
                            monthsDiff -= 1;
                        }
                        
                        // ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ£ŸÜ ÿπÿØÿØ ÿßŸÑÿ£ÿ¥Ÿáÿ± ŸÑŸäÿ≥ ÿ≥ÿßŸÑÿ®ÿßŸã
                        if (monthsDiff < 0) {
                            monthsDiff = 0;
                        }
                        
                        totalMonthlyLeaves = (monthsDiff * monthlyLeaveDays) + initialBalance;
                    } else {
                        totalMonthlyLeaves = initialBalance;
                    }
                    
                    // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖÿ©
                    // ŸÖŸÑÿßÿ≠ÿ∏ÿ©: 
                    // 1. ÿ¨ŸÖŸäÿπ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ŸÖŸÜ ŸÜŸàÿπ "monthly" ÿ™Ÿèÿ≠ÿ≥ÿ® ŸÅŸä ÿßŸÑÿ±ÿµŸäÿØ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
                    // 2. ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ŸÖŸÜ ŸÜŸàÿπ "unpaid" ÿßŸÑÿ™Ÿä ÿ™ŸÖ ÿ™ÿ≠ŸàŸäŸÑŸáÿß ŸÖŸÜ "monthly" (convertedFromMonthly === true) ÿ™Ÿèÿ≠ÿ≥ÿ® ÿ£Ÿäÿ∂ÿßŸã
                    // 3. ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ŸÖŸÜ ŸÜŸàÿπ "unpaid" ÿßŸÑŸÖÿ®ÿßÿ¥ÿ±ÿ© (ÿ∫Ÿäÿ± ŸÖÿ≠ŸàŸÑÿ©) ŸÑÿß ÿ™Ÿèÿ≠ÿ≥ÿ® ŸÅŸä ÿßŸÑÿ±ÿµŸäÿØ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
                    let monthlyUsed = 0;
                    const monthlyLeaves = leavesData.filter(l => 
                        l.employeeId === employeeId && 
                        l.status === 'approved' && // ÿßŸÑŸÖŸàÿßŸÅŸÇ ÿπŸÑŸäŸáÿß ŸÅŸÇÿ∑
                        (
                            l.type === 'monthly' || // ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑÿ¥Ÿáÿ±Ÿäÿ©
                            (l.type === 'unpaid' && l.convertedFromMonthly === true) // ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑŸÖÿ≠ŸàŸÑÿ© ŸÖŸÜ ÿ¥Ÿáÿ±Ÿäÿ© ÿ•ŸÑŸâ ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ®
                        )
                    );
                    
                    monthlyLeaves.forEach(leave => {
                        if (leave.startDate && leave.endDate) {
                            const start = new Date(leave.startDate);
                            start.setHours(0, 0, 0, 0); // ÿ∂ÿ®ÿ∑ ÿßŸÑŸàŸÇÿ™ ÿ•ŸÑŸâ ÿ®ÿØÿßŸäÿ© ÿßŸÑŸäŸàŸÖ
                            const end = new Date(leave.endDate);
                            end.setHours(0, 0, 0, 0); // ÿ∂ÿ®ÿ∑ ÿßŸÑŸàŸÇÿ™ ÿ•ŸÑŸâ ÿ®ÿØÿßŸäÿ© ÿßŸÑŸäŸàŸÖ
                            
                            // ÿ≠ÿ≥ÿßÿ® ÿπÿØÿØ ÿßŸÑÿ£ŸäÿßŸÖ (ÿ¥ÿßŸÖŸÑÿ©)
                            const diffTime = Math.abs(end - start);
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                            monthlyUsed += diffDays;
                        }
                    });
                    
                    const monthlyBalance = totalMonthlyLeaves - monthlyUsed;
                    
                    // ÿ≠ÿ≥ÿßÿ® ŸÖÿØÿ© ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    const diffTime = Math.abs(end - start);
                    const requiredDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    
                    // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿ±ÿµŸäÿØ ÿ∫Ÿäÿ± ŸÉÿßŸÅŸä (ÿµŸÅÿ± ÿ£Ÿà ÿ≥ÿßŸÑÿ®)ÿå ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿ•ŸÑŸâ ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ®
                    if (monthlyBalance <= 0 || monthlyBalance < requiredDays) {
                        let confirmMessage = '';
                        if (monthlyBalance < 0) {
                            // ÿßŸÑÿ±ÿµŸäÿØ ÿßŸÑÿ≥ÿßŸÑÿ®
                            confirmMessage = `‚ö†Ô∏è ÿßŸÑÿ±ÿµŸäÿØ ÿßŸÑÿ≠ÿßŸÑŸä: ${monthlyBalance.toFixed(1)} ŸäŸàŸÖ (ÿ±ÿµŸäÿØ ÿ≥ÿßŸÑÿ®)\n\nÿßŸÑŸÖÿ∑ŸÑŸàÿ®: ${requiredDays} ŸäŸàŸÖ\n\nÿ≥Ÿäÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ŸÉŸÄ "ÿ•ÿ¨ÿßÿ≤ÿ© ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ®" ŸÑÿ£ŸÜ ÿßŸÑÿ±ÿµŸäÿØ ÿ≥ÿßŸÑÿ®.\n\nŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©ÿü`;
                        } else if (monthlyBalance === 0) {
                            // ÿßŸÑÿ±ÿµŸäÿØ ÿµŸÅÿ±
                            confirmMessage = `‚ö†Ô∏è ÿßŸÑÿ±ÿµŸäÿØ ÿßŸÑÿ≠ÿßŸÑŸä: ${monthlyBalance.toFixed(1)} ŸäŸàŸÖ (ÿ±ÿµŸäÿØ ÿµŸÅÿ±)\n\nÿßŸÑŸÖÿ∑ŸÑŸàÿ®: ${requiredDays} ŸäŸàŸÖ\n\nÿ≥Ÿäÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ŸÉŸÄ "ÿ•ÿ¨ÿßÿ≤ÿ© ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ®" ŸÑÿ£ŸÜ ÿßŸÑÿ±ÿµŸäÿØ ÿµŸÅÿ±.\n\nŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©ÿü`;
                        } else {
                            // ÿßŸÑÿ±ÿµŸäÿØ ŸÖŸàÿ¨ÿ® ŸÑŸÉŸÜ ÿ∫Ÿäÿ± ŸÉÿßŸÅŸä - ÿ™ŸÇÿ≥ŸäŸÖ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ©
                            const shortage = requiredDays - monthlyBalance;
                            
                            // ÿ≠ÿ≥ÿßÿ® ÿ™Ÿàÿßÿ±ŸäÿÆ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑŸÖŸÇÿ≥ŸÖÿ©
                            const startDateObj = new Date(startDate);
                            startDateObj.setHours(0, 0, 0, 0);
                            
                            // ÿ™ÿßÿ±ŸäÿÆ ÿßŸÜÿ™Ÿáÿßÿ° ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ŸÖŸÜ ÿßŸÑÿ±ÿµŸäÿØ (ÿ®ÿπÿØ ÿπÿØÿØ ÿßŸÑÿ£ŸäÿßŸÖ ÿßŸÑŸÖÿ™ÿßÿ≠ÿ©)
                            const paidEndDateObj = new Date(startDateObj);
                            paidEndDateObj.setDate(paidEndDateObj.getDate() + Math.floor(monthlyBalance) - 1);
                            
                            // ÿ™ÿßÿ±ŸäÿÆ ÿ®ÿØÿßŸäÿ© ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ® (ÿßŸÑŸäŸàŸÖ ÿßŸÑÿ™ÿßŸÑŸä ŸÑÿ™ÿßÿ±ŸäÿÆ ÿßŸÜÿ™Ÿáÿßÿ° ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ŸÖŸÜ ÿßŸÑÿ±ÿµŸäÿØ)
                            const unpaidStartDateObj = new Date(paidEndDateObj);
                            unpaidStartDateObj.setDate(unpaidStartDateObj.getDate() + 1);
                            
                            // ÿ™ÿßÿ±ŸäÿÆ ÿßŸÜÿ™Ÿáÿßÿ° ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ® (ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ£ÿµŸÑŸä)
                            const unpaidEndDateObj = new Date(endDate);
                            
                            paidEndDate = paidEndDateObj.toISOString().split('T')[0];
                            unpaidStartDate = unpaidStartDateObj.toISOString().split('T')[0];
                            
                            confirmMessage = `‚ö†Ô∏è ÿßŸÑÿ±ÿµŸäÿØ ÿßŸÑŸÖÿ™ÿßÿ≠: ${monthlyBalance.toFixed(1)} ŸäŸàŸÖ\nÿßŸÑŸÖÿ∑ŸÑŸàÿ®: ${requiredDays} ŸäŸàŸÖ\nÿßŸÑŸÜŸÇÿµ: ${shortage.toFixed(1)} ŸäŸàŸÖ\n\nÿ≥Ÿäÿ™ŸÖ ÿ™ŸÇÿ≥ŸäŸÖ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã:\n‚Ä¢ ÿ•ÿ¨ÿßÿ≤ÿ© ÿ¥Ÿáÿ±Ÿäÿ©: ${Math.floor(monthlyBalance)} ŸäŸàŸÖ (ŸÖŸÜ ${startDate} ÿ•ŸÑŸâ ${paidEndDate})\n‚Ä¢ ÿ•ÿ¨ÿßÿ≤ÿ© ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ®: ${Math.ceil(shortage)} ŸäŸàŸÖ (ŸÖŸÜ ${unpaidStartDate} ÿ•ŸÑŸâ ${endDate})\n\nŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©ÿü`;
                            shouldSplitMonthlyLeave = true;
                            paidDays = Math.floor(monthlyBalance);
                            unpaidDays = Math.ceil(shortage);
                        }
                        
                        if (!confirm(confirmMessage)) {
                            return;
                        }
                        
                        // ÿ•ÿ∏Ÿáÿßÿ± ÿÆŸäÿßÿ± ÿßŸÑÿÆÿµŸÖ ÿπŸÜÿØ ÿ™ŸÇÿ≥ŸäŸÖ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ©
                        if (shouldSplitMonthlyLeave) {
                            const leaveDeductionGroup = document.getElementById('leaveDeductionGroup');
                            if (leaveDeductionGroup) {
                                leaveDeductionGroup.style.display = 'block';
                            }
                        }
                        
                        if (!shouldSplitMonthlyLeave) {
                            // ÿ™ÿ≠ŸàŸäŸÑ ŸÜŸàÿπ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿ•ŸÑŸâ ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ® (ŸÑŸÑÿ±ÿµŸäÿØ ÿßŸÑÿ≥ÿßŸÑÿ® ÿ£Ÿà ÿßŸÑÿµŸÅÿ±)
                            // ÿ≠ŸÅÿ∏ ÿßŸÑŸÜŸàÿπ ÿßŸÑÿ£ÿµŸÑŸä ŸÇÿ®ŸÑ ÿßŸÑÿ™ÿ≠ŸàŸäŸÑ (ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑŸÖÿ™ÿ∫Ÿäÿ± ÿßŸÑŸÖŸàÿ¨ŸàÿØ)
                            // ÿ™ÿ£ŸÉŸäÿØ ÿ£ŸÜ ÿßŸÑŸÜŸàÿπ ÿßŸÑÿ£ÿµŸÑŸä ŸáŸà 'monthly' ÿπŸÜÿØ ÿßŸÑÿ™ÿ≠ŸàŸäŸÑ
                            originalType = 'monthly'; // ÿ™ÿ≠ÿØŸäÿ´ originalType ŸÇÿ®ŸÑ ÿ™ÿ∫ŸäŸäÿ± type
                            leaveTypeSelect.setAttribute('data-original-type', 'monthly'); // ÿ≠ŸÅÿ∏ ŸÅŸä attribute ÿ£Ÿäÿ∂ÿßŸã
                            leaveTypeSelect.value = 'unpaid';
                            type = 'unpaid';
                            
                            // ÿ•ÿ∏Ÿáÿßÿ± ÿÆŸäÿßÿ± ÿßŸÑÿÆÿµŸÖ ÿπŸÜÿØ ÿßŸÑÿ™ÿ≠ŸàŸäŸÑ ÿ•ŸÑŸâ ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ®
                            const leaveDeductionGroup = document.getElementById('leaveDeductionGroup');
                            if (leaveDeductionGroup) {
                                leaveDeductionGroup.style.display = 'block';
                            }
                            
                            // ŸÖŸÑÿßÿ≠ÿ∏ÿ©: endDate ÿ≥Ÿäÿ™ŸÖ ÿ™ÿπŸäŸäŸÜŸá ÿ•ŸÑŸâ null ÿπŸÜÿØ ÿßŸÑÿ≠ŸÅÿ∏ ŸÑÿ£ŸÜ type ÿ£ÿµÿ®ÿ≠ 'unpaid'
                        }
                    }
                }
            }

            try {
                // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑŸÖŸàÿ∏ŸÅ ŸÑŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ±ÿßÿ™ÿ®
                const employee = employeesData.find(e => e.id === employeeId);
                
                // ÿ•ÿ∞ÿß ŸÉÿßŸÜ Ÿäÿ¨ÿ® ÿ™ŸÇÿ≥ŸäŸÖ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© (ÿ¥Ÿáÿ±Ÿäÿ© ÿ£Ÿà ÿ≤ŸÖŸÜŸäÿ©)
                if (shouldSplitMonthlyLeave || shouldSplitLeave) {
                    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿπÿØŸÖ ÿ™ŸÉÿ±ÿßÿ± ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ŸÑŸÜŸÅÿ≥ ÿßŸÑŸÖŸàÿ∏ŸÅ ŸÅŸä ŸÜŸÅÿ≥ ÿßŸÑŸÅÿ™ÿ±ÿ©
                    const hasOverlap = checkLeaveOverlap(employeeId, startDate, endDate, type, null);
                    if (hasOverlap) {
                        alert('‚ö†Ô∏è ŸäŸàÿ¨ÿØ ÿ•ÿ¨ÿßÿ≤ÿ© ÿ£ÿÆÿ±Ÿâ ŸÑŸÑŸÖŸàÿ∏ŸÅ ŸÅŸä ŸÜŸÅÿ≥ ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑÿ≤ŸÖŸÜŸäÿ©. ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ™Ÿàÿßÿ±ŸäÿÆ.');
                        return;
                    }
                    
                    // ÿ™ŸÇÿ≥ŸäŸÖ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿßŸÑÿ¥Ÿáÿ±Ÿäÿ©
                    if (shouldSplitMonthlyLeave) {
                        // 1. ÿ•ŸÜÿ¥ÿßÿ° ÿ•ÿ¨ÿßÿ≤ÿ© ÿ¥Ÿáÿ±Ÿäÿ© ŸÖŸÜ ÿßŸÑÿ±ÿµŸäÿØ
                        const paidLeaveData = {
                            employeeId: employeeId,
                            type: 'monthly',
                            originalType: 'monthly',
                            convertedFromMonthly: false,
                            calculateDeduction: false,
                            salaryAtLeaveDate: null,
                            salaryCurrencyAtLeave: null,
                            startDate: startDate,
                            endDate: paidEndDate,
                            hours: null,
                            status: status,
                            notes: notes + ' (ÿ¨ÿ≤ÿ° ŸÖŸÜ ÿ•ÿ¨ÿßÿ≤ÿ© ŸÖŸÇÿ≥ŸÖÿ© - ŸÖŸÜ ÿßŸÑÿ±ÿµŸäÿØ)',
                            createdAt: window.firestore.serverTimestamp(),
                            createdBy: currentUser?.uid || 'system'
                        };
                        
                        // 2. ÿ•ŸÜÿ¥ÿßÿ° ÿ•ÿ¨ÿßÿ≤ÿ© ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ® ŸÑŸÑÿ®ÿßŸÇŸä
                        const calculateDeduction = document.getElementById('leaveCalculateDeduction')?.checked ?? true;
                        let salaryAtLeaveDate = null;
                        let salaryCurrencyAtLeave = null;
                        if (calculateDeduction && employee && employee.currentSalary) {
                            salaryAtLeaveDate = employee.currentSalary;
                            salaryCurrencyAtLeave = employee.currentSalaryCurrency || 'IQD';
                        }
                        
                        const unpaidLeaveData = {
                            employeeId: employeeId,
                            type: 'unpaid',
                            originalType: 'monthly',
                            convertedFromMonthly: true,
                            calculateDeduction: calculateDeduction,
                            salaryAtLeaveDate: salaryAtLeaveDate,
                            salaryCurrencyAtLeave: salaryCurrencyAtLeave,
                            startDate: unpaidStartDate,
                            endDate: endDate,
                            hours: null,
                            status: status,
                            notes: notes + ' (ÿ¨ÿ≤ÿ° ŸÖŸÜ ÿ•ÿ¨ÿßÿ≤ÿ© ŸÖŸÇÿ≥ŸÖÿ© - ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ®)',
                            createdAt: window.firestore.serverTimestamp(),
                            createdBy: currentUser?.uid || 'system'
                        };
                        
                        // ÿ≠ŸÅÿ∏ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ™ŸäŸÜ
                        await window.firestore.addDoc(
                            window.firestore.collection(window.db, 'leaves'),
                            paidLeaveData
                        );
                        
                        await window.firestore.addDoc(
                            window.firestore.collection(window.db, 'leaves'),
                            unpaidLeaveData
                        );
                        
                        alert(`‚úÖ ÿ™ŸÖ ÿ™ŸÇÿ≥ŸäŸÖ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿ®ŸÜÿ¨ÿßÿ≠!\n‚Ä¢ ÿ•ÿ¨ÿßÿ≤ÿ© ÿ¥Ÿáÿ±Ÿäÿ©: ${paidDays} ŸäŸàŸÖ (ŸÖŸÜ ÿßŸÑÿ±ÿµŸäÿØ)\n‚Ä¢ ÿ•ÿ¨ÿßÿ≤ÿ© ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ®: ${unpaidDays} ŸäŸàŸÖ`);
                    }
                    
                    // ÿ™ŸÇÿ≥ŸäŸÖ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿßŸÑÿ≤ŸÖŸÜŸäÿ©
                    else if (shouldSplitLeave) {
                        // 1. ÿ•ŸÜÿ¥ÿßÿ° ÿ•ÿ¨ÿßÿ≤ÿ© ÿ≤ŸÖŸÜŸäÿ© ŸÖŸÜ ÿßŸÑÿ±ÿµŸäÿØ
                        const paidLeaveData = {
                            employeeId: employeeId,
                            type: 'hourly',
                            originalType: 'hourly',
                            convertedFromMonthly: false,
                            calculateDeduction: false,
                            salaryAtLeaveDate: null,
                            salaryCurrencyAtLeave: null,
                            startDate: startDate,
                            endDate: null,
                            hours: paidHours,
                            status: status,
                            notes: notes + ' (ÿ¨ÿ≤ÿ° ŸÖŸÜ ÿ•ÿ¨ÿßÿ≤ÿ© ŸÖŸÇÿ≥ŸÖÿ© - ŸÖŸÜ ÿßŸÑÿ±ÿµŸäÿØ)',
                            createdAt: window.firestore.serverTimestamp(),
                            createdBy: currentUser?.uid || 'system'
                        };
                        
                        // 2. ÿ•ŸÜÿ¥ÿßÿ° ÿ•ÿ¨ÿßÿ≤ÿ© ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ® ŸÑŸÑÿ®ÿßŸÇŸä
                        const calculateDeduction = document.getElementById('leaveCalculateDeduction')?.checked ?? true;
                        let salaryAtLeaveDate = null;
                        let salaryCurrencyAtLeave = null;
                        if (calculateDeduction && employee && employee.currentSalary) {
                            salaryAtLeaveDate = employee.currentSalary;
                            salaryCurrencyAtLeave = employee.currentSalaryCurrency || 'IQD';
                        }
                        
                        const unpaidLeaveData = {
                            employeeId: employeeId,
                            type: 'unpaid',
                            originalType: 'hourly',
                            convertedFromMonthly: true,
                            calculateDeduction: calculateDeduction,
                            salaryAtLeaveDate: salaryAtLeaveDate,
                            salaryCurrencyAtLeave: salaryCurrencyAtLeave,
                            startDate: startDate,
                            endDate: null,
                            hours: unpaidHours,
                            status: status,
                            notes: notes + ' (ÿ¨ÿ≤ÿ° ŸÖŸÜ ÿ•ÿ¨ÿßÿ≤ÿ© ŸÖŸÇÿ≥ŸÖÿ© - ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ®)',
                            createdAt: window.firestore.serverTimestamp(),
                            createdBy: currentUser?.uid || 'system'
                        };
                        
                        // ÿ≠ŸÅÿ∏ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ™ŸäŸÜ
                        await window.firestore.addDoc(
                            window.firestore.collection(window.db, 'leaves'),
                            paidLeaveData
                        );
                        
                        await window.firestore.addDoc(
                            window.firestore.collection(window.db, 'leaves'),
                            unpaidLeaveData
                        );
                        
                        alert(`‚úÖ ÿ™ŸÖ ÿ™ŸÇÿ≥ŸäŸÖ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿ®ŸÜÿ¨ÿßÿ≠!\n‚Ä¢ ÿ•ÿ¨ÿßÿ≤ÿ© ÿ≤ŸÖŸÜŸäÿ©: ${paidHours.toFixed(1)} ÿ≥ÿßÿπÿ© (ŸÖŸÜ ÿßŸÑÿ±ÿµŸäÿØ)\n‚Ä¢ ÿ•ÿ¨ÿßÿ≤ÿ© ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ®: ${unpaidHours.toFixed(1)} ÿ≥ÿßÿπÿ©`);
                    }
                    
                    hideAddLeaveForm();
                    await loadLeaves();
                    return; // ÿ•ŸÜŸáÿßÿ° ÿßŸÑÿØÿßŸÑÿ© ÿ®ÿπÿØ ÿ≠ŸÅÿ∏ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ™ŸäŸÜ ÿßŸÑŸÖŸÇÿ≥ŸÖÿ™ŸäŸÜ
                }
                
                // ÿßŸÑÿ≠ÿßŸÑÿ© ÿßŸÑÿπÿßÿØŸäÿ©: ÿ•ÿ¨ÿßÿ≤ÿ© Ÿàÿßÿ≠ÿØÿ© (ÿ∫Ÿäÿ± ŸÖŸÇÿ≥ŸÖÿ©)
                // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿπÿØŸÖ ÿ™ŸÉÿ±ÿßÿ± ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ŸÑŸÜŸÅÿ≥ ÿßŸÑŸÖŸàÿ∏ŸÅ ŸÅŸä ŸÜŸÅÿ≥ ÿßŸÑŸÅÿ™ÿ±ÿ©
                const hasOverlap = checkLeaveOverlap(employeeId, startDate, endDate, type, null);
                if (hasOverlap) {
                    alert('‚ö†Ô∏è ŸäŸàÿ¨ÿØ ÿ•ÿ¨ÿßÿ≤ÿ© ÿ£ÿÆÿ±Ÿâ ŸÑŸÑŸÖŸàÿ∏ŸÅ ŸÅŸä ŸÜŸÅÿ≥ ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑÿ≤ŸÖŸÜŸäÿ©. ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ™Ÿàÿßÿ±ŸäÿÆ.');
                    return;
                }
                
                // ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÜŸàÿπ ÿßŸÑÿ£ÿµŸÑŸä ŸÑŸÑÿ•ÿ¨ÿßÿ≤ÿ© (ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿ®ÿπÿØ ÿ£Ÿä ÿ™ÿ≠ŸàŸäŸÑ)
                // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ originalType ŸÖŸÜ attribute ÿ•ÿ∞ÿß ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´Ÿá
                const finalOriginalType = leaveTypeSelect.getAttribute('data-original-type') || originalType;
                
                // ÿ™ÿ≠ÿØŸäÿØ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ÿ≠ŸàŸäŸÑ: ÿ¥Ÿáÿ±Ÿäÿ©‚Üíÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ®ÿå ÿ£Ÿà ÿ≤ŸÖŸÜŸäÿ© ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ® (isUnpaidHourly)
                const isUnpaidHourly = leaveTypeSelect.getAttribute('data-is-unpaid-hourly') === 'true';
                const convertedFromMonthly = (finalOriginalType === 'monthly' && type === 'unpaid') || (finalOriginalType === 'hourly' && (type === 'unpaid' || isUnpaidHourly));
                
                // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµÿ≠ÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÇÿ®ŸÑ ÿßŸÑÿ≠ŸÅÿ∏
                if (!finalOriginalType) {
                    console.error('ÿÆÿ∑ÿ£: ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÜŸàÿπ ÿßŸÑÿ£ÿµŸÑŸä ŸÑŸÑÿ•ÿ¨ÿßÿ≤ÿ©');
                    alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™. ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.');
                    return;
                }
                
                // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ŸÇŸäŸÖÿ© ÿÆŸäÿßÿ± ÿßŸÑÿÆÿµŸÖ (ŸÅŸÇÿ∑ ŸÑŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑŸÖÿ≠ŸàŸÑÿ© ÿ•ŸÑŸâ ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ®)
                const calculateDeduction = type === 'unpaid' && convertedFromMonthly 
                    ? document.getElementById('leaveCalculateDeduction')?.checked ?? true 
                    : true; // ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä: true ŸÑŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ® ÿßŸÑŸÖÿ®ÿßÿ¥ÿ±ÿ©
                
                // ÿ≠ŸÅÿ∏ ÿßŸÑÿ±ÿßÿ™ÿ® ÿßŸÑÿ≠ÿßŸÑŸä ŸàÿßŸÑÿπŸÖŸÑÿ© ÿπŸÜÿØ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© (ŸÑŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÅŸä ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿÆÿµŸÖ ŸÑÿßÿ≠ŸÇÿßŸã)
                let salaryAtLeaveDate = null;
                let salaryCurrencyAtLeave = null;
                if (type === 'unpaid' && calculateDeduction) {
                    if (employee && employee.currentSalary) {
                        salaryAtLeaveDate = employee.currentSalary;
                        salaryCurrencyAtLeave = employee.currentSalaryCurrency || 'IQD';
                    }
                }
                
                // ÿ™ÿ≠ÿØŸäÿØ ŸÜŸàÿπ ÿßŸÑŸÖŸáŸÖÿ© ŸàÿπÿØÿØ ÿßŸÑÿ≥ÿßÿπÿßÿ™ ŸÑŸÖŸáŸÖÿ© ÿßŸÑÿπŸÖŸÑ
                let missionType = null;
                let missionHours = null;
                if (type === 'work-mission') {
                    missionType = document.getElementById('leaveMissionType')?.value || null;
                    if (missionType === 'hourly') {
                        missionHours = parseFloat(document.getElementById('leaveMissionHours')?.value || 0);
                    }
                }
                
                const leaveData = {
                    employeeId: employeeId,
                    type: type,
                    originalType: finalOriginalType, // ÿßŸÑŸÜŸàÿπ ÿßŸÑÿ£ÿµŸÑŸä ŸÇÿ®ŸÑ ÿßŸÑÿ™ÿ≠ŸàŸäŸÑ (ŸÖÿ≠ÿØÿ´ ÿ®ÿπÿØ ÿßŸÑÿ™ÿ≠ŸàŸäŸÑ)
                    isUnpaidHourly: (type === 'hourly' && isUnpaidHourly) || false, // ÿ•ÿ¨ÿßÿ≤ÿ© ÿ≤ŸÖŸÜŸäÿ© ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ® (ÿ±ÿµŸäÿØ ŸÖŸÜÿ™ŸáŸç)
                    convertedFromMonthly: convertedFromMonthly, // ŸáŸÑ ÿ™ŸÖ ÿ™ÿ≠ŸàŸäŸÑŸáÿß ŸÖŸÜ ÿ¥Ÿáÿ±Ÿäÿ© ÿ£Ÿà ÿ≤ŸÖŸÜŸäÿ©ÿü
                    calculateDeduction: calculateDeduction, // ŸáŸÑ Ÿäÿ™ŸÖ ÿßÿ≠ÿ™ÿ≥ÿßÿ® ÿÆÿµŸÖ ŸÖÿßŸÑŸäÿü
                    salaryAtLeaveDate: salaryAtLeaveDate, // ÿßŸÑÿ±ÿßÿ™ÿ® ÿßŸÑÿ≠ÿßŸÑŸä ÿπŸÜÿØ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ©
                    salaryCurrencyAtLeave: salaryCurrencyAtLeave, // ÿßŸÑÿπŸÖŸÑÿ© ÿπŸÜÿØ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ©
                    regionId: (type === 'work-mission') ? (document.getElementById('leaveRegionId')?.value || null) : null, // ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ŸÑŸÖŸáŸÖÿ© ÿßŸÑÿπŸÖŸÑ
                    missionType: missionType, // ŸÜŸàÿπ ÿßŸÑŸÖŸáŸÖÿ© (ÿ≤ŸÖŸÜŸäÿ© ÿ£Ÿà ŸäŸàŸÖ ŸÉÿßŸÖŸÑ)
                    missionHours: missionHours, // ÿπÿØÿØ ÿ≥ÿßÿπÿßÿ™ ÿßŸÑŸÖŸáŸÖÿ© ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿ≤ŸÖŸÜŸäÿ©
                    startDate: startDate,
                    endDate: (type === 'hourly' || (type === 'work-mission' && missionType === 'hourly')) ? null : (endDate || null), // ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ© ŸàŸÖŸáÿßŸÖ ÿßŸÑÿπŸÖŸÑ ÿßŸÑÿ≤ŸÖŸÜŸäÿ© ŸÑÿß ÿ™ÿ≠ÿ™ÿßÿ¨ endDate
                    hours: type === 'hourly' ? parseFloat(hours) : null,
                    timeRanges: timeRanges, // ÿßŸÑŸÅÿ™ÿ±ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ© ÿßŸÑŸÖÿ™ÿπÿØÿØÿ© ŸÑŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ© ÿßŸÑŸÖÿ™ŸÇÿ∑ÿπÿ©
                    status: status,
                    notes: notes,
                    createdAt: window.firestore.serverTimestamp(),
                    createdBy: currentUser?.uid || 'system'
                };
                
                // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÑÿ™ÿ≠ŸÇŸÇ (ŸÅŸä Ÿàÿ∂ÿπ ÿßŸÑÿ™ÿ∑ŸàŸäÿ±)
                console.log('üíæ ÿ≠ŸÅÿ∏ ÿ•ÿ¨ÿßÿ≤ÿ© ÿ¨ÿØŸäÿØÿ©:', {
                    type: leaveData.type,
                    originalType: leaveData.originalType,
                    convertedFromMonthly: leaveData.convertedFromMonthly,
                    endDate: leaveData.endDate
                });

                await window.firestore.addDoc(
                    window.firestore.collection(window.db, 'leaves'),
                    leaveData
                );

                alert('ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿ®ŸÜÿ¨ÿßÿ≠!');
                hideAddLeaveForm();
                await loadLeaves();
            } catch (error) {
                alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ©: ' + error.message);
                console.error(error);
            }
        }

        async function editLeave(id) {
            // #region agent log
            const editSessionId = 'debug-session-' + Date.now();
            const editRunId = 'run1';
            const editingLeaveIdBefore = editingLeaveId;
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßÿ≥ÿ™ÿØÿπÿßÿ° logging ÿßŸÑÿÆÿßÿ±ÿ¨Ÿä
            console.log('üîç [DEBUG-LEAVE-EDIT] ÿ®ÿØÿ° editLeave(), id:', id, 'editingLeaveId ŸÇÿ®ŸÑ:', editingLeaveIdBefore);
            // #endregion
            
            editingLeaveId = id;
            
            // #region agent log
            // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßÿ≥ÿ™ÿØÿπÿßÿ° logging ÿßŸÑÿÆÿßÿ±ÿ¨Ÿä
            console.log('üîç [DEBUG-LEAVE-EDIT] ÿ®ÿπÿØ ÿ™ÿπŸäŸäŸÜ editingLeaveId:', editingLeaveId);
            // #endregion
            
            const leave = leavesData.find(l => l.id === id);
            if (!leave) {
                alert('ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©');
                editingLeaveId = null; // ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ÿπŸäŸäŸÜ
                return;
            }

            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ŸÖŸàÿßŸÅŸÇ ÿπŸÑŸäŸáÿß
            if (leave.status === 'approved') {
                const password = prompt('‚ö†Ô∏è Ÿáÿ∞Ÿá ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ŸÖŸàÿßŸÅŸÇ ÿπŸÑŸäŸáÿß.\n\nÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ŸÑŸÑÿ™ÿπÿØŸäŸÑ:');
                if (password === null) {
                    // ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ£ŸÑÿ∫Ÿâ ÿßŸÑÿπŸÖŸÑŸäÿ©
                    editingLeaveId = null;
                    // #region agent log
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßÿ≥ÿ™ÿØÿπÿßÿ° logging ÿßŸÑÿÆÿßÿ±ÿ¨Ÿä
                    console.log('üîç [DEBUG-LEAVE-EDIT] ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿπŸÖŸÑŸäÿ© - editingLeaveId:', editingLeaveId);
                    // #endregion
                    return;
                }
                if (password !== LEAVE_EDIT_PASSWORD) {
                    alert('‚ùå ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©. ŸÑÿß ŸäŸÖŸÉŸÜ ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿßŸÑŸÖŸàÿßŸÅŸÇ ÿπŸÑŸäŸáÿß.');
                    editingLeaveId = null;
                    // #region agent log
                    // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßÿ≥ÿ™ÿØÿπÿßÿ° logging ÿßŸÑÿÆÿßÿ±ÿ¨Ÿä
                    console.log('üîç [DEBUG-LEAVE-EDIT] ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ© - editingLeaveId:', editingLeaveId);
                    // #endregion
                    return;
                }
            }

            const modal = document.getElementById('leaveModal');
            if (!modal) return;

            // ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ™ÿ±ÿ¨ŸÖÿßÿ™ ŸÇÿ®ŸÑ ŸÅÿ™ÿ≠ ÿßŸÑŸÜÿßŸÅÿ∞ÿ©
            applyTranslations();
            
            const submitBtn = document.getElementById('leaveSubmitBtn');
            if (submitBtn) {
                submitBtn.setAttribute('onclick', 'updateLeave()');
                // #region agent log
                const onclickAfter = submitBtn.getAttribute('onclick');
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßÿ≥ÿ™ÿØÿπÿßÿ° logging ÿßŸÑÿÆÿßÿ±ÿ¨Ÿä
                console.log('üîç [DEBUG-LEAVE-EDIT] editLeave() - onclick ÿ®ÿπÿØ ÿßŸÑÿ™ÿπŸäŸäŸÜ:', onclickAfter, 'editingLeaveId:', editingLeaveId);
                // #endregion
            } else {
                // #region agent log
                // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßÿ≥ÿ™ÿØÿπÿßÿ° logging ÿßŸÑÿÆÿßÿ±ÿ¨Ÿä
                console.log('üîç [DEBUG-LEAVE-EDIT] ÿßŸÑÿ≤ÿ± leaveSubmitBtn ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ!');
                // #endregion
            }

            // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™ŸÉŸÜ ŸÖÿ≠ŸÖŸÑÿ© ÿ®ÿßŸÑŸÅÿπŸÑ
            if (!employeesData || employeesData.length === 0) {
                console.log('ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ...');
                await loadEmployees();
            }

            // ÿ™ÿ≠ÿØŸäÿ´ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ
            const employeeInput = document.getElementById('leaveEmployeeId');
            const employeeDatalist = document.getElementById('leaveEmployeeList');
            const employeeHiddenInput = document.getElementById('leaveEmployeeIdHidden');
            
            if (employeeInput && employeeDatalist) {
                // ŸÖÿ≥ÿ≠ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ≥ÿßÿ®ŸÇÿ©
                employeeDatalist.innerHTML = '';
                employeeInput.value = '';
                if (employeeHiddenInput) employeeHiddenInput.value = '';
                
                // #region agent log
                console.log('üîç [DEBUG-LEAVE-EDIT] ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ - leave.employeeId:', leave.employeeId, 'ŸÜŸàÿπ:', typeof leave.employeeId);
                console.log('üîç [DEBUG-LEAVE-EDIT] ÿπÿØÿØ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ:', employeesData ? employeesData.length : 0);
                // #endregion
                
                if (employeesData && employeesData.length > 0) {
                    // ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ ÿ≠ÿ≥ÿ® ÿßŸÑÿßÿ≥ŸÖ
                    const sortedEmployees = [...employeesData].sort((a, b) => {
                        const nameA = (a.name || '').trim().toLowerCase();
                        const nameB = (b.name || '').trim().toLowerCase();
                        return nameA.localeCompare(nameB, 'ar');
                    });
                    
                    let foundEmployee = false;
                    sortedEmployees.forEach(emp => {
                        const option = document.createElement('option');
                        const displayText = `${emp.name || 'ÿ®ÿØŸàŸÜ ÿßÿ≥ŸÖ'}${emp.employeeNumber ? ' (' + emp.employeeNumber + ')' : ''}`;
                        option.value = displayText;
                        option.setAttribute('data-employee-id', emp.id);
                        
                        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ™ÿ∑ÿßÿ®ŸÇ
                        const empIdMatch = String(emp.id) === String(leave.employeeId);
                        if (empIdMatch) {
                            foundEmployee = true;
                            employeeInput.value = displayText;
                            if (employeeHiddenInput) employeeHiddenInput.value = emp.id;
                            // #region agent log
                            console.log('üîç [DEBUG-LEAVE-EDIT] ÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿßŸÑŸÖŸàÿ∏ŸÅ ÿßŸÑŸÖÿ∑ÿßÿ®ŸÇ:', emp.name, 'emp.id:', emp.id, 'leave.employeeId:', leave.employeeId);
                            // #endregion
                        }
                        employeeDatalist.appendChild(option);
                    });
                    
                    // #region agent log
                    if (!foundEmployee && leave.employeeId) {
                        console.warn('‚ö†Ô∏è [DEBUG-LEAVE-EDIT] ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿßŸÑŸÖŸàÿ∏ŸÅ ÿßŸÑŸÖÿ∑ÿßÿ®ŸÇ! leave.employeeId:', leave.employeeId, 'ŸÜŸàÿπ:', typeof leave.employeeId);
                        console.log('üîç [DEBUG-LEAVE-EDIT] ŸÇÿßÿ¶ŸÖÿ© IDs ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ:', employeesData.map(e => ({id: e.id, type: typeof e.id, name: e.name})));
                    }
                    // #endregion
                }
                
                // ÿ•ÿ∂ÿßŸÅÿ© event listener ŸÑÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ© ÿπŸÜÿØ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÖŸàÿ∏ŸÅ
                employeeInput.addEventListener('input', function() {
                    const inputValue = this.value.trim();
                    if (!inputValue) {
                        if (employeeHiddenInput) employeeHiddenInput.value = '';
                        const balanceInfo = document.getElementById('leaveBalanceInfo');
                        if (balanceInfo) balanceInfo.style.display = 'none';
                        return;
                    }
                    
                    // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÖŸàÿ∏ŸÅ ÿßŸÑŸÖÿ∑ÿßÿ®ŸÇ
                    const matchingOption = Array.from(employeeDatalist.options).find(opt => {
                        return opt.value === inputValue || opt.value.includes(inputValue);
                    });
                    
                    if (matchingOption) {
                        const employeeId = matchingOption.getAttribute('data-employee-id');
                        if (employeeHiddenInput) employeeHiddenInput.value = employeeId;
                        if (employeeId) {
                            calculateLeaveBalance(employeeId);
                        }
                    } else {
                        // ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿ¨ŸÖŸäÿπ ÿßŸÑÿÆŸäÿßÿ±ÿßÿ™ ŸÑŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ŸÖÿ∑ÿßÿ®ŸÇÿ© ÿ¨ÿ≤ÿ¶Ÿäÿ©
                        const foundOption = Array.from(employeeDatalist.options).find(opt => {
                            return opt.value.toLowerCase().includes(inputValue.toLowerCase());
                        });
                        
                        if (foundOption) {
                            const employeeId = foundOption.getAttribute('data-employee-id');
                            if (employeeHiddenInput) employeeHiddenInput.value = employeeId;
                            if (employeeId) {
                                calculateLeaveBalance(employeeId);
                            }
                        } else {
                            if (employeeHiddenInput) employeeHiddenInput.value = '';
                            const balanceInfo = document.getElementById('leaveBalanceInfo');
                            if (balanceInfo) balanceInfo.style.display = 'none';
                        }
                    }
                });
                
                // ÿ•ÿ∂ÿßŸÅÿ© event listener ÿπŸÜÿØ ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸÜ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸÜÿ≥ÿØŸÑÿ©
                employeeInput.addEventListener('change', function() {
                    const inputValue = this.value.trim();
                    if (!inputValue) {
                        if (employeeHiddenInput) employeeHiddenInput.value = '';
                        const balanceInfo = document.getElementById('leaveBalanceInfo');
                        if (balanceInfo) balanceInfo.style.display = 'none';
                        return;
                    }
                    
                    const matchingOption = Array.from(employeeDatalist.options).find(opt => opt.value === inputValue);
                    if (matchingOption) {
                        const employeeId = matchingOption.getAttribute('data-employee-id');
                        if (employeeHiddenInput) employeeHiddenInput.value = employeeId;
                        if (employeeId) {
                            calculateLeaveBalance(employeeId);
                        }
                    } else {
                        // ÿ•ÿ∞ÿß ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ŸÖÿ∑ÿßÿ®ŸÇÿ© ÿØŸÇŸäŸÇÿ©ÿå ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ŸÖÿ∑ÿßÿ®ŸÇÿ© ÿ¨ÿ≤ÿ¶Ÿäÿ©
                        const foundOption = Array.from(employeeDatalist.options).find(opt => {
                            return opt.value.toLowerCase().includes(inputValue.toLowerCase()) || 
                                   inputValue.toLowerCase().includes(opt.value.toLowerCase());
                        });
                        
                        if (foundOption) {
                            const employeeId = foundOption.getAttribute('data-employee-id');
                            if (employeeHiddenInput) employeeHiddenInput.value = employeeId;
                            this.value = foundOption.value; // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÜÿµ ÿßŸÑŸÖÿπÿ±Ÿàÿ∂
                            if (employeeId) {
                                calculateLeaveBalance(employeeId);
                            }
                        } else {
                            // ÿ•ÿ∞ÿß ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ£Ÿä ŸÖÿ∑ÿßÿ®ŸÇÿ©ÿå ŸÖÿ≥ÿ≠ ÿßŸÑŸÇŸäŸÖÿ©
                            if (employeeHiddenInput) employeeHiddenInput.value = '';
                            this.value = '';
                            const balanceInfo = document.getElementById('leaveBalanceInfo');
                            if (balanceInfo) balanceInfo.style.display = 'none';
                            alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸàÿ∏ŸÅ ŸÖŸÜ ÿßŸÑŸÇÿßÿ¶ŸÖÿ©');
                        }
                    }
                });
                
                // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ© ŸÑŸÑŸÖŸàÿ∏ŸÅ ÿßŸÑŸÖÿ≠ÿØÿØ
                if (leave.employeeId) {
                    calculateLeaveBalance(leave.employeeId);
                }
            }
            
            // ÿ™ÿ≠ÿØŸäÿ´ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ
            await updateLeaveRegionSelect();

            // ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ŸÅŸä ÿßŸÑÿ≠ŸÇŸàŸÑ
            const leaveTypeSelect = document.getElementById('leaveType');
            if (leaveTypeSelect) {
                leaveTypeSelect.value = leave.type || '';
                // ÿ≠ŸÅÿ∏ ÿßŸÑŸÜŸàÿπ ÿßŸÑÿ£ÿµŸÑŸä ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÖŸàÿ¨ŸàÿØÿßŸã
                if (leave.originalType) {
                    leaveTypeSelect.setAttribute('data-original-type', leave.originalType);
                } else {
                    // ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸáŸÜÿßŸÉ ŸÜŸàÿπ ÿ£ÿµŸÑŸä ŸÖÿ≠ŸÅŸàÿ∏ÿå ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑŸÜŸàÿπ ÿßŸÑÿ≠ÿßŸÑŸä
                    leaveTypeSelect.setAttribute('data-original-type', leave.type || '');
                }
            }
            
            document.getElementById('leaveStartDate').value = leave.startDate || '';
            document.getElementById('leaveEndDate').value = leave.endDate || '';
            
            // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ≥ÿßÿπÿßÿ™ (ÿ≠ÿ™Ÿâ ŸÑŸà ŸÉÿßŸÜÿ™ null ÿ£Ÿà undefined)
            const hoursInput = document.getElementById('leaveHours');
            const hoursInputMethod = document.getElementById('leaveHoursInputMethod');
            if (hoursInput) {
                hoursInput.value = leave.hours !== null && leave.hours !== undefined ? leave.hours : '';
            }
            
            // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÅÿ™ÿ±ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ© ÿßŸÑŸÖÿ™ÿπÿØÿØÿ© ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ŸÖŸàÿ¨ŸàÿØÿ©
            if (leave.type === 'hourly' && leave.timeRanges && Array.isArray(leave.timeRanges) && leave.timeRanges.length > 0) {
                // ÿ™ÿπŸäŸäŸÜ ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿ•ÿØÿÆÿßŸÑ ÿ•ŸÑŸâ "ŸÅÿ™ÿ±ÿßÿ™ ŸÖÿ™ÿπÿØÿØÿ©"
                if (hoursInputMethod) {
                    hoursInputMethod.value = 'multiple-periods';
                    handleLeaveHoursMethodChange();
                }
                
                // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÅÿ™ÿ±ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ©
                const container = document.getElementById('leaveTimePeriodsContainer');
                if (container) {
                    container.innerHTML = ''; // ŸÖÿ≥ÿ≠ ÿßŸÑŸÅÿ™ÿ±ÿßÿ™ ÿßŸÑÿ≥ÿßÿ®ŸÇÿ©
                    leave.timeRanges.forEach(timeRange => {
                        addLeaveTimePeriod();
                        const periods = container.querySelectorAll('.leave-time-period');
                        const lastPeriod = periods[periods.length - 1];
                        if (lastPeriod) {
                            const startTimeInput = lastPeriod.querySelector('.period-start-time');
                            const endTimeInput = lastPeriod.querySelector('.period-end-time');
                            if (startTimeInput && endTimeInput) {
                                startTimeInput.value = timeRange.startTime || '';
                                endTimeInput.value = timeRange.endTime || '';
                            }
                        }
                    });
                    calculateTotalLeaveHoursFromPeriods();
                }
            } else if (leave.type === 'hourly' && leave.startTime && leave.endTime) {
                // ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ŸáŸÜÿßŸÉ ŸÅÿ™ÿ±ÿ© ÿ≤ŸÖŸÜŸäÿ© Ÿàÿßÿ≠ÿØÿ© (startTime Ÿà endTime ŸÇÿØŸäŸÖŸäŸÜ)
                if (hoursInputMethod) {
                    hoursInputMethod.value = 'time-range';
                    handleLeaveHoursMethodChange();
                }
                const startTimeInput = document.getElementById('leaveStartTime');
                const endTimeInput = document.getElementById('leaveEndTime');
                if (startTimeInput) startTimeInput.value = leave.startTime;
                if (endTimeInput) endTimeInput.value = leave.endTime;
                calculateLeaveHoursFromTime();
            }
            
            document.getElementById('leaveStatus').value = leave.status || 'pending';
            document.getElementById('leaveNotes').value = leave.notes || '';
            
            // #region agent log
            fetch('http://127.0.0.1:7242/ingest/92a107bc-3396-4b6c-a6d6-34a2cf7f1b41',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'Human Resources Management.html:9664',message:'editLeave() - ÿ®ÿπÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä ÿßŸÑÿ≠ŸÇŸàŸÑ',data:{id:id,editingLeaveId:editingLeaveId,leaveType:leave.type,leaveStartDate:leave.startDate,leaveEndDate:leave.endDate,leaveStatus:leave.status,originalType:leave.originalType},timestamp:Date.now(),sessionId:editSessionId,runId:editRunId,hypothesisId:'C'})}).catch(()=>{});
            console.log('üîç [DEBUG-LEAVE-EDIT] ÿ®ÿπÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä ÿßŸÑÿ≠ŸÇŸàŸÑ:', {
                id,
                editingLeaveId,
                type: leave.type,
                startDate: leave.startDate,
                endDate: leave.endDate,
                status: leave.status
            });
            // #endregion

            // ÿ•ÿ∏Ÿáÿßÿ±/ÿ•ÿÆŸÅÿßÿ° ÿ≠ŸÇŸÑ ÿßŸÑÿ≥ÿßÿπÿßÿ™ ŸàÿÆŸäÿßÿ± ÿßŸÑÿÆÿµŸÖ ÿ≠ÿ≥ÿ® ŸÜŸàÿπ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ©
            const leaveHoursGroup = document.getElementById('leaveHoursGroup');
            const leaveDeductionGroup = document.getElementById('leaveDeductionGroup');
            const leaveRegionGroup = document.getElementById('leaveRegionGroup');
            if (leave.type === 'hourly') {
                if (leaveHoursGroup) leaveHoursGroup.style.display = 'block';
                if (leaveDeductionGroup) leaveDeductionGroup.style.display = 'none';
                if (leaveRegionGroup) leaveRegionGroup.style.display = 'none';
            } else if (leave.type === 'unpaid') {
                if (leaveHoursGroup) leaveHoursGroup.style.display = 'none';
                if (leaveRegionGroup) leaveRegionGroup.style.display = 'none';
                // ÿ•ÿ∏Ÿáÿßÿ± ÿÆŸäÿßÿ± ÿßŸÑÿÆÿµŸÖ ŸÅŸÇÿ∑ ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ŸÖÿ≠ŸàŸÑÿ© ŸÖŸÜ ÿ¥Ÿáÿ±Ÿäÿ© ÿ£Ÿà ÿ≤ŸÖŸÜŸäÿ©
                if (leaveDeductionGroup && leave.convertedFromMonthly) {
                    leaveDeductionGroup.style.display = 'block';
                    const calculateDeductionCheckbox = document.getElementById('leaveCalculateDeduction');
                    if (calculateDeductionCheckbox) {
                        calculateDeductionCheckbox.checked = leave.calculateDeduction !== false; // ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä: true
                    }
                } else {
                    if (leaveDeductionGroup) leaveDeductionGroup.style.display = 'none';
                }
            } else if (leave.type === 'work-mission') {
                if (leaveHoursGroup) leaveHoursGroup.style.display = 'none';
                if (leaveDeductionGroup) leaveDeductionGroup.style.display = 'none';
                if (leaveRegionGroup) leaveRegionGroup.style.display = 'block';
                
                // ÿ™ÿ≠ŸÖŸäŸÑ ŸÜŸàÿπ ÿßŸÑŸÖŸáŸÖÿ© ŸàÿπÿØÿØ ÿßŸÑÿ≥ÿßÿπÿßÿ™
                const leaveMissionTypeSelect = document.getElementById('leaveMissionType');
                const leaveMissionHoursInput = document.getElementById('leaveMissionHours');
                const leaveMissionTypeGroup = document.getElementById('leaveMissionTypeGroup');
                const leaveMissionHoursGroup = document.getElementById('leaveMissionHoursGroup');
                
                if (leaveMissionTypeSelect) {
                    leaveMissionTypeSelect.value = leave.missionType || '';
                    handleMissionTypeChange(); // ÿßÿ≥ÿ™ÿØÿπÿßÿ° ÿßŸÑÿØÿßŸÑÿ© ŸÑÿ•ÿ∏Ÿáÿßÿ±/ÿ•ÿÆŸÅÿßÿ° ÿßŸÑÿ≠ŸÇŸàŸÑ
                }
                if (leaveMissionHoursInput && leave.missionHours) {
                    leaveMissionHoursInput.value = leave.missionHours;
                }
            } else {
                if (leaveHoursGroup) leaveHoursGroup.style.display = 'none';
                if (leaveDeductionGroup) leaveDeductionGroup.style.display = 'none';
                if (leaveRegionGroup) leaveRegionGroup.style.display = 'none';
            }
            
            // ÿßÿ≥ÿ™ÿØÿπÿßÿ° handleLeaveTypeChange ŸÑŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ•ÿ∏Ÿáÿßÿ±/ÿ•ÿÆŸÅÿßÿ° ÿßŸÑÿ≠ŸÇŸàŸÑ ÿ®ÿ¥ŸÉŸÑ ÿµÿ≠Ÿäÿ≠
            handleLeaveTypeChange();
            
            // ÿ•ÿπÿßÿØÿ© ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ© ÿπŸÜÿØ ÿßŸÑÿ™ÿπÿØŸäŸÑ
            if (leave.employeeId) {
                calculateLeaveBalance(leave.employeeId);
            }

            // #region agent log
            const modalActive = modal.classList.contains('active');
            const finalOnclick = submitBtn ? submitBtn.getAttribute('onclick') : 'ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ';
            fetch('http://127.0.0.1:7242/ingest/92a107bc-3396-4b6c-a6d6-34a2cf7f1b41',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'Human Resources Management.html:9689',message:'editLeave() - ŸÇÿ®ŸÑ ŸÅÿ™ÿ≠ ÿßŸÑŸÜÿßŸÅÿ∞ÿ©',data:{id:id,editingLeaveId:editingLeaveId,modalActive:modalActive,finalOnclick:finalOnclick},timestamp:Date.now(),sessionId:editSessionId,runId:editRunId,hypothesisId:'G'})}).catch(()=>{});
            console.log('üîç [DEBUG-LEAVE-EDIT] ŸÇÿ®ŸÑ ŸÅÿ™ÿ≠ ÿßŸÑŸÜÿßŸÅÿ∞ÿ© - editingLeaveId:', editingLeaveId, 'onclick:', finalOnclick);
            // #endregion

            modal.classList.add('active');
            
            // #region agent log
            fetch('http://127.0.0.1:7242/ingest/92a107bc-3396-4b6c-a6d6-34a2cf7f1b41',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'Human Resources Management.html:9690',message:'editLeave() - ÿ®ÿπÿØ ŸÅÿ™ÿ≠ ÿßŸÑŸÜÿßŸÅÿ∞ÿ©',data:{id:id,editingLeaveId:editingLeaveId,modalActiveNow:modal.classList.contains('active')},timestamp:Date.now(),sessionId:editSessionId,runId:editRunId,hypothesisId:'G'})}).catch(()=>{});
            console.log('üîç [DEBUG-LEAVE-EDIT] ÿ®ÿπÿØ ŸÅÿ™ÿ≠ ÿßŸÑŸÜÿßŸÅÿ∞ÿ© - editingLeaveId:', editingLeaveId);
            // #endregion
        }

        async function updateLeave() {
            // #region agent log
            const sessionId = 'debug-session-' + Date.now();
            const runId = 'run1';
            fetch('http://127.0.0.1:7242/ingest/92a107bc-3396-4b6c-a6d6-34a2cf7f1b41',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'Human Resources Management.html:9578',message:'updateLeave() - ÿ®ÿØÿ° ÿßŸÑÿ™ÿ≠ÿØŸäÿ´',data:{editingLeaveId:editingLeaveId,leavesDataCount:leavesData.length},timestamp:Date.now(),sessionId:sessionId,runId:runId,hypothesisId:'A'})}).catch(()=>{});
            console.log('üîç [DEBUG-LEAVE-UPDATE] ÿ®ÿØÿ° updateLeave(), editingLeaveId:', editingLeaveId);
            // #endregion
            
            if (!editingLeaveId) {
                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/92a107bc-3396-4b6c-a6d6-34a2cf7f1b41',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'Human Resources Management.html:9580',message:'updateLeave() - editingLeaveId ŸÅÿßÿ±ÿ∫',data:{editingLeaveId:editingLeaveId},timestamp:Date.now(),sessionId:sessionId,runId:runId,hypothesisId:'A'})}).catch(()=>{});
                console.log('üîç [DEBUG-LEAVE-UPDATE] editingLeaveId ŸÅÿßÿ±ÿ∫ - ÿ•ŸäŸÇÿßŸÅ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´');
                // #endregion
                return;
            }

            if (!window.db || !window.firestore) {
                alert('Firebase ÿ∫Ÿäÿ± ŸÖŸáŸäÿ£');
                return;
            }

            // ŸÇÿ±ÿßÿ°ÿ© ID ÿßŸÑŸÖŸàÿ∏ŸÅ ŸÖŸÜ ÿßŸÑÿ≠ŸÇŸÑ ÿßŸÑŸÖÿÆŸÅŸä
            const employeeHiddenInput = document.getElementById('leaveEmployeeIdHidden');
            const employeeInput = document.getElementById('leaveEmployeeId');
            let employeeId = employeeHiddenInput ? employeeHiddenInput.value : '';
            
            // ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸáŸÜÿßŸÉ ID ŸÅŸä ÿßŸÑÿ≠ŸÇŸÑ ÿßŸÑŸÖÿÆŸÅŸäÿå ÿ≠ÿßŸàŸÑ ÿßŸÑÿ®ÿ≠ÿ´ ŸÖŸÜ ÿßŸÑŸÜÿµ ÿßŸÑŸÖÿØÿÆŸÑ
            if (!employeeId && employeeInput && employeeInput.value.trim()) {
                const datalist = document.getElementById('leaveEmployeeList');
                if (datalist) {
                    const matchingOption = Array.from(datalist.options).find(opt => opt.value === employeeInput.value.trim());
                    if (matchingOption) {
                        employeeId = matchingOption.getAttribute('data-employee-id');
                        if (employeeId && employeeHiddenInput) {
                            employeeHiddenInput.value = employeeId;
                        }
                    }
                }
            }
            
            if (!employeeId) {
                alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸàÿ∏ŸÅ ÿµÿ≠Ÿäÿ≠ ŸÖŸÜ ÿßŸÑŸÇÿßÿ¶ŸÖÿ©');
                return;
            }
            
            const leaveTypeSelect = document.getElementById('leaveType');
            const type = leaveTypeSelect ? leaveTypeSelect.value : '';
            const startDate = document.getElementById('leaveStartDate').value;
            const endDate = document.getElementById('leaveEndDate').value;
            const hoursInputMethod = document.getElementById('leaveHoursInputMethod')?.value;
            let hours = document.getElementById('leaveHours').value;
            let timeRanges = null; // ŸÖÿµŸÅŸàŸÅÿ© ÿßŸÑŸÅÿ™ÿ±ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ© ÿßŸÑŸÖÿ™ÿπÿØÿØÿ©
            
            // ÿ¨ŸÖÿπ ÿßŸÑŸÅÿ™ÿ±ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ© ÿßŸÑŸÖÿ™ÿπÿØÿØÿ© ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿßŸÑÿ∑ÿ±ŸäŸÇÿ© "multiple-periods"
            if (type === 'hourly' && hoursInputMethod === 'multiple-periods') {
                const container = document.getElementById('leaveTimePeriodsContainer');
                if (container) {
                    timeRanges = [];
                    const periods = container.querySelectorAll('.leave-time-period');
                    periods.forEach(period => {
                        const startTimeInput = period.querySelector('.period-start-time');
                        const endTimeInput = period.querySelector('.period-end-time');
                        if (startTimeInput && endTimeInput && startTimeInput.value && endTimeInput.value) {
                            timeRanges.push({
                                startTime: startTimeInput.value,
                                endTime: endTimeInput.value
                            });
                        }
                    });
                    // ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™ŸÉŸÜ ŸáŸÜÿßŸÉ ŸÅÿ™ÿ±ÿßÿ™ ÿµÿßŸÑÿ≠ÿ©ÿå ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ≥ÿßÿπÿßÿ™ ÿßŸÑŸÖÿ≠ÿ≥Ÿàÿ®ÿ©
                    if (timeRanges.length === 0) {
                        alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿ∂ÿßŸÅÿ© ŸÅÿ™ÿ±ÿ© ÿ≤ŸÖŸÜŸäÿ© Ÿàÿßÿ≠ÿØÿ© ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ');
                        return;
                    }
                }
            }
            
            const status = document.getElementById('leaveStatus').value || 'pending';
            const notes = document.getElementById('leaveNotes').value.trim();

            // #region agent log
            fetch('http://127.0.0.1:7242/ingest/92a107bc-3396-4b6c-a6d6-34a2cf7f1b41',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'Human Resources Management.html:9595',message:'updateLeave() - ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿØÿÆŸÑÿ©',data:{editingLeaveId:editingLeaveId,employeeId:employeeId,type:type,startDate:startDate,endDate:endDate,status:status},timestamp:Date.now(),sessionId:sessionId,runId:runId,hypothesisId:'A'})}).catch(()=>{});
            console.log('üîç [DEBUG-LEAVE-UPDATE] ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿØÿÆŸÑÿ©:', {editingLeaveId, employeeId, type, startDate, endDate, status});
            // #endregion

            if (!employeeId || !type || !startDate) {
                alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©');
                return;
            }

            if (type !== 'hourly' && type !== 'unpaid' && !endDate) {
                alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ°');
                return;
            }

            if (type === 'hourly' && !hours) {
                alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿπÿØÿØ ÿßŸÑÿ≥ÿßÿπÿßÿ™');
                return;
            }

            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ±ÿµŸäÿØ ÿπŸÜÿØ ÿ™ÿ∫ŸäŸäÿ± ŸÜŸàÿπ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ŸÖŸÜ "ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ®" ÿ•ŸÑŸâ "ÿ¥Ÿáÿ±Ÿäÿ©"
            if (type === 'monthly' && endDate) {
                const existingLeave = leavesData.find(l => l.id === editingLeaveId);
                // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÅŸÇÿ∑ ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ© "ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ®" ÿ£Ÿà ÿ•ÿ∞ÿß ÿ™ŸÖ ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸÜŸàÿπ
                if (!existingLeave || existingLeave.type !== 'monthly') {
                    const employee = employeesData.find(e => e.id === employeeId);
                    if (employee) {
                        const monthlyLeaveDays = employee.monthlyLeaveDays || 2.5;
                        const initialBalance = employee.initialLeaveBalance || 0;
                        const entryDate = employee.systemEntryDate || employee.hireDate;
                        
                        let totalMonthlyLeaves = 0;
                        if (entryDate) {
                            const systemEntryDate = new Date(entryDate);
                            systemEntryDate.setHours(0, 0, 0, 0);
                            const now = new Date();
                            now.setHours(0, 0, 0, 0);
                            
                            let monthsDiff = (now.getFullYear() - systemEntryDate.getFullYear()) * 12 + 
                                            (now.getMonth() - systemEntryDate.getMonth());
                            
                            if (now.getDate() < systemEntryDate.getDate()) {
                                monthsDiff -= 1;
                            }
                            
                            if (monthsDiff < 0) {
                                monthsDiff = 0;
                            }
                            
                            totalMonthlyLeaves = (monthsDiff * monthlyLeaveDays) + initialBalance;
                        } else {
                            totalMonthlyLeaves = initialBalance;
                        }
                        
                        // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖÿ© (ÿßÿ≥ÿ™ÿ´ŸÜÿßÿ° ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ© ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ŸÖŸàÿßŸÅŸÇ ÿπŸÑŸäŸáÿß)
                        let monthlyUsed = 0;
                        const monthlyLeaves = leavesData.filter(l => 
                            l.employeeId === employeeId && 
                            l.id !== editingLeaveId && // ÿßÿ≥ÿ™ÿ´ŸÜÿßÿ° ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©
                            l.status === 'approved' &&
                            (
                                l.type === 'monthly' ||
                                (l.type === 'unpaid' && l.convertedFromMonthly === true)
                            )
                        );
                        
                        monthlyLeaves.forEach(leave => {
                            if (leave.startDate && leave.endDate) {
                                const start = new Date(leave.startDate);
                                start.setHours(0, 0, 0, 0);
                                const end = new Date(leave.endDate);
                                end.setHours(0, 0, 0, 0);
                                
                                const diffTime = Math.abs(end - start);
                                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                                monthlyUsed += diffDays;
                            }
                        });
                        
                        const monthlyBalance = totalMonthlyLeaves - monthlyUsed;
                        
                        // ÿ≠ÿ≥ÿßÿ® ŸÖÿØÿ© ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©
                        const start = new Date(startDate);
                        const end = new Date(endDate);
                        const diffTime = Math.abs(end - start);
                        const requiredDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                        
                        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ±ÿµŸäÿØ
                        if (monthlyBalance <= 0) {
                            let errorMessage = '';
                            if (monthlyBalance < 0) {
                                errorMessage = `‚ö†Ô∏è ŸÑÿß ŸäŸÖŸÉŸÜ ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿ•ŸÑŸâ "ÿ•ÿ¨ÿßÿ≤ÿ© ÿ¥Ÿáÿ±Ÿäÿ©"\n\nÿßŸÑÿ±ÿµŸäÿØ ÿßŸÑÿ≠ÿßŸÑŸä: ${monthlyBalance.toFixed(1)} ŸäŸàŸÖ (ÿ±ÿµŸäÿØ ÿ≥ÿßŸÑÿ®)\nÿßŸÑŸÖÿ∑ŸÑŸàÿ®: ${requiredDays} ŸäŸàŸÖ\n\nÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿ®ŸÇÿßÿ° ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ŸÉŸÄ "ÿ•ÿ¨ÿßÿ≤ÿ© ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ®" ÿ£Ÿà ÿ≤ŸäÿßÿØÿ© ÿ±ÿµŸäÿØ ÿßŸÑŸÖŸàÿ∏ŸÅ ÿ£ŸàŸÑÿßŸã.`;
                            } else {
                                errorMessage = `‚ö†Ô∏è ŸÑÿß ŸäŸÖŸÉŸÜ ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿ•ŸÑŸâ "ÿ•ÿ¨ÿßÿ≤ÿ© ÿ¥Ÿáÿ±Ÿäÿ©"\n\nÿßŸÑÿ±ÿµŸäÿØ ÿßŸÑÿ≠ÿßŸÑŸä: ${monthlyBalance.toFixed(1)} ŸäŸàŸÖ (ÿ±ÿµŸäÿØ ÿµŸÅÿ±)\nÿßŸÑŸÖÿ∑ŸÑŸàÿ®: ${requiredDays} ŸäŸàŸÖ\n\nÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿ®ŸÇÿßÿ° ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ŸÉŸÄ "ÿ•ÿ¨ÿßÿ≤ÿ© ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ®" ÿ£Ÿà ÿ≤ŸäÿßÿØÿ© ÿ±ÿµŸäÿØ ÿßŸÑŸÖŸàÿ∏ŸÅ ÿ£ŸàŸÑÿßŸã.`;
                            }
                            alert(errorMessage);
                            return;
                        } else if (monthlyBalance < requiredDays) {
                            const shortage = requiredDays - monthlyBalance;
                            const errorMessage = `‚ö†Ô∏è ŸÑÿß ŸäŸÖŸÉŸÜ ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿ•ŸÑŸâ "ÿ•ÿ¨ÿßÿ≤ÿ© ÿ¥Ÿáÿ±Ÿäÿ©"\n\nÿßŸÑÿ±ÿµŸäÿØ ÿßŸÑŸÖÿ™ÿßÿ≠: ${monthlyBalance.toFixed(1)} ŸäŸàŸÖ\nÿßŸÑŸÖÿ∑ŸÑŸàÿ®: ${requiredDays} ŸäŸàŸÖ\nÿßŸÑŸÜŸÇÿµ: ${shortage.toFixed(1)} ŸäŸàŸÖ\n\nÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿ®ŸÇÿßÿ° ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ŸÉŸÄ "ÿ•ÿ¨ÿßÿ≤ÿ© ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ®" ÿ£Ÿà ÿ≤ŸäÿßÿØÿ© ÿ±ÿµŸäÿØ ÿßŸÑŸÖŸàÿ∏ŸÅ ÿ£ŸàŸÑÿßŸã.`;
                            alert(errorMessage);
                            return;
                        }
                    }
                }
            }

            try {
                // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿπÿØŸÖ ÿ™ŸÉÿ±ÿßÿ± ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ŸÑŸÜŸÅÿ≥ ÿßŸÑŸÖŸàÿ∏ŸÅ ŸÅŸä ŸÜŸÅÿ≥ ÿßŸÑŸÅÿ™ÿ±ÿ© (ÿßÿ≥ÿ™ÿ´ŸÜÿßÿ° ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©)
                // #region agent log
                const beforeOverlapCheck = leavesData.filter(l => l.employeeId === employeeId && l.id !== editingLeaveId).length;
                fetch('http://127.0.0.1:7242/ingest/92a107bc-3396-4b6c-a6d6-34a2cf7f1b41',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'Human Resources Management.html:9612',message:'updateLeave() - ŸÇÿ®ŸÑ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ™ÿ∂ÿßÿ±ÿ®',data:{editingLeaveId:editingLeaveId,employeeId:employeeId,otherLeavesCount:beforeOverlapCheck,startDate:startDate,endDate:endDate,type:type},timestamp:Date.now(),sessionId:sessionId,runId:runId,hypothesisId:'B'})}).catch(()=>{});
                console.log('üîç [DEBUG-LEAVE-UPDATE] ŸÇÿ®ŸÑ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ™ÿ∂ÿßÿ±ÿ® - ÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿ£ÿÆÿ±Ÿâ ŸÑŸÑŸÖŸàÿ∏ŸÅ:', beforeOverlapCheck);
                // #endregion
                
                const hasOverlap = checkLeaveOverlap(employeeId, startDate, endDate, type, editingLeaveId);
                
                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/92a107bc-3396-4b6c-a6d6-34a2cf7f1b41',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'Human Resources Management.html:9613',message:'updateLeave() - ŸÜÿ™Ÿäÿ¨ÿ© ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ™ÿ∂ÿßÿ±ÿ®',data:{editingLeaveId:editingLeaveId,hasOverlap:hasOverlap},timestamp:Date.now(),sessionId:sessionId,runId:runId,hypothesisId:'B'})}).catch(()=>{});
                console.log('üîç [DEBUG-LEAVE-UPDATE] ŸÜÿ™Ÿäÿ¨ÿ© ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ™ÿ∂ÿßÿ±ÿ®:', hasOverlap);
                // #endregion
                
                if (hasOverlap) {
                    alert('‚ö†Ô∏è ŸäŸàÿ¨ÿØ ÿ•ÿ¨ÿßÿ≤ÿ© ÿ£ÿÆÿ±Ÿâ ŸÑŸÑŸÖŸàÿ∏ŸÅ ŸÅŸä ŸÜŸÅÿ≥ ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑÿ≤ŸÖŸÜŸäÿ©. ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ™Ÿàÿßÿ±ŸäÿÆ.');
                    return;
                }
                
                // ÿßŸÑÿ≠ŸÅÿßÿ∏ ÿπŸÑŸâ ÿßŸÑŸÜŸàÿπ ÿßŸÑÿ£ÿµŸÑŸä ÿπŸÜÿØ ÿßŸÑÿ™ÿπÿØŸäŸÑ
                const existingLeave = leavesData.find(l => l.id === editingLeaveId);
                
                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/92a107bc-3396-4b6c-a6d6-34a2cf7f1b41',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'Human Resources Management.html:9619',message:'updateLeave() - ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿßŸÑŸÖŸàÿ¨ŸàÿØÿ©',data:{editingLeaveId:editingLeaveId,existingLeaveFound:!!existingLeave,existingLeaveType:existingLeave?.type,existingLeaveOriginalType:existingLeave?.originalType},timestamp:Date.now(),sessionId:sessionId,runId:runId,hypothesisId:'C'})}).catch(()=>{});
                console.log('üîç [DEBUG-LEAVE-UPDATE] ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿßŸÑŸÖŸàÿ¨ŸàÿØÿ©:', existingLeave ? {id: existingLeave.id, type: existingLeave.type, originalType: existingLeave.originalType} : 'ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©');
                // #endregion
                
                // ŸÖÿ≠ÿßŸàŸÑÿ© ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑŸÜŸàÿπ ÿßŸÑÿ£ÿµŸÑŸä ŸÖŸÜ attribute ÿ£Ÿà ŸÖŸÜ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ©
                let originalType = leaveTypeSelect ? leaveTypeSelect.getAttribute('data-original-type') : null;
                
                // ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸÖŸàÿ¨ŸàÿØÿßŸã ŸÅŸä attributeÿå ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ©
                if (!originalType && existingLeave) {
                    originalType = existingLeave.originalType || existingLeave.type || type;
                }
                
                // ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸÖŸàÿ¨ŸàÿØÿßŸã ÿπŸÑŸâ ÿßŸÑÿ•ÿ∑ŸÑÿßŸÇÿå ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑŸÜŸàÿπ ÿßŸÑÿ≠ÿßŸÑŸä
                if (!originalType) {
                    originalType = type;
                }
                
                // ÿ™ÿ≠ÿØŸäÿØ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ÿ≠ŸàŸäŸÑ:
                // 1. ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ŸÖŸàÿ¨ŸàÿØÿ©ÿå ÿßÿ≠ÿ™ŸÅÿ∏ ÿ®ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿ£ÿµŸÑŸäÿ© ÿ•ÿ∞ÿß ŸÑŸÖ Ÿäÿ™ÿ∫Ÿäÿ± ÿßŸÑŸÜŸàÿπ
                // 2. ÿ•ÿ∞ÿß ÿ™ŸÖ ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸÜŸàÿπ ŸÖŸÜ ÿ¥Ÿáÿ±Ÿäÿ© ÿ£Ÿà ÿ≤ŸÖŸÜŸäÿ© ÿ•ŸÑŸâ ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ® ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿ™ÿπÿØŸäŸÑÿå ÿ≠ÿØŸëÿ´ ÿßŸÑÿ≠ÿßŸÑÿ©
                let convertedFromMonthly = false;
                if (existingLeave) {
                    // ÿßŸÑÿ≠ŸÅÿßÿ∏ ÿπŸÑŸâ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿ£ÿµŸÑŸäÿ© ÿ•ÿ∞ÿß ŸÑŸÖ Ÿäÿ™ÿ∫Ÿäÿ± ÿßŸÑŸÜŸàÿπ
                    if (existingLeave.type === type) {
                        convertedFromMonthly = existingLeave.convertedFromMonthly || false;
                    } else {
                        // ÿ•ÿ∞ÿß ÿ™ÿ∫Ÿäÿ± ÿßŸÑŸÜŸàÿπÿå ÿßÿ≠ÿ≥ÿ® ÿßŸÑÿ≠ÿßŸÑÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ©
                        convertedFromMonthly = (originalType === 'monthly' && type === 'unpaid') || (originalType === 'hourly' && type === 'unpaid');
                    }
                } else {
                    // ÿ•ÿ¨ÿßÿ≤ÿ© ÿ¨ÿØŸäÿØÿ© (ŸÑÿß Ÿäÿ¨ÿ® ÿ£ŸÜ Ÿäÿ≠ÿØÿ´ Ÿáÿ∞ÿßÿå ŸÑŸÉŸÜ ŸÑŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑)
                    convertedFromMonthly = (originalType === 'monthly' && type === 'unpaid') || (originalType === 'hourly' && type === 'unpaid');
                }
                
                // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ŸÇŸäŸÖÿ© ÿÆŸäÿßÿ± ÿßŸÑÿÆÿµŸÖ (ŸÅŸÇÿ∑ ŸÑŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑŸÖÿ≠ŸàŸÑÿ© ÿ•ŸÑŸâ ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ®)
                const calculateDeduction = type === 'unpaid' && convertedFromMonthly 
                    ? document.getElementById('leaveCalculateDeduction')?.checked ?? true 
                    : (existingLeave?.calculateDeduction !== undefined ? existingLeave.calculateDeduction : true);
                
                // ÿ≠ŸÅÿ∏ ÿßŸÑÿ±ÿßÿ™ÿ® ÿßŸÑÿ≠ÿßŸÑŸä ŸàÿßŸÑÿπŸÖŸÑÿ© ÿπŸÜÿØ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© (ÿ•ÿ∞ÿß ÿ™ÿ∫Ÿäÿ± ŸÜŸàÿπ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿ•ŸÑŸâ ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ® ÿ£Ÿà ÿ™ÿ∫Ÿäÿ± ÿÆŸäÿßÿ± ÿßŸÑÿÆÿµŸÖ)
                let salaryAtLeaveDate = existingLeave?.salaryAtLeaveDate || null;
                let salaryCurrencyAtLeave = existingLeave?.salaryCurrencyAtLeave || null;
                
                // ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ® ŸàŸäÿ™ŸÖ ÿßÿ≠ÿ™ÿ≥ÿßÿ® ÿßŸÑÿÆÿµŸÖÿå ŸÜÿ≠ŸÅÿ∏ ÿßŸÑÿ±ÿßÿ™ÿ® ÿßŸÑÿ≠ÿßŸÑŸä
                if (type === 'unpaid' && calculateDeduction) {
                    // ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸáŸÜÿßŸÉ ÿ±ÿßÿ™ÿ® ŸÖÿ≠ŸÅŸàÿ∏ ŸÖÿ≥ÿ®ŸÇÿßŸã ÿ£Ÿà ÿ™ÿ∫Ÿäÿ± ŸÜŸàÿπ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿ•ŸÑŸâ ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ®
                    if (!salaryAtLeaveDate || (existingLeave && existingLeave.type !== 'unpaid')) {
                        const employee = employeesData.find(e => e.id === employeeId);
                        if (employee && employee.currentSalary) {
                            salaryAtLeaveDate = employee.currentSalary;
                            salaryCurrencyAtLeave = employee.currentSalaryCurrency || 'IQD';
                        }
                    }
                }
                
                // ÿ™ÿ≠ÿØŸäÿØ ŸÜŸàÿπ ÿßŸÑŸÖŸáŸÖÿ© ŸàÿπÿØÿØ ÿßŸÑÿ≥ÿßÿπÿßÿ™ ŸÑŸÖŸáŸÖÿ© ÿßŸÑÿπŸÖŸÑ
                let missionType = null;
                let missionHours = null;
                if (type === 'work-mission') {
                    missionType = document.getElementById('leaveMissionType')?.value || null;
                    if (missionType === 'hourly') {
                        missionHours = parseFloat(document.getElementById('leaveMissionHours')?.value || 0);
                    }
                }
                
                const leaveData = {
                    employeeId: employeeId,
                    type: type,
                    originalType: originalType, // ÿßŸÑÿ≠ŸÅÿßÿ∏ ÿπŸÑŸâ ÿßŸÑŸÜŸàÿπ ÿßŸÑÿ£ÿµŸÑŸä
                    convertedFromMonthly: convertedFromMonthly, // ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ÿ≠ŸàŸäŸÑ (ŸÖÿ≠ÿØÿ´ÿ© ÿ•ÿ∞ÿß ÿ™ÿ∫Ÿäÿ± ÿßŸÑŸÜŸàÿπ)
                    calculateDeduction: calculateDeduction, // ŸáŸÑ Ÿäÿ™ŸÖ ÿßÿ≠ÿ™ÿ≥ÿßÿ® ÿÆÿµŸÖ ŸÖÿßŸÑŸäÿü
                    salaryAtLeaveDate: salaryAtLeaveDate, // ÿßŸÑÿ±ÿßÿ™ÿ® ÿßŸÑÿ≠ÿßŸÑŸä ÿπŸÜÿØ ÿ•ÿ∂ÿßŸÅÿ©/ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ©
                    salaryCurrencyAtLeave: salaryCurrencyAtLeave, // ÿßŸÑÿπŸÖŸÑÿ© ÿπŸÜÿØ ÿ•ÿ∂ÿßŸÅÿ©/ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ©
                    regionId: (type === 'work-mission') ? (document.getElementById('leaveRegionId')?.value || null) : null, // ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ŸÑŸÖŸáŸÖÿ© ÿßŸÑÿπŸÖŸÑ
                    missionType: missionType, // ŸÜŸàÿπ ÿßŸÑŸÖŸáŸÖÿ© (ÿ≤ŸÖŸÜŸäÿ© ÿ£Ÿà ŸäŸàŸÖ ŸÉÿßŸÖŸÑ)
                    missionHours: missionHours, // ÿπÿØÿØ ÿ≥ÿßÿπÿßÿ™ ÿßŸÑŸÖŸáŸÖÿ© ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿ≤ŸÖŸÜŸäÿ©
                    startDate: startDate,
                    endDate: (type === 'hourly' || (type === 'work-mission' && missionType === 'hourly')) ? null : (endDate || null), // ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ© ŸàŸÖŸáÿßŸÖ ÿßŸÑÿπŸÖŸÑ ÿßŸÑÿ≤ŸÖŸÜŸäÿ© ŸÑÿß ÿ™ÿ≠ÿ™ÿßÿ¨ endDate
                    hours: type === 'hourly' ? parseFloat(hours) : null,
                    timeRanges: timeRanges, // ÿßŸÑŸÅÿ™ÿ±ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ© ÿßŸÑŸÖÿ™ÿπÿØÿØÿ© ŸÑŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ© ÿßŸÑŸÖÿ™ŸÇÿ∑ÿπÿ©
                    status: status,
                    notes: notes,
                    updatedAt: window.firestore.serverTimestamp(),
                    updatedBy: currentUser?.uid || 'system'
                };
                
                // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÑÿ™ÿ≠ŸÇŸÇ (ŸÅŸä Ÿàÿ∂ÿπ ÿßŸÑÿ™ÿ∑ŸàŸäÿ±)
                console.log('üíæ ÿ™ÿ≠ÿØŸäÿ´ ÿ•ÿ¨ÿßÿ≤ÿ©:', {
                    id: editingLeaveId,
                    type: leaveData.type,
                    originalType: leaveData.originalType,
                    convertedFromMonthly: leaveData.convertedFromMonthly,
                    endDate: leaveData.endDate,
                    previousType: existingLeave?.type,
                    previousConvertedFromMonthly: existingLeave?.convertedFromMonthly
                });

                // #region agent log
                const beforeUpdate = leavesData.filter(l => l.id === editingLeaveId).length;
                fetch('http://127.0.0.1:7242/ingest/92a107bc-3396-4b6c-a6d6-34a2cf7f1b41',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'Human Resources Management.html:9700',message:'updateLeave() - ŸÇÿ®ŸÑ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ŸÅŸä Firebase',data:{editingLeaveId:editingLeaveId,leaveData:leaveData,leavesDataCountBefore:leavesData.length,existingInMemory:beforeUpdate},timestamp:Date.now(),sessionId:sessionId,runId:runId,hypothesisId:'D'})}).catch(()=>{});
                console.log('üîç [DEBUG-LEAVE-UPDATE] ŸÇÿ®ŸÑ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ŸÅŸä Firebase - ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ŸÖŸàÿ¨ŸàÿØÿ© ŸÅŸä ÿßŸÑÿ∞ÿßŸÉÿ±ÿ©:', beforeUpdate);
                // #endregion
                
                await window.firestore.updateDoc(
                    window.firestore.doc(window.db, 'leaves', editingLeaveId),
                    leaveData
                );

                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/92a107bc-3396-4b6c-a6d6-34a2cf7f1b41',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'Human Resources Management.html:9703',message:'updateLeave() - ÿ®ÿπÿØ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ŸÅŸä Firebase',data:{editingLeaveId:editingLeaveId},timestamp:Date.now(),sessionId:sessionId,runId:runId,hypothesisId:'D'})}).catch(()=>{});
                console.log('üîç [DEBUG-LEAVE-UPDATE] ÿ®ÿπÿØ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ŸÅŸä Firebase');
                // #endregion

                alert('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿ®ŸÜÿ¨ÿßÿ≠!');
                
                // #region agent log
                const editingLeaveIdBeforeHide = editingLeaveId;
                fetch('http://127.0.0.1:7242/ingest/92a107bc-3396-4b6c-a6d6-34a2cf7f1b41',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'Human Resources Management.html:9706',message:'updateLeave() - ŸÇÿ®ŸÑ hideAddLeaveForm',data:{editingLeaveId:editingLeaveIdBeforeHide},timestamp:Date.now(),sessionId:sessionId,runId:runId,hypothesisId:'E'})}).catch(()=>{});
                console.log('üîç [DEBUG-LEAVE-UPDATE] ŸÇÿ®ŸÑ hideAddLeaveForm(), editingLeaveId:', editingLeaveIdBeforeHide);
                // #endregion
                
                hideAddLeaveForm();
                
                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/92a107bc-3396-4b6c-a6d6-34a2cf7f1b41',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'Human Resources Management.html:9707',message:'updateLeave() - ÿ®ÿπÿØ hideAddLeaveForm',data:{editingLeaveId:editingLeaveId},timestamp:Date.now(),sessionId:sessionId,runId:runId,hypothesisId:'E'})}).catch(()=>{});
                console.log('üîç [DEBUG-LEAVE-UPDATE] ÿ®ÿπÿØ hideAddLeaveForm(), editingLeaveId:', editingLeaveId);
                // #endregion
                
                await loadLeaves();
                
                // #region agent log
                const afterLoad = leavesData.filter(l => l.id === editingLeaveIdBeforeHide).length;
                fetch('http://127.0.0.1:7242/ingest/92a107bc-3396-4b6c-a6d6-34a2cf7f1b41',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'Human Resources Management.html:9708',message:'updateLeave() - ÿ®ÿπÿØ loadLeaves',data:{editingLeaveId:editingLeaveIdBeforeHide,leavesDataCountAfter:leavesData.length,existingInMemory:afterLoad,editingLeaveIdNow:editingLeaveId},timestamp:Date.now(),sessionId:sessionId,runId:runId,hypothesisId:'D'})}).catch(()=>{});
                console.log('üîç [DEBUG-LEAVE-UPDATE] ÿ®ÿπÿØ loadLeaves() - ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ŸÖŸàÿ¨ŸàÿØÿ© ŸÅŸä ÿßŸÑÿ∞ÿßŸÉÿ±ÿ©:', afterLoad, 'editingLeaveId:', editingLeaveId);
                // #endregion
            } catch (error) {
                alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ©: ' + error.message);
                console.error(error);
            }
        }

        async function deleteLeave(id) {
            if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞Ÿá ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ©ÿü')) {
                return;
            }

            if (!window.db || !window.firestore) {
                alert('Firebase ÿ∫Ÿäÿ± ŸÖŸáŸäÿ£');
                return;
            }

            try {
                await window.firestore.deleteDoc(
                    window.firestore.doc(window.db, 'leaves', id)
                );

                alert('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿ®ŸÜÿ¨ÿßÿ≠!');
                await loadLeaves();
            } catch (error) {
                alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ÿ∞ŸÅ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ©: ' + error.message);
                console.error(error);
            }
        }

        function getLeaveTypeName(type, leave = null) {
            const types = {
                'monthly': 'ÿ•ÿ¨ÿßÿ≤ÿ© ÿ¥Ÿáÿ±Ÿäÿ©',
                'hourly': 'ÿ•ÿ¨ÿßÿ≤ÿ© ÿ≤ŸÖŸÜŸäÿ©',
                'unpaid': 'ÿ•ÿ¨ÿßÿ≤ÿ© ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ®',
                'work-mission': 'ŸÖŸáŸÖÿ© ÿπŸÖŸÑ'
            };
            
            // ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ŸÖÿ≠ŸàŸÑÿ© ŸÖŸÜ ÿ¥Ÿáÿ±Ÿäÿ© ÿ•ŸÑŸâ ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ®
            if (leave && leave.type === 'unpaid' && leave.convertedFromMonthly) {
                return 'ÿ•ÿ¨ÿßÿ≤ÿ© ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ® (ŸÖÿ≠ŸàŸÑÿ© ŸÖŸÜ ÿ¥Ÿáÿ±Ÿäÿ©)';
            }
            
            // ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ŸÖŸáŸÖÿ© ÿπŸÖŸÑÿå ÿ£ÿ∂ŸÅ ŸÜŸàÿπ ÿßŸÑŸÖŸáŸÖÿ©
            if (type === 'work-mission' && leave) {
                if (leave.missionType === 'hourly') {
                    return `ŸÖŸáŸÖÿ© ÿπŸÖŸÑ (ÿ≤ŸÖŸÜŸäÿ© - ${leave.missionHours || 0} ÿ≥ÿßÿπÿ©)`;
                } else if (leave.missionType === 'full-day') {
                    return 'ŸÖŸáŸÖÿ© ÿπŸÖŸÑ (ŸäŸàŸÖ ŸÉÿßŸÖŸÑ)';
                }
                return 'ŸÖŸáŸÖÿ© ÿπŸÖŸÑ';
            }
            
            return types[type] || type;
        }

        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ™ÿØÿßÿÆŸÑ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ŸÑŸÜŸÅÿ≥ ÿßŸÑŸÖŸàÿ∏ŸÅ
        function checkLeaveOverlap(employeeId, startDate, endDate, type, excludeLeaveId = null) {
            // #region agent log
            const sessionId = 'debug-session-' + Date.now();
            const runId = 'run1';
            fetch('http://127.0.0.1:7242/ingest/92a107bc-3396-4b6c-a6d6-34a2cf7f1b41',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'Human Resources Management.html:9753',message:'checkLeaveOverlap() - ÿ®ÿØÿ° ÿßŸÑÿ™ÿ≠ŸÇŸÇ',data:{employeeId:employeeId,startDate:startDate,endDate:endDate,type:type,excludeLeaveId:excludeLeaveId,leavesDataCount:leavesData.length},timestamp:Date.now(),sessionId:sessionId,runId:runId,hypothesisId:'B'})}).catch(()=>{});
            console.log('üîç [DEBUG-LEAVE-OVERLAP] ÿ®ÿØÿ° ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ™ÿ∂ÿßÿ±ÿ®:', {employeeId, startDate, endDate, type, excludeLeaveId});
            // #endregion
            
            if (!employeeId || !startDate) {
                return false;
            }
            
            const newStart = new Date(startDate);
            newStart.setHours(0, 0, 0, 0);
            
            // ŸÑŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ©ÿå ŸÜÿ≥ÿ™ÿÆÿØŸÖ ŸÜŸÅÿ≥ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ŸÉÿ™ÿßÿ±ŸäÿÆ ÿ®ÿØÿßŸäÿ© ŸàŸÜŸáÿßŸäÿ©
            let newEnd = null;
            if (type === 'hourly') {
                newEnd = new Date(startDate);
                newEnd.setHours(23, 59, 59, 999);
            } else if (endDate) {
                newEnd = new Date(endDate);
                newEnd.setHours(23, 59, 59, 999);
            } else {
                // ŸÑŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ® ÿ®ÿØŸàŸÜ ÿ™ÿßÿ±ŸäÿÆ ÿßŸÜÿ™Ÿáÿßÿ°ÿå ŸÜÿ≥ÿ™ÿÆÿØŸÖ ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ®ÿØÿßŸäÿ© ŸÅŸÇÿ∑
                newEnd = new Date(startDate);
                newEnd.setHours(23, 59, 59, 999);
            }
            
            // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿ•ÿ¨ÿßÿ≤ÿßÿ™ ŸÖÿ™ÿØÿßÿÆŸÑÿ© ŸÑŸÜŸÅÿ≥ ÿßŸÑŸÖŸàÿ∏ŸÅ
            const allEmployeeLeaves = leavesData.filter(l => l.employeeId === employeeId);
            const validLeaves = allEmployeeLeaves.filter(l => l.status !== 'rejected' && l.status !== 'cancelled' && l.startDate);
            
            // #region agent log
            fetch('http://127.0.0.1:7242/ingest/92a107bc-3396-4b6c-a6d6-34a2cf7f1b41',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'Human Resources Management.html:9775',message:'checkLeaveOverlap() - ŸÇÿ®ŸÑ ÿßŸÑŸÅŸÑÿ™ÿ±ÿ©',data:{employeeId:employeeId,allEmployeeLeavesCount:allEmployeeLeaves.length,validLeavesCount:validLeaves.length,excludeLeaveId:excludeLeaveId},timestamp:Date.now(),sessionId:sessionId,runId:runId,hypothesisId:'B'})}).catch(()=>{});
            console.log('üîç [DEBUG-LEAVE-OVERLAP] ÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑŸÖŸàÿ∏ŸÅ:', {all: allEmployeeLeaves.length, valid: validLeaves.length});
            // #endregion
            
            const overlappingLeaves = validLeaves.filter(leave => {
                // ÿßÿ≥ÿ™ÿ´ŸÜÿßÿ° ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ© ÿπŸÜÿØ ÿßŸÑÿ™ÿπÿØŸäŸÑ
                if (excludeLeaveId && leave.id === excludeLeaveId) {
                    return false;
                }
                
                if (!leave.startDate) {
                    return false;
                }
                
                const existingStart = new Date(leave.startDate);
                existingStart.setHours(0, 0, 0, 0);
                
                let existingEnd = null;
                if (leave.type === 'hourly') {
                    // ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ©: ŸÜŸÅÿ≥ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ
                    existingEnd = new Date(leave.startDate);
                    existingEnd.setHours(23, 59, 59, 999);
                } else if (leave.endDate) {
                    existingEnd = new Date(leave.endDate);
                    existingEnd.setHours(23, 59, 59, 999);
                } else {
                    // ÿ®ÿØŸàŸÜ ÿ™ÿßÿ±ŸäÿÆ ÿßŸÜÿ™Ÿáÿßÿ°: ŸÜŸÅÿ≥ ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ®ÿØÿßŸäÿ©
                    existingEnd = new Date(leave.startDate);
                    existingEnd.setHours(23, 59, 59, 999);
                }
                
                // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ™ÿØÿßÿÆŸÑ: ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ© ÿ™ÿ™ÿØÿßÿÆŸÑ ŸÖÿπ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿßŸÑŸÖŸàÿ¨ŸàÿØÿ©
                // ÿßŸÑÿ™ÿØÿßÿÆŸÑ Ÿäÿ≠ÿØÿ´ ÿ•ÿ∞ÿß:
                // 1. ÿ™ÿßÿ±ŸäÿÆ ÿ®ÿØÿßŸäÿ© ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ© ŸäŸÇÿπ ÿ∂ŸÖŸÜ ŸÅÿ™ÿ±ÿ© ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿßŸÑŸÖŸàÿ¨ŸàÿØÿ©
                // 2. ÿ™ÿßÿ±ŸäÿÆ ŸÜŸáÿßŸäÿ© ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ© ŸäŸÇÿπ ÿ∂ŸÖŸÜ ŸÅÿ™ÿ±ÿ© ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿßŸÑŸÖŸàÿ¨ŸàÿØÿ©
                // 3. ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ© ÿ™ÿ≠ÿ™ŸàŸä ÿπŸÑŸâ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿßŸÑŸÖŸàÿ¨ŸàÿØÿ© ÿ®ÿßŸÑŸÉÿßŸÖŸÑ
                // 4. ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿßŸÑŸÖŸàÿ¨ŸàÿØÿ© ÿ™ÿ≠ÿ™ŸàŸä ÿπŸÑŸâ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ© ÿ®ÿßŸÑŸÉÿßŸÖŸÑ
                const overlap = (
                    (newStart >= existingStart && newStart <= existingEnd) ||
                    (newEnd >= existingStart && newEnd <= existingEnd) ||
                    (newStart <= existingStart && newEnd >= existingEnd) ||
                    (existingStart <= newStart && existingEnd >= newEnd)
                );
                
                // #region agent log
                if (overlap) {
                    fetch('http://127.0.0.1:7242/ingest/92a107bc-3396-4b6c-a6d6-34a2cf7f1b41',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'Human Resources Management.html:9819',message:'checkLeaveOverlap() - ÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ™ÿØÿßÿÆŸÑ',data:{leaveId:leave.id,leaveType:leave.type,leaveStartDate:leave.startDate,leaveEndDate:leave.endDate,newStartDate:startDate,newEndDate:endDate,excludeLeaveId:excludeLeaveId},timestamp:Date.now(),sessionId:sessionId,runId:runId,hypothesisId:'B'})}).catch(()=>{});
                    console.log('üîç [DEBUG-LEAVE-OVERLAP] ÿ™ÿØÿßÿÆŸÑ ŸÖÿπ ÿ•ÿ¨ÿßÿ≤ÿ©:', {leaveId: leave.id, leaveType: leave.type, leaveStart: leave.startDate, leaveEnd: leave.endDate});
                }
                // #endregion
                
                return overlap;
            });
            
            // #region agent log
            fetch('http://127.0.0.1:7242/ingest/92a107bc-3396-4b6c-a6d6-34a2cf7f1b41',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'Human Resources Management.html:9829',message:'checkLeaveOverlap() - ŸÜÿ™Ÿäÿ¨ÿ© ÿßŸÑÿ™ÿ≠ŸÇŸÇ',data:{employeeId:employeeId,overlappingLeavesCount:overlappingLeaves.length,overlappingLeavesIds:overlappingLeaves.map(l=>l.id),excludeLeaveId:excludeLeaveId},timestamp:Date.now(),sessionId:sessionId,runId:runId,hypothesisId:'B'})}).catch(()=>{});
            console.log('üîç [DEBUG-LEAVE-OVERLAP] ÿπÿØÿØ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑŸÖÿ™ÿØÿßÿÆŸÑÿ©:', overlappingLeaves.length, overlappingLeaves.map(l => l.id));
            // #endregion
            
            if (overlappingLeaves.length > 0) {
                console.warn('‚ö†Ô∏è ÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ•ÿ¨ÿßÿ≤ÿßÿ™ ŸÖÿ™ÿØÿßÿÆŸÑÿ©:', overlappingLeaves);
                return true;
            }
            
            return false;
        }

        // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿÆÿµŸÖ ŸÑŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ®
        function calculateUnpaidLeaveDeduction(leave, employee) {
            if (leave.type !== 'unpaid') {
                return null;
            }
            
            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿÆŸäÿßÿ± ÿßÿ≠ÿ™ÿ≥ÿßÿ® ÿßŸÑÿÆÿµŸÖ (ŸÅŸÇÿ∑ ŸÑŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑŸÖÿ≠ŸàŸÑÿ©)
            if (leave.convertedFromMonthly && leave.calculateDeduction === false) {
                return null; // ŸÑÿß Ÿäÿ™ŸÖ ÿßÿ≠ÿ™ÿ≥ÿßÿ® ÿÆÿµŸÖ ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿÆŸäÿßÿ± ŸÖÿπÿ∑ŸÑÿßŸã
            }
            
            // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ±ÿßÿ™ÿ® ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ ÿπŸÜÿØ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© (ÿ•ŸÜ Ÿàÿ¨ÿØ)ÿå Ÿàÿ•ŸÑÿß ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ±ÿßÿ™ÿ® ÿßŸÑÿ≠ÿßŸÑŸä
            const salaryToUse = leave.salaryAtLeaveDate || employee.currentSalary;
            if (!salaryToUse || salaryToUse <= 0) {
                return null;
            }
            
            // ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿ≤ŸÖŸÜŸäÿ© (hourly) - ÿßÿ≠ÿ™ÿ≥ÿßÿ® ÿßŸÑÿÆÿµŸÖ ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿßŸÑÿ≥ÿßÿπÿßÿ™
            if (leave.originalType === 'hourly' && leave.hours) {
                // ÿ≠ÿ≥ÿßÿ® ÿπÿØÿØ ÿ≥ÿßÿπÿßÿ™ ÿßŸÑÿπŸÖŸÑ ŸÅŸä ÿßŸÑÿ¥Ÿáÿ± (ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä: 8 ÿ≥ÿßÿπÿßÿ™ √ó 22 ŸäŸàŸÖ ÿπŸÖŸÑ = 176 ÿ≥ÿßÿπÿ©)
                // ÿ£Ÿà ŸäŸÖŸÉŸÜ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿ≥ÿßÿπÿßÿ™ ÿßŸÑÿπŸÖŸÑ ÿßŸÑÿ¥Ÿáÿ±Ÿäÿ© ŸÖŸÜ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖŸàÿ∏ŸÅ ÿ•ŸÜ Ÿàÿ¨ÿØÿ™
                const workingHoursPerDay = 8; // ÿ≥ÿßÿπÿßÿ™ ÿßŸÑÿπŸÖŸÑ ÿßŸÑŸäŸàŸÖŸäÿ©
                let daysInMonth = 30; // ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä
                if (leave.startDate) {
                    const leaveDate = new Date(leave.startDate);
                    const year = leaveDate.getFullYear();
                    const month = leaveDate.getMonth();
                    daysInMonth = new Date(year, month + 1, 0).getDate();
                }
                const workingHoursPerMonth = workingHoursPerDay * daysInMonth;
                
                // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿÆÿµŸÖ: (ÿßŸÑÿ±ÿßÿ™ÿ® ÿßŸÑÿ¥Ÿáÿ±Ÿä / ÿπÿØÿØ ÿ≥ÿßÿπÿßÿ™ ÿßŸÑÿπŸÖŸÑ ÿßŸÑÿ¥Ÿáÿ±Ÿäÿ©) √ó ÿπÿØÿØ ÿ≥ÿßÿπÿßÿ™ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ©
                const hourlySalary = salaryToUse / workingHoursPerMonth;
                const deduction = hourlySalary * leave.hours;
                
                return Math.round(deduction * 100) / 100; // ÿ™ŸÇÿ±Ÿäÿ® ÿ•ŸÑŸâ ÿ±ŸÇŸÖŸäŸÜ ÿπÿ¥ÿ±ŸäŸäŸÜ
            }
            
            // ŸÑŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑÿ¥Ÿáÿ±Ÿäÿ© - ÿßÿ≠ÿ™ÿ≥ÿßÿ® ÿßŸÑÿÆÿµŸÖ ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿßŸÑÿ£ŸäÿßŸÖ
            // ÿ≠ÿ≥ÿßÿ® ÿπÿØÿØ ÿßŸÑÿ£ŸäÿßŸÖ
            let days = 0;
            if (leave.startDate && leave.endDate) {
                const start = new Date(leave.startDate);
                const end = new Date(leave.endDate);
                const diffTime = Math.abs(end - start);
                days = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
            } else if (leave.startDate) {
                days = 1; // ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸáŸÜÿßŸÉ ÿ™ÿßÿ±ŸäÿÆ ÿßŸÜÿ™Ÿáÿßÿ°ÿå ŸÜÿπÿ™ÿ®ÿ± ŸäŸàŸÖ Ÿàÿßÿ≠ÿØ
            }
            
            if (days <= 0) {
                return null;
            }
            
            // ÿ≠ÿ≥ÿßÿ® ÿπÿØÿØ ÿ£ŸäÿßŸÖ ÿßŸÑÿ¥Ÿáÿ± ÿßŸÑŸÅÿπŸÑŸä (ÿ≠ÿ≥ÿ® ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ©)
            let daysInMonth = 30; // ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä
            if (leave.startDate) {
                const leaveDate = new Date(leave.startDate);
                const year = leaveDate.getFullYear();
                const month = leaveDate.getMonth();
                // ÿ≠ÿ≥ÿßÿ® ÿπÿØÿØ ÿ£ŸäÿßŸÖ ÿßŸÑÿ¥Ÿáÿ± ÿßŸÑŸÅÿπŸÑŸä
                daysInMonth = new Date(year, month + 1, 0).getDate();
            }
            
            // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿÆÿµŸÖ: (ÿßŸÑÿ±ÿßÿ™ÿ® ÿßŸÑÿ¥Ÿáÿ±Ÿä / ÿπÿØÿØ ÿ£ŸäÿßŸÖ ÿßŸÑÿ¥Ÿáÿ±) √ó ÿπÿØÿØ ÿßŸÑÿ£ŸäÿßŸÖ
            const dailySalary = salaryToUse / daysInMonth;
            const deduction = dailySalary * days;
            
            return Math.round(deduction * 100) / 100; // ÿ™ŸÇÿ±Ÿäÿ® ÿ•ŸÑŸâ ÿ±ŸÇŸÖŸäŸÜ ÿπÿ¥ÿ±ŸäŸäŸÜ
        }

        // ÿ™ÿ®ÿØŸäŸÑ ÿ≠ÿßŸÑÿ© ÿπÿ±ÿ∂ ÿßŸÑÿÆÿµŸàŸÖÿßÿ™
        function toggleDeductionView() {
            if (window.deductionViewUnlocked) {
                // ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑÿπÿ±ÿ∂
                window.deductionViewUnlocked = false;
                const lockIcon = document.getElementById('deductionLockIcon');
                if (lockIcon) {
                    lockIcon.textContent = 'üîí';
                    lockIcon.title = 'ÿßŸÜŸÇÿ± ŸÑÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿÆÿµŸàŸÖÿßÿ™';
                }
                displayLeaves(); // ÿ•ÿπÿßÿØÿ© ÿπÿ±ÿ∂ ÿßŸÑÿ¨ÿØŸàŸÑ
            } else {
                // ÿ∑ŸÑÿ® ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±
                const password = prompt('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ŸÑÿπÿ±ÿ∂ ÿßŸÑÿÆÿµŸàŸÖÿßÿ™:');
                if (password === null) {
                    return; // ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ£ŸÑÿ∫Ÿâ ÿßŸÑÿπŸÖŸÑŸäÿ©
                }
                
                if (password !== DEDUCTION_VIEW_PASSWORD) {
                    alert('‚ùå ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©');
                    return;
                }
                
                // ŸÅÿ™ÿ≠ ÿßŸÑÿπÿ±ÿ∂
                window.deductionViewUnlocked = true;
                const lockIcon = document.getElementById('deductionLockIcon');
                if (lockIcon) {
                    lockIcon.textContent = 'üîì';
                    lockIcon.title = 'ÿßŸÜŸÇÿ± ŸÑÿ•ÿÆŸÅÿßÿ° ÿßŸÑÿÆÿµŸàŸÖÿßÿ™';
                }
                displayLeaves(); // ÿ•ÿπÿßÿØÿ© ÿπÿ±ÿ∂ ÿßŸÑÿ¨ÿØŸàŸÑ
            }
        }

        // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ© ŸÑŸÑŸÖŸàÿ∏ŸÅ
        function calculateLeaveBalance(employeeId) {
            const employee = employeesData.find(e => e.id === employeeId);
            if (!employee) {
                document.getElementById('leaveBalanceInfo').style.display = 'none';
                return;
            }

            const monthlyLeaveDays = employee.monthlyLeaveDays || 2.5;
            const hourlyLeaveHours = employee.hourlyLeaveHours || 8;

            // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑÿ¥Ÿáÿ±Ÿäÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖÿ© (ÿ™ÿ±ÿßŸÉŸÖŸäÿ© ŸÖŸÜ ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ•ÿØÿ±ÿßÿ¨ ŸÅŸä ÿßŸÑŸÜÿ∏ÿßŸÖ + ÿßŸÑÿ±ÿµŸäÿØ ÿßŸÑÿßÿ®ÿ™ÿØÿßÿ¶Ÿä)
            let monthlyUsed = 0;
            const initialBalance = employee.initialLeaveBalance || 0;
            const entryDate = employee.systemEntryDate || employee.hireDate; // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ•ÿØÿ±ÿßÿ¨ ÿ£Ÿà ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿπŸäŸäŸÜ ŸÉÿ®ÿØŸäŸÑ
            
            if (entryDate) {
                const systemEntryDate = new Date(entryDate);
                systemEntryDate.setHours(0, 0, 0, 0); // ÿ∂ÿ®ÿ∑ ÿßŸÑŸàŸÇÿ™ ÿ•ŸÑŸâ ÿ®ÿØÿßŸäÿ© ÿßŸÑŸäŸàŸÖ
                const now = new Date();
                now.setHours(0, 0, 0, 0); // ÿ∂ÿ®ÿ∑ ÿßŸÑŸàŸÇÿ™ ÿ•ŸÑŸâ ÿ®ÿØÿßŸäÿ© ÿßŸÑŸäŸàŸÖ
                
                // ÿ≠ÿ≥ÿßÿ® ÿπÿØÿØ ÿßŸÑÿ£ÿ¥Ÿáÿ± ÿ®ÿØŸÇÿ© (ŸÖÿ±ÿßÿπÿßÿ© ÿßŸÑÿ£ŸäÿßŸÖ)
                // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑŸäŸàŸÖ ÿßŸÑÿ≠ÿßŸÑŸä >= ŸäŸàŸÖ ÿßŸÑÿ•ÿØÿ±ÿßÿ¨ÿå ŸÜÿ≠ÿ≥ÿ® ÿßŸÑÿ¥Ÿáÿ± ÿßŸÑÿ≠ÿßŸÑŸä ŸÉÿßŸÖŸÑÿßŸã
                // Ÿàÿ•ŸÑÿß ŸÑÿß ŸÜÿ≠ÿ≥ÿ®Ÿá
                let monthsDiff = (now.getFullYear() - systemEntryDate.getFullYear()) * 12 + 
                                (now.getMonth() - systemEntryDate.getMonth());
                
                // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑŸäŸàŸÖ ÿßŸÑÿ≠ÿßŸÑŸä < ŸäŸàŸÖ ÿßŸÑÿ•ÿØÿ±ÿßÿ¨ÿå ŸÑÿß ŸÜÿ≠ÿ≥ÿ® ÿßŸÑÿ¥Ÿáÿ± ÿßŸÑÿ≠ÿßŸÑŸä
                if (now.getDate() < systemEntryDate.getDate()) {
                    monthsDiff -= 1;
                }
                
                // ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ£ŸÜ ÿπÿØÿØ ÿßŸÑÿ£ÿ¥Ÿáÿ± ŸÑŸäÿ≥ ÿ≥ÿßŸÑÿ®ÿßŸã
                if (monthsDiff < 0) {
                    monthsDiff = 0;
                }
                
                // ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑÿ¥Ÿáÿ±Ÿäÿ© ÿßŸÑŸÖÿ™ÿ±ÿßŸÉŸÖÿ© = (ÿπÿØÿØ ÿßŸÑÿ£ÿ¥Ÿáÿ± √ó ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑÿ¥Ÿáÿ±Ÿäÿ©) + ÿßŸÑÿ±ÿµŸäÿØ ÿßŸÑÿßÿ®ÿ™ÿØÿßÿ¶Ÿä
                const totalMonthlyLeaves = (monthsDiff * monthlyLeaveDays) + initialBalance;
                
                // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑÿ¥Ÿáÿ±Ÿäÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖÿ© (ÿßŸÑŸÖŸàÿßŸÅŸÇ ÿπŸÑŸäŸáÿß ŸÅŸÇÿ∑)
                // ŸÖŸÑÿßÿ≠ÿ∏ÿ©: 
                // 1. ÿ¨ŸÖŸäÿπ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ŸÖŸÜ ŸÜŸàÿπ "monthly" ÿ™Ÿèÿ≠ÿ≥ÿ® ŸÅŸä ÿßŸÑÿ±ÿµŸäÿØ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
                // 2. ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ŸÖŸÜ ŸÜŸàÿπ "unpaid" ÿßŸÑÿ™Ÿä ÿ™ŸÖ ÿ™ÿ≠ŸàŸäŸÑŸáÿß ŸÖŸÜ "monthly" (convertedFromMonthly === true) ÿ™Ÿèÿ≠ÿ≥ÿ® ÿ£Ÿäÿ∂ÿßŸã
                // 3. ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ŸÖŸÜ ŸÜŸàÿπ "unpaid" ÿßŸÑŸÖÿ®ÿßÿ¥ÿ±ÿ© (ÿ∫Ÿäÿ± ŸÖÿ≠ŸàŸÑÿ©) ŸÑÿß ÿ™Ÿèÿ≠ÿ≥ÿ® ŸÅŸä ÿßŸÑÿ±ÿµŸäÿØ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
                const monthlyLeaves = leavesData.filter(l => 
                    l.employeeId === employeeId && 
                    l.status === 'approved' && // ÿßŸÑŸÖŸàÿßŸÅŸÇ ÿπŸÑŸäŸáÿß ŸÅŸÇÿ∑
                    (
                        l.type === 'monthly' || // ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑÿ¥Ÿáÿ±Ÿäÿ©
                        (l.type === 'unpaid' && l.convertedFromMonthly === true) // ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑŸÖÿ≠ŸàŸÑÿ© ŸÖŸÜ ÿ¥Ÿáÿ±Ÿäÿ© ÿ•ŸÑŸâ ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ®
                    )
                );
                
                monthlyLeaves.forEach(leave => {
                    if (leave.startDate && leave.endDate) {
                        const start = new Date(leave.startDate);
                        start.setHours(0, 0, 0, 0); // ÿ∂ÿ®ÿ∑ ÿßŸÑŸàŸÇÿ™ ÿ•ŸÑŸâ ÿ®ÿØÿßŸäÿ© ÿßŸÑŸäŸàŸÖ
                        const end = new Date(leave.endDate);
                        end.setHours(0, 0, 0, 0); // ÿ∂ÿ®ÿ∑ ÿßŸÑŸàŸÇÿ™ ÿ•ŸÑŸâ ÿ®ÿØÿßŸäÿ© ÿßŸÑŸäŸàŸÖ
                        
                        // ÿ≠ÿ≥ÿßÿ® ÿπÿØÿØ ÿßŸÑÿ£ŸäÿßŸÖ (ÿ¥ÿßŸÖŸÑÿ©)
                        // ŸÖÿ´ÿßŸÑ: ŸÖŸÜ 1 ŸäŸÜÿßŸäÿ± ÿ•ŸÑŸâ 3 ŸäŸÜÿßŸäÿ± = 3 ÿ£ŸäÿßŸÖ (1, 2, 3)
                        const diffTime = Math.abs(end - start);
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                        monthlyUsed += diffDays;
                    }
                });
                
                const monthlyBalance = totalMonthlyLeaves - monthlyUsed;
                const balanceElement = document.getElementById('monthlyLeaveBalance');
                const balanceContainer = balanceElement.parentElement;
                
                if (monthlyBalance < 0) {
                    // ÿßŸÑÿ±ÿµŸäÿØ ÿßŸÑÿ≥ÿßŸÑÿ®
                    balanceContainer.innerHTML = `
                        <strong>ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑÿ¥Ÿáÿ±Ÿäÿ©:</strong>
                        <span id="monthlyLeaveBalance" style="color: #dc3545; font-weight: bold; font-size: 18px;">${monthlyBalance.toFixed(1)}</span> ŸäŸàŸÖ
                        <span style="color: #dc3545; font-size: 12px; display: block; margin-top: 5px;">‚ö†Ô∏è ÿßŸÑÿ±ÿµŸäÿØ ÿ≥ÿßŸÑÿ® - ÿ¨ŸÖŸäÿπ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ© ÿ≥ÿ™ŸÉŸàŸÜ "ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ®"</span>
                    `;
                } else if (monthlyBalance === 0) {
                    // ÿßŸÑÿ±ÿµŸäÿØ ÿµŸÅÿ±
                    balanceContainer.innerHTML = `
                        <strong>ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑÿ¥Ÿáÿ±Ÿäÿ©:</strong>
                        <span id="monthlyLeaveBalance" style="color: #ff9800; font-weight: bold; font-size: 18px;">${monthlyBalance.toFixed(1)}</span> ŸäŸàŸÖ
                        <span style="color: #ff9800; font-size: 12px; display: block; margin-top: 5px;">‚ö†Ô∏è ÿßŸÑÿ±ÿµŸäÿØ ÿµŸÅÿ± - ÿ¨ŸÖŸäÿπ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ© ÿ≥ÿ™ŸÉŸàŸÜ "ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ®"</span>
                    `;
                } else {
                    // ÿßŸÑÿ±ÿµŸäÿØ ŸÖŸàÿ¨ÿ®
                    balanceElement.textContent = monthlyBalance.toFixed(1);
                    balanceElement.style.color = '#28a745'; // ÿ£ÿÆÿ∂ÿ±
                }
            } else {
                // ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸáŸÜÿßŸÉ ÿ™ÿßÿ±ŸäÿÆ ÿ•ÿØÿ±ÿßÿ¨ÿå ŸÜÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ±ÿµŸäÿØ ÿßŸÑÿßÿ®ÿ™ÿØÿßÿ¶Ÿä ŸÅŸÇÿ∑
                const monthlyBalance = initialBalance;
                const balanceElement = document.getElementById('monthlyLeaveBalance');
                const balanceContainer = balanceElement.parentElement;
                
                if (monthlyBalance < 0) {
                    // ÿßŸÑÿ±ÿµŸäÿØ ÿßŸÑÿ≥ÿßŸÑÿ®
                    balanceContainer.innerHTML = `
                        <strong>ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑÿ¥Ÿáÿ±Ÿäÿ©:</strong>
                        <span id="monthlyLeaveBalance" style="color: #dc3545; font-weight: bold; font-size: 18px;">${monthlyBalance.toFixed(1)}</span> ŸäŸàŸÖ
                        <span style="color: #dc3545; font-size: 12px; display: block; margin-top: 5px;">‚ö†Ô∏è ÿßŸÑÿ±ÿµŸäÿØ ÿ≥ÿßŸÑÿ® - ÿ¨ŸÖŸäÿπ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ© ÿ≥ÿ™ŸÉŸàŸÜ "ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ®"</span>
                    `;
                } else if (monthlyBalance === 0) {
                    // ÿßŸÑÿ±ÿµŸäÿØ ÿµŸÅÿ±
                    balanceContainer.innerHTML = `
                        <strong>ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑÿ¥Ÿáÿ±Ÿäÿ©:</strong>
                        <span id="monthlyLeaveBalance" style="color: #ff9800; font-weight: bold; font-size: 18px;">${monthlyBalance.toFixed(1)}</span> ŸäŸàŸÖ
                        <span style="color: #ff9800; font-size: 12px; display: block; margin-top: 5px;">‚ö†Ô∏è ÿßŸÑÿ±ÿµŸäÿØ ÿµŸÅÿ± - ÿ¨ŸÖŸäÿπ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ© ÿ≥ÿ™ŸÉŸàŸÜ "ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ®"</span>
                    `;
                } else {
                    // ÿßŸÑÿ±ÿµŸäÿØ ŸÖŸàÿ¨ÿ®
                    balanceElement.textContent = monthlyBalance.toFixed(1);
                    balanceElement.style.color = '#28a745'; // ÿ£ÿÆÿ∂ÿ±
                }
            }

            // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖÿ© (ŸÖŸÜ ÿ®ÿØÿßŸäÿ© ÿßŸÑÿ¥Ÿáÿ± ÿßŸÑÿ≠ÿßŸÑŸä)
            let hourlyUsed = 0;
            const now = new Date();
            const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            
            const hourlyLeaves = leavesData.filter(l => 
                l.employeeId === employeeId && 
                l.type === 'hourly' && 
                l.status === 'approved'
            );
            
            hourlyLeaves.forEach(leave => {
                if (leave.startDate) {
                    const leaveDate = new Date(leave.startDate);
                    // ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ŸÅŸä ÿßŸÑÿ¥Ÿáÿ± ÿßŸÑÿ≠ÿßŸÑŸä
                    if (leaveDate >= firstDayOfMonth) {
                        hourlyUsed += (leave.hours || 0);
                    }
                }
            });
            
            const hourlyBalance = hourlyLeaveHours - hourlyUsed;
            const hourlyBalanceElement = document.getElementById('hourlyLeaveBalance');
            const hourlyBalanceContainer = hourlyBalanceElement.parentElement;
            
            if (hourlyBalance < 0) {
                // ÿßŸÑÿ±ÿµŸäÿØ ÿßŸÑÿ≥ÿßŸÑÿ®
                hourlyBalanceContainer.innerHTML = `
                    <strong>ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ©:</strong>
                    <span id="hourlyLeaveBalance" style="color: #dc3545; font-weight: bold; font-size: 18px;">${hourlyBalance.toFixed(1)}</span> ÿ≥ÿßÿπÿ©
                    <span style="color: #dc3545; font-size: 12px; display: block; margin-top: 5px;">‚ö†Ô∏è ÿßŸÑÿ±ÿµŸäÿØ ÿ≥ÿßŸÑÿ® - ÿ¨ŸÖŸäÿπ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ© ÿ≥ÿ™ŸÉŸàŸÜ "ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ®"</span>
                `;
            } else if (hourlyBalance === 0) {
                // ÿßŸÑÿ±ÿµŸäÿØ ÿµŸÅÿ±
                hourlyBalanceContainer.innerHTML = `
                    <strong>ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ©:</strong>
                    <span id="hourlyLeaveBalance" style="color: #ff9800; font-weight: bold; font-size: 18px;">${hourlyBalance.toFixed(1)}</span> ÿ≥ÿßÿπÿ©
                    <span style="color: #ff9800; font-size: 12px; display: block; margin-top: 5px;">‚ö†Ô∏è ÿßŸÑÿ±ÿµŸäÿØ ÿµŸÅÿ± - ÿ¨ŸÖŸäÿπ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ© ÿ≥ÿ™ŸÉŸàŸÜ "ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ®"</span>
                `;
            } else {
                // ÿßŸÑÿ±ÿµŸäÿØ ŸÖŸàÿ¨ÿ®
                hourlyBalanceElement.textContent = hourlyBalance.toFixed(1);
                hourlyBalanceElement.style.color = '#28a745'; // ÿ£ÿÆÿ∂ÿ±
            }

            // ÿπÿ±ÿ∂ ŸÇÿ≥ŸÖ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ©
            document.getElementById('leaveBalanceInfo').style.display = 'block';
        }

        function getLeaveStatusName(status) {
            const statuses = {
                'pending': 'ŸÇŸäÿØ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±',
                'approved': 'ŸÖŸàÿßŸÅŸÇ ÿπŸÑŸäŸáÿß',
                'rejected': 'ŸÖÿ±ŸÅŸàÿ∂ÿ©',
                'cancelled': 'ŸÖŸÑÿ∫ÿßÿ©'
            };
            return statuses[status] || status;
        }

        function getLeaveStatusBadge(status) {
            const badges = {
                'pending': 'badge-warning',
                'approved': 'badge-success',
                'rejected': 'badge-danger',
                'cancelled': 'badge-secondary'
            };
            return badges[status] || 'badge-secondary';
        }

        // ============================================
        // ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ±
        // ============================================
        let currentReportData = null;
        let currentReportType = null;

        // ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ
        async function generateEmployeeReport() {
            try {
                if (!window.db || !window.firestore) {
                    alert('Firebase ÿ∫Ÿäÿ± ŸÖŸáŸäÿ£');
                    return;
                }

                currentReportType = 'employees';
                const reportTitle = 'ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ';
                document.getElementById('reportTitle').textContent = reportTitle;
                
                const reportBody = document.getElementById('reportBody');
                reportBody.innerHTML = '<div class="loading">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...</div>';
                document.getElementById('reportContent').style.display = 'block';
                
                // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                await loadEmployees();
                
                const totalEmployees = employeesData.length;
                const activeEmployees = employeesData.filter(e => e.status === 'active').length;
                const inactiveEmployees = totalEmployees - activeEmployees;
                
                // ÿ™ÿ¨ŸÖŸäÿπ ÿ≠ÿ≥ÿ® ÿßŸÑŸÖÿ≥ŸÖŸâ ÿßŸÑŸàÿ∏ŸäŸÅŸä
                const byPosition = {};
                employeesData.forEach(emp => {
                    const position = emp.position || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
                    byPosition[position] = (byPosition[position] || 0) + 1;
                });
                
                // ÿ™ÿ¨ŸÖŸäÿπ ÿ≠ÿ≥ÿ® ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ÿßŸÑÿ≠ÿßŸÑŸä
                const byProject = {};
                employeesData.forEach(emp => {
                    if (emp.projectsHistory && emp.projectsHistory.length > 0) {
                        const currentProjects = emp.projectsHistory.filter(p => !p.endDate);
                        if (currentProjects.length > 0) {
                            currentProjects.forEach(p => {
                                const projectName = projectsData.find(pr => pr.id === p.projectId)?.name || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
                                byProject[projectName] = (byProject[projectName] || 0) + 1;
                            });
                        } else {
                            byProject['ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖÿ¥ÿ±Ÿàÿπ'] = (byProject['ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖÿ¥ÿ±Ÿàÿπ'] || 0) + 1;
                        }
                    } else {
                        byProject['ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖÿ¥ÿ±Ÿàÿπ'] = (byProject['ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖÿ¥ÿ±Ÿàÿπ'] || 0) + 1;
                    }
                });
                
                let html = `
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #667eea; margin-bottom: 20px;">üìä ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿπÿßŸÖÿ©</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2em; font-weight: bold; color: #667eea;">${totalEmployees}</div>
                                <div style="color: #666;">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ</div>
                            </div>
                            <div style="background: #d4edda; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2em; font-weight: bold; color: #28a745;">${activeEmployees}</div>
                                <div style="color: #666;">ŸÖŸàÿ∏ŸÅŸäŸÜ ŸÜÿ¥ÿ∑ŸäŸÜ</div>
                            </div>
                            <div style="background: #f8d7da; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2em; font-weight: bold; color: #dc3545;">${inactiveEmployees}</div>
                                <div style="color: #666;">ŸÖŸàÿ∏ŸÅŸäŸÜ ÿ∫Ÿäÿ± ŸÜÿ¥ÿ∑ŸäŸÜ</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #667eea; margin-bottom: 15px;">üìã ÿßŸÑÿ™Ÿàÿ≤Ÿäÿπ ÿ≠ÿ≥ÿ® ÿßŸÑŸÖÿ≥ŸÖŸâ ÿßŸÑŸàÿ∏ŸäŸÅŸä</h3>
                        <div class="table-container">
                            <table style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th>ÿßŸÑŸÖÿ≥ŸÖŸâ ÿßŸÑŸàÿ∏ŸäŸÅŸä</th>
                                        <th>ÿπÿØÿØ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ</th>
                                        <th>ÿßŸÑŸÜÿ≥ÿ®ÿ©</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                Object.entries(byPosition).sort((a, b) => b[1] - a[1]).forEach(([position, count]) => {
                    const percentage = ((count / totalEmployees) * 100).toFixed(1);
                    html += `
                        <tr>
                            <td>${position}</td>
                            <td>${count}</td>
                            <td>${percentage}%</td>
                        </tr>
                    `;
                });
                
                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #667eea; margin-bottom: 15px;">üìÅ ÿßŸÑÿ™Ÿàÿ≤Ÿäÿπ ÿ≠ÿ≥ÿ® ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ</h3>
                        <div class="table-container">
                            <table style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th>ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ</th>
                                        <th>ÿπÿØÿØ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ</th>
                                        <th>ÿßŸÑŸÜÿ≥ÿ®ÿ©</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                Object.entries(byProject).sort((a, b) => b[1] - a[1]).forEach(([project, count]) => {
                    const percentage = ((count / totalEmployees) * 100).toFixed(1);
                    html += `
                        <tr>
                            <td>${project}</td>
                            <td>${count}</td>
                            <td>${percentage}%</td>
                        </tr>
                    `;
                });
                
                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div>
                        <h3 style="color: #667eea; margin-bottom: 15px;">üìù ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ</h3>
                        <div class="table-container">
                            <table style="width: 100%; font-size: 14px;">
                                <thead>
                                    <tr>
                                        <th>ÿßŸÑÿ±ŸÇŸÖ</th>
                                        <th>ÿßŸÑÿßÿ≥ŸÖ</th>
                                        <th>ÿßŸÑŸÖÿ≥ŸÖŸâ ÿßŸÑŸàÿ∏ŸäŸÅŸä</th>
                                        <th>ÿßŸÑÿ≠ÿßŸÑÿ©</th>
                                        <th>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™Ÿàÿ∏ŸäŸÅ</th>
                                        <th>ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ÿßŸÑÿ≠ÿßŸÑŸä</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                employeesData.forEach((emp, index) => {
                    const currentProject = emp.projectsHistory?.find(p => !p.endDate);
                    const projectName = currentProject ? (projectsData.find(p => p.id === currentProject.projectId)?.name || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ') : 'ŸÑÿß ŸäŸàÿ¨ÿØ';
                    html += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${emp.name || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</td>
                            <td>${emp.position || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</td>
                            <td><span class="badge ${emp.status === 'active' ? 'badge-success' : 'badge-danger'}">${getEmployeeStatusName(emp.status)}</span></td>
                            <td>${emp.hireDate ? formatDate(emp.hireDate) : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</td>
                            <td>${projectName}</td>
                        </tr>
                    `;
                });
                
                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; text-align: center; color: #666; font-size: 12px;">
                        ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±: ${formatDateTime(new Date())}
                    </div>
                `;
                
                reportBody.innerHTML = html;
                currentReportData = { type: 'employees', data: employeesData };
                
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ŸàŸÑŸäÿØ ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ:', error);
                alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ŸàŸÑŸäÿØ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±: ' + error.message);
            }
        }

        // ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™
        async function generateLeaveReport() {
            try {
                if (!window.db || !window.firestore) {
                    alert('Firebase ÿ∫Ÿäÿ± ŸÖŸáŸäÿ£');
                    return;
                }

                currentReportType = 'leaves';
                const reportTitle = 'ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™';
                document.getElementById('reportTitle').textContent = reportTitle;
                
                const reportBody = document.getElementById('reportBody');
                reportBody.innerHTML = '<div class="loading">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...</div>';
                document.getElementById('reportContent').style.display = 'block';
                
                // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                await loadLeaves();
                await loadEmployees();
                
                const totalLeaves = leavesData.length;
                const approvedLeaves = leavesData.filter(l => l.status === 'approved').length;
                const pendingLeaves = leavesData.filter(l => l.status === 'pending').length;
                const rejectedLeaves = leavesData.filter(l => l.status === 'rejected').length;
                
                // ÿ™ÿ¨ŸÖŸäÿπ ÿ≠ÿ≥ÿ® ÿßŸÑŸÜŸàÿπ
                const byType = {};
                leavesData.forEach(leave => {
                    const type = getLeaveTypeName(leave.type, leave);
                    byType[type] = (byType[type] || 0) + 1;
                });
                
                // ÿ™ÿ¨ŸÖŸäÿπ ÿ≠ÿ≥ÿ® ÿßŸÑŸÖŸàÿ∏ŸÅ
                const byEmployee = {};
                leavesData.forEach(leave => {
                    const employee = employeesData.find(e => e.id === leave.employeeId);
                    const employeeName = employee?.name || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
                    if (!byEmployee[employeeName]) {
                        byEmployee[employeeName] = { total: 0, approved: 0, pending: 0, rejected: 0 };
                    }
                    byEmployee[employeeName].total++;
                    byEmployee[employeeName][leave.status]++;
                });
                
                let html = `
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #667eea; margin-bottom: 20px;">üìä ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿπÿßŸÖÿ©</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2em; font-weight: bold; color: #667eea;">${totalLeaves}</div>
                                <div style="color: #666;">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™</div>
                            </div>
                            <div style="background: #d4edda; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2em; font-weight: bold; color: #28a745;">${approvedLeaves}</div>
                                <div style="color: #666;">ŸÖŸàÿßŸÅŸÇ ÿπŸÑŸäŸáÿß</div>
                            </div>
                            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2em; font-weight: bold; color: #ffc107;">${pendingLeaves}</div>
                                <div style="color: #666;">ŸÇŸäÿØ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±</div>
                            </div>
                            <div style="background: #f8d7da; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2em; font-weight: bold; color: #dc3545;">${rejectedLeaves}</div>
                                <div style="color: #666;">ŸÖÿ±ŸÅŸàÿ∂ÿ©</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #667eea; margin-bottom: 15px;">üìã ÿßŸÑÿ™Ÿàÿ≤Ÿäÿπ ÿ≠ÿ≥ÿ® ŸÜŸàÿπ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ©</h3>
                        <div class="table-container">
                            <table style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th>ŸÜŸàÿπ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ©</th>
                                        <th>ÿßŸÑÿπÿØÿØ</th>
                                        <th>ÿßŸÑŸÜÿ≥ÿ®ÿ©</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                Object.entries(byType).forEach(([type, count]) => {
                    const percentage = ((count / totalLeaves) * 100).toFixed(1);
                    html += `
                        <tr>
                            <td>${type}</td>
                            <td>${count}</td>
                            <td>${percentage}%</td>
                        </tr>
                    `;
                });
                
                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #667eea; margin-bottom: 15px;">üë• ÿßŸÑÿ™Ÿàÿ≤Ÿäÿπ ÿ≠ÿ≥ÿ® ÿßŸÑŸÖŸàÿ∏ŸÅ</h3>
                        <div class="table-container">
                            <table style="width: 100%; font-size: 14px;">
                                <thead>
                                    <tr>
                                        <th>ÿßŸÑŸÖŸàÿ∏ŸÅ</th>
                                        <th>ÿ•ÿ¨ŸÖÿßŸÑŸä</th>
                                        <th>ŸÖŸàÿßŸÅŸÇ ÿπŸÑŸäŸáÿß</th>
                                        <th>ŸÇŸäÿØ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±</th>
                                        <th>ŸÖÿ±ŸÅŸàÿ∂ÿ©</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                Object.entries(byEmployee).sort((a, b) => b[1].total - a[1].total).forEach(([employee, stats]) => {
                    html += `
                        <tr>
                            <td>${employee}</td>
                            <td>${stats.total}</td>
                            <td><span style="color: #28a745;">${stats.approved}</span></td>
                            <td><span style="color: #ffc107;">${stats.pending}</span></td>
                            <td><span style="color: #dc3545;">${stats.rejected}</span></td>
                        </tr>
                    `;
                });
                
                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; text-align: center; color: #666; font-size: 12px;">
                        ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±: ${formatDateTime(new Date())}
                    </div>
                `;
                
                reportBody.innerHTML = html;
                currentReportData = { type: 'leaves', data: leavesData };
                
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ŸàŸÑŸäÿØ ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™:', error);
                alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ŸàŸÑŸäÿØ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±: ' + error.message);
            }
        }

        // ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿÆÿµŸàŸÖÿßÿ™ (ŸÖŸÇŸÅŸÑ ÿ®ŸÉŸÑŸÖÿ© ŸÖÿ±Ÿàÿ±)
        async function generateDeductionReport() {
            try {
                // ÿ∑ŸÑÿ® ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±
                const DEDUCTION_REPORT_PASSWORD = '1475963';
                const password = prompt('üîí Ÿáÿ∞ÿß ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ŸÖÿ≠ŸÖŸä ÿ®ŸÉŸÑŸÖÿ© ŸÖÿ±Ÿàÿ±\nÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ŸÑÿπÿ±ÿ∂ ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿÆÿµŸàŸÖÿßÿ™:');
                
                if (!password) {
                    return; // ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ£ŸÑÿ∫Ÿâ
                }
                
                if (password !== DEDUCTION_REPORT_PASSWORD) {
                    alert('‚ùå ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©');
                    return;
                }
                
                if (!window.db || !window.firestore) {
                    alert('Firebase ÿ∫Ÿäÿ± ŸÖŸáŸäÿ£');
                    return;
                }

                currentReportType = 'deduction';
                const reportTitle = 'ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿÆÿµŸàŸÖÿßÿ™ ÿßŸÑŸÖÿßŸÑŸäÿ©';
                document.getElementById('reportTitle').textContent = reportTitle;
                
                const reportBody = document.getElementById('reportBody');
                reportBody.innerHTML = '<div class="loading">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...</div>';
                document.getElementById('reportContent').style.display = 'block';
                
                // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                await loadEmployees();
                await loadLeaves();
                
                // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿÆÿµŸàŸÖÿßÿ™ ŸÖŸÜ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ®
                const deductionData = employeesData.map(emp => {
                    const unpaidLeaves = leavesData.filter(l => 
                        l.employeeId === emp.id && 
                        l.type === 'unpaid' && 
                        l.status === 'approved' &&
                        l.calculateDeduction !== false
                    );
                    
                    let totalDeduction = 0;
                    const leaveDetails = [];
                    
                    unpaidLeaves.forEach(leave => {
                        const deduction = calculateUnpaidLeaveDeduction(leave, emp);
                        if (deduction) {
                            totalDeduction += deduction;
                            leaveDetails.push({
                                leave: leave,
                                deduction: deduction,
                                currency: leave.salaryCurrencyAtLeave || emp.currentSalaryCurrency || 'IQD'
                            });
                        }
                    });
                    
                    return {
                        employee: emp,
                        currentSalary: emp.currentSalary || 0,
                        currentSalaryCurrency: emp.currentSalaryCurrency || 'IQD',
                        unpaidLeavesCount: unpaidLeaves.length,
                        totalDeduction: totalDeduction,
                        leaveDetails: leaveDetails
                    };
                }).filter(d => d.totalDeduction > 0); // ŸÅŸÇÿ∑ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ ÿßŸÑÿ∞ŸäŸÜ ŸÑÿØŸäŸáŸÖ ÿÆÿµŸàŸÖÿßÿ™
                
                const totalDeductions = deductionData.reduce((sum, d) => sum + d.totalDeduction, 0);
                const totalEmployeesWithDeductions = deductionData.length;
                
                let html = `
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #667eea; margin-bottom: 20px;">üìä ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿπÿßŸÖÿ©</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5em; font-weight: bold; color: #667eea;">${totalEmployeesWithDeductions}</div>
                                <div style="color: #666;">ÿπÿØÿØ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ ŸÖÿπ ÿÆÿµŸàŸÖÿßÿ™</div>
                            </div>
                            <div style="background: #f8d7da; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5em; font-weight: bold; color: #dc3545;">${formatCurrency(totalDeductions, 'IQD')}</div>
                                <div style="color: #666;">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿÆÿµŸàŸÖÿßÿ™</div>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h3 style="color: #667eea; margin-bottom: 15px;">üîí ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿÆÿµŸàŸÖÿßÿ™ ÿßŸÑŸÖÿßŸÑŸäÿ©</h3>
                        <div class="table-container">
                            <table style="width: 100%; font-size: 14px;">
                                <thead>
                                    <tr>
                                        <th>ÿßŸÑŸÖŸàÿ∏ŸÅ</th>
                                        <th>ÿ±ŸÇŸÖ ÿßŸÑŸÖŸàÿ∏ŸÅ</th>
                                        <th>ÿßŸÑÿ±ÿßÿ™ÿ® ÿßŸÑÿ≠ÿßŸÑŸä</th>
                                        <th>ÿπÿØÿØ ÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿ®ÿØŸàŸÜ ÿ±ÿßÿ™ÿ®</th>
                                        <th>ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿÆÿµŸàŸÖÿßÿ™</th>
                                        <th>ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                deductionData.forEach(d => {
                    const leaveDetailsHtml = d.leaveDetails.map(ld => {
                        const startDate = ld.leave.startDate || '-';
                        const endDate = ld.leave.endDate || '-';
                        const days = ld.leave.days || ld.leave.hours ? `${ld.leave.hours} ÿ≥ÿßÿπÿ©` : '-';
                        return `
                            <div style="margin-bottom: 8px; padding: 8px; background: #f8f9fa; border-radius: 5px; border-right: 3px solid #dc3545;">
                                <div><strong>ŸÖŸÜ:</strong> ${startDate} <strong>ÿ•ŸÑŸâ:</strong> ${endDate}</div>
                                <div><strong>ÿßŸÑŸÖÿØÿ©:</strong> ${days}</div>
                                <div><strong>ÿßŸÑÿÆÿµŸÖ:</strong> <span style="color: #dc3545; font-weight: bold;">${formatCurrency(ld.deduction, ld.currency)}</span></div>
                            </div>
                        `;
                    }).join('');
                    
                    html += `
                        <tr>
                            <td><strong>${d.employee.name || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</strong></td>
                            <td>${d.employee.employeeNumber || '-'}</td>
                            <td>${formatCurrency(d.currentSalary, d.currentSalaryCurrency)}</td>
                            <td>${d.unpaidLeavesCount}</td>
                            <td style="color: #dc3545; font-weight: bold; font-size: 1.1em;">${formatCurrency(d.totalDeduction, d.currentSalaryCurrency)}</td>
                            <td style="max-width: 400px;">${leaveDetailsHtml || '-'}</td>
                        </tr>
                    `;
                });
                
                if (deductionData.length === 0) {
                    html += `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
                                ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿÆÿµŸàŸÖÿßÿ™ ŸÖÿ≥ÿ¨ŸÑÿ©
                            </td>
                        </tr>
                    `;
                }
                
                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; text-align: center; color: #666; font-size: 12px;">
                        ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±: ${formatDateTime(new Date())}
                    </div>
                `;
                
                reportBody.innerHTML = html;
                currentReportData = { type: 'deduction', data: deductionData };
                
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ŸàŸÑŸäÿØ ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿÆÿµŸàŸÖÿßÿ™:', error);
                alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ŸàŸÑŸäÿØ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±: ' + error.message);
            }
        }

        // ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ
        async function generateProjectReport() {
            try {
                if (!window.db || !window.firestore) {
                    alert('Firebase ÿ∫Ÿäÿ± ŸÖŸáŸäÿ£');
                    return;
                }

                currentReportType = 'projects';
                const reportTitle = 'ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ';
                document.getElementById('reportTitle').textContent = reportTitle;
                
                const reportBody = document.getElementById('reportBody');
                reportBody.innerHTML = '<div class="loading">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...</div>';
                document.getElementById('reportContent').style.display = 'block';
                
                // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                await loadProjects();
                await loadEmployees();
                
                const totalProjects = projectsData.length;
                const activeProjects = projectsData.filter(p => p.status === 'active').length;
                const completedProjects = projectsData.filter(p => p.status === 'completed').length;
                
                // ÿ™ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ ÿ≠ÿ≥ÿ® ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ
                const projectEmployees = {};
                projectsData.forEach(project => {
                    projectEmployees[project.id] = [];
                });
                
                employeesData.forEach(emp => {
                    if (emp.projectsHistory) {
                        emp.projectsHistory.forEach(ph => {
                            if (!ph.endDate && projectEmployees[ph.projectId]) {
                                projectEmployees[ph.projectId].push(emp.name || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ');
                            }
                        });
                    }
                });
                
                let html = `
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #667eea; margin-bottom: 20px;">üìä ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿπÿßŸÖÿ©</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2em; font-weight: bold; color: #667eea;">${totalProjects}</div>
                                <div style="color: #666;">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ</div>
                            </div>
                            <div style="background: #d4edda; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2em; font-weight: bold; color: #28a745;">${activeProjects}</div>
                                <div style="color: #666;">ŸÖÿ¥ÿßÿ±Ÿäÿπ ŸÜÿ¥ÿ∑ÿ©</div>
                            </div>
                            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2em; font-weight: bold; color: #ffc107;">${completedProjects}</div>
                                <div style="color: #666;">ŸÖÿ¥ÿßÿ±Ÿäÿπ ŸÖŸÉÿ™ŸÖŸÑÿ©</div>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h3 style="color: #667eea; margin-bottom: 15px;">üìÅ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ</h3>
                        <div class="table-container">
                            <table style="width: 100%; font-size: 14px;">
                                <thead>
                                    <tr>
                                        <th>ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ</th>
                                        <th>ÿßŸÑÿ±ŸÖÿ≤</th>
                                        <th>ÿßŸÑÿ≠ÿßŸÑÿ©</th>
                                        <th>ÿπÿØÿØ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ</th>
                                        <th>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ®ÿØÿ°</th>
                                        <th>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ°</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                projectsData.forEach(project => {
                    const employees = projectEmployees[project.id] || [];
                    html += `
                        <tr>
                            <td>${project.name || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</td>
                            <td>${project.code || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</td>
                            <td><span class="badge ${project.status === 'active' ? 'badge-success' : 'badge-secondary'}">${project.status === 'active' ? 'ŸÜÿ¥ÿ∑' : 'ŸÖŸÉÿ™ŸÖŸÑ'}</span></td>
                            <td>${employees.length}</td>
                            <td>${project.startDate ? formatDate(project.startDate) : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</td>
                            <td>${project.endDate ? formatDate(project.endDate) : 'ŸÇŸäÿØ ÿßŸÑÿ™ŸÜŸÅŸäÿ∞'}</td>
                        </tr>
                    `;
                });
                
                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; text-align: center; color: #666; font-size: 12px;">
                        ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±: ${formatDateTime(new Date())}
                    </div>
                `;
                
                reportBody.innerHTML = html;
                currentReportData = { type: 'projects', data: projectsData };
                
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ŸàŸÑŸäÿØ ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ:', error);
                alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ŸàŸÑŸäÿØ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±: ' + error.message);
            }
        }

        // ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ™ŸÇŸäŸäŸÖÿßÿ™ ÿßŸÑÿ≥ŸÜŸàŸäÿ©
        async function generateEvaluationsReport() {
            try {
                if (!window.db || !window.firestore) {
                    alert('Firebase ÿ∫Ÿäÿ± ŸÖŸáŸäÿ£');
                    return;
                }

                currentReportType = 'evaluations';
                const reportTitle = 'ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ™ŸÇŸäŸäŸÖÿßÿ™ ÿßŸÑÿ≥ŸÜŸàŸäÿ©';
                document.getElementById('reportTitle').textContent = reportTitle;
                
                const reportBody = document.getElementById('reportBody');
                reportBody.innerHTML = '<div class="loading">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...</div>';
                document.getElementById('reportContent').style.display = 'block';
                
                // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                await loadEmployees();
                
                // ÿ™ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ŸÇŸäŸäŸÖÿßÿ™
                const evaluationsData = [];
                employeesData.forEach(emp => {
                    if (emp.evaluations && emp.evaluations.length > 0) {
                        emp.evaluations.forEach(evaluation => {
                            evaluationsData.push({
                                employee: emp,
                                evaluation: evaluation
                            });
                        });
                    }
                });
                
                // ÿ™ÿ±ÿ™Ÿäÿ® ÿ≠ÿ≥ÿ® ÿßŸÑÿ≥ŸÜÿ© (ÿßŸÑÿ£ÿ≠ÿØÿ´ ÿ£ŸàŸÑÿßŸã)
                evaluationsData.sort((a, b) => {
                    if (b.evaluation.year !== a.evaluation.year) {
                        return b.evaluation.year - a.evaluation.year;
                    }
                    return b.evaluation.rating - a.evaluation.rating;
                });
                
                const totalEvaluations = evaluationsData.length;
                const employeesWithEvaluations = new Set(evaluationsData.map(e => e.employee.id)).size;
                
                // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™
                const ratingStats = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
                const yearStats = {};
                evaluationsData.forEach(e => {
                    ratingStats[e.evaluation.rating] = (ratingStats[e.evaluation.rating] || 0) + 1;
                    const year = e.evaluation.year;
                    yearStats[year] = (yearStats[year] || 0) + 1;
                });
                
                const averageRating = totalEvaluations > 0 
                    ? (evaluationsData.reduce((sum, e) => sum + e.evaluation.rating, 0) / totalEvaluations).toFixed(2)
                    : 0;
                
                const ratingNames = {
                    1: { name: 'ÿ∂ÿπŸäŸÅ ÿ¨ÿØÿßŸã', color: '#dc3545', bg: '#f8d7da' },
                    2: { name: 'ÿ∂ÿπŸäŸÅ', color: '#fd7e14', bg: '#ffe5d0' },
                    3: { name: 'ŸÖŸÇÿ®ŸàŸÑ', color: '#ffc107', bg: '#fff3cd' },
                    4: { name: 'ÿ¨ŸäÿØ', color: '#28a745', bg: '#d4edda' },
                    5: { name: 'ŸÖŸÖÿ™ÿßÿ≤', color: '#20c997', bg: '#d1f2eb' }
                };
                
                let html = `
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #667eea; margin-bottom: 20px;">üìä ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿπÿßŸÖÿ©</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5em; font-weight: bold; color: #667eea;">${totalEvaluations}</div>
                                <div style="color: #666;">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ™ŸÇŸäŸäŸÖÿßÿ™</div>
                            </div>
                            <div style="background: #d4edda; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5em; font-weight: bold; color: #28a745;">${employeesWithEvaluations}</div>
                                <div style="color: #666;">ÿπÿØÿØ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ</div>
                            </div>
                            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5em; font-weight: bold; color: #ffc107;">${averageRating}</div>
                                <div style="color: #666;">ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑÿ™ŸÇŸäŸäŸÖ</div>
                            </div>
                        </div>
                        
                        <h4 style="color: #667eea; margin-bottom: 15px;">ÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ™ŸÇŸäŸäŸÖÿßÿ™</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px;">
                `;
                
                [5, 4, 3, 2, 1].forEach(rating => {
                    const count = ratingStats[rating] || 0;
                    const percentage = totalEvaluations > 0 ? ((count / totalEvaluations) * 100).toFixed(1) : 0;
                    const ratingInfo = ratingNames[rating];
                    html += `
                        <div style="background: ${ratingInfo.bg}; padding: 15px; border-radius: 8px; border-right: 4px solid ${ratingInfo.color};">
                            <div style="font-size: 1.2em; font-weight: bold; color: ${ratingInfo.color}; margin-bottom: 5px;">
                                ${'‚≠ê'.repeat(rating)}${'‚òÜ'.repeat(5 - rating)} (${rating}/5)
                            </div>
                            <div style="font-size: 1.5em; font-weight: bold; color: ${ratingInfo.color};">${count}</div>
                            <div style="color: #666; font-size: 12px;">${ratingInfo.name}</div>
                            <div style="color: #666; font-size: 11px; margin-top: 5px;">${percentage}%</div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                    
                    <div>
                        <h3 style="color: #667eea; margin-bottom: 15px;">‚≠ê ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ™ŸÇŸäŸäŸÖÿßÿ™ ÿßŸÑÿ≥ŸÜŸàŸäÿ©</h3>
                        <div class="table-container">
                            <table style="width: 100%; font-size: 14px;">
                                <thead>
                                    <tr>
                                        <th>ÿßŸÑŸÖŸàÿ∏ŸÅ</th>
                                        <th>ÿßŸÑÿ≥ŸÜÿ©</th>
                                        <th>ÿßŸÑÿ™ŸÇŸäŸäŸÖ</th>
                                        <th>ÿßŸÑŸàÿµŸÅ</th>
                                        <th>ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                if (evaluationsData.length === 0) {
                    html += `
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 40px; color: #666;">
                                ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ™ŸÇŸäŸäŸÖÿßÿ™ ÿ≥ŸÜŸàŸäÿ© ŸÖÿ≥ÿ¨ŸÑÿ©
                            </td>
                        </tr>
                    `;
                } else {
                    evaluationsData.forEach(e => {
                        const ratingInfo = ratingNames[e.evaluation.rating];
                        html += `
                            <tr>
                                <td><strong>${e.employee.name || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</strong><br><small style="color: #666;">${e.employee.employeeNumber || '-'}</small></td>
                                <td style="font-weight: bold; color: #667eea;">${e.evaluation.year}</td>
                                <td>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 18px;">${'‚≠ê'.repeat(e.evaluation.rating)}${'‚òÜ'.repeat(5 - e.evaluation.rating)}</span>
                                        <span style="font-weight: bold; color: ${ratingInfo.color}; background: ${ratingInfo.bg}; padding: 4px 10px; border-radius: 6px;">
                                            ${e.evaluation.rating}/5 - ${ratingInfo.name}
                                        </span>
                                    </div>
                                </td>
                                <td style="max-width: 300px;">${e.evaluation.description || '-'}</td>
                                <td style="max-width: 200px;">${e.evaluation.notes || '-'}</td>
                            </tr>
                        `;
                    });
                }
                
                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; text-align: center; color: #666; font-size: 12px;">
                        ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±: ${formatDateTime(new Date())}
                    </div>
                `;
                
                reportBody.innerHTML = html;
                currentReportData = { type: 'evaluations', data: evaluationsData };
                
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ŸàŸÑŸäÿØ ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ™ŸÇŸäŸäŸÖÿßÿ™ ÿßŸÑÿ≥ŸÜŸàŸäÿ©:', error);
                alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ŸàŸÑŸäÿØ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±: ' + error.message);
            }
        }

        // ÿ™ŸÇÿ±Ÿäÿ± ÿ•ÿ≠ÿµÿßÿ¶Ÿä ÿπÿßŸÖ
        async function generateStatisticsReport() {
            try {
                if (!window.db || !window.firestore) {
                    alert('Firebase ÿ∫Ÿäÿ± ŸÖŸáŸäÿ£');
                    return;
                }

                currentReportType = 'statistics';
                const reportTitle = 'ÿ™ŸÇÿ±Ÿäÿ± ÿ•ÿ≠ÿµÿßÿ¶Ÿä ÿπÿßŸÖ';
                document.getElementById('reportTitle').textContent = reportTitle;
                
                const reportBody = document.getElementById('reportBody');
                reportBody.innerHTML = '<div class="loading">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...</div>';
                document.getElementById('reportContent').style.display = 'block';
                
                // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                await loadEmployees();
                await loadLeaves();
                await loadProjects();
                await loadUsers();
                
                const totalEmployees = employeesData.length;
                const activeEmployees = employeesData.filter(e => e.status === 'active').length;
                const totalProjects = projectsData.length;
                const activeProjects = projectsData.filter(p => p.status === 'active').length;
                const totalLeaves = leavesData.length;
                const approvedLeaves = leavesData.filter(l => l.status === 'approved').length;
                const totalUsers = usersData.length;
                
                let html = `
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #667eea; margin-bottom: 20px;">üìä ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿ¥ÿßŸÖŸÑÿ©</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 3em; font-weight: bold; margin-bottom: 10px;">${totalEmployees}</div>
                                <div style="font-size: 1.2em;">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ</div>
                                <div style="font-size: 0.9em; opacity: 0.9; margin-top: 5px;">${activeEmployees} ŸÜÿ¥ÿ∑</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 3em; font-weight: bold; margin-bottom: 10px;">${totalProjects}</div>
                                <div style="font-size: 1.2em;">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ</div>
                                <div style="font-size: 0.9em; opacity: 0.9; margin-top: 5px;">${activeProjects} ŸÜÿ¥ÿ∑</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 3em; font-weight: bold; margin-bottom: 10px;">${totalLeaves}</div>
                                <div style="font-size: 1.2em;">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™</div>
                                <div style="font-size: 0.9em; opacity: 0.9; margin-top: 5px;">${approvedLeaves} ŸÖŸàÿßŸÅŸÇ ÿπŸÑŸäŸáÿß</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 3em; font-weight: bold; margin-bottom: 10px;">${totalUsers}</div>
                                <div style="font-size: 1.2em;">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; text-align: center; color: #666; font-size: 12px;">
                        ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±: ${formatDateTime(new Date())}
                    </div>
                `;
                
                reportBody.innerHTML = html;
                currentReportData = { type: 'statistics', data: { employees: totalEmployees, projects: totalProjects, leaves: totalLeaves, users: totalUsers } };
                
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ŸàŸÑŸäÿØ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿä:', error);
                alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ŸàŸÑŸäÿØ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±: ' + error.message);
            }
        }

        // ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±
        function closeReport() {
            document.getElementById('reportContent').style.display = 'none';
            currentReportData = null;
            currentReportType = null;
        }

        // ÿ∑ÿ®ÿßÿπÿ© ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±
        function printReport() {
            const reportContent = document.getElementById('reportContent');
            if (!reportContent || reportContent.style.display === 'none') {
                alert('ŸÑÿß ŸäŸàÿ¨ÿØ ÿ™ŸÇÿ±Ÿäÿ± ŸÑŸÑÿ∑ÿ®ÿßÿπÿ©');
                return;
            }

            // ÿ•ŸÜÿ¥ÿßÿ° ŸÜÿßŸÅÿ∞ÿ© ÿ∑ÿ®ÿßÿπÿ©
            const printWindow = window.open('', '_blank');
            const reportTitle = document.getElementById('reportTitle')?.textContent || 'ÿ™ŸÇÿ±Ÿäÿ±';
            const reportBody = document.getElementById('reportBody')?.innerHTML || '';

            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>${reportTitle}</title>
                    <style>
                        @media print {
                            @page {
                                size: A4;
                                margin: 1cm;
                            }
                        }
                        body {
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                            direction: rtl;
                            text-align: right;
                            padding: 20px;
                            color: #333;
                        }
                        h1, h2, h3 {
                            color: #667eea;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin: 15px 0;
                        }
                        table th, table td {
                            border: 1px solid #ddd;
                            padding: 8px;
                            text-align: right;
                        }
                        table th {
                            background-color: #667eea;
                            color: white;
                            font-weight: bold;
                        }
                        table tr:nth-child(even) {
                            background-color: #f9f9f9;
                        }
                        .org-chart-container {
                            page-break-inside: avoid;
                        }
                        .org-node {
                            page-break-inside: avoid;
                        }
                    </style>
                </head>
                <body>
                    <h1 style="text-align: center; margin-bottom: 30px;">${reportTitle}</h1>
                    <div style="text-align: center; margin-bottom: 20px; color: #666;">
                        ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±: ${formatDate(new Date(), { year: 'numeric', month: 'long', day: 'numeric' })}
                    </div>
                    ${reportBody}
                </body>
                </html>
            `);

            printWindow.document.close();
            printWindow.focus();
            
            // ÿßŸÜÿ™ÿ∏ÿßÿ± ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸàÿ± ÿ´ŸÖ ÿßŸÑÿ∑ÿ®ÿßÿπÿ©
            setTimeout(() => {
                printWindow.print();
                // ÿ®ÿπÿØ ÿßŸÑÿ∑ÿ®ÿßÿπÿ©: ŸÖÿ≥ÿ≠ ÿ®ŸäÿßŸÜÿßÿ™ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ Ÿàÿπÿ±ÿ∂ ŸÜÿßŸÅÿ∞ÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÅÿßÿ±ÿ∫ÿ©
                try {
                    localStorage.removeItem('hrm_remembered_email');
                    localStorage.removeItem('hrm_remembered_password');
                    localStorage.removeItem('hrm_remember_me');
                    sessionStorage.removeItem('hrm_manual_logout');
                } catch (e) {}
                if (typeof showLogin === 'function') showLogin();
            }, 500);
        }

        // ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿ•ŸÑŸâ PDF (ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ∑ÿ®ÿßÿπÿ©)
        function exportReportToPDF() {
            printReport();
        }

        // ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿ•ŸÑŸâ Excel
        function exportReportToExcel() {
            if (!currentReportData || !currentReportType) {
                alert('ŸÑÿß ŸäŸàÿ¨ÿØ ÿ™ŸÇÿ±Ÿäÿ± ŸÑŸÑÿ™ÿµÿØŸäÿ±');
                return;
            }

            if (typeof XLSX === 'undefined') {
                alert('ŸÖŸÉÿ™ÿ®ÿ© Excel ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±ÿ©. Ÿäÿ±ÿ¨Ÿâ ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©.');
                return;
            }

            try {
                const reportTitle = document.getElementById('reportTitle')?.textContent || 'ÿ™ŸÇÿ±Ÿäÿ±';
                const workbook = XLSX.utils.book_new();
                let fileName = reportTitle;

                switch (currentReportType) {
                    case 'employees':
                        exportEmployeesToExcel(workbook, currentReportData);
                        fileName = 'ÿ™ŸÇÿ±Ÿäÿ±_ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ';
                        break;
                    case 'leaves':
                        exportLeavesToExcel(workbook, currentReportData);
                        fileName = 'ÿ™ŸÇÿ±Ÿäÿ±_ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™';
                        break;
                    case 'deduction':
                        exportDeductionsToExcel(workbook, currentReportData);
                        fileName = 'ÿ™ŸÇÿ±Ÿäÿ±_ÿßŸÑÿÆÿµŸàŸÖÿßÿ™';
                        break;
                    case 'projects':
                        exportProjectsToExcel(workbook, currentReportData);
                        fileName = 'ÿ™ŸÇÿ±Ÿäÿ±_ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ';
                        break;
                    case 'evaluations':
                        exportEvaluationsToExcel(workbook, currentReportData);
                        fileName = 'ÿ™ŸÇÿ±Ÿäÿ±_ÿßŸÑÿ™ŸÇŸäŸäŸÖÿßÿ™';
                        break;
                    case 'statistics':
                        exportStatisticsToExcel(workbook, currentReportData);
                        fileName = 'ÿ™ŸÇÿ±Ÿäÿ±_ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™';
                        break;
                    case 'companyStructure':
                        exportCompanyStructureToExcel(workbook, currentReportData);
                        fileName = 'ÿ™ŸÇÿ±Ÿäÿ±_ŸáŸäŸÉŸÑ_ÿßŸÑÿ¥ÿ±ŸÉÿ©';
                        break;
                    case 'employeeLeaveHistory':
                        exportEmployeeLeaveHistoryToExcel(workbook, currentReportData);
                        fileName = 'ÿ™ŸÇÿ±Ÿäÿ±_ÿ™ÿßÿ±ŸäÿÆ_ÿ•ÿ¨ÿßÿ≤ÿßÿ™_ÿßŸÑŸÖŸàÿ∏ŸÅ';
                        break;
                    case 'projectEmployees':
                        exportProjectEmployeesToExcel(workbook, currentReportData);
                        fileName = 'ÿ™ŸÇÿ±Ÿäÿ±_ŸÖŸàÿ∏ŸÅŸä_ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ';
                        break;
                    case 'employeeProjectsHistory':
                        exportEmployeeProjectsHistoryToExcel(workbook, currentReportData);
                        fileName = 'ÿ™ŸÇÿ±Ÿäÿ±_ÿ™ÿßÿ±ŸäÿÆ_ŸÖÿ¥ÿßÿ±Ÿäÿπ_ÿßŸÑŸÖŸàÿ∏ŸÅ';
                        break;
                    default:
                        alert('ŸÜŸàÿπ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿ∫Ÿäÿ± ŸÖÿØÿπŸàŸÖ ŸÑŸÑÿ™ÿµÿØŸäÿ±');
                        return;
                }

                // ÿ™ÿµÿØŸäÿ± ÿßŸÑŸÖŸÑŸÅ
                const dateStr = new Date().toISOString().split('T')[0];
                XLSX.writeFile(workbook, `${fileName}_${dateStr}.xlsx`);
                alert('‚úÖ ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿ®ŸÜÿ¨ÿßÿ≠!');
                // ŸÖÿ≥ÿ≠ ÿ®ŸäÿßŸÜÿßÿ™ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ© Ÿàÿπÿ±ÿ∂ ŸÜÿßŸÅÿ∞ÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÅÿßÿ±ÿ∫ÿ©
                try {
                    localStorage.removeItem('hrm_remembered_email');
                    localStorage.removeItem('hrm_remembered_password');
                    localStorage.removeItem('hrm_remember_me');
                    sessionStorage.removeItem('hrm_manual_logout');
                } catch (e) {}
                if (typeof showLogin === 'function') showLogin();
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿµÿØŸäÿ± Excel:', error);
                alert('‚ùå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±: ' + error.message);
            }
        }

        // ÿ™ÿµÿØŸäÿ± ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ ÿ•ŸÑŸâ Excel
        function exportEmployeesToExcel(workbook, reportData) {
            const data = reportData.data || [];
            
            // Ÿàÿ±ŸÇÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©
            const mainData = data.map(emp => ({
                'ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑŸàÿ∏ŸäŸÅŸä': emp.employeeNumber || '',
                'ÿßŸÑÿßÿ≥ŸÖ': emp.name || '',
                'ÿßŸÑÿßÿ≥ŸÖ ÿ®ÿßŸÑÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ©': emp.nameEn || '',
                'ÿßŸÑŸÖÿ≥ŸÖŸâ ÿßŸÑŸàÿ∏ŸäŸÅŸä': emp.position || '',
                'ÿßŸÑŸÇÿ≥ŸÖ': departmentsData.find(d => d.id === emp.departmentId)?.name || '',
                'ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ÿßŸÑÿ≠ÿßŸÑŸä': getCurrentProjectName(emp) || '',
                'ŸÖŸÉÿßŸÜ ÿßŸÑÿπŸÖŸÑ': regionsData.find(r => r.id === emp.workLocationId)?.name || '',
                'ÿßŸÑÿ≠ÿßŸÑÿ©': emp.status === 'active' ? 'ŸÜÿ¥ÿ∑' : 'ÿ∫Ÿäÿ± ŸÜÿ¥ÿ∑',
                'ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿπŸäŸäŸÜ': emp.hireDate ? formatDate(emp.hireDate) : '',
                'ÿßŸÑÿ±ÿßÿ™ÿ®': emp.salary || 0,
                'ÿßŸÑÿπŸÖŸÑÿ©': emp.currency || 'IQD',
                'ÿßŸÑŸáÿßÿ™ŸÅ': emp.phone || '',
                'ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä': emp.email || '',
                'ÿßŸÑÿπŸÜŸàÿßŸÜ': emp.address || ''
            }));

            const ws1 = XLSX.utils.json_to_sheet(mainData);
            XLSX.utils.book_append_sheet(workbook, ws1, 'ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ');

            // ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™
            const totalEmployees = data.length;
            const activeEmployees = data.filter(e => e.status === 'active').length;
            const inactiveEmployees = totalEmployees - activeEmployees;

            const stats = [
                ['ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿ©', 'ÿßŸÑŸÇŸäŸÖÿ©'],
                ['ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ', totalEmployees],
                ['ŸÖŸàÿ∏ŸÅŸäŸÜ ŸÜÿ¥ÿ∑ŸäŸÜ', activeEmployees],
                ['ŸÖŸàÿ∏ŸÅŸäŸÜ ÿ∫Ÿäÿ± ŸÜÿ¥ÿ∑ŸäŸÜ', inactiveEmployees]
            ];

            const ws2 = XLSX.utils.aoa_to_sheet(stats);
            XLSX.utils.book_append_sheet(workbook, ws2, 'ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™');
        }

        // ÿ™ÿµÿØŸäÿ± ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿ•ŸÑŸâ Excel
        function exportLeavesToExcel(workbook, reportData) {
            const data = reportData.data || [];
            
            const mainData = data.map(leave => {
                const employee = employeesData.find(e => e.id === leave.employeeId);
                const leaveTypeName = getLeaveTypeName(leave.type, leave);
                const region = leave.regionId ? regionsData.find(r => r.id === leave.regionId) : null;
                
                return {
                    'ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑŸàÿ∏ŸäŸÅŸä': employee?.employeeNumber || '',
                    'ÿßÿ≥ŸÖ ÿßŸÑŸÖŸàÿ∏ŸÅ': employee?.name || '',
                    'ŸÜŸàÿπ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ©': leaveTypeName,
                    'ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©': region?.name || '',
                    'ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ®ÿØÿßŸäÿ©': leave.startDate ? formatDate(leave.startDate) : '',
                    'ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÜŸáÿßŸäÿ©': leave.endDate ? formatDate(leave.endDate) : '',
                    'ÿπÿØÿØ ÿßŸÑÿ£ŸäÿßŸÖ': leave.days || 0,
                    'ÿßŸÑÿ≠ÿßŸÑÿ©': leave.status === 'approved' ? 'ŸÖŸàÿßŸÅŸÇ ÿπŸÑŸäŸáÿß' : leave.status === 'rejected' ? 'ŸÖÿ±ŸÅŸàÿ∂ÿ©' : 'ŸÇŸäÿØ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±',
                    'ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ∑ŸÑÿ®': leave.requestDate ? formatDate(leave.requestDate) : '',
                    'ÿßŸÑÿ≥ÿ®ÿ®': leave.reason || ''
                };
            });

            const ws1 = XLSX.utils.json_to_sheet(mainData);
            XLSX.utils.book_append_sheet(workbook, ws1, 'ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™');

            // ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™
            const totalLeaves = data.length;
            const approvedLeaves = data.filter(l => l.status === 'approved').length;
            const pendingLeaves = data.filter(l => l.status === 'pending').length;
            const rejectedLeaves = data.filter(l => l.status === 'rejected').length;

            const stats = [
                ['ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿ©', 'ÿßŸÑŸÇŸäŸÖÿ©'],
                ['ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™', totalLeaves],
                ['ŸÖŸàÿßŸÅŸÇ ÿπŸÑŸäŸáÿß', approvedLeaves],
                ['ŸÇŸäÿØ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±', pendingLeaves],
                ['ŸÖÿ±ŸÅŸàÿ∂ÿ©', rejectedLeaves]
            ];

            const ws2 = XLSX.utils.aoa_to_sheet(stats);
            XLSX.utils.book_append_sheet(workbook, ws2, 'ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™');
        }

        // ÿ™ÿµÿØŸäÿ± ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿÆÿµŸàŸÖÿßÿ™ ÿ•ŸÑŸâ Excel
        function exportDeductionsToExcel(workbook, reportData) {
            const data = reportData.data || [];
            
            const mainData = data.map(deduction => {
                const employee = employeesData.find(e => e.id === deduction.employeeId);
                return {
                    'ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑŸàÿ∏ŸäŸÅŸä': employee?.employeeNumber || '',
                    'ÿßÿ≥ŸÖ ÿßŸÑŸÖŸàÿ∏ŸÅ': employee?.name || '',
                    'ŸÜŸàÿπ ÿßŸÑÿÆÿµŸÖ': deduction.type || '',
                    'ÿßŸÑŸÖÿ®ŸÑÿ∫': deduction.amount || 0,
                    'ÿßŸÑÿπŸÖŸÑÿ©': deduction.currency || 'IQD',
                    'ÿßŸÑÿ™ÿßÿ±ŸäÿÆ': deduction.date ? formatDate(deduction.date) : '',
                    'ÿßŸÑÿ≥ÿ®ÿ®': deduction.reason || '',
                    'ÿßŸÑÿ≠ÿßŸÑÿ©': deduction.status || ''
                };
            });

            const ws1 = XLSX.utils.json_to_sheet(mainData);
            XLSX.utils.book_append_sheet(workbook, ws1, 'ÿßŸÑÿÆÿµŸàŸÖÿßÿ™');

            // ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿÆÿµŸàŸÖÿßÿ™
            const totalAmount = data.reduce((sum, d) => sum + (parseFloat(d.amount) || 0), 0);
            const stats = [
                ['ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿ©', 'ÿßŸÑŸÇŸäŸÖÿ©'],
                ['ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿÆÿµŸàŸÖÿßÿ™', totalAmount],
                ['ÿπÿØÿØ ÿßŸÑÿÆÿµŸàŸÖÿßÿ™', data.length]
            ];

            const ws2 = XLSX.utils.aoa_to_sheet(stats);
            XLSX.utils.book_append_sheet(workbook, ws2, 'ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™');
        }

        // ÿ™ÿµÿØŸäÿ± ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ ÿ•ŸÑŸâ Excel
        function exportProjectsToExcel(workbook, reportData) {
            const data = reportData.data || [];
            
            const mainData = data.map(project => {
                const region = regionsData.find(r => r.id === project.regionId);
                return {
                    'ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ': project.name || '',
                    'ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ÿ®ÿßŸÑÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ©': project.nameEn || '',
                    'ÿ±ŸÖÿ≤ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ': project.code || '',
                    'ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©': region?.name || '',
                    'ÿßŸÑÿ≠ÿßŸÑÿ©': project.status || '',
                    'ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ®ÿØÿ°': project.startDate ? formatDate(project.startDate) : '',
                    'ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ°': project.endDate ? formatDate(project.endDate) : '',
                    'ÿßŸÑŸÖŸäÿ≤ÿßŸÜŸäÿ©': project.budget || 0,
                    'ÿßŸÑÿπŸÖŸÑÿ©': project.currency || 'IQD',
                    'ÿßŸÑŸàÿµŸÅ': project.description || ''
                };
            });

            const ws1 = XLSX.utils.json_to_sheet(mainData);
            XLSX.utils.book_append_sheet(workbook, ws1, 'ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ');
        }

        // ÿ™ÿµÿØŸäÿ± ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ™ŸÇŸäŸäŸÖÿßÿ™ ÿ•ŸÑŸâ Excel
        function exportEvaluationsToExcel(workbook, reportData) {
            const data = reportData.data || [];
            
            const mainData = data.map(evaluation => {
                const employee = employeesData.find(e => e.id === evaluation.employeeId);
                return {
                    'ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑŸàÿ∏ŸäŸÅŸä': employee?.employeeNumber || '',
                    'ÿßÿ≥ŸÖ ÿßŸÑŸÖŸàÿ∏ŸÅ': employee?.name || '',
                    'ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ŸÇŸäŸäŸÖ': evaluation.date ? formatDate(evaluation.date) : '',
                    'ÿßŸÑÿ™ŸÇŸäŸäŸÖ': evaluation.rating || 0,
                    'ÿßŸÑÿ™ÿπŸÑŸäŸÇÿßÿ™': evaluation.comments || ''
                };
            });

            const ws1 = XLSX.utils.json_to_sheet(mainData);
            XLSX.utils.book_append_sheet(workbook, ws1, 'ÿßŸÑÿ™ŸÇŸäŸäŸÖÿßÿ™');
        }

        // ÿ™ÿµÿØŸäÿ± ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿ•ŸÑŸâ Excel
        function exportStatisticsToExcel(workbook, reportData) {
            const stats = [
                ['ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿ©', 'ÿßŸÑŸÇŸäŸÖÿ©'],
                ['ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ', reportData.data?.employees || 0],
                ['ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ', reportData.data?.projects || 0],
                ['ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™', reportData.data?.leaves || 0],
                ['ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ', reportData.data?.users || 0]
            ];

            const ws = XLSX.utils.aoa_to_sheet(stats);
            XLSX.utils.book_append_sheet(workbook, ws, 'ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™');
        }

        // ÿ™ÿµÿØŸäÿ± ÿ™ŸÇÿ±Ÿäÿ± ŸáŸäŸÉŸÑ ÿßŸÑÿ¥ÿ±ŸÉÿ© ÿ•ŸÑŸâ Excel
        function exportCompanyStructureToExcel(workbook, reportData) {
            const structure = reportData.data || {};
            const rows = [];

            // ÿßŸÑÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿπÿßŸÖÿ©
            rows.push(['ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ', 'ÿßŸÑŸÜŸàÿπ', 'ÿßŸÑÿßÿ≥ŸÖ', 'ÿßŸÑÿ±ŸÖÿ≤', 'ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©', 'ÿπÿØÿØ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ', 'ÿπÿØÿØ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ']);

            // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ
            Object.values(structure).forEach(({ region, projects }) => {
                rows.push(['ŸÖŸÜÿ∑ŸÇÿ©', region.name, region.nameEn || '', region.code || '', '', '', '']);

                // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ
                projects.forEach(project => {
                    const deptCount = project.departments ? project.departments.length : 0;
                    const empCount = project.departments ? project.departments.reduce((sum, d) => sum + (d.employees ? d.employees.length : 0), 0) : 0;
                    rows.push(['ŸÖÿ¥ÿ±Ÿàÿπ', project.name, project.nameEn || '', project.code || '', region.name, deptCount, empCount]);

                    // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ
                    if (project.departments) {
                        project.departments.forEach(dept => {
                            const empCount = dept.employees ? dept.employees.length : 0;
                            rows.push(['ŸÇÿ≥ŸÖ', dept.name, dept.nameEn || '', '', region.name, '', empCount]);
                        });
                    }
                });
            });

            const ws = XLSX.utils.aoa_to_sheet(rows);
            XLSX.utils.book_append_sheet(workbook, ws, 'ŸáŸäŸÉŸÑ ÿßŸÑÿ¥ÿ±ŸÉÿ©');
        }

        // ÿ™ÿµÿØŸäÿ± ÿ™ŸÇÿ±Ÿäÿ± ÿ™ÿßÿ±ŸäÿÆ ÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑŸÖŸàÿ∏ŸÅ ÿ•ŸÑŸâ Excel
        function exportEmployeeLeaveHistoryToExcel(workbook, reportData) {
            const { employee, leaves } = reportData.data || {};
            
            // ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖŸàÿ∏ŸÅ
            const employeeInfo = [
                ['ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖŸàÿ∏ŸÅ', ''],
                ['ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑŸàÿ∏ŸäŸÅŸä', employee?.employeeNumber || ''],
                ['ÿßŸÑÿßÿ≥ŸÖ', employee?.name || ''],
                ['ÿßŸÑŸÖÿ≥ŸÖŸâ ÿßŸÑŸàÿ∏ŸäŸÅŸä', employee?.position || ''],
                ['', '']
            ];

            // ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™
            const leaveData = leaves.map(leave => {
                const leaveTypeName = getLeaveTypeName(leave.type, leave);
                const region = leave.regionId ? regionsData.find(r => r.id === leave.regionId) : null;
                
                return {
                    'ŸÜŸàÿπ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ©': leaveTypeName,
                    'ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©': region?.name || '',
                    'ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ®ÿØÿßŸäÿ©': leave.startDate ? formatDate(leave.startDate) : '',
                    'ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÜŸáÿßŸäÿ©': leave.endDate ? formatDate(leave.endDate) : '',
                    'ÿπÿØÿØ ÿßŸÑÿ£ŸäÿßŸÖ': leave.days || 0,
                    'ÿßŸÑÿ≠ÿßŸÑÿ©': leave.status === 'approved' ? 'ŸÖŸàÿßŸÅŸÇ ÿπŸÑŸäŸáÿß' : leave.status === 'rejected' ? 'ŸÖÿ±ŸÅŸàÿ∂ÿ©' : 'ŸÇŸäÿØ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±',
                    'ÿßŸÑÿ≥ÿ®ÿ®': leave.reason || ''
                };
            });

            const ws1 = XLSX.utils.aoa_to_sheet(employeeInfo);
            XLSX.utils.book_append_sheet(workbook, ws1, 'ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖŸàÿ∏ŸÅ');

            const ws2 = XLSX.utils.json_to_sheet(leaveData);
            XLSX.utils.book_append_sheet(workbook, ws2, 'ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™');
        }

        // ÿ™ÿµÿØŸäÿ± ÿ™ŸÇÿ±Ÿäÿ± ŸÖŸàÿ∏ŸÅŸä ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ÿ•ŸÑŸâ Excel
        function exportProjectEmployeesToExcel(workbook, reportData) {
            const { project, employees } = reportData.data || {};
            
            // ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ
            const projectInfo = [
                ['ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ', ''],
                ['ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ', project?.name || ''],
                ['ÿ±ŸÖÿ≤ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ', project?.code || ''],
                ['', '']
            ];

            // ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ
            const employeeData = employees.map(emp => ({
                'ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑŸàÿ∏ŸäŸÅŸä': emp.employeeNumber || '',
                'ÿßŸÑÿßÿ≥ŸÖ': emp.name || '',
                'ÿßŸÑŸÖÿ≥ŸÖŸâ ÿßŸÑŸàÿ∏ŸäŸÅŸä': emp.position || '',
                'ÿßŸÑŸÇÿ≥ŸÖ': departmentsData.find(d => d.id === emp.departmentId)?.name || '',
                'ÿßŸÑÿ≠ÿßŸÑÿ©': emp.status === 'active' ? 'ŸÜÿ¥ÿ∑' : 'ÿ∫Ÿäÿ± ŸÜÿ¥ÿ∑'
            }));

            const ws1 = XLSX.utils.aoa_to_sheet(projectInfo);
            XLSX.utils.book_append_sheet(workbook, ws1, 'ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ');

            const ws2 = XLSX.utils.json_to_sheet(employeeData);
            XLSX.utils.book_append_sheet(workbook, ws2, 'ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ');
        }

        // ÿ™ÿµÿØŸäÿ± ÿ™ŸÇÿ±Ÿäÿ± ÿ™ÿßÿ±ŸäÿÆ ŸÖÿ¥ÿßÿ±Ÿäÿπ ÿßŸÑŸÖŸàÿ∏ŸÅ ÿ•ŸÑŸâ Excel
        function exportEmployeeProjectsHistoryToExcel(workbook, reportData) {
            const { employee, projectsHistory } = reportData.data || {};
            
            // ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖŸàÿ∏ŸÅ
            const employeeInfo = [
                ['ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖŸàÿ∏ŸÅ', ''],
                ['ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑŸàÿ∏ŸäŸÅŸä', employee?.employeeNumber || ''],
                ['ÿßŸÑÿßÿ≥ŸÖ', employee?.name || ''],
                ['ÿßŸÑŸÖÿ≥ŸÖŸâ ÿßŸÑŸàÿ∏ŸäŸÅŸä', employee?.position || ''],
                ['', '']
            ];

            // ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ
            const projectData = projectsHistory.map(ph => {
                const project = projectsData.find(p => p.id === ph.projectId);
                return {
                    'ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ': project?.name || '',
                    'ÿ±ŸÖÿ≤ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ': project?.code || '',
                    'ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ®ÿØÿ°': ph.startDate ? formatDate(ph.startDate) : '',
                    'ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ°': ph.endDate ? formatDate(ph.endDate) : '',
                    'ÿßŸÑÿ≠ÿßŸÑÿ©': ph.endDate ? 'ŸÖŸÜÿ™ŸáŸä' : 'ŸÜÿ¥ÿ∑'
                };
            });

            const ws1 = XLSX.utils.aoa_to_sheet(employeeInfo);
            XLSX.utils.book_append_sheet(workbook, ws1, 'ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖŸàÿ∏ŸÅ');

            const ws2 = XLSX.utils.json_to_sheet(projectData);
            XLSX.utils.book_append_sheet(workbook, ws2, 'ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ');
        }

        // ÿØÿßŸÑÿ© ŸÖÿ≥ÿßÿπÿØÿ© ŸÑŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ÿßŸÑÿ≠ÿßŸÑŸä
        function getCurrentProjectName(employee) {
            if (!employee.projectsHistory || employee.projectsHistory.length === 0) {
                return '';
            }
            const currentProject = employee.projectsHistory.find(p => !p.endDate);
            if (!currentProject) {
                return '';
            }
            const project = projectsData.find(p => p.id === currentProject.projectId);
            return project?.name || '';
        }

        // ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑÿπŸÖŸÑÿ©
        function formatCurrency(amount, currency) {
            if (!amount) return '0';
            const formatted = formatNumber(amount);
            return currency === 'USD' ? `$${formatted}` : `${formatted} ÿØ.ÿπ`;
        }

        // ÿßŸÑŸÖŸàÿßŸÅŸÇÿ© ÿπŸÑŸâ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ©
        async function approveLeave(id) {
            if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑŸÖŸàÿßŸÅŸÇÿ© ÿπŸÑŸâ Ÿáÿ∞Ÿá ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ©ÿü')) {
                return;
            }

            if (!window.db || !window.firestore) {
                alert('Firebase ÿ∫Ÿäÿ± ŸÖŸáŸäÿ£');
                return;
            }

            try {
                await window.firestore.updateDoc(
                    window.firestore.doc(window.db, 'leaves', id),
                    {
                        status: 'approved',
                        approvedAt: window.firestore.serverTimestamp(),
                        approvedBy: currentUser?.uid || 'system'
                    }
                );

                alert('‚úÖ ÿ™ŸÖ ÿßŸÑŸÖŸàÿßŸÅŸÇÿ© ÿπŸÑŸâ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿ®ŸÜÿ¨ÿßÿ≠!');
                await loadLeaves();
            } catch (error) {
                alert('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑŸÖŸàÿßŸÅŸÇÿ© ÿπŸÑŸâ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ©: ' + error.message);
                console.error(error);
            }
        }

        // ÿ±ŸÅÿ∂ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ©
        async function rejectLeave(id) {
            const reason = prompt('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿ≥ÿ®ÿ® ÿßŸÑÿ±ŸÅÿ∂ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä):');
            if (reason === null) {
                return; // ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ£ŸÑÿ∫Ÿâ ÿßŸÑÿπŸÖŸÑŸäÿ©
            }

            if (!window.db || !window.firestore) {
                alert('Firebase ÿ∫Ÿäÿ± ŸÖŸáŸäÿ£');
                return;
            }

            try {
                const updateData = {
                    status: 'rejected',
                    rejectedAt: window.firestore.serverTimestamp(),
                    rejectedBy: currentUser?.uid || 'system'
                };
                
                if (reason && reason.trim()) {
                    updateData.rejectionReason = reason.trim();
                }

                await window.firestore.updateDoc(
                    window.firestore.doc(window.db, 'leaves', id),
                    updateData
                );

                alert('‚úÖ ÿ™ŸÖ ÿ±ŸÅÿ∂ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ© ÿ®ŸÜÿ¨ÿßÿ≠!');
                await loadLeaves();
            } catch (error) {
                alert('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ±ŸÅÿ∂ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ©: ' + error.message);
                console.error(error);
            }
        }

        // ============================================
        // ŸÜÿßŸÅÿ∞ÿ© ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ
        // ============================================
        
        // ÿ•ÿ∏Ÿáÿßÿ± ŸÜÿßŸÅÿ∞ÿ© ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ
        async function showEmployeeReportModal() {
            const modal = document.getElementById('employeeReportModal');
            if (modal) {
                // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ ŸÑÿ™ÿπÿ®ÿ¶ÿ© ÿßŸÑŸÇÿßÿ¶ŸÖÿ©
                await loadProjects();
                
                // ÿ™ÿ≠ÿØŸäÿ´ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ
                const projectSelect = document.getElementById('reportProjectFilter');
                if (projectSelect) {
                    projectSelect.innerHTML = '<option value="">ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ</option>';
                    projectsData.forEach(project => {
                        const option = document.createElement('option');
                        option.value = project.id;
                        option.textContent = project.name || project.code || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
                        projectSelect.appendChild(option);
                    });
                }
                
                modal.classList.add('active');
                // ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÇŸäŸÖ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©
                const today = new Date();
                const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                const startDateInput = document.getElementById('reportStartDate');
                const endDateInput = document.getElementById('reportEndDate');
                if (startDateInput) startDateInput.value = firstDayOfMonth.toISOString().split('T')[0];
                if (endDateInput) endDateInput.value = today.toISOString().split('T')[0];
                
                const statusFilter = document.getElementById('reportStatusFilter');
                const positionFilter = document.getElementById('reportPositionFilter');
                const projectFilter = document.getElementById('reportProjectFilter');
                if (statusFilter) statusFilter.value = '';
                if (positionFilter) positionFilter.value = '';
                if (projectFilter) projectFilter.value = '';
            }
        }

        // ÿ•ÿÆŸÅÿßÿ° ŸÜÿßŸÅÿ∞ÿ© ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ
        function hideEmployeeReportModal() {
            const modal = document.getElementById('employeeReportModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        // ÿ™ŸàŸÑŸäÿØ ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ ŸÖÿπ ÿßŸÑÿÆŸäÿßÿ±ÿßÿ™
        async function generateEmployeeReportWithFilters() {
            try {
                if (!window.db || !window.firestore) {
                    alert('Firebase ÿ∫Ÿäÿ± ŸÖŸáŸäÿ£');
                    return;
                }

                const startDate = document.getElementById('reportStartDate').value;
                const endDate = document.getElementById('reportEndDate').value;
                const statusFilter = document.getElementById('reportStatusFilter').value;
                const positionFilter = document.getElementById('reportPositionFilter').value;
                const projectFilter = document.getElementById('reportProjectFilter').value;

                // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÜÿßŸÅÿ∞ÿ©
                hideEmployeeReportModal();

                currentReportType = 'employees';
                const reportTitle = 'ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ';
                document.getElementById('reportTitle').textContent = reportTitle;
                
                const reportBody = document.getElementById('reportBody');
                reportBody.innerHTML = '<div class="loading">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...</div>';
                document.getElementById('reportContent').style.display = 'block';
                
                // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                await loadEmployees();
                
                // ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑŸÅŸÑÿßÿ™ÿ±
                let filteredEmployees = [...employeesData];
                
                // ŸÅŸÑÿ™ÿ±ÿ© ÿ≠ÿ≥ÿ® ÿßŸÑÿ™ÿßÿ±ŸäÿÆ (ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™Ÿàÿ∏ŸäŸÅ)
                if (startDate || endDate) {
                    filteredEmployees = filteredEmployees.filter(emp => {
                        if (!emp.hireDate) return false;
                        const hireDate = emp.hireDate.seconds ? new Date(emp.hireDate.seconds * 1000) : new Date(emp.hireDate);
                        const start = startDate ? new Date(startDate) : null;
                        const end = endDate ? new Date(endDate) : null;
                        
                        if (start && hireDate < start) return false;
                        if (end && hireDate > end) return false;
                        return true;
                    });
                }
                
                // ŸÅŸÑÿ™ÿ±ÿ© ÿ≠ÿ≥ÿ® ÿßŸÑÿ≠ÿßŸÑÿ©
                if (statusFilter) {
                    filteredEmployees = filteredEmployees.filter(emp => emp.status === statusFilter);
                }
                
                // ŸÅŸÑÿ™ÿ±ÿ© ÿ≠ÿ≥ÿ® ÿßŸÑŸÖÿ≥ŸÖŸâ ÿßŸÑŸàÿ∏ŸäŸÅŸä
                if (positionFilter) {
                    filteredEmployees = filteredEmployees.filter(emp => 
                        emp.position && emp.position.toLowerCase().includes(positionFilter.toLowerCase())
                    );
                }
                
                // ŸÅŸÑÿ™ÿ±ÿ© ÿ≠ÿ≥ÿ® ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ
                if (projectFilter) {
                    filteredEmployees = filteredEmployees.filter(emp => {
                        if (!emp.projectsHistory || emp.projectsHistory.length === 0) return false;
                        return emp.projectsHistory.some(ph => ph.projectId === projectFilter && !ph.endDate);
                    });
                }
                
                const totalEmployees = filteredEmployees.length;
                const activeEmployees = filteredEmployees.filter(e => e.status === 'active').length;
                const inactiveEmployees = totalEmployees - activeEmployees;
                
                // ÿ™ÿ¨ŸÖŸäÿπ ÿ≠ÿ≥ÿ® ÿßŸÑŸÖÿ≥ŸÖŸâ ÿßŸÑŸàÿ∏ŸäŸÅŸä
                const byPosition = {};
                filteredEmployees.forEach(emp => {
                    const position = emp.position || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
                    byPosition[position] = (byPosition[position] || 0) + 1;
                });
                
                // ÿ™ÿ¨ŸÖŸäÿπ ÿ≠ÿ≥ÿ® ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ÿßŸÑÿ≠ÿßŸÑŸä
                const byProject = {};
                filteredEmployees.forEach(emp => {
                    if (emp.projectsHistory && emp.projectsHistory.length > 0) {
                        const currentProjects = emp.projectsHistory.filter(p => !p.endDate);
                        if (currentProjects.length > 0) {
                            currentProjects.forEach(p => {
                                const projectName = projectsData.find(pr => pr.id === p.projectId)?.name || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
                                byProject[projectName] = (byProject[projectName] || 0) + 1;
                            });
                        } else {
                            byProject['ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖÿ¥ÿ±Ÿàÿπ'] = (byProject['ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖÿ¥ÿ±Ÿàÿπ'] || 0) + 1;
                        }
                    } else {
                        byProject['ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖÿ¥ÿ±Ÿàÿπ'] = (byProject['ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖÿ¥ÿ±Ÿàÿπ'] || 0) + 1;
                    }
                });
                
                let html = `
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #667eea; margin-bottom: 20px;">üìä ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿπÿßŸÖÿ©</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2em; font-weight: bold; color: #667eea;">${totalEmployees}</div>
                                <div style="color: #666;">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ</div>
                            </div>
                            <div style="background: #d4edda; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2em; font-weight: bold; color: #28a745;">${activeEmployees}</div>
                                <div style="color: #666;">ŸÖŸàÿ∏ŸÅŸäŸÜ ŸÜÿ¥ÿ∑ŸäŸÜ</div>
                            </div>
                            <div style="background: #f8d7da; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2em; font-weight: bold; color: #dc3545;">${inactiveEmployees}</div>
                                <div style="color: #666;">ŸÖŸàÿ∏ŸÅŸäŸÜ ÿ∫Ÿäÿ± ŸÜÿ¥ÿ∑ŸäŸÜ</div>
                            </div>
                        </div>
                        ${startDate || endDate ? `<div style="background: #fff3cd; padding: 10px; border-radius: 8px; margin-bottom: 15px; text-align: center; color: #856404;">
                            <strong>ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑŸÖÿ≠ÿØÿØÿ©:</strong> ${startDate ? formatDate(startDate) : 'ÿ®ÿØÿßŸäÿ©'} - ${endDate ? formatDate(endDate) : 'ŸÜŸáÿßŸäÿ©'}
                        </div>` : ''}
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #667eea; margin-bottom: 15px;">üìã ÿßŸÑÿ™Ÿàÿ≤Ÿäÿπ ÿ≠ÿ≥ÿ® ÿßŸÑŸÖÿ≥ŸÖŸâ ÿßŸÑŸàÿ∏ŸäŸÅŸä</h3>
                        <div class="table-container">
                            <table style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th>ÿßŸÑŸÖÿ≥ŸÖŸâ ÿßŸÑŸàÿ∏ŸäŸÅŸä</th>
                                        <th>ÿπÿØÿØ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ</th>
                                        <th>ÿßŸÑŸÜÿ≥ÿ®ÿ©</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                Object.entries(byPosition).sort((a, b) => b[1] - a[1]).forEach(([position, count]) => {
                    const percentage = totalEmployees > 0 ? ((count / totalEmployees) * 100).toFixed(1) : '0';
                    html += `
                        <tr>
                            <td>${position}</td>
                            <td>${count}</td>
                            <td>${percentage}%</td>
                        </tr>
                    `;
                });
                
                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #667eea; margin-bottom: 15px;">üìÅ ÿßŸÑÿ™Ÿàÿ≤Ÿäÿπ ÿ≠ÿ≥ÿ® ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ</h3>
                        <div class="table-container">
                            <table style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th>ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ</th>
                                        <th>ÿπÿØÿØ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ</th>
                                        <th>ÿßŸÑŸÜÿ≥ÿ®ÿ©</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                Object.entries(byProject).sort((a, b) => b[1] - a[1]).forEach(([project, count]) => {
                    const percentage = totalEmployees > 0 ? ((count / totalEmployees) * 100).toFixed(1) : '0';
                    html += `
                        <tr>
                            <td>${project}</td>
                            <td>${count}</td>
                            <td>${percentage}%</td>
                        </tr>
                    `;
                });
                
                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div>
                        <h3 style="color: #667eea; margin-bottom: 15px;">üìù ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ</h3>
                        <div class="table-container">
                            <table style="width: 100%; font-size: 14px;">
                                <thead>
                                    <tr>
                                        <th>ÿßŸÑÿ±ŸÇŸÖ</th>
                                        <th>ÿßŸÑÿßÿ≥ŸÖ</th>
                                        <th>ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑŸàÿ∏ŸäŸÅŸä</th>
                                        <th>ÿßŸÑŸÖÿ≥ŸÖŸâ ÿßŸÑŸàÿ∏ŸäŸÅŸä</th>
                                        <th>ÿßŸÑÿ≠ÿßŸÑÿ©</th>
                                        <th>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™Ÿàÿ∏ŸäŸÅ</th>
                                        <th>ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ÿßŸÑÿ≠ÿßŸÑŸä</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                filteredEmployees.forEach((emp, index) => {
                    const currentProject = emp.projectsHistory?.find(p => !p.endDate);
                    const projectName = currentProject ? (projectsData.find(p => p.id === currentProject.projectId)?.name || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ') : 'ŸÑÿß ŸäŸàÿ¨ÿØ';
                    html += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${emp.name || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</td>
                            <td>${emp.employeeNumber || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</td>
                            <td>${emp.position || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</td>
                            <td><span class="badge ${emp.status === 'active' ? 'badge-success' : 'badge-danger'}">${getEmployeeStatusName(emp.status)}</span></td>
                            <td>${emp.hireDate ? (emp.hireDate.seconds ? formatDate(emp.hireDate) : formatDate(emp.hireDate)) : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</td>
                            <td>${projectName}</td>
                        </tr>
                    `;
                });
                
                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; text-align: center; color: #666; font-size: 12px;">
                        ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±: ${formatDateTime(new Date())}
                    </div>
                `;
                
                reportBody.innerHTML = html;
                currentReportData = { type: 'employees', data: filteredEmployees };
                
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ŸàŸÑŸäÿØ ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ:', error);
                alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ŸàŸÑŸäÿØ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±: ' + error.message);
            }
        }

        // ============================================
        // ÿ™ŸÇÿßÿ±Ÿäÿ± ÿ¨ÿØŸäÿØÿ©
        // ============================================

        // ÿ•ÿ∏Ÿáÿßÿ± ŸÜÿßŸÅÿ∞ÿ© ÿ™ŸÇÿ±Ÿäÿ± ÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑŸÖŸàÿ∏ŸÅ
        async function showEmployeeLeaveHistoryReportModal() {
            const modal = document.getElementById('employeeLeaveHistoryReportModal');
            if (modal) {
                await loadEmployees();
                
                // ÿ™ÿ≠ÿØŸäÿ´ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ ŸÑŸÑÿ®ÿ≠ÿ´ ÿßŸÑŸÖÿ±ÿ™ÿ®
                const employeeInput = document.getElementById('employeeLeaveReportEmployeeId');
                const employeeDatalist = document.getElementById('employeeLeaveReportEmployeeList');
                const employeeHiddenInput = document.getElementById('employeeLeaveReportEmployeeIdHidden');
                
                if (employeeInput && employeeDatalist) {
                    // ŸÖÿ≥ÿ≠ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ≥ÿßÿ®ŸÇÿ©
                    employeeDatalist.innerHTML = '';
                    employeeInput.value = '';
                    if (employeeHiddenInput) employeeHiddenInput.value = '';
                    
                    if (employeesData && employeesData.length > 0) {
                        // ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ ÿ≠ÿ≥ÿ® ÿßŸÑÿßÿ≥ŸÖ
                        const sortedEmployees = [...employeesData].sort((a, b) => {
                            const nameA = (a.name || '').trim().toLowerCase();
                            const nameB = (b.name || '').trim().toLowerCase();
                            return nameA.localeCompare(nameB, 'ar');
                        });
                        
                        sortedEmployees.forEach(emp => {
                            const option = document.createElement('option');
                            const displayText = `${emp.name || 'ÿ®ÿØŸàŸÜ ÿßÿ≥ŸÖ'}${emp.employeeNumber ? ' (' + emp.employeeNumber + ')' : ''}`;
                            option.value = displayText;
                            option.setAttribute('data-employee-id', emp.id);
                            employeeDatalist.appendChild(option);
                        });
                    }
                    
                    // ÿØÿßŸÑÿ© ŸÑŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÖŸàÿ∏ŸÅ
                    function findEmployeeId(inputValue) {
                        if (!inputValue || !inputValue.trim()) {
                            return null;
                        }
                        
                        const trimmedValue = inputValue.trim();
                        
                        // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ŸÖÿ∑ÿßÿ®ŸÇÿ© ŸÉÿßŸÖŸÑÿ© ÿ£ŸàŸÑÿßŸã
                        const exactMatch = Array.from(employeeDatalist.options).find(opt => opt.value === trimmedValue);
                        if (exactMatch) {
                            return exactMatch.getAttribute('data-employee-id');
                        }
                        
                        // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ŸÖÿ∑ÿßÿ®ŸÇÿ© ÿ¨ÿ≤ÿ¶Ÿäÿ©
                        const partialMatch = Array.from(employeeDatalist.options).find(opt => {
                            const optValue = opt.value.toLowerCase();
                            const searchValue = trimmedValue.toLowerCase();
                            return optValue.includes(searchValue) || searchValue.includes(optValue);
                        });
                        
                        if (partialMatch) {
                            return partialMatch.getAttribute('data-employee-id');
                        }
                        
                        return null;
                    }
                    
                    // ÿ•ÿ≤ÿßŸÑÿ© event listeners ÿßŸÑŸÇÿØŸäŸÖÿ© ÿ•ŸÜ Ÿàÿ¨ÿØÿ™ (ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ŸÖÿÆÿ≤ŸÜÿ©)
                    if (employeeInput._inputHandler) {
                        employeeInput.removeEventListener('input', employeeInput._inputHandler);
                    }
                    if (employeeInput._changeHandler) {
                        employeeInput.removeEventListener('change', employeeInput._changeHandler);
                    }
                    
                    // ÿ•ŸÜÿ¥ÿßÿ° handlers ÿ¨ÿØŸäÿØÿ©
                    const inputHandler = function() {
                        const inputValue = this.value;
                        const employeeId = findEmployeeId(inputValue);
                        
                        if (employeeId && employeeHiddenInput) {
                            employeeHiddenInput.value = employeeId;
                        } else if (employeeHiddenInput) {
                            employeeHiddenInput.value = '';
                        }
                    };
                    
                    const changeHandler = function() {
                        const inputValue = this.value;
                        const employeeId = findEmployeeId(inputValue);
                        
                        if (employeeId && employeeHiddenInput) {
                            employeeHiddenInput.value = employeeId;
                            
                            // ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑŸÜÿµ ÿßŸÑŸÖÿπÿ±Ÿàÿ∂ Ÿäÿ∑ÿßÿ®ŸÇ ÿßŸÑÿÆŸäÿßÿ± ÿßŸÑŸÖÿ≠ÿØÿØ
                            const matchingOption = Array.from(employeeDatalist.options).find(opt => 
                                opt.getAttribute('data-employee-id') === employeeId
                            );
                            if (matchingOption && this.value !== matchingOption.value) {
                                this.value = matchingOption.value;
                            }
                        } else if (employeeHiddenInput) {
                            employeeHiddenInput.value = '';
                        }
                    };
                    
                    // ÿ≠ŸÅÿ∏ ÿßŸÑŸÄ handlers ŸÑŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÑÿßÿ≠ŸÇÿßŸã
                    employeeInput._inputHandler = inputHandler;
                    employeeInput._changeHandler = changeHandler;
                    
                    // ÿ•ÿ∂ÿßŸÅÿ© event listeners
                    employeeInput.addEventListener('input', inputHandler);
                    employeeInput.addEventListener('change', changeHandler);
                }
                
                // ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ™Ÿàÿßÿ±ŸäÿÆ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ© (ŸÖŸÜ ÿ®ÿØÿßŸäÿ© ÿßŸÑÿ≥ŸÜÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ© ÿ•ŸÑŸâ ÿßŸÑŸäŸàŸÖ)
                const today = new Date();
                const startOfYear = new Date(today.getFullYear(), 0, 1);
                document.getElementById('employeeLeaveReportStartDate').value = startOfYear.toISOString().split('T')[0];
                document.getElementById('employeeLeaveReportEndDate').value = today.toISOString().split('T')[0];
                modal.classList.add('active');
            }
        }

        // ÿ•ÿÆŸÅÿßÿ° ŸÜÿßŸÅÿ∞ÿ© ÿ™ŸÇÿ±Ÿäÿ± ÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑŸÖŸàÿ∏ŸÅ
        function hideEmployeeLeaveHistoryReportModal() {
            const modal = document.getElementById('employeeLeaveHistoryReportModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        // ÿ™ŸàŸÑŸäÿØ ÿ™ŸÇÿ±Ÿäÿ± ÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑŸÖŸàÿ∏ŸÅ
        async function generateEmployeeLeaveHistoryReport() {
            try {
                // ŸÇÿ±ÿßÿ°ÿ© ID ÿßŸÑŸÖŸàÿ∏ŸÅ ŸÖŸÜ ÿßŸÑÿ≠ŸÇŸÑ ÿßŸÑŸÖÿÆŸÅŸä
                const employeeHiddenInput = document.getElementById('employeeLeaveReportEmployeeIdHidden');
                const employeeInput = document.getElementById('employeeLeaveReportEmployeeId');
                let employeeId = employeeHiddenInput ? employeeHiddenInput.value.trim() : '';
                
                // ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸáŸÜÿßŸÉ ID ŸÅŸä ÿßŸÑÿ≠ŸÇŸÑ ÿßŸÑŸÖÿÆŸÅŸäÿå ÿ≠ÿßŸàŸÑ ÿßŸÑÿ®ÿ≠ÿ´ ŸÖŸÜ ÿßŸÑŸÜÿµ ÿßŸÑŸÖÿØÿÆŸÑ
                if (!employeeId && employeeInput && employeeInput.value.trim()) {
                    const datalist = document.getElementById('employeeLeaveReportEmployeeList');
                    if (datalist) {
                        const inputValue = employeeInput.value.trim();
                        
                        // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ŸÖÿ∑ÿßÿ®ŸÇÿ© ŸÉÿßŸÖŸÑÿ© ÿ£ŸàŸÑÿßŸã
                        let matchingOption = Array.from(datalist.options).find(opt => opt.value === inputValue);
                        
                        // ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™Ÿàÿ¨ÿØ ŸÖÿ∑ÿßÿ®ŸÇÿ© ŸÉÿßŸÖŸÑÿ©ÿå ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ŸÖÿ∑ÿßÿ®ŸÇÿ© ÿ¨ÿ≤ÿ¶Ÿäÿ©
                        if (!matchingOption) {
                            matchingOption = Array.from(datalist.options).find(opt => {
                                const optValue = opt.value.toLowerCase();
                                const searchValue = inputValue.toLowerCase();
                                return optValue.includes(searchValue) || searchValue.includes(optValue);
                            });
                        }
                        
                        if (matchingOption) {
                            employeeId = matchingOption.getAttribute('data-employee-id');
                            if (employeeId && employeeHiddenInput) {
                                employeeHiddenInput.value = employeeId;
                            }
                            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÜÿµ ÿßŸÑŸÖÿπÿ±Ÿàÿ∂ ŸÑŸäÿ∑ÿßÿ®ŸÇ ÿßŸÑÿÆŸäÿßÿ± ÿßŸÑŸÖÿ≠ÿØÿØ
                            if (employeeInput.value !== matchingOption.value) {
                                employeeInput.value = matchingOption.value;
                            }
                        }
                    }
                }
                
                const startDate = document.getElementById('employeeLeaveReportStartDate').value;
                const endDate = document.getElementById('employeeLeaveReportEndDate').value;

                if (!employeeId) {
                    alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸàÿ∏ŸÅ ÿµÿ≠Ÿäÿ≠ ŸÖŸÜ ÿßŸÑŸÇÿßÿ¶ŸÖÿ©');
                    return;
                }

                const employee = employeesData.find(e => e.id === employeeId);
                if (!employee) {
                    alert('ÿßŸÑŸÖŸàÿ∏ŸÅ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ');
                    return;
                }

                await loadLeaves();

                // ÿ™ÿµŸÅŸäÿ© ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿ≠ÿ≥ÿ® ÿßŸÑŸÖŸàÿ∏ŸÅ ŸàÿßŸÑŸÅÿ™ÿ±ÿ©
                let filteredLeaves = leavesData.filter(l => l.employeeId === employeeId);
                
                if (startDate) {
                    filteredLeaves = filteredLeaves.filter(l => {
                        const leaveDate = l.startDate ? (l.startDate.seconds ? new Date(l.startDate.seconds * 1000) : new Date(l.startDate)) : null;
                        return leaveDate && leaveDate >= new Date(startDate);
                    });
                }
                
                if (endDate) {
                    filteredLeaves = filteredLeaves.filter(l => {
                        const leaveDate = l.startDate ? (l.startDate.seconds ? new Date(l.startDate.seconds * 1000) : new Date(l.startDate)) : null;
                        return leaveDate && leaveDate <= new Date(endDate);
                    });
                }

                // ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿ≠ÿ≥ÿ® ÿßŸÑÿ™ÿßÿ±ŸäÿÆ (ÿßŸÑÿ£ÿ≠ÿØÿ´ ÿ£ŸàŸÑÿßŸã)
                filteredLeaves.sort((a, b) => {
                    const dateA = a.startDate ? (a.startDate.seconds ? new Date(a.startDate.seconds * 1000) : new Date(a.startDate)) : new Date(0);
                    const dateB = b.startDate ? (b.startDate.seconds ? new Date(b.startDate.seconds * 1000) : new Date(b.startDate)) : new Date(0);
                    return dateB - dateA;
                });

                // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ±ÿµŸäÿØ
                const monthlyLeaveDays = employee.monthlyLeaveDays || 2.5;
                const hourlyLeaveHours = employee.hourlyLeaveHours || 8;
                const initialBalance = employee.initialLeaveBalance || 0;
                const entryDate = employee.systemEntryDate || employee.hireDate;
                
                let totalMonthlyLeaves = initialBalance;
                let monthlyUsed = 0;
                let hourlyUsed = 0;
                
                if (entryDate) {
                    const systemEntryDate = new Date(entryDate);
                    systemEntryDate.setHours(0, 0, 0, 0);
                    const now = new Date();
                    now.setHours(0, 0, 0, 0);
                    
                    let monthsDiff = (now.getFullYear() - systemEntryDate.getFullYear()) * 12 + 
                                    (now.getMonth() - systemEntryDate.getMonth());
                    
                    if (now.getDate() < systemEntryDate.getDate()) {
                        monthsDiff -= 1;
                    }
                    
                    if (monthsDiff < 0) {
                        monthsDiff = 0;
                    }
                    
                    totalMonthlyLeaves = (monthsDiff * monthlyLeaveDays) + initialBalance;
                }

                // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖÿ©
                filteredLeaves.forEach(leave => {
                    if (leave.status === 'approved') {
                        if (leave.type === 'monthly' || (leave.type === 'unpaid' && leave.convertedFromMonthly === true)) {
                            if (leave.startDate && leave.endDate) {
                                const start = new Date(leave.startDate);
                                start.setHours(0, 0, 0, 0);
                                const end = new Date(leave.endDate);
                                end.setHours(0, 0, 0, 0);
                                const diffTime = Math.abs(end - start);
                                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                                monthlyUsed += diffDays;
                            }
                        } else if (leave.type === 'hourly') {
                            hourlyUsed += (leave.hours || 0);
                        }
                    }
                });

                const monthlyBalance = totalMonthlyLeaves - monthlyUsed;
                const hourlyBalance = hourlyLeaveHours - hourlyUsed;

                // ÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±
                hideEmployeeLeaveHistoryReportModal();
                
                const reportTitle = `ÿ™ŸÇÿ±Ÿäÿ± ÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑŸÖŸàÿ∏ŸÅ - ${employee.name}`;
                document.getElementById('reportTitle').textContent = reportTitle;
                
                const reportBody = document.getElementById('reportBody');
                reportBody.innerHTML = '<div class="loading">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...</div>';
                document.getElementById('reportContent').style.display = 'block';

                let html = `
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #667eea; margin-bottom: 20px;">üë§ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖŸàÿ∏ŸÅ</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="background: #e7f3ff; padding: 15px; border-radius: 8px;">
                                <strong>ÿßŸÑÿßÿ≥ŸÖ:</strong> ${employee.name || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}<br>
                                <strong>ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑŸàÿ∏ŸäŸÅŸä:</strong> ${employee.employeeNumber || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}<br>
                                <strong>ÿßŸÑŸÖÿ≥ŸÖŸâ ÿßŸÑŸàÿ∏ŸäŸÅŸä:</strong> ${employee.position || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}
                            </div>
                            <div style="background: #e7f3ff; padding: 15px; border-radius: 8px;">
                                <strong>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ•ÿØÿ±ÿßÿ¨:</strong> ${entryDate ? formatDate(entryDate) : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}<br>
                                <strong>ÿßŸÑÿ±ÿµŸäÿØ ÿßŸÑÿßÿ®ÿ™ÿØÿßÿ¶Ÿä:</strong> ${initialBalance} ŸäŸàŸÖ
                            </div>
                        </div>
                    </div>

                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #667eea; margin-bottom: 20px;">üìä ŸÖŸÑÿÆÿµ ÿßŸÑÿ±ÿµŸäÿØ</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                            <div style="background: #d4edda; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5em; font-weight: bold; color: #28a745; margin-bottom: 10px;">ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑÿ¥Ÿáÿ±Ÿäÿ©</div>
                                <div style="font-size: 2em; font-weight: bold; color: #155724;">${totalMonthlyLeaves.toFixed(1)}</div>
                                <div style="color: #666; margin-top: 5px;">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ™ÿ±ÿßŸÉŸÖ</div>
                            </div>
                            <div style="background: #fff3cd; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5em; font-weight: bold; color: #856404; margin-bottom: 10px;">ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ</div>
                                <div style="font-size: 2em; font-weight: bold; color: #856404;">${monthlyUsed.toFixed(1)}</div>
                                <div style="color: #666; margin-top: 5px;">ŸäŸàŸÖ</div>
                            </div>
                            <div style="background: ${monthlyBalance >= 0 ? '#d1ecf1' : '#f8d7da'}; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5em; font-weight: bold; color: ${monthlyBalance >= 0 ? '#0c5460' : '#721c24'}; margin-bottom: 10px;">ÿßŸÑŸÖÿ™ÿ®ŸÇŸä</div>
                                <div style="font-size: 2em; font-weight: bold; color: ${monthlyBalance >= 0 ? '#0c5460' : '#721c24'};">${monthlyBalance.toFixed(1)}</div>
                                <div style="color: #666; margin-top: 5px;">ŸäŸàŸÖ</div>
                            </div>
                            <div style="background: #e7f3ff; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5em; font-weight: bold; color: #667eea; margin-bottom: 10px;">ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ©</div>
                                <div style="font-size: 2em; font-weight: bold; color: #667eea;">${hourlyLeaveHours}</div>
                                <div style="color: #666; margin-top: 5px;">ÿ≥ÿßÿπÿ©/ÿ¥Ÿáÿ±</div>
                            </div>
                            <div style="background: #fff3cd; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5em; font-weight: bold; color: #856404; margin-bottom: 10px;">ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ</div>
                                <div style="font-size: 2em; font-weight: bold; color: #856404;">${hourlyUsed.toFixed(1)}</div>
                                <div style="color: #666; margin-top: 5px;">ÿ≥ÿßÿπÿ©</div>
                            </div>
                            <div style="background: ${hourlyBalance >= 0 ? '#d1ecf1' : '#f8d7da'}; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5em; font-weight: bold; color: ${hourlyBalance >= 0 ? '#0c5460' : '#721c24'}; margin-bottom: 10px;">ÿßŸÑŸÖÿ™ÿ®ŸÇŸä</div>
                                <div style="font-size: 2em; font-weight: bold; color: ${hourlyBalance >= 0 ? '#0c5460' : '#721c24'};">${hourlyBalance.toFixed(1)}</div>
                                <div style="color: #666; margin-top: 5px;">ÿ≥ÿßÿπÿ©</div>
                            </div>
                        </div>
                    </div>

                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #667eea; margin-bottom: 15px;">üìã ÿ≠ÿ±ŸÉÿ© ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿßÿ™ ${startDate || endDate ? `(${startDate || 'ŸÖŸÜ ÿßŸÑÿ®ÿØÿßŸäÿ©'} - ${endDate || 'ÿ≠ÿ™Ÿâ ÿßŸÑÿ¢ŸÜ'})` : ''}</h3>
                        <div class="table-container">
                            <table style="width: 100%; font-size: 14px;">
                                <thead>
                                    <tr>
                                        <th>ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</th>
                                        <th>ŸÜŸàÿπ ÿßŸÑÿ•ÿ¨ÿßÿ≤ÿ©</th>
                                        <th>ÿßŸÑŸÖÿØÿ©</th>
                                        <th>ÿßŸÑÿ≠ÿßŸÑÿ©</th>
                                        <th>ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;

                if (filteredLeaves.length === 0) {
                    html += `
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 40px; color: #666;">
                                ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ•ÿ¨ÿßÿ≤ÿßÿ™ ŸÅŸä ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑŸÖÿ≠ÿØÿØÿ©
                            </td>
                        </tr>
                    `;
                } else {
                    filteredLeaves.forEach(leave => {
                        const startDateStr = leave.startDate ? (leave.startDate.seconds ? formatDate(leave.startDate) : formatDate(leave.startDate)) : '-';
                        const endDateStr = leave.endDate ? (leave.endDate.seconds ? formatDate(leave.endDate) : formatDate(leave.endDate)) : '-';
                        
                        let duration = '-';
                        if (leave.type === 'monthly' || leave.type === 'unpaid') {
                            if (leave.startDate && leave.endDate) {
                                const start = new Date(leave.startDate);
                                const end = new Date(leave.endDate);
                                const diffTime = Math.abs(end - start);
                                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                                duration = `${diffDays} ŸäŸàŸÖ`;
                            }
                        } else if (leave.type === 'hourly') {
                            duration = `${leave.hours || 0} ÿ≥ÿßÿπÿ©`;
                        }

                        const leaveTypeName = getLeaveTypeName(leave.type, leave);
                        const statusBadge = leave.status === 'approved' ? 'badge-success' : leave.status === 'rejected' ? 'badge-danger' : 'badge-warning';
                        const statusName = getLeaveStatusName(leave.status);

                        html += `
                            <tr>
                                <td>${startDateStr} ${leave.endDate ? `- ${endDateStr}` : ''}</td>
                                <td>${leaveTypeName}</td>
                                <td>${duration}</td>
                                <td><span class="badge ${statusBadge}">${statusName}</span></td>
                                <td>${leave.notes || '-'}</td>
                            </tr>
                        `;
                    });
                }

                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; text-align: center; color: #666; font-size: 12px;">
                        ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±: ${formatDateTime(new Date())}
                    </div>
                `;

                reportBody.innerHTML = html;
                currentReportData = { type: 'employeeLeaveHistory', data: { employee, leaves: filteredLeaves } };

            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ŸàŸÑŸäÿØ ÿ™ŸÇÿ±Ÿäÿ± ÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑŸÖŸàÿ∏ŸÅ:', error);
                alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ŸàŸÑŸäÿØ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±: ' + error.message);
            }
        }

        // ÿ•ÿ∏Ÿáÿßÿ± ŸÜÿßŸÅÿ∞ÿ© ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ŸàÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ
        async function showProjectEmployeesReportModal() {
            const modal = document.getElementById('projectEmployeesReportModal');
            if (modal) {
                await loadProjects();
                const select = document.getElementById('projectEmployeesReportProjectId');
                if (select) {
                    select.innerHTML = '<option value="">-- ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ --</option>';
                    projectsData.forEach(project => {
                        const option = document.createElement('option');
                        option.value = project.id;
                        option.textContent = `${project.code || ''} - ${project.name}`;
                        select.appendChild(option);
                    });
                }
                modal.classList.add('active');
            }
        }

        // ÿ•ÿÆŸÅÿßÿ° ŸÜÿßŸÅÿ∞ÿ© ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ŸàÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ
        function hideProjectEmployeesReportModal() {
            const modal = document.getElementById('projectEmployeesReportModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        // ÿ™ŸàŸÑŸäÿØ ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ŸàÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ
        async function generateProjectEmployeesReport() {
            try {
                const projectId = document.getElementById('projectEmployeesReportProjectId').value;
                const includeHistory = document.getElementById('projectEmployeesReportIncludeHistory').checked;

                if (!projectId) {
                    alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßÿÆÿ™Ÿäÿßÿ± ŸÖÿ¥ÿ±Ÿàÿπ');
                    return;
                }

                const project = projectsData.find(p => p.id === projectId);
                if (!project) {
                    alert('ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ');
                    return;
                }

                await loadEmployees();

                // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ ŸÅŸä Ÿáÿ∞ÿß ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ
                const projectEmployees = [];
                employeesData.forEach(emp => {
                    if (emp.projectsHistory && emp.projectsHistory.length > 0) {
                        emp.projectsHistory.forEach(ph => {
                            if (ph.projectId === projectId) {
                                if (includeHistory || !ph.endDate) {
                                    projectEmployees.push({
                                        employee: emp,
                                        projectHistory: ph
                                    });
                                }
                            }
                        });
                    }
                });

                // ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ ÿ≠ÿ≥ÿ® ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ®ÿØÿ°
                projectEmployees.sort((a, b) => {
                    const dateA = a.projectHistory.startDate ? (a.projectHistory.startDate.seconds ? new Date(a.projectHistory.startDate.seconds * 1000) : new Date(a.projectHistory.startDate)) : new Date(0);
                    const dateB = b.projectHistory.startDate ? (b.projectHistory.startDate.seconds ? new Date(b.projectHistory.startDate.seconds * 1000) : new Date(b.projectHistory.startDate)) : new Date(0);
                    return dateB - dateA;
                });

                // ÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±
                hideProjectEmployeesReportModal();
                
                const reportTitle = `ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ - ${project.name}`;
                document.getElementById('reportTitle').textContent = reportTitle;
                
                const reportBody = document.getElementById('reportBody');
                reportBody.innerHTML = '<div class="loading">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...</div>';
                document.getElementById('reportContent').style.display = 'block';

                let html = `
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #667eea; margin-bottom: 20px;">üìÅ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ</h3>
                        <div style="background: #e7f3ff; padding: 20px; border-radius: 8px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div>
                                    <strong>ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ:</strong> ${project.name || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}<br>
                                    <strong>ÿ±ŸÖÿ≤ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ:</strong> ${project.code || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}<br>
                                    <strong>ÿßŸÑÿ≠ÿßŸÑÿ©:</strong> <span class="badge ${project.status === 'active' ? 'badge-success' : 'badge-danger'}">${project.status === 'active' ? 'ŸÜÿ¥ÿ∑' : 'ÿ∫Ÿäÿ± ŸÜÿ¥ÿ∑'}</span>
                                </div>
                                <div>
                                    <strong>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ®ÿØÿ°:</strong> ${project.startDate ? (project.startDate.seconds ? formatDate(project.startDate) : formatDate(project.startDate)) : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}<br>
                                    <strong>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ°:</strong> ${project.endDate ? (project.endDate.seconds ? formatDate(project.endDate) : formatDate(project.endDate)) : 'ŸÖÿ≥ÿ™ŸÖÿ±'}<br>
                                    <strong>ÿßŸÑŸàÿµŸÅ:</strong> ${project.description || 'ŸÑÿß ŸäŸàÿ¨ÿØ'}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #667eea; margin-bottom: 15px;">üë• ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ ŸÅŸä ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ (${projectEmployees.length})</h3>
                        <div class="table-container">
                            <table style="width: 100%; font-size: 14px;">
                                <thead>
                                    <tr>
                                        <th>ÿßŸÑÿ±ŸÇŸÖ</th>
                                        <th>ÿßŸÑÿßÿ≥ŸÖ</th>
                                        <th>ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑŸàÿ∏ŸäŸÅŸä</th>
                                        <th>ÿßŸÑŸÖÿ≥ŸÖŸâ ÿßŸÑŸàÿ∏ŸäŸÅŸä</th>
                                        <th>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ®ÿØÿ°</th>
                                        <th>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ°</th>
                                        <th>ÿßŸÑÿ≠ÿßŸÑÿ©</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;

                if (projectEmployees.length === 0) {
                    html += `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
                                ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖŸàÿ∏ŸÅŸäŸÜ ŸÅŸä Ÿáÿ∞ÿß ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ
                            </td>
                        </tr>
                    `;
                } else {
                    projectEmployees.forEach((item, index) => {
                        const emp = item.employee;
                        const ph = item.projectHistory;
                        const startDateStr = ph.startDate ? (ph.startDate.seconds ? formatDate(ph.startDate) : formatDate(ph.startDate)) : '-';
                        const endDateStr = ph.endDate ? (ph.endDate.seconds ? formatDate(ph.endDate) : formatDate(ph.endDate)) : 'ŸÖÿ≥ÿ™ŸÖÿ±';
                        const isCurrent = !ph.endDate;

                        html += `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${emp.name || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</td>
                                <td>${emp.employeeNumber || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</td>
                                <td>${emp.position || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</td>
                                <td>${startDateStr}</td>
                                <td>${endDateStr}</td>
                                <td><span class="badge ${isCurrent ? 'badge-success' : 'badge-secondary'}">${isCurrent ? 'ÿ≠ÿßŸÑŸä' : 'ŸÖŸÜÿ™ŸáŸä'}</span></td>
                            </tr>
                        `;
                    });
                }

                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; text-align: center; color: #666; font-size: 12px;">
                        ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±: ${formatDateTime(new Date())}
                    </div>
                `;

                reportBody.innerHTML = html;
                currentReportData = { type: 'projectEmployees', data: { project, employees: projectEmployees } };

            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ŸàŸÑŸäÿØ ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ:', error);
                alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ŸàŸÑŸäÿØ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±: ' + error.message);
            }
        }

        // ÿ•ÿ∏Ÿáÿßÿ± ŸÜÿßŸÅÿ∞ÿ© ÿ™ŸÇÿ±Ÿäÿ± ŸÖÿ¥ÿßÿ±Ÿäÿπ ÿßŸÑŸÖŸàÿ∏ŸÅ
        async function showEmployeeProjectsHistoryReportModal() {
            const modal = document.getElementById('employeeProjectsHistoryReportModal');
            if (modal) {
                await loadEmployees();
                const select = document.getElementById('employeeProjectsReportEmployeeId');
                if (select) {
                    select.innerHTML = '<option value="">-- ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸàÿ∏ŸÅ --</option>';
                    employeesData.forEach(emp => {
                        const option = document.createElement('option');
                        option.value = emp.id;
                        option.textContent = `${emp.name} (${emp.employeeNumber || emp.id})`;
                        select.appendChild(option);
                    });
                }
                modal.classList.add('active');
            }
        }

        // ÿ•ÿÆŸÅÿßÿ° ŸÜÿßŸÅÿ∞ÿ© ÿ™ŸÇÿ±Ÿäÿ± ŸÖÿ¥ÿßÿ±Ÿäÿπ ÿßŸÑŸÖŸàÿ∏ŸÅ
        function hideEmployeeProjectsHistoryReportModal() {
            const modal = document.getElementById('employeeProjectsHistoryReportModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        // ÿ™ŸàŸÑŸäÿØ ÿ™ŸÇÿ±Ÿäÿ± ŸÖÿ¥ÿßÿ±Ÿäÿπ ÿßŸÑŸÖŸàÿ∏ŸÅ
        async function generateEmployeeProjectsHistoryReport() {
            try {
                const employeeId = document.getElementById('employeeProjectsReportEmployeeId').value;

                if (!employeeId) {
                    alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸàÿ∏ŸÅ');
                    return;
                }

                const employee = employeesData.find(e => e.id === employeeId);
                if (!employee) {
                    alert('ÿßŸÑŸÖŸàÿ∏ŸÅ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ');
                    return;
                }

                await loadProjects();

                const projectsHistory = employee.projectsHistory || [];

                // ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ ÿ≠ÿ≥ÿ® ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ®ÿØÿ° (ÿßŸÑÿ£ÿ≠ÿØÿ´ ÿ£ŸàŸÑÿßŸã)
                projectsHistory.sort((a, b) => {
                    const dateA = a.startDate ? (a.startDate.seconds ? new Date(a.startDate.seconds * 1000) : new Date(a.startDate)) : new Date(0);
                    const dateB = b.startDate ? (b.startDate.seconds ? new Date(b.startDate.seconds * 1000) : new Date(b.startDate)) : new Date(0);
                    return dateB - dateA;
                });

                // ÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±
                hideEmployeeProjectsHistoryReportModal();
                
                const reportTitle = `ÿ™ŸÇÿ±Ÿäÿ± ŸÖÿ¥ÿßÿ±Ÿäÿπ ÿßŸÑŸÖŸàÿ∏ŸÅ - ${employee.name}`;
                document.getElementById('reportTitle').textContent = reportTitle;
                
                const reportBody = document.getElementById('reportBody');
                reportBody.innerHTML = '<div class="loading">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...</div>';
                document.getElementById('reportContent').style.display = 'block';

                let html = `
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #667eea; margin-bottom: 20px;">üë§ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖŸàÿ∏ŸÅ</h3>
                        <div style="background: #e7f3ff; padding: 20px; border-radius: 8px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div>
                                    <strong>ÿßŸÑÿßÿ≥ŸÖ:</strong> ${employee.name || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}<br>
                                    <strong>ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑŸàÿ∏ŸäŸÅŸä:</strong> ${employee.employeeNumber || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}<br>
                                    <strong>ÿßŸÑŸÖÿ≥ŸÖŸâ ÿßŸÑŸàÿ∏ŸäŸÅŸä:</strong> ${employee.position || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}
                                </div>
                                <div>
                                    <strong>ÿßŸÑÿ≠ÿßŸÑÿ©:</strong> <span class="badge ${employee.status === 'active' ? 'badge-success' : 'badge-danger'}">${getEmployeeStatusName(employee.status)}</span><br>
                                    <strong>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™Ÿàÿ∏ŸäŸÅ:</strong> ${employee.hireDate ? formatDate(employee.hireDate) : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #667eea; margin-bottom: 15px;">üìÅ ÿ≠ÿ±ŸÉÿ© ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ (${projectsHistory.length})</h3>
                        <div class="table-container">
                            <table style="width: 100%; font-size: 14px;">
                                <thead>
                                    <tr>
                                        <th>ÿßŸÑÿ±ŸÇŸÖ</th>
                                        <th>ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ</th>
                                        <th>ÿ±ŸÖÿ≤ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ</th>
                                        <th>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ®ÿØÿ°</th>
                                        <th>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ°</th>
                                        <th>ÿßŸÑŸÖÿØÿ©</th>
                                        <th>ÿßŸÑÿ≠ÿßŸÑÿ©</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;

                if (projectsHistory.length === 0) {
                    html += `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
                                ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖÿ¥ÿßÿ±Ÿäÿπ ŸÖÿ≥ÿ¨ŸÑÿ© ŸÑŸáÿ∞ÿß ÿßŸÑŸÖŸàÿ∏ŸÅ
                            </td>
                        </tr>
                    `;
                } else {
                    projectsHistory.forEach((ph, index) => {
                        const project = projectsData.find(p => p.id === ph.projectId);
                        const projectName = project ? project.name : 'ŸÖÿ¥ÿ±Ÿàÿπ ŸÖÿ≠ÿ∞ŸàŸÅ';
                        const projectCode = project ? project.code : '-';
                        
                        const startDateStr = ph.startDate ? (ph.startDate.seconds ? formatDate(ph.startDate) : formatDate(ph.startDate)) : '-';
                        const endDateStr = ph.endDate ? (ph.endDate.seconds ? formatDate(ph.endDate) : formatDate(ph.endDate)) : 'ŸÖÿ≥ÿ™ŸÖÿ±';
                        
                        let duration = '-';
                        if (ph.startDate) {
                            const start = new Date(ph.startDate);
                            const end = ph.endDate ? new Date(ph.endDate) : new Date();
                            const diffTime = Math.abs(end - start);
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                            const months = Math.floor(diffDays / 30);
                            const days = diffDays % 30;
                            if (months > 0) {
                                duration = `${months} ÿ¥Ÿáÿ± ${days > 0 ? days + ' ŸäŸàŸÖ' : ''}`;
                            } else {
                                duration = `${diffDays} ŸäŸàŸÖ`;
                            }
                        }
                        
                        const isCurrent = !ph.endDate;

                        html += `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${projectName}</td>
                                <td>${projectCode}</td>
                                <td>${startDateStr}</td>
                                <td>${endDateStr}</td>
                                <td>${duration}</td>
                                <td><span class="badge ${isCurrent ? 'badge-success' : 'badge-secondary'}">${isCurrent ? 'ÿ≠ÿßŸÑŸä' : 'ŸÖŸÜÿ™ŸáŸä'}</span></td>
                            </tr>
                        `;
                    });
                }

                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; text-align: center; color: #666; font-size: 12px;">
                        ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±: ${formatDateTime(new Date())}
                    </div>
                `;

                reportBody.innerHTML = html;
                currentReportData = { type: 'employeeProjectsHistory', data: { employee, projectsHistory } };

            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ŸàŸÑŸäÿØ ÿ™ŸÇÿ±Ÿäÿ± ŸÖÿ¥ÿßÿ±Ÿäÿπ ÿßŸÑŸÖŸàÿ∏ŸÅ:', error);
                alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ŸàŸÑŸäÿØ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±: ' + error.message);
            }
        }

        // ÿ™ŸàŸÑŸäÿØ ÿ™ŸÇÿ±Ÿäÿ± ŸáŸäŸÉŸÑ ÿßŸÑÿ¥ÿ±ŸÉÿ©
        async function generateCompanyStructureReport() {
            try {
                if (!window.db || !window.firestore) {
                    alert('Firebase ÿ∫Ÿäÿ± ŸÖŸáŸäÿ£');
                    return;
                }

                currentReportType = 'companyStructure';
                const reportTitle = 'ÿ™ŸÇÿ±Ÿäÿ± ŸáŸäŸÉŸÑ ÿßŸÑÿ¥ÿ±ŸÉÿ©';
                document.getElementById('reportTitle').textContent = reportTitle;
                
                const reportBody = document.getElementById('reportBody');
                reportBody.innerHTML = '<div class="loading">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...</div>';
                document.getElementById('reportContent').style.display = 'block';

                // ÿ™ÿ≠ŸÖŸäŸÑ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                await loadRegions();
                await loadProjects();
                await loadEmployees();
                await loadDepartments();

                // ÿ™ÿ≠ÿØŸäÿØ ŸÖÿ¥ÿ±Ÿàÿπ ÿßŸÑÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿπÿßŸÖÿ©
                const generalManagementProject = projectsData.find(p => p.isGeneralManagement === true) || null;
                
                // ÿ™ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ÿ≠ÿ≥ÿ® ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ÿ£Ÿà ÿßŸÑÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿπÿßŸÖÿ©
                const departmentsByProject = {};
                departmentsData.forEach(dept => {
                    // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑŸÇÿ≥ŸÖ ŸÖÿ±ÿ™ÿ®ÿ∑ ÿ®ŸÖÿ¥ÿ±Ÿàÿπ ÿ•ÿØÿßÿ±ÿ© ÿπÿßŸÖÿ©ÿå ÿßÿ≥ÿ™ÿÆÿØŸÖ ŸÖÿπÿ±ŸÅ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ
                    // ÿ•ÿ∞ÿß ŸÉÿßŸÜ projectId ŸáŸà 'general_management'ÿå ÿßÿ≥ÿ™ÿÆÿØŸÖ 'general_management'
                    // ÿ•ÿ∞ÿß ŸÉÿßŸÜ projectId ŸÖŸàÿ¨ŸàÿØÿßŸãÿå ÿßÿ≥ÿ™ÿÆÿØŸÖŸá
                    let key;
                    if (dept.projectId === 'general_management') {
                        key = 'general_management';
                    } else if (dept.projectId && generalManagementProject && dept.projectId === generalManagementProject.id) {
                        // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑŸÇÿ≥ŸÖ ŸÖÿ±ÿ™ÿ®ÿ∑ ÿ®ŸÖÿ¥ÿ±Ÿàÿπ ÿßŸÑÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿπÿßŸÖÿ©
                        key = generalManagementProject.id;
                    } else if (dept.projectId) {
                        key = dept.projectId;
                    } else {
                        // ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸáŸÜÿßŸÉ projectIdÿå ŸÜÿπÿ™ÿ®ÿ±Ÿá ÿ•ÿØÿßÿ±ÿ© ÿπÿßŸÖÿ©
                        key = generalManagementProject ? generalManagementProject.id : 'general_management';
                    }
                    
                    if (!departmentsByProject[key]) {
                        departmentsByProject[key] = [];
                    }
                    departmentsByProject[key].push(dept);
                });

                // ÿ™ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ ÿ≠ÿ≥ÿ® ÿßŸÑŸÇÿ≥ŸÖ
                const employeesByDepartment = {};
                employeesData.forEach(emp => {
                    if (emp.departmentId) {
                        if (!employeesByDepartment[emp.departmentId]) {
                            employeesByDepartment[emp.departmentId] = [];
                        }
                        employeesByDepartment[emp.departmentId].push(emp);
                    }
                });

                // ÿ™ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ≠ÿ≥ÿ® ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ
                const structureByRegion = {};
                
                regionsData.forEach(region => {
                    structureByRegion[region.id] = {
                        region: region,
                        projects: []
                    };
                });

                // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ ŸÑŸÑŸÖŸÜÿßÿ∑ŸÇ ŸÖÿπ ÿ£ŸÇÿ≥ÿßŸÖŸáÿß ŸàŸÖŸàÿ∏ŸÅŸäŸáÿß (ÿßÿ≥ÿ™ÿ®ÿπÿßÿØ ŸÖÿ¥ÿ±Ÿàÿπ ÿßŸÑÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿπÿßŸÖÿ©)
                projectsData.forEach(project => {
                    // ÿßÿ≥ÿ™ÿ®ÿπÿßÿØ ŸÖÿ¥ÿ±Ÿàÿπ ÿßŸÑÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿπÿßŸÖÿ© ŸÖŸÜ ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ ŸÅŸä ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ
                    if (project.isGeneralManagement === true) {
                        return; // ÿ™ÿÆÿ∑Ÿä ŸÖÿ¥ÿ±Ÿàÿπ ÿßŸÑÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿπÿßŸÖÿ©
                    }
                    
                    if (project.regionId && structureByRegion[project.regionId]) {
                        // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ÿßŸÑŸÖÿ±ÿ™ÿ®ÿ∑ÿ© ÿ®Ÿáÿ∞ÿß ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ŸÅŸÇÿ∑ (ŸàŸÑŸäÿ≥ 'general_management')
                        const projectDepartments = (departmentsByProject[project.id] || []).filter(dept => {
                            // ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑŸÇÿ≥ŸÖ ŸÖÿ±ÿ™ÿ®ÿ∑ ÿ®Ÿáÿ∞ÿß ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ŸàŸÑŸäÿ≥ ÿ®ŸÄ 'general_management'
                            return dept.projectId === project.id && dept.projectId !== 'general_management';
                        });
                        
                        const projectWithDepartments = {
                            ...project,
                            departments: projectDepartments.map(dept => {
                                // ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ¨ŸÑÿ® ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ ÿ®ÿ¥ŸÉŸÑ ÿµÿ≠Ÿäÿ≠
                                const deptEmployees = employeesByDepartment[dept.id] || [];
                                return {
                                    ...dept,
                                    employees: deptEmployees
                                };
                            })
                        };
                        structureByRegion[project.regionId].projects.push(projectWithDepartments);
                    }
                });

                // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™
                const totalDepartments = departmentsData.length;
                const totalEmployeesInStructure = employeesData.filter(emp => emp.departmentId).length;

                // ÿØÿßŸÑÿ© ŸÑÿ•ŸÜÿ¥ÿßÿ° ÿπŸÇÿØÿ© ŸáŸäŸÉŸÑŸäÿ©
                function createOrgNode(title, subtitle, count, level, children = '', extraClass = '', managers = null) {
                    const levelClass = `level-${level}`;
                    let managersHtml = '';
                    if (managers && (managers.generalManager || managers.executiveManager)) {
                        managersHtml = '<div class="org-node-managers">';
                        if (managers.generalManager) {
                            managersHtml += `<div>üëî <strong>ÿßŸÑŸÖÿØŸäÿ± ÿßŸÑÿπÿßŸÖ:</strong> ${managers.generalManager}</div>`;
                        }
                        if (managers.executiveManager) {
                            managersHtml += `<div>üíº <strong>ÿßŸÑŸÖÿØŸäÿ± ÿßŸÑÿ™ŸÜŸÅŸäÿ∞Ÿä:</strong> ${managers.executiveManager}</div>`;
                        }
                        managersHtml += '</div>';
                    }
                    return `
                        <div class="org-node-wrapper">
                            <div class="org-node ${levelClass} ${extraClass}">
                                ${level > 0 ? '<div class="org-connector vertical"></div>' : ''}
                                <div class="org-node-title">${title}</div>
                                ${subtitle ? `<div class="org-node-subtitle">${subtitle}</div>` : ''}
                                ${count !== undefined ? `<div class="org-node-count">${count}</div>` : ''}
                                ${managersHtml}
                                ${children ? `<div class="org-children">${children}</div>` : ''}
                            </div>
                        </div>
                    `;
                }

                // ÿØÿßŸÑÿ© ŸÑÿ•ŸÜÿ¥ÿßÿ° ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ
                function createEmployeeList(employees) {
                    if (!employees || employees.length === 0) return '';
                    // ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ ÿ≠ÿ≥ÿ® ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑŸàÿ∏ŸäŸÅŸä
                    const sortedEmployees = [...employees].sort((a, b) => {
                        const numA = (a.employeeNumber || '').replace(/\D/g, '');
                        const numB = (b.employeeNumber || '').replace(/\D/g, '');
                        return numA.localeCompare(numB);
                    });
                    
                    return `
                        <div class="org-employee-list">
                            ${sortedEmployees.slice(0, 8).map(emp => {
                                const statusIcon = emp.status === 'active' ? '‚úÖ' : 
                                                   emp.status === 'inactive' ? '‚è∏Ô∏è' : 
                                                   emp.status === 'on-leave' ? 'üèñÔ∏è' : '‚ùå';
                                return `
                                <div class="org-employee-card" title="${emp.employeeNumber || ''} - ${emp.email || ''}">
                                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                                        <span style="font-size: 0.85em;">${statusIcon}</span>
                                        <strong style="font-size: 0.95em;">${emp.name || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</strong>
                                    </div>
                                    <small style="color: rgba(255,255,255,0.9); display: block; margin-top: 4px;">
                                        ${emp.position || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}
                                    </small>
                                    ${emp.employeeNumber ? `<small style="font-size: 0.75em; opacity: 0.8; display: block; margin-top: 2px;">${emp.employeeNumber}</small>` : ''}
                                </div>
                            `;
                            }).join('')}
                            ${sortedEmployees.length > 8 ? `<div class="org-employee-card" style="background: rgba(255,255,255,0.2); border-style: dashed;">
                                <strong style="font-size: 1.1em;">+${sortedEmployees.length - 8}</strong><br>
                                <small>ŸÖŸàÿ∏ŸÅ ÿ•ÿ∂ÿßŸÅŸä</small>
                            </div>` : ''}
                        </div>
                    `;
                }

                // ÿ≠ÿ≥ÿßÿ® ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ©
                const activeProjects = projectsData.filter(p => p.status === 'active' && !p.isGeneralManagement).length;
                const activeEmployees = employeesData.filter(emp => emp.status === 'active' && emp.departmentId).length;
                const totalProjectsInRegions = projectsData.filter(p => p.regionId && !p.isGeneralManagement).length;
                
                let html = `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 16px; margin-bottom: 30px; color: white; box-shadow: 0 8px 30px rgba(102, 126, 234, 0.3);">
                        <h2 style="margin: 0 0 20px 0; text-align: center; font-size: 1.8em; text-shadow: 0 2px 10px rgba(0,0,0,0.2);">
                            üè¢ ÿ™ŸÇÿ±Ÿäÿ± ŸáŸäŸÉŸÑ ÿßŸÑÿ¥ÿ±ŸÉÿ© ÿßŸÑÿ™ŸÜÿ∏ŸäŸÖŸä
                        </h2>
                        <p style="text-align: center; margin: 0; opacity: 0.95; font-size: 1.1em;">
                            ${formatDate(new Date(), { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                        </p>
                    </div>
                    
                    <div class="org-stats">
                        <div class="org-stat-card">
                            <div style="font-size: 2em; margin-bottom: 8px;">üåç</div>
                            <div class="org-stat-number">${regionsData.length}</div>
                            <div class="org-stat-label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ</div>
                            <div style="font-size: 0.85em; color: #999; margin-top: 8px;">
                                ${totalProjectsInRegions} ŸÖÿ¥ÿ±Ÿàÿπ ŸÖÿ±ÿ™ÿ®ÿ∑
                            </div>
                        </div>
                        <div class="org-stat-card">
                            <div style="font-size: 2em; margin-bottom: 8px;">üìÅ</div>
                            <div class="org-stat-number">${projectsData.length}</div>
                            <div class="org-stat-label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ</div>
                            <div style="font-size: 0.85em; color: #999; margin-top: 8px;">
                                ${activeProjects} ŸÖÿ¥ÿ±Ÿàÿπ ŸÜÿ¥ÿ∑
                            </div>
                        </div>
                        <div class="org-stat-card">
                            <div style="font-size: 2em; margin-bottom: 8px;">üèõÔ∏è</div>
                            <div class="org-stat-number">${totalDepartments}</div>
                            <div class="org-stat-label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ</div>
                            <div style="font-size: 0.85em; color: #999; margin-top: 8px;">
                                ŸÖŸàÿ≤ÿπÿ© ÿπŸÑŸâ ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ
                            </div>
                        </div>
                        <div class="org-stat-card">
                            <div style="font-size: 2em; margin-bottom: 8px;">üë•</div>
                            <div class="org-stat-number">${totalEmployeesInStructure}</div>
                            <div class="org-stat-label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ</div>
                            <div style="font-size: 0.85em; color: #999; margin-top: 8px;">
                                ${activeEmployees} ŸÖŸàÿ∏ŸÅ ŸÜÿ¥ÿ∑
                            </div>
                        </div>
                    </div>

                    <div class="org-controls">
                        <button class="btn btn-primary" onclick="orgChartZoomIn()" title="ÿ™ŸÉÿ®Ÿäÿ± ÿßŸÑÿ±ÿ≥ŸÖ ÿßŸÑŸáŸäŸÉŸÑŸä">
                            <span style="font-size: 1.2em;">üîç</span> ÿ™ŸÉÿ®Ÿäÿ±
                        </button>
                        <button class="btn btn-primary" onclick="orgChartZoomOut()" title="ÿ™ÿµÿ∫Ÿäÿ± ÿßŸÑÿ±ÿ≥ŸÖ ÿßŸÑŸáŸäŸÉŸÑŸä">
                            <span style="font-size: 1.2em;">üîç</span> ÿ™ÿµÿ∫Ÿäÿ±
                        </button>
                        <button class="btn btn-primary" onclick="orgChartReset()" title="ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ™ŸÉÿ®Ÿäÿ±">
                            <span style="font-size: 1.2em;">üîÑ</span> ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ
                        </button>
                        <button class="btn btn-success" onclick="window.print()" title="ÿ∑ÿ®ÿßÿπÿ© ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±">
                            <span style="font-size: 1.2em;">üñ®Ô∏è</span> ÿ∑ÿ®ÿßÿπÿ©
                        </button>
                        <button class="btn btn-info" onclick="exportOrgChartAsImage()" title="ÿ™ÿµÿØŸäÿ± ŸÉÿµŸàÿ±ÿ©">
                            <span style="font-size: 1.2em;">üì•</span> ÿ™ÿµÿØŸäÿ±
                        </button>
                        <div class="org-zoom-controls">
                            <span style="font-weight: 600; color: #667eea;">ŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑÿ™ŸÉÿ®Ÿäÿ±:</span>
                            <span class="org-zoom-level" id="orgZoomLevel">100%</span>
                        </div>
                    </div>
                    
                    <div style="background: #e7f3ff; border-right: 4px solid #667eea; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
                        <p style="margin: 0; color: #0c5460; font-size: 14px;">
                            üí° <strong>ŸÖŸÑÿßÿ≠ÿ∏ÿ©:</strong> ŸäŸÖŸÉŸÜŸÉ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ™ŸÉÿ®Ÿäÿ±/ÿßŸÑÿ™ÿµÿ∫Ÿäÿ± ŸÑŸÑÿ™ŸÜŸÇŸÑ ŸÅŸä ÿßŸÑÿ±ÿ≥ŸÖ ÿßŸÑŸáŸäŸÉŸÑŸäÿå ÿ£Ÿà ÿßŸÑÿ≥ÿ≠ÿ® ÿ®ÿßŸÑŸÖÿßŸàÿ≥ ŸÑŸÑÿ™ÿ≠ÿ±ŸäŸÉ
                        </p>
                    </div>

                    <div class="org-chart-container" id="orgChartContainer">
                        <div class="org-chart" id="orgChart" style="transform: scale(1);" data-report-date="${formatDateTime(new Date())}">
                `;

                // ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ 0: ÿßŸÑÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿπÿßŸÖÿ© (ÿ•ŸÜ Ÿàÿ¨ÿØÿ™)
                // ÿ¨ŸÖÿπ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ÿßŸÑŸÖÿ±ÿ™ÿ®ÿ∑ÿ© ÿ®ÿßŸÑÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿπÿßŸÖÿ© (ÿ≥Ÿàÿßÿ° ŸÖŸÜ ŸÖÿ¥ÿ±Ÿàÿπ ÿ£Ÿà 'general_management')
                let generalManagementDepts = [];
                
                if (generalManagementProject) {
                    // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸáŸÜÿßŸÉ ŸÖÿ¥ÿ±Ÿàÿπ ŸÖÿ≠ÿØÿØ ŸÉÿ•ÿØÿßÿ±ÿ© ÿπÿßŸÖÿ©
                    const deptsFromProject = departmentsByProject[generalManagementProject.id] || [];
                    const deptsFromGeneral = departmentsByProject['general_management'] || [];
                    // ÿØŸÖÿ¨ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ŸÖÿπ ÿ™ÿ¨ŸÜÿ® ÿßŸÑÿ™ŸÉÿ±ÿßÿ±
                    const allDeptIds = new Set();
                    generalManagementDepts = [...deptsFromProject, ...deptsFromGeneral].filter(dept => {
                        if (allDeptIds.has(dept.id)) {
                            return false;
                        }
                        allDeptIds.add(dept.id);
                        return true;
                    });
                } else {
                    // ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸáŸÜÿßŸÉ ŸÖÿ¥ÿ±Ÿàÿπ ÿ•ÿØÿßÿ±ÿ© ÿπÿßŸÖÿ©ÿå ŸÜÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ÿßŸÑŸÖÿ±ÿ™ÿ®ÿ∑ÿ© ÿ®ŸÄ 'general_management'
                    generalManagementDepts = departmentsByProject['general_management'] || [];
                }
                
                // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ ŸÅŸä ÿßŸÑÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿπÿßŸÖÿ©
                const generalManagementEmployees = generalManagementDepts.reduce((acc, dept) => {
                    const deptEmployees = employeesByDepartment[dept.id] || [];
                    // ÿ™ÿ¨ŸÜÿ® ÿ™ŸÉÿ±ÿßÿ± ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ
                    deptEmployees.forEach(emp => {
                        if (!acc.find(e => e.id === emp.id)) {
                            acc.push(emp);
                        }
                    });
                    return acc;
                }, []);

                // ÿπÿ±ÿ∂ ÿßŸÑÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿπÿßŸÖÿ© ŸÅŸÇÿ∑ ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸáŸÜÿßŸÉ ÿ£ŸÇÿ≥ÿßŸÖ ÿ£Ÿà ŸÖÿ¥ÿ±Ÿàÿπ ÿ•ÿØÿßÿ±ÿ© ÿπÿßŸÖÿ©
                if (generalManagementProject || generalManagementDepts.length > 0) {
                    const gmTitle = generalManagementProject 
                        ? (generalManagementProject.nameEn ? `${generalManagementProject.name} (${generalManagementProject.nameEn})` : generalManagementProject.name)
                        : 'ÿßŸÑÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿπÿßŸÖÿ©';
                    const gmSubtitle = generalManagementProject 
                        ? (generalManagementProject.code ? `ÿ±ŸÖÿ≤: ${generalManagementProject.code}` : 'ŸÖÿ¥ÿ±Ÿàÿπ ÿßŸÑÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿπÿßŸÖÿ©')
                        : 'ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ÿßŸÑÿ•ÿØÿßÿ±Ÿäÿ© ÿßŸÑÿπÿßŸÖÿ©';
                    const gmCount = `${generalManagementDepts.length} ŸÇÿ≥ŸÖ ‚Ä¢ ${generalManagementEmployees.length} ŸÖŸàÿ∏ŸÅ`;
                    
                    // ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿØŸäÿ±ŸäŸÜ
                    const managers = generalManagementProject ? {
                        generalManager: generalManagementProject.generalManager || null,
                        executiveManager: generalManagementProject.executiveManager || null
                    } : null;
                    
                    // ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ŸÅŸä ÿßŸÑÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿπÿßŸÖÿ©
                    let gmDepartmentsHtml = '';
                    if (generalManagementDepts.length > 0) {
                        gmDepartmentsHtml = '<div class="org-children-wrapper level-3-wrapper">';
                        gmDepartmentsHtml += generalManagementDepts.map(dept => {
                            const deptEmployees = employeesByDepartment[dept.id] || [];
                            const deptTitle = dept.nameEn ? `${dept.name} (${dept.nameEn})` : dept.name;
                            return createOrgNode(
                                deptTitle,
                                dept.description || '',
                                `${deptEmployees.length} ŸÖŸàÿ∏ŸÅ`,
                                3,
                                createEmployeeList(deptEmployees)
                            );
                        }).join('');
                        gmDepartmentsHtml += '</div>';
                    }

                    html += `
                        <div class="org-level">
                            ${createOrgNode(gmTitle, gmSubtitle, gmCount, 0, gmDepartmentsHtml, '', managers)}
                        </div>
                    `;
                }

                // ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ 1: ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ
                const regionsList = Object.values(structureByRegion);
                if (regionsList.length > 0) {
                    let regionsHtml = '<div class="org-children-wrapper level-1-wrapper">';
                    
                    regionsList.forEach(({ region, projects }) => {
                        // ÿ≠ÿ≥ÿßÿ® ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ŸàÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ ŸÅŸä ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©
                        const regionTotalDepts = projects.reduce((sum, p) => sum + (p.departments ? p.departments.length : 0), 0);
                        const regionTotalEmployees = projects.reduce((sum, p) => {
                            if (!p.departments) return sum;
                            return sum + p.departments.reduce((s, d) => {
                                const empCount = d.employees ? d.employees.length : 0;
                                return s + empCount;
                            }, 0);
                        }, 0);

                        // ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ 2: ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ ŸÅŸä ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©
                        let projectsHtml = '';
                        if (projects.length > 0) {
                            projectsHtml = '<div class="org-children-wrapper level-2-wrapper">';
                            projectsHtml += projects.map(project => {
                                // ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ
                                const projectDepartments = project.departments || [];
                                const projectTotalEmployees = projectDepartments.reduce((sum, dept) => {
                                    const empCount = dept.employees ? dept.employees.length : 0;
                                    return sum + empCount;
                                }, 0);
                                
                                // ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ 3: ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ŸÅŸä ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ
                                let departmentsHtml = '';
                                if (projectDepartments.length > 0) {
                                    departmentsHtml = '<div class="org-children-wrapper level-3-wrapper">';
                                    departmentsHtml += projectDepartments.map(dept => {
                                        // ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ
                                        const deptEmployees = dept.employees || [];
                                        const deptTitle = dept.nameEn ? `${dept.name} (${dept.nameEn})` : dept.name;
                                        return createOrgNode(
                                            deptTitle,
                                            dept.description || '',
                                            `${deptEmployees.length} ŸÖŸàÿ∏ŸÅ`,
                                            3,
                                            createEmployeeList(deptEmployees)
                                        );
                                    }).join('');
                                    departmentsHtml += '</div>';
                                }

                                const projectTitle = project.nameEn ? `${project.name} (${project.nameEn})` : project.name;
                                return createOrgNode(
                                    projectTitle,
                                    project.code || getStatusName(project.status),
                                    `${projectDepartments.length} ŸÇÿ≥ŸÖ ‚Ä¢ ${projectTotalEmployees} ŸÖŸàÿ∏ŸÅ`,
                                    2,
                                    departmentsHtml
                                );
                            }).join('');
                            projectsHtml += '</div>';
                        }

                        const regionTitle = region.nameEn ? `${region.name} (${region.nameEn})` : region.name;
                        regionsHtml += createOrgNode(
                            regionTitle,
                            region.description || '',
                            `${projects.length} ŸÖÿ¥ÿ±Ÿàÿπ ‚Ä¢ ${regionTotalDepts} ŸÇÿ≥ŸÖ ‚Ä¢ ${regionTotalEmployees} ŸÖŸàÿ∏ŸÅ`,
                            1,
                            projectsHtml
                        );
                    });
                    
                    regionsHtml += '</div>';

                    // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸáŸÜÿßŸÉ ÿ•ÿØÿßÿ±ÿ© ÿπÿßŸÖÿ©ÿå ŸÜÿ∂ŸäŸÅ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ ŸÉÿ£ÿ®ŸÜÿßÿ° ŸÑŸáÿß
                    if (generalManagementProject || generalManagementDepts.length > 0) {
                        html += `
                            <div class="org-level">
                                ${regionsHtml}
                            </div>
                        `;
                    } else {
                        // ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™ŸÉŸÜ ŸáŸÜÿßŸÉ ÿ•ÿØÿßÿ±ÿ© ÿπÿßŸÖÿ©ÿå ŸÜÿπÿ±ÿ∂ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ ŸÉŸÖÿ≥ÿ™ŸàŸâ ÿ±ÿ¶Ÿäÿ≥Ÿä
                        html += `
                            <div class="org-level">
                                ${regionsHtml}
                            </div>
                        `;
                    }
                }

                // ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ ÿ®ÿØŸàŸÜ ŸÖŸÜÿ∑ŸÇÿ© (ÿßÿ≥ÿ™ÿ®ÿπÿßÿØ ŸÖÿ¥ÿ±Ÿàÿπ ÿßŸÑÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿπÿßŸÖÿ©)
                const projectsWithoutRegion = projectsData.filter(p => !p.regionId && p.isGeneralManagement !== true);
                if (projectsWithoutRegion.length > 0) {
                    let orphanProjectsHtml = '<div class="org-children-wrapper level-2-wrapper">';
                    orphanProjectsHtml += projectsWithoutRegion.map(project => {
                        const projectDepts = departmentsByProject[project.id] || [];
                        const projectTotalEmployees = projectDepts.reduce((sum, dept) => {
                            return sum + (employeesByDepartment[dept.id]?.length || 0);
                        }, 0);

                        let departmentsHtml = '';
                        if (projectDepts.length > 0) {
                            departmentsHtml = '<div class="org-children-wrapper level-3-wrapper">';
                            departmentsHtml += projectDepts.map(dept => {
                                const deptEmployees = employeesByDepartment[dept.id] || [];
                                return createOrgNode(
                                    dept.name,
                                    dept.description || '',
                                    `${deptEmployees.length} ŸÖŸàÿ∏ŸÅ`,
                                    3,
                                    createEmployeeList(deptEmployees)
                                );
                            }).join('');
                            departmentsHtml += '</div>';
                        }

                        const projectTitle = project.nameEn ? `${project.name} (${project.nameEn})` : project.name;
                        return createOrgNode(
                            projectTitle,
                            project.code || getStatusName(project.status),
                            `${projectDepts.length} ŸÇÿ≥ŸÖ ‚Ä¢ ${projectTotalEmployees} ŸÖŸàÿ∏ŸÅ`,
                            2,
                            departmentsHtml,
                            'orphan-project'
                        );
                    }).join('');
                    orphanProjectsHtml += '</div>';

                    html += `
                        <div class="org-level">
                            <div class="org-node level-1" style="border-color: #dc3545; background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                                <div class="org-node-title">‚ö†Ô∏è ŸÖÿ¥ÿßÿ±Ÿäÿπ ÿ®ÿØŸàŸÜ ŸÖŸÜÿ∑ŸÇÿ©</div>
                                <div class="org-node-count">${projectsWithoutRegion.length} ŸÖÿ¥ÿ±Ÿàÿπ</div>
                                ${orphanProjectsHtml}
                            </div>
                        </div>
                    `;
                }

                html += `
                        </div>
                    </div>
                    
                    <div style="margin-top: 40px; padding: 20px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 12px; border-top: 3px solid #667eea;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 15px;">
                            <div style="text-align: center;">
                                <div style="font-size: 1.5em; margin-bottom: 5px;">üìÖ</div>
                                <div style="font-weight: 600; color: #333; margin-bottom: 5px;">ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±</div>
                                <div style="color: #666; font-size: 0.95em;">
                                    ${formatDate(new Date(), { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                                </div>
                                <div style="color: #999; font-size: 0.85em; margin-top: 3px;">
                                    ${new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}
                                </div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5em; margin-bottom: 5px;">üìä</div>
                                <div style="font-weight: 600; color: #333; margin-bottom: 5px;">ŸÖŸÑÿÆÿµ ÿßŸÑŸáŸäŸÉŸÑ</div>
                                <div style="color: #666; font-size: 0.95em;">
                                    ${regionsData.length} ŸÖŸÜÿ∑ŸÇÿ© ‚Ä¢ ${projectsData.length} ŸÖÿ¥ÿ±Ÿàÿπ ‚Ä¢ ${totalDepartments} ŸÇÿ≥ŸÖ ‚Ä¢ ${totalEmployeesInStructure} ŸÖŸàÿ∏ŸÅ
                                </div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5em; margin-bottom: 5px;">üè¢</div>
                                <div style="font-weight: 600; color: #333; margin-bottom: 5px;">ÿßŸÑŸÖÿ∑Ÿàÿ±</div>
                                <div style="color: #666; font-size: 0.95em;">
                                    Rosemary ŸÑŸÑÿ≠ŸÑŸàŸÑ ÿßŸÑÿ®ÿ±ŸÖÿ¨Ÿä
                                </div>
                            </div>
                        </div>
                        <div style="text-align: center; padding-top: 15px; border-top: 1px solid #dee2e6; color: #999; font-size: 0.85em;">
                            ¬© 2024 Rosemary - ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÇ ŸÖÿ≠ŸÅŸàÿ∏ÿ© | Ÿáÿ∞ÿß ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ§Ÿá ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ŸÖŸÜ ŸÜÿ∏ÿßŸÖ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸàÿßÿ±ÿØ ÿßŸÑÿ®ÿ¥ÿ±Ÿäÿ©
                        </div>
                    </div>
                `;

                reportBody.innerHTML = html;
                currentReportData = { type: 'companyStructure', data: structureByRegion };

            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ŸàŸÑŸäÿØ ÿ™ŸÇÿ±Ÿäÿ± ŸáŸäŸÉŸÑ ÿßŸÑÿ¥ÿ±ŸÉÿ©:', error);
                alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ŸàŸÑŸäÿØ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±: ' + error.message);
            }
        }

        // ÿØŸàÿßŸÑ ÿßŸÑÿ™ÿ≠ŸÉŸÖ ŸÅŸä ÿßŸÑÿ±ÿ≥ŸÖ ÿßŸÑŸáŸäŸÉŸÑŸä
        let orgChartZoom = 1;

        function orgChartZoomIn() {
            orgChartZoom = Math.min(orgChartZoom + 0.1, 2);
            updateOrgChartZoom();
        }

        function orgChartZoomOut() {
            orgChartZoom = Math.max(orgChartZoom - 0.1, 0.5);
            updateOrgChartZoom();
        }

        function orgChartReset() {
            orgChartZoom = 1;
            updateOrgChartZoom();
        }

        function updateOrgChartZoom() {
            const orgChart = document.getElementById('orgChart');
            const zoomLevel = document.getElementById('orgZoomLevel');
            if (orgChart) {
                orgChart.style.transform = `scale(${orgChartZoom})`;
                orgChart.style.transformOrigin = 'top center';
            }
            if (zoomLevel) {
                zoomLevel.textContent = Math.round(orgChartZoom * 100) + '%';
            }
        }

        // ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ±ÿ≥ŸÖ ÿßŸÑŸáŸäŸÉŸÑŸä ŸÉÿµŸàÿ±ÿ©
        async function exportOrgChartAsImage() {
            try {
                const orgChartContainer = document.getElementById('orgChartContainer');
                if (!orgChartContainer) {
                    alert('ÿßŸÑÿ±ÿ≥ŸÖ ÿßŸÑŸáŸäŸÉŸÑŸä ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ');
                    return;
                }

                // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ html2canvas ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÖÿ™ŸàŸÅÿ±ÿßŸãÿå ÿ£Ÿà ÿπÿ±ÿ∂ ÿ±ÿ≥ÿßŸÑÿ©
                if (typeof html2canvas === 'undefined') {
                    // ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ html2canvas ŸÖÿ™ŸàŸÅÿ±ÿßŸãÿå ŸÜÿ≥ÿ™ÿÆÿØŸÖ window.print ŸÉÿ®ÿØŸäŸÑ
                    if (confirm('ŸÑÿ™ÿµÿØŸäÿ± ŸÉÿµŸàÿ±ÿ©ÿå Ÿäÿ±ÿ¨Ÿâ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÖŸäÿ≤ÿ© ÿßŸÑÿ∑ÿ®ÿßÿπÿ© Ÿàÿ≠ŸÅÿ∏Ÿáÿß ŸÉŸÄ PDF.\n\nŸáŸÑ ÿ™ÿ±ŸäÿØ ŸÅÿ™ÿ≠ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ∑ÿ®ÿßÿπÿ©ÿü')) {
                        window.print();
                    }
                    return;
                }

                // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ html2canvas ŸÑÿßŸÑÿ™ŸÇÿßÿ∑ ÿßŸÑÿµŸàÿ±ÿ©
                const canvas = await html2canvas(orgChartContainer, {
                    backgroundColor: '#f5f7fa',
                    scale: 2,
                    logging: false,
                    useCORS: true
                });

                // ÿ™ÿ≠ŸàŸäŸÑ Canvas ÿ•ŸÑŸâ ÿµŸàÿ±ÿ©
                const imgData = canvas.toDataURL('image/png');
                
                // ÿ•ŸÜÿ¥ÿßÿ° ÿ±ÿßÿ®ÿ∑ ŸÑŸÑÿ™ÿ≠ŸÖŸäŸÑ
                const link = document.createElement('a');
                link.download = `ŸáŸäŸÉŸÑ_ÿßŸÑÿ¥ÿ±ŸÉÿ©_${new Date().toISOString().split('T')[0]}.png`;
                link.href = imgData;
                link.click();
                
                alert('‚úÖ ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ±ÿ≥ŸÖ ÿßŸÑŸáŸäŸÉŸÑŸä ÿ®ŸÜÿ¨ÿßÿ≠!');
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿµÿØŸäÿ± ÿßŸÑÿµŸàÿ±ÿ©:', error);
                alert('‚ö†Ô∏è ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ™ÿµÿØŸäÿ± ÿßŸÑÿµŸàÿ±ÿ©. Ÿäÿ±ÿ¨Ÿâ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÖŸäÿ≤ÿ© ÿßŸÑÿ∑ÿ®ÿßÿπÿ© ÿ®ÿØŸÑÿßŸã ŸÖŸÜ ÿ∞ŸÑŸÉ.');
            }
        }

        // ÿ•ÿ∂ÿßŸÅÿ© ÿØÿπŸÖ ÿßŸÑÿ≥ÿ≠ÿ® ŸÑŸÑÿ±ÿ≥ŸÖ ÿßŸÑŸáŸäŸÉŸÑŸä
        let isDragging = false;
        let startX, startY, scrollLeft, scrollTop;

        document.addEventListener('DOMContentLoaded', function() {
            const orgChartContainer = document.getElementById('orgChartContainer');
            if (orgChartContainer) {
                orgChartContainer.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    startX = e.pageX - orgChartContainer.offsetLeft;
                    startY = e.pageY - orgChartContainer.offsetTop;
                    scrollLeft = orgChartContainer.scrollLeft;
                    scrollTop = orgChartContainer.scrollTop;
                    orgChartContainer.style.cursor = 'grabbing';
                });

                orgChartContainer.addEventListener('mouseleave', () => {
                    isDragging = false;
                    orgChartContainer.style.cursor = 'grab';
                });

                orgChartContainer.addEventListener('mouseup', () => {
                    isDragging = false;
                    orgChartContainer.style.cursor = 'grab';
                });

                orgChartContainer.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    e.preventDefault();
                    const x = e.pageX - orgChartContainer.offsetLeft;
                    const y = e.pageY - orgChartContainer.offsetTop;
                    const walkX = (x - startX) * 2;
                    const walkY = (y - startY) * 2;
                    orgChartContainer.scrollLeft = scrollLeft - walkX;
                    orgChartContainer.scrollTop = scrollTop - walkY;
                });

                // ÿ•ÿ∂ÿßŸÅÿ© ÿØÿπŸÖ ÿßŸÑÿ™ŸÉÿ®Ÿäÿ± ÿ®ÿßŸÑÿπÿ¨ŸÑÿ©
                orgChartContainer.addEventListener('wheel', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        e.preventDefault();
                        const delta = e.deltaY > 0 ? -0.1 : 0.1;
                        orgChartZoom = Math.max(0.5, Math.min(2, orgChartZoom + delta));
                        updateOrgChartZoom();
                    }
                }, { passive: false });
            }
        });
    </script>

    <!-- ŸÜÿßŸÅÿ∞ÿ© ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ -->
    <div id="employeeReportModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ - ÿÆŸäÿßÿ±ÿßÿ™ ÿßŸÑÿ™ÿµŸÅŸäÿ©</h3>
                <span class="modal-close" onclick="hideEmployeeReportModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form onsubmit="generateEmployeeReportWithFilters(); return false;">
                    <!-- ŸÅÿ™ÿ±ÿ© ÿßŸÑÿ™ÿßÿ±ŸäÿÆ -->
                    <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-right: 4px solid #667eea;">
                        <h4 style="color: #667eea; margin-bottom: 15px;">üìÖ ŸÅÿ™ÿ±ÿ© ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group" style="margin: 0;">
                                <label>ŸÖŸÜ ÿ™ÿßÿ±ŸäÿÆ:</label>
                                <input type="date" id="reportStartDate" class="form-control">
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label>ÿ•ŸÑŸâ ÿ™ÿßÿ±ŸäÿÆ:</label>
                                <input type="date" id="reportEndDate" class="form-control">
                            </div>
                        </div>
                        <p style="color: #666; font-size: 12px; margin-top: 10px; margin-bottom: 0;">
                            Ÿäÿ™ŸÖ ÿßŸÑÿ™ÿµŸÅŸäÿ© ÿ≠ÿ≥ÿ® ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™Ÿàÿ∏ŸäŸÅ
                        </p>
                    </div>

                    <!-- ÿÆŸäÿßÿ±ÿßÿ™ ÿßŸÑÿ™ÿµŸÅŸäÿ© -->
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="color: #667eea; margin-bottom: 15px;">üîç ÿÆŸäÿßÿ±ÿßÿ™ ÿßŸÑÿ™ÿµŸÅŸäÿ©</h4>
                        <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
                            <div class="form-group" style="margin: 0;">
                                <label>ÿßŸÑÿ≠ÿßŸÑÿ©:</label>
                                <select id="reportStatusFilter" class="form-control">
                                    <option value="">ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ÿßŸÑÿßÿ™</option>
                                    <option value="active">ŸÜÿ¥ÿ∑</option>
                                    <option value="inactive">ÿ∫Ÿäÿ± ŸÜÿ¥ÿ∑</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label>ÿßŸÑŸÖÿ≥ŸÖŸâ ÿßŸÑŸàÿ∏ŸäŸÅŸä:</label>
                                <input type="text" id="reportPositionFilter" placeholder="ÿßÿ®ÿ≠ÿ´ ÿ®ÿßŸÑŸÖÿ≥ŸÖŸâ ÿßŸÑŸàÿ∏ŸäŸÅŸä..." class="form-control">
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label>ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ:</label>
                                <select id="reportProjectFilter" class="form-control">
                                    <option value="">ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button type="button" class="btn btn-danger" onclick="hideEmployeeReportModal()">ÿ•ŸÑÿ∫ÿßÿ°</button>
                        <button type="submit" class="btn btn-success">üìä ÿ™ŸàŸÑŸäÿØ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ŸÜÿßŸÅÿ∞ÿ© ÿ™ŸÇÿ±Ÿäÿ± ÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑŸÖŸàÿ∏ŸÅ -->
    <div id="employeeLeaveHistoryReportModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>ÿ™ŸÇÿ±Ÿäÿ± ÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑŸÖŸàÿ∏ŸÅ - ÿ≠ÿ±ŸÉÿ© ÿ™ÿßÿ±ŸäÿÆŸäÿ©</h3>
                <span class="modal-close" onclick="hideEmployeeLeaveHistoryReportModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form onsubmit="generateEmployeeLeaveHistoryReport(); return false;">
                    <div class="form-group">
                        <label>ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸàÿ∏ŸÅ: <span style="color: red;">*</span></label>
                        <input type="text" id="employeeLeaveReportEmployeeId" list="employeeLeaveReportEmployeeList" placeholder="ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÖŸàÿ∏ŸÅ ÿ®ÿßŸÑÿßÿ≥ŸÖ ÿ£Ÿà ÿ±ŸÇŸÖ ÿßŸÑŸÖŸàÿ∏ŸÅ..." required autocomplete="off" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px;">
                        <input type="hidden" id="employeeLeaveReportEmployeeIdHidden" value="">
                        <datalist id="employeeLeaveReportEmployeeList"></datalist>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>ŸÖŸÜ ÿ™ÿßÿ±ŸäÿÆ:</label>
                            <input type="date" id="employeeLeaveReportStartDate" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>ÿ•ŸÑŸâ ÿ™ÿßÿ±ŸäÿÆ:</label>
                            <input type="date" id="employeeLeaveReportEndDate" class="form-control">
                        </div>
                    </div>
                    <div style="margin-top: 20px; text-align: center;">
                        <button type="submit" class="btn btn-primary">ÿ™ŸàŸÑŸäÿØ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±</button>
                        <button type="button" class="btn btn-secondary" onclick="hideEmployeeLeaveHistoryReportModal()">ÿ•ŸÑÿ∫ÿßÿ°</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ŸÜÿßŸÅÿ∞ÿ© ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ŸàÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ -->
    <div id="projectEmployeesReportModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ - ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ</h3>
                <span class="modal-close" onclick="hideProjectEmployeesReportModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form onsubmit="generateProjectEmployeesReport(); return false;">
                    <div class="form-group">
                        <label>ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ: <span style="color: red;">*</span></label>
                        <select id="projectEmployeesReportProjectId" class="form-control" required>
                            <option value="">-- ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="projectEmployeesReportIncludeHistory" checked>
                            ÿ™ÿ∂ŸÖŸäŸÜ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ ÿßŸÑÿ≥ÿßÿ®ŸÇŸäŸÜ (ÿßŸÑÿ∞ŸäŸÜ ÿßŸÜÿ™ŸáŸâ ÿπŸÖŸÑŸáŸÖ ŸÅŸä ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ)
                        </label>
                    </div>
                    <div style="margin-top: 20px; text-align: center;">
                        <button type="submit" class="btn btn-primary">ÿ™ŸàŸÑŸäÿØ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±</button>
                        <button type="button" class="btn btn-secondary" onclick="hideProjectEmployeesReportModal()">ÿ•ŸÑÿ∫ÿßÿ°</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ŸÜÿßŸÅÿ∞ÿ© ÿ™ŸÇÿ±Ÿäÿ± ŸÖÿ¥ÿßÿ±Ÿäÿπ ÿßŸÑŸÖŸàÿ∏ŸÅ -->
    <div id="employeeProjectsHistoryReportModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>ÿ™ŸÇÿ±Ÿäÿ± ŸÖÿ¥ÿßÿ±Ÿäÿπ ÿßŸÑŸÖŸàÿ∏ŸÅ - ÿ≠ÿ±ŸÉÿ© ÿ™ÿßÿ±ŸäÿÆŸäÿ©</h3>
                <span class="modal-close" onclick="hideEmployeeProjectsHistoryReportModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form onsubmit="generateEmployeeProjectsHistoryReport(); return false;">
                    <div class="form-group">
                        <label>ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸàÿ∏ŸÅ: <span style="color: red;">*</span></label>
                        <select id="employeeProjectsReportEmployeeId" class="form-control" required>
                            <option value="">-- ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸàÿ∏ŸÅ --</option>
                        </select>
                    </div>
                    <div style="margin-top: 20px; text-align: center;">
                        <button type="submit" class="btn btn-primary">ÿ™ŸàŸÑŸäÿØ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±</button>
                        <button type="button" class="btn btn-secondary" onclick="hideEmployeeProjectsHistoryReportModal()">ÿ•ŸÑÿ∫ÿßÿ°</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ŸÜÿßŸÅÿ∞ÿ© ÿ™ŸÇÿ±Ÿäÿ± ÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑŸÖŸàÿ∏ŸÅ -->
    <div id="employeeLeaveHistoryReportModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>ÿ™ŸÇÿ±Ÿäÿ± ÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿßŸÑŸÖŸàÿ∏ŸÅ - ÿ≠ÿ±ŸÉÿ© ÿ™ÿßÿ±ŸäÿÆŸäÿ©</h3>
                <span class="modal-close" onclick="hideEmployeeLeaveHistoryReportModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form onsubmit="generateEmployeeLeaveHistoryReport(); return false;">
                    <div class="form-group">
                        <label>ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸàÿ∏ŸÅ: <span style="color: red;">*</span></label>
                        <input type="text" id="employeeLeaveReportEmployeeId" list="employeeLeaveReportEmployeeList" placeholder="ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÖŸàÿ∏ŸÅ ÿ®ÿßŸÑÿßÿ≥ŸÖ ÿ£Ÿà ÿ±ŸÇŸÖ ÿßŸÑŸÖŸàÿ∏ŸÅ..." required autocomplete="off" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px;">
                        <input type="hidden" id="employeeLeaveReportEmployeeIdHidden" value="">
                        <datalist id="employeeLeaveReportEmployeeList"></datalist>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>ŸÖŸÜ ÿ™ÿßÿ±ŸäÿÆ:</label>
                            <input type="date" id="employeeLeaveReportStartDate" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>ÿ•ŸÑŸâ ÿ™ÿßÿ±ŸäÿÆ:</label>
                            <input type="date" id="employeeLeaveReportEndDate" class="form-control">
                        </div>
                    </div>
                    <div style="margin-top: 20px; text-align: center;">
                        <button type="submit" class="btn btn-primary">ÿ™ŸàŸÑŸäÿØ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±</button>
                        <button type="button" class="btn btn-secondary" onclick="hideEmployeeLeaveHistoryReportModal()">ÿ•ŸÑÿ∫ÿßÿ°</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ŸÜÿßŸÅÿ∞ÿ© ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ŸàÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ -->
    <div id="projectEmployeesReportModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ - ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ</h3>
                <span class="modal-close" onclick="hideProjectEmployeesReportModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form onsubmit="generateProjectEmployeesReport(); return false;">
                    <div class="form-group">
                        <label>ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ: <span style="color: red;">*</span></label>
                        <select id="projectEmployeesReportProjectId" class="form-control" required>
                            <option value="">-- ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="projectEmployeesReportIncludeHistory" checked>
                            ÿ™ÿ∂ŸÖŸäŸÜ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ ÿßŸÑÿ≥ÿßÿ®ŸÇŸäŸÜ (ÿßŸÑÿ∞ŸäŸÜ ÿßŸÜÿ™ŸáŸâ ÿπŸÖŸÑŸáŸÖ ŸÅŸä ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ)
                        </label>
                    </div>
                    <div style="margin-top: 20px; text-align: center;">
                        <button type="submit" class="btn btn-primary">ÿ™ŸàŸÑŸäÿØ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±</button>
                        <button type="button" class="btn btn-secondary" onclick="hideProjectEmployeesReportModal()">ÿ•ŸÑÿ∫ÿßÿ°</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ŸÜÿßŸÅÿ∞ÿ© ÿ™ŸÇÿ±Ÿäÿ± ŸÖÿ¥ÿßÿ±Ÿäÿπ ÿßŸÑŸÖŸàÿ∏ŸÅ -->
    <div id="employeeProjectsHistoryReportModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>ÿ™ŸÇÿ±Ÿäÿ± ŸÖÿ¥ÿßÿ±Ÿäÿπ ÿßŸÑŸÖŸàÿ∏ŸÅ - ÿ≠ÿ±ŸÉÿ© ÿ™ÿßÿ±ŸäÿÆŸäÿ©</h3>
                <span class="modal-close" onclick="hideEmployeeProjectsHistoryReportModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form onsubmit="generateEmployeeProjectsHistoryReport(); return false;">
                    <div class="form-group">
                        <label>ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸàÿ∏ŸÅ: <span style="color: red;">*</span></label>
                        <select id="employeeProjectsReportEmployeeId" class="form-control" required>
                            <option value="">-- ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸàÿ∏ŸÅ --</option>
                        </select>
                    </div>
                    <div style="margin-top: 20px; text-align: center;">
                        <button type="submit" class="btn btn-primary">ÿ™ŸàŸÑŸäÿØ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±</button>
                        <button type="button" class="btn btn-secondary" onclick="hideEmployeeProjectsHistoryReportModal()">ÿ•ŸÑÿ∫ÿßÿ°</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</body>
</html>

